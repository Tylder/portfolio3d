var Y$=Object.defineProperty,j$=Object.defineProperties,K$=Object.getOwnPropertyDescriptors,QN=Object.getOwnPropertySymbols,Q$=Object.prototype.hasOwnProperty,Z$=Object.prototype.propertyIsEnumerable,ZN=(et,Ce,L)=>Ce in et?Y$(et,Ce,{enumerable:!0,configurable:!0,writable:!0,value:L}):et[Ce]=L,Mi=(et,Ce)=>{for(var L in Ce||(Ce={}))Q$.call(Ce,L)&&ZN(et,L,Ce[L]);if(QN)for(var L of QN(Ce))Z$.call(Ce,L)&&ZN(et,L,Ce[L]);return et},Gp=(et,Ce)=>j$(et,K$(Ce));(self.webpackChunkng_web_portfolio=self.webpackChunkng_web_portfolio||[]).push([[179],{9993:(et,Ce,L)=>{"use strict";var he=L(8929),xe=L(4096),Pe=L(4202),ve=L(6787),K=L(1762);class ce{constructor(e,t){this.subjectFactory=e,this.selector=t}call(e,t){const{selector:i}=this,n=this.subjectFactory(),s=i(n).subscribe(e);return s.add(t.subscribe(n)),s}}var Ae=L(4327);function Le(){return new he.xQ}function G(r){for(let e in r)if(r[e]===G)return e;throw Error("Could not find renamed property on target object.")}function ie(r,e){for(const t in e)e.hasOwnProperty(t)&&!r.hasOwnProperty(t)&&(r[t]=e[t])}function q(r){if("string"==typeof r)return r;if(Array.isArray(r))return"["+r.map(q).join(", ")+"]";if(null==r)return""+r;if(r.overriddenName)return`${r.overriddenName}`;if(r.name)return`${r.name}`;const e=r.toString();if(null==e)return""+e;const t=e.indexOf("\n");return-1===t?e:e.substring(0,t)}function we(r,e){return null==r||""===r?null===e?"":e:null==e||""===e?r:r+" "+e}const Ee=G({__forward_ref__:G});function pe(r){return r.__forward_ref__=pe,r.toString=function(){return q(this())},r}function ae(r){return _t(r)?r():r}function _t(r){return"function"==typeof r&&r.hasOwnProperty(Ee)&&r.__forward_ref__===pe}class Ke extends Error{constructor(e,t){super(function Zt(r,e){return`NG0${Math.abs(r)}${e?": "+e:""}`}(e,t)),this.code=e}}function st(r){return"string"==typeof r?r:null==r?"":String(r)}function Ut(r){return"function"==typeof r?r.name||r.toString():"object"==typeof r&&null!=r&&"function"==typeof r.type?r.type.name||r.type.toString():st(r)}function Pt(r,e){const t=e?` in ${e}`:"";throw new Ke(-201,`No provider for ${Ut(r)} found${t}`)}function er(r,e){null==r&&function Pi(r,e,t,i){throw new Error(`ASSERTION ERROR: ${r}`+(null==i?"":` [Expected=> ${t} ${i} ${e} <=Actual]`))}(e,r,null,"!=")}function St(r){return{token:r.token,providedIn:r.providedIn||null,factory:r.factory,value:void 0}}function Lr(r){return{providers:r.providers||[],imports:r.imports||[]}}function uu(r){return qo(r,Jo)||qo(r,Zh)}function qo(r,e){return r.hasOwnProperty(e)?r[e]:null}function _o(r){return r&&(r.hasOwnProperty(hu)||r.hasOwnProperty(cv))?r[hu]:null}const Jo=G({\u0275prov:G}),hu=G({\u0275inj:G}),Zh=G({ngInjectableDef:G}),cv=G({ngInjectorDef:G});var Ht=(()=>((Ht=Ht||{})[Ht.Default=0]="Default",Ht[Ht.Host=1]="Host",Ht[Ht.Self=2]="Self",Ht[Ht.SkipSelf=4]="SkipSelf",Ht[Ht.Optional=8]="Optional",Ht))();let du;function Os(r){const e=du;return du=r,e}function qh(r,e,t){const i=uu(r);return i&&"root"==i.providedIn?void 0===i.value?i.value=i.factory():i.value:t&Ht.Optional?null:void 0!==e?e:void Pt(q(r),"Injector")}function Br(r){return{toString:r}.toString()}var Vn=(()=>((Vn=Vn||{})[Vn.OnPush=0]="OnPush",Vn[Vn.Default=1]="Default",Vn))(),vs=(()=>{return(r=vs||(vs={}))[r.Emulated=0]="Emulated",r[r.None=2]="None",r[r.ShadowDom=3]="ShadowDom",vs;var r})();const Vl="undefined"!=typeof globalThis&&globalThis,Xp="undefined"!=typeof window&&window,Yp="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,Ni=Vl||"undefined"!=typeof global&&global||Xp||Yp,oa={},Ui=[],kl=G({\u0275cmp:G}),fu=G({\u0275dir:G}),Gl=G({\u0275pipe:G}),Jh=G({\u0275mod:G}),Fs=G({\u0275fac:G}),Ba=G({__NG_ELEMENT_ID__:G});let $p=0;function mo(r){return Br(()=>{const t={},i={type:r.type,providersResolver:null,decls:r.decls,vars:r.vars,factory:null,template:r.template||null,consts:r.consts||null,ngContentSelectors:r.ngContentSelectors,hostBindings:r.hostBindings||null,hostVars:r.hostVars||0,hostAttrs:r.hostAttrs||null,contentQueries:r.contentQueries||null,declaredInputs:t,inputs:null,outputs:null,exportAs:r.exportAs||null,onPush:r.changeDetection===Vn.OnPush,directiveDefs:null,pipeDefs:null,selectors:r.selectors||Ui,viewQuery:r.viewQuery||null,features:r.features||null,data:r.data||{},encapsulation:r.encapsulation||vs.Emulated,id:"c",styles:r.styles||Ui,_:null,setInput:null,schemas:r.schemas||null,tView:null},n=r.directives,s=r.features,a=r.pipes;return i.id+=$p++,i.inputs=td(r.inputs,t),i.outputs=td(r.outputs),s&&s.forEach(o=>o(i)),i.directiveDefs=n?()=>("function"==typeof n?n():n).map(pu):null,i.pipeDefs=a?()=>("function"==typeof a?a():a).map(gu):null,i})}function pu(r){return kn(r)||function la(r){return r[fu]||null}(r)}function gu(r){return function Ua(r){return r[Gl]||null}(r)}const ed={};function Er(r){return Br(()=>{const e={type:r.type,bootstrap:r.bootstrap||Ui,declarations:r.declarations||Ui,imports:r.imports||Ui,exports:r.exports||Ui,transitiveCompileScopes:null,schemas:r.schemas||null,id:r.id||null};return null!=r.id&&(ed[r.id]=r.type),e})}function td(r,e){if(null==r)return oa;const t={};for(const i in r)if(r.hasOwnProperty(i)){let n=r[i],s=n;Array.isArray(n)&&(s=n[1],n=n[0]),t[n]=i,e&&(e[n]=s)}return t}const Tt=mo;function lr(r){return{type:r.type,name:r.name,factory:null,pure:!1!==r.pure,onDestroy:r.type.prototype.ngOnDestroy||null}}function kn(r){return r[kl]||null}function Ur(r,e){const t=r[Jh]||null;if(!t&&!0===e)throw new Error(`Type ${q(r)} does not have '\u0275mod' property.`);return t}function ca(r){return Array.isArray(r)&&"object"==typeof r[1]}function Bs(r){return Array.isArray(r)&&!0===r[1]}function qp(r){return 0!=(8&r.flags)}function id(r){return 2==(2&r.flags)}function nd(r){return 1==(1&r.flags)}function Us(r){return null!==r.template}function t1(r){return 0!=(512&r[2])}function tl(r,e){return r.hasOwnProperty(Fs)?r[Fs]:null}class r1{constructor(e,t,i){this.previousValue=e,this.currentValue=t,this.firstChange=i}isFirstChange(){return this.firstChange}}function il(){return gv}function gv(r){return r.type.prototype.ngOnChanges&&(r.setInput=a1),s1}function s1(){const r=mv(this),e=null==r?void 0:r.current;if(e){const t=r.previous;if(t===oa)r.previous=e;else for(let i in e)t[i]=e[i];r.current=null,this.ngOnChanges(e)}}function a1(r,e,t,i){const n=mv(r)||function o1(r,e){return r[_v]=e}(r,{previous:oa,current:null}),s=n.current||(n.current={}),a=n.previous,o=this.declaredInputs[t],l=a[o];s[o]=new r1(l&&l.currentValue,e,a===oa),r[i]=e}il.ngInherit=!0;const _v="__ngSimpleChanges__";function mv(r){return r[_v]||null}let ng;function gn(r){return!!r.listen}const Tv={createRenderer:(r,e)=>function rg(){return void 0!==ng?ng:"undefined"!=typeof document?document:void 0}()};function Dn(r){for(;Array.isArray(r);)r=r[0];return r}function Qr(r,e){return Dn(e[r.index])}function sg(r,e){return r.data[e]}function zl(r,e){return r[e]}function Zr(r,e){const t=e[r];return ca(t)?t:t[0]}function Ev(r){return 4==(4&r[2])}function ag(r){return 128==(128&r[2])}function Eo(r,e){return null==e?null:r[e]}function vv(r){r[18]=0}function og(r,e){r[5]+=e;let t=r,i=r[3];for(;null!==i&&(1===e&&1===t[5]||-1===e&&0===t[5]);)i[5]+=e,t=i,i=i[3]}const $t={lFrame:Dv(null),bindingsEnabled:!0};function xv(){return $t.bindingsEnabled}function Ge(){return $t.lFrame.lView}function vi(){return $t.lFrame.tView}function Gn(){let r=yv();for(;null!==r&&64===r.type;)r=r.parent;return r}function yv(){return $t.lFrame.currentTNode}function ua(r,e){const t=$t.lFrame;t.currentTNode=r,t.isParent=e}function lg(){return $t.lFrame.isParent}function Sr(){const r=$t.lFrame;let e=r.bindingRootIndex;return-1===e&&(e=r.bindingRootIndex=r.tView.bindingStartIndex),e}function Wl(){return $t.lFrame.bindingIndex++}function y1(r,e){const t=$t.lFrame;t.bindingIndex=t.bindingRootIndex=r,ug(e)}function ug(r){$t.lFrame.currentDirectiveIndex=r}function Iv(){return $t.lFrame.currentQueryIndex}function dg(r){$t.lFrame.currentQueryIndex=r}function C1(r){const e=r[1];return 2===e.type?e.declTNode:1===e.type?r[6]:null}function Rv(r,e,t){if(t&Ht.SkipSelf){let n=e,s=r;for(;!(n=n.parent,null!==n||t&Ht.Host||(n=C1(s),null===n||(s=s[15],10&n.type))););if(null===n)return!1;e=n,r=s}const i=$t.lFrame=Mv();return i.currentTNode=e,i.lView=r,!0}function ad(r){const e=Mv(),t=r[1];$t.lFrame=e,e.currentTNode=t.firstChild,e.lView=r,e.tView=t,e.contextLView=r,e.bindingIndex=t.bindingStartIndex,e.inI18n=!1}function Mv(){const r=$t.lFrame,e=null===r?null:r.child;return null===e?Dv(r):e}function Dv(r){const e={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:r,child:null,inI18n:!1};return null!==r&&(r.child=e),e}function Pv(){const r=$t.lFrame;return $t.lFrame=r.parent,r.currentTNode=null,r.lView=null,r}const wv=Pv;function od(){const r=Pv();r.isParent=!0,r.tView=null,r.selectedIndex=-1,r.contextLView=null,r.elementDepthCount=0,r.currentDirectiveIndex=-1,r.currentNamespace=null,r.bindingRootIndex=-1,r.bindingIndex=-1,r.currentQueryIndex=0}function xr(){return $t.lFrame.selectedIndex}function vo(r){$t.lFrame.selectedIndex=r}function ld(r,e){for(let t=e.directiveStart,i=e.directiveEnd;t<i;t++){const s=r.data[t].type.prototype,{ngAfterContentInit:a,ngAfterContentChecked:o,ngAfterViewInit:l,ngAfterViewChecked:c,ngOnDestroy:u}=s;a&&(r.contentHooks||(r.contentHooks=[])).push(-t,a),o&&((r.contentHooks||(r.contentHooks=[])).push(t,o),(r.contentCheckHooks||(r.contentCheckHooks=[])).push(t,o)),l&&(r.viewHooks||(r.viewHooks=[])).push(-t,l),c&&((r.viewHooks||(r.viewHooks=[])).push(t,c),(r.viewCheckHooks||(r.viewCheckHooks=[])).push(t,c)),null!=u&&(r.destroyHooks||(r.destroyHooks=[])).push(t,u)}}function cd(r,e,t){Ov(r,e,3,t)}function ud(r,e,t,i){(3&r[2])===t&&Ov(r,e,t,i)}function fg(r,e){let t=r[2];(3&t)===e&&(t&=2047,t+=1,r[2]=t)}function Ov(r,e,t,i){const s=null!=i?i:-1,a=e.length-1;let o=0;for(let l=void 0!==i?65535&r[18]:0;l<a;l++)if("number"==typeof e[l+1]){if(o=e[l],null!=i&&o>=i)break}else e[l]<0&&(r[18]+=65536),(o<s||-1==s)&&(N1(r,t,e,l),r[18]=(4294901760&r[18])+l+2),l++}function N1(r,e,t,i){const n=t[i]<0,s=t[i+1],o=r[n?-t[i]:t[i]];if(n){if(r[2]>>11<r[18]>>16&&(3&r[2])===e){r[2]+=2048;try{s.call(o)}finally{}}}else try{s.call(o)}finally{}}class Tu{constructor(e,t,i){this.factory=e,this.resolving=!1,this.canSeeViewProviders=t,this.injectImpl=i}}function hd(r,e,t){const i=gn(r);let n=0;for(;n<t.length;){const s=t[n];if("number"==typeof s){if(0!==s)break;n++;const a=t[n++],o=t[n++],l=t[n++];i?r.setAttribute(e,o,l,a):e.setAttributeNS(a,o,l)}else{const a=s,o=t[++n];gg(a)?i&&r.setProperty(e,a,o):i?r.setAttribute(e,a,o):e.setAttribute(a,o),n++}}return n}function Fv(r){return 3===r||4===r||6===r}function gg(r){return 64===r.charCodeAt(0)}function dd(r,e){if(null!==e&&0!==e.length)if(null===r||0===r.length)r=e.slice();else{let t=-1;for(let i=0;i<e.length;i++){const n=e[i];"number"==typeof n?t=n:0===t||Nv(r,t,n,null,-1===t||2===t?e[++i]:null)}}return r}function Nv(r,e,t,i,n){let s=0,a=r.length;if(-1===e)a=-1;else for(;s<r.length;){const o=r[s++];if("number"==typeof o){if(o===e){a=-1;break}if(o>e){a=s-1;break}}}for(;s<r.length;){const o=r[s];if("number"==typeof o)break;if(o===t){if(null===i)return void(null!==n&&(r[s+1]=n));if(i===r[s+1])return void(r[s+2]=n)}s++,null!==i&&s++,null!==n&&s++}-1!==a&&(r.splice(a,0,e),s=a+1),r.splice(s++,0,t),null!==i&&r.splice(s++,0,i),null!==n&&r.splice(s++,0,n)}function Lv(r){return-1!==r}function Xl(r){return 32767&r}function Yl(r,e){let t=function k1(r){return r>>16}(r),i=e;for(;t>0;)i=i[15],t--;return i}let _g=!0;function fd(r){const e=_g;return _g=r,e}let G1=0;function vu(r,e){const t=Tg(r,e);if(-1!==t)return t;const i=e[1];i.firstCreatePass&&(r.injectorIndex=e.length,mg(i.data,r),mg(e,null),mg(i.blueprint,null));const n=pd(r,e),s=r.injectorIndex;if(Lv(n)){const a=Xl(n),o=Yl(n,e),l=o[1].data;for(let c=0;c<8;c++)e[s+c]=o[a+c]|l[a+c]}return e[s+8]=n,s}function mg(r,e){r.push(0,0,0,0,0,0,0,0,e)}function Tg(r,e){return-1===r.injectorIndex||r.parent&&r.parent.injectorIndex===r.injectorIndex||null===e[r.injectorIndex+8]?-1:r.injectorIndex}function pd(r,e){if(r.parent&&-1!==r.parent.injectorIndex)return r.parent.injectorIndex;let t=0,i=null,n=e;for(;null!==n;){const s=n[1],a=s.type;if(i=2===a?s.declTNode:1===a?n[6]:null,null===i)return-1;if(t++,n=n[15],-1!==i.injectorIndex)return i.injectorIndex|t<<16}return-1}function gd(r,e,t){!function H1(r,e,t){let i;"string"==typeof t?i=t.charCodeAt(0)||0:t.hasOwnProperty(Ba)&&(i=t[Ba]),null==i&&(i=t[Ba]=G1++);const n=255&i;e.data[r+(n>>5)]|=1<<n}(r,e,t)}function Vv(r,e,t){if(t&Ht.Optional)return r;Pt(e,"NodeInjector")}function kv(r,e,t,i){if(t&Ht.Optional&&void 0===i&&(i=null),0==(t&(Ht.Self|Ht.Host))){const n=r[9],s=Os(void 0);try{return n?n.get(e,i,t&Ht.Optional):qh(e,i,t&Ht.Optional)}finally{Os(s)}}return Vv(i,e,t)}function Gv(r,e,t,i=Ht.Default,n){if(null!==r){const s=function Y1(r){if("string"==typeof r)return r.charCodeAt(0)||0;const e=r.hasOwnProperty(Ba)?r[Ba]:void 0;return"number"==typeof e?e>=0?255&e:W1:e}(t);if("function"==typeof s){if(!Rv(e,r,i))return i&Ht.Host?Vv(n,t,i):kv(e,t,i,n);try{const a=s(i);if(null!=a||i&Ht.Optional)return a;Pt(t)}finally{wv()}}else if("number"==typeof s){let a=null,o=Tg(r,e),l=-1,c=i&Ht.Host?e[16][6]:null;for((-1===o||i&Ht.SkipSelf)&&(l=-1===o?pd(r,e):e[o+8],-1!==l&&Wv(i,!1)?(a=e[1],o=Xl(l),e=Yl(l,e)):o=-1);-1!==o;){const u=e[1];if(zv(s,o,u.data)){const h=X1(o,e,t,a,i,c);if(h!==Hv)return h}l=e[o+8],-1!==l&&Wv(i,e[1].data[o+8]===c)&&zv(s,o,e)?(a=u,o=Xl(l),e=Yl(l,e)):o=-1}}}return kv(e,t,i,n)}const Hv={};function W1(){return new jl(Gn(),Ge())}function X1(r,e,t,i,n,s){const a=e[1],o=a.data[r+8],u=_d(o,a,t,null==i?id(o)&&_g:i!=a&&0!=(3&o.type),n&Ht.Host&&s===o);return null!==u?Su(e,a,u,o):Hv}function _d(r,e,t,i,n){const s=r.providerIndexes,a=e.data,o=1048575&s,l=r.directiveStart,u=s>>20,d=n?o+u:r.directiveEnd;for(let f=i?o:o+u;f<d;f++){const p=a[f];if(f<l&&t===p||f>=l&&p.type===t)return f}if(n){const f=a[l];if(f&&Us(f)&&f.type===t)return l}return null}function Su(r,e,t,i){let n=r[t];const s=e.data;if(function L1(r){return r instanceof Tu}(n)){const a=n;a.resolving&&function Di(r,e){const t=e?`. Dependency path: ${e.join(" > ")} > ${r}`:"";throw new Ke(-200,`Circular dependency in DI detected for ${r}${t}`)}(Ut(s[t]));const o=fd(a.canSeeViewProviders);a.resolving=!0;const l=a.injectImpl?Os(a.injectImpl):null;Rv(r,i,Ht.Default);try{n=r[t]=a.factory(void 0,s,r,i),e.firstCreatePass&&t>=i.directiveStart&&function F1(r,e,t){const{ngOnChanges:i,ngOnInit:n,ngDoCheck:s}=e.type.prototype;if(i){const a=gv(e);(t.preOrderHooks||(t.preOrderHooks=[])).push(r,a),(t.preOrderCheckHooks||(t.preOrderCheckHooks=[])).push(r,a)}n&&(t.preOrderHooks||(t.preOrderHooks=[])).push(0-r,n),s&&((t.preOrderHooks||(t.preOrderHooks=[])).push(r,s),(t.preOrderCheckHooks||(t.preOrderCheckHooks=[])).push(r,s))}(t,s[t],e)}finally{null!==l&&Os(l),fd(o),a.resolving=!1,wv()}}return n}function zv(r,e,t){return!!(t[e+(r>>5)]&1<<r)}function Wv(r,e){return!(r&Ht.Self||r&Ht.Host&&e)}class jl{constructor(e,t){this._tNode=e,this._lView=t}get(e,t,i){return Gv(this._tNode,this._lView,e,i,t)}}function Jt(r){return Br(()=>{const e=r.prototype.constructor,t=e[Fs]||Eg(e),i=Object.prototype;let n=Object.getPrototypeOf(r.prototype).constructor;for(;n&&n!==i;){const s=n[Fs]||Eg(n);if(s&&s!==t)return s;n=Object.getPrototypeOf(n)}return s=>new s})}function Eg(r){return _t(r)?()=>{const e=Eg(ae(r));return e&&e()}:tl(r)}const Kl="__parameters__";function Zl(r,e,t){return Br(()=>{const i=function Sg(r){return function(...t){if(r){const i=r(...t);for(const n in i)this[n]=i[n]}}}(e);function n(...s){if(this instanceof n)return i.apply(this,s),this;const a=new n(...s);return o.annotation=a,o;function o(l,c,u){const h=l.hasOwnProperty(Kl)?l[Kl]:Object.defineProperty(l,Kl,{value:[]})[Kl];for(;h.length<=u;)h.push(null);return(h[u]=h[u]||[]).push(a),l}}return t&&(n.prototype=Object.create(t.prototype)),n.prototype.ngMetadataName=r,n.annotationCls=n,n})}class oi{constructor(e,t){this._desc=e,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,"number"==typeof t?this.__NG_ELEMENT_ID__=t:void 0!==t&&(this.\u0275prov=St({token:this,providedIn:t.providedIn||"root",factory:t.factory}))}toString(){return`InjectionToken ${this._desc}`}}function xs(r,e){void 0===e&&(e=r);for(let t=0;t<r.length;t++){let i=r[t];Array.isArray(i)?(e===r&&(e=r.slice(0,t)),xs(i,e)):e!==r&&e.push(i)}return e}function ha(r,e){r.forEach(t=>Array.isArray(t)?ha(t,e):e(t))}function Yv(r,e,t){e>=r.length?r.push(t):r.splice(e,0,t)}function md(r,e){return e>=r.length-1?r.pop():r.splice(e,1)[0]}const bu={},bg="__NG_DI_FLAG__",Ed="ngTempTokenPath",nL=/\n/gm,Zv="__source",sL=G({provide:String,useValue:G});let Cu;function qv(r){const e=Cu;return Cu=r,e}function aL(r,e=Ht.Default){if(void 0===Cu)throw new Ke(203,"");return null===Cu?qh(r,void 0,e):Cu.get(r,e&Ht.Optional?null:void 0,e)}function rt(r,e=Ht.Default){return(function zp(){return du}()||aL)(ae(r),e)}const vd=rt;function Cg(r){const e=[];for(let t=0;t<r.length;t++){const i=ae(r[t]);if(Array.isArray(i)){if(0===i.length)throw new Ke(900,"");let n,s=Ht.Default;for(let a=0;a<i.length;a++){const o=i[a],l=oL(o);"number"==typeof l?-1===l?n=o.token:s|=l:n=o}e.push(rt(n,s))}else e.push(rt(i))}return e}function Iu(r,e){return r[bg]=e,r.prototype[bg]=e,r}function oL(r){return r[bg]}const Sd=Iu(Zl("Optional"),8),xd=Iu(Zl("SkipSelf"),4);var Jr=(()=>((Jr=Jr||{})[Jr.Important=1]="Important",Jr[Jr.DashCase=2]="DashCase",Jr))();const aS="__ngContext__";function cr(r,e){r[aS]=e}function Dg(r){const e=function Mu(r){return r[aS]||null}(r);return e?Array.isArray(e)?e:e.lView:null}function wg(r,e){return undefined(r,e)}function Du(r){const e=r[3];return Bs(e)?e[3]:e}function Og(r){return fS(r[13])}function Fg(r){return fS(r[4])}function fS(r){for(;null!==r&&!Bs(r);)r=r[4];return r}function ec(r,e,t,i,n){if(null!=i){let s,a=!1;Bs(i)?s=i:ca(i)&&(a=!0,i=i[0]);const o=Dn(i);0===r&&null!==t?null==n?ES(e,t,o):nl(e,t,o,n||null,!0):1===r&&null!==t?nl(e,t,o,n||null,!0):2===r?function Gg(r,e,t){const i=yd(r,e);i&&function UL(r,e,t,i){gn(r)?r.removeChild(e,t,i):e.removeChild(t)}(r,i,e,t)}(e,o,a):3===r&&e.destroyNode(o),null!=s&&function GL(r,e,t,i,n){const s=t[7];s!==Dn(t)&&ec(e,r,i,s,n);for(let o=10;o<t.length;o++){const l=t[o];Pu(l[1],l,r,e,i,s)}}(e,r,s,t,n)}}function Lg(r,e,t){if(gn(r))return r.createElement(e,t);{const i=null!==t?function h1(r){const e=r.toLowerCase();return"svg"===e?"http://www.w3.org/2000/svg":"math"===e?"http://www.w3.org/1998/MathML/":null}(t):null;return null===i?r.createElement(e):r.createElementNS(i,e)}}function gS(r,e){const t=r[9],i=t.indexOf(e),n=e[3];1024&e[2]&&(e[2]&=-1025,og(n,-1)),t.splice(i,1)}function Bg(r,e){if(r.length<=10)return;const t=10+e,i=r[t];if(i){const n=i[17];null!==n&&n!==r&&gS(n,i),e>0&&(r[t-1][4]=i[4]);const s=md(r,10+e);!function DL(r,e){Pu(r,e,e[11],2,null,null),e[0]=null,e[6]=null}(i[1],i);const a=s[19];null!==a&&a.detachView(s[1]),i[3]=null,i[4]=null,i[2]&=-129}return i}function _S(r,e){if(!(256&e[2])){const t=e[11];gn(t)&&t.destroyNode&&Pu(r,e,t,3,null,null),function OL(r){let e=r[13];if(!e)return Ug(r[1],r);for(;e;){let t=null;if(ca(e))t=e[13];else{const i=e[10];i&&(t=i)}if(!t){for(;e&&!e[4]&&e!==r;)ca(e)&&Ug(e[1],e),e=e[3];null===e&&(e=r),ca(e)&&Ug(e[1],e),t=e&&e[4]}e=t}}(e)}}function Ug(r,e){if(!(256&e[2])){e[2]&=-129,e[2]|=256,function BL(r,e){let t;if(null!=r&&null!=(t=r.destroyHooks))for(let i=0;i<t.length;i+=2){const n=e[t[i]];if(!(n instanceof Tu)){const s=t[i+1];if(Array.isArray(s))for(let a=0;a<s.length;a+=2){const o=n[s[a]],l=s[a+1];try{l.call(o)}finally{}}else try{s.call(n)}finally{}}}}(r,e),function LL(r,e){const t=r.cleanup,i=e[7];let n=-1;if(null!==t)for(let s=0;s<t.length-1;s+=2)if("string"==typeof t[s]){const a=t[s+1],o="function"==typeof a?a(e):Dn(e[a]),l=i[n=t[s+2]],c=t[s+3];"boolean"==typeof c?o.removeEventListener(t[s],l,c):c>=0?i[n=c]():i[n=-c].unsubscribe(),s+=2}else{const a=i[n=t[s+1]];t[s].call(a)}if(null!==i){for(let s=n+1;s<i.length;s++)i[s]();e[7]=null}}(r,e),1===e[1].type&&gn(e[11])&&e[11].destroy();const t=e[17];if(null!==t&&Bs(e[3])){t!==e[3]&&gS(t,e);const i=e[19];null!==i&&i.detachView(r)}}}function mS(r,e,t){return function TS(r,e,t){let i=e;for(;null!==i&&40&i.type;)i=(e=i).parent;if(null===i)return t[0];if(2&i.flags){const n=r.data[i.directiveStart].encapsulation;if(n===vs.None||n===vs.Emulated)return null}return Qr(i,t)}(r,e.parent,t)}function nl(r,e,t,i,n){gn(r)?r.insertBefore(e,t,i,n):e.insertBefore(t,i,n)}function ES(r,e,t){gn(r)?r.appendChild(e,t):e.appendChild(t)}function vS(r,e,t,i,n){null!==i?nl(r,e,t,i,n):ES(r,e,t)}function yd(r,e){return gn(r)?r.parentNode(e):e.parentNode}let AS=function xS(r,e,t){return 40&r.type?Qr(r,t):null};function bd(r,e,t,i){const n=mS(r,i,e),s=e[11],o=function SS(r,e,t){return AS(r,e,t)}(i.parent||e[6],i,e);if(null!=n)if(Array.isArray(t))for(let l=0;l<t.length;l++)vS(s,n,t[l],o,!1);else vS(s,n,t,o,!1)}function Cd(r,e){if(null!==e){const t=e.type;if(3&t)return Qr(e,r);if(4&t)return kg(-1,r[e.index]);if(8&t){const i=e.child;if(null!==i)return Cd(r,i);{const n=r[e.index];return Bs(n)?kg(-1,n):Dn(n)}}if(32&t)return wg(e,r)()||Dn(r[e.index]);{const i=bS(r,e);return null!==i?Array.isArray(i)?i[0]:Cd(Du(r[16]),i):Cd(r,e.next)}}return null}function bS(r,e){return null!==e?r[16][6].projection[e.projection]:null}function kg(r,e){const t=10+r+1;if(t<e.length){const i=e[t],n=i[1].firstChild;if(null!==n)return Cd(i,n)}return e[7]}function Hg(r,e,t,i,n,s,a){for(;null!=t;){const o=i[t.index],l=t.type;if(a&&0===e&&(o&&cr(Dn(o),i),t.flags|=4),64!=(64&t.flags))if(8&l)Hg(r,e,t.child,i,n,s,!1),ec(e,r,n,o,s);else if(32&l){const c=wg(t,i);let u;for(;u=c();)ec(e,r,n,u,s);ec(e,r,n,o,s)}else 16&l?CS(r,e,i,t,n,s):ec(e,r,n,o,s);t=a?t.projectionNext:t.next}}function Pu(r,e,t,i,n,s){Hg(t,i,r.firstChild,e,n,s,!1)}function CS(r,e,t,i,n,s){const a=t[16],l=a[6].projection[i.projection];if(Array.isArray(l))for(let c=0;c<l.length;c++)ec(e,r,n,l[c],s);else Hg(r,e,l,a[3],n,s,!0)}function IS(r,e,t){gn(r)?r.setAttribute(e,"style",t):e.style.cssText=t}function zg(r,e,t){gn(r)?""===t?r.removeAttribute(e,"class"):r.setAttribute(e,"class",t):e.className=t}class sl{constructor(e){this.changingThisBreaksApplicationSecurity=e}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see https://g.co/ng/security#xss)`}}function da(r,e){const t=function PS(r){return r instanceof sl&&r.getTypeName()||null}(r);if(null!=t&&t!==e){if("ResourceURL"===t&&"URL"===e)return!0;throw new Error(`Required a safe ${e}, got a ${t} (see https://g.co/ng/security#xss)`)}return t===e}const sB=/^(?:(?:https?|mailto|ftp|tel|file|sms):|[^&:/?#]*(?:[/?#]|$))/gi,aB=/^data:(?:image\/(?:bmp|gif|jpeg|jpg|png|tiff|webp)|video\/(?:mpeg|mp4|ogg|webm)|audio\/(?:mp3|oga|ogg|opus));base64,[a-z0-9+\/]+=*$/i;var zi=(()=>((zi=zi||{})[zi.NONE=0]="NONE",zi[zi.HTML=1]="HTML",zi[zi.STYLE=2]="STYLE",zi[zi.SCRIPT=3]="SCRIPT",zi[zi.URL=4]="URL",zi[zi.RESOURCE_URL=5]="RESOURCE_URL",zi))();function Qg(r){const e=function Fu(){const r=Ge();return r&&r[12]}();return e?e.sanitize(zi.URL,r)||"":da(r,"URL")?function es(r){return r instanceof sl?r.changingThisBreaksApplicationSecurity:r}(r):function wu(r){return(r=String(r)).match(sB)||r.match(aB)?r:"unsafe:"+r}(st(r))}function qg(r){return r.ngOriginalError}function xB(r,...e){r.error(...e)}class Nu{constructor(){this._console=console}handleError(e){const t=this._findOriginalError(e),i=function SB(r){return r&&r.ngErrorLogger||xB}(e);i(this._console,"ERROR",e),t&&i(this._console,"ORIGINAL ERROR",t)}_findOriginalError(e){let t=e&&qg(e);for(;t&&qg(t);)t=qg(t);return t||null}}const MB=(()=>("undefined"!=typeof requestAnimationFrame&&requestAnimationFrame||setTimeout).bind(Ni))();function pa(r){return r instanceof Function?r():r}function HS(r,e,t){let i=r.length;for(;;){const n=r.indexOf(e,t);if(-1===n)return n;if(0===n||r.charCodeAt(n-1)<=32){const s=e.length;if(n+s===i||r.charCodeAt(n+s)<=32)return n}t=n+1}}const zS="ng-template";function OB(r,e,t){let i=0;for(;i<r.length;){let n=r[i++];if(t&&"class"===n){if(n=r[i],-1!==HS(n.toLowerCase(),e,0))return!0}else if(1===n){for(;i<r.length&&"string"==typeof(n=r[i++]);)if(n.toLowerCase()===e)return!0;return!1}}return!1}function WS(r){return 4===r.type&&r.value!==zS}function FB(r,e,t){return e===(4!==r.type||t?r.value:zS)}function NB(r,e,t){let i=4;const n=r.attrs||[],s=function UB(r){for(let e=0;e<r.length;e++)if(Fv(r[e]))return e;return r.length}(n);let a=!1;for(let o=0;o<e.length;o++){const l=e[o];if("number"!=typeof l){if(!a)if(4&i){if(i=2|1&i,""!==l&&!FB(r,l,t)||""===l&&1===e.length){if(Vs(i))return!1;a=!0}}else{const c=8&i?l:e[++o];if(8&i&&null!==r.attrs){if(!OB(r.attrs,c,t)){if(Vs(i))return!1;a=!0}continue}const h=LB(8&i?"class":l,n,WS(r),t);if(-1===h){if(Vs(i))return!1;a=!0;continue}if(""!==c){let d;d=h>s?"":n[h+1].toLowerCase();const f=8&i?d:null;if(f&&-1!==HS(f,c,0)||2&i&&c!==d){if(Vs(i))return!1;a=!0}}}}else{if(!a&&!Vs(i)&&!Vs(l))return!1;if(a&&Vs(l))continue;a=!1,i=l|1&i}}return Vs(i)||a}function Vs(r){return 0==(1&r)}function LB(r,e,t,i){if(null===e)return-1;let n=0;if(i||!t){let s=!1;for(;n<e.length;){const a=e[n];if(a===r)return n;if(3===a||6===a)s=!0;else{if(1===a||2===a){let o=e[++n];for(;"string"==typeof o;)o=e[++n];continue}if(4===a)break;if(0===a){n+=4;continue}}n+=s?1:2}return-1}return function VB(r,e){let t=r.indexOf(4);if(t>-1)for(t++;t<r.length;){const i=r[t];if("number"==typeof i)return-1;if(i===e)return t;t++}return-1}(e,r)}function XS(r,e,t=!1){for(let i=0;i<e.length;i++)if(NB(r,e[i],t))return!0;return!1}function YS(r,e){return r?":not("+e.trim()+")":e}function GB(r){let e=r[0],t=1,i=2,n="",s=!1;for(;t<r.length;){let a=r[t];if("string"==typeof a)if(2&i){const o=r[++t];n+="["+a+(o.length>0?'="'+o+'"':"")+"]"}else 8&i?n+="."+a:4&i&&(n+=" "+a);else""!==n&&!Vs(a)&&(e+=YS(s,n),n=""),i=a,s=s||!Vs(i);t++}return""!==n&&(e+=YS(s,n)),e}const Kt={};function ur(r){jS(vi(),Ge(),xr()+r,!1)}function jS(r,e,t,i){if(!i)if(3==(3&e[2])){const s=r.preOrderCheckHooks;null!==s&&cd(e,s,t)}else{const s=r.preOrderHooks;null!==s&&ud(e,s,0,t)}vo(t)}function rx(r,e){const t=r.contentQueries;if(null!==t)for(let i=0;i<t.length;i+=2){const n=t[i],s=t[i+1];if(-1!==s){const a=r.data[s];dg(n),a.contentQueries(2,e[s],s)}}}function Lu(r,e,t,i,n,s,a,o,l,c){const u=e.blueprint.slice();return u[0]=n,u[2]=140|i,vv(u),u[3]=u[15]=r,u[8]=t,u[10]=a||r&&r[10],u[11]=o||r&&r[11],u[12]=l||r&&r[12]||null,u[9]=c||r&&r[9]||null,u[6]=s,u[16]=2==e.type?r[16]:u,u}function ic(r,e,t,i,n){let s=r.data[e];if(null===s)s=function u_(r,e,t,i,n){const s=yv(),a=lg(),l=r.data[e]=function sU(r,e,t,i,n,s){return{type:t,index:i,insertBeforeIndex:null,injectorIndex:e?e.injectorIndex:-1,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,propertyBindings:null,flags:0,providerIndexes:0,value:n,attrs:s,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tViews:null,next:null,projectionNext:null,child:null,parent:e,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}(0,a?s:s&&s.parent,t,e,i,n);return null===r.firstChild&&(r.firstChild=l),null!==s&&(a?null==s.child&&null!==l.parent&&(s.child=l):null===s.next&&(s.next=l)),l}(r,e,t,i,n),function A1(){return $t.lFrame.inI18n}()&&(s.flags|=64);else if(64&s.type){s.type=t,s.value=i,s.attrs=n;const a=function mu(){const r=$t.lFrame,e=r.currentTNode;return r.isParent?e:e.parent}();s.injectorIndex=null===a?-1:a.injectorIndex}return ua(s,!0),s}function nc(r,e,t,i){if(0===t)return-1;const n=e.length;for(let s=0;s<t;s++)e.push(i),r.blueprint.push(i),r.data.push(null);return n}function Bu(r,e,t){ad(e);try{const i=r.viewQuery;null!==i&&E_(1,i,t);const n=r.template;null!==n&&sx(r,e,n,1,t),r.firstCreatePass&&(r.firstCreatePass=!1),r.staticContentQueries&&rx(r,e),r.staticViewQueries&&E_(2,r.viewQuery,t);const s=r.components;null!==s&&function iU(r,e){for(let t=0;t<e.length;t++)AU(r,e[t])}(e,s)}catch(i){throw r.firstCreatePass&&(r.incompleteFirstPass=!0,r.firstCreatePass=!1),i}finally{e[2]&=-5,od()}}function rc(r,e,t,i){const n=e[2];if(256!=(256&n)){ad(e);try{vv(e),function bv(r){return $t.lFrame.bindingIndex=r}(r.bindingStartIndex),null!==t&&sx(r,e,t,2,i);const a=3==(3&n);if(a){const c=r.preOrderCheckHooks;null!==c&&cd(e,c,null)}else{const c=r.preOrderHooks;null!==c&&ud(e,c,0,null),fg(e,0)}if(function SU(r){for(let e=Og(r);null!==e;e=Fg(e)){if(!e[2])continue;const t=e[9];for(let i=0;i<t.length;i++){const n=t[i],s=n[3];0==(1024&n[2])&&og(s,1),n[2]|=1024}}}(e),function vU(r){for(let e=Og(r);null!==e;e=Fg(e))for(let t=10;t<e.length;t++){const i=e[t],n=i[1];ag(i)&&rc(n,i,n.template,i[8])}}(e),null!==r.contentQueries&&rx(r,e),a){const c=r.contentCheckHooks;null!==c&&cd(e,c)}else{const c=r.contentHooks;null!==c&&ud(e,c,1),fg(e,1)}!function eU(r,e){const t=r.hostBindingOpCodes;if(null!==t)try{for(let i=0;i<t.length;i++){const n=t[i];if(n<0)vo(~n);else{const s=n,a=t[++i],o=t[++i];y1(a,s),o(2,e[s])}}}finally{vo(-1)}}(r,e);const o=r.components;null!==o&&function tU(r,e){for(let t=0;t<e.length;t++)xU(r,e[t])}(e,o);const l=r.viewQuery;if(null!==l&&E_(2,l,i),a){const c=r.viewCheckHooks;null!==c&&cd(e,c)}else{const c=r.viewHooks;null!==c&&ud(e,c,2),fg(e,2)}!0===r.firstUpdatePass&&(r.firstUpdatePass=!1),e[2]&=-73,1024&e[2]&&(e[2]&=-1025,og(e[3],-1))}finally{od()}}}function nU(r,e,t,i){const n=e[10],a=Ev(e);try{!a&&n.begin&&n.begin(),a&&Bu(r,e,i),rc(r,e,t,i)}finally{!a&&n.end&&n.end()}}function sx(r,e,t,i,n){const s=xr(),a=2&i;try{vo(-1),a&&e.length>20&&jS(r,e,20,!1),t(i,n)}finally{vo(s)}}function h_(r,e,t){!xv()||(function dU(r,e,t,i){const n=t.directiveStart,s=t.directiveEnd;r.firstCreatePass||vu(t,e),cr(i,e);const a=t.initialInputs;for(let o=n;o<s;o++){const l=r.data[o],c=Us(l);c&&mU(e,t,l);const u=Su(e,r,o,t);cr(u,e),null!==a&&TU(0,o-n,u,l,0,a),c&&(Zr(t.index,e)[8]=u)}}(r,e,t,Qr(t,e)),128==(128&t.flags)&&function fU(r,e,t){const i=t.directiveStart,n=t.directiveEnd,a=t.index,o=function b1(){return $t.lFrame.currentDirectiveIndex}();try{vo(a);for(let l=i;l<n;l++){const c=r.data[l],u=e[l];ug(l),(null!==c.hostBindings||0!==c.hostVars||null!==c.hostAttrs)&&px(c,u)}}finally{vo(-1),ug(o)}}(r,e,t))}function d_(r,e,t=Qr){const i=e.localNames;if(null!==i){let n=e.index+1;for(let s=0;s<i.length;s+=2){const a=i[s+1],o=-1===a?t(e,r):r[a];r[n++]=o}}}function ox(r){const e=r.tView;return null===e||e.incompleteFirstPass?r.tView=Od(1,null,r.template,r.decls,r.vars,r.directiveDefs,r.pipeDefs,r.viewQuery,r.schemas,r.consts):e}function Od(r,e,t,i,n,s,a,o,l,c){const u=20+i,h=u+n,d=function rU(r,e){const t=[];for(let i=0;i<e;i++)t.push(i<r?null:Kt);return t}(u,h),f="function"==typeof c?c():c;return d[1]={type:r,blueprint:d,template:t,queries:null,viewQuery:o,declTNode:e,data:d.slice().fill(null,u),bindingStartIndex:u,expandoStartIndex:h,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:"function"==typeof s?s():s,pipeRegistry:"function"==typeof a?a():a,firstChild:null,schemas:l,consts:f,incompleteFirstPass:!1}}function ux(r,e,t,i){const n=vx(e);null===t?n.push(i):(n.push(t),r.firstCreatePass&&Sx(r).push(i,n.length-1))}function hx(r,e,t){for(let i in r)if(r.hasOwnProperty(i)){const n=r[i];(t=null===t?{}:t).hasOwnProperty(i)?t[i].push(e,n):t[i]=[e,n]}return t}function f_(r,e,t,i){let n=!1;if(xv()){const s=function pU(r,e,t){const i=r.directiveRegistry;let n=null;if(i)for(let s=0;s<i.length;s++){const a=i[s];XS(t,a.selectors,!1)&&(n||(n=[]),gd(vu(t,e),r,a.type),Us(a)?(gx(r,t),n.unshift(a)):n.push(a))}return n}(r,e,t),a=null===i?null:{"":-1};if(null!==s){n=!0,_x(t,r.data.length,s.length);for(let u=0;u<s.length;u++){const h=s[u];h.providersResolver&&h.providersResolver(h)}let o=!1,l=!1,c=nc(r,e,s.length,null);for(let u=0;u<s.length;u++){const h=s[u];t.mergedAttrs=dd(t.mergedAttrs,h.hostAttrs),mx(r,t,e,c,h),_U(c,h,a),null!==h.contentQueries&&(t.flags|=8),(null!==h.hostBindings||null!==h.hostAttrs||0!==h.hostVars)&&(t.flags|=128);const d=h.type.prototype;!o&&(d.ngOnChanges||d.ngOnInit||d.ngDoCheck)&&((r.preOrderHooks||(r.preOrderHooks=[])).push(t.index),o=!0),!l&&(d.ngOnChanges||d.ngDoCheck)&&((r.preOrderCheckHooks||(r.preOrderCheckHooks=[])).push(t.index),l=!0),c++}!function aU(r,e){const i=e.directiveEnd,n=r.data,s=e.attrs,a=[];let o=null,l=null;for(let c=e.directiveStart;c<i;c++){const u=n[c],h=u.inputs,d=null===s||WS(e)?null:EU(h,s);a.push(d),o=hx(h,c,o),l=hx(u.outputs,c,l)}null!==o&&(o.hasOwnProperty("class")&&(e.flags|=16),o.hasOwnProperty("style")&&(e.flags|=32)),e.initialInputs=a,e.inputs=o,e.outputs=l}(r,t)}a&&function gU(r,e,t){if(e){const i=r.localNames=[];for(let n=0;n<e.length;n+=2){const s=t[e[n+1]];if(null==s)throw new Ke(-301,!1);i.push(e[n],s)}}}(t,i,a)}return t.mergedAttrs=dd(t.mergedAttrs,t.attrs),n}function fx(r,e,t,i,n,s){const a=s.hostBindings;if(a){let o=r.hostBindingOpCodes;null===o&&(o=r.hostBindingOpCodes=[]);const l=~e.index;(function hU(r){let e=r.length;for(;e>0;){const t=r[--e];if("number"==typeof t&&t<0)return t}return 0})(o)!=l&&o.push(l),o.push(i,n,a)}}function px(r,e){null!==r.hostBindings&&r.hostBindings(1,e)}function gx(r,e){e.flags|=2,(r.components||(r.components=[])).push(e.index)}function _U(r,e,t){if(t){if(e.exportAs)for(let i=0;i<e.exportAs.length;i++)t[e.exportAs[i]]=r;Us(e)&&(t[""]=r)}}function _x(r,e,t){r.flags|=1,r.directiveStart=e,r.directiveEnd=e+t,r.providerIndexes=e}function mx(r,e,t,i,n){r.data[i]=n;const s=n.factory||(n.factory=tl(n.type)),a=new Tu(s,Us(n),null);r.blueprint[i]=a,t[i]=a,fx(r,e,0,i,nc(r,t,n.hostVars,Kt),n)}function mU(r,e,t){const i=Qr(e,r),n=ox(t),s=r[10],a=Fd(r,Lu(r,n,null,t.onPush?64:16,i,e,s,s.createRenderer(i,t),null,null));r[e.index]=a}function TU(r,e,t,i,n,s){const a=s[e];if(null!==a){const o=i.setInput;for(let l=0;l<a.length;){const c=a[l++],u=a[l++],h=a[l++];null!==o?i.setInput(t,h,c,u):t[u]=h}}}function EU(r,e){let t=null,i=0;for(;i<e.length;){const n=e[i];if(0!==n)if(5!==n){if("number"==typeof n)break;r.hasOwnProperty(n)&&(null===t&&(t=[]),t.push(n,r[n],e[i+1])),i+=2}else i+=2;else i+=4}return t}function Tx(r,e,t,i){return new Array(r,!0,!1,e,null,0,i,t,null,null)}function xU(r,e){const t=Zr(e,r);if(ag(t)){const i=t[1];80&t[2]?rc(i,t,i.template,t[8]):t[5]>0&&g_(t)}}function g_(r){for(let i=Og(r);null!==i;i=Fg(i))for(let n=10;n<i.length;n++){const s=i[n];if(1024&s[2]){const a=s[1];rc(a,s,a.template,s[8])}else s[5]>0&&g_(s)}const t=r[1].components;if(null!==t)for(let i=0;i<t.length;i++){const n=Zr(t[i],r);ag(n)&&n[5]>0&&g_(n)}}function AU(r,e){const t=Zr(e,r),i=t[1];(function yU(r,e){for(let t=e.length;t<r.blueprint.length;t++)e.push(r.blueprint[t])})(i,t),Bu(i,t,t[8])}function Fd(r,e){return r[13]?r[14][4]=e:r[13]=e,r[14]=e,e}function __(r){for(;r;){r[2]|=64;const e=Du(r);if(t1(r)&&!e)return r;r=e}return null}function Ex(r){!function m_(r){for(let e=0;e<r.components.length;e++){const t=r.components[e],i=Dg(t),n=i[1];nU(n,i,n.template,t)}}(r[8])}function E_(r,e,t){dg(0),e(r,t)}const CU=(()=>Promise.resolve(null))();function vx(r){return r[7]||(r[7]=[])}function Sx(r){return r.cleanup||(r.cleanup=[])}function Ax(r,e){const t=r[9],i=t?t.get(Nu,null):null;i&&i.handleError(e)}function yx(r,e,t,i,n){for(let s=0;s<t.length;){const a=t[s++],o=t[s++],l=e[a],c=r.data[a];null!==c.setInput?c.setInput(l,n,i,o):l[o]=n}}function Wa(r,e,t){const i=function rd(r,e){return Dn(e[r])}(e,r);!function pS(r,e,t){gn(r)?r.setValue(e,t):e.textContent=t}(r[11],i,t)}function Nd(r,e,t){let i=t?r.styles:null,n=t?r.classes:null,s=0;if(null!==e)for(let a=0;a<e.length;a++){const o=e[a];"number"==typeof o?s=o:1==s?n=we(n,o):2==s&&(i=we(i,o+": "+e[++a]+";"))}t?r.styles=i:r.stylesWithoutHost=i,t?r.classes=n:r.classesWithoutHost=n}const v_=new oi("INJECTOR",-1);class bx{get(e,t=bu){if(t===bu){const i=new Error(`NullInjectorError: No provider for ${q(e)}!`);throw i.name="NullInjectorError",i}return t}}const S_=new oi("Set Injector scope."),Uu={},MU={};let x_;function Cx(){return void 0===x_&&(x_=new bx),x_}function Ix(r,e=null,t=null,i){const n=Rx(r,e,t,i);return n._resolveInjectorDefTypes(),n}function Rx(r,e=null,t=null,i){return new DU(r,t,e||Cx(),i)}class DU{constructor(e,t,i,n=null){this.parent=i,this.records=new Map,this.injectorDefTypes=new Set,this.onDestroy=new Set,this._destroyed=!1;const s=[];t&&ha(t,o=>this.processProvider(o,e,t)),ha([e],o=>this.processInjectorType(o,[],s)),this.records.set(v_,sc(void 0,this));const a=this.records.get(S_);this.scope=null!=a?a.value:null,this.source=n||("object"==typeof e?null:q(e))}get destroyed(){return this._destroyed}destroy(){this.assertNotDestroyed(),this._destroyed=!0;try{this.onDestroy.forEach(e=>e.ngOnDestroy())}finally{this.records.clear(),this.onDestroy.clear(),this.injectorDefTypes.clear()}}get(e,t=bu,i=Ht.Default){this.assertNotDestroyed();const n=qv(this),s=Os(void 0);try{if(!(i&Ht.SkipSelf)){let o=this.records.get(e);if(void 0===o){const l=function UU(r){return"function"==typeof r||"object"==typeof r&&r instanceof oi}(e)&&uu(e);o=l&&this.injectableDefInScope(l)?sc(A_(e),Uu):null,this.records.set(e,o)}if(null!=o)return this.hydrate(e,o)}return(i&Ht.Self?Cx():this.parent).get(e,t=i&Ht.Optional&&t===bu?null:t)}catch(a){if("NullInjectorError"===a.name){if((a[Ed]=a[Ed]||[]).unshift(q(e)),n)throw a;return function lL(r,e,t,i){const n=r[Ed];throw e[Zv]&&n.unshift(e[Zv]),r.message=function cL(r,e,t,i=null){r=r&&"\n"===r.charAt(0)&&"\u0275"==r.charAt(1)?r.substr(2):r;let n=q(e);if(Array.isArray(e))n=e.map(q).join(" -> ");else if("object"==typeof e){let s=[];for(let a in e)if(e.hasOwnProperty(a)){let o=e[a];s.push(a+":"+("string"==typeof o?JSON.stringify(o):q(o)))}n=`{${s.join(", ")}}`}return`${t}${i?"("+i+")":""}[${n}]: ${r.replace(nL,"\n  ")}`}("\n"+r.message,n,t,i),r.ngTokenPath=n,r[Ed]=null,r}(a,e,"R3InjectorError",this.source)}throw a}finally{Os(s),qv(n)}}_resolveInjectorDefTypes(){this.injectorDefTypes.forEach(e=>this.get(e))}toString(){const e=[];return this.records.forEach((i,n)=>e.push(q(n))),`R3Injector[${e.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new Ke(205,!1)}processInjectorType(e,t,i){if(!(e=ae(e)))return!1;let n=_o(e);const s=null==n&&e.ngModule||void 0,a=void 0===s?e:s,o=-1!==i.indexOf(a);if(void 0!==s&&(n=_o(s)),null==n)return!1;if(null!=n.imports&&!o){let u;i.push(a);try{ha(n.imports,h=>{this.processInjectorType(h,t,i)&&(void 0===u&&(u=[]),u.push(h))})}finally{}if(void 0!==u)for(let h=0;h<u.length;h++){const{ngModule:d,providers:f}=u[h];ha(f,p=>this.processProvider(p,d,f||Ui))}}this.injectorDefTypes.add(a);const l=tl(a)||(()=>new a);this.records.set(a,sc(l,Uu));const c=n.providers;if(null!=c&&!o){const u=e;ha(c,h=>this.processProvider(h,u,c))}return void 0!==s&&void 0!==e.providers}processProvider(e,t,i){let n=ac(e=ae(e))?e:ae(e&&e.provide);const s=function wU(r,e,t){return Dx(r)?sc(void 0,r.useValue):sc(function Mx(r,e,t){let i;if(ac(r)){const n=ae(r);return tl(n)||A_(n)}if(Dx(r))i=()=>ae(r.useValue);else if(function FU(r){return!(!r||!r.useFactory)}(r))i=()=>r.useFactory(...Cg(r.deps||[]));else if(function OU(r){return!(!r||!r.useExisting)}(r))i=()=>rt(ae(r.useExisting));else{const n=ae(r&&(r.useClass||r.provide));if(!function LU(r){return!!r.deps}(r))return tl(n)||A_(n);i=()=>new n(...Cg(r.deps))}return i}(r),Uu)}(e);if(ac(e)||!0!==e.multi)this.records.get(n);else{let a=this.records.get(n);a||(a=sc(void 0,Uu,!0),a.factory=()=>Cg(a.multi),this.records.set(n,a)),n=e,a.multi.push(e)}this.records.set(n,s)}hydrate(e,t){return t.value===Uu&&(t.value=MU,t.value=t.factory()),"object"==typeof t.value&&t.value&&function BU(r){return null!==r&&"object"==typeof r&&"function"==typeof r.ngOnDestroy}(t.value)&&this.onDestroy.add(t.value),t.value}injectableDefInScope(e){if(!e.providedIn)return!1;const t=ae(e.providedIn);return"string"==typeof t?"any"===t||t===this.scope:this.injectorDefTypes.has(t)}}function A_(r){const e=uu(r),t=null!==e?e.factory:tl(r);if(null!==t)return t;if(r instanceof oi)throw new Ke(204,!1);if(r instanceof Function)return function PU(r){const e=r.length;if(e>0)throw function yu(r,e){const t=[];for(let i=0;i<r;i++)t.push(e);return t}(e,"?"),new Ke(204,!1);const t=function Qh(r){const e=r&&(r[Jo]||r[Zh]);if(e){const t=function ws(r){if(r.hasOwnProperty("name"))return r.name;const e=(""+r).match(/^function\s*([^\s(]+)/);return null===e?"":e[1]}(r);return console.warn(`DEPRECATED: DI is instantiating a token "${t}" that inherits its @Injectable decorator but does not provide one itself.\nThis will become an error in a future version of Angular. Please add @Injectable() to the "${t}" class.`),e}return null}(r);return null!==t?()=>t.factory(r):()=>new r}(r);throw new Ke(204,!1)}function sc(r,e,t=!1){return{factory:r,value:e,multi:t?[]:void 0}}function Dx(r){return null!==r&&"object"==typeof r&&sL in r}function ac(r){return"function"==typeof r}let Gs=(()=>{class r{static create(t,i){var n;if(Array.isArray(t))return Ix({name:""},i,t,"");{const s=null!==(n=t.name)&&void 0!==n?n:"";return Ix({name:s},t.parent,t.providers,s)}}}return r.THROW_IF_NOT_FOUND=bu,r.NULL=new bx,r.\u0275prov=St({token:r,providedIn:"any",factory:()=>rt(v_)}),r.__NG_ELEMENT_ID__=-1,r})();function YU(r,e){ld(Dg(r)[1],Gn())}function Vt(r){let e=function Hx(r){return Object.getPrototypeOf(r.prototype).constructor}(r.type),t=!0;const i=[r];for(;e;){let n;if(Us(r))n=e.\u0275cmp||e.\u0275dir;else{if(e.\u0275cmp)throw new Ke(903,"");n=e.\u0275dir}if(n){if(t){i.push(n);const a=r;a.inputs=C_(r.inputs),a.declaredInputs=C_(r.declaredInputs),a.outputs=C_(r.outputs);const o=n.hostBindings;o&&QU(r,o);const l=n.viewQuery,c=n.contentQueries;if(l&&$U(r,l),c&&KU(r,c),ie(r.inputs,n.inputs),ie(r.declaredInputs,n.declaredInputs),ie(r.outputs,n.outputs),Us(n)&&n.data.animation){const u=r.data;u.animation=(u.animation||[]).concat(n.data.animation)}}const s=n.features;if(s)for(let a=0;a<s.length;a++){const o=s[a];o&&o.ngInherit&&o(r),o===Vt&&(t=!1)}}e=Object.getPrototypeOf(e)}!function jU(r){let e=0,t=null;for(let i=r.length-1;i>=0;i--){const n=r[i];n.hostVars=e+=n.hostVars,n.hostAttrs=dd(n.hostAttrs,t=dd(t,n.hostAttrs))}}(i)}function C_(r){return r===oa?{}:r===Ui?[]:r}function $U(r,e){const t=r.viewQuery;r.viewQuery=t?(i,n)=>{e(i,n),t(i,n)}:e}function KU(r,e){const t=r.contentQueries;r.contentQueries=t?(i,n,s)=>{e(i,n,s),t(i,n,s)}:e}function QU(r,e){const t=r.hostBindings;r.hostBindings=t?(i,n)=>{e(i,n),t(i,n)}:e}let Ld=null;function oc(){if(!Ld){const r=Ni.Symbol;if(r&&r.iterator)Ld=r.iterator;else{const e=Object.getOwnPropertyNames(Map.prototype);for(let t=0;t<e.length;++t){const i=e[t];"entries"!==i&&"size"!==i&&Map.prototype[i]===Map.prototype.entries&&(Ld=i)}}}return Ld}function Vu(r){return!!function I_(r){return null!==r&&("function"==typeof r||"object"==typeof r)}(r)&&(Array.isArray(r)||!(r instanceof Map)&&oc()in r)}function _a(r,e,t){return r[e]=t}function hr(r,e,t){return!Object.is(r[e],t)&&(r[e]=t,!0)}function ol(r,e,t,i,n,s,a,o){const l=Ge(),c=vi(),u=r+20,h=c.firstCreatePass?function n2(r,e,t,i,n,s,a,o,l){const c=e.consts,u=ic(e,r,4,a||null,Eo(c,o));f_(e,t,u,Eo(c,l)),ld(e,u);const h=u.tViews=Od(2,u,i,n,s,e.directiveRegistry,e.pipeRegistry,null,e.schemas,c);return null!==e.queries&&(e.queries.template(e,u),h.queries=e.queries.embeddedTView(u)),u}(u,c,l,e,t,i,n,s,a):c.data[u];ua(h,!1);const d=l[11].createComment("");bd(c,l,d,h),cr(d,l),Fd(l,l[u]=Tx(d,l,d,h)),nd(h)&&h_(c,l,h),null!=a&&d_(l,h,o)}function de(r,e=Ht.Default){const t=Ge();return null===t?rt(r,e):Gv(Gn(),t,ae(r),e)}function ys(r,e,t){const i=Ge();return hr(i,Wl(),e)&&function ts(r,e,t,i,n,s,a,o){const l=Qr(e,t);let u,c=e.inputs;!o&&null!=c&&(u=c[i])?(yx(r,t,u,i,n),id(e)&&function lU(r,e){const t=Zr(e,r);16&t[2]||(t[2]|=64)}(t,e.index)):3&e.type&&(i=function oU(r){return"class"===r?"className":"for"===r?"htmlFor":"formaction"===r?"formAction":"innerHtml"===r?"innerHTML":"readonly"===r?"readOnly":"tabindex"===r?"tabIndex":r}(i),n=null!=a?a(n,e.value||"",i):n,gn(s)?s.setProperty(l,i,n):gg(i)||(l.setProperty?l.setProperty(i,n):l[i]=n))}(vi(),function on(){const r=$t.lFrame;return sg(r.tView,r.selectedIndex)}(),i,r,e,i[11],t,!1),ys}function w_(r,e,t,i,n){const a=n?"class":"style";yx(r,t,e.inputs[a],a,i)}function yr(r,e,t,i){const n=Ge(),s=vi(),a=20+r,o=n[11],l=n[a]=Lg(o,e,function O1(){return $t.lFrame.currentNamespace}()),c=s.firstCreatePass?function b2(r,e,t,i,n,s,a){const o=e.consts,c=ic(e,r,2,n,Eo(o,s));return f_(e,t,c,Eo(o,a)),null!==c.attrs&&Nd(c,c.attrs,!1),null!==c.mergedAttrs&&Nd(c,c.mergedAttrs,!0),null!==e.queries&&e.queries.elementStart(e,c),c}(a,s,n,0,e,t,i):s.data[a];ua(c,!0);const u=c.mergedAttrs;null!==u&&hd(o,l,u);const h=c.classes;null!==h&&zg(o,l,h);const d=c.styles;return null!==d&&IS(o,l,d),64!=(64&c.flags)&&bd(s,n,l,c),0===function m1(){return $t.lFrame.elementDepthCount}()&&cr(l,n),function T1(){$t.lFrame.elementDepthCount++}(),nd(c)&&(h_(s,n,c),function ax(r,e,t){if(qp(e)){const n=e.directiveEnd;for(let s=e.directiveStart;s<n;s++){const a=r.data[s];a.contentQueries&&a.contentQueries(1,t[s],s)}}}(s,c,n)),null!==i&&d_(n,c),yr}function kr(){let r=Gn();lg()?function cg(){$t.lFrame.isParent=!1}():(r=r.parent,ua(r,!1));const e=r;!function E1(){$t.lFrame.elementDepthCount--}();const t=vi();return t.firstCreatePass&&(ld(t,r),qp(r)&&t.queries.elementEnd(r)),null!=e.classesWithoutHost&&function U1(r){return 0!=(16&r.flags)}(e)&&w_(t,e,Ge(),e.classesWithoutHost,!0),null!=e.stylesWithoutHost&&function V1(r){return 0!=(32&r.flags)}(e)&&w_(t,e,Ge(),e.stylesWithoutHost,!1),kr}function yo(r,e,t,i){return yr(r,e,t,i),kr(),yo}function N_(r){return!!r&&"function"==typeof r.then}function dA(r){return!!r&&"function"==typeof r.subscribe}const I2=dA;function Gu(r,e,t,i){const n=Ge(),s=vi(),a=Gn();return function pA(r,e,t,i,n,s,a,o){const l=nd(i),u=r.firstCreatePass&&Sx(r),h=e[8],d=vx(e);let f=!0;if(3&i.type||o){const _=Qr(i,e),m=o?o(_):_,T=d.length,v=o?A=>o(Dn(A[i.index])):i.index;if(gn(t)){let A=null;if(!o&&l&&(A=function R2(r,e,t,i){const n=r.cleanup;if(null!=n)for(let s=0;s<n.length-1;s+=2){const a=n[s];if(a===t&&n[s+1]===i){const o=e[7],l=n[s+2];return o.length>l?o[l]:null}"string"==typeof a&&(s+=2)}return null}(r,e,n,i.index)),null!==A)(A.__ngLastListenerFn__||A).__ngNextListenerFn__=s,A.__ngLastListenerFn__=s,f=!1;else{s=L_(i,e,h,s,!1);const S=t.listen(m,n,s);d.push(s,S),u&&u.push(n,v,T,T+1)}}else s=L_(i,e,h,s,!0),m.addEventListener(n,s,a),d.push(s),u&&u.push(n,v,T,a)}else s=L_(i,e,h,s,!1);const p=i.outputs;let g;if(f&&null!==p&&(g=p[n])){const _=g.length;if(_)for(let m=0;m<_;m+=2){const x=e[g[m]][g[m+1]].subscribe(s),C=d.length;d.push(s,x),u&&u.push(n,i.index,C,-(C+1))}}}(s,n,n[11],a,r,e,!!t,i),Gu}function gA(r,e,t,i){try{return!1!==t(i)}catch(n){return Ax(r,n),!1}}function L_(r,e,t,i,n){return function s(a){if(a===Function)return i;const o=2&r.flags?Zr(r.index,e):e;0==(32&e[2])&&__(o);let l=gA(e,0,i,a),c=s.__ngNextListenerFn__;for(;c;)l=gA(e,0,c,a)&&l,c=c.__ngNextListenerFn__;return n&&!1===l&&(a.preventDefault(),a.returnValue=!1),l}}function Vd(r=1){return function I1(r){return($t.lFrame.contextLView=function R1(r,e){for(;r>0;)e=e[15],r--;return e}(r,$t.lFrame.contextLView))[8]}(r)}function Ea(r,e=""){const t=Ge(),i=vi(),n=r+20,s=i.firstCreatePass?ic(i,n,1,e,null):i.data[n],a=t[n]=function Ng(r,e){return gn(r)?r.createText(e):r.createTextNode(e)}(t[11],e);bd(i,t,a,s),ua(s,!1)}function ll(r){return Gd("",r,""),ll}function Gd(r,e,t){const i=Ge(),n=function cc(r,e,t,i){return hr(r,Wl(),t)?e+st(t)+i:Kt}(i,r,e,t);return n!==Kt&&Wa(i,xr(),n),Gd}const cl=void 0;var gV=["en",[["a","p"],["AM","PM"],cl],[["AM","PM"],cl,cl],[["S","M","T","W","T","F","S"],["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],["Su","Mo","Tu","We","Th","Fr","Sa"]],cl,[["J","F","M","A","M","J","J","A","S","O","N","D"],["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],["January","February","March","April","May","June","July","August","September","October","November","December"]],cl,[["B","A"],["BC","AD"],["Before Christ","Anno Domini"]],0,[6,0],["M/d/yy","MMM d, y","MMMM d, y","EEEE, MMMM d, y"],["h:mm a","h:mm:ss a","h:mm:ss a z","h:mm:ss a zzzz"],["{1}, {0}",cl,"{1} 'at' {0}",cl],[".",",",";","%","+","-","E","\xd7","\u2030","\u221e","NaN",":"],["#,##0.###","#,##0%","\xa4#,##0.00","#E0"],"USD","$","US Dollar",{},"ltr",function pV(r){const t=Math.floor(Math.abs(r)),i=r.toString().replace(/^[^.]*\.?/,"").length;return 1===t&&0===i?1:5}];let Ec={};function br(r){const e=function _V(r){return r.toLowerCase().replace(/_/g,"-")}(r);let t=ay(e);if(t)return t;const i=e.split("-")[0];if(t=ay(i),t)return t;if("en"===i)return gV;throw new Error(`Missing locale data for the locale "${r}".`)}function ay(r){return r in Ec||(Ec[r]=Ni.ng&&Ni.ng.common&&Ni.ng.common.locales&&Ni.ng.common.locales[r]),Ec[r]}var ot=(()=>((ot=ot||{})[ot.LocaleId=0]="LocaleId",ot[ot.DayPeriodsFormat=1]="DayPeriodsFormat",ot[ot.DayPeriodsStandalone=2]="DayPeriodsStandalone",ot[ot.DaysFormat=3]="DaysFormat",ot[ot.DaysStandalone=4]="DaysStandalone",ot[ot.MonthsFormat=5]="MonthsFormat",ot[ot.MonthsStandalone=6]="MonthsStandalone",ot[ot.Eras=7]="Eras",ot[ot.FirstDayOfWeek=8]="FirstDayOfWeek",ot[ot.WeekendRange=9]="WeekendRange",ot[ot.DateFormat=10]="DateFormat",ot[ot.TimeFormat=11]="TimeFormat",ot[ot.DateTimeFormat=12]="DateTimeFormat",ot[ot.NumberSymbols=13]="NumberSymbols",ot[ot.NumberFormats=14]="NumberFormats",ot[ot.CurrencyCode=15]="CurrencyCode",ot[ot.CurrencySymbol=16]="CurrencySymbol",ot[ot.CurrencyName=17]="CurrencyName",ot[ot.Currencies=18]="Currencies",ot[ot.Directionality=19]="Directionality",ot[ot.PluralCase=20]="PluralCase",ot[ot.ExtraData=21]="ExtraData",ot))();const Hd="en-US";let oy=Hd;class wy{}class T3{resolveComponentFactory(e){throw function m3(r){const e=Error(`No component factory found for ${q(r)}. Did you add it to @NgModule.entryComponents?`);return e.ngComponent=r,e}(e)}}let jd=(()=>{class r{}return r.NULL=new T3,r})();function E3(){return Sc(Gn(),Ge())}function Sc(r,e){return new Ii(Qr(r,e))}let Ii=(()=>{class r{constructor(t){this.nativeElement=t}}return r.__NG_ELEMENT_ID__=E3,r})();function v3(r){return r instanceof Ii?r.nativeElement:r}class Fy{}let ju=(()=>{class r{}return r.__NG_ELEMENT_ID__=()=>function x3(){const r=Ge(),t=Zr(Gn().index,r);return function S3(r){return r[11]}(ca(t)?t:r)}(),r})(),A3=(()=>{class r{}return r.\u0275prov=St({token:r,providedIn:"root",factory:()=>null}),r})();class $d{constructor(e){this.full=e,this.major=e.split(".")[0],this.minor=e.split(".")[1],this.patch=e.split(".").slice(2).join(".")}}const y3=new $d("13.4.0"),X_={};function Kd(r,e,t,i,n=!1){for(;null!==t;){const s=e[t.index];if(null!==s&&i.push(Dn(s)),Bs(s))for(let o=10;o<s.length;o++){const l=s[o],c=l[1].firstChild;null!==c&&Kd(l[1],l,c,i)}const a=t.type;if(8&a)Kd(r,e,t.child,i);else if(32&a){const o=wg(t,e);let l;for(;l=o();)i.push(l)}else if(16&a){const o=bS(e,t);if(Array.isArray(o))i.push(...o);else{const l=Du(e[16]);Kd(l[1],l,o,i,!0)}}t=n?t.projectionNext:t.next}return i}class $u{constructor(e,t){this._lView=e,this._cdRefInjectingView=t,this._appRef=null,this._attachedToViewContainer=!1}get rootNodes(){const e=this._lView,t=e[1];return Kd(t,e,t.firstChild,[])}get context(){return this._lView[8]}set context(e){this._lView[8]=e}get destroyed(){return 256==(256&this._lView[2])}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){const e=this._lView[3];if(Bs(e)){const t=e[8],i=t?t.indexOf(this):-1;i>-1&&(Bg(e,i),md(t,i))}this._attachedToViewContainer=!1}_S(this._lView[1],this._lView)}onDestroy(e){ux(this._lView[1],this._lView,null,e)}markForCheck(){__(this._cdRefInjectingView||this._lView)}detach(){this._lView[2]&=-129}reattach(){this._lView[2]|=128}detectChanges(){!function T_(r,e,t){const i=e[10];i.begin&&i.begin();try{rc(r,e,r.template,t)}catch(n){throw Ax(e,n),n}finally{i.end&&i.end()}}(this._lView[1],this._lView,this.context)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new Ke(902,"");this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null,function wL(r,e){Pu(r,e,e[11],2,null,null)}(this._lView[1],this._lView)}attachToAppRef(e){if(this._attachedToViewContainer)throw new Ke(902,"");this._appRef=e}}class b3 extends $u{constructor(e){super(e),this._view=e}detectChanges(){Ex(this._view)}checkNoChanges(){}get context(){return null}}class Ny extends jd{constructor(e){super(),this.ngModule=e}resolveComponentFactory(e){const t=kn(e);return new Y_(t,this.ngModule)}}function Ly(r){const e=[];for(let t in r)r.hasOwnProperty(t)&&e.push({propName:r[t],templateName:t});return e}class Y_ extends wy{constructor(e,t){super(),this.componentDef=e,this.ngModule=t,this.componentType=e.type,this.selector=function HB(r){return r.map(GB).join(",")}(e.selectors),this.ngContentSelectors=e.ngContentSelectors?e.ngContentSelectors:[],this.isBoundToModule=!!t}get inputs(){return Ly(this.componentDef.inputs)}get outputs(){return Ly(this.componentDef.outputs)}create(e,t,i,n){const s=(n=n||this.ngModule)?function I3(r,e){return{get:(t,i,n)=>{const s=r.get(t,X_,n);return s!==X_||i===X_?s:e.get(t,i,n)}}}(e,n.injector):e,a=s.get(Fy,Tv),o=s.get(A3,null),l=a.createRenderer(null,this.componentDef),c=this.componentDef.selectors[0][0]||"div",u=i?function cx(r,e,t){if(gn(r))return r.selectRootElement(e,t===vs.ShadowDom);let i="string"==typeof e?r.querySelector(e):e;return i.textContent="",i}(l,i,this.componentDef.encapsulation):Lg(a.createRenderer(null,this.componentDef),c,function C3(r){const e=r.toLowerCase();return"svg"===e?"svg":"math"===e?"math":null}(c)),h=this.componentDef.onPush?576:528,d=function Gx(r,e){return{components:[],scheduler:r||MB,clean:CU,playerHandler:e||null,flags:0}}(),f=Od(0,null,null,1,0,null,null,null,null,null),p=Lu(null,f,d,h,null,null,a,l,o,s);let g,_;ad(p);try{const m=function Vx(r,e,t,i,n,s){const a=t[1];t[20]=r;const l=ic(a,20,2,"#host",null),c=l.mergedAttrs=e.hostAttrs;null!==c&&(Nd(l,c,!0),null!==r&&(hd(n,r,c),null!==l.classes&&zg(n,r,l.classes),null!==l.styles&&IS(n,r,l.styles)));const u=i.createRenderer(r,e),h=Lu(t,ox(e),null,e.onPush?64:16,t[20],l,i,u,s||null,null);return a.firstCreatePass&&(gd(vu(l,t),a,e.type),gx(a,l),_x(l,t.length,1)),Fd(t,h),t[20]=h}(u,this.componentDef,p,a,l);if(u)if(i)hd(l,u,["ng-version",y3.full]);else{const{attrs:T,classes:v}=function zB(r){const e=[],t=[];let i=1,n=2;for(;i<r.length;){let s=r[i];if("string"==typeof s)2===n?""!==s&&e.push(s,r[++i]):8===n&&t.push(s);else{if(!Vs(n))break;n=s}i++}return{attrs:e,classes:t}}(this.componentDef.selectors[0]);T&&hd(l,u,T),v&&v.length>0&&zg(l,u,v.join(" "))}if(_=sg(f,20),void 0!==t){const T=_.projection=[];for(let v=0;v<this.ngContentSelectors.length;v++){const A=t[v];T.push(null!=A?Array.from(A):null)}}g=function kx(r,e,t,i,n){const s=t[1],a=function uU(r,e,t){const i=Gn();r.firstCreatePass&&(t.providersResolver&&t.providersResolver(t),mx(r,i,e,nc(r,e,1,null),t));const n=Su(e,r,i.directiveStart,i);cr(n,e);const s=Qr(i,e);return s&&cr(s,e),n}(s,t,e);if(i.components.push(a),r[8]=a,n&&n.forEach(l=>l(a,e)),e.contentQueries){const l=Gn();e.contentQueries(1,a,l.directiveStart)}const o=Gn();return!s.firstCreatePass||null===e.hostBindings&&null===e.hostAttrs||(vo(o.index),fx(t[1],o,0,o.directiveStart,o.directiveEnd,e),px(e,a)),a}(m,this.componentDef,p,d,[YU]),Bu(f,p,null)}finally{od()}return new M3(this.componentType,g,Sc(_,p),p,_)}}class M3 extends class _3{}{constructor(e,t,i,n,s){super(),this.location=i,this._rootLView=n,this._tNode=s,this.instance=t,this.hostView=this.changeDetectorRef=new b3(n),this.componentType=e}get injector(){return new jl(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(e){this.hostView.onDestroy(e)}}class xc{}const Ac=new Map;class Vy extends xc{constructor(e,t){super(),this._parent=t,this._bootstrapComponents=[],this.injector=this,this.destroyCbs=[],this.componentFactoryResolver=new Ny(this);const i=Ur(e);this._bootstrapComponents=pa(i.bootstrap),this._r3Injector=Rx(e,t,[{provide:xc,useValue:this},{provide:jd,useValue:this.componentFactoryResolver}],q(e)),this._r3Injector._resolveInjectorDefTypes(),this.instance=this.get(e)}get(e,t=Gs.THROW_IF_NOT_FOUND,i=Ht.Default){return e===Gs||e===xc||e===v_?this:this._r3Injector.get(e,t,i)}destroy(){const e=this._r3Injector;!e.destroyed&&e.destroy(),this.destroyCbs.forEach(t=>t()),this.destroyCbs=null}onDestroy(e){this.destroyCbs.push(e)}}class j_ extends class P3{}{constructor(e){super(),this.moduleType=e,null!==Ur(e)&&function w3(r){const e=new Set;!function t(i){const n=Ur(i,!0),s=n.id;null!==s&&(function By(r,e,t){if(e&&e!==t)throw new Error(`Duplicate module registered for ${r} - ${q(e)} vs ${q(e.name)}`)}(s,Ac.get(s),i),Ac.set(s,i));const a=pa(n.imports);for(const o of a)e.has(o)||(e.add(o),t(o))}(r)}(e)}create(e){return new Vy(this.moduleType,e)}}function Ku(r,e){const t=r[e];return t===Kt?void 0:t}function Gy(r,e,t,i,n,s,a){const o=e+t;return function al(r,e,t,i){const n=hr(r,e,t);return hr(r,e+1,i)||n}(r,o,n,s)?_a(r,o+2,a?i.call(a,n,s):i(n,s)):Ku(r,o+2)}function ul(r,e){const t=vi();let i;const n=r+20;t.firstCreatePass?(i=function z3(r,e){if(e)for(let t=e.length-1;t>=0;t--){const i=e[t];if(r===i.name)return i}}(e,t.pipeRegistry),t.data[n]=i,i.onDestroy&&(t.destroyHooks||(t.destroyHooks=[])).push(n,i.onDestroy)):i=t.data[n];const s=i.factory||(i.factory=tl(i.type)),a=Os(de);try{const o=fd(!1),l=s();return fd(o),function r2(r,e,t,i){t>=r.data.length&&(r.data[t]=null,r.blueprint[t]=null),e[t]=i}(t,Ge(),n,l),l}finally{Os(a)}}function yc(r,e,t){const i=r+20,n=Ge(),s=zl(n,i);return Qu(n,i)?function ky(r,e,t,i,n,s){const a=e+t;return hr(r,a,n)?_a(r,a+1,s?i.call(s,n):i(n)):Ku(r,a+1)}(n,Sr(),e,s.transform,t,s):s.transform(t)}function Qu(r,e){return r[1].data[e].pure}function $_(r){return e=>{setTimeout(r,void 0,e)}}const is=class j3 extends he.xQ{constructor(e=!1){super(),this.__isAsync=e}emit(e){super.next(e)}subscribe(e,t,i){var n,s,a;let o=e,l=t||(()=>null),c=i;if(e&&"object"==typeof e){const h=e;o=null===(n=h.next)||void 0===n?void 0:n.bind(h),l=null===(s=h.error)||void 0===s?void 0:s.bind(h),c=null===(a=h.complete)||void 0===a?void 0:a.bind(h)}this.__isAsync&&(l=$_(l),o&&(o=$_(o)),c&&(c=$_(c)));const u=super.subscribe({next:o,error:l,complete:c});return e instanceof xe.w&&e.add(u),u}};function $3(){return this._results[oc()]()}class K_{constructor(e=!1){this._emitDistinctChangesOnly=e,this.dirty=!0,this._results=[],this._changesDetected=!1,this._changes=null,this.length=0,this.first=void 0,this.last=void 0;const t=oc(),i=K_.prototype;i[t]||(i[t]=$3)}get changes(){return this._changes||(this._changes=new is)}get(e){return this._results[e]}map(e){return this._results.map(e)}filter(e){return this._results.filter(e)}find(e){return this._results.find(e)}reduce(e,t){return this._results.reduce(e,t)}forEach(e){this._results.forEach(e)}some(e){return this._results.some(e)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(e,t){const i=this;i.dirty=!1;const n=xs(e);(this._changesDetected=!function $1(r,e,t){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++){let n=r[i],s=e[i];if(t&&(n=t(n),s=t(s)),s!==n)return!1}return!0}(i._results,n,t))&&(i._results=n,i.length=n.length,i.last=n[this.length-1],i.first=n[0])}notifyOnChanges(){this._changes&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.emit(this)}setDirty(){this.dirty=!0}destroy(){this.changes.complete(),this.changes.unsubscribe()}}Symbol;let Xa=(()=>{class r{}return r.__NG_ELEMENT_ID__=Z3,r})();const K3=Xa,Q3=class extends K3{constructor(e,t,i){super(),this._declarationLView=e,this._declarationTContainer=t,this.elementRef=i}createEmbeddedView(e){const t=this._declarationTContainer.tViews,i=Lu(this._declarationLView,t,e,16,null,t.declTNode,null,null,null,null);i[17]=this._declarationLView[this._declarationTContainer.index];const s=this._declarationLView[19];return null!==s&&(i[19]=s.createEmbeddedView(t)),Bu(t,i,e),new $u(i)}};function Z3(){return Qd(Gn(),Ge())}function Qd(r,e){return 4&r.type?new Q3(e,r,Sc(r,e)):null}let va=(()=>{class r{}return r.__NG_ELEMENT_ID__=q3,r})();function q3(){return $y(Gn(),Ge())}const J3=va,Yy=class extends J3{constructor(e,t,i){super(),this._lContainer=e,this._hostTNode=t,this._hostLView=i}get element(){return Sc(this._hostTNode,this._hostLView)}get injector(){return new jl(this._hostTNode,this._hostLView)}get parentInjector(){const e=pd(this._hostTNode,this._hostLView);if(Lv(e)){const t=Yl(e,this._hostLView),i=Xl(e);return new jl(t[1].data[i+8],t)}return new jl(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(e){const t=jy(this._lContainer);return null!==t&&t[e]||null}get length(){return this._lContainer.length-10}createEmbeddedView(e,t,i){const n=e.createEmbeddedView(t||{});return this.insert(n,i),n}createComponent(e,t,i,n,s){const a=e&&!function Au(r){return"function"==typeof r}(e);let o;if(a)o=t;else{const h=t||{};o=h.index,i=h.injector,n=h.projectableNodes,s=h.ngModuleRef}const l=a?e:new Y_(kn(e)),c=i||this.parentInjector;if(!s&&null==l.ngModule){const d=(a?c:this.parentInjector).get(xc,null);d&&(s=d)}const u=l.create(c,n,void 0,s);return this.insert(u.hostView,o),u}insert(e,t){const i=e._lView,n=i[1];if(function _1(r){return Bs(r[3])}(i)){const u=this.indexOf(e);if(-1!==u)this.detach(u);else{const h=i[3],d=new Yy(h,h[6],h[3]);d.detach(d.indexOf(e))}}const s=this._adjustIndex(t),a=this._lContainer;!function FL(r,e,t,i){const n=10+i,s=t.length;i>0&&(t[n-1][4]=e),i<s-10?(e[4]=t[n],Yv(t,10+i,e)):(t.push(e),e[4]=null),e[3]=t;const a=e[17];null!==a&&t!==a&&function NL(r,e){const t=r[9];e[16]!==e[3][3][16]&&(r[2]=!0),null===t?r[9]=[e]:t.push(e)}(a,e);const o=e[19];null!==o&&o.insertView(r),e[2]|=128}(n,i,a,s);const o=kg(s,a),l=i[11],c=yd(l,a[7]);return null!==c&&function PL(r,e,t,i,n,s){i[0]=n,i[6]=e,Pu(r,i,t,1,n,s)}(n,a[6],l,i,c,o),e.attachToViewContainerRef(),Yv(Q_(a),s,e),e}move(e,t){return this.insert(e,t)}indexOf(e){const t=jy(this._lContainer);return null!==t?t.indexOf(e):-1}remove(e){const t=this._adjustIndex(e,-1),i=Bg(this._lContainer,t);i&&(md(Q_(this._lContainer),t),_S(i[1],i))}detach(e){const t=this._adjustIndex(e,-1),i=Bg(this._lContainer,t);return i&&null!=md(Q_(this._lContainer),t)?new $u(i):null}_adjustIndex(e,t=0){return null==e?this.length+t:e}};function jy(r){return r[8]}function Q_(r){return r[8]||(r[8]=[])}function $y(r,e){let t;const i=e[r.index];if(Bs(i))t=i;else{let n;if(8&r.type)n=Dn(i);else{const s=e[11];n=s.createComment("");const a=Qr(r,e);nl(s,yd(s,a),n,function VL(r,e){return gn(r)?r.nextSibling(e):e.nextSibling}(s,a),!1)}e[r.index]=t=Tx(i,e,n,r),Fd(e,t)}return new Yy(t,r,e)}class Z_{constructor(e){this.queryList=e,this.matches=null}clone(){return new Z_(this.queryList)}setDirty(){this.queryList.setDirty()}}class q_{constructor(e=[]){this.queries=e}createEmbeddedView(e){const t=e.queries;if(null!==t){const i=null!==e.contentQueries?e.contentQueries[0]:t.length,n=[];for(let s=0;s<i;s++){const a=t.getByIndex(s);n.push(this.queries[a.indexInDeclarationView].clone())}return new q_(n)}return null}insertView(e){this.dirtyQueriesWithMatches(e)}detachView(e){this.dirtyQueriesWithMatches(e)}dirtyQueriesWithMatches(e){for(let t=0;t<this.queries.length;t++)null!==n0(e,t).matches&&this.queries[t].setDirty()}}class Ky{constructor(e,t,i=null){this.predicate=e,this.flags=t,this.read=i}}class J_{constructor(e=[]){this.queries=e}elementStart(e,t){for(let i=0;i<this.queries.length;i++)this.queries[i].elementStart(e,t)}elementEnd(e){for(let t=0;t<this.queries.length;t++)this.queries[t].elementEnd(e)}embeddedTView(e){let t=null;for(let i=0;i<this.length;i++){const n=null!==t?t.length:0,s=this.getByIndex(i).embeddedTView(e,n);s&&(s.indexInDeclarationView=i,null!==t?t.push(s):t=[s])}return null!==t?new J_(t):null}template(e,t){for(let i=0;i<this.queries.length;i++)this.queries[i].template(e,t)}getByIndex(e){return this.queries[e]}get length(){return this.queries.length}track(e){this.queries.push(e)}}class em{constructor(e,t=-1){this.metadata=e,this.matches=null,this.indexInDeclarationView=-1,this.crossesNgTemplate=!1,this._appliesToNextNode=!0,this._declarationNodeIndex=t}elementStart(e,t){this.isApplyingToNode(t)&&this.matchTNode(e,t)}elementEnd(e){this._declarationNodeIndex===e.index&&(this._appliesToNextNode=!1)}template(e,t){this.elementStart(e,t)}embeddedTView(e,t){return this.isApplyingToNode(e)?(this.crossesNgTemplate=!0,this.addMatch(-e.index,t),new em(this.metadata)):null}isApplyingToNode(e){if(this._appliesToNextNode&&1!=(1&this.metadata.flags)){const t=this._declarationNodeIndex;let i=e.parent;for(;null!==i&&8&i.type&&i.index!==t;)i=i.parent;return t===(null!==i?i.index:-1)}return this._appliesToNextNode}matchTNode(e,t){const i=this.metadata.predicate;if(Array.isArray(i))for(let n=0;n<i.length;n++){const s=i[n];this.matchTNodeWithReadOption(e,t,ik(t,s)),this.matchTNodeWithReadOption(e,t,_d(t,e,s,!1,!1))}else i===Xa?4&t.type&&this.matchTNodeWithReadOption(e,t,-1):this.matchTNodeWithReadOption(e,t,_d(t,e,i,!1,!1))}matchTNodeWithReadOption(e,t,i){if(null!==i){const n=this.metadata.read;if(null!==n)if(n===Ii||n===va||n===Xa&&4&t.type)this.addMatch(t.index,-2);else{const s=_d(t,e,n,!1,!1);null!==s&&this.addMatch(t.index,s)}else this.addMatch(t.index,i)}}addMatch(e,t){null===this.matches?this.matches=[e,t]:this.matches.push(e,t)}}function ik(r,e){const t=r.localNames;if(null!==t)for(let i=0;i<t.length;i+=2)if(t[i]===e)return t[i+1];return null}function rk(r,e,t,i){return-1===t?function nk(r,e){return 11&r.type?Sc(r,e):4&r.type?Qd(r,e):null}(e,r):-2===t?function sk(r,e,t){return t===Ii?Sc(e,r):t===Xa?Qd(e,r):t===va?$y(e,r):void 0}(r,e,i):Su(r,r[1],t,e)}function Qy(r,e,t,i){const n=e[19].queries[i];if(null===n.matches){const s=r.data,a=t.matches,o=[];for(let l=0;l<a.length;l+=2){const c=a[l];o.push(c<0?null:rk(e,s[c],a[l+1],t.metadata.read))}n.matches=o}return n.matches}function tm(r,e,t,i){const n=r.queries.getByIndex(t),s=n.matches;if(null!==s){const a=Qy(r,e,n,t);for(let o=0;o<s.length;o+=2){const l=s[o];if(l>0)i.push(a[o/2]);else{const c=s[o+1],u=e[-l];for(let h=10;h<u.length;h++){const d=u[h];d[17]===d[3]&&tm(d[1],d,c,i)}if(null!==u[9]){const h=u[9];for(let d=0;d<h.length;d++){const f=h[d];tm(f[1],f,c,i)}}}}}return i}function Zy(r){const e=Ge(),t=vi(),i=Iv();dg(i+1);const n=n0(t,i);if(r.dirty&&Ev(e)===(2==(2&n.metadata.flags))){if(null===n.matches)r.reset([]);else{const s=n.crossesNgTemplate?tm(t,e,i,[]):Qy(t,e,n,i);r.reset(s,v3),r.notifyOnChanges()}return!0}return!1}function qy(r,e,t){const i=vi();i.firstCreatePass&&(function t0(r,e,t){null===r.queries&&(r.queries=new J_),r.queries.track(new em(e,t))}(i,new Ky(r,e,t),-1),2==(2&e)&&(i.staticViewQueries=!0)),function e0(r,e,t){const i=new K_(4==(4&t));ux(r,e,i,i.destroy),null===e[19]&&(e[19]=new q_),e[19].queries.push(new Z_(i))}(i,Ge(),e)}function n0(r,e){return r.queries.getByIndex(e)}function Jd(...r){}const v0=new oi("Application Initializer");let om=(()=>{class r{constructor(t){this.appInits=t,this.resolve=Jd,this.reject=Jd,this.initialized=!1,this.done=!1,this.donePromise=new Promise((i,n)=>{this.resolve=i,this.reject=n})}runInitializers(){if(this.initialized)return;const t=[],i=()=>{this.done=!0,this.resolve()};if(this.appInits)for(let n=0;n<this.appInits.length;n++){const s=this.appInits[n]();if(N_(s))t.push(s);else if(I2(s)){const a=new Promise((o,l)=>{s.subscribe({complete:o,error:l})});t.push(a)}}Promise.all(t).then(()=>{i()}).catch(n=>{this.reject(n)}),0===t.length&&i(),this.initialized=!0}}return r.\u0275fac=function(t){return new(t||r)(rt(v0,8))},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const qu=new oi("AppId",{providedIn:"root",factory:function S0(){return`${lm()}${lm()}${lm()}`}});function lm(){return String.fromCharCode(97+Math.floor(25*Math.random()))}const x0=new oi("Platform Initializer"),Gr=new oi("Platform ID",{providedIn:"platform",factory:()=>"unknown"}),A0=new oi("appBootstrapListener"),bo=new oi("LocaleId",{providedIn:"root",factory:()=>vd(bo,Ht.Optional|Ht.SkipSelf)||function Ck(){return"undefined"!=typeof $localize&&$localize.locale||Hd}()}),Dk=(()=>Promise.resolve(0))();function cm(r){"undefined"==typeof Zone?Dk.then(()=>{r&&r.apply(null,null)}):Zone.current.scheduleMicroTask("scheduleMicrotask",r)}class Pn{constructor({enableLongStackTrace:e=!1,shouldCoalesceEventChangeDetection:t=!1,shouldCoalesceRunChangeDetection:i=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new is(!1),this.onMicrotaskEmpty=new is(!1),this.onStable=new is(!1),this.onError=new is(!1),"undefined"==typeof Zone)throw new Error("In this configuration Angular requires Zone.js");Zone.assertZonePatched();const n=this;n._nesting=0,n._outer=n._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(n._inner=n._inner.fork(new Zone.TaskTrackingZoneSpec)),e&&Zone.longStackTraceZoneSpec&&(n._inner=n._inner.fork(Zone.longStackTraceZoneSpec)),n.shouldCoalesceEventChangeDetection=!i&&t,n.shouldCoalesceRunChangeDetection=i,n.lastRequestAnimationFrameId=-1,n.nativeRequestAnimationFrame=function Pk(){let r=Ni.requestAnimationFrame,e=Ni.cancelAnimationFrame;if("undefined"!=typeof Zone&&r&&e){const t=r[Zone.__symbol__("OriginalDelegate")];t&&(r=t);const i=e[Zone.__symbol__("OriginalDelegate")];i&&(e=i)}return{nativeRequestAnimationFrame:r,nativeCancelAnimationFrame:e}}().nativeRequestAnimationFrame,function Fk(r){const e=()=>{!function Ok(r){r.isCheckStableRunning||-1!==r.lastRequestAnimationFrameId||(r.lastRequestAnimationFrameId=r.nativeRequestAnimationFrame.call(Ni,()=>{r.fakeTopEventTask||(r.fakeTopEventTask=Zone.root.scheduleEventTask("fakeTopEventTask",()=>{r.lastRequestAnimationFrameId=-1,hm(r),r.isCheckStableRunning=!0,um(r),r.isCheckStableRunning=!1},void 0,()=>{},()=>{})),r.fakeTopEventTask.invoke()}),hm(r))}(r)};r._inner=r._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(t,i,n,s,a,o)=>{try{return y0(r),t.invokeTask(n,s,a,o)}finally{(r.shouldCoalesceEventChangeDetection&&"eventTask"===s.type||r.shouldCoalesceRunChangeDetection)&&e(),b0(r)}},onInvoke:(t,i,n,s,a,o,l)=>{try{return y0(r),t.invoke(n,s,a,o,l)}finally{r.shouldCoalesceRunChangeDetection&&e(),b0(r)}},onHasTask:(t,i,n,s)=>{t.hasTask(n,s),i===n&&("microTask"==s.change?(r._hasPendingMicrotasks=s.microTask,hm(r),um(r)):"macroTask"==s.change&&(r.hasPendingMacrotasks=s.macroTask))},onHandleError:(t,i,n,s)=>(t.handleError(n,s),r.runOutsideAngular(()=>r.onError.emit(s)),!1)})}(n)}static isInAngularZone(){return"undefined"!=typeof Zone&&!0===Zone.current.get("isAngularZone")}static assertInAngularZone(){if(!Pn.isInAngularZone())throw new Error("Expected to be in Angular Zone, but it is not!")}static assertNotInAngularZone(){if(Pn.isInAngularZone())throw new Error("Expected to not be in Angular Zone, but it is!")}run(e,t,i){return this._inner.run(e,t,i)}runTask(e,t,i,n){const s=this._inner,a=s.scheduleEventTask("NgZoneEvent: "+n,e,wk,Jd,Jd);try{return s.runTask(a,t,i)}finally{s.cancelTask(a)}}runGuarded(e,t,i){return this._inner.runGuarded(e,t,i)}runOutsideAngular(e){return this._outer.run(e)}}const wk={};function um(r){if(0==r._nesting&&!r.hasPendingMicrotasks&&!r.isStable)try{r._nesting++,r.onMicrotaskEmpty.emit(null)}finally{if(r._nesting--,!r.hasPendingMicrotasks)try{r.runOutsideAngular(()=>r.onStable.emit(null))}finally{r.isStable=!0}}}function hm(r){r.hasPendingMicrotasks=!!(r._hasPendingMicrotasks||(r.shouldCoalesceEventChangeDetection||r.shouldCoalesceRunChangeDetection)&&-1!==r.lastRequestAnimationFrameId)}function y0(r){r._nesting++,r.isStable&&(r.isStable=!1,r.onUnstable.emit(null))}function b0(r){r._nesting--,um(r)}class Nk{constructor(){this.hasPendingMicrotasks=!1,this.hasPendingMacrotasks=!1,this.isStable=!0,this.onUnstable=new is,this.onMicrotaskEmpty=new is,this.onStable=new is,this.onError=new is}run(e,t,i){return e.apply(t,i)}runGuarded(e,t,i){return e.apply(t,i)}runOutsideAngular(e){return e()}runTask(e,t,i,n){return e.apply(t,i)}}let dm=(()=>{class r{constructor(t){this._ngZone=t,this._pendingCount=0,this._isZoneStable=!0,this._didWork=!1,this._callbacks=[],this.taskTrackingZone=null,this._watchAngularEvents(),t.run(()=>{this.taskTrackingZone="undefined"==typeof Zone?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){this._ngZone.onUnstable.subscribe({next:()=>{this._didWork=!0,this._isZoneStable=!1}}),this._ngZone.runOutsideAngular(()=>{this._ngZone.onStable.subscribe({next:()=>{Pn.assertNotInAngularZone(),cm(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}})})}increasePendingRequestCount(){return this._pendingCount+=1,this._didWork=!0,this._pendingCount}decreasePendingRequestCount(){if(this._pendingCount-=1,this._pendingCount<0)throw new Error("pending async requests below zero");return this._runCallbacksIfReady(),this._pendingCount}isStable(){return this._isZoneStable&&0===this._pendingCount&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())cm(()=>{for(;0!==this._callbacks.length;){let t=this._callbacks.pop();clearTimeout(t.timeoutId),t.doneCb(this._didWork)}this._didWork=!1});else{let t=this.getPendingTasks();this._callbacks=this._callbacks.filter(i=>!i.updateCb||!i.updateCb(t)||(clearTimeout(i.timeoutId),!1)),this._didWork=!0}}getPendingTasks(){return this.taskTrackingZone?this.taskTrackingZone.macroTasks.map(t=>({source:t.source,creationLocation:t.creationLocation,data:t.data})):[]}addCallback(t,i,n){let s=-1;i&&i>0&&(s=setTimeout(()=>{this._callbacks=this._callbacks.filter(a=>a.timeoutId!==s),t(this._didWork,this.getPendingTasks())},i)),this._callbacks.push({doneCb:t,timeoutId:s,updateCb:n})}whenStable(t,i,n){if(n&&!this.taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(t,i,n),this._runCallbacksIfReady()}getPendingRequestCount(){return this._pendingCount}findProviders(t,i,n){return[]}}return r.\u0275fac=function(t){return new(t||r)(rt(Pn))},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})(),Lk=(()=>{class r{constructor(){this._applications=new Map,fm.addToWindow(this)}registerApplication(t,i){this._applications.set(t,i)}unregisterApplication(t){this._applications.delete(t)}unregisterAllApplications(){this._applications.clear()}getTestability(t){return this._applications.get(t)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(t,i=!0){return fm.findTestabilityInTree(this,t,i)}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"platform"}),r})();class Bk{addToWindow(e){}findTestabilityInTree(e,t,i){return null}}let fm=new Bk,hl=null;const C0=new oi("AllowMultipleToken"),I0=new oi("PlatformOnDestroy");function R0(r,e,t=[]){const i=`Platform: ${e}`,n=new oi(i);return(s=[])=>{let a=pm();if(!a||a.injector.get(C0,!1)){const o=[...t,...s,{provide:n,useValue:!0}];r?r(o):function Gk(r){if(hl&&!hl.get(C0,!1))throw new Ke(400,"");hl=r;const e=r.get(M0),t=r.get(x0,null);t&&t.forEach(i=>i())}(function zk(r=[],e){return Gs.create({name:e,providers:[{provide:S_,useValue:"platform"},{provide:I0,useValue:()=>hl=null},...r]})}(o,i))}return function Hk(r){const e=pm();if(!e)throw new Ke(401,"");return e}()}}function pm(){var r;return null!==(r=null==hl?void 0:hl.get(M0))&&void 0!==r?r:null}let M0=(()=>{class r{constructor(t){this._injector=t,this._modules=[],this._destroyListeners=[],this._destroyed=!1}bootstrapModuleFactory(t,i){const o=function Wk(r,e){let t;return t="noop"===r?new Nk:("zone.js"===r?void 0:r)||new Pn({enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:!!(null==e?void 0:e.ngZoneEventCoalescing),shouldCoalesceRunChangeDetection:!!(null==e?void 0:e.ngZoneRunCoalescing)}),t}(i?i.ngZone:void 0,{ngZoneEventCoalescing:i&&i.ngZoneEventCoalescing||!1,ngZoneRunCoalescing:i&&i.ngZoneRunCoalescing||!1}),l=[{provide:Pn,useValue:o}];return o.run(()=>{const c=Gs.create({providers:l,parent:this.injector,name:t.moduleType.name}),u=t.create(c),h=u.injector.get(Nu,null);if(!h)throw new Ke(402,"");return o.runOutsideAngular(()=>{const d=o.onError.subscribe({next:f=>{h.handleError(f)}});u.onDestroy(()=>{gm(this._modules,u),d.unsubscribe()})}),function Xk(r,e,t){try{const i=t();return N_(i)?i.catch(n=>{throw e.runOutsideAngular(()=>r.handleError(n)),n}):i}catch(i){throw e.runOutsideAngular(()=>r.handleError(i)),i}}(h,o,()=>{const d=u.injector.get(om);return d.runInitializers(),d.donePromise.then(()=>(function vV(r){er(r,"Expected localeId to be defined"),"string"==typeof r&&(oy=r.toLowerCase().replace(/_/g,"-"))}(u.injector.get(bo,Hd)||Hd),this._moduleDoBootstrap(u),u))})})}bootstrapModule(t,i=[]){const n=D0({},i);return function Vk(r,e,t){const i=new j_(t);return Promise.resolve(i)}(0,0,t).then(s=>this.bootstrapModuleFactory(s,n))}_moduleDoBootstrap(t){const i=t.injector.get(P0);if(t._bootstrapComponents.length>0)t._bootstrapComponents.forEach(n=>i.bootstrap(n));else{if(!t.instance.ngDoBootstrap)throw new Ke(403,"");t.instance.ngDoBootstrap(i)}this._modules.push(t)}onDestroy(t){this._destroyListeners.push(t)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new Ke(404,"");this._modules.slice().forEach(i=>i.destroy()),this._destroyListeners.forEach(i=>i());const t=this._injector.get(I0,null);null==t||t(),this._destroyed=!0}get destroyed(){return this._destroyed}}return r.\u0275fac=function(t){return new(t||r)(rt(Gs))},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"platform"}),r})();function D0(r,e){return Array.isArray(e)?e.reduce(D0,r):Object.assign(Object.assign({},r),e)}let P0=(()=>{class r{constructor(t,i,n,s){this._zone=t,this._injector=i,this._exceptionHandler=n,this._initStatus=s,this._bootstrapListeners=[],this._views=[],this._runningTick=!1,this._stable=!0,this.componentTypes=[],this.components=[],this._onMicrotaskEmptySubscription=this._zone.onMicrotaskEmpty.subscribe({next:()=>{this._zone.run(()=>{this.tick()})}});const a=new Pe.y(l=>{this._stable=this._zone.isStable&&!this._zone.hasPendingMacrotasks&&!this._zone.hasPendingMicrotasks,this._zone.runOutsideAngular(()=>{l.next(this._stable),l.complete()})}),o=new Pe.y(l=>{let c;this._zone.runOutsideAngular(()=>{c=this._zone.onStable.subscribe(()=>{Pn.assertNotInAngularZone(),cm(()=>{!this._stable&&!this._zone.hasPendingMacrotasks&&!this._zone.hasPendingMicrotasks&&(this._stable=!0,l.next(!0))})})});const u=this._zone.onUnstable.subscribe(()=>{Pn.assertInAngularZone(),this._stable&&(this._stable=!1,this._zone.runOutsideAngular(()=>{l.next(!1)}))});return()=>{c.unsubscribe(),u.unsubscribe()}});this.isStable=(0,ve.T)(a,o.pipe(function Te(){return r=>(0,Ae.x)()(function re(r,e){return function(i){let n;if(n="function"==typeof r?r:function(){return r},"function"==typeof e)return i.lift(new ce(n,e));const s=Object.create(i,K.N);return s.source=i,s.subjectFactory=n,s}}(Le)(r))}()))}bootstrap(t,i){if(!this._initStatus.done)throw new Ke(405,"");let n;n=t instanceof wy?t:this._injector.get(jd).resolveComponentFactory(t),this.componentTypes.push(n.componentType);const s=function kk(r){return r.isBoundToModule}(n)?void 0:this._injector.get(xc),o=n.create(Gs.NULL,[],i||n.selector,s),l=o.location.nativeElement,c=o.injector.get(dm,null),u=c&&o.injector.get(Lk);return c&&u&&u.registerApplication(l,c),o.onDestroy(()=>{this.detachView(o.hostView),gm(this.components,o),u&&u.unregisterApplication(l)}),this._loadComponent(o),o}tick(){if(this._runningTick)throw new Ke(101,"");try{this._runningTick=!0;for(let t of this._views)t.detectChanges()}catch(t){this._zone.runOutsideAngular(()=>this._exceptionHandler.handleError(t))}finally{this._runningTick=!1}}attachView(t){const i=t;this._views.push(i),i.attachToAppRef(this)}detachView(t){const i=t;gm(this._views,i),i.detachFromAppRef()}_loadComponent(t){this.attachView(t.hostView),this.tick(),this.components.push(t),this._injector.get(A0,[]).concat(this._bootstrapListeners).forEach(n=>n(t))}ngOnDestroy(){this._views.slice().forEach(t=>t.destroy()),this._onMicrotaskEmptySubscription.unsubscribe()}get viewCount(){return this._views.length}}return r.\u0275fac=function(t){return new(t||r)(rt(Pn),rt(Gs),rt(Nu),rt(om))},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();function gm(r,e){const t=r.indexOf(e);t>-1&&r.splice(t,1)}let O0=!0,$k=(()=>{class r{}return r.__NG_ELEMENT_ID__=Kk,r})();function Kk(r){return function Qk(r,e,t){if(id(r)&&!t){const i=Zr(r.index,e);return new $u(i,i)}return 47&r.type?new $u(e[16],e):null}(Gn(),Ge(),16==(16&r))}class U0{constructor(){}supports(e){return Vu(e)}create(e){return new iG(e)}}const tG=(r,e)=>e;class iG{constructor(e){this.length=0,this._linkedRecords=null,this._unlinkedRecords=null,this._previousItHead=null,this._itHead=null,this._itTail=null,this._additionsHead=null,this._additionsTail=null,this._movesHead=null,this._movesTail=null,this._removalsHead=null,this._removalsTail=null,this._identityChangesHead=null,this._identityChangesTail=null,this._trackByFn=e||tG}forEachItem(e){let t;for(t=this._itHead;null!==t;t=t._next)e(t)}forEachOperation(e){let t=this._itHead,i=this._removalsHead,n=0,s=null;for(;t||i;){const a=!i||t&&t.currentIndex<k0(i,n,s)?t:i,o=k0(a,n,s),l=a.currentIndex;if(a===i)n--,i=i._nextRemoved;else if(t=t._next,null==a.previousIndex)n++;else{s||(s=[]);const c=o-n,u=l-n;if(c!=u){for(let d=0;d<c;d++){const f=d<s.length?s[d]:s[d]=0,p=f+d;u<=p&&p<c&&(s[d]=f+1)}s[a.previousIndex]=u-c}}o!==l&&e(a,o,l)}}forEachPreviousItem(e){let t;for(t=this._previousItHead;null!==t;t=t._nextPrevious)e(t)}forEachAddedItem(e){let t;for(t=this._additionsHead;null!==t;t=t._nextAdded)e(t)}forEachMovedItem(e){let t;for(t=this._movesHead;null!==t;t=t._nextMoved)e(t)}forEachRemovedItem(e){let t;for(t=this._removalsHead;null!==t;t=t._nextRemoved)e(t)}forEachIdentityChange(e){let t;for(t=this._identityChangesHead;null!==t;t=t._nextIdentityChange)e(t)}diff(e){if(null==e&&(e=[]),!Vu(e))throw new Ke(900,"");return this.check(e)?this:null}onDestroy(){}check(e){this._reset();let n,s,a,t=this._itHead,i=!1;if(Array.isArray(e)){this.length=e.length;for(let o=0;o<this.length;o++)s=e[o],a=this._trackByFn(o,s),null!==t&&Object.is(t.trackById,a)?(i&&(t=this._verifyReinsertion(t,s,a,o)),Object.is(t.item,s)||this._addIdentityChange(t,s)):(t=this._mismatch(t,s,a,o),i=!0),t=t._next}else n=0,function i2(r,e){if(Array.isArray(r))for(let t=0;t<r.length;t++)e(r[t]);else{const t=r[oc()]();let i;for(;!(i=t.next()).done;)e(i.value)}}(e,o=>{a=this._trackByFn(n,o),null!==t&&Object.is(t.trackById,a)?(i&&(t=this._verifyReinsertion(t,o,a,n)),Object.is(t.item,o)||this._addIdentityChange(t,o)):(t=this._mismatch(t,o,a,n),i=!0),t=t._next,n++}),this.length=n;return this._truncate(t),this.collection=e,this.isDirty}get isDirty(){return null!==this._additionsHead||null!==this._movesHead||null!==this._removalsHead||null!==this._identityChangesHead}_reset(){if(this.isDirty){let e;for(e=this._previousItHead=this._itHead;null!==e;e=e._next)e._nextPrevious=e._next;for(e=this._additionsHead;null!==e;e=e._nextAdded)e.previousIndex=e.currentIndex;for(this._additionsHead=this._additionsTail=null,e=this._movesHead;null!==e;e=e._nextMoved)e.previousIndex=e.currentIndex;this._movesHead=this._movesTail=null,this._removalsHead=this._removalsTail=null,this._identityChangesHead=this._identityChangesTail=null}}_mismatch(e,t,i,n){let s;return null===e?s=this._itTail:(s=e._prev,this._remove(e)),null!==(e=null===this._unlinkedRecords?null:this._unlinkedRecords.get(i,null))?(Object.is(e.item,t)||this._addIdentityChange(e,t),this._reinsertAfter(e,s,n)):null!==(e=null===this._linkedRecords?null:this._linkedRecords.get(i,n))?(Object.is(e.item,t)||this._addIdentityChange(e,t),this._moveAfter(e,s,n)):e=this._addAfter(new nG(t,i),s,n),e}_verifyReinsertion(e,t,i,n){let s=null===this._unlinkedRecords?null:this._unlinkedRecords.get(i,null);return null!==s?e=this._reinsertAfter(s,e._prev,n):e.currentIndex!=n&&(e.currentIndex=n,this._addToMoves(e,n)),e}_truncate(e){for(;null!==e;){const t=e._next;this._addToRemovals(this._unlink(e)),e=t}null!==this._unlinkedRecords&&this._unlinkedRecords.clear(),null!==this._additionsTail&&(this._additionsTail._nextAdded=null),null!==this._movesTail&&(this._movesTail._nextMoved=null),null!==this._itTail&&(this._itTail._next=null),null!==this._removalsTail&&(this._removalsTail._nextRemoved=null),null!==this._identityChangesTail&&(this._identityChangesTail._nextIdentityChange=null)}_reinsertAfter(e,t,i){null!==this._unlinkedRecords&&this._unlinkedRecords.remove(e);const n=e._prevRemoved,s=e._nextRemoved;return null===n?this._removalsHead=s:n._nextRemoved=s,null===s?this._removalsTail=n:s._prevRemoved=n,this._insertAfter(e,t,i),this._addToMoves(e,i),e}_moveAfter(e,t,i){return this._unlink(e),this._insertAfter(e,t,i),this._addToMoves(e,i),e}_addAfter(e,t,i){return this._insertAfter(e,t,i),this._additionsTail=null===this._additionsTail?this._additionsHead=e:this._additionsTail._nextAdded=e,e}_insertAfter(e,t,i){const n=null===t?this._itHead:t._next;return e._next=n,e._prev=t,null===n?this._itTail=e:n._prev=e,null===t?this._itHead=e:t._next=e,null===this._linkedRecords&&(this._linkedRecords=new V0),this._linkedRecords.put(e),e.currentIndex=i,e}_remove(e){return this._addToRemovals(this._unlink(e))}_unlink(e){null!==this._linkedRecords&&this._linkedRecords.remove(e);const t=e._prev,i=e._next;return null===t?this._itHead=i:t._next=i,null===i?this._itTail=t:i._prev=t,e}_addToMoves(e,t){return e.previousIndex===t||(this._movesTail=null===this._movesTail?this._movesHead=e:this._movesTail._nextMoved=e),e}_addToRemovals(e){return null===this._unlinkedRecords&&(this._unlinkedRecords=new V0),this._unlinkedRecords.put(e),e.currentIndex=null,e._nextRemoved=null,null===this._removalsTail?(this._removalsTail=this._removalsHead=e,e._prevRemoved=null):(e._prevRemoved=this._removalsTail,this._removalsTail=this._removalsTail._nextRemoved=e),e}_addIdentityChange(e,t){return e.item=t,this._identityChangesTail=null===this._identityChangesTail?this._identityChangesHead=e:this._identityChangesTail._nextIdentityChange=e,e}}class nG{constructor(e,t){this.item=e,this.trackById=t,this.currentIndex=null,this.previousIndex=null,this._nextPrevious=null,this._prev=null,this._next=null,this._prevDup=null,this._nextDup=null,this._prevRemoved=null,this._nextRemoved=null,this._nextAdded=null,this._nextMoved=null,this._nextIdentityChange=null}}class rG{constructor(){this._head=null,this._tail=null}add(e){null===this._head?(this._head=this._tail=e,e._nextDup=null,e._prevDup=null):(this._tail._nextDup=e,e._prevDup=this._tail,e._nextDup=null,this._tail=e)}get(e,t){let i;for(i=this._head;null!==i;i=i._nextDup)if((null===t||t<=i.currentIndex)&&Object.is(i.trackById,e))return i;return null}remove(e){const t=e._prevDup,i=e._nextDup;return null===t?this._head=i:t._nextDup=i,null===i?this._tail=t:i._prevDup=t,null===this._head}}class V0{constructor(){this.map=new Map}put(e){const t=e.trackById;let i=this.map.get(t);i||(i=new rG,this.map.set(t,i)),i.add(e)}get(e,t){const n=this.map.get(e);return n?n.get(e,t):null}remove(e){const t=e.trackById;return this.map.get(t).remove(e)&&this.map.delete(t),e}get isEmpty(){return 0===this.map.size}clear(){this.map.clear()}}function k0(r,e,t){const i=r.previousIndex;if(null===i)return i;let n=0;return t&&i<t.length&&(n=t[i]),i+e+n}function H0(){return new Ju([new U0])}let Ju=(()=>{class r{constructor(t){this.factories=t}static create(t,i){if(null!=i){const n=i.factories.slice();t=t.concat(n)}return new r(t)}static extend(t){return{provide:r,useFactory:i=>r.create(t,i||H0()),deps:[[r,new xd,new Sd]]}}find(t){const i=this.factories.find(n=>n.supports(t));if(null!=i)return i;throw new Ke(901,"")}}return r.\u0275prov=St({token:r,providedIn:"root",factory:H0}),r})();const cG=R0(null,"core",[]);let uG=(()=>{class r{constructor(t){}}return r.\u0275fac=function(t){return new(t||r)(rt(P0))},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({}),r})(),nf=null;function eh(){return nf}const xn=new oi("DocumentToken");var Hr=(()=>((Hr=Hr||{})[Hr.Decimal=0]="Decimal",Hr[Hr.Percent=1]="Percent",Hr[Hr.Currency=2]="Currency",Hr[Hr.Scientific=3]="Scientific",Hr))(),wt=(()=>((wt=wt||{})[wt.Decimal=0]="Decimal",wt[wt.Group=1]="Group",wt[wt.List=2]="List",wt[wt.PercentSign=3]="PercentSign",wt[wt.PlusSign=4]="PlusSign",wt[wt.MinusSign=5]="MinusSign",wt[wt.Exponential=6]="Exponential",wt[wt.SuperscriptingExponent=7]="SuperscriptingExponent",wt[wt.PerMille=8]="PerMille",wt[wt.Infinity=9]="Infinity",wt[wt.NaN=10]="NaN",wt[wt.TimeSeparator=11]="TimeSeparator",wt[wt.CurrencyDecimal=12]="CurrencyDecimal",wt[wt.CurrencyGroup=13]="CurrencyGroup",wt))();function bs(r,e){const t=br(r),i=t[ot.NumberSymbols][e];if(void 0===i){if(e===wt.CurrencyDecimal)return t[ot.NumberSymbols][wt.Decimal];if(e===wt.CurrencyGroup)return t[ot.NumberSymbols][wt.Group]}return i}const HG=/^(\d+)?\.((\d+)(-(\d+))?)?$/;function Im(r){const e=parseInt(r);if(isNaN(e))throw new Error("Invalid integer literal when parsing "+r);return e}class t4{constructor(e,t,i,n){this.$implicit=e,this.ngForOf=t,this.index=i,this.count=n}get first(){return 0===this.index}get last(){return this.index===this.count-1}get even(){return this.index%2==0}get odd(){return!this.even}}let eb=(()=>{class r{constructor(t,i,n){this._viewContainer=t,this._template=i,this._differs=n,this._ngForOf=null,this._ngForOfDirty=!0,this._differ=null}set ngForOf(t){this._ngForOf=t,this._ngForOfDirty=!0}set ngForTrackBy(t){this._trackByFn=t}get ngForTrackBy(){return this._trackByFn}set ngForTemplate(t){t&&(this._template=t)}ngDoCheck(){if(this._ngForOfDirty){this._ngForOfDirty=!1;const t=this._ngForOf;!this._differ&&t&&(this._differ=this._differs.find(t).create(this.ngForTrackBy))}if(this._differ){const t=this._differ.diff(this._ngForOf);t&&this._applyChanges(t)}}_applyChanges(t){const i=this._viewContainer;t.forEachOperation((n,s,a)=>{if(null==n.previousIndex)i.createEmbeddedView(this._template,new t4(n.item,this._ngForOf,-1,-1),null===a?void 0:a);else if(null==a)i.remove(null===s?void 0:s);else if(null!==s){const o=i.get(s);i.move(o,a),tb(o,n)}});for(let n=0,s=i.length;n<s;n++){const o=i.get(n).context;o.index=n,o.count=s,o.ngForOf=this._ngForOf}t.forEachIdentityChange(n=>{tb(i.get(n.currentIndex),n)})}static ngTemplateContextGuard(t,i){return!0}}return r.\u0275fac=function(t){return new(t||r)(de(va),de(Xa),de(Ju))},r.\u0275dir=Tt({type:r,selectors:[["","ngFor","","ngForOf",""]],inputs:{ngForOf:"ngForOf",ngForTrackBy:"ngForTrackBy",ngForTemplate:"ngForTemplate"}}),r})();function tb(r,e){r.context.$implicit=e.item}let ib=(()=>{class r{constructor(t,i){this._viewContainer=t,this._context=new i4,this._thenTemplateRef=null,this._elseTemplateRef=null,this._thenViewRef=null,this._elseViewRef=null,this._thenTemplateRef=i}set ngIf(t){this._context.$implicit=this._context.ngIf=t,this._updateView()}set ngIfThen(t){nb("ngIfThen",t),this._thenTemplateRef=t,this._thenViewRef=null,this._updateView()}set ngIfElse(t){nb("ngIfElse",t),this._elseTemplateRef=t,this._elseViewRef=null,this._updateView()}_updateView(){this._context.$implicit?this._thenViewRef||(this._viewContainer.clear(),this._elseViewRef=null,this._thenTemplateRef&&(this._thenViewRef=this._viewContainer.createEmbeddedView(this._thenTemplateRef,this._context))):this._elseViewRef||(this._viewContainer.clear(),this._thenViewRef=null,this._elseTemplateRef&&(this._elseViewRef=this._viewContainer.createEmbeddedView(this._elseTemplateRef,this._context)))}static ngTemplateContextGuard(t,i){return!0}}return r.\u0275fac=function(t){return new(t||r)(de(va),de(Xa))},r.\u0275dir=Tt({type:r,selectors:[["","ngIf",""]],inputs:{ngIf:"ngIf",ngIfThen:"ngIfThen",ngIfElse:"ngIfElse"}}),r})();class i4{constructor(){this.$implicit=null,this.ngIf=null}}function nb(r,e){if(e&&!e.createEmbeddedView)throw new Error(`${r} must be a TemplateRef, but received '${q(e)}'.`)}const rb="browser";function ja(r){return r===rb}function Cc(r){return"server"===r}function Ys(r,e){return new Ke(2100,"")}class N4{createSubscription(e,t){return e.subscribe({next:t,error:i=>{throw i}})}dispose(e){e.unsubscribe()}onDestroy(e){e.unsubscribe()}}class L4{createSubscription(e,t){return e.then(t,i=>{throw i})}dispose(e){}onDestroy(e){}}const B4=new L4,U4=new N4;let ub=(()=>{class r{constructor(t){this._ref=t,this._latestValue=null,this._subscription=null,this._obj=null,this._strategy=null}ngOnDestroy(){this._subscription&&this._dispose()}transform(t){return this._obj?t!==this._obj?(this._dispose(),this.transform(t)):this._latestValue:(t&&this._subscribe(t),this._latestValue)}_subscribe(t){this._obj=t,this._strategy=this._selectStrategy(t),this._subscription=this._strategy.createSubscription(t,i=>this._updateLatestValue(t,i))}_selectStrategy(t){if(N_(t))return B4;if(dA(t))return U4;throw Ys()}_dispose(){this._strategy.dispose(this._subscription),this._latestValue=null,this._subscription=null,this._obj=null}_updateLatestValue(t,i){t===this._obj&&(this._latestValue=i,this._ref.markForCheck())}}return r.\u0275fac=function(t){return new(t||r)(de($k,16))},r.\u0275pipe=lr({name:"async",type:r,pure:!1}),r})(),db=(()=>{class r{constructor(t){this._locale=t}transform(t,i,n){if(!function Nm(r){return!(null==r||""===r||r!=r)}(t))return null;n=n||this._locale;try{return function $G(r,e,t){return function bm(r,e,t,i,n,s,a=!1){let o="",l=!1;if(isFinite(r)){let c=function QG(r){let i,n,s,a,o,e=Math.abs(r)+"",t=0;for((n=e.indexOf("."))>-1&&(e=e.replace(".","")),(s=e.search(/e/i))>0?(n<0&&(n=s),n+=+e.slice(s+1),e=e.substring(0,s)):n<0&&(n=e.length),s=0;"0"===e.charAt(s);s++);if(s===(o=e.length))i=[0],n=1;else{for(o--;"0"===e.charAt(o);)o--;for(n-=s,i=[],a=0;s<=o;s++,a++)i[a]=Number(e.charAt(s))}return n>22&&(i=i.splice(0,21),t=n-1,n=1),{digits:i,exponent:t,integerLen:n}}(r);a&&(c=function KG(r){if(0===r.digits[0])return r;const e=r.digits.length-r.integerLen;return r.exponent?r.exponent+=2:(0===e?r.digits.push(0,0):1===e&&r.digits.push(0),r.integerLen+=2),r}(c));let u=e.minInt,h=e.minFrac,d=e.maxFrac;if(s){const T=s.match(HG);if(null===T)throw new Error(`${s} is not a valid digit info`);const v=T[1],A=T[3],S=T[5];null!=v&&(u=Im(v)),null!=A&&(h=Im(A)),null!=S?d=Im(S):null!=A&&h>d&&(d=h)}!function ZG(r,e,t){if(e>t)throw new Error(`The minimum number of digits after fraction (${e}) is higher than the maximum (${t}).`);let i=r.digits,n=i.length-r.integerLen;const s=Math.min(Math.max(e,n),t);let a=s+r.integerLen,o=i[a];if(a>0){i.splice(Math.max(r.integerLen,a));for(let h=a;h<i.length;h++)i[h]=0}else{n=Math.max(0,n),r.integerLen=1,i.length=Math.max(1,a=s+1),i[0]=0;for(let h=1;h<a;h++)i[h]=0}if(o>=5)if(a-1<0){for(let h=0;h>a;h--)i.unshift(0),r.integerLen++;i.unshift(1),r.integerLen++}else i[a-1]++;for(;n<Math.max(0,s);n++)i.push(0);let l=0!==s;const c=e+r.integerLen,u=i.reduceRight(function(h,d,f,p){return p[f]=(d+=h)<10?d:d-10,l&&(0===p[f]&&f>=c?p.pop():l=!1),d>=10?1:0},0);u&&(i.unshift(u),r.integerLen++)}(c,h,d);let f=c.digits,p=c.integerLen;const g=c.exponent;let _=[];for(l=f.every(T=>!T);p<u;p++)f.unshift(0);for(;p<0;p++)f.unshift(0);p>0?_=f.splice(p,f.length):(_=f,f=[0]);const m=[];for(f.length>=e.lgSize&&m.unshift(f.splice(-e.lgSize,f.length).join(""));f.length>e.gSize;)m.unshift(f.splice(-e.gSize,f.length).join(""));f.length&&m.unshift(f.join("")),o=m.join(bs(t,i)),_.length&&(o+=bs(t,n)+_.join("")),g&&(o+=bs(t,wt.Exponential)+"+"+g)}else o=bs(t,wt.Infinity);return o=r<0&&!l?e.negPre+o+e.negSuf:e.posPre+o+e.posSuf,o}(r,function Cm(r,e="-"){const t={minInt:1,minFrac:0,maxFrac:0,posPre:"",posSuf:"",negPre:"",negSuf:"",gSize:0,lgSize:0},i=r.split(";"),n=i[0],s=i[1],a=-1!==n.indexOf(".")?n.split("."):[n.substring(0,n.lastIndexOf("0")+1),n.substring(n.lastIndexOf("0")+1)],o=a[0],l=a[1]||"";t.posPre=o.substr(0,o.indexOf("#"));for(let u=0;u<l.length;u++){const h=l.charAt(u);"0"===h?t.minFrac=t.maxFrac=u+1:"#"===h?t.maxFrac=u+1:t.posSuf+=h}const c=o.split(",");if(t.gSize=c[1]?c[1].length:0,t.lgSize=c[2]||c[1]?(c[2]||c[1]).length:0,s){const u=n.length-t.posPre.length-t.posSuf.length,h=s.indexOf("#");t.negPre=s.substr(0,h).replace(/'/g,""),t.negSuf=s.substr(h+u).replace(/'/g,"")}else t.negPre=e+t.posPre,t.negSuf=t.posSuf;return t}(function vm(r,e){return br(r)[ot.NumberFormats][e]}(e,Hr.Decimal),bs(e,wt.MinusSign)),e,wt.Group,wt.Decimal,t)}(function Lm(r){if("string"==typeof r&&!isNaN(Number(r)-parseFloat(r)))return Number(r);if("number"!=typeof r)throw new Error(`${r} is not a number`);return r}(t),n,i)}catch(s){throw Ys()}}}return r.\u0275fac=function(t){return new(t||r)(de(bo,16))},r.\u0275pipe=lr({name:"number",type:r,pure:!0}),r})();let eH=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({}),r})();class Bm extends class rH extends class fG{}{constructor(){super(...arguments),this.supportsDOMEvents=!0}}{static makeCurrent(){!function dG(r){nf||(nf=r)}(new Bm)}onAndCancel(e,t,i){return e.addEventListener(t,i,!1),()=>{e.removeEventListener(t,i,!1)}}dispatchEvent(e,t){e.dispatchEvent(t)}remove(e){e.parentNode&&e.parentNode.removeChild(e)}createElement(e,t){return(t=t||this.getDefaultDocument()).createElement(e)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isShadowRoot(e){return e instanceof DocumentFragment}getGlobalEventTarget(e,t){return"window"===t?window:"document"===t?e:"body"===t?e.body:null}getBaseHref(e){const t=function sH(){return rh=rh||document.querySelector("base"),rh?rh.getAttribute("href"):null}();return null==t?null:function aH(r){_f=_f||document.createElement("a"),_f.setAttribute("href",r);const e=_f.pathname;return"/"===e.charAt(0)?e:`/${e}`}(t)}resetBaseElement(){rh=null}getUserAgent(){return window.navigator.userAgent}getCookie(e){return function JG(r,e){e=encodeURIComponent(e);for(const t of r.split(";")){const i=t.indexOf("="),[n,s]=-1==i?[t,""]:[t.slice(0,i),t.slice(i+1)];if(n.trim()===e)return decodeURIComponent(s)}return null}(document.cookie,e)}}let _f,rh=null;const pb=new oi("TRANSITION_ID"),lH=[{provide:v0,useFactory:function oH(r,e,t){return()=>{t.get(om).donePromise.then(()=>{const i=eh(),n=e.querySelectorAll(`style[ng-transition="${r}"]`);for(let s=0;s<n.length;s++)i.remove(n[s])})}},deps:[pb,xn,Gs],multi:!0}];class Um{static init(){!function Uk(r){fm=r}(new Um)}addToWindow(e){Ni.getAngularTestability=(i,n=!0)=>{const s=e.findTestabilityInTree(i,n);if(null==s)throw new Error("Could not find testability for element.");return s},Ni.getAllAngularTestabilities=()=>e.getAllTestabilities(),Ni.getAllAngularRootElements=()=>e.getAllRootElements(),Ni.frameworkStabilizers||(Ni.frameworkStabilizers=[]),Ni.frameworkStabilizers.push(i=>{const n=Ni.getAllAngularTestabilities();let s=n.length,a=!1;const o=function(l){a=a||l,s--,0==s&&i(a)};n.forEach(function(l){l.whenStable(o)})})}findTestabilityInTree(e,t,i){if(null==t)return null;const n=e.getTestability(t);return null!=n?n:i?eh().isShadowRoot(t)?this.findTestabilityInTree(e,t.host,!0):this.findTestabilityInTree(e,t.parentElement,!0):null}}let cH=(()=>{class r{build(){return new XMLHttpRequest}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})();const mf=new oi("EventManagerPlugins");let Tf=(()=>{class r{constructor(t,i){this._zone=i,this._eventNameToPlugin=new Map,t.forEach(n=>n.manager=this),this._plugins=t.slice().reverse()}addEventListener(t,i,n){return this._findPluginFor(i).addEventListener(t,i,n)}addGlobalEventListener(t,i,n){return this._findPluginFor(i).addGlobalEventListener(t,i,n)}getZone(){return this._zone}_findPluginFor(t){const i=this._eventNameToPlugin.get(t);if(i)return i;const n=this._plugins;for(let s=0;s<n.length;s++){const a=n[s];if(a.supports(t))return this._eventNameToPlugin.set(t,a),a}throw new Error(`No event manager plugin found for event ${t}`)}}return r.\u0275fac=function(t){return new(t||r)(rt(mf),rt(Pn))},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})();class gb{constructor(e){this._doc=e}addGlobalEventListener(e,t,i){const n=eh().getGlobalEventTarget(this._doc,e);if(!n)throw new Error(`Unsupported event target ${n} for event ${t}`);return this.addEventListener(n,t,i)}}let _b=(()=>{class r{constructor(){this._stylesSet=new Set}addStyles(t){const i=new Set;t.forEach(n=>{this._stylesSet.has(n)||(this._stylesSet.add(n),i.add(n))}),this.onStylesAdded(i)}onStylesAdded(t){}getAllStyles(){return Array.from(this._stylesSet)}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})(),sh=(()=>{class r extends _b{constructor(t){super(),this._doc=t,this._hostNodes=new Map,this._hostNodes.set(t.head,[])}_addStylesToHost(t,i,n){t.forEach(s=>{const a=this._doc.createElement("style");a.textContent=s,n.push(i.appendChild(a))})}addHost(t){const i=[];this._addStylesToHost(this._stylesSet,t,i),this._hostNodes.set(t,i)}removeHost(t){const i=this._hostNodes.get(t);i&&i.forEach(mb),this._hostNodes.delete(t)}onStylesAdded(t){this._hostNodes.forEach((i,n)=>{this._addStylesToHost(t,n,i)})}ngOnDestroy(){this._hostNodes.forEach(t=>t.forEach(mb))}}return r.\u0275fac=function(t){return new(t||r)(rt(xn))},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})();function mb(r){eh().remove(r)}const Vm={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/MathML/"},km=/%COMP%/g;function Ef(r,e,t){for(let i=0;i<e.length;i++){let n=e[i];Array.isArray(n)?Ef(r,n,t):(n=n.replace(km,r),t.push(n))}return t}function vb(r){return e=>{if("__ngUnwrap__"===e)return r;!1===r(e)&&(e.preventDefault(),e.returnValue=!1)}}let Gm=(()=>{class r{constructor(t,i,n){this.eventManager=t,this.sharedStylesHost=i,this.appId=n,this.rendererByCompId=new Map,this.defaultRenderer=new Hm(t)}createRenderer(t,i){if(!t||!i)return this.defaultRenderer;switch(i.encapsulation){case vs.Emulated:{let n=this.rendererByCompId.get(i.id);return n||(n=new gH(this.eventManager,this.sharedStylesHost,i,this.appId),this.rendererByCompId.set(i.id,n)),n.applyToHost(t),n}case 1:case vs.ShadowDom:return new _H(this.eventManager,this.sharedStylesHost,t,i);default:if(!this.rendererByCompId.has(i.id)){const n=Ef(i.id,i.styles,[]);this.sharedStylesHost.addStyles(n),this.rendererByCompId.set(i.id,this.defaultRenderer)}return this.defaultRenderer}}begin(){}end(){}}return r.\u0275fac=function(t){return new(t||r)(rt(Tf),rt(sh),rt(qu))},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})();class Hm{constructor(e){this.eventManager=e,this.data=Object.create(null),this.destroyNode=null}destroy(){}createElement(e,t){return t?document.createElementNS(Vm[t]||t,e):document.createElement(e)}createComment(e){return document.createComment(e)}createText(e){return document.createTextNode(e)}appendChild(e,t){e.appendChild(t)}insertBefore(e,t,i){e&&e.insertBefore(t,i)}removeChild(e,t){e&&e.removeChild(t)}selectRootElement(e,t){let i="string"==typeof e?document.querySelector(e):e;if(!i)throw new Error(`The selector "${e}" did not match any elements`);return t||(i.textContent=""),i}parentNode(e){return e.parentNode}nextSibling(e){return e.nextSibling}setAttribute(e,t,i,n){if(n){t=n+":"+t;const s=Vm[n];s?e.setAttributeNS(s,t,i):e.setAttribute(t,i)}else e.setAttribute(t,i)}removeAttribute(e,t,i){if(i){const n=Vm[i];n?e.removeAttributeNS(n,t):e.removeAttribute(`${i}:${t}`)}else e.removeAttribute(t)}addClass(e,t){e.classList.add(t)}removeClass(e,t){e.classList.remove(t)}setStyle(e,t,i,n){n&(Jr.DashCase|Jr.Important)?e.style.setProperty(t,i,n&Jr.Important?"important":""):e.style[t]=i}removeStyle(e,t,i){i&Jr.DashCase?e.style.removeProperty(t):e.style[t]=""}setProperty(e,t,i){e[t]=i}setValue(e,t){e.nodeValue=t}listen(e,t,i){return"string"==typeof e?this.eventManager.addGlobalEventListener(e,t,vb(i)):this.eventManager.addEventListener(e,t,vb(i))}}class gH extends Hm{constructor(e,t,i,n){super(e),this.component=i;const s=Ef(n+"-"+i.id,i.styles,[]);t.addStyles(s),this.contentAttr=function dH(r){return"_ngcontent-%COMP%".replace(km,r)}(n+"-"+i.id),this.hostAttr=function fH(r){return"_nghost-%COMP%".replace(km,r)}(n+"-"+i.id)}applyToHost(e){super.setAttribute(e,this.hostAttr,"")}createElement(e,t){const i=super.createElement(e,t);return super.setAttribute(i,this.contentAttr,""),i}}class _H extends Hm{constructor(e,t,i,n){super(e),this.sharedStylesHost=t,this.hostEl=i,this.shadowRoot=i.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);const s=Ef(n.id,n.styles,[]);for(let a=0;a<s.length;a++){const o=document.createElement("style");o.textContent=s[a],this.shadowRoot.appendChild(o)}}nodeOrShadowRoot(e){return e===this.hostEl?this.shadowRoot:e}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}appendChild(e,t){return super.appendChild(this.nodeOrShadowRoot(e),t)}insertBefore(e,t,i){return super.insertBefore(this.nodeOrShadowRoot(e),t,i)}removeChild(e,t){return super.removeChild(this.nodeOrShadowRoot(e),t)}parentNode(e){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(e)))}}let mH=(()=>{class r extends gb{constructor(t){super(t)}supports(t){return!0}addEventListener(t,i,n){return t.addEventListener(i,n,!1),()=>this.removeEventListener(t,i,n)}removeEventListener(t,i,n){return t.removeEventListener(i,n)}}return r.\u0275fac=function(t){return new(t||r)(rt(xn))},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})();const xb=["alt","control","meta","shift"],EH={"\b":"Backspace","\t":"Tab","\x7f":"Delete","\x1b":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},Ab={A:"1",B:"2",C:"3",D:"4",E:"5",F:"6",G:"7",H:"8",I:"9",J:"*",K:"+",M:"-",N:".",O:"/","`":"0","\x90":"NumLock"},vH={alt:r=>r.altKey,control:r=>r.ctrlKey,meta:r=>r.metaKey,shift:r=>r.shiftKey};let SH=(()=>{class r extends gb{constructor(t){super(t)}supports(t){return null!=r.parseEventName(t)}addEventListener(t,i,n){const s=r.parseEventName(i),a=r.eventCallback(s.fullKey,n,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>eh().onAndCancel(t,s.domEventName,a))}static parseEventName(t){const i=t.toLowerCase().split("."),n=i.shift();if(0===i.length||"keydown"!==n&&"keyup"!==n)return null;const s=r._normalizeKey(i.pop());let a="";if(xb.forEach(l=>{const c=i.indexOf(l);c>-1&&(i.splice(c,1),a+=l+".")}),a+=s,0!=i.length||0===s.length)return null;const o={};return o.domEventName=n,o.fullKey=a,o}static getEventFullKey(t){let i="",n=function xH(r){let e=r.key;if(null==e){if(e=r.keyIdentifier,null==e)return"Unidentified";e.startsWith("U+")&&(e=String.fromCharCode(parseInt(e.substring(2),16)),3===r.location&&Ab.hasOwnProperty(e)&&(e=Ab[e]))}return EH[e]||e}(t);return n=n.toLowerCase()," "===n?n="space":"."===n&&(n="dot"),xb.forEach(s=>{s!=n&&vH[s](t)&&(i+=s+".")}),i+=n,i}static eventCallback(t,i,n){return s=>{r.getEventFullKey(s)===t&&n.runGuarded(()=>i(s))}}static _normalizeKey(t){return"esc"===t?"escape":t}}return r.\u0275fac=function(t){return new(t||r)(rt(xn))},r.\u0275prov=St({token:r,factory:r.\u0275fac}),r})();const CH=R0(cG,"browser",[{provide:Gr,useValue:rb},{provide:x0,useValue:function AH(){Bm.makeCurrent(),Um.init()},multi:!0},{provide:xn,useFactory:function bH(){return function d1(r){ng=r}(document),document},deps:[]}]),IH=[{provide:S_,useValue:"root"},{provide:Nu,useFactory:function yH(){return new Nu},deps:[]},{provide:mf,useClass:mH,multi:!0,deps:[xn,Pn,Gr]},{provide:mf,useClass:SH,multi:!0,deps:[xn]},{provide:Gm,useClass:Gm,deps:[Tf,sh,qu]},{provide:Fy,useExisting:Gm},{provide:_b,useExisting:sh},{provide:sh,useClass:sh,deps:[xn]},{provide:dm,useClass:dm,deps:[Pn]},{provide:Tf,useClass:Tf,deps:[mf,Pn]},{provide:class iH{},useClass:cH,deps:[]}];let RH=(()=>{class r{constructor(t){if(t)throw new Error("BrowserModule has already been loaded. If you need access to common directives such as NgIf and NgFor from a lazy loaded module, import CommonModule instead.")}static withServerTransition(t){return{ngModule:r,providers:[{provide:qu,useValue:t.appId},{provide:pb,useExisting:qu},lH]}}}return r.\u0275fac=function(t){return new(t||r)(rt(r,12))},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({providers:IH,imports:[eH,uG]}),r})();"undefined"!=typeof window&&window;var Ic=L(3753),Io=L(591),ah=L(2247),js=L(2198),VH=L(826),kH=L(448);class HH{constructor(e,t){this.observables=e,this.project=t}call(e,t){return t.subscribe(new zH(e,this.observables,this.project))}}class zH extends VH.L{constructor(e,t,i){super(e),this.observables=t,this.project=i,this.toRespond=[];const n=t.length;this.values=new Array(n);for(let s=0;s<n;s++)this.toRespond.push(s);for(let s=0;s<n;s++)this.add((0,kH.D)(this,t[s],void 0,s))}notifyNext(e,t,i){this.values[i]=t;const n=this.toRespond;if(n.length>0){const s=n.indexOf(i);-1!==s&&n.splice(s,1)}}notifyComplete(){}_next(e){if(0===this.toRespond.length){const t=[e,...this.values];this.project?this._tryProject(t):this.destination.next(t)}}_tryProject(e){let t;try{t=this.project.apply(this,e)}catch(i){return void this.destination.error(i)}this.destination.next(t)}}var Ir=L(4850),oh=L(3489),Ro=L(7876),WH=L(7043);function Mo(r,e,t){return function(n){return n.lift(new XH(r,e,t))}}class XH{constructor(e,t,i){this.nextOrObserver=e,this.error=t,this.complete=i}call(e,t){return t.subscribe(new YH(e,this.nextOrObserver,this.error,this.complete))}}class YH extends oh.L{constructor(e,t,i,n){super(e),this._tapNext=Ro.Z,this._tapError=Ro.Z,this._tapComplete=Ro.Z,this._tapError=i||Ro.Z,this._tapComplete=n||Ro.Z,(0,WH.m)(t)?(this._context=this,this._tapNext=t):t&&(this._context=t,this._tapNext=t.next||Ro.Z,this._tapError=t.error||Ro.Z,this._tapComplete=t.complete||Ro.Z)}_next(e){try{this._tapNext.call(this._context,e)}catch(t){return void this.destination.error(t)}this.destination.next(e)}_error(e){try{this._tapError.call(this._context,e)}catch(t){return void this.destination.error(t)}this.destination.error(e)}_complete(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()}}var Rc=L(1177);function ns(r){return e=>e.lift(new jH(r))}class jH{constructor(e){this.notifier=e}call(e,t){const i=new $H(e),n=(0,Rc.ft)(this.notifier,new Rc.IY(i));return n&&!i.seenValue?(i.add(n),t.subscribe(i)):i}}class $H extends Rc.Ds{constructor(e){super(e),this.seenValue=!1}notifyNext(){this.seenValue=!0,this.complete()}notifyComplete(){}}var KH=L(4231),QH=L(8896);function Wm(r){return e=>0===r?(0,QH.c)():e.lift(new ZH(r))}class ZH{constructor(e){if(this.total=e,this.total<0)throw new KH.W}call(e,t){return t.subscribe(new qH(e,this.total))}}class qH extends oh.L{constructor(e,t){super(e),this.total=t,this.count=0}_next(e){const t=this.total,i=++this.count;i<=t&&(this.destination.next(e),i===t&&(this.destination.complete(),this.unsubscribe()))}}function Rb(){return function(r){return new Pe.y(e=>{r.subscribe({next(t){null!=t&&e.next(t)},error(t){e.error(t)},complete(){e.complete()}})})}}class Se{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return 0==(e=+e)||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=Se.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=Se.Repeat(e,2*t);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let n=Se.Clamp(i);return n=-2*n*n*n+3*n*n,t*n+e*(1-n)}static MoveTowards(e,t,i){let n=0;return n=Math.abs(t-e)<=i?t:e+Se.Sign(t-e)*i,n}static MoveTowardsAngle(e,t,i){const n=Se.DeltaAngle(e,t);let s=0;return s=-i<n&&n<i?t:Se.MoveTowards(e,t=e+n,i),s}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let n=Se.Repeat(t-e,360);return n>180&&(n-=360),e+n*Se.Clamp(i)}static InverseLerp(e,t,i){let n=0;return n=e!=t?Se.Clamp((i-e)/(t-e)):0,n}static Hermite(e,t,i,n,s){const a=s*s,o=s*a;return e*(2*o-3*a+1)+i*(-2*o+3*a)+t*(o-2*a+s)+n*(o-a)}static Hermite1stDerivative(e,t,i,n,s){const a=s*s;return 6*(a-s)*e+(3*a-4*s+1)*t+6*(-a+s)*i+(3*a-2*s)*n}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-Se.TwoPi*Math.floor((e+Math.PI)/Se.TwoPi)}static HCF(e,t){const i=e%t;return 0===i?t:Se.HCF(t,i)}}function b(r,e,t,i){var a,n=arguments.length,s=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(r,e,t,i);else for(var o=r.length-1;o>=0;o--)(a=r[o])&&(s=(n<3?a(s):n>3?a(e,t,s):a(e,t))||s);return n>3&&s&&Object.defineProperty(e,t,s),s}Se.TwoPi=2*Math.PI;const Sf=1/2.2,nn=(1+Math.sqrt(5))/2,kt=.001;class mn{static BuildArray(e,t){const i=[];for(let n=0;n<e;++n)i.push(t());return i}static BuildTuple(e,t){return mn.BuildArray(e,t)}}const iz=["push","splice","pop","shift","unshift"];function Ob(r,e){const t=iz.map(i=>function tz(r,e,t){const i=r[e];if("function"!=typeof i)return null;const n=function(){const s=r.length,a=n.previous.apply(r,arguments);return t(e,s),a};return i.next=n,n.previous=i,r[e]=n,()=>{const s=n.previous;if(!s)return;const a=n.next;a?(s.next=a,a.previous=s):(s.next=void 0,r[e]=s),n.next=void 0,n.previous=void 0}}(r,i,e));return()=>{t.forEach(i=>{null==i||i()})}}const Fb={};function ye(r,e){Fb[r]=e}function zr(r){return Fb[r]}class bn{static SetMatrixPrecision(e){if(bn.MatrixTrackPrecisionChange=!1,e&&!bn.MatrixUse64Bits&&bn.MatrixTrackedMatrices)for(let t=0;t<bn.MatrixTrackedMatrices.length;++t){const i=bn.MatrixTrackedMatrices[t],n=i._m;i._m=new Array(16);for(let s=0;s<16;++s)i._m[s]=n[s]}bn.MatrixUse64Bits=e,bn.MatrixCurrentType=bn.MatrixUse64Bits?Array:Float32Array,bn.MatrixTrackedMatrices=null}}bn.MatrixUse64Bits=!1,bn.MatrixTrackPrecisionChange=!0,bn.MatrixCurrentType=Float32Array,bn.MatrixTrackedMatrices=[];class nz{constructor(e,t=!1,i,n){this.initialize(e,t,i,n)}initialize(e,t=!1,i,n){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=n,this}}class rz{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class J{static FromPromise(e,t){const i=new J;return e.then(n=>{i.notifyObservers(n)}).catch(n=>{if(!t)throw n;t.notifyObservers(n)}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new nz(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,n=null,s=!1){if(!e)return null;const a=new rz(e,t,n);return a.unregisterOnNextCall=s,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(a,this._lastNotifiedValue),a}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return!(!e||-1===this._observers.indexOf(e)||(this._deferUnregister(e),0))}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const n=this._observers[i];if(!(n._willBeUnregistered||n.callback!==e||t&&t!==n.scope))return this._deferUnregister(n),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return-1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,n,s){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const a=this._eventState;a.mask=t,a.target=i,a.currentTarget=n,a.skipNextObservers=!1,a.lastReturnValue=e,a.userInfo=s;for(const o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.unregisterOnNextCall&&this._deferUnregister(o),a.lastReturnValue=o.scope?o.callback.apply(o.scope,[e,a]):o.callback(e,a)),a.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const n=this._eventState;n.mask=i,n.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,n)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){this._observers.length=0,this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new J;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class Je{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}Je.Instances=new Array,Je.OnEnginesDisposedObservable=new J,Je._LastCreatedScene=null,Je.UseFallbackTexture=!0,Je.FallbackTexture="";const Rr=r=>parseInt(r.toString().replace(/\W/g,""));class We{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let i=Rr(this.x);return i=397*i^Rr(this.y),i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return We.FromArrayToRef(e,t,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=kt){return e&&Se.WithinEpsilon(this.x,e.x,t)&&Se.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),n=Math.sin(e),a=n*this.x+i*this.y;return t.x=i*this.x-n*this.y,t.y=a,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return We.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new We(0,0)}static One(){return new We(1,1)}static Random(e=0,t=1){return new We(Se.RandomRange(e,t),Se.RandomRange(e,t))}static get ZeroReadOnly(){return We._ZeroReadOnly}static FromArray(e,t=0){return new We(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,n,s){const a=s*s,o=s*a;return new e.constructor(.5*(2*t.x+(-e.x+i.x)*s+(2*e.x-5*t.x+4*i.x-n.x)*a+(3*t.x-e.x-3*i.x+n.x)*o),.5*(2*t.y+(-e.y+i.y)*s+(2*e.y-5*t.y+4*i.y-n.y)*a+(3*t.y-e.y-3*i.y+n.y)*o))}static Clamp(e,t,i){let n=e.x;n=n>i.x?i.x:n,n=n<t.x?t.x:n;let s=e.y;return s=s>i.y?i.y:s,s=s<t.y?t.y:s,new e.constructor(n,s)}static Hermite(e,t,i,n,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a;return new e.constructor(e.x*l+i.x*c+t.x*u+n.x*h,e.y*l+i.y*c+t.y*u+n.y*h)}static Hermite1stDerivative(e,t,i,n,s){const a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,s,a),a}static Hermite1stDerivativeToRef(e,t,i,n,s,a){const o=s*s;return a.x=6*(o-s)*e.x+(3*o-4*s+1)*t.x+6*(-o+s)*i.x+(3*o-2*s)*n.x,a.y=6*(o-s)*e.y+(3*o-4*s+1)*t.y+6*(-o+s)*i.y+(3*o-2*s)*n.y,a}static Lerp(e,t,i){return new e.constructor(e.x+(t.x-e.x)*i,e.y+(t.y-e.y)*i)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){const i=e.length();return 0===i||(t.x=e.x/i,t.y=e.y/i),t}static Minimize(e,t){return new e.constructor(e.x<t.x?e.x:t.x,e.y<t.y?e.y:t.y)}static Maximize(e,t){return new e.constructor(e.x>t.x?e.x:t.x,e.y>t.y?e.y:t.y)}static Transform(e,t){const i=new e.constructor;return We.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const n=t.m,a=e.x*n[1]+e.y*n[5]+n[13];return i.x=e.x*n[0]+e.y*n[4]+n[12],i.y=a,i}static PointInTriangle(e,t,i,n){const s=.5*(-i.y*n.x+t.y*(-i.x+n.x)+t.x*(i.y-n.y)+i.x*n.y),a=s<0?-1:1,o=(t.y*n.x-t.x*n.y+(n.y-t.y)*e.x+(t.x-n.x)*e.y)*a,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*a;return o>0&&l>0&&o+l<2*s*a}static Distance(e,t){return Math.sqrt(We.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}static Center(e,t){const i=new e.constructor;return We.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const n=We.DistanceSquared(t,i);if(0===n)return We.Distance(e,t);const s=i.subtract(t),a=Math.max(0,Math.min(1,We.Dot(e.subtract(t),s)/n)),o=t.add(s.multiplyByFloats(a,a));return We.Distance(e,o)}}We._ZeroReadOnly=We.Zero();class E{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let n=Rr(this._x);return n=397*n^Rr(this._y),n=397*n^Rr(this._z),n}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return E.FromArrayToRef(e,t,this),this}toQuaternion(){return Be.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,n){return n.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(-1*this._x,-1*this._y,-1*this._z)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const n=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const s=t*Math.sin(i)*Math.cos(n),a=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(n);return e.set(s,a,o),e}applyRotationQuaternionToRef(e,t){const i=e._w*this._x+e._y*this._z-e._z*this._y,n=e._w*this._y+e._z*this._x-e._x*this._z,s=e._w*this._z+e._x*this._y-e._y*this._x,a=-e._x*this._x-e._y*this._y-e._z*this._z;return t._x=i*e._w+a*-e._x+n*-e._z-s*-e._y,t._y=n*e._w+a*-e._y+s*-e._x-i*-e._z,t._z=s*e._w+a*-e._z+i*-e._y-n*-e._x,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const n=e.normal,s=e.d,a=tt.Vector3[0];this.subtractToRef(t,a),a.normalize();const o=E.Dot(a,n);if(Math.abs(o)<Math.pow(10,-10))i.setAll(1/0);else{const l=-(E.Dot(t,n)+s)/o,c=a.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=kt){return e&&Se.WithinEpsilon(this._x,e._x,t)&&Se.WithinEpsilon(this._y,e._y,t)&&Se.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!Se.WithinEpsilon(t,i,e))return!0;const n=Math.abs(this._z);return!Se.WithinEpsilon(t,n,e)||!Se.WithinEpsilon(i,n,e)}get isNonUniform(){const e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z==0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return"xyz"===(e=e.toLowerCase())||(tt.Vector3[0].copyFrom(this),["x","y","z"].forEach((t,i)=>{this[t]=tt.Vector3[0][e[i]]})),this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(tt.Matrix[0]),E.TransformCoordinatesToRef(this,tt.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,tt.Vector3[0]),tt.Vector3[0].rotateByQuaternionToRef(e,tt.Vector3[0]),t.addToRef(tt.Vector3[0],i),i}cross(e){const t=new this.constructor;return E.CrossToRef(this,e,t)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,n){const s=E.Dot(e,i)-n;return s/(s-(E.Dot(t,i)-n))}static GetAngleBetweenVectors(e,t,i){const n=e.normalizeToRef(tt.Vector3[1]),s=t.normalizeToRef(tt.Vector3[2]);let a=E.Dot(n,s);a=Se.Clamp(a,-1,1);const o=Math.acos(a),l=tt.Vector3[3];return E.CrossToRef(n,s,l),E.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}static GetAngleBetweenVectorsOnPlane(e,t,i){tt.Vector3[0].copyFrom(e);const n=tt.Vector3[0];tt.Vector3[1].copyFrom(t);const s=tt.Vector3[1];tt.Vector3[2].copyFrom(i);const a=tt.Vector3[2],o=tt.Vector3[3],l=tt.Vector3[4];n.normalize(),s.normalize(),a.normalize(),E.CrossToRef(a,n,o),E.CrossToRef(o,a,l);const c=Math.atan2(E.Dot(s,o),E.Dot(s,l));return Se.NormalizeRadians(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const n=z.Vector3[0];return t.subtractToRef(e,n),i._y=Math.atan2(n.x,n.z)||0,i._x=Math.atan2(Math.sqrt(n.x**2+n.z**2),n.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=E.Zero();return E.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,n){i=Se.Clamp(i,0,1);const s=tt.Vector3[0],a=tt.Vector3[1];s.copyFrom(e);const o=s.length();s.normalizeFromLength(o),a.copyFrom(t);const l=a.length();a.normalizeFromLength(l);const c=E.Dot(s,a);let u,h;if(c<1-kt){const d=Math.acos(c),f=1/Math.sin(d);u=Math.sin((1-i)*d)*f,h=Math.sin(i*d)*f}else u=1-i,h=i;return s.scaleInPlace(u),a.scaleInPlace(h),n.copyFrom(s).addInPlace(a),n.scaleInPlace(Se.Lerp(o,l,i)),n}static SmoothToRef(e,t,i,n,s){return E.SlerpToRef(e,t,0===n?1:i/n,s),s}static FromArray(e,t=0){return new E(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return E.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return E.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,n){return n.copyFromFloats(e,t,i),n}static Zero(){return new E(0,0,0)}static One(){return new E(1,1,1)}static Up(){return new E(0,1,0)}static get UpReadOnly(){return E._UpReadOnly}static get DownReadOnly(){return E._DownReadOnly}static get RightReadOnly(){return E._RightReadOnly}static get LeftReadOnly(){return E._LeftReadOnly}static get LeftHandedForwardReadOnly(){return E._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return E._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return E._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return E._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return E._ZeroReadOnly}static Down(){return new E(0,-1,0)}static Forward(e=!1){return new E(0,0,e?-1:1)}static Backward(e=!1){return new E(0,0,e?1:-1)}static Right(){return new E(1,0,0)}static Left(){return new E(-1,0,0)}static Random(e=0,t=1){return new E(Se.RandomRange(e,t),Se.RandomRange(e,t),Se.RandomRange(e,t))}static TransformCoordinates(e,t){const i=E.Zero();return E.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return E.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,n,s){const a=n.m,l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],u=1/(e*a[3]+t*a[7]+i*a[11]+a[15]);return s._x=(e*a[0]+t*a[4]+i*a[8]+a[12])*u,s._y=l*u,s._z=c*u,s._isDirty=!0,s}static TransformNormal(e,t){const i=E.Zero();return E.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,n,s){const a=n.m;return s._x=e*a[0]+t*a[4]+i*a[8],s._y=e*a[1]+t*a[5]+i*a[9],s._z=e*a[2]+t*a[6]+i*a[10],s._isDirty=!0,s}static CatmullRom(e,t,i,n,s){const a=s*s,o=s*a;return new e.constructor(.5*(2*t._x+(-e._x+i._x)*s+(2*e._x-5*t._x+4*i._x-n._x)*a+(3*t._x-e._x-3*i._x+n._x)*o),.5*(2*t._y+(-e._y+i._y)*s+(2*e._y-5*t._y+4*i._y-n._y)*a+(3*t._y-e._y-3*i._y+n._y)*o),.5*(2*t._z+(-e._z+i._z)*s+(2*e._z-5*t._z+4*i._z-n._z)*a+(3*t._z-e._z-3*i._z+n._z)*o))}static Clamp(e,t,i){const n=new e.constructor;return E.ClampToRef(e,t,i,n),n}static ClampToRef(e,t,i,n){let s=e._x;s=s>i._x?i._x:s,s=s<t._x?t._x:s;let a=e._y;a=a>i._y?i._y:a,a=a<t._y?t._y:a;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,n.copyFromFloats(s,a,o),n}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,n,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a;return new e.constructor(e._x*l+i._x*c+t._x*u+n._x*h,e._y*l+i._y*c+t._y*u+n._y*h,e._z*l+i._z*c+t._z*u+n._z*h)}static Hermite1stDerivative(e,t,i,n,s){const a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,s,a),a}static Hermite1stDerivativeToRef(e,t,i,n,s,a){const o=s*s;return a._x=6*(o-s)*e._x+(3*o-4*s+1)*t._x+6*(-o+s)*i._x+(3*o-2*s)*n._x,a._y=6*(o-s)*e._y+(3*o-4*s+1)*t._y+6*(-o+s)*i._y+(3*o-2*s)*n._y,a._z=6*(o-s)*e._z+(3*o-4*s+1)*t._z+6*(-o+s)*i._z+(3*o-2*s)*n._z,a._isDirty=!0,a}static Lerp(e,t,i){const n=new e.constructor(0,0,0);return E.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){return n._x=e._x+(t._x-e._x)*i,n._y=e._y+(t._y-e._y)*i,n._z=e._z+(t._z-e._z)*i,n._isDirty=!0,n}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(e,t){const i=new e.constructor;return E.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){return i.copyFromFloats(e._y*t._z-e._z*t._y,e._z*t._x-e._x*t._z,e._x*t._y-e._y*t._x),i}static Normalize(e){const t=E.Zero();return E.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,n){const s=new e.constructor;return E.ProjectToRef(e,t,i,n,s),s}static ProjectToRef(e,t,i,n,s){const a=n.width,o=n.height,u=tt.Matrix[1];B.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,.5,0,n.x+a/2,o/2+n.y,.5,1,u);const h=tt.Matrix[0];return t.multiplyToRef(i,h),h.multiplyToRef(u,h),E.TransformCoordinatesToRef(e,h,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new E)}static ReflectToRef(e,t,i){const n=z.Vector3[0];return n.copyFrom(t).scaleInPlace(2*E.Dot(e,t)),i.copyFrom(e).subtractInPlace(n)}static _UnprojectFromInvertedMatrixToRef(e,t,i){E.TransformCoordinatesToRef(e,t,i);const n=t.m,s=e._x*n[3]+e._y*n[7]+e._z*n[11]+n[15];return Se.WithinEpsilon(s,1)&&i.scaleInPlace(1/s),i}static UnprojectFromTransform(e,t,i,n,s){return this.Unproject(e,t,i,n,s,B.IdentityReadOnly)}static Unproject(e,t,i,n,s,a){const o=new e.constructor;return E.UnprojectToRef(e,t,i,n,s,a,o),o}static UnprojectToRef(e,t,i,n,s,a,o){return E.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,n,s,a,o),o}static UnprojectFloatsToRef(e,t,i,n,s,a,o,l,c){var u;const h=tt.Matrix[0];a.multiplyToRef(o,h),h.multiplyToRef(l,h),h.invert();const d=tt.Vector3[0];return d.x=e/n*2-1,d.y=-(t/s*2-1),d.z=(null===(u=Je.LastCreatedEngine)||void 0===u?void 0:u.isNDCHalfZRange)?i:2*i-1,E._UnprojectFromInvertedMatrixToRef(d,h,c),c}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(E.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,n=e._y-t._y,s=e._z-t._z;return i*i+n*n+s*s}static ProjectOnTriangleToRef(e,t,i,n,s){const a=tt.Vector3[0],o=tt.Vector3[1],l=tt.Vector3[2],c=tt.Vector3[3],u=tt.Vector3[4];i.subtractToRef(t,a),n.subtractToRef(t,o),n.subtractToRef(i,l);const h=a.length(),d=o.length(),f=l.length();if(h<kt||d<kt||f<kt)return s.copyFrom(t),E.Distance(e,t);e.subtractToRef(t,u),E.CrossToRef(a,o,c);const p=c.length();if(p<kt)return s.copyFrom(t),E.Distance(e,t);c.normalizeFromLength(p);let g=u.length();if(g<kt)return s.copyFrom(t),0;u.normalizeFromLength(g);const _=E.Dot(c,u),m=tt.Vector3[5],T=tt.Vector3[6];m.copyFrom(c).scaleInPlace(-g*_),T.copyFrom(e).addInPlace(m);const v=tt.Vector3[4],A=tt.Vector3[5],S=tt.Vector3[7],x=tt.Vector3[8];v.copyFrom(a).scaleInPlace(1/h),x.copyFrom(o).scaleInPlace(1/d),v.addInPlace(x).scaleInPlace(-1),A.copyFrom(a).scaleInPlace(-1/h),x.copyFrom(l).scaleInPlace(1/f),A.addInPlace(x).scaleInPlace(-1),S.copyFrom(l).scaleInPlace(-1/f),x.copyFrom(o).scaleInPlace(-1/d),S.addInPlace(x).scaleInPlace(-1);const C=tt.Vector3[9];let R;C.copyFrom(T).subtractInPlace(t),E.CrossToRef(v,C,x),R=E.Dot(x,c);const D=R;C.copyFrom(T).subtractInPlace(i),E.CrossToRef(A,C,x),R=E.Dot(x,c);const P=R;C.copyFrom(T).subtractInPlace(n),E.CrossToRef(S,C,x),R=E.Dot(x,c);const N=R,k=tt.Vector3[10];let X,ne;D>0&&P<0?(k.copyFrom(a),X=t,ne=i):P>0&&N<0?(k.copyFrom(l),X=i,ne=n):(k.copyFrom(o).scaleInPlace(-1),X=n,ne=t);const ge=tt.Vector3[9],ue=tt.Vector3[4];if(X.subtractToRef(T,x),ne.subtractToRef(T,ge),E.CrossToRef(x,ge,ue),!(E.Dot(ue,c)<0))return s.copyFrom(T),Math.abs(g*_);const me=tt.Vector3[5];E.CrossToRef(k,ue,me),me.normalize();const $=tt.Vector3[9];$.copyFrom(X).subtractInPlace(T);const Q=$.length();if(Q<kt)return s.copyFrom(X),E.Distance(e,X);$.normalizeFromLength(Q);const w=E.Dot(me,$),Y=tt.Vector3[7];Y.copyFrom(T).addInPlace(me.scaleInPlace(Q*w)),x.copyFrom(Y).subtractInPlace(X),g=k.length(),k.normalizeFromLength(g);let se=E.Dot(x,k)/Math.max(g,kt);return se=Se.Clamp(se,0,1),Y.copyFrom(X).addInPlace(k.scaleInPlace(se*g)),s.copyFrom(Y),E.Distance(e,Y)}static Center(e,t){return E.CenterToRef(e,t,E.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const n=new e.constructor;return E.RotationFromAxisToRef(e,t,i,n),n}static RotationFromAxisToRef(e,t,i,n){const s=tt.Quaternion[0];return Be.RotationQuaternionFromAxisToRef(e,t,i,s),s.toEulerAnglesToRef(n),n}}E._UpReadOnly=E.Up(),E._DownReadOnly=E.Down(),E._LeftHandedForwardReadOnly=E.Forward(!1),E._RightHandedForwardReadOnly=E.Forward(!0),E._LeftHandedBackwardReadOnly=E.Backward(!1),E._RightHandedBackwardReadOnly=E.Backward(!0),E._RightReadOnly=E.Right(),E._LeftReadOnly=E.Left(),E._ZeroReadOnly=E.Zero();class Qt{constructor(e=0,t=0,i=0,n=0){this.x=e,this.y=t,this.z=i,this.w=n}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let s=Rr(this.x);return s=397*s^Rr(this.y),s=397*s^Rr(this.z),s=397*s^Rr(this.w),s}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return Qt.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,n){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-n)}subtractFromFloatsToRef(e,t,i,n,s){return s.x=this.x-e,s.y=this.y-t,s.z=this.z-i,s.w=this.w-n,s}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=kt){return e&&Se.WithinEpsilon(this.x,e.x,t)&&Se.WithinEpsilon(this.y,e.y,t)&&Se.WithinEpsilon(this.z,e.z,t)&&Se.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,n){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*n)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return 0===e?this:this.scaleInPlace(1/e)}toVector3(){return new E(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}set(e,t,i,n){return this.copyFromFloats(e,t,i,n)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,t){return t||(t=0),new Qt(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return Qt.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,n,s){return s.x=e,s.y=t,s.z=i,s.w=n,s}static Zero(){return new Qt(0,0,0,0)}static One(){return new Qt(1,1,1,1)}static Random(e=0,t=1){return new Qt(Se.RandomRange(e,t),Se.RandomRange(e,t),Se.RandomRange(e,t),Se.RandomRange(e,t))}static get ZeroReadOnly(){return Qt._ZeroReadOnly}static Normalize(e){const t=Qt.Zero();return Qt.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return t.copyFrom(e),t.normalize(),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(Qt.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return i*i+n*n+s*s+a*a}static Center(e,t){return Qt.CenterToRef(e,t,Qt.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=Qt.Zero();return Qt.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return Qt.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,n,s){const a=n.m,l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],u=e*a[3]+t*a[7]+i*a[11]+a[15];return s.x=e*a[0]+t*a[4]+i*a[8]+a[12],s.y=l,s.z=c,s.w=u,s}static TransformNormal(e,t){const i=new e.constructor;return Qt.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const n=t.m,a=e.x*n[1]+e.y*n[5]+e.z*n[9],o=e.x*n[2]+e.y*n[6]+e.z*n[10];return i.x=e.x*n[0]+e.y*n[4]+e.z*n[8],i.y=a,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,n,s,a){const o=s.m;return a.x=e*o[0]+t*o[4]+i*o[8],a.y=e*o[1]+t*o[5]+i*o[9],a.z=e*o[2]+t*o[6]+i*o[10],a.w=n,a}static FromVector3(e,t=0){return new Qt(e._x,e._y,e._z,t)}}Qt._ZeroReadOnly=Qt.Zero();class Be{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,n=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=n}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let s=Rr(this._x);return s=397*s^Rr(this._y),s=397*s^Rr(this._z),s=397*s^Rr(this._w),s}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=kt){return e&&Se.WithinEpsilon(this._x,e._x,t)&&Se.WithinEpsilon(this._y,e._y,t)&&Se.WithinEpsilon(this._z,e._z,t)&&Se.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._isDirty=!0,this}set(e,t,i,n){return this.copyFromFloats(e,t,i,n)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();return 0===e||this.scaleInPlace(1/e),this}normalizeToNew(){const e=this.length();return 0===e?this.clone():this.scale(1/e)}toEulerAngles(){const e=E.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,n=this._y,s=this._w,a=n*t-i*s,o=.4999999;if(a<-o)e._y=2*Math.atan2(n,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(a>o)e._y=2*Math.atan2(n,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=s*s,c=t*t,u=i*i,h=n*n;e._z=Math.atan2(2*(i*n+t*s),-c-u+h+l),e._x=Math.asin(-2*a),e._y=Math.atan2(2*(t*i+n*s),c-u-h+l),e._isDirty=!0}return e}toRotationMatrix(e){return B.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return Be.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const t=new Be;return Be.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,n=i[0],s=i[4],a=i[8],o=i[1],l=i[5],c=i[9],u=i[2],h=i[6],d=i[10],f=n+l+d;let p;return f>0?(p=.5/Math.sqrt(f+1),t._w=.25/p,t._x=(h-c)*p,t._y=(a-u)*p,t._z=(o-s)*p,t._isDirty=!0):n>l&&n>d?(p=2*Math.sqrt(1+n-l-d),t._w=(h-c)/p,t._x=.25*p,t._y=(s+o)/p,t._z=(a+u)/p,t._isDirty=!0):l>d?(p=2*Math.sqrt(1+l-n-d),t._w=(a-u)/p,t._x=(s+o)/p,t._y=.25*p,t._z=(c+h)/p,t._isDirty=!0):(p=2*Math.sqrt(1+d-n-l),t._w=(o-s)/p,t._x=(a+u)/p,t._y=(c+h)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const n=Be.Dot(e,t);return 1-n*n<=i}static SmoothToRef(e,t,i,n,s){let a=0===n?1:i/n;return a=Se.Clamp(a,0,1),Be.SlerpToRef(e,t,a,s),s}static Zero(){return new Be(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new Be(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return Be.RotationAxisToRef(e,t,new Be)}static RotationAxisToRef(e,t,i){const n=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*n,i._y=e._y*n,i._z=e._z*n,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new Be(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const n=new Be;return Be.RotationYawPitchRollToRef(t,e,i,n),n}static FromEulerAnglesToRef(e,t,i,n){return Be.RotationYawPitchRollToRef(t,e,i,n),n}static FromEulerVector(e){const t=new Be;return Be.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return Be.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i){const n=E.Dot(e,t)+1;return n<kt?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(E.CrossToRef(e,t,z.Vector3[0]),i.set(z.Vector3[0].x,z.Vector3[0].y,z.Vector3[0].z,n)),i.normalize()}static RotationYawPitchRoll(e,t,i){const n=new Be;return Be.RotationYawPitchRollToRef(e,t,i,n),n}static RotationYawPitchRollToRef(e,t,i,n){const s=.5*i,a=.5*t,o=.5*e,l=Math.sin(s),c=Math.cos(s),u=Math.sin(a),h=Math.cos(a),d=Math.sin(o),f=Math.cos(o);return n._x=f*u*c+d*h*l,n._y=d*h*c-f*u*l,n._z=f*h*l-d*u*c,n._w=f*h*c+d*u*l,n._isDirty=!0,n}static RotationAlphaBetaGamma(e,t,i){const n=new Be;return Be.RotationAlphaBetaGammaToRef(e,t,i,n),n}static RotationAlphaBetaGammaToRef(e,t,i,n){const s=.5*(i+e),a=.5*(i-e),o=.5*t;return n._x=Math.cos(a)*Math.sin(o),n._y=Math.sin(a)*Math.sin(o),n._z=Math.sin(s)*Math.cos(o),n._w=Math.cos(s)*Math.cos(o),n._isDirty=!0,n}static RotationQuaternionFromAxis(e,t,i){const n=new Be(0,0,0,0);return Be.RotationQuaternionFromAxisToRef(e,t,i,n),n}static RotationQuaternionFromAxisToRef(e,t,i,n){const s=tt.Matrix[0];return B.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),s),Be.FromRotationMatrixToRef(s,n),n}static FromLookDirectionLH(e,t){const i=new Be;return Be.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const n=tt.Matrix[0];return B.LookDirectionLHToRef(e,t,n),Be.FromRotationMatrixToRef(n,i),i}static FromLookDirectionRH(e,t){const i=new Be;return Be.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const n=tt.Matrix[0];return B.LookDirectionRHToRef(e,t,n),Be.FromRotationMatrixToRef(n,i)}static Slerp(e,t,i){const n=Be.Identity();return Be.SlerpToRef(e,t,i,n),n}static SlerpToRef(e,t,i,n){let s,a,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)a=1-i,s=l?-i:i;else{const c=Math.acos(o),u=1/Math.sin(c);a=Math.sin((1-i)*c)*u,s=l?-Math.sin(i*c)*u:Math.sin(i*c)*u}return n._x=a*e._x+s*t._x,n._y=a*e._y+s*t._y,n._z=a*e._z+s*t._z,n._w=a*e._w+s*t._w,n._isDirty=!0,n}static Hermite(e,t,i,n,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a;return new e.constructor(e._x*l+i._x*c+t._x*u+n._x*h,e._y*l+i._y*c+t._y*u+n._y*h,e._z*l+i._z*c+t._z*u+n._z*h,e._w*l+i._w*c+t._w*u+n._w*h)}static Hermite1stDerivative(e,t,i,n,s){const a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,s,a),a}static Hermite1stDerivativeToRef(e,t,i,n,s,a){const o=s*s;return a._x=6*(o-s)*e._x+(3*o-4*s+1)*t._x+6*(-o+s)*i._x+(3*o-2*s)*n._x,a._y=6*(o-s)*e._y+(3*o-4*s+1)*t._y+6*(-o+s)*i._y+(3*o-2*s)*n._y,a._z=6*(o-s)*e._z+(3*o-4*s+1)*t._z+6*(-o+s)*i._z+(3*o-2*s)*n._z,a._w=6*(o-s)*e._w+(3*o-4*s+1)*t._w+6*(-o+s)*i._w+(3*o-2*s)*n._w,a._isDirty=!0,a}}class B{static get Use64Bits(){return bn.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=B._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,n=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&n}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,bn.MatrixTrackPrecisionChange&&bn.MatrixTrackedMatrices.push(this),this._m=new bn.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._isIdentity3x2=1===this._m[0]&&1===this._m[5]&&1===this._m[15]&&0===this._m[1]&&0===this._m[2]&&0===this._m[3]&&0===this._m[4]&&0===this._m[6]&&0===this._m[7]&&0===this._m[8]&&0===this._m[9]&&0===this._m[10]&&0===this._m[11]&&0===this._m[12]&&0===this._m[13]&&0===this._m[14]),this._isIdentity3x2}determinant(){if(!0===this._isIdentity)return 1;const e=this._m,a=e[4],o=e[5],l=e[6],c=e[7],u=e[8],h=e[9],d=e[10],f=e[11],p=e[12],g=e[13],_=e[14],m=e[15],T=d*m-_*f,v=h*m-g*f,A=h*_-g*d,S=u*m-p*f,x=u*_-d*p,C=u*g-p*h;return e[0]*+(o*T-l*v+c*A)+e[1]*-(a*T-l*S+c*x)+e[2]*+(a*v-o*S+c*C)+e[3]*-(a*A-o*x+l*C)}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return B.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,n=t._m,s=e.m;for(let a=0;a<16;a++)n[a]=i[a]+s[a];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let n=0;n<16;n++)t[n]+=i[n];return this.markAsUpdated(),this}invertToRef(e){if(!0===this._isIdentity)return B.IdentityToRef(e),e;const t=this._m,i=t[0],n=t[1],s=t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],f=t[10],p=t[11],g=t[12],_=t[13],m=t[14],T=t[15],v=f*T-m*p,A=d*T-_*p,S=d*m-_*f,x=h*T-g*p,C=h*m-f*g,R=h*_-g*d,D=+(l*v-c*A+u*S),P=-(o*v-c*x+u*C),N=+(o*A-l*x+u*R),k=-(o*S-l*C+c*R),X=i*D+n*P+s*N+a*k;if(0===X)return e.copyFrom(this),e;const ne=1/X,ge=c*T-m*u,ue=l*T-_*u,ke=l*m-_*c,me=o*T-g*u,$=o*m-g*c,Q=o*_-g*l,w=c*p-f*u,Y=l*p-d*u,se=l*f-d*c,Re=o*p-h*u,mt=o*f-h*c,$e=o*d-h*l;return B.FromValuesToRef(D*ne,-(n*v-s*A+a*S)*ne,+(n*ge-s*ue+a*ke)*ne,-(n*w-s*Y+a*se)*ne,P*ne,+(i*v-s*x+a*C)*ne,-(i*ge-s*me+a*$)*ne,+(i*w-s*Re+a*mt)*ne,N*ne,-(i*A-n*x+a*R)*ne,+(i*ue-n*me+a*Q)*ne,-(i*Y-n*Re+a*$e)*ne,k*ne,+(i*S-n*C+s*R)*ne,-(i*ke-n*$+s*Q)*ne,+(i*se-n*mt+s*$e)*ne,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new E(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return B.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const n=this._m,s=e.m,a=n[0],o=n[1],l=n[2],c=n[3],u=n[4],h=n[5],d=n[6],f=n[7],p=n[8],g=n[9],_=n[10],m=n[11],T=n[12],v=n[13],A=n[14],S=n[15],x=s[0],C=s[1],R=s[2],D=s[3],P=s[4],N=s[5],k=s[6],X=s[7],ne=s[8],ge=s[9],ue=s[10],ke=s[11],me=s[12],$=s[13],Q=s[14],w=s[15];return t[i]=a*x+o*P+l*ne+c*me,t[i+1]=a*C+o*N+l*ge+c*$,t[i+2]=a*R+o*k+l*ue+c*Q,t[i+3]=a*D+o*X+l*ke+c*w,t[i+4]=u*x+h*P+d*ne+f*me,t[i+5]=u*C+h*N+d*ge+f*$,t[i+6]=u*R+h*k+d*ue+f*Q,t[i+7]=u*D+h*X+d*ke+f*w,t[i+8]=p*x+g*P+_*ne+m*me,t[i+9]=p*C+g*N+_*ge+m*$,t[i+10]=p*R+g*k+_*ue+m*Q,t[i+11]=p*D+g*X+_*ke+m*w,t[i+12]=T*x+v*P+A*ne+S*me,t[i+13]=T*C+v*N+A*ge+S*$,t[i+14]=T*R+v*k+A*ue+S*Q,t[i+15]=T*D+v*X+A*ke+S*w,this}equals(e){if(!e)return!1;if((this._isIdentity||e._isIdentity)&&!this._isIdentityDirty&&!e._isIdentityDirty)return this._isIdentity&&e._isIdentity;const i=this.m,n=e.m;return i[0]===n[0]&&i[1]===n[1]&&i[2]===n[2]&&i[3]===n[3]&&i[4]===n[4]&&i[5]===n[5]&&i[6]===n[6]&&i[7]===n[7]&&i[8]===n[8]&&i[9]===n[9]&&i[10]===n[10]&&i[11]===n[11]&&i[12]===n[12]&&i[13]===n[13]&&i[14]===n[14]&&i[15]===n[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=Rr(this._m[0]);for(let t=1;t<16;t++)e=397*e^Rr(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new Be,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,n){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const s=this._m;if(i&&i.copyFromFloats(s[12],s[13],s[14]),(e=e||tt.Vector3[0]).x=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),e.y=Math.sqrt(s[4]*s[4]+s[5]*s[5]+s[6]*s[6]),e.z=Math.sqrt(s[8]*s[8]+s[9]*s[9]+s[10]*s[10]),n){const o=n.scaling.y<0?-1:1,l=n.scaling.z<0?-1:1;e.x*=n.scaling.x<0?-1:1,e.y*=o,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const a=1/e._x,o=1/e._y,l=1/e._z;B.FromValuesToRef(s[0]*a,s[1]*a,s[2]*a,0,s[4]*o,s[5]*o,s[6]*o,0,s[8]*l,s[9]*l,s[10]*l,0,0,0,0,1,tt.Matrix[0]),Be.FromRotationMatrixToRef(tt.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=4*e;return new Qt(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return B.TransposeToRef(this,e),e}transposeToRef(e){return B.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,n,s){if(e<0||e>3)return this;const a=4*e;return this._m[a+0]=t,this._m[a+1]=i,this._m[a+2]=n,this._m[a+3]=s,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=tt.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return B.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=tt.Vector3[0];if(!this.decompose(t))return B.IdentityToRef(e),e;const i=this._m,n=1/t._x,s=1/t._y,a=1/t._z;return B.FromValuesToRef(i[0]*n,i[1]*n,i[2]*n,0,i[4]*s,i[5]*s,i[6]*s,0,i[8]*a,i[9]*a,i[10]*a,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new B;return B.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let n=0;n<16;n++)i._m[n]=e[n+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,n){for(let s=0;s<16;s++)n._m[s]=e[s+t]*i;return n.markAsUpdated(),n}static get IdentityReadOnly(){return B._IdentityReadOnly}static FromValuesToRef(e,t,i,n,s,a,o,l,c,u,h,d,f,p,g,_,m){const T=m._m;T[0]=e,T[1]=t,T[2]=i,T[3]=n,T[4]=s,T[5]=a,T[6]=o,T[7]=l,T[8]=c,T[9]=u,T[10]=h,T[11]=d,T[12]=f,T[13]=p,T[14]=g,T[15]=_,m.markAsUpdated()}static FromValues(e,t,i,n,s,a,o,l,c,u,h,d,f,p,g,_){const m=new B,T=m._m;return T[0]=e,T[1]=t,T[2]=i,T[3]=n,T[4]=s,T[5]=a,T[6]=o,T[7]=l,T[8]=c,T[9]=u,T[10]=h,T[11]=d,T[12]=f,T[13]=p,T[14]=g,T[15]=_,m.markAsUpdated(),m}static Compose(e,t,i){const n=new B;return B.ComposeToRef(e,t,i,n),n}static ComposeToRef(e,t,i,n){const s=n._m,a=t._x,o=t._y,l=t._z,c=t._w,u=a+a,h=o+o,d=l+l,f=a*u,p=a*h,g=a*d,_=o*h,m=o*d,T=l*d,v=c*u,A=c*h,S=c*d,x=e._x,C=e._y,R=e._z;return s[0]=(1-(_+T))*x,s[1]=(p+S)*x,s[2]=(g-A)*x,s[3]=0,s[4]=(p-S)*C,s[5]=(1-(f+T))*C,s[6]=(m+v)*C,s[7]=0,s[8]=(g+A)*R,s[9]=(m-v)*R,s[10]=(1-(f+_))*R,s[11]=0,s[12]=i._x,s[13]=i._y,s[14]=i._z,s[15]=1,n.markAsUpdated(),n}static Identity(){const e=B.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return B.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=B.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new B;return B.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),n=Math.cos(e);return B.FromValuesToRef(1,0,0,0,0,n,i,0,0,-i,n,0,0,0,0,1,t),t._updateIdentityStatus(1===n&&0===i),t}static RotationY(e){const t=new B;return B.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),n=Math.cos(e);return B.FromValuesToRef(n,0,-i,0,0,1,0,0,i,0,n,0,0,0,0,1,t),t._updateIdentityStatus(1===n&&0===i),t}static RotationZ(e){const t=new B;return B.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),n=Math.cos(e);return B.FromValuesToRef(n,i,0,0,-i,n,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===n&&0===i),t}static RotationAxis(e,t){const i=new B;return B.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const n=Math.sin(-t),s=Math.cos(-t),a=1-s;e.normalize();const o=i._m;return o[0]=e._x*e._x*a+s,o[1]=e._x*e._y*a-e._z*n,o[2]=e._x*e._z*a+e._y*n,o[3]=0,o[4]=e._y*e._x*a+e._z*n,o[5]=e._y*e._y*a+s,o[6]=e._y*e._z*a-e._x*n,o[7]=0,o[8]=e._z*e._x*a-e._y*n,o[9]=e._z*e._y*a+e._x*n,o[10]=e._z*e._z*a+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i){const n=E.Dot(t,e),s=i._m;if(n<-1+kt)s[0]=-1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0;else{const a=E.Cross(t,e),o=1/(1+n);s[0]=a._x*a._x*o+n,s[1]=a._y*a._x*o-a._z,s[2]=a._z*a._x*o+a._y,s[3]=0,s[4]=a._x*a._y*o+a._z,s[5]=a._y*a._y*o+n,s[6]=a._z*a._y*o-a._x,s[7]=0,s[8]=a._x*a._z*o-a._y,s[9]=a._y*a._z*o+a._x,s[10]=a._z*a._z*o+n,s[11]=0}return s[12]=0,s[13]=0,s[14]=0,s[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const n=new B;return B.RotationYawPitchRollToRef(e,t,i,n),n}static RotationYawPitchRollToRef(e,t,i,n){return Be.RotationYawPitchRollToRef(e,t,i,tt.Quaternion[0]),tt.Quaternion[0].toRotationMatrix(n),n}static Scaling(e,t,i){const n=new B;return B.ScalingToRef(e,t,i,n),n}static ScalingToRef(e,t,i,n){return B.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,n),n._updateIdentityStatus(1===e&&1===t&&1===i),n}static Translation(e,t,i){const n=new B;return B.TranslationToRef(e,t,i,n),n}static TranslationToRef(e,t,i,n){return B.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,n),n._updateIdentityStatus(0===e&&0===t&&0===i),n}static Lerp(e,t,i){const n=new e.constructor;return B.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){const s=n._m,a=e.m,o=t.m;for(let l=0;l<16;l++)s[l]=a[l]*(1-i)+o[l]*i;return n.markAsUpdated(),n}static DecomposeLerp(e,t,i){const n=new e.constructor;return B.DecomposeLerpToRef(e,t,i,n),n}static DecomposeLerpToRef(e,t,i,n){const s=tt.Vector3[0],a=tt.Quaternion[0],o=tt.Vector3[1];e.decompose(s,a,o);const l=tt.Vector3[2],c=tt.Quaternion[1],u=tt.Vector3[3];t.decompose(l,c,u);const h=tt.Vector3[4];E.LerpToRef(s,l,i,h);const d=tt.Quaternion[2];Be.SlerpToRef(a,c,i,d);const f=tt.Vector3[5];return E.LerpToRef(o,u,i,f),B.ComposeToRef(h,d,f,n),n}static LookAtLH(e,t,i){const n=new B;return B.LookAtLHToRef(e,t,i,n),n}static LookAtLHToRef(e,t,i,n){const s=tt.Vector3[0],a=tt.Vector3[1],o=tt.Vector3[2];t.subtractToRef(e,o),o.normalize(),E.CrossToRef(i,o,s);const l=s.lengthSquared();0===l?s.x=1:s.normalizeFromLength(Math.sqrt(l)),E.CrossToRef(o,s,a),a.normalize();const c=-E.Dot(s,e),u=-E.Dot(a,e),h=-E.Dot(o,e);B.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,c,u,h,1,n)}static LookAtRH(e,t,i){const n=new B;return B.LookAtRHToRef(e,t,i,n),n}static LookAtRHToRef(e,t,i,n){const s=tt.Vector3[0],a=tt.Vector3[1],o=tt.Vector3[2];e.subtractToRef(t,o),o.normalize(),E.CrossToRef(i,o,s);const l=s.lengthSquared();0===l?s.x=1:s.normalizeFromLength(Math.sqrt(l)),E.CrossToRef(o,s,a),a.normalize();const c=-E.Dot(s,e),u=-E.Dot(a,e),h=-E.Dot(o,e);return B.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,c,u,h,1,n),n}static LookDirectionLH(e,t){const i=new B;return B.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const n=tt.Vector3[0];n.copyFrom(e),n.scaleInPlace(-1);const s=tt.Vector3[1];return E.CrossToRef(t,n,s),B.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,n._x,n._y,n._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new B;return B.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const n=tt.Vector3[2];return E.CrossToRef(t,e,n),B.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,n,s){const a=new B;return B.OrthoLHToRef(e,t,i,n,a,s),a}static OrthoLHToRef(e,t,i,n,s,a){const c=2/e,u=2/t,h=2/(n-i),d=-(n+i)/(n-i);return B.FromValuesToRef(c,0,0,0,0,u,0,0,0,0,h,0,0,0,d,1,s),a&&s.multiplyToRef(Do,s),s._updateIdentityStatus(1===c&&1===u&&1===h&&0===d),s}static OrthoOffCenterLH(e,t,i,n,s,a,o){const l=new B;return B.OrthoOffCenterLHToRef(e,t,i,n,s,a,l,o),l}static OrthoOffCenterLHToRef(e,t,i,n,s,a,o,l){return B.FromValuesToRef(2/(t-e),0,0,0,0,2/(n-i),0,0,0,0,2/(a-s),0,(e+t)/(e-t),(n+i)/(i-n),-(a+s)/(a-s),1,o),l&&o.multiplyToRef(Do,o),o.markAsUpdated(),o}static OrthoOffCenterRH(e,t,i,n,s,a,o){const l=new B;return B.OrthoOffCenterRHToRef(e,t,i,n,s,a,l,o),l}static OrthoOffCenterRHToRef(e,t,i,n,s,a,o,l){return B.OrthoOffCenterLHToRef(e,t,i,n,s,a,o,l),o._m[10]*=-1,o}static PerspectiveLH(e,t,i,n,s,a=0){const o=new B,u=2*i/e,h=2*i/t,d=(n+i)/(n-i),f=-2*n*i/(n-i),p=Math.tan(a);return B.FromValuesToRef(u,0,0,0,0,h,0,p,0,0,d,1,0,0,f,0,o),s&&o.multiplyToRef(Do,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,n,s,a=0,o=!1){const l=new B;return B.PerspectiveFovLHToRef(e,t,i,n,l,!0,s,a,o),l}static PerspectiveFovLHToRef(e,t,i,n,s,a=!0,o,l=0,c=!1){const u=i,h=n,d=1/Math.tan(.5*e),f=a?d/t:d,p=a?d:d*t,g=c&&0===u?-1:0!==h?(h+u)/(h-u):1,_=c&&0===u?2*h:0!==h?-2*h*u/(h-u):-2*u,m=Math.tan(l);return B.FromValuesToRef(f,0,0,0,0,p,0,m,0,0,g,1,0,0,_,0,s),o&&s.multiplyToRef(Do,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,i,n,s,a=!0,o,l=0){const c=1/Math.tan(.5*e),u=a?c/t:c,h=a?c:c*t,d=Math.tan(l);return B.FromValuesToRef(u,0,0,0,0,h,0,d,0,0,-i,1,0,0,1,0,s),o&&s.multiplyToRef(Do,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,i,n,s,a=0,o=!1){const l=new B;return B.PerspectiveFovRHToRef(e,t,i,n,l,!0,s,a,o),l}static PerspectiveFovRHToRef(e,t,i,n,s,a=!0,o,l=0,c=!1){const u=i,h=n,d=1/Math.tan(.5*e),f=a?d/t:d,p=a?d:d*t,g=c&&0===u?1:0!==h?-(h+u)/(h-u):-1,_=c&&0===u?2*h:0!==h?-2*h*u/(h-u):-2*u,m=Math.tan(l);return B.FromValuesToRef(f,0,0,0,0,p,0,m,0,0,g,-1,0,0,_,0,s),o&&s.multiplyToRef(Do,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,i,n,s,a=!0,o,l=0){const c=1/Math.tan(.5*e),u=a?c/t:c,h=a?c:c*t,d=Math.tan(l);return B.FromValuesToRef(u,0,0,0,0,h,0,d,0,0,-i,-1,0,0,-1,0,s),o&&s.multiplyToRef(Do,s),s._updateIdentityStatus(!1),s}static PerspectiveFovWebVRToRef(e,t,i,n,s=!1,a,o=0){const l=s?-1:1,c=Math.tan(e.upDegrees*Math.PI/180),u=Math.tan(e.downDegrees*Math.PI/180),h=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(h+d),p=2/(c+u),g=Math.tan(o),_=n._m;return _[0]=f,_[1]=_[2]=_[3]=_[4]=0,_[5]=p,_[6]=0,_[7]=g,_[8]=(h-d)*f*.5,_[9]=-(c-u)*p*.5,_[10]=-i/(t-i),_[11]=1*l,_[12]=_[13]=_[15]=0,_[14]=-2*i*t/(i-t),a&&n.multiplyToRef(Do,n),n.markAsUpdated(),n}static GetFinalMatrix(e,t,i,n,s,a){const o=e.width,l=e.height,h=B.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,a-s,0,e.x+o/2,l/2+e.y,s,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(n,d),d.multiplyToRef(h,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return bn.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return bn.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return B.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=t._m,n=e.m;return i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new B;return B.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,n=e.normal.y,s=e.normal.z,a=-2*i,o=-2*n,l=-2*s;return B.FromValuesToRef(a*i+1,o*i,l*i,0,a*n,o*n+1,l*n,0,a*s,o*s,l*s+1,0,a*e.d,o*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,n){return B.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,n),n}static FromQuaternionToRef(e,t){const i=e._x*e._x,n=e._y*e._y,s=e._z*e._z,a=e._x*e._y,o=e._z*e._w,l=e._z*e._x,c=e._y*e._w,u=e._y*e._z,h=e._x*e._w;return t._m[0]=1-2*(n+s),t._m[1]=2*(a+o),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(a-o),t._m[5]=1-2*(s+i),t._m[6]=2*(u+h),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(u-h),t._m[10]=1-2*(n+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}B._UpdateFlagSeed=0,B._IdentityReadOnly=B.Identity();class tt{}tt.Vector3=mn.BuildTuple(11,E.Zero),tt.Matrix=mn.BuildTuple(2,B.Identity),tt.Quaternion=mn.BuildTuple(3,Be.Zero);class z{}z.Vector2=mn.BuildTuple(3,We.Zero),z.Vector3=mn.BuildTuple(13,E.Zero),z.Vector4=mn.BuildTuple(3,Qt.Zero),z.Quaternion=mn.BuildTuple(2,Be.Zero),z.Matrix=mn.BuildTuple(8,B.Identity),ye("BABYLON.Vector2",We),ye("BABYLON.Vector3",E),ye("BABYLON.Vector4",Qt),ye("BABYLON.Matrix",B);const Do=B.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);class pl{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),pl._HandleParenthesisContent(i,t))):pl._HandleParenthesisContent(e,t))||"false"!==e&&pl.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(s=>"true"===s);const n=e.split("||");for(const s in n)if(Object.prototype.hasOwnProperty.call(n,s)){let a=pl._SimplifyNegation(n[s].trim());const o=a.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){const c=pl._SimplifyNegation(o[l].trim());if(i="true"!==c&&"false"!==c?"!"===c[0]?!t(c.substring(1)):t(c):"true"===c,!i){a="false";break}}if(i||"true"===a){i=!0;break}i="true"!==a&&"false"!==a?"!"===a[0]?!t(a.substring(1)):t(a):"true"===a}return i?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>"")).length%2?"!":"")).trim())?e="false":"!false"===e&&(e="true"),e}}class Gt{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Gt.HasTags(e),e.addTags=t=>Gt.AddTagsTo(e,t),e.removeTags=t=>Gt.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>Gt.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&!0===e._tags[n]&&i.push(n);return i.join(" ")}return e._tags}static AddTagsTo(e,t){t&&"string"==typeof t&&t.split(" ").forEach(function(n){Gt._AddTagTo(e,n)})}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(Gt.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!Gt.HasTags(e))return;const i=t.split(" ");for(const n in i)Gt._RemoveTagFrom(e,i[n])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?Gt.HasTags(e):pl.Eval(t,i=>Gt.HasTags(e)&&e._tags[i]))}}function ht(r){return`${r} needs to be imported before as it contains a side-effect required by your code.`}function Mc(r){return Math.pow(r,2.2)}function Dc(r){return r<=.04045?.0773993808*r:Math.pow(.947867299*(r+.055),2.4)}function Pc(r){return Math.pow(r,Sf)}function wc(r){return r<=.0031308?12.92*r:1.055*Math.pow(r,.41666)-.055}class Fe{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return Fe.FromArrayToRef(e,t,this),this}toColor4(e=1){return new ct(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new Fe(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new Fe(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=Se.Clamp(this.r,e,t),i.g=Se.Clamp(this.g,e,t),i.b=Se.Clamp(this.b,e,t),this}add(e){return new Fe(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new Fe(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new Fe(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+Se.ToHex(e)+Se.ToHex(t)+Se.ToHex(i)}toHSV(){const e=new Fe;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,n=this.b,s=Math.max(t,i,n),a=Math.min(t,i,n);let o=0,l=0;const c=s,u=s-a;0!==s&&(l=u/s),s!=a&&(s==t?(o=(i-n)/u,i<n&&(o+=6)):s==i?o=(n-t)/u+2:s==n&&(o=(t-i)/u+4),o*=60),e.r=o,e.g=l,e.b=c}toLinearSpace(e=!1){const t=new Fe;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Dc(this.r),e.g=Dc(this.g),e.b=Dc(this.b)):(e.r=Mc(this.r),e.g=Mc(this.g),e.b=Mc(this.b)),this}toGammaSpace(e=!1){const t=new Fe;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=wc(this.r),e.g=wc(this.g),e.b=wc(this.b)):(e.r=Pc(this.r),e.g=Pc(this.g),e.b=Pc(this.b)),this}static HSVtoRGBToRef(e,t,i,n){const s=i*t,a=e/60,o=s*(1-Math.abs(a%2-1));let l=0,c=0,u=0;a>=0&&a<=1?(l=s,c=o):a>=1&&a<=2?(l=o,c=s):a>=2&&a<=3?(c=s,u=o):a>=3&&a<=4?(c=o,u=s):a>=4&&a<=5?(l=o,u=s):a>=5&&a<=6&&(l=s,u=o);const h=i-s;n.set(l+h,c+h,u+h)}static FromHSV(e,t,i){const n=new Fe(0,0,0);return Fe.HSVtoRGBToRef(e,t,i,n),n}static FromHexString(e){if("#"!==e.substring(0,1)||7!==e.length)return new Fe(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16);return Fe.FromInts(t,i,n)}static FromArray(e,t=0){return new Fe(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new Fe(e/255,t/255,i/255)}static Lerp(e,t,i){const n=new Fe(0,0,0);return Fe.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,n,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a;return new Fe(e.r*l+i.r*c+t.r*u+n.r*h,e.g*l+i.g*c+t.g*u+n.g*h,e.b*l+i.b*c+t.b*u+n.b*h)}static Hermite1stDerivative(e,t,i,n,s){const a=Fe.Black();return this.Hermite1stDerivativeToRef(e,t,i,n,s,a),a}static Hermite1stDerivativeToRef(e,t,i,n,s,a){const o=s*s;a.r=6*(o-s)*e.r+(3*o-4*s+1)*t.r+6*(-o+s)*i.r+(3*o-2*s)*n.r,a.g=6*(o-s)*e.g+(3*o-4*s+1)*t.g+6*(-o+s)*i.g+(3*o-2*s)*n.g,a.b=6*(o-s)*e.b+(3*o-4*s+1)*t.b+6*(-o+s)*i.b+(3*o-2*s)*n.b}static Red(){return new Fe(1,0,0)}static Green(){return new Fe(0,1,0)}static Blue(){return new Fe(0,0,1)}static Black(){return new Fe(0,0,0)}static get BlackReadOnly(){return Fe._BlackReadOnly}static White(){return new Fe(1,1,1)}static Purple(){return new Fe(.5,0,.5)}static Magenta(){return new Fe(1,0,1)}static Yellow(){return new Fe(1,1,0)}static Gray(){return new Fe(.5,.5,.5)}static Teal(){return new Fe(0,1,1)}static Random(){return new Fe(Math.random(),Math.random(),Math.random())}}Fe._BlackReadOnly=Fe.Black();class ct{constructor(e=0,t=0,i=0,n=1){this.r=e,this.g=t,this.b=i,this.a=n}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return ct.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new ct(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new ct(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new ct(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=Se.Clamp(this.r,e,t),i.g=Se.Clamp(this.g,e,t),i.b=Se.Clamp(this.b,e,t),i.a=Se.Clamp(this.a,e,t),this}multiply(e){return new ct(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e=397*e^(255*this.a|0),e}clone(){return new ct(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,n){return this.r=e,this.g=t,this.b=i,this.a=n,this}set(e,t,i,n){return this.copyFromFloats(e,t,i,n)}toHexString(e=!1){const t=Math.round(255*this.r),i=Math.round(255*this.g),n=Math.round(255*this.b);if(e)return"#"+Se.ToHex(t)+Se.ToHex(i)+Se.ToHex(n);const s=Math.round(255*this.a);return"#"+Se.ToHex(t)+Se.ToHex(i)+Se.ToHex(n)+Se.ToHex(s)}toLinearSpace(e=!1){const t=new ct;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Dc(this.r),e.g=Dc(this.g),e.b=Dc(this.b)):(e.r=Mc(this.r),e.g=Mc(this.g),e.b=Mc(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new ct;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=wc(this.r),e.g=wc(this.g),e.b=wc(this.b)):(e.r=Pc(this.r),e.g=Pc(this.g),e.b=Pc(this.b)),e.a=this.a,this}static FromHexString(e){if("#"!==e.substring(0,1)||9!==e.length&&7!==e.length)return new ct(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),s=9===e.length?parseInt(e.substring(7,9),16):255;return ct.FromInts(t,i,n,s)}static Lerp(e,t,i){const n=new ct(0,0,0,0);return ct.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i,n.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,n,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a;return new ct(e.r*l+i.r*c+t.r*u+n.r*h,e.g*l+i.g*c+t.g*u+n.g*h,e.b*l+i.b*c+t.b*u+n.b*h,e.a*l+i.a*c+t.a*u+n.a*h)}static Hermite1stDerivative(e,t,i,n,s){const a=new ct;return this.Hermite1stDerivativeToRef(e,t,i,n,s,a),a}static Hermite1stDerivativeToRef(e,t,i,n,s,a){const o=s*s;a.r=6*(o-s)*e.r+(3*o-4*s+1)*t.r+6*(-o+s)*i.r+(3*o-2*s)*n.r,a.g=6*(o-s)*e.g+(3*o-4*s+1)*t.g+6*(-o+s)*i.g+(3*o-2*s)*n.g,a.b=6*(o-s)*e.b+(3*o-4*s+1)*t.b+6*(-o+s)*i.b+(3*o-2*s)*n.b,a.a=6*(o-s)*e.a+(3*o-4*s+1)*t.a+6*(-o+s)*i.a+(3*o-2*s)*n.a}static FromColor3(e,t=1){return new ct(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new ct(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,n){return new ct(e/255,t/255,i/255,n/255)}static CheckColors4(e,t){if(e.length===3*t){const i=[];for(let n=0;n<e.length;n+=3){const s=n/3*4;i[s]=e[n],i[s+1]=e[n+1],i[s+2]=e[n+2],i[s+3]=1}return i}return e}}class ei{}ei.Color3=mn.BuildArray(3,Fe.Black),ei.Color4=mn.BuildArray(3,()=>new ct(0,0,0,0)),ye("BABYLON.Color3",Fe),ye("BABYLON.Color4",ct);const Af={},yf={},Nb=function(r,e,t){const i=r();Gt&&Gt.HasTags(e)&&Gt.AddTagsTo(i,Gt.GetTags(e,!0));const n=Ym(i);for(const s in n){const o=e[s],l=n[s].type;if(null!=o&&("uniqueId"!==s||lt.AllowLoadingUniqueId))switch(l){case 0:case 6:case 11:i[s]=o;break;case 1:i[s]=t||o.isRenderTarget?o:o.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[s]=t?o:o.clone()}}return i};function Ym(r){const e=r.getClassName();if(yf[e])return yf[e];yf[e]={};const t=yf[e];let i=r,n=e;for(;n;){const s=Af[n];for(const l in s)t[l]=s[l];let a,o=!1;do{if(a=Object.getPrototypeOf(i),!a.getClassName){o=!0;break}if(a.getClassName()!==n)break;i=a}while(a);if(o)break;n=a.getClassName(),i=a}return t}function rs(r,e){return(t,i)=>{const n=function sz(r){const e=r.getClassName();return Af[e]||(Af[e]={}),Af[e]}(t);n[i]||(n[i]={type:r,sourceName:e})}}function ee(r,e=null){return function az(r,e=null){return(t,i)=>{const n=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[n]},set:function(s){"function"==typeof this.equals&&this.equals(s)||this[n]!==s&&(this[n]=s,t[r].apply(this))},enumerable:!0,configurable:!0})}}(r,e)}function O(r){return rs(0,r)}function Bt(r){return rs(1,r)}function cn(r){return rs(2,r)}function lh(r){return rs(3,r)}function Lb(r){return rs(4,r)}function Mr(r){return rs(5,r)}function Bb(r){return rs(6,r)}function jm(r){return rs(8,r)}function Ub(r){return rs(9,r)}let lt=(()=>{class r{static AppendSerializedAnimations(t,i){if(t.animations){i.animations=[];for(let n=0;n<t.animations.length;n++)i.animations.push(t.animations[n].serialize())}}static Serialize(t,i){i||(i={}),Gt&&(i.tags=Gt.GetTags(t));const n=Ym(t);for(const s in n){const a=n[s],o=a.sourceName||s,l=a.type,c=t[s];if(null!=c&&("uniqueId"!==s||r.AllowLoadingUniqueId))switch(l){case 0:i[o]=c;break;case 1:case 3:case 7:case 9:i[o]=c.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:i[o]=c.asArray();break;case 6:case 11:i[o]=c.id}}return i}static ParseProperties(t,i,n,s){s||(s="");const a=Ym(i);for(const o in a){const l=a[o],c=t[l.sourceName||o],u=l.type;if(null!=c&&("uniqueId"!==o||r.AllowLoadingUniqueId)){const h=i;switch(u){case 0:h[o]=c;break;case 1:n&&(h[o]=r._TextureParser(c,n,s));break;case 2:h[o]=Fe.FromArray(c);break;case 3:h[o]=r._FresnelParametersParser(c);break;case 4:h[o]=We.FromArray(c);break;case 5:h[o]=E.FromArray(c);break;case 6:n&&(h[o]=n.getLastMeshById(c));break;case 7:h[o]=r._ColorCurvesParser(c);break;case 8:h[o]=ct.FromArray(c);break;case 9:h[o]=r._ImageProcessingConfigurationParser(c);break;case 10:h[o]=Be.FromArray(c);break;case 11:n&&(h[o]=n.getCameraById(c));break;case 12:h[o]=B.FromArray(c)}}}}static Parse(t,i,n,s=null){const a=t();return Gt&&Gt.AddTagsTo(a,i.tags),r.ParseProperties(i,a,n,s),a}static Clone(t,i){return Nb(t,i,!1)}static Instanciate(t,i){return Nb(t,i,!0)}}return r.AllowLoadingUniqueId=!1,r._ImageProcessingConfigurationParser=e=>{throw ht("ImageProcessingConfiguration")},r._FresnelParametersParser=e=>{throw ht("FresnelParameters")},r._ColorCurvesParser=e=>{throw ht("ColorCurves")},r._TextureParser=(e,t,i)=>{throw ht("Texture")},r})();function Po(r,e,t,i){const n=t.value;t.value=(...s)=>{let a=n;if("undefined"!=typeof _native&&_native[e]){const o=_native[e];a=i?(...l)=>i(...l)?o(...l):n(...l):o}return r[e]=a,a(...s)}}Po.filter=function(r){return(e,t,i)=>Po(e,t,i,r)};class bf{static extractMinAndMaxIndexed(e,t,i,n,s,a){for(let o=i;o<i+n;o++){const l=3*t[o],c=e[l],u=e[l+1],h=e[l+2];s.minimizeInPlaceFromFloats(c,u,h),a.maximizeInPlaceFromFloats(c,u,h)}}static extractMinAndMax(e,t,i,n,s,a){for(let o=t,l=t*n;o<t+i;o++,l+=n){const c=e[l],u=e[l+1],h=e[l+2];s.minimizeInPlaceFromFloats(c,u,h),a.maximizeInPlaceFromFloats(c,u,h)}}}function Vb(r,e,t,i=null,n){const s=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),bf.extractMinAndMax(r,e,t,n,s,a),i&&(s.x-=s.x*i.x+i.y,s.y-=s.y*i.x+i.y,s.z-=s.z*i.x+i.y,a.x+=a.x*i.x+i.y,a.y+=a.y*i.x+i.y,a.z+=a.z*i.x+i.y),{minimum:s,maximum:a}}b([Po.filter((...[r,e])=>!Array.isArray(r)&&!Array.isArray(e))],bf,"extractMinAndMaxIndexed",null),b([Po.filter((...[r])=>!Array.isArray(r))],bf,"extractMinAndMax",null);var Yt=(()=>{return(r=Yt||(Yt={}))[r.LOCAL=0]="LOCAL",r[r.WORLD=1]="WORLD",r[r.BONE=2]="BONE",Yt;var r})();class wo{}wo.X=new E(1,0,0),wo.Y=new E(0,1,0),wo.Z=new E(0,0,1);var Oo=(()=>{return(r=Oo||(Oo={}))[r.X=0]="X",r[r.Y=1]="Y",r[r.Z=2]="Z",Oo;var r})();class ss{constructor(e,t,i,n){this.normal=new E(e,t,i),this.d=n}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new ss(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^(0|this.d),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=ss._TmpMatrix;e.invertToRef(t);const i=t.m,n=this.normal.x,s=this.normal.y,a=this.normal.z,o=this.d;return new ss(n*i[0]+s*i[1]+a*i[2]+o*i[3],n*i[4]+s*i[5]+a*i[6]+o*i[7],n*i[8]+s*i[9]+a*i[10]+o*i[11],n*i[12]+s*i[13]+a*i[14]+o*i[15])}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const n=t.x-e.x,s=t.y-e.y,a=t.z-e.z,o=i.x-e.x,l=i.y-e.y,c=i.z-e.z,u=s*c-a*l,h=a*o-n*c,d=n*l-s*o,f=Math.sqrt(u*u+h*h+d*d);let p;return p=0!==f?1/f:0,this.normal.x=u*p,this.normal.y=h*p,this.normal.z=d*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return E.Dot(this.normal,e)<=t}signedDistanceTo(e){return E.Dot(e,this.normal)+this.d}static FromArray(e){return new ss(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const n=new ss(0,0,0,0);return n.copyFromPoints(e,t,i),n}static FromPositionAndNormal(e,t){const i=new ss(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const n=-(t.x*e.x+t.y*e.y+t.z*e.z);return E.Dot(i,t)+n}}ss._TmpMatrix=B.Identity();class as{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new ss(0,0,0,0));return as.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){as.GetNearPlaneToRef(e,t[0]),as.GetFarPlaneToRef(e,t[1]),as.GetLeftPlaneToRef(e,t[2]),as.GetRightPlaneToRef(e,t[3]),as.GetTopPlaneToRef(e,t[4]),as.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}var gl=(()=>{return(r=gl||(gl={}))[r.CW=0]="CW",r[r.CCW=1]="CCW",gl;var r})();class Fo{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),n=Math.atan2(i.y,i.x);return new Fo(n)}static FromRadians(e){return new Fo(e)}static FromDegrees(e){return new Fo(e*Math.PI/180)}}class dz{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const n=Math.pow(t.x,2)+Math.pow(t.y,2),s=(Math.pow(e.x,2)+Math.pow(e.y,2)-n)/2,a=(n-Math.pow(i.x,2)-Math.pow(i.y,2))/2,o=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new We((s*(t.y-i.y)-a*(e.y-t.y))/o,((e.x-t.x)*a-(t.x-i.x)*s)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=Fo.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let c=Fo.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),u=Fo.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-l>180&&(c-=360),c-l<-180&&(c+=360),u-c>180&&(u-=360),u-c<-180&&(u+=360),this.orientation=c-l<0?gl.CW:gl.CCW,this.angle=Fo.FromDegrees(this.orientation===gl.CW?l-u:u-l)}}class $m{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new We(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new We(e,t),n=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(n).length(),this}addArcTo(e,t,i,n,s=36){if(this.closed)return this;const a=this._points[this._points.length-1],o=new We(e,t),l=new We(i,n),c=new dz(a,o,l);let u=c.angle.radians()/s;c.orientation===gl.CW&&(u*=-1);let h=c.startAngle.radians()+u;for(let d=0;d<s;d++){const f=Math.cos(h)*c.radius+c.centerPoint.x,p=Math.sin(h)*c.radius+c.centerPoint.y;this.addLineTo(f,p),h+=u}return this}close(){return this.closed=!0,this}length(){let e=this._length;return this.closed&&(e+=this._points[0].subtract(this._points[this._points.length-1]).length()),e}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return We.Zero();const t=e*this.length();let i=0;for(let n=0;n<this._points.length;n++){const a=this._points[n],l=this._points[(n+1)%this._points.length].subtract(a),c=l.length()+i;if(t>=i&&t<=c){const u=l.normalize(),h=t-i;return new We(a.x+u.x*h,a.y+u.y*h)}i=c}return We.Zero()}static StartingAt(e,t){return new $m(e,t)}}class ch{constructor(e,t=null,i,n=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:E.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:B.Identity()};for(let s=0;s<e.length;s++)this._curve[s]=e[s].clone();this._raw=i||!1,this._alignTangentsWithPath=n,this._compute(t,n)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?E.TransformCoordinates(E.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?E.TransformCoordinates(E.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?E.TransformCoordinates(E.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let n=0;n<this._curve.length-1;n++){const s=this._curve[n+0],a=this._curve[n+1].subtract(s).normalize(),o=this._distances[n+1]-this._distances[n+0],l=Math.min(Math.max(E.Dot(a,e.subtract(s).normalize()),0)*E.Distance(s,e)/o,1),c=E.Distance(s.add(a.scale(l*o)),e);c<t&&(t=c,i=(this._distances[n+0]+o*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1- -1*e%1),t<0&&(t=1- -1*t%1),e>t){const c=e;e=t,t=c}const i=this.getCurve(),n=this.getPointAt(e);let s=this.getPreviousPointIndexAt(e);const a=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,l=[];return 0!==e&&(s++,l.push(n)),l.push(...i.slice(s,o)),(1!==t||1===e)&&l.push(a),new ch(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let n=0;n<e.length;n++)this._curve[n].x=e[n].x,this._curve[n].y=e[n].y,this._curve[n].z=e[n].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const n=this._tangents[0],s=this._normalVector(n,e);let a,o,l,c,u;this._normals[0]=s,this._raw||this._normals[0].normalize(),this._binormals[0]=E.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let h=1;h<i;h++)a=this._getLastNonNullVector(h),h<i-1&&(o=this._getFirstNonNullVector(h),this._tangents[h]=t?o:a.add(o),this._tangents[h].normalize()),this._distances[h]=this._distances[h-1]+this._curve[h].subtract(this._curve[h-1]).length(),l=this._tangents[h],u=this._binormals[h-1],this._normals[h]=E.Cross(u,l),this._raw||(0===this._normals[h].length()?(c=this._normals[h-1],this._normals[h]=c.clone()):this._normals[h].normalize()),this._binormals[h]=E.Cross(l,this._normals[h]),this._raw||this._binormals[h].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;0===i.length()&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;0===i.length()&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,n=e.length();if(0===n&&(n=1),null==t){let s;s=Se.WithinEpsilon(Math.abs(e.y)/n,1,kt)?Se.WithinEpsilon(Math.abs(e.x)/n,1,kt)?Se.WithinEpsilon(Math.abs(e.z)/n,1,kt)?E.Zero():new E(0,0,1):new E(1,0,0):new E(0,-1,0),i=E.Cross(e,s)}else i=E.Cross(e,t),E.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let s,n=i[0],a=0;const o=e*this.length();for(let l=1;l<i.length;l++){s=i[l];const c=E.Distance(n,s);if(a+=c,a===o)return this._setPointAtData(e,1,s,l,t);if(a>o){const h=(a-o)/c,d=n.subtract(s),f=s.add(d.scaleInPlace(h));return this._setPointAtData(e,1-h,f,l-1,t)}n=s}return this._pointAtData}_setPointAtData(e,t,i,n,s){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=n,this._pointAtData.interpolateReady=s,s&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=B.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),n=this._normals[e].clone(),s=this._binormals[e].clone(),a=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),c=Be.RotationQuaternionFromAxis(n,s,i),u=Be.RotationQuaternionFromAxis(o,l,a);Be.Slerp(c,u,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class os{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^(0|this.height),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new os(this.width*e,this.height*t)}clone(){return new os(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new os(0,0)}add(e){return new os(this.width+e.width,this.height+e.height)}subtract(e){return new os(this.width-e.width,this.height-e.height)}static Lerp(e,t,i){return new os(e.width+(t.width-e.width)*i,e.height+(t.height-e.height)*i)}}class uh{constructor(e,t,i,n){this.x=e,this.y=t,this.width=i,this.height=n}toGlobal(e,t){return new uh(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new uh(this.x,this.y,this.width,this.height)}}const Sa=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],fz=[()=>1,r=>r.y,r=>r.z,r=>r.x,r=>r.x*r.y,r=>r.y*r.z,r=>3*r.z*r.z-1,r=>r.x*r.z,r=>r.x*r.x-r.y*r.y],$a=(r,e)=>Sa[r]*fz[r](e),Ka=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class hh{constructor(){this.preScaled=!1,this.l00=E.Zero(),this.l1_1=E.Zero(),this.l10=E.Zero(),this.l11=E.Zero(),this.l2_2=E.Zero(),this.l2_1=E.Zero(),this.l20=E.Zero(),this.l21=E.Zero(),this.l22=E.Zero()}addLight(e,t,i){z.Vector3[0].set(t.r,t.g,t.b);const s=z.Vector3[1];z.Vector3[0].scaleToRef(i,s),s.scaleToRef($a(0,e),z.Vector3[2]),this.l00.addInPlace(z.Vector3[2]),s.scaleToRef($a(1,e),z.Vector3[2]),this.l1_1.addInPlace(z.Vector3[2]),s.scaleToRef($a(2,e),z.Vector3[2]),this.l10.addInPlace(z.Vector3[2]),s.scaleToRef($a(3,e),z.Vector3[2]),this.l11.addInPlace(z.Vector3[2]),s.scaleToRef($a(4,e),z.Vector3[2]),this.l2_2.addInPlace(z.Vector3[2]),s.scaleToRef($a(5,e),z.Vector3[2]),this.l2_1.addInPlace(z.Vector3[2]),s.scaleToRef($a(6,e),z.Vector3[2]),this.l20.addInPlace(z.Vector3[2]),s.scaleToRef($a(7,e),z.Vector3[2]),this.l21.addInPlace(z.Vector3[2]),s.scaleToRef($a(8,e),z.Vector3[2]),this.l22.addInPlace(z.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(Ka[0]),this.l1_1.scaleInPlace(Ka[1]),this.l10.scaleInPlace(Ka[2]),this.l11.scaleInPlace(Ka[3]),this.l2_2.scaleInPlace(Ka[4]),this.l2_1.scaleInPlace(Ka[5]),this.l20.scaleInPlace(Ka[6]),this.l21.scaleInPlace(Ka[7]),this.l22.scaleInPlace(Ka[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Sa[0]),this.l1_1.scaleInPlace(Sa[1]),this.l10.scaleInPlace(Sa[2]),this.l11.scaleInPlace(Sa[3]),this.l2_2.scaleInPlace(Sa[4]),this.l2_1.scaleInPlace(Sa[5]),this.l20.scaleInPlace(Sa[6]),this.l21.scaleInPlace(Sa[7]),this.l22.scaleInPlace(Sa[8])}updateFromArray(e){return E.FromArrayToRef(e[0],0,this.l00),E.FromArrayToRef(e[1],0,this.l1_1),E.FromArrayToRef(e[2],0,this.l10),E.FromArrayToRef(e[3],0,this.l11),E.FromArrayToRef(e[4],0,this.l2_2),E.FromArrayToRef(e[5],0,this.l2_1),E.FromArrayToRef(e[6],0,this.l20),E.FromArrayToRef(e[7],0,this.l21),E.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return E.FromFloatsToRef(e[0],e[1],e[2],this.l00),E.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),E.FromFloatsToRef(e[6],e[7],e[8],this.l10),E.FromFloatsToRef(e[9],e[10],e[11],this.l11),E.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),E.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),E.FromFloatsToRef(e[18],e[19],e[20],this.l20),E.FromFloatsToRef(e[21],e[22],e[23],this.l21),E.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new hh).updateFromArray(e)}static FromPolynomial(e){const t=new hh;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class _l{constructor(){this.x=E.Zero(),this.y=E.Zero(),this.z=E.Zero(),this.xx=E.Zero(),this.yy=E.Zero(),this.zz=E.Zero(),this.xy=E.Zero(),this.yz=E.Zero(),this.zx=E.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=hh.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){z.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=z.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),z.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),z.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(z.Vector3[0]).addInPlace(z.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(z.Vector3[0]).subtractInPlace(z.Vector3[1]),this.zz.copyFrom(e.l00),z.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(z.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new _l).updateFromHarmonics(e)}static FromArray(e){const t=new _l;return E.FromArrayToRef(e[0],0,t.x),E.FromArrayToRef(e[1],0,t.y),E.FromArrayToRef(e[2],0,t.z),E.FromArrayToRef(e[3],0,t.xx),E.FromArrayToRef(e[4],0,t.yy),E.FromArrayToRef(e[5],0,t.zz),E.FromArrayToRef(e[6],0,t.yz),E.FromArrayToRef(e[7],0,t.zx),E.FromArrayToRef(e[8],0,t.xy),t}}var Cf=(()=>{return(r=Cf||(Cf={}))[r.NONE=0]="NONE",r[r.STEP=1]="STEP",Cf;var r})();class Oc{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new Oc(this.name,this.from,this.to)}}class pz{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new J,this._onClonedObservable=new J}}class $i{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,n){const s=this._NodeConstructors[e];return s?s(t,i,n):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&null!=this._parentNode._children){const i=this._parentNode._children.indexOf(this);-1!==i&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&(null==this._parentNode._children&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes;e[this._nodeDataStorage._sceneRootNodesIndex]=e[e.length-1],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new pz,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new J,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=B.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new J,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||Je.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let n=0;n<this._children.length;n++){const s=this._children[n];(!i||i(s))&&e.push(s),t||s._getDescendants(e,!1,i)}}getDescendants(e,t){const i=new Array;return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,n=>(!t||t(n))&&void 0!==n.cullingStrategy),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e)return void(this._nodeDataStorage._isReady=!1);this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=$i._AnimationRangeFactory(e,t,i);for(let n=0,s=this.animations.length;n<s;n++)this.animations[n]&&this.animations[n].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,n=this.animations.length;i<n;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,n){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,n):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const n={};n.name=t,n.from=i.from,n.to=i.to,e.push(n)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=B.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const n of i)n.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let n=0;n<t.ranges.length;n++){const s=t.ranges[n];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,n;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const s=this;if(s.getBoundingInfo&&s.subMeshes){const a=s.getBoundingInfo();i=a.boundingBox.minimumWorld.clone(),n=a.boundingBox.maximumWorld.clone()}else i=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const a=this.getDescendants(!1);for(const o of a){const l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||0===l.getTotalVertices())continue;const u=l.getBoundingInfo().boundingBox,d=u.maximumWorld;E.CheckExtends(u.minimumWorld,i,n),E.CheckExtends(d,i,n)}}return{min:i,max:n}}}$i._AnimationRangeFactory=(r,e,t)=>{throw ht("AnimationRange")},$i._NodeConstructors={},b([O()],$i.prototype,"name",void 0),b([O()],$i.prototype,"id",void 0),b([O()],$i.prototype,"uniqueId",void 0),b([O()],$i.prototype,"state",void 0),b([O()],$i.prototype,"metadata",void 0);class Kn{constructor(){this._xhr=function gz(){return"undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Kn.CustomRequestHeaders){const t=Kn.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Kn.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Kn.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of Kn.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Kn.CustomRequestHeaders={},Kn.CustomRequestModifiers=new Array,Kn.SkipRequestModificationForBabylonCDN=!0;class Me{static _PrepareAnimation(e,t,i,n,s,a,o,l){let c;if(!isNaN(parseFloat(s))&&isFinite(s)?c=Me.ANIMATIONTYPE_FLOAT:s instanceof Be?c=Me.ANIMATIONTYPE_QUATERNION:s instanceof E?c=Me.ANIMATIONTYPE_VECTOR3:s instanceof We?c=Me.ANIMATIONTYPE_VECTOR2:s instanceof Fe?c=Me.ANIMATIONTYPE_COLOR3:s instanceof ct?c=Me.ANIMATIONTYPE_COLOR4:s instanceof os&&(c=Me.ANIMATIONTYPE_SIZE),null==c)return null;const u=new Me(e,t,i,c,o);return u.setKeys([{frame:0,value:s},{frame:n,value:a}]),void 0!==l&&u.setEasingFunction(l),u}static CreateAnimation(e,t,i,n){const s=new Me(e+"Animation",e,i,t,Me.ANIMATIONLOOPMODE_CONSTANT);return s.setEasingFunction(n),s}static CreateAndStartAnimation(e,t,i,n,s,a,o,l,c,u,h){const d=Me._PrepareAnimation(e,i,n,s,a,o,l,c);return d&&(t.getScene&&(h=t.getScene()),h)?h.beginDirectAnimation(t,[d],0,s,1===d.loopMode,1,u):null}static CreateAndStartHierarchyAnimation(e,t,i,n,s,a,o,l,c,u,h){const d=Me._PrepareAnimation(e,n,s,a,o,l,c,u);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,a,1===d.loopMode,1,h):null}static CreateMergeAndStartAnimation(e,t,i,n,s,a,o,l,c,u){const h=Me._PrepareAnimation(e,i,n,s,a,o,l,c);return h?(t.animations.push(h),t.getScene().beginAnimation(t,0,s,1===h.loopMode,1,u)):null}static MakeAnimationAdditive(e,t=0,i,n=!1,s){let a=e;if(n&&(a=e.clone(),a.name=s||a.name),!a._keys.length)return a;t=t>=0?t:0;let o=0;const l=a._keys[0];let c=a._keys.length-1;const u=a._keys[c],h={referenceValue:l.value,referencePosition:z.Vector3[0],referenceQuaternion:z.Quaternion[0],referenceScaling:z.Vector3[1],keyPosition:z.Vector3[2],keyQuaternion:z.Quaternion[1],keyScaling:z.Vector3[3]};let d=!1,f=l.frame,p=u.frame;if(i){const T=a.getRange(i);T&&(f=T.from,p=T.to)}let g=l.frame===f,_=u.frame===p;if(1===a._keys.length){const T=a._getKeyValue(a._keys[0]);h.referenceValue=T.clone?T.clone():T,d=!0}else if(t<=l.frame){const T=a._getKeyValue(l.value);h.referenceValue=T.clone?T.clone():T,d=!0}else if(t>=u.frame){const T=a._getKeyValue(u.value);h.referenceValue=T.clone?T.clone():T,d=!0}let m=0;for(;!d||!g||!_&&m<a._keys.length-1;){const T=a._keys[m],v=a._keys[m+1];if(!d&&t>=T.frame&&t<=v.frame){let A;A=t===T.frame?a._getKeyValue(T.value):t===v.frame?a._getKeyValue(v.value):a._interpolate(t,{key:m,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT}),h.referenceValue=A.clone?A.clone():A,d=!0}if(!g&&f>=T.frame&&f<=v.frame){if(f===T.frame)o=m;else if(f===v.frame)o=m+1;else{const S=a._interpolate(f,{key:m,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT}),x={frame:f,value:S.clone?S.clone():S};a._keys.splice(m+1,0,x),o=m+1}g=!0}if(!_&&p>=T.frame&&p<=v.frame){if(p===T.frame)c=m;else if(p===v.frame)c=m+1;else{const S=a._interpolate(p,{key:m,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT}),x={frame:p,value:S.clone?S.clone():S};a._keys.splice(m+1,0,x),c=m+1}_=!0}m++}for(a.dataType===Me.ANIMATIONTYPE_QUATERNION?h.referenceValue.normalize().conjugateInPlace():a.dataType===Me.ANIMATIONTYPE_MATRIX&&(h.referenceValue.decompose(h.referenceScaling,h.referenceQuaternion,h.referencePosition),h.referenceQuaternion.normalize().conjugateInPlace()),m=o;m<=c;m++){const T=a._keys[m];if(!m||a.dataType===Me.ANIMATIONTYPE_FLOAT||T.value!==l.value)switch(a.dataType){case Me.ANIMATIONTYPE_MATRIX:T.value.decompose(h.keyScaling,h.keyQuaternion,h.keyPosition),h.keyPosition.subtractInPlace(h.referencePosition),h.keyScaling.divideInPlace(h.referenceScaling),h.referenceQuaternion.multiplyToRef(h.keyQuaternion,h.keyQuaternion),B.ComposeToRef(h.keyScaling,h.keyQuaternion,h.keyPosition,T.value);break;case Me.ANIMATIONTYPE_QUATERNION:h.referenceValue.multiplyToRef(T.value,T.value);break;case Me.ANIMATIONTYPE_VECTOR2:case Me.ANIMATIONTYPE_VECTOR3:case Me.ANIMATIONTYPE_COLOR3:case Me.ANIMATIONTYPE_COLOR4:T.value.subtractToRef(h.referenceValue,T.value);break;case Me.ANIMATIONTYPE_SIZE:T.value.width-=h.referenceValue.width,T.value.height-=h.referenceValue.height;break;default:T.value-=h.referenceValue}}return a}static TransitionTo(e,t,i,n,s,a,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;const c=s*(o/1e3);a.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(a);const u=n.beginAnimation(i,0,c,!1);return u.onAnimationEnd=l,u}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,n,s,a){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=n,this.loopMode=s,this.enableBlending=a,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=n,this.loopMode=void 0===s?Me.ANIMATIONLOOPMODE_CYCLE:s,this.uniqueId=Me._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const n in this._ranges)i&&(t+=", ",i=!1),t+=n;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new Oc(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const n=i.from,s=i.to;for(let a=this._keys.length-1;a>=0;a--)this._keys[a].frame>=n&&this._keys[a].frame<=s&&this._keys.splice(a,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return Se.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,n,s){return Se.Hermite(e,t,i,n,s)}quaternionInterpolateFunction(e,t,i){return Be.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,n,s){return Be.Hermite(e,t,i,n,s).normalize()}vector3InterpolateFunction(e,t,i){return E.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,n,s){return E.Hermite(e,t,i,n,s)}vector2InterpolateFunction(e,t,i){return We.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,n,s){return We.Hermite(e,t,i,n,s)}sizeInterpolateFunction(e,t,i){return os.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return Fe.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,n,s){return Fe.Hermite(e,t,i,n,s)}color4InterpolateFunction(e,t,i){return ct.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,n,s){return ct.Hermite(e,t,i,n,s)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:Me.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,t){if(t.loopMode===Me.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,n=i.length;let s=t.key;for(;s>=0&&e<i[s].frame;)--s;for(;s+1<=n-1&&e>=i[s+1].frame;)++s;if(t.key=s,s<0)return this._getKeyValue(i[0].value);if(s+1>n-1)return this._getKeyValue(i[n-1].value);const a=i[s],o=i[s+1],l=this._getKeyValue(a.value),c=this._getKeyValue(o.value);if(a.interpolation===Cf.STEP)return o.frame>e?l:c;const u=void 0!==a.outTangent&&void 0!==o.inTangent,h=o.frame-a.frame;let d=(e-a.frame)/h;const f=this.getEasingFunction();switch(null!==f&&(d=f.ease(d)),this.dataType){case Me.ANIMATIONTYPE_FLOAT:{const p=u?this.floatInterpolateFunctionWithTangents(l,a.outTangent*h,c,o.inTangent*h,d):this.floatInterpolateFunction(l,c,d);switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return p;case Me.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+p}break}case Me.ANIMATIONTYPE_QUATERNION:{const p=u?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.quaternionInterpolateFunction(l,c,d);switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return p;case Me.ANIMATIONLOOPMODE_RELATIVE:return p.addInPlace(t.offsetValue.scale(t.repeatCount))}return p}case Me.ANIMATIONTYPE_VECTOR3:{const p=u?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.vector3InterpolateFunction(l,c,d);switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return p;case Me.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case Me.ANIMATIONTYPE_VECTOR2:{const p=u?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.vector2InterpolateFunction(l,c,d);switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return p;case Me.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case Me.ANIMATIONTYPE_SIZE:switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(l,c,d);case Me.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,c,d).add(t.offsetValue.scale(t.repeatCount))}break;case Me.ANIMATIONTYPE_COLOR3:{const p=u?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.color3InterpolateFunction(l,c,d);switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return p;case Me.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case Me.ANIMATIONTYPE_COLOR4:{const p=u?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.color4InterpolateFunction(l,c,d);switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return p;case Me.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case Me.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case Me.ANIMATIONLOOPMODE_CYCLE:case Me.ANIMATIONLOOPMODE_CONSTANT:return Me.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,c,d,t.workValue):l;case Me.ANIMATIONLOOPMODE_RELATIVE:return l}}return 0}matrixInterpolateFunction(e,t,i,n){return Me.AllowMatrixDecomposeForInterpolation?n?(B.DecomposeLerpToRef(e,t,i,n),n):B.DecomposeLerp(e,t,i):n?(B.LerpToRef(e,t,i,n),n):B.Lerp(e,t,i)}clone(){const e=new Me(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];!i||(e._ranges[t]=i.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let n=0;n<i.length;n++){const s=i[n],a={};switch(a.frame=s.frame,t){case Me.ANIMATIONTYPE_FLOAT:a.values=[s.value],void 0!==s.inTangent&&a.values.push(s.inTangent),void 0!==s.outTangent&&(void 0===s.inTangent&&a.values.push(void 0),a.values.push(s.outTangent)),void 0!==s.interpolation&&(void 0===s.inTangent&&a.values.push(void 0),void 0===s.outTangent&&a.values.push(void 0),a.values.push(s.interpolation));break;case Me.ANIMATIONTYPE_QUATERNION:case Me.ANIMATIONTYPE_MATRIX:case Me.ANIMATIONTYPE_VECTOR3:case Me.ANIMATIONTYPE_COLOR3:case Me.ANIMATIONTYPE_COLOR4:a.values=s.value.asArray(),null!=s.inTangent&&a.values.push(s.inTangent.asArray()),null!=s.outTangent&&(void 0===s.inTangent&&a.values.push(void 0),a.values.push(s.outTangent.asArray())),void 0!==s.interpolation&&(void 0===s.inTangent&&a.values.push(void 0),void 0===s.outTangent&&a.values.push(void 0),a.values.push(s.interpolation))}e.keys.push(a)}e.ranges=[];for(const n in this._ranges){const s=this._ranges[n];if(!s)continue;const a={};a.name=n,a.from=s.from,a.to=s.to,e.ranges.push(a)}return e}static _UniversalLerp(e,t,i){const n=e.constructor;return n.Lerp?n.Lerp(e,t,i):n.Slerp?n.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new Me(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,n=[];let s,a;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),a=0;a<e.keys.length;a++){const o=e.keys[a];let l,c,u;switch(i){case Me.ANIMATIONTYPE_FLOAT:s=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(c=o.values[2]),o.values.length>=4&&(u=o.values[3]);break;case Me.ANIMATIONTYPE_QUATERNION:if(s=Be.FromArray(o.values),o.values.length>=8){const d=Be.FromArray(o.values.slice(4,8));d.equals(Be.Zero())||(l=d)}if(o.values.length>=12){const d=Be.FromArray(o.values.slice(8,12));d.equals(Be.Zero())||(c=d)}o.values.length>=13&&(u=o.values[12]);break;case Me.ANIMATIONTYPE_MATRIX:s=B.FromArray(o.values),o.values.length>=17&&(u=o.values[16]);break;case Me.ANIMATIONTYPE_COLOR3:s=Fe.FromArray(o.values),o.values[3]&&(l=Fe.FromArray(o.values[3])),o.values[4]&&(c=Fe.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break;case Me.ANIMATIONTYPE_COLOR4:s=ct.FromArray(o.values),o.values[4]&&(l=ct.FromArray(o.values[4])),o.values[5]&&(c=ct.FromArray(o.values[5])),o.values[6]&&(u=ct.FromArray(o.values[6]));break;default:s=E.FromArray(o.values),o.values[3]&&(l=E.FromArray(o.values[3])),o.values[4]&&(c=E.FromArray(o.values[4])),o.values[5]&&(u=o.values[5])}const h={};h.frame=o.frame,h.value=s,null!=l&&(h.inTangent=l),null!=c&&(h.outTangent=c),null!=u&&(h.interpolation=u),n.push(h)}if(t.setKeys(n),e.ranges)for(a=0;a<e.ranges.length;a++)s=e.ranges[a],t.createRange(s.name,s.from,s.to);return t}static AppendSerializedAnimations(e,t){lt.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,n)=>{const s=new Kn;s.addEventListener("readystatechange",()=>{if(4==s.readyState)if(200==s.status){let a=JSON.parse(s.responseText);if(a.animations&&(a=a.animations),a.length){const o=new Array;for(const l of a)o.push(this.Parse(l));i(o)}else{const o=this.Parse(a);e&&(o.name=e),i(o)}}else n("Unable to load the animation")}),s.open("GET",t),s.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const n=new Kn;n.addEventListener("readystatechange",()=>{if(4==n.readyState)if(200==n.status){const s=JSON.parse(JSON.parse(n.responseText).jsonPayload);if(s.animations){const a=JSON.parse(s.animations),o=new Array;for(const l of a.animations){const c=this.Parse(l);c.snippetId=e,o.push(c)}t(o)}else{const a=JSON.parse(s.animation),o=this.Parse(a);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}Me._UniqueIdGenerator=0,Me.AllowMatricesInterpolation=!1,Me.AllowMatrixDecomposeForInterpolation=!0,Me.SnippetUrl="https://snippet.babylonjs.com",Me.ANIMATIONTYPE_FLOAT=0,Me.ANIMATIONTYPE_VECTOR3=1,Me.ANIMATIONTYPE_QUATERNION=2,Me.ANIMATIONTYPE_MATRIX=3,Me.ANIMATIONTYPE_COLOR3=4,Me.ANIMATIONTYPE_COLOR4=7,Me.ANIMATIONTYPE_VECTOR2=5,Me.ANIMATIONTYPE_SIZE=6,Me.ANIMATIONLOOPMODE_RELATIVE=0,Me.ANIMATIONLOOPMODE_CYCLE=1,Me.ANIMATIONLOOPMODE_CONSTANT=2,Me.CreateFromSnippetAsync=Me.ParseFromSnippetAsync,ye("BABYLON.Animation",Me),$i._AnimationRangeFactory=(r,e,t)=>new Oc(r,e,t);const _z=Object.freeze(new Be(0,0,0,0)),mz=Object.freeze(E.Zero()),Tz=Object.freeze(We.Zero()),Ez=Object.freeze(os.Zero()),vz=Object.freeze(Fe.Black());class Sz{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,n){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=n,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===Me.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=B.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame&&this._keys.splice(0,0,{frame:0,value:this._minValue}),this._target instanceof Array){let a=0;for(const o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const s=t.getEvents();s&&s.length>0&&s.forEach(a=>{this._events.push(a._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let n=e[i[0]];for(let s=1;s<i.length-1;s++)n=n[i[s]];this._targetPath=i[i.length-1],this._activeTargets[t]=n}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)void 0!==this._originalValue[t]&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let i=0;i<this._target.length;i++)this._setValue(this._target[i],this._activeTargets[i],e,t,i);else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];t=i.getRestPose&&"_matrix"===this._targetPath?i.getRestPose():i[this._targetPath],this._originalValue[e]=t&&t.clone?t.clone():t}_setValue(e,t,i,n,s){if(this._currentActiveTarget=t,this._weight=n,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];this._originalBlendValue=o.clone?o.clone():o}this._originalBlendValue.m?Me.AllowMatrixDecomposeForInterpolation?this._currentValue?B.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=B.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?B.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=B.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=Me._UniversalLerp(this._originalBlendValue,i,this._blendingFactor),this._blendingFactor+=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:this._currentValue=(null==i?void 0:i.clone)?i.clone():i;-1!==n?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[s]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let s=0;s<i.length;s++)i[s].onlyOnce||(i[s].isDone=i[s].frame<e);this._currentFrame=e;const n=this._animation._interpolate(e,this._animationState);this.setValue(n,-1)}_prepareForSpeedRatioChange(e){this._ratioOffset=this._previousRatio-this._previousDelay*(this._animation.framePerSecond*e)/1e3}animate(e,t,i,n,s,a=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const u=i-t;let h;const d=e*(o.framePerSecond*s)/1e3+this._ratioOffset;let p,f=0;if(this._previousDelay=e,this._previousRatio=d,!n&&i>=t&&d>=u)c=!1,f=o._getKeyValue(this._maxValue);else if(!n&&t>=i&&d<=u)c=!1,f=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==Me.ANIMATIONLOOPMODE_CYCLE){const m=i.toString()+t.toString();if(!this._offsetsCache[m]){this._animationState.repeatCount=0,this._animationState.loopMode=Me.ANIMATIONLOOPMODE_CYCLE;const T=o._interpolate(t,this._animationState),v=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case Me.ANIMATIONTYPE_FLOAT:this._offsetsCache[m]=v-T;break;case Me.ANIMATIONTYPE_QUATERNION:case Me.ANIMATIONTYPE_VECTOR3:case Me.ANIMATIONTYPE_VECTOR2:case Me.ANIMATIONTYPE_SIZE:case Me.ANIMATIONTYPE_COLOR3:this._offsetsCache[m]=v.subtract(T)}this._highLimitsCache[m]=v}f=this._highLimitsCache[m],h=this._offsetsCache[m]}if(void 0===h)switch(o.dataType){case Me.ANIMATIONTYPE_FLOAT:h=0;break;case Me.ANIMATIONTYPE_QUATERNION:h=_z;break;case Me.ANIMATIONTYPE_VECTOR3:h=mz;break;case Me.ANIMATIONTYPE_VECTOR2:h=Tz;break;case Me.ANIMATIONTYPE_SIZE:h=Ez;break;case Me.ANIMATIONTYPE_COLOR3:h=vz}if(this._host&&this._host.syncRoot){const m=this._host.syncRoot;p=t+(m.masterFrame-m.fromFrame)/(m.toFrame-m.fromFrame)*(i-t)}else p=d>0&&t>i||d<0&&t<i?c&&0!==u?i+d%u:t:c&&0!==u?t+d%u:i;const g=this._events;if(s>0&&this.currentFrame>p||s<0&&this.currentFrame<p){this._onLoop();for(let m=0;m<g.length;m++)g[m].onlyOnce||(g[m].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=p,this._animationState.repeatCount=0===u?0:d/u>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=h;const _=o._interpolate(p,this._animationState);if(this.setValue(_,a),g.length)for(let m=0;m<g.length;m++)if(u>0&&p>=g[m].frame&&g[m].frame>=t||u<0&&p<=g[m].frame&&g[m].frame<=t){const T=g[m];T.isDone||(T.onlyOnce&&(g.splice(m,1),m--),T.isDone=!0,T.action(p))}return c||(this._stopped=!0),c}}function Hb(r,e,t,i,n,s,a){try{var o=r[s](a),l=o.value}catch(c){return void t(c)}o.done?e(l):Promise.resolve(l).then(i,n)}function ls(r){return function(){var e=this,t=arguments;return new Promise(function(i,n){var s=r.apply(e,t);function a(l){Hb(s,i,n,a,o,"next",l)}function o(l){Hb(s,i,n,a,o,"throw",l)}a(void 0)})}}function rn(){return"undefined"!=typeof window}function Km(){return"undefined"!=typeof navigator}function dh(){return"undefined"!=typeof document}function If(r){let e="",t=r.firstChild;for(;t;)3===t.nodeType&&(e+=t.textContent),t=t.nextSibling;return e}const Qm={IsWindowObjectExist:rn,IsNavigatorAvailable:Km,IsDocumentAvailable:dh,GetDOMTextContent:If};class H{static _CheckLimit(e,t){let i=H._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},H._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const n=H._LogLimitOutputs[e];if(!n||!H.MessageLimitReached)return;const s=this._Levels[t];n.current===n.limit&&H[s.name](H.MessageLimitReached.replace(/%LIMIT%/g,""+n.limit).replace(/%TYPE%/g,null!==(i=s.name)&&void 0!==i?i:""))}static _AddLogEntry(e){H._LogCache=e+H._LogCache,H.OnNewCacheEntry&&H.OnNewCacheEntry(e)}static _FormatMessage(e){const t=n=>n<10?"0"+n:""+n,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(void 0!==i&&!H._CheckLimit(t,i))return;const n=H._FormatMessage(t),s=this._Levels[e];s.logFunc&&s.logFunc("BJS - "+n),H._AddLogEntry(`<div style='color:${s.color}'>${n}</div><br>`),H._GenerateLimitMessage(t,e)}static get LogCache(){return H._LogCache}static ClearLogCache(){H._LogCache="",H._LogLimitOutputs={},H.errorsCount=0}static set LogLevels(e){H.Log=H._LogDisabled,H.Warn=H._LogDisabled,H.Error=H._LogDisabled,[H.MessageLogLevel,H.WarningLogLevel,H.ErrorLogLevel].forEach(t=>{(e&t)===t&&(H[this._Levels[t].name]=H._LogEnabled.bind(H,t))})}}H.NoneLogLevel=0,H.MessageLogLevel=1,H.WarningLogLevel=2,H.ErrorLogLevel=4,H.AllLogLevel=7,H.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",H._LogCache="",H._LogLimitOutputs={},H._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],H.errorsCount=0,H.Log=H._LogEnabled.bind(H,H.MessageLogLevel),H.Warn=H._LogEnabled.bind(H,H.WarningLogLevel),H.Error=H._LogEnabled.bind(H,H.ErrorLogLevel);const zb=(r,e)=>!r||r.getClassName&&"Mesh"===r.getClassName()?null:r.getClassName&&"SubMesh"===r.getClassName()?r.clone(e):r.clone?r.clone():null;class Wr{static DeepCopy(e,t,i,n){const s=function xz(r){const e=[];do{Object.getOwnPropertyNames(r).forEach(function(t){-1===e.indexOf(t)&&e.push(t)})}while(r=Object.getPrototypeOf(r));return e}(e);for(const a of s){if("_"===a[0]&&(!n||-1===n.indexOf(a))||a.endsWith("Observable")||i&&-1!==i.indexOf(a))continue;const o=e[a],l=typeof o;if("function"!==l)try{if("object"===l)if(o instanceof Array){if(t[a]=[],o.length>0)if("object"==typeof o[0])for(let c=0;c<o.length;c++){const u=zb(o[c],t);-1===t[a].indexOf(u)&&t[a].push(u)}else t[a]=o.slice(0)}else t[a]=zb(o,t);else t[a]=o}catch(c){H.Warn(c.message)}}}}class Qa{static get Now(){return Qm.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}let Rf=(()=>{class r{}return r.FilesToLoad={},r})();class Fc extends Error{}Fc._setPrototypeOf=Object.setPrototypeOf||((r,e)=>(r.__proto__=e,r));class xa extends Fc{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Fc._setPrototypeOf(this,xa.prototype)}}const Zm=r=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,n,s,a,o,l,c,t="",u=0;const h=ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r);for(;u<h.length;)i=h[u++],n=u<h.length?h[u++]:Number.NaN,s=u<h.length?h[u++]:Number.NaN,a=i>>2,o=(3&i)<<4|n>>4,l=(15&n)<<2|s>>6,c=63&s,isNaN(n)?l=c=64:isNaN(s)&&(c=64),t+=e.charAt(a)+e.charAt(o)+e.charAt(l)+e.charAt(c);return t},qm=r=>atob(r);class fh{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,n,s,a,o,l;let c="";if(this.line){let u=this.line;const h=t.processor;if(h){h.lineProcessor&&(u=h.lineProcessor(u,t.isFragment,t.processingContext));const d=null!==(n=null===(i=t.processor)||void 0===i?void 0:i.attributeKeywordName)&&void 0!==n?n:"attribute",f=t.isFragment&&(null===(s=t.processor)||void 0===s?void 0:s.varyingFragmentKeywordName)?null===(a=t.processor)||void 0===a?void 0:a.varyingFragmentKeywordName:!t.isFragment&&(null===(o=t.processor)||void 0===o?void 0:o.varyingVertexKeywordName)?null===(l=t.processor)||void 0===l?void 0:l.varyingVertexKeywordName:"varying";!t.isFragment&&h.attributeProcessor&&this.line.startsWith(d)?u=h.attributeProcessor(this.line,e,t.processingContext):h.varyingProcessor&&this.line.startsWith(f)?u=h.varyingProcessor(this.line,t.isFragment,e,t.processingContext):h.uniformProcessor&&h.uniformRegexp&&h.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&h.uniformBufferRegexp&&h.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):h.textureProcessor&&h.textureRegexp&&h.textureRegexp.test(this.line)?u=h.textureProcessor(this.line,t.isFragment,e,t.processingContext):(h.uniformProcessor||h.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?h.uniformProcessor&&(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,h.endOfUniformBufferProcessor&&(u=h.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}c+=u+"\r\n"}return this.children.forEach(u=>{c+=u.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),c}}class Mz{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if("#"===t[0]){this._lines.push(t);continue}if(t.trim().startsWith("//")){this._lines.push(t);continue}const i=t.split(";");for(let n=0;n<i.length;n++){let s=i[n];s=s.trim(),s&&this._lines.push(s+(n!==i.length-1?";":""))}}}}class Jm extends fh{process(e,t){for(let i=0;i<this.children.length;i++){const n=this.children[i];if(n.isValid(e))return n.process(e,t)}return""}}class Dz extends fh{isValid(e){return this.testExpression.isTrue(e)}}let ph=(()=>{class r{isTrue(t){return!0}static postfixToInfix(t){const i=[];for(const n of t)if(void 0===r._OperatorPriority[n])i.push(n);else{const s=i[i.length-1],a=i[i.length-2];i.length-=2,i.push(`(${a}${n}${s})`)}return i[i.length-1]}static infixToPostfix(t){const i=[];let n=-1;const s=()=>{u=u.trim(),""!==u&&(i.push(u),u="")},a=h=>{n<r._Stack.length-1&&(r._Stack[++n]=h)},o=()=>r._Stack[n],l=()=>-1===n?"!!INVALID EXPRESSION!!":r._Stack[n--];let c=0,u="";for(;c<t.length;){const h=t.charAt(c),d=c<t.length-1?t.substr(c,2):"";if("("===h)u="",a(h);else if(")"===h){for(s();-1!==n&&"("!==o();)i.push(l());l()}else if(r._OperatorPriority[d]>1){for(s();-1!==n&&r._OperatorPriority[o()]>=r._OperatorPriority[d];)i.push(l());a(d),c++}else u+=h;c++}for(s();-1!==n;)"("===o()?l():i.push(l());return i}}return r._OperatorPriority={")":0,"(":1,"||":2,"&&":3},r._Stack=["","","","","","","","","","","","","","","","","","","",""],r})();class Mf extends ph{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class Pz extends ph{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class wz extends ph{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class Oz extends ph{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];void 0===t&&(t=this.define);let i=!1;const n=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":i=n>s;break;case"<":i=n<s;break;case"<=":i=n<=s;break;case">=":i=n>=s;break;case"==":i=n===s}return i}}var Ri=(()=>{return(r=Ri||(Ri={}))[r.GLSL=0]="GLSL",r[r.WGSL=1]="WGSL",Ri;var r})();const Fz=/defined\s*?\((.+?)\)/g,eT=/defined\s*?\[(.+?)\]/g,Xb=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class Aa{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,n){var s;(null===(s=t.processor)||void 0===s?void 0:s.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,a=>{t.processCodeAfterIncludes&&(a=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",a));const o=this._ProcessShaderConversion(a,t,n);i(o,a)})}static PreProcess(e,t,i,n){var s;(null===(s=t.processor)||void 0===s?void 0:s.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,a=>{t.processCodeAfterIncludes&&(a=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",a));const o=this._ApplyPreProcessing(a,t,n);i(o,a)})}static Finalize(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}static _ProcessPrecision(e,t){var i;if(null===(i=t.processor)||void 0===i?void 0:i.noPrecision)return e;const n=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=n?"precision highp float;\n"+e:"precision mediump float;\n"+e:n||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new Mf(i[1].trim(),"!"===e[0]);const n=["==",">=","<=","<",">"];let s="",a=0;for(s of n)if(a=e.indexOf(s),a>-1)break;if(-1===a)return new Mf(e);const o=e.substring(0,a).trim(),l=e.substring(a+s.length).trim();return new Oz(o,s,l)}static _BuildSubExpression(e){e=e.replace(Fz,"defined[$1]");const t=ph.infixToPostfix(e),i=[];for(const s of t)if("||"!==s&&"&&"!==s)i.push(s);else if(i.length>=2){let a=i[i.length-1],o=i[i.length-2];i.length-=2;const l="&&"==s?new wz:new Pz;"string"==typeof a&&(a=a.replace(eT,"defined($1)")),"string"==typeof o&&(o=o.replace(eT,"defined($1)")),l.leftOperand="string"==typeof o?this._ExtractOperation(o):o,l.rightOperand="string"==typeof a?this._ExtractOperation(a):a,i.push(l)}let n=i[i.length-1];return"string"==typeof n&&(n=n.replace(eT,"defined($1)")),"string"==typeof n?this._ExtractOperation(n):n}static _BuildExpression(e,t){const i=new Dz,n=e.substring(0,t);let s=e.substring(t);return s=s.substring(0,(s.indexOf("//")+1||s.length+1)-1).trim(),i.testExpression="#ifdef"===n?new Mf(s):"#ifndef"===n?new Mf(s,!0):this._BuildSubExpression(s),i}static _MoveCursorWithinIf(e,t,i){let n=e.currentLine;for(;this._MoveCursor(e,i);){n=e.currentLine;const s=n.substring(0,5).toLowerCase();if("#else"===s){const a=new fh;return t.children.push(a),void this._MoveCursor(e,a)}if("#elif"===s){const a=this._BuildExpression(n,5);t.children.push(a),i=a}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine,s=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(s&&s.length)switch(s[0]){case"#ifdef":{const o=new Jm;t.children.push(o);const l=this._BuildExpression(i,6);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const o=new Jm;t.children.push(o);const l=this._BuildExpression(i,7);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#if":{const o=new Jm,l=this._BuildExpression(i,3);t.children.push(o),o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}}else{const a=new fh;if(a.line=i,t.children.push(a),"#"===i[0]&&"d"===i[1]){const o=i.replace(";","").split(" ");a.additionalDefineKey=o[1],3===o.length&&(a.additionalDefineValue=o[2])}}}return!1}static _EvaluatePreProcessors(e,t,i){const n=new fh,s=new Mz;return s.lineIndex=-1,s.lines=e.split("\n"),this._MoveCursor(s,n),n.process(t,i)}static _PreparePreProcessors(e,t){var i;const n=e.defines,s={};for(const a of n){const l=a.replace("#define","").replace(";","").trim().split(" ");s[l[0]]=l.length>1?l[1]:""}return(null===(i=e.processor)||void 0===i?void 0:i.shaderLanguage)===Ri.GLSL&&(s.GL_ES="true"),s.__VERSION__=e.version,s[e.platformName]="true",t._getGlobalDefines(s),s}static _ProcessShaderConversion(e,t,i){let n=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===Ri.GLSL&&-1!==n.indexOf("#version 3")&&(n=n.replace("#version 300 es",""),!t.processor.parseGLES3))return n;const s=t.defines,a=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,s,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,a,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,s,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ApplyPreProcessing(e,t,i){var n,s;let a=e;const o=t.defines,l=this._PreparePreProcessors(t,i);return(null===(n=t.processor)||void 0===n?void 0:n.preProcessor)&&(a=t.processor.preProcessor(a,o,t.isFragment,t.processingContext)),a=this._EvaluatePreProcessors(a,l,t),(null===(s=t.processor)||void 0===s?void 0:s.postProcessor)&&(a=t.processor.postProcessor(a,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(a=i.inlineShaderCode(a)),a}static _ProcessIncludes(e,t,i){let n=Xb.exec(e),s=new String(e),a=!1;for(;null!=n;){let o=n[1];if(-1!==o.indexOf("__decl__")&&(o=o.replace(/__decl__/,""),t.supportsUniformBuffers&&(o=o.replace(/Vertex/,"Ubo"),o=o.replace(/Fragment/,"Ubo")),o+="Declaration"),!t.includesShadersStore[o])return void Aa._FileToolsLoadFile(t.shadersRepository+"ShadersInclude/"+o+".fx",c=>{t.includesShadersStore[o]=c,this._ProcessIncludes(s,t,i)});{let l=t.includesShadersStore[o];if(n[2]){const c=n[3].split(",");for(let u=0;u<c.length;u+=2){const h=new RegExp(c[u],"g");l=l.replace(h,c[u+1])}}if(n[4]){const c=n[5];if(-1!==c.indexOf("..")){const u=c.split(".."),h=parseInt(u[0]);let d=parseInt(u[1]),f=l.slice(0);l="",isNaN(d)&&(d=t.indexParameters[u[1]]);for(let p=h;p<d;p++)t.supportsUniformBuffers||(f=f.replace(/light\{X\}.(\w*)/g,(g,_)=>_+"{X}")),l+=f.replace(/\{X\}/g,p.toString())+"\n"}else t.supportsUniformBuffers||(l=l.replace(/light\{X\}.(\w*)/g,(u,h)=>h+"{X}")),l=l.replace(/\{X\}/g,c)}s=s.replace(n[0],l),a=a||l.indexOf("#include<")>=0||l.indexOf("#include <")>=0}n=Xb.exec(e)}a?this._ProcessIncludes(s.toString(),t,i):i(s)}static _FileToolsLoadFile(e,t,i,n,s,a){throw ht("FileTools")}}let Z=(()=>{class r{static GetShadersRepository(t=Ri.GLSL){return t===Ri.GLSL?r.ShadersRepository:r.ShadersRepositoryWGSL}static GetShadersStore(t=Ri.GLSL){return t===Ri.GLSL?r.ShadersStore:r.ShadersStoreWGSL}static GetIncludesShadersStore(t=Ri.GLSL){return t===Ri.GLSL?r.IncludesShadersStore:r.IncludesShadersStoreWGSL}}return r.ShadersRepository="src/Shaders/",r.ShadersStore={},r.IncludesShadersStore={},r.ShadersRepositoryWGSL="src/ShadersWGSL/",r.ShadersStoreWGSL={},r.IncludesShadersStoreWGSL={},r})();class Si{static get ShadersRepository(){return Z.ShadersRepository}static set ShadersRepository(e){Z.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new J),this._onBindObservable}constructor(e,t,i,n=null,s,a=null,o=null,l=null,c=null,u,h="",d=Ri.GLSL){var f,p,g;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new J,this.onErrorObservable=new J,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=h;let _,T,v,m=null;if(t.attributes){const R=t;if(this._engine=i,this._attributesNames=R.attributes,this._uniformsNames=R.uniformsNames.concat(R.samplers),this._samplerList=R.samplers.slice(),this.defines=R.defines,this.onError=R.onError,this.onCompiled=R.onCompiled,this._fallbacks=R.fallbacks,this._indexParameters=R.indexParameters,this._transformFeedbackVaryings=R.transformFeedbackVaryings||null,this._multiTarget=!!R.multiTarget,this._shaderLanguage=null!==(f=R.shaderLanguage)&&void 0!==f?f:Ri.GLSL,R.uniformBuffersNames){this._uniformBuffersNamesList=R.uniformBuffersNames.slice();for(let D=0;D<R.uniformBuffersNames.length;D++)this._uniformBuffersNames[R.uniformBuffersNames[D]]=D}m=null!==(p=R.processFinalCode)&&void 0!==p?p:null,_=null!==(g=R.processCodeAfterIncludes)&&void 0!==g?g:void 0}else this._engine=s,this.defines=null==a?"":a,this._uniformsNames=i.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=c,this.onCompiled=l,this._indexParameters=u,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=Si._UniqueIdSeed++;const A=rn()?this._engine.getHostDocument():null;e.vertexSource?T="source:"+e.vertexSource:e.vertexElement?(T=A?A.getElementById(e.vertexElement):null,T||(T=e.vertexElement)):T=e.vertex||e,e.fragmentSource?v="source:"+e.fragmentSource:e.fragmentElement?(v=A?A.getElementById(e.fragmentElement):null,v||(v=e.fragmentElement)):v=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let S={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Z.GetShadersRepository(this._shaderLanguage),includesShadersStore:Z.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:_};const x=[void 0,void 0],C=()=>{if(x[0]&&x[1]){S.isFragment=!0;const[R,D]=x;Aa.Process(D,S,(P,N)=>{this._fragmentSourceCodeBeforeMigration=N,m&&(P=m("fragment",P));const k=Aa.Finalize(R,P,S);S=null,this._useFinalCode(k.vertexCode,k.fragmentCode,e)},this._engine)}};this._loadShader(T,"Vertex","",R=>{Aa.Initialize(S),Aa.Process(R,S,(D,P)=>{this._rawVertexSourceCode=R,this._vertexSourceCodeBeforeMigration=P,m&&(D=m("vertex",D)),x[0]=D,C()},this._engine)}),this._loadShader(v,"Fragment","Pixel",R=>{this._rawFragmentSourceCode=R,x[1]=R,C()})}_useFinalCode(e,t,i){if(i){const s=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===Ri.WGSL?"//":"")+"#define SHADER_NAME vertex:"+(i.vertexElement||i.vertex||i.spectorName||i)+"\n"+e,this._fragmentSourceCode=(this._shaderLanguage===Ri.WGSL?"//":"")+"#define SHADER_NAME fragment:"+s+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch(e){return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,n){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void n(If(e));if("source:"===e.substr(0,7))return void n(e.substr(7));if("base64:"===e.substr(0,7))return void n(window.atob(e.substr(7)));const s=Z.GetShadersStore(this._shaderLanguage);if(s[e+t+"Shader"])return void n(s[e+t+"Shader"]);if(i&&s[e+i+"Shader"])return void n(s[e+i+"Shader"]);let a;a="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:Z.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(a+"."+t.toLowerCase()+".fx",n)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getVertexShaderCode())&&void 0!==t?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getFragmentShaderCode())&&void 0!==t?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,n){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(s,a)=>{n&&n(a)},this.onCompiled=()=>{const s=this.getEngine().scenes;if(s)for(let a=0;a<s.length;a++)s[a].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const n=this._engine;this._pipelineContext=n.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const s=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,null,this._transformFeedbackVaryings,this._key):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,s,t,this._transformFeedbackVaryings,this._key),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let a=0;a<e.length;a++)this._attributeLocationByName[e[a]]=this._attributes[a];n.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(n){this._processCompilationErrors(n,i)}}_getShaderCodeAndErrorLine(e,t,i){let s=null;if(t&&e){const a=t.match(i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/);if(a&&2===a.length){const o=parseInt(a[1]),l=e.split("\n",-1);l.length>=o&&(s=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var i,n,s;this._compilationError=e.message;const a=this._attributesNames,o=this._fallbacks;if(H.Error("Unable to compile effect:"),H.Error("Uniforms: "+this._uniformsNames.map(function(c){return" "+c})),H.Error("Attributes: "+a.map(function(c){return" "+c})),H.Error("Defines:\r\n"+this.defines),Si.LogShaderCodeOnCompilationError){let c=null,u=null,h=null;(null===(i=this._pipelineContext)||void 0===i?void 0:i._getVertexShaderCode())&&([h,c]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),h&&(H.Error("Vertex code:"),H.Error(h))),(null===(n=this._pipelineContext)||void 0===n?void 0:n._getFragmentShaderCode())&&([h,u]=this._getShaderCodeAndErrorLine(null===(s=this._pipelineContext)||void 0===s?void 0:s._getFragmentShaderCode(),this._compilationError,!0),h&&(H.Error("Fragment code:"),H.Error(h))),c&&H.Error(c),u&&H.Error(u)}H.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,H.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const n=this._samplerList.indexOf(e);for(let a=1;a<t.length;a++){const o=i+(a-1).toString();this._samplerList.splice(n+a,0,o)}let s=0;for(const a of this._samplerList)this._samplers[a]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||Si._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(Si._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,n){return this._pipelineContext.setInt3(e,t,i,n),this}setInt4(e,t,i,n,s){return this._pipelineContext.setInt4(e,t,i,n,s),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setUInt3(e,t,i,n){return this._pipelineContext.setInt3(e,t,i,n),this}setUInt4(e,t,i,n,s){return this._pipelineContext.setInt4(e,t,i,n,s),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,n){return this._pipelineContext.setFloat3(e,t,i,n),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,n,s){return this._pipelineContext.setFloat4(e,t,i,n,s),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,n=Ri.GLSL){t&&(Z.GetShadersStore(n)[`${e}PixelShader`]=t),i&&(Z.GetShadersStore(n)[`${e}VertexShader`]=i)}static ResetCache(){Si._BaseCache={}}}Si.LogShaderCodeOnCompilationError=!0,Si._UniqueIdSeed=0,Si._BaseCache={},Si.ShadersStore=Z.ShadersStore,Si.IncludesShadersStore=Z.IncludesShadersStore;class Yb{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){!this.isDirty||(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}let Nz=(()=>{class r{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=r.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=r.KEEP,this.opDepthFail=r.KEEP,this.opStencilDepthPass=r.REPLACE}get stencilFunc(){return this.func}set stencilFunc(t){this.func=t}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(t){this.funcRef=t}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(t){this.funcMask=t}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(t){this.opStencilFail=t}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(t){this.opDepthFail=t}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(t){this.opStencilDepthPass=t}get stencilMask(){return this.mask}set stencilMask(t){this.mask=t}get stencilTest(){return this.enabled}set stencilTest(t){this.enabled=t}}return r.ALWAYS=519,r.KEEP=7680,r.REPLACE=7681,r})();class Lz{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,n){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===n||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=n,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,n){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===n||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=n,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){!this.isDirty||(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}var vt=(()=>{return(r=vt||(vt={}))[r.Unknown=0]="Unknown",r[r.Url=1]="Url",r[r.Temp=2]="Temp",r[r.Raw=3]="Raw",r[r.Dynamic=4]="Dynamic",r[r.RenderTarget=5]="RenderTarget",r[r.MultiRenderTarget=6]="MultiRenderTarget",r[r.Cube=7]="Cube",r[r.CubeRaw=8]="CubeRaw",r[r.CubePrefiltered=9]="CubePrefiltered",r[r.Raw3D=10]="Raw3D",r[r.Raw2DArray=11]="Raw2DArray",r[r.DepthStencil=12]="DepthStencil",r[r.CubeRawRGBD=13]="CubeRawRGBD",r[r.Depth=14]="Depth",vt;var r})();let hi=(()=>{class r extends class Bz{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,n=1,s=2,a=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=n,this.samplingMode=s,this._comparisonFunction=a,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}{get useMipMaps(){return this.generateMipMaps}set useMipMaps(t){this.generateMipMaps=t}get uniqueId(){return this._uniqueId}_setUniqueId(t){this._uniqueId=t}getEngine(){return this._engine}get source(){return this._source}constructor(t,i,n=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new J,this.onErrorObservable=new J,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=vt.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=t,this._source=i,this._uniqueId=r._Counter++,n||(this._hardwareTexture=t._createHardwareTexture())}incrementReferences(){this._references++}updateSize(t,i,n=1){this._engine.updateTextureDimensions(this,t,i,n),this.width=t,this.height=i,this.depth=n,this.baseWidth=t,this.baseHeight=i,this.baseDepth=n,this._size=t*i*n}_rebuild(){var t;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const n=this.onRebuildCallback(this),s=a=>{a._swapAndDie(this,!1),this.isReady=n.isReady};return void(n.isAsync?n.proxy.then(s):s(n.proxy))}let i;switch(this.source){case vt.Temp:break;case vt.Url:return void(i=this._engine.createTexture(null!==(t=this._originalUrl)&&void 0!==t?t:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,n=>{n._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case vt.Raw:i=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),i._swapAndDie(this,!1),this.isReady=!0;break;case vt.Raw3D:i=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case vt.Raw2DArray:i=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),i._swapAndDie(this,!1),this.isReady=!0;break;case vt.Dynamic:i=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),i._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case vt.Cube:return void(i=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer));case vt.CubeRaw:i=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),i._swapAndDie(this,!1),this.isReady=!0;break;case vt.CubeRawRGBD:return;case vt.CubePrefiltered:return i=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,n=>{n&&n._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),void(i._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(t,i=!0){var n;null===(n=this._hardwareTexture)||void 0===n||n.setUsage(t._source,this.generateMipMaps,this.isCube,this.width,this.height),t._hardwareTexture=this._hardwareTexture,i&&(t._isRGBD=this._isRGBD),this._lodTextureHigh&&(t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(t._lodTextureLow&&t._lodTextureLow.dispose(),t._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(t._irradianceTexture&&t._irradianceTexture.dispose(),t._irradianceTexture=this._irradianceTexture);const s=this._engine.getLoadedTexturesCache();let a=s.indexOf(this);-1!==a&&s.splice(a,1),a=s.indexOf(t),-1===a&&s.push(t)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}return r._Counter=0,r})();class Uz{constructor(){this.shaderLanguage=Ri.GLSL}postProcessor(e,t,i,n,s){return s.getCaps().drawBuffersExtension||(e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")),e}}class jb{constructor(){this.shaderLanguage=Ri.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const n=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i)e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(n?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}let Df=(()=>{class r{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=r._Counter++}}return r._Counter=0,r})();class gh extends Df{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class Vz{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,n,s,a,o,l){const c=this.engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);let h;for(this.engine.getUniforms(this,i).forEach((d,f)=>{n[i[f]]=d}),this._uniforms=n,h=0;h<s.length;h++)null==e.getUniform(s[h])&&(s.splice(h,1),h--);s.forEach((d,f)=>{a[d]=f});for(const d of c.getAttributes(this,o))l.push(d)}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],n=t.updateFlag;return(void 0===i||i!==n)&&(this._valueCache[e]=n,!0)}_cacheFloat2(e,t,i){let n=this._valueCache[e];if(!n||2!==n.length)return n=[t,i],this._valueCache[e]=n,!0;let s=!1;return n[0]!==t&&(n[0]=t,s=!0),n[1]!==i&&(n[1]=i,s=!0),s}_cacheFloat3(e,t,i,n){let s=this._valueCache[e];if(!s||3!==s.length)return s=[t,i,n],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==i&&(s[1]=i,a=!0),s[2]!==n&&(s[2]=n,a=!0),a}_cacheFloat4(e,t,i,n,s){let a=this._valueCache[e];if(!a||4!==a.length)return a=[t,i,n,s],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==n&&(a[2]=n,o=!0),a[3]!==s&&(a[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setInt4(e,t,i,n,s){this._cacheFloat4(e,t,i,n,s)&&(this.engine.setInt4(this._uniforms[e],t,i,n,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setUInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setUInt4(e,t,i,n,s){this._cacheFloat4(e,t,i,n,s)&&(this.engine.setUInt4(this._uniforms[e],t,i,n,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){!t||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setFloat3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,n,s){this._cacheFloat4(e,t,i,n,s)&&(this.engine.setFloat4(this._uniforms[e],t,i,n,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class $b{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class Qs{static IsWrapper(e){return void 0===e.getPipelineContext}static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var n;this.effect=e,void 0!==t&&(this.defines=t),i&&(null===(n=this.drawContext)||void 0===n||n.reset())}dispose(){var e;null===(e=this.drawContext)||void 0===e||e.dispose()}}class Kb{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,null===(e=this.stencilGlobal)||void 0===e||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(null===(t=this.stencilMaterial)||void 0===t?void 0:t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class kz{}let Ze=(()=>{class r{static get NpmPackage(){return"babylonjs@5.57.1"}static get Version(){return"5.57.1"}get description(){let t=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(t+=" - Parallel shader compilation"),t}get name(){return this._name}set name(t){this._name=t}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return Si.ShadersRepository}static set ShadersRepository(t){Si.ShadersRepository=t}_getShaderProcessor(t){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(t){t!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=t,this._depthCullingState.depthFunc=t?518:515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(t){this._doNotHandleContextLost=t}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const t=new Uint8Array(4);this._emptyCubeTexture=this.createRawCubeTexture([t,t,t,t,t,t],1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(t){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(t){this._snapshotRenderingMode=t}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(t,i){if("undefined"==typeof document)return new OffscreenCanvas(t,i);const n=document.createElement("canvas");return n.width=t,n.height=i,n}createCanvas(t,i){return r._CreateCanvas(t,i)}createCanvasImage(){return document.createElement("img")}constructor(t,i,n,s){var a,o,l,c,u,h,d,f,p,g,_;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new J,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new J,this.onContextRestoredObservable=new J,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Yb,this._stencilStateComposer=new Kb,this._stencilState=new Nz,this._alphaState=new Lz,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new J,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Qa.Now;let m=null;this._creationOptions=n=n||{},this.adaptToDeviceRatio=null!=s&&s,this._stencilStateComposer.stencilGlobal=this._stencilState,bn.SetMatrixPrecision(!!n.useHighPrecisionMatrix),n.antialias=null!=i?i:n.antialias,n.deterministicLockstep=null!==(a=n.deterministicLockstep)&&void 0!==a&&a,n.lockstepMaxSteps=null!==(o=n.lockstepMaxSteps)&&void 0!==o?o:4,n.timeStep=null!==(l=n.timeStep)&&void 0!==l?l:1/60,n.audioEngine=null===(c=n.audioEngine)||void 0===c||c,n.stencil=null===(u=n.stencil)||void 0===u||u,this._audioContext=null!==(d=null===(h=n.audioEngineOptions)||void 0===h?void 0:h.audioContext)&&void 0!==d?d:null,this._audioDestination=null!==(p=null===(f=n.audioEngineOptions)||void 0===f?void 0:f.audioDestination)&&void 0!==p?p:null,this.premultipliedAlpha=null===(g=n.premultipliedAlpha)||void 0===g||g,this.useExactSrgbConversions=null!==(_=n.useExactSrgbConversions)&&void 0!==_&&_,this._doNotHandleContextLost=!!n.doNotHandleContextLost,this._isStencilEnable=!!n.stencil,s=s||n.adaptToDeviceRatio||!1;const T=rn()&&window.devicePixelRatio||1;if(this._hardwareScalingLevel=s?1/Math.min(n.limitDeviceRatio||T,T):1,this._lastDevicePixelRatio=T,!t)return;if(t.getContext){if(m=t,this._renderingCanvas=m,void 0===n.preserveDrawingBuffer&&(n.preserveDrawingBuffer=!1),void 0===n.xrCompatible&&(n.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const S=navigator.userAgent;for(const x of r.ExceptionList){const R=x.targets;if(new RegExp(x.key).test(S)){if(x.capture&&x.captureConstraint){const N=x.captureConstraint,X=new RegExp(x.capture).exec(S);if(X&&X.length>0&&parseInt(X[X.length-1])>=N)continue}for(const P of R)switch(P){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":n.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=S=>{S.preventDefault(),this._contextWasLost=!0,H.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},m.addEventListener("webglcontextlost",this._onContextLost,!1),m.addEventListener("webglcontextrestored",this._onContextRestored,!1),n.powerPreference=n.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(n.xrCompatible=!1),!n.disableWebGL2Support)try{this._gl=m.getContext("webgl2",n)||m.getContext("experimental-webgl2",n),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(S){}if(!this._gl){if(!m)throw new Error("The provided canvas is null or undefined.");try{this._gl=m.getContext("webgl",n)||m.getContext("experimental-webgl",n)}catch(S){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const S=this._gl.getContextAttributes();S&&(n.stencil=S.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==n.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=n.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let S=0;S<this._caps.maxVertexAttribs;S++)this._currentBufferPointers[S]=new kz;this._shaderProcessor=this.webGLVersion>1?new jb:new Uz,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const A=`Babylon.js v${r.Version}`;console.log(A+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",A)}_setupMobileChecks(){!navigator||!navigator.userAgent||(this._checkForMobile=()=>{const t=navigator.userAgent;this.hostInformation.isMobile=-1!==t.indexOf("Mobile")||-1!==t.indexOf("Mac")&&dh()&&"ontouchend"in document},this._checkForMobile(),rn()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(t){var i=this;setTimeout(ls(function*(){var n;i._dummyFramebuffer=null;const s=i._depthCullingState.depthTest,a=i._depthCullingState.depthFunc,o=i._depthCullingState.depthMask,l=i._stencilState.stencilTest;yield t(),i.wipeCaches(!0),i._rebuildEffects(),null===(n=i._rebuildComputeEffects)||void 0===n||n.call(i),i._rebuildBuffers(),i._rebuildInternalTextures(),i._rebuildRenderTargetWrappers(),i.wipeCaches(!0),i._depthCullingState.depthTest=s,i._depthCullingState.depthFunc=a,i._depthCullingState.depthMask=o,i._stencilState.stencilTest=l,H.Warn(i.name+" context successfully restored."),i.onContextRestoredObservable.notifyObservers(i),i._contextWasLost=!1}),0)}_sharedInit(t){this._renderingCanvas=t}_getShaderProcessingContext(t){return null}_rebuildInternalTextures(){const t=this._internalTexturesCache.slice();for(const i of t)i._rebuild()}_rebuildRenderTargetWrappers(){const t=this._renderTargetWrapperCache.slice();for(const i of t)i._rebuild()}_rebuildEffects(){for(const t in this._compiledEffects){const i=this._compiledEffects[t];i._pipelineContext=null,i._wasPreviouslyReady=!1,i._prepareEffect()}Si.ResetCache()}areAllEffectsReady(){for(const t in this._compiledEffects)if(!this._compiledEffects[t].isReady())return!1;return!0}_rebuildBuffers(){for(const t of this._uniformBuffers)t._rebuild();for(const t of this._storageBuffers)t._rebuild()}_initGLContext(){var t;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);const i=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=i&&(this._glRenderer=this._gl.getParameter(i.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(i.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(null!==(t=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==t?t:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const n=this._gl.getExtension("WEBGL_draw_buffers");if(null!==n){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=n.drawBuffersWEBGL.bind(n),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let s=0;s<16;s++)this._gl["COLOR_ATTACHMENT"+s+"_WEBGL"]=n["COLOR_ATTACHMENT"+s+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const n=this._gl.getExtension("WEBGL_depth_texture");null!=n&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=n.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const n=this._gl.getExtension("OES_vertex_array_object");null!=n&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=n.createVertexArrayOES.bind(n),this._gl.bindVertexArray=n.bindVertexArrayOES.bind(n),this._gl.deleteVertexArray=n.deleteVertexArrayOES.bind(n))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const n=this._gl.getExtension("ANGLE_instanced_arrays");null!=n?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=n.drawArraysInstancedANGLE.bind(n),this._gl.drawElementsInstanced=n.drawElementsInstancedANGLE.bind(n),this._gl.vertexAttribDivisor=n.vertexAttribDivisorANGLE.bind(n)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const n=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),s=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);n&&s&&(this._caps.highPrecisionShaderSupported=0!==n.precision&&0!==s.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const n=this._gl.getExtension("EXT_blend_minmax");null!=n&&(this._caps.blendMinMax=!0,this._gl.MAX=n.MAX_EXT,this._gl.MIN=n.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{const n=this._gl.getExtension("EXT_sRGB");null!=n&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=n.SRGB_EXT,this._gl.SRGB8=n.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=n.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let n=0;n<this._maxSimultaneousTextures;n++)this._nextFreeTextureSlots.push(n);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const t=this._workingCanvas.getContext("2d");t&&(this._workingContext=t)}resetTextureCache(){for(const t in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,t)||(this._boundTexturesCache[t]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(t){this._hardwareScalingLevel=t,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(t){if(!t)return void(this._activeRenderLoops.length=0);const i=this._activeRenderLoops.indexOf(t);i>=0&&this._activeRenderLoops.splice(i,1)}_renderLoop(){if(!this._contextWasLost){let t=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t){this.beginFrame();for(let i=0;i<this._activeRenderLoops.length;i++)this._activeRenderLoops[i]();this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return rn()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(t,i){return r.QueueNewFrame(t,i)}runRenderLoop(t){-1===this._activeRenderLoops.indexOf(t)&&(this._activeRenderLoops.push(t),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(t,i,n,s=!1){const a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;let o=0;i&&t&&(this._gl.clearColor(t.r,t.g,t.b,void 0!==t.a?t.a:1),o|=this._gl.COLOR_BUFFER_BIT),n&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),o|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),o|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(o)}_viewport(t,i,n,s){(t!==this._viewportCached.x||i!==this._viewportCached.y||n!==this._viewportCached.z||s!==this._viewportCached.w)&&(this._viewportCached.x=t,this._viewportCached.y=i,this._viewportCached.z=n,this._viewportCached.w=s,this._gl.viewport(t,i,n,s))}setViewport(t,i,n){const s=i||this.getRenderWidth(),a=n||this.getRenderHeight(),o=t.x||0,l=t.y||0;this._cachedViewport=t,this._viewport(o*s,l*a,s*t.width,a*t.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(t=!1){let i,n;if(this.adaptToDeviceRatio){const s=rn()&&window.devicePixelRatio||1,a=this._lastDevicePixelRatio/s;this._lastDevicePixelRatio=s,this._hardwareScalingLevel*=a}rn()?(i=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,n=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(i=this._renderingCanvas?this._renderingCanvas.width:100,n=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(i/this._hardwareScalingLevel,n/this._hardwareScalingLevel,t)}setSize(t,i,n=!1){return!(!this._renderingCanvas||(t|=0,i|=0,!n&&this._renderingCanvas.width===t&&this._renderingCanvas.height===i)||(this._renderingCanvas.width=t,this._renderingCanvas.height=i,0))}bindFramebuffer(t,i=0,n,s,a,o=0,l=0){var c,u,h,d,f;const p=t;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,this._bindUnboundFramebuffer(p._MSAAFramebuffer?p._MSAAFramebuffer:p._framebuffer);const g=this._gl;t.isMulti||(t.is2DArray?g.framebufferTextureLayer(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,null===(c=t.texture._hardwareTexture)||void 0===c?void 0:c.underlyingResource,o,l):t.isCube&&g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(u=t.texture._hardwareTexture)||void 0===u?void 0:u.underlyingResource,o));const _=t._depthStencilTexture;if(_){const m=t._depthStencilTextureWithStencil?g.DEPTH_STENCIL_ATTACHMENT:g.DEPTH_ATTACHMENT;t.is2DArray?g.framebufferTextureLayer(g.FRAMEBUFFER,m,null===(h=_._hardwareTexture)||void 0===h?void 0:h.underlyingResource,o,l):t.isCube?g.framebufferTexture2D(g.FRAMEBUFFER,m,g.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(d=_._hardwareTexture)||void 0===d?void 0:d.underlyingResource,o):g.framebufferTexture2D(g.FRAMEBUFFER,m,g.TEXTURE_2D,null===(f=_._hardwareTexture)||void 0===f?void 0:f.underlyingResource,o)}this._cachedViewport&&!a?this.setViewport(this._cachedViewport,n,s):(n||(n=t.width,o&&(n/=Math.pow(2,o))),s||(s=t.height,o&&(s/=Math.pow(2,o))),this._viewport(0,0,n,s)),this.wipeCaches()}setState(t,i=0,n,s=!1,a,o,l=0){var c,u;(this._depthCullingState.cull!==t||n)&&(this._depthCullingState.cull=t);const h=null===(u=null!==(c=this.cullBackFaces)&&void 0!==c?c:a)||void 0===u||u?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==h||n)&&(this._depthCullingState.cullFace=h),this.setZOffset(i),this.setZOffsetUnits(l);const d=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==d||n)&&(this._depthCullingState.frontFace=d),this._stencilStateComposer.stencilMaterial=o}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(t){this._depthCullingState.depthTest=t}setZOffset(t){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-t:t}getZOffset(){const t=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-t:t}setZOffsetUnits(t){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-t:t}getZOffsetUnits(){const t=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-t:t}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t),this._currentFramebuffer=t)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(t){this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(t,i=!1,n){var s;const a=t;this._currentRenderTarget=null;const o=this._gl;if(a._MSAAFramebuffer){if(t.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(t,i,n);o.bindFramebuffer(o.READ_FRAMEBUFFER,a._MSAAFramebuffer),o.bindFramebuffer(o.DRAW_FRAMEBUFFER,a._framebuffer),o.blitFramebuffer(0,0,t.width,t.height,0,0,t.width,t.height,o.COLOR_BUFFER_BIT,o.NEAREST)}(null===(s=t.texture)||void 0===s?void 0:s.generateMipMaps)&&!i&&!t.isCube&&this.generateMipmaps(t.texture),n&&(a._MSAAFramebuffer&&this._bindUnboundFramebuffer(a._framebuffer),n()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(t){return this._createVertexBuffer(t,this._gl.STATIC_DRAW)}_createVertexBuffer(t,i){const n=this._gl.createBuffer();if(!n)throw new Error("Unable to create vertex buffer");const s=new gh(n);return this.bindArrayBuffer(s),this._gl.bufferData(this._gl.ARRAY_BUFFER,t instanceof Array?new Float32Array(t):t,i),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(t){return this._createVertexBuffer(t,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(t,i){const n=this._gl.createBuffer(),s=new gh(n);if(!n)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);const a=this._normalizeIndexData(t);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,i?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),s.references=1,s.is32Bits=4===a.BYTES_PER_ELEMENT,s}_normalizeIndexData(t){if(2===t.BYTES_PER_ELEMENT)return t;if(this._caps.uintIndices){if(t instanceof Uint32Array)return t;for(let n=0;n<t.length;n++)if(t[n]>=65535)return new Uint32Array(t);return new Uint16Array(t)}return new Uint16Array(t)}bindArrayBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ARRAY_BUFFER)}bindUniformBlock(t,i,n){const s=t.program,a=this._gl.getUniformBlockIndex(s,i);this._gl.uniformBlockBinding(s,a,n)}bindIndexBuffer(t){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(t,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(t,i){(this._vaoRecordInProgress||this._currentBoundBuffer[i]!==t)&&(this._gl.bindBuffer(i,t?t.underlyingResource:null),this._currentBoundBuffer[i]=t)}updateArrayBuffer(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)}_vertexAttribPointer(t,i,n,s,a,o,l){const c=this._currentBufferPointers[i];if(!c)return;let u=!1;c.active?(c.buffer!==t&&(c.buffer=t,u=!0),c.size!==n&&(c.size=n,u=!0),c.type!==s&&(c.type=s,u=!0),c.normalized!==a&&(c.normalized=a,u=!0),c.stride!==o&&(c.stride=o,u=!0),c.offset!==l&&(c.offset=l,u=!0)):(u=!0,c.active=!0,c.index=i,c.size=n,c.type=s,c.normalized=a,c.stride=o,c.offset=l,c.buffer=t),(u||this._vaoRecordInProgress)&&(this.bindArrayBuffer(t),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(i,n,s,o,l):this._gl.vertexAttribPointer(i,n,s,a,o,l))}_bindIndexBufferWithCache(t){null!=t&&this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)}_bindVertexBuffersAttributes(t,i,n){const s=i.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let a=0;a<s.length;a++){const o=i.getAttributeLocation(a);if(o>=0){const l=s[a];let c=null;if(n&&(c=n[l]),c||(c=t[l]),!c)continue;this._gl.enableVertexAttribArray(o),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[o]=!0);const u=c.getBuffer();u&&(this._vertexAttribPointer(u,o,c.getSize(),c.type,c.normalized,c.byteStride,c.byteOffset),c.getIsInstanced()&&(this._gl.vertexAttribDivisor(o,c.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(o),this._currentInstanceBuffers.push(u))))}}}recordVertexArrayObject(t,i,n,s){const a=this._gl.createVertexArray();if(!a)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(a),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(t,n,s),this.bindIndexBuffer(i),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),a}bindVertexArrayObject(t,i){this._cachedVertexArrayObject!==t&&(this._cachedVertexArrayObject=t,this._gl.bindVertexArray(t),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=i&&i.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(t,i,n,s,a){if(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==a){this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=a;const o=a.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let l=0;for(let c=0;c<o;c++)if(c<n.length){const u=a.getAttributeLocation(c);u>=0&&(this._gl.enableVertexAttribArray(u),this._vertexAttribArraysEnabled[u]=!0,this._vertexAttribPointer(t,u,n[c],this._gl.FLOAT,!1,s,l)),l+=4*n[c]}}this._bindIndexBufferWithCache(i)}_unbindVertexArrayObject(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(t,i,n,s){(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==n)&&(this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=n,this._bindVertexBuffersAttributes(t,n,s)),this._bindIndexBufferWithCache(i)}unbindInstanceAttributes(){let t;for(let i=0,n=this._currentInstanceLocations.length;i<n;i++){const s=this._currentInstanceBuffers[i];t!=s&&s.references&&(t=s,this.bindArrayBuffer(s)),this._gl.vertexAttribDivisor(this._currentInstanceLocations[i],0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(t){this._gl.deleteVertexArray(t)}_releaseBuffer(t){return t.references--,0===t.references&&(this._deleteBuffer(t),!0)}_deleteBuffer(t){this._gl.deleteBuffer(t.underlyingResource)}updateAndBindInstancesBuffer(t,i,n){if(this.bindArrayBuffer(t),i&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,i),void 0!==n[0].index)this.bindInstancesBuffer(t,n,!0);else for(let s=0;s<4;s++){const a=n[s];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this._vertexAttribPointer(t,a,4,this._gl.FLOAT,!1,64,16*s),this._gl.vertexAttribDivisor(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(t)}}bindInstancesBuffer(t,i,n=!0){this.bindArrayBuffer(t);let s=0;if(n)for(let a=0;a<i.length;a++)s+=4*i[a].attributeSize;for(let a=0;a<i.length;a++){const o=i[a];void 0===o.index&&(o.index=this._currentEffect.getAttributeLocationByName(o.attributeName)),!(o.index<0)&&(this._vertexAttribArraysEnabled[o.index]||(this._gl.enableVertexAttribArray(o.index),this._vertexAttribArraysEnabled[o.index]=!0),this._vertexAttribPointer(t,o.index,o.attributeSize,o.attributeType||this._gl.FLOAT,o.normalized||!1,s,o.offset),this._gl.vertexAttribDivisor(o.index,void 0===o.divisor?1:o.divisor),this._currentInstanceLocations.push(o.index),this._currentInstanceBuffers.push(t))}}disableInstanceAttributeByName(t){if(!this._currentEffect)return;const i=this._currentEffect.getAttributeLocationByName(t);this.disableInstanceAttribute(i)}disableInstanceAttribute(t){let n,i=!1;for(;-1!==(n=this._currentInstanceLocations.indexOf(t));)this._currentInstanceLocations.splice(n,1),this._currentInstanceBuffers.splice(n,1),i=!0,n=this._currentInstanceLocations.indexOf(t);i&&(this._gl.vertexAttribDivisor(t,0),this.disableAttributeByIndex(t))}disableAttributeByIndex(t){this._gl.disableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!1,this._currentBufferPointers[t].active=!1}draw(t,i,n,s){this.drawElementsType(t?0:1,i,n,s)}drawPointClouds(t,i,n){this.drawArraysType(2,t,i,n)}drawUnIndexed(t,i,n,s){this.drawArraysType(t?0:1,i,n,s)}drawElementsType(t,i,n,s){this.applyStates(),this._reportDrawCall();const a=this._drawMode(t),o=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,l=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(a,n,o,i*l,s):this._gl.drawElements(a,n,o,i*l)}drawArraysType(t,i,n,s){this.applyStates(),this._reportDrawCall();const a=this._drawMode(t);s?this._gl.drawArraysInstanced(a,i,n,s):this._gl.drawArrays(a,i,n)}_drawMode(t){switch(t){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_reportDrawCall(){}_releaseEffect(t){this._compiledEffects[t._key]&&delete this._compiledEffects[t._key];const i=t.getPipelineContext();i&&this._deletePipelineContext(i)}_deletePipelineContext(t){const i=t;i&&i.program&&(i.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(i.program))}_getGlobalDefines(t){if(t)return this.isNDCHalfZRange?t.IS_NDC_HALF_ZRANGE="":delete t.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?t.USE_REVERSE_DEPTHBUFFER="":delete t.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?t.USE_EXACT_SRGB_CONVERSIONS="":delete t.USE_EXACT_SRGB_CONVERSIONS);{let i="";return this.isNDCHalfZRange&&(i+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(i&&(i+="\n"),i+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(i&&(i+="\n"),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}createEffect(t,i,n,s,a,o,l,c,u,h=Ri.GLSL){var d;const f=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,p=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,g=this._getGlobalDefines();let _=null!==(d=null!=a?a:i.defines)&&void 0!==d?d:"";g&&(_+=g);const m=f+"+"+p+"@"+_;if(this._compiledEffects[m]){const v=this._compiledEffects[m];return l&&v.isReady()&&l(v),v}const T=new Si(t,i,n,s,this,a,o,l,c,u,m,h);return this._compiledEffects[m]=T,T}static _ConcatenateShader(t,i,n=""){return n+(i?i+"\n":"")+t}_compileShader(t,i,n,s){return this._compileRawShader(r._ConcatenateShader(t,n,s),i)}_compileRawShader(t,i){const n=this._gl,s=n.createShader("vertex"===i?n.VERTEX_SHADER:n.FRAGMENT_SHADER);if(!s){let a=n.NO_ERROR,o=n.NO_ERROR;for(;(o=n.getError())!==n.NO_ERROR;)a=o;throw new Error(`Something went wrong while creating a gl ${i} shader object. gl error=${a}, gl isContextLost=${n.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return n.shaderSource(s,t),n.compileShader(s),s}_getShaderSource(t){return this._gl.getShaderSource(t)}createRawShaderProgram(t,i,n,s,a=null){s=s||this._gl;const o=this._compileRawShader(i,"vertex"),l=this._compileRawShader(n,"fragment");return this._createShaderProgram(t,o,l,s,a)}createShaderProgram(t,i,n,s,a,o=null){a=a||this._gl;const l=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",c=this._compileShader(i,"vertex",s,l),u=this._compileShader(n,"fragment",s,l);return this._createShaderProgram(t,c,u,a,o)}inlineShaderCode(t){return t}createPipelineContext(t){const i=new Vz;return i.engine=this,this._caps.parallelShaderCompile&&(i.isParallelCompiled=!0),i}createMaterialContext(){}createDrawContext(){}_createShaderProgram(t,i,n,s,a=null){const o=s.createProgram();if(t.program=o,!o)throw new Error("Unable to create program");return s.attachShader(o,i),s.attachShader(o,n),s.linkProgram(o),t.context=s,t.vertexShader=i,t.fragmentShader=n,t.isParallelCompiled||this._finalizePipelineContext(t),o}_finalizePipelineContext(t){const i=t.context,n=t.vertexShader,s=t.fragmentShader,a=t.program;if(!i.getProgramParameter(a,i.LINK_STATUS)){if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){const c=this._gl.getShaderInfoLog(n);if(c)throw t.vertexCompilationError=c,new Error("VERTEX SHADER "+c)}if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const c=this._gl.getShaderInfoLog(s);if(c)throw t.fragmentCompilationError=c,new Error("FRAGMENT SHADER "+c)}const l=i.getProgramInfoLog(a);if(l)throw t.programLinkError=l,new Error(l)}if(this.validateShaderPrograms&&(i.validateProgram(a),!i.getProgramParameter(a,i.VALIDATE_STATUS))){const c=i.getProgramInfoLog(a);if(c)throw t.programValidationError=c,new Error(c)}i.deleteShader(n),i.deleteShader(s),t.vertexShader=void 0,t.fragmentShader=void 0,t.onCompiled&&(t.onCompiled(),t.onCompiled=void 0)}_preparePipelineContext(t,i,n,s,a,o,l,c,u,h){const d=t;d.program=s?this.createRawShaderProgram(d,i,n,void 0,u):this.createShaderProgram(d,i,n,c,void 0,u),d.program.__SPECTOR_rebuildProgram=l}_isRenderingStateCompiled(t){const i=t;return!!this._gl.getProgramParameter(i.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)&&(this._finalizePipelineContext(i),!0)}_executeWhenRenderingStateIsCompiled(t,i){const n=t;if(!n.isParallelCompiled)return void i();const s=n.onCompiled;n.onCompiled=s?()=>{s(),i()}:i}getUniforms(t,i){const n=new Array,s=t;for(let a=0;a<i.length;a++)n.push(this._gl.getUniformLocation(s.program,i[a]));return n}getAttributes(t,i){const n=[],s=t;for(let a=0;a<i.length;a++)try{n.push(this._gl.getAttribLocation(s.program,i[a]))}catch(o){n.push(-1)}return n}enableEffect(t){(t=null!==t&&Qs.IsWrapper(t)?t.effect:t)&&t!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(t),this._currentEffect=t,t.onBind&&t.onBind(t),t._onBindObservable&&t._onBindObservable.notifyObservers(t))}setInt(t,i){return!!t&&(this._gl.uniform1i(t,i),!0)}setInt2(t,i,n){return!!t&&(this._gl.uniform2i(t,i,n),!0)}setInt3(t,i,n,s){return!!t&&(this._gl.uniform3i(t,i,n,s),!0)}setInt4(t,i,n,s,a){return!!t&&(this._gl.uniform4i(t,i,n,s,a),!0)}setIntArray(t,i){return!!t&&(this._gl.uniform1iv(t,i),!0)}setIntArray2(t,i){return!(!t||i.length%2!=0||(this._gl.uniform2iv(t,i),0))}setIntArray3(t,i){return!(!t||i.length%3!=0||(this._gl.uniform3iv(t,i),0))}setIntArray4(t,i){return!(!t||i.length%4!=0||(this._gl.uniform4iv(t,i),0))}setUInt(t,i){return!!t&&(this._gl.uniform1ui(t,i),!0)}setUInt2(t,i,n){return!!t&&(this._gl.uniform2ui(t,i,n),!0)}setUInt3(t,i,n,s){return!!t&&(this._gl.uniform3ui(t,i,n,s),!0)}setUInt4(t,i,n,s,a){return!!t&&(this._gl.uniform4ui(t,i,n,s,a),!0)}setUIntArray(t,i){return!!t&&(this._gl.uniform1uiv(t,i),!0)}setUIntArray2(t,i){return!(!t||i.length%2!=0||(this._gl.uniform2uiv(t,i),0))}setUIntArray3(t,i){return!(!t||i.length%3!=0||(this._gl.uniform3uiv(t,i),0))}setUIntArray4(t,i){return!(!t||i.length%4!=0||(this._gl.uniform4uiv(t,i),0))}setArray(t,i){return!(!t||i.length<1||(this._gl.uniform1fv(t,i),0))}setArray2(t,i){return!(!t||i.length%2!=0||(this._gl.uniform2fv(t,i),0))}setArray3(t,i){return!(!t||i.length%3!=0||(this._gl.uniform3fv(t,i),0))}setArray4(t,i){return!(!t||i.length%4!=0||(this._gl.uniform4fv(t,i),0))}setMatrices(t,i){return!!t&&(this._gl.uniformMatrix4fv(t,!1,i),!0)}setMatrix3x3(t,i){return!!t&&(this._gl.uniformMatrix3fv(t,!1,i),!0)}setMatrix2x2(t,i){return!!t&&(this._gl.uniformMatrix2fv(t,!1,i),!0)}setFloat(t,i){return!!t&&(this._gl.uniform1f(t,i),!0)}setFloat2(t,i,n){return!!t&&(this._gl.uniform2f(t,i,n),!0)}setFloat3(t,i,n,s){return!!t&&(this._gl.uniform3f(t,i,n,s),!0)}setFloat4(t,i,n,s,a){return!!t&&(this._gl.uniform4f(t,i,n,s,a),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const t=this._colorWrite;this._gl.colorMask(t,t,t,t)}}setColorWrite(t){t!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=t)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),t&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(t,i){const n=this._gl;let s=n.NEAREST,a=n.NEAREST;switch(t){case 11:s=n.LINEAR,a=i?n.LINEAR_MIPMAP_NEAREST:n.LINEAR;break;case 3:s=n.LINEAR,a=i?n.LINEAR_MIPMAP_LINEAR:n.LINEAR;break;case 8:s=n.NEAREST,a=i?n.NEAREST_MIPMAP_LINEAR:n.NEAREST;break;case 4:s=n.NEAREST,a=i?n.NEAREST_MIPMAP_NEAREST:n.NEAREST;break;case 5:s=n.NEAREST,a=i?n.LINEAR_MIPMAP_NEAREST:n.LINEAR;break;case 6:s=n.NEAREST,a=i?n.LINEAR_MIPMAP_LINEAR:n.LINEAR;break;case 7:s=n.NEAREST,a=n.LINEAR;break;case 1:s=n.NEAREST,a=n.NEAREST;break;case 9:s=n.LINEAR,a=i?n.NEAREST_MIPMAP_NEAREST:n.NEAREST;break;case 10:s=n.LINEAR,a=i?n.NEAREST_MIPMAP_LINEAR:n.NEAREST;break;case 2:s=n.LINEAR,a=n.LINEAR;break;case 12:s=n.LINEAR,a=n.NEAREST}return{min:a,mag:s}}_createTexture(){const t=this._gl.createTexture();if(!t)throw new Error("Unable to create texture");return t}_createHardwareTexture(){return new $b(this._createTexture(),this._gl)}_createInternalTexture(t,i,n=!0,s=vt.Unknown){var a;let f,o=!1,l=0,c=3,u=5,h=!1,d=1;void 0!==i&&"object"==typeof i?(o=!!i.generateMipMaps,l=void 0===i.type?0:i.type,c=void 0===i.samplingMode?3:i.samplingMode,u=void 0===i.format?5:i.format,h=void 0!==i.useSRGBBuffer&&i.useSRGBBuffer,d=null!==(a=i.samples)&&void 0!==a?a:1,f=i.label):o=!!i,h&&(h=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1===l&&!this._caps.textureFloatLinearFiltering||2===l&&!this._caps.textureHalfFloatLinearFiltering)&&(c=1),1===l&&!this._caps.textureFloat&&(l=0,H.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const p=this._gl,g=new hi(this,s),_=t.width||t,m=t.height||t,T=t.layers||0,v=this._getSamplingParameters(c,o),A=0!==T?p.TEXTURE_2D_ARRAY:p.TEXTURE_2D,S=this._getRGBABufferInternalSizedFormat(l,u,h),x=this._getInternalFormat(u),C=this._getWebGLTextureType(l);return this._bindTextureDirectly(A,g),0!==T?(g.is2DArray=!0,p.texImage3D(A,0,S,_,m,T,0,x,C,null)):p.texImage2D(A,0,S,_,m,0,x,C,null),p.texParameteri(A,p.TEXTURE_MAG_FILTER,v.mag),p.texParameteri(A,p.TEXTURE_MIN_FILTER,v.min),p.texParameteri(A,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(A,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),o&&this._gl.generateMipmap(A),this._bindTextureDirectly(A,null),g._useSRGBBuffer=h,g.baseWidth=_,g.baseHeight=m,g.width=_,g.height=m,g.depth=T,g.isReady=!0,g.samples=d,g.generateMipMaps=o,g.samplingMode=c,g.type=l,g.format=u,g.label=f,this._internalTexturesCache.push(g),g}_getUseSRGBBuffer(t,i){return t&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||i)}_createTextureBase(t,i,n,s,a=3,o=null,l=null,c,u,h=null,d=null,f=null,p=null,g,_,m){const T="data:"===(t=t||"").substr(0,5),v="blob:"===t.substr(0,5),A=T&&-1!==t.indexOf(";base64,"),S=d||new hi(this,vt.Url);S!==d&&(S.label=t.substring(0,60));const x=t;this._transformTextureUrl&&!A&&!d&&!h&&(t=this._transformTextureUrl(t)),x!==t&&(S._originalUrl=x);const C=t.lastIndexOf(".");let R=p||(C>-1?t.substring(C).toLowerCase():""),D=null;R.indexOf("?")>-1&&(R=R.split("?")[0]);for(const X of r._TextureLoaders)if(X.canLoad(R,g)){D=X;break}s&&s.addPendingData(S),S.url=t,S.generateMipMaps=!i,S.samplingMode=a,S.invertY=n,S._useSRGBBuffer=this._getUseSRGBBuffer(!!m,i),this._doNotHandleContextLost||(S._buffer=h);let N=null;o&&!d&&(N=S.onLoadedObservable.add(o)),d||this._internalTexturesCache.push(S);const k=(X,ne)=>{s&&s.removePendingData(S),t===x?(N&&S.onLoadedObservable.remove(N),Je.UseFallbackTexture&&this._createTextureBase(Je.FallbackTexture,i,S.invertY,s,a,null,l,c,u,h,S),S.onErrorObservable.notifyObservers({message:X=(X||"Unknown error")+(Je.UseFallbackTexture?" - Fallback texture was used":""),exception:ne}),l&&l(X,ne)):(H.Warn(`Failed to load ${t}, falling back to ${x}`),this._createTextureBase(x,i,S.invertY,s,a,o,l,c,u,h,S,f,p,g,_,m))};if(D){const X=ne=>{D.loadData(ne,S,(ge,ue,ke,me,$,Q)=>{Q?k("TextureLoader failed to load data"):c(S,R,s,{width:ge,height:ue},S.invertY,!ke,me,()=>($(),!1),a)},_)};h?h instanceof ArrayBuffer?X(new Uint8Array(h)):ArrayBuffer.isView(h)?X(h):l&&l("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,ne=>X(new Uint8Array(ne)),void 0,s?s.offlineProvider:void 0,!0,(ne,ge)=>{k("Unable to load "+ge)})}else{const X=ne=>{v&&!this._doNotHandleContextLost&&(S._buffer=ne),c(S,R,s,ne,S.invertY,i,!1,u,a)};!T||A?h&&("string"==typeof h.decoding||h.close)?X(h):r._FileToolsLoadImage(t,X,k,s?s.offlineProvider:null,g,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof h||h instanceof ArrayBuffer||ArrayBuffer.isView(h)||h instanceof Blob?r._FileToolsLoadImage(h,X,k,s?s.offlineProvider:null,g,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):h&&X(h)}return S}createTexture(t,i,n,s,a=3,o=null,l=null,c=null,u=null,h=null,d=null,f,p,g,_){return this._createTextureBase(t,i,n,s,a,o,l,this._prepareWebGLTexture.bind(this),(m,T,v,A,S,x)=>{const C=this._gl,R=v.width===m&&v.height===T,D=h?this._getInternalFormat(h,S._useSRGBBuffer):".jpg"!==A||S._useSRGBBuffer?S._useSRGBBuffer?C.SRGB8_ALPHA8:C.RGBA:C.RGB;let P=h?this._getInternalFormat(h):".jpg"!==A||S._useSRGBBuffer?C.RGBA:C.RGB;if(S._useSRGBBuffer&&1===this.webGLVersion&&(P=D),R)return C.texImage2D(C.TEXTURE_2D,0,D,P,C.UNSIGNED_BYTE,v),!1;const N=this._caps.maxTextureSize;if(v.width>N||v.height>N||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=m,this._workingCanvas.height=T,this._workingContext.drawImage(v,0,0,v.width,v.height,0,0,m,T),C.texImage2D(C.TEXTURE_2D,0,D,P,C.UNSIGNED_BYTE,this._workingCanvas),S.width=m,S.height=T),!1;{const k=new hi(this,vt.Temp);this._bindTextureDirectly(C.TEXTURE_2D,k,!0),C.texImage2D(C.TEXTURE_2D,0,D,P,C.UNSIGNED_BYTE,v),this._rescaleTexture(k,S,s,D,()=>{this._releaseTexture(k),this._bindTextureDirectly(C.TEXTURE_2D,S,!0),x()})}return!0},c,u,h,d,f,p,_)}static _FileToolsLoadImage(t,i,n,s,a,o){throw ht("FileTools")}_rescaleTexture(t,i,n,s,a){}createRawTexture(t,i,n,s,a,o,l,c=null,u=0,h=0,d=!1){throw ht("Engine.RawTexture")}createRawCubeTexture(t,i,n,s,a,o,l,c=null){throw ht("Engine.RawTexture")}createRawTexture3D(t,i,n,s,a,o,l,c,u=null,h=0){throw ht("Engine.RawTexture")}createRawTexture2DArray(t,i,n,s,a,o,l,c,u=null,h=0){throw ht("Engine.RawTexture")}_unpackFlipY(t){this._unpackFlipYCached!==t&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,t?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=t))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(t){return t.isCube?this._gl.TEXTURE_CUBE_MAP:t.is3D?this._gl.TEXTURE_3D:t.is2DArray||t.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(t,i,n=!1){const s=this._getTextureTarget(i),a=this._getSamplingParameters(t,i.useMipMaps||n);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,a.mag,i),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,a.min),n&&(i.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),i.samplingMode=t}updateTextureDimensions(t,i,n,s=1){}updateTextureWrappingMode(t,i,n=null,s=null){const a=this._getTextureTarget(t);null!==i&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i),t),t._cachedWrapU=i),null!==n&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(n),t),t._cachedWrapV=n),(t.is2DArray||t.is3D)&&null!==s&&(this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),t),t._cachedWrapR=s),this._bindTextureDirectly(a,null)}_setupDepthStencilTexture(t,i,n,s,a,o=1){const l=i.width||i,c=i.height||i,u=i.layers||0;t.baseWidth=l,t.baseHeight=c,t.width=l,t.height=c,t.is2DArray=u>0,t.depth=u,t.isReady=!0,t.samples=o,t.generateMipMaps=!1,t.samplingMode=s?2:1,t.type=0,t._comparisonFunction=a;const h=this._gl,d=this._getTextureTarget(t),f=this._getSamplingParameters(t.samplingMode,!1);h.texParameteri(d,h.TEXTURE_MAG_FILTER,f.mag),h.texParameteri(d,h.TEXTURE_MIN_FILTER,f.min),h.texParameteri(d,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(d,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===a?(h.texParameteri(d,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(d,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(d,h.TEXTURE_COMPARE_FUNC,a),h.texParameteri(d,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(t,i,n,s,a,o=0,l=0){const c=this._gl;let u=c.TEXTURE_2D;if(t.isCube&&(u=c.TEXTURE_CUBE_MAP_POSITIVE_X+o),t._useSRGBBuffer)switch(i){case 37492:case 36196:this._caps.etc2?i=c.COMPRESSED_SRGB8_ETC2:t._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?i=c.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t._useSRGBBuffer=!1;break;case 36492:i=c.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:i=c.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?i=c.COMPRESSED_SRGB_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?i=c.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:t._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?i=c.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:t._useSRGBBuffer=!1;break;default:t._useSRGBBuffer=!1}this._gl.compressedTexImage2D(u,l,i,n,s,0,a)}_uploadDataToTextureDirectly(t,i,n=0,s=0,a,o=!1){const l=this._gl,c=this._getWebGLTextureType(t.type),u=this._getInternalFormat(t.format),h=void 0===a?this._getRGBABufferInternalSizedFormat(t.type,t.format,t._useSRGBBuffer):this._getInternalFormat(a,t._useSRGBBuffer);this._unpackFlipY(t.invertY);let d=l.TEXTURE_2D;t.isCube&&(d=l.TEXTURE_CUBE_MAP_POSITIVE_X+n);const f=Math.round(Math.log(t.width)*Math.LOG2E),p=Math.round(Math.log(t.height)*Math.LOG2E),g=o?t.width:Math.pow(2,Math.max(f-s,0)),_=o?t.height:Math.pow(2,Math.max(p-s,0));l.texImage2D(d,s,h,g,_,0,u,c,i)}updateTextureData(t,i,n,s,a,o,l=0,c=0,u=!1){const h=this._gl,d=this._getWebGLTextureType(t.type),f=this._getInternalFormat(t.format);this._unpackFlipY(t.invertY);let p=h.TEXTURE_2D,g=h.TEXTURE_2D;t.isCube&&(g=h.TEXTURE_CUBE_MAP_POSITIVE_X+l,p=h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(p,t,!0),h.texSubImage2D(g,c,n,s,a,o,f,d,i),u&&this._gl.generateMipmap(g),this._bindTextureDirectly(p,null)}_uploadArrayBufferViewToTexture(t,i,n=0,s=0){const a=this._gl,o=t.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(o,t,!0),this._uploadDataToTextureDirectly(t,i,n,s),this._bindTextureDirectly(o,null,!0)}_prepareWebGLTextureContinuation(t,i,n,s,a){const o=this._gl;if(!o)return;const l=this._getSamplingParameters(a,!n);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,l.mag),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,l.min),!n&&!s&&o.generateMipmap(o.TEXTURE_2D),this._bindTextureDirectly(o.TEXTURE_2D,null),i&&i.removePendingData(t),t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear()}_prepareWebGLTexture(t,i,n,s,a,o,l,c,u=3){const h=this.getCaps().maxTextureSize,d=Math.min(h,this.needPOTTextures?r.GetExponentOfTwo(s.width,h):s.width),f=Math.min(h,this.needPOTTextures?r.GetExponentOfTwo(s.height,h):s.height),p=this._gl;if(p){if(!t._hardwareTexture)return void(n&&n.removePendingData(t));this._bindTextureDirectly(p.TEXTURE_2D,t,!0),this._unpackFlipY(void 0===a||!!a),t.baseWidth=s.width,t.baseHeight=s.height,t.width=d,t.height=f,t.isReady=!0,!c(d,f,s,i,t,()=>{this._prepareWebGLTextureContinuation(t,n,o,l,u)})&&this._prepareWebGLTextureContinuation(t,n,o,l,u)}}_setupFramebufferDepthAttachments(t,i,n,s,a=1){const o=this._gl;if(t&&i)return this._createRenderBuffer(n,s,a,o.DEPTH_STENCIL,o.DEPTH24_STENCIL8,o.DEPTH_STENCIL_ATTACHMENT);if(i){let l=o.DEPTH_COMPONENT16;return this._webGLVersion>1&&(l=o.DEPTH_COMPONENT32F),this._createRenderBuffer(n,s,a,l,l,o.DEPTH_ATTACHMENT)}return t?this._createRenderBuffer(n,s,a,o.STENCIL_INDEX8,o.STENCIL_INDEX8,o.STENCIL_ATTACHMENT):null}_createRenderBuffer(t,i,n,s,a,o,l=!0){const u=this._gl.createRenderbuffer();return this._updateRenderBuffer(u,t,i,n,s,a,o,l)}_updateRenderBuffer(t,i,n,s,a,o,l,c=!0){const u=this._gl;return u.bindRenderbuffer(u.RENDERBUFFER,t),s>1&&u.renderbufferStorageMultisample?u.renderbufferStorageMultisample(u.RENDERBUFFER,s,o,i,n):u.renderbufferStorage(u.RENDERBUFFER,a,i,n),u.framebufferRenderbuffer(u.FRAMEBUFFER,l,u.RENDERBUFFER,t),c&&u.bindRenderbuffer(u.RENDERBUFFER,null),t}_releaseTexture(t){var i;this._deleteTexture(null===(i=t._hardwareTexture)||void 0===i?void 0:i.underlyingResource),this.unbindAllTextures();const n=this._internalTexturesCache.indexOf(t);-1!==n&&this._internalTexturesCache.splice(n,1),t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureLow&&t._lodTextureLow.dispose(),t._irradianceTexture&&t._irradianceTexture.dispose()}_releaseRenderTargetWrapper(t){const i=this._renderTargetWrapperCache.indexOf(t);-1!==i&&this._renderTargetWrapperCache.splice(i,1)}_deleteTexture(t){t&&this._gl.deleteTexture(t)}_setProgram(t){this._currentProgram!==t&&(this._gl.useProgram(t),this._currentProgram=t)}bindSamplers(t){const i=t.getPipelineContext();this._setProgram(i.program);const n=t.getSamplers();for(let s=0;s<n.length;s++){const a=t.getUniform(n[s]);a&&(this._boundUniforms[s]=a)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(t,i,n=!1,s=!1){var a,o;let l=!1;const c=i&&i._associatedChannel>-1;if(n&&c&&(this._activeChannel=i._associatedChannel),this._boundTexturesCache[this._activeChannel]!==i||s){if(this._activateCurrentTexture(),i&&i.isMultiview)throw console.error(t,i),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(t,null!==(o=null===(a=null==i?void 0:i._hardwareTexture)||void 0===a?void 0:a.underlyingResource)&&void 0!==o?o:null),this._boundTexturesCache[this._activeChannel]=i,i&&(i._associatedChannel=this._activeChannel)}else n&&(l=!0,this._activateCurrentTexture());return c&&!n&&this._bindSamplerUniformToChannel(i._associatedChannel,this._activeChannel),l}_bindTexture(t,i,n){if(void 0===t)return;i&&(i._associatedChannel=t),this._activeChannel=t;const s=i?this._getTextureTarget(i):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,i)}unbindAllTextures(){for(let t=0;t<this._maxSimultaneousTextures;t++)this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(t,i,n,s){void 0!==t&&(i&&(this._boundUniforms[t]=i),this._setTexture(t,n))}_bindSamplerUniformToChannel(t,i){const n=this._boundUniforms[t];!n||n._currentState===i||(this._gl.uniform1i(n,i),n._currentState=i)}_getTextureWrapMode(t){switch(t){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(t,i,n=!1,s=!1,a=""){if(!i)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(i.video)this._activeChannel=t,i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let o;o=s?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!n&&o&&(o._associatedChannel=t);let l=!0;this._boundTexturesCache[t]===o&&(n||this._bindSamplerUniformToChannel(o._associatedChannel,t),l=!1),this._activeChannel=t;const c=this._getTextureTarget(o);if(l&&this._bindTextureDirectly(c,o,n),o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==i.coordinatesMode){o._cachedCoordinatesMode=i.coordinatesMode;const u=3!==i.coordinatesMode&&5!==i.coordinatesMode?1:0;i.wrapU=u,i.wrapV=u}o._cachedWrapU!==i.wrapU&&(o._cachedWrapU=i.wrapU,this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(i.wrapU),o)),o._cachedWrapV!==i.wrapV&&(o._cachedWrapV=i.wrapV,this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i.wrapV),o)),o.is3D&&o._cachedWrapR!==i.wrapR&&(o._cachedWrapR=i.wrapR,this._setTextureParameterInteger(c,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i.wrapR),o)),this._setAnisotropicLevel(c,o,i.anisotropicFilteringLevel)}return!0}setTextureArray(t,i,n,s){if(void 0!==t&&i){(!this._textureUnits||this._textureUnits.length!==n.length)&&(this._textureUnits=new Int32Array(n.length));for(let a=0;a<n.length;a++){const o=n[a].getInternalTexture();o?(this._textureUnits[a]=t+a,o._associatedChannel=t+a):this._textureUnits[a]=-1}this._gl.uniform1iv(i,this._textureUnits);for(let a=0;a<n.length;a++)this._setTexture(this._textureUnits[a],n[a],!0)}}_setAnisotropicLevel(t,i,n){const s=this._caps.textureAnisotropicFilterExtension;11!==i.samplingMode&&3!==i.samplingMode&&2!==i.samplingMode&&(n=1),s&&i._cachedAnisotropicFilteringLevel!==n&&(this._setTextureParameterFloat(t,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n,this._caps.maxAnisotropy),i),i._cachedAnisotropicFilteringLevel=n)}_setTextureParameterFloat(t,i,n,s){this._bindTextureDirectly(t,s,!0,!0),this._gl.texParameterf(t,i,n)}_setTextureParameterInteger(t,i,n,s){s&&this._bindTextureDirectly(t,s,!0,!0),this._gl.texParameteri(t,i,n)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let t=0;t<this._caps.maxVertexAttribs;t++)this.disableAttributeByIndex(t)}else for(let t=0,i=this._vertexAttribArraysEnabled.length;t<i;t++)t>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[t]||this.disableAttributeByIndex(t)}releaseEffects(){for(const t in this._compiledEffects){const i=this._compiledEffects[t].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}}dispose(){var t;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),null===(t=this.releaseComputeEffects)||void 0===t||t.call(this),this.unbindAllAttributes(),this._boundUniforms={},rn()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Si.ResetCache();for(const i of this._activeRequests)i.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",t,!1)}attachContextRestoredEvent(t){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",t,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(t){const i=this._gl;for(;i.getError()!==i.NO_ERROR;);let n=!0;const s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(t),1,1,0,i.RGBA,this._getWebGLTextureType(t),null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const a=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(n=n&&o===i.FRAMEBUFFER_COMPLETE,n=n&&i.getError()===i.NO_ERROR,n&&(i.clear(i.COLOR_BUFFER_BIT),n=n&&i.getError()===i.NO_ERROR),n){i.bindFramebuffer(i.FRAMEBUFFER,null);const l=i.RGBA,c=i.UNSIGNED_BYTE,u=new Uint8Array(4);i.readPixels(0,0,1,1,l,c,u),n=n&&i.getError()===i.NO_ERROR}for(i.deleteTexture(s),i.deleteFramebuffer(a),i.bindFramebuffer(i.FRAMEBUFFER,null);!n&&i.getError()!==i.NO_ERROR;);return n}_getWebGLTextureType(t){if(1===this._webGLVersion){switch(t){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(t){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(t,i=!1){let n=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(t){case 0:n=this._gl.ALPHA;break;case 1:n=this._gl.LUMINANCE;break;case 2:n=this._gl.LUMINANCE_ALPHA;break;case 6:n=this._gl.RED;break;case 7:n=this._gl.RG;break;case 4:n=i?this._gl.SRGB:this._gl.RGB;break;case 5:n=i?this._gl.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(t){case 8:n=this._gl.RED_INTEGER;break;case 9:n=this._gl.RG_INTEGER;break;case 10:n=this._gl.RGB_INTEGER;break;case 11:n=this._gl.RGBA_INTEGER}return n}_getRGBABufferInternalSizedFormat(t,i,n=!1){if(1===this._webGLVersion){if(void 0!==i)switch(i){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return n?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(t){case 3:switch(i){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(i){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return n?this._gl.SRGB8:this._gl.RGB8;case 5:return n?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(i){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(i){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(i){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(i){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(i){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(i){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(i){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return n?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(t){return 1===t?this._gl.RGBA32F:2===t?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(t,i,n,s,a,o){const l=r._FileToolsLoadFile(t,i,n,s,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}static _FileToolsLoadFile(t,i,n,s,a,o){throw ht("FileTools")}readPixels(t,i,n,s,a=!0,o=!0){const c=a?this._gl.RGBA:this._gl.RGB,u=new Uint8Array(s*n*(a?4:3));return o&&this.flushFramebuffer(),this._gl.readPixels(t,i,n,s,c,this._gl.UNSIGNED_BYTE,u),Promise.resolve(u)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const t=this._CreateCanvas(1,1),i=t.getContext("webgl")||t.getContext("experimental-webgl");this._IsSupported=null!=i&&!!window.WebGLRenderingContext}catch(t){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const t=this._CreateCanvas(1,1),i=t.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||t.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!i}catch(t){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}static FloorPOT(t){return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,(t|=t>>16)-(t>>1)}static NearestPOT(t){const i=r.CeilingPOT(t),n=r.FloorPOT(t);return i-t>t-n?n:i}static GetExponentOfTwo(t,i,n=2){let s;switch(n){case 1:s=r.FloorPOT(t);break;case 2:s=r.NearestPOT(t);break;default:s=r.CeilingPOT(t)}return Math.min(s,i)}static QueueNewFrame(t,i){if(rn()){const{requestPostAnimationFrame:n,requestAnimationFrame:s}=i||window;if("function"==typeof n)return n(t);if("function"==typeof s)return s(t)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(t);return setTimeout(t,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:dh()?document:null}}return r.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],r._TextureLoaders=[],r.CollisionsEpsilon=.001,r._IsSupported=null,r._HasMajorPerformanceCaveat=null,r})();class Nc{static SetImmediate(e){rn()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const Qb=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class Pf extends xa{constructor(e,t){super(e,4e3),this.name="LoadFileError",Fc._setPrototypeOf(this,Pf.prototype),t instanceof Kn?this.request=t:this.file=t}}class wf extends xa{constructor(e,t){super(e,4001),this.request=t,this.name="RequestFileError",Fc._setPrototypeOf(this,wf.prototype)}}class tT extends xa{constructor(e,t){super(e,4002),this.file=t,this.name="ReadFileError",Fc._setPrototypeOf(this,tT.prototype)}}const Xn={DefaultRetryStrategy:class Az{static ExponentialBackoff(e=3,t=500){return(i,n,s)=>0!==n.status||s>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,s)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:r=>r},Zb=r=>r.replace(/#/gm,"%23"),iT=(r,e)=>{if((!r||0!==r.indexOf("data:"))&&Xn.CorsBehavior)if("string"==typeof Xn.CorsBehavior||Xn.CorsBehavior instanceof String)e.crossOrigin=Xn.CorsBehavior;else{const t=Xn.CorsBehavior(r);t&&(e.crossOrigin=t)}},Of=(r,e,t,i,n="",s)=>{var a;let o,l=!1;r instanceof ArrayBuffer||ArrayBuffer.isView(r)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(o=URL.createObjectURL(new Blob([r],{type:n})),l=!0):o=`data:${n};base64,`+Zm(r):r instanceof Blob?(o=URL.createObjectURL(r),l=!0):(o=Zb(r),o=Xn.PreprocessUrl(r));const c=Je.LastCreatedEngine,u=x=>{if(t){const C=o||r.toString();t(`Error while trying to load image: ${0===C.indexOf("http")||C.length<=128?C:C.slice(0,128)+"..."}`,x)}};if("undefined"==typeof Image||null!==(a=null==c?void 0:c._features.forceBitmapOverHTMLImageElement)&&void 0!==a&&a)return Bo(o,x=>{c.createImageBitmap(new Blob([x],{type:n}),Mi({premultiplyAlpha:"none"},s)).then(C=>{e(C),l&&URL.revokeObjectURL(o)}).catch(C=>{t&&t("Error while trying to load image: "+r,C)})},void 0,i||void 0,!0,(x,C)=>{u(C)}),null;const h=new Image;iT(o,h);const d=[],p=()=>{d.forEach(x=>{x.target.removeEventListener(x.name,x.handler)}),d.length=0};d.push({target:h,name:"load",handler:()=>{p(),e(h),l&&h.src&&URL.revokeObjectURL(h.src)}}),d.push({target:h,name:"error",handler:x=>{p(),u(x),l&&h.src&&URL.revokeObjectURL(h.src)}}),d.push({target:document,name:"securitypolicyviolation",handler:x=>{if(x.blockedURI!==h.src)return;p();const C=new Error(`CSP violation of policy ${x.effectiveDirective} ${x.blockedURI}. Current policy is ${x.originalPolicy}`);Je.UseFallbackTexture=!1,u(C),l&&h.src&&URL.revokeObjectURL(h.src),h.src=""}}),d.forEach(x=>{x.target.addEventListener(x.name,x.handler)});const T="blob:"===o.substring(0,5),v="data:"===o.substring(0,5),A=()=>{T||v?h.src=o:Bo(o,(x,C,R)=>{const P=new Blob([x],{type:!n&&R?R:n}),N=URL.createObjectURL(P);l=!0,h.src=N},void 0,i||void 0,!0,(x,C)=>{u(C)})};if(!T&&!v&&i&&i.enableTexturesOffline)i.open(()=>{i&&i.loadImage(o,h)},A);else{if(-1!==o.indexOf("file:")){const x=decodeURIComponent(o.substring(5).toLowerCase());if(Rf.FilesToLoad[x]&&"undefined"!=typeof URL){try{let C;try{C=URL.createObjectURL(Rf.FilesToLoad[x])}catch(R){C=URL.createObjectURL(Rf.FilesToLoad[x])}h.src=C,l=!0}catch(C){h.src=""}return h}}A()}return h},_h=(r,e,t,i,n)=>{const s=new FileReader,a={onCompleteObservable:new J,abort:()=>s.abort()};return s.onloadend=()=>a.onCompleteObservable.notifyObservers(a),n&&(s.onerror=()=>{n(new tT(`Unable to read ${r.name}`,r))}),s.onload=o=>{e(o.target.result)},t&&(s.onprogress=t),i?s.readAsArrayBuffer(r):s.readAsText(r),a},Bo=(r,e,t,i,n,s,a)=>{if(r.name)return _h(r,e,t,n,s?u=>{s(void 0,u)}:void 0);const o=r;if(-1!==o.indexOf("file:")){let u=decodeURIComponent(o.substring(5).toLowerCase());0===u.indexOf("./")&&(u=u.substring(2));const h=Rf.FilesToLoad[u];if(h)return _h(h,e,t,n,s?d=>s(void 0,new Pf(d.message,d.file)):void 0)}const{match:l,type:c}=Gz(o);if(l){const u={onCompleteObservable:new J,abort:()=>()=>{}};try{const h=n?sT(o):Jb(o);e(h,void 0,c)}catch(h){s?s(void 0,h):H.Error(h.message||"Failed to parse the Data URL")}return Nc.SetImmediate(()=>{u.onCompleteObservable.notifyObservers(u)}),u}return nT(o,(u,h)=>{e(u,null==h?void 0:h.responseURL,null==h?void 0:h.getResponseHeader("content-type"))},t,i,n,s?u=>{s(u.request,new Pf(u.message,u.request))}:void 0,a)},nT=(r,e,t,i,n,s,a)=>{r=Zb(r),r=Xn.PreprocessUrl(r);const o=Xn.BaseUrl+r;let l=!1;const c={onCompleteObservable:new J,abort:()=>l=!0},u=()=>{let f,h=new Kn,d=null;const p=()=>{!h||(t&&h.removeEventListener("progress",t),f&&h.removeEventListener("readystatechange",f),h.removeEventListener("loadend",g))};let g=()=>{p(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,f=null,g=null,s=void 0,a=void 0,e=void 0};c.abort=()=>{l=!0,g&&g(),h&&h.readyState!==(XMLHttpRequest.DONE||4)&&h.abort(),null!==d&&(clearTimeout(d),d=null),h=null};const _=T=>{const v=T.message||"Unknown error";s&&h?s(new wf(v,h)):H.Error(v)},m=T=>{if(h){if(h.open("GET",o),a)try{a(h)}catch(v){return void _(v)}n&&(h.responseType="arraybuffer"),t&&h.addEventListener("progress",t),g&&h.addEventListener("loadend",g),f=()=>{if(!l&&h&&h.readyState===(XMLHttpRequest.DONE||4)){if(f&&h.removeEventListener("readystatechange",f),h.status>=200&&h.status<300||0===h.status&&(!rn()||qb())){try{e&&e(n?h.response:h.responseText,h)}catch(S){_(S)}return}const v=Xn.DefaultRetryStrategy;if(v){const S=v(o,h,T);if(-1!==S)return p(),h=new Kn,void(d=setTimeout(()=>m(T+1),S))}const A=new wf("Error status: "+h.status+" "+h.statusText+" - Unable to load "+o,h);s&&s(A)}},h.addEventListener("readystatechange",f),h.send()}};m(0)};if(i&&i.enableSceneOffline){const h=f=>{f&&f.status>400?s&&s(f):u()},d=()=>{i&&i.loadFile(Xn.BaseUrl+r,f=>{!l&&e&&e(f),c.onCompleteObservable.notifyObservers(c)},t?f=>{!l&&t&&t(f)}:void 0,h,n)};i.open(d,h)}else u();return c},qb=()=>"undefined"!=typeof location&&"file:"===location.protocol,rT=r=>Qb.test(r),Gz=r=>{const e=Qb.exec(r);return null===e||0===e.length?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function sT(r){return(r=>{const e=qm(r),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let n=0;n<t;n++)i[n]=e.charCodeAt(n);return i.buffer})(r.split(",")[1])}const Jb=r=>qm(r.split(",")[1]);let mh;var t;Ze._FileToolsLoadImage=Of,Ze._FileToolsLoadFile=Bo,Aa._FileToolsLoadFile=Bo,mh={DecodeBase64UrlToBinary:sT,DecodeBase64UrlToString:Jb,DefaultRetryStrategy:(t=Xn).DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:rT,IsFileURL:qb,LoadFile:Bo,LoadImage:Of,ReadFile:_h,RequestFile:nT,SetCorsBehavior:iT},Object.defineProperty(mh,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(u){t.DefaultRetryStrategy=u}}),Object.defineProperty(mh,"BaseUrl",{get:function(){return t.BaseUrl},set:function(u){t.BaseUrl=u}}),Object.defineProperty(mh,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(u){t.PreprocessUrl=u}}),Object.defineProperty(mh,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(u){t.CorsBehavior=u}});let Ff=(()=>{class r{static Instantiate(t){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[t])return this.RegisteredExternalClasses[t];const i=zr(t);if(i)return i;H.Warn(t+" not found, you may have missed an import.");const n=t.split(".");let s=window||this;for(let a=0,o=n.length;a<o;a++)s=s[n[a]];return"function"!=typeof s?null:s}}return r.RegisteredExternalClasses={},r})();function Nf(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const e=16*Math.random()|0;return("x"===r?e:3&e|8).toString(16)})}class Ie{static get BaseUrl(){return Xn.BaseUrl}static set BaseUrl(e){Xn.BaseUrl=e}static get DefaultRetryStrategy(){return Xn.DefaultRetryStrategy}static set DefaultRetryStrategy(e){Xn.DefaultRetryStrategy=e}static get CorsBehavior(){return Xn.CorsBehavior}static set CorsBehavior(e){Xn.CorsBehavior=e}static get UseFallbackTexture(){return Je.UseFallbackTexture}static set UseFallbackTexture(e){Je.UseFallbackTexture=e}static get RegisteredExternalClasses(){return Ff.RegisteredExternalClasses}static set RegisteredExternalClasses(e){Ff.RegisteredExternalClasses=e}static get fallbackTexture(){return Je.FallbackTexture}static set fallbackTexture(e){Je.FallbackTexture=e}static FetchToRef(e,t,i,n,s,a){const c=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*n%n|0)*i);a.r=s[c]/255,a.g=s[c+1]/255,a.b=s[c+2]/255,a.a=s[c+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return Ff.Instantiate(e)}static SetImmediate(e){Nc.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do{t*=2}while(t<e);return t===e}static FloatRound(e){return Math.fround?Math.fround(e):(Ie._TmpFloatArray[0]=e,Ie._TmpFloatArray[0])}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const n=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(s)+i*Math.sin(n),(1-i)*Math.cos(s)+i*Math.cos(n)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){let t="pointer";return rn()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){iT(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e.replace(/#/gm,"%23")}static get PreprocessUrl(){return Xn.PreprocessUrl}static set PreprocessUrl(e){Xn.PreprocessUrl=e}static LoadImage(e,t,i,n,s,a){return Of(e,t,i,n,s,a)}static LoadFile(e,t,i,n,s,a){return Bo(e,t,i,n,s,a)}static LoadFileAsync(e,t=!0){return new Promise((i,n)=>{Bo(e,s=>{i(s)},void 0,void 0,t,(s,a)=>{n(a)})})}static LoadScript(e,t,i,n){if("function"==typeof importScripts){try{importScripts(e),t()}catch(o){null==i||i(`Unable to load script '${e}' in worker`,o)}return}if(!rn())return void(null==i||i(`Cannot load script '${e}' outside of a window or a worker`));const s=document.getElementsByTagName("head")[0],a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",e),n&&(a.id=n),a.onload=()=>{t&&t()},a.onerror=o=>{i&&i(`Unable to load script '${e}'`,o)},s.appendChild(a)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(n,s)=>{i(s||new Error(n))})})}static ReadFileAsDataURL(e,t,i){const n=new FileReader,s={onCompleteObservable:new J,abort:()=>n.abort()};return n.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},n.onload=a=>{t(a.target.result)},n.onprogress=i,n.readAsDataURL(e),s}static ReadFile(e,t,i,n,s){return _h(e,t,i,n,s)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,n){Wr.DeepCopy(e,t,i,n)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const n=t[i];e.addEventListener(n.name,n.handler,!1);try{window.parent&&window.parent.addEventListener(n.name,n.handler,!1)}catch(s){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const n=t[i];e.removeEventListener(n.name,n.handler);try{e.parent&&e.parent.removeEventListener(n.name,n.handler)}catch(s){}}}static DumpFramebuffer(e,t,i,n){return ls(function*(s,a,o,l,c="image/png",u){throw ht("DumpTools")}).apply(this,arguments)}static DumpData(e,t,i,n,s="image/png",a,o=!1,l=!1,c){throw ht("DumpTools")}static DumpDataAsync(e,t,i,n="image/png",s,a=!1,o=!1,l){throw ht("DumpTools")}static ToBlob(e,t,i="image/png",n){e.toBlob||(e.toBlob=function(s,a,o){setTimeout(()=>{const l=atob(this.toDataURL(a,o).split(",")[1]),c=l.length,u=new Uint8Array(c);for(let h=0;h<c;h++)u[h]=l.charCodeAt(h);s(new Blob([u]))})}),e.toBlob(function(s){t(s)},i,n)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+(i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2)+".png"}Ie.Download(e,t)}else if(e&&"undefined"!=typeof URL){const i=URL.createObjectURL(e),n=window.open("");if(!n)return;const s=n.document.createElement("img");s.onload=function(){URL.revokeObjectURL(i)},s.src=i,n.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",n,s){t?t(e.toDataURL(i,s)):this.ToBlob(e,function(a){a&&Ie.DownloadBlob(a,n)},i,s)}static Download(e,t){if("undefined"==typeof URL)return;const i=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=i,n.download=t,n.addEventListener("click",()=>{n.parentElement&&n.parentElement.removeChild(n)}),n.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,n,s="image/png"){throw ht("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,n="image/png"){throw ht("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,n,s="image/png",a=1,o=!1,l){throw ht("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,n="image/png",s=1,a=!1,o){throw ht("ScreenshotTools")}static RandomId(){return Nf()}static IsBase64(e){return rT(e)}static DecodeBase64(e){return sT(e)}static get errorsCount(){return H.errorsCount}static Log(e){H.Log(e)}static Warn(e){H.Warn(e)}static Error(e){H.Error(e)}static get LogCache(){return H.LogCache}static ClearLogCache(){H.ClearLogCache()}static set LogLevels(e){H.LogLevels=e}static set PerformanceLogLevel(e){return(e&Ie.PerformanceUserMarkLogLevel)===Ie.PerformanceUserMarkLogLevel?(Ie.StartPerformanceCounter=Ie._StartUserMark,void(Ie.EndPerformanceCounter=Ie._EndUserMark)):(e&Ie.PerformanceConsoleLogLevel)===Ie.PerformanceConsoleLogLevel?(Ie.StartPerformanceCounter=Ie._StartPerformanceConsole,void(Ie.EndPerformanceCounter=Ie._EndPerformanceConsole)):(Ie.StartPerformanceCounter=Ie._StartPerformanceCounterDisabled,void(Ie.EndPerformanceCounter=Ie._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!Ie._Performance){if(!rn())return;Ie._Performance=window.performance}!t||!Ie._Performance.mark||Ie._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!Ie._Performance.mark||(Ie._Performance.mark(e+"-End"),Ie._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){!t||(Ie._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){!t||(Ie._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Qa.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,n=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const s=t?e:Object.getPrototypeOf(e);i=s.constructor.__bjsclassName__,n=s.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=n?n+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return!!Km()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}Ie.UseCustomRequestHeaders=!1,Ie.CustomRequestHeaders=Kn.CustomRequestHeaders,Ie._TmpFloatArray=new Float32Array(1),Ie.GetDOMTextContent=If,Ie.GetAbsoluteUrl="object"==typeof document?r=>{const e=document.createElement("a");return e.href=r,e.href}:"function"==typeof URL&&"object"==typeof location?r=>new URL(r,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},Ie.NoneLogLevel=H.NoneLogLevel,Ie.MessageLogLevel=H.MessageLogLevel,Ie.WarningLogLevel=H.WarningLogLevel,Ie.ErrorLogLevel=H.ErrorLogLevel,Ie.AllLogLevel=H.AllLogLevel,Ie.IsWindowObjectExist=rn,Ie.PerformanceNoneLogLevel=0,Ie.PerformanceUserMarkLogLevel=1,Ie.PerformanceConsoleLogLevel=2,Ie.StartPerformanceCounter=Ie._StartPerformanceCounterDisabled,Ie.EndPerformanceCounter=Ie._EndPerformanceCounterDisabled;class Is{constructor(e,t,i,n=0){this.iterations=e,this.index=n-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,n=0){const s=new Is(e,t,i,n);return s.executeNext(),s}static SyncAsyncForLoop(e,t,i,n,s,a=0){return Is.Run(Math.ceil(e/t),o=>{s&&s()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const c=o.index*t+l;if(c>=e)break;if(i(c),s&&s()){o.breakLoop();break}}o.executeNext()},a)},n)}}Je.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";let Qn=(()=>{class r{constructor(t){this.length=0,this.data=new Array(t),this._id=r._GlobalId++}push(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2)}forEach(t){for(let i=0;i<this.length;i++)t(this.data[i])}sort(t){this.data.sort(t)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(t){if(0!==t.length){this.length+t.length>this.data.length&&(this.data.length=2*(this.length+t.length));for(let i=0;i<t.length;i++)this.data[this.length++]=(t.data||t)[i]}}indexOf(t){const i=this.data.indexOf(t);return i>=this.length?-1:i}contains(t){return-1!==this.indexOf(t)}}return r._GlobalId=0,r})();class ml extends Qn{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.pushNoDuplicate((e.data||e)[t])}}}class eC{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const n=e(t,this._data[t]);if(n)return n}return null}}let cs=(()=>{class r{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(t,i){this._BabylonFileParsers[t]=i}static GetParser(t){return this._BabylonFileParsers[t]?this._BabylonFileParsers[t]:null}static AddIndividualParser(t,i){this._IndividualBabylonFileParsers[t]=i}static GetIndividualParser(t){return this._IndividualBabylonFileParsers[t]?this._IndividualBabylonFileParsers[t]:null}static Parse(t,i,n,s){for(const a in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,a)&&this._BabylonFileParsers[a](t,i,n,s)}get environmentTexture(){return this._environmentTexture}set environmentTexture(t){this._environmentTexture=t}getNodes(){let t=new Array;return t=t.concat(this.meshes),t=t.concat(this.lights),t=t.concat(this.cameras),t=t.concat(this.transformNodes),this.skeletons.forEach(i=>t=t.concat(i.bones)),t}}return r._BabylonFileParsers={},r._IndividualBabylonFileParsers={},r})();class us{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)-1===this._keys.indexOf(e)&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,n,s,a;const o=null!==(n=null===(i=null===(t=this._externalProperties)||void 0===t?void 0:t[e])||void 0===i?void 0:i.type)&&void 0!==n?n:typeof this[e],l=null===(a=null===(s=this._externalProperties)||void 0===s?void 0:s[e])||void 0===a?void 0:a.default;switch(o){case"number":this[e]=null!=l?l:0;break;case"string":this[e]=null!=l?l:"";break;default:this[e]=null!=l&&l}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],n=this[i];switch(typeof n){case"number":case"string":e+="#define "+i+" "+n+"\n";break;default:n&&(e+="#define "+i+"\n")}}return e}}class Vi{constructor(){this._dirty=!0,this._tempColor=new ct(0,0,0,0),this._globalCurve=new ct(0,0,0,0),this._highlightsCurve=new ct(0,0,0,0),this._midtonesCurve=new ct(0,0,0,0),this._shadowsCurve=new ct(0,0,0,0),this._positiveCurve=new ct(0,0,0,0),this._negativeCurve=new ct(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",n="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(n,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,n,s){null!=e&&(e=Vi._Clamp(e,0,360),t=Vi._Clamp(t,-100,100),i=Vi._Clamp(i,-100,100),n=Vi._Clamp(n,-100,100),t=Vi._ApplyColorGradingSliderNonlinear(t),t*=.5,n=Vi._ApplyColorGradingSliderNonlinear(n),t<0&&(t*=-1,e=(e+180)%360),Vi._FromHSBToRef(e,t,50+.25*n,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,n){let s=Vi._Clamp(e,0,360);const a=Vi._Clamp(t/100,0,1),o=Vi._Clamp(i/100,0,1);if(0===a)n.r=o,n.g=o,n.b=o;else{s/=60;const l=Math.floor(s),c=s-l,u=o*(1-a),h=o*(1-a*c),d=o*(1-a*(1-c));switch(l){case 0:n.r=o,n.g=d,n.b=u;break;case 1:n.r=h,n.g=o,n.b=u;break;case 2:n.r=u,n.g=o,n.b=d;break;case 3:n.r=u,n.g=h,n.b=o;break;case 4:n.r=d,n.g=u,n.b=o;break;default:n.r=o,n.g=u,n.b=h}}n.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return lt.Clone(()=>new Vi,this)}serialize(){return lt.Serialize(this)}static Parse(e){return lt.Parse(()=>new Vi,e,null,null)}}b([O()],Vi.prototype,"_globalHue",void 0),b([O()],Vi.prototype,"_globalDensity",void 0),b([O()],Vi.prototype,"_globalSaturation",void 0),b([O()],Vi.prototype,"_globalExposure",void 0),b([O()],Vi.prototype,"_highlightsHue",void 0),b([O()],Vi.prototype,"_highlightsDensity",void 0),b([O()],Vi.prototype,"_highlightsSaturation",void 0),b([O()],Vi.prototype,"_highlightsExposure",void 0),b([O()],Vi.prototype,"_midtonesHue",void 0),b([O()],Vi.prototype,"_midtonesDensity",void 0),b([O()],Vi.prototype,"_midtonesSaturation",void 0),b([O()],Vi.prototype,"_midtonesExposure",void 0),lt._ColorCurvesParser=Vi.Parse;class Hz extends us{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class Wt{constructor(){this.colorCurves=new Vi,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=Wt.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new ct(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=Wt.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new J}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Vi.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===Wt._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,e.TONEMAPPING_ACES=this._toneMappingType===Wt.TONEMAPPING_ACES,e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING3D=!!e.COLORGRADING&&this.colorGradingTexture.is3D,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Vi.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),n=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,n),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const s=null!=t?t:n/i;let a=Math.tan(.5*this.vignetteCameraFov),o=a*s;const l=Math.sqrt(o*a);o=Ie.Mix(o,l,this.vignetteStretch),a=Ie.Mix(a,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,a,-o*this.vignetteCenterX,-a*this.vignetteCenterY),e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,-2*this.vignetteWeight)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return lt.Clone(()=>new Wt,this)}serialize(){return lt.Serialize(this)}static Parse(e){const t=lt.Parse(()=>new Wt,e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}Wt.TONEMAPPING_STANDARD=0,Wt.TONEMAPPING_ACES=1,Wt._VIGNETTEMODE_MULTIPLY=0,Wt._VIGNETTEMODE_OPAQUE=1,b([function oz(r){return rs(7,r)}()],Wt.prototype,"colorCurves",void 0),b([O()],Wt.prototype,"_colorCurvesEnabled",void 0),b([Bt("colorGradingTexture")],Wt.prototype,"_colorGradingTexture",void 0),b([O()],Wt.prototype,"_colorGradingEnabled",void 0),b([O()],Wt.prototype,"_colorGradingWithGreenDepth",void 0),b([O()],Wt.prototype,"_colorGradingBGR",void 0),b([O()],Wt.prototype,"_exposure",void 0),b([O()],Wt.prototype,"_toneMappingEnabled",void 0),b([O()],Wt.prototype,"_toneMappingType",void 0),b([O()],Wt.prototype,"_contrast",void 0),b([O()],Wt.prototype,"vignetteStretch",void 0),b([O()],Wt.prototype,"vignetteCenterX",void 0),b([O()],Wt.prototype,"vignetteCenterY",void 0),b([O()],Wt.prototype,"vignetteWeight",void 0),b([jm()],Wt.prototype,"vignetteColor",void 0),b([O()],Wt.prototype,"vignetteCameraFov",void 0),b([O()],Wt.prototype,"_vignetteBlendMode",void 0),b([O()],Wt.prototype,"_vignetteEnabled",void 0),b([O()],Wt.prototype,"_ditheringEnabled",void 0),b([O()],Wt.prototype,"_ditheringIntensity",void 0),b([O()],Wt.prototype,"_skipFinalColorClamp",void 0),b([O()],Wt.prototype,"_applyByPostProcess",void 0),b([O()],Wt.prototype,"_isEnabled",void 0),lt._ImageProcessingConfigurationParser=Wt.Parse,Ze.prototype.createUniformBuffer=function(r){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const t=new gh(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},Ze.prototype.createDynamicUniformBuffer=function(r){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const t=new gh(e);return this.bindUniformBuffer(t),r instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,r,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(r),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},Ze.prototype.updateUniformBuffer=function(r,e,t,i){this.bindUniformBuffer(r),void 0===t&&(t=0),void 0===i?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)},Ze.prototype.bindUniformBuffer=function(r){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,r?r.underlyingResource:null)},Ze.prototype.bindUniformBufferBase=function(r,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,r?r.underlyingResource:null)},Ze.prototype.bindUniformBlock=function(r,e,t){const i=r.program,n=this._gl.getUniformBlockIndex(i,e);4294967295!==n&&this._gl.uniformBlockBinding(i,n,t)};class He{constructor(e,t,i,n,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=null!=n?n:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const n=this._uniformLocationPointer-i;for(let s=0;s<n;s++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||void 0!==this._uniformLocations[e])return;let n;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i,n=[];for(let s=0;s<t;s++)n.push(0)}else{if(t instanceof Array)n=t,t=n.length;else{n=[];for(let s=0;s<t;s++)n.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let s=0;s<t;s++)this._data.push(n[s]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){this.addUniform(e,[t,i])}addFloat3(e,t,i,n){this.addUniform(e,[t,i,n])}addColor3(e,t){this.addUniform(e,[t.r,t.g,t.b])}addColor4(e,t,i){this.addUniform(e,[t.r,t.g,t.b,i])}addVector3(e,t){this.addUniform(e,[t.x,t.y,t.z])}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._buffer=this._dynamic?this._engine.createDynamicUniformBuffer(this._bufferData):this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer)return void this.create();if(!this._dynamic&&!this._needSync)return void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(He._UpdatedUbosInFrame[this._name]||(He._UpdatedUbosInFrame[this._name]=0),He._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let n=this._uniformLocations[e];if(void 0===n){if(this._buffer)return void H.Error("Cannot add an uniform after UBO has been created.");this.addUniform(e,i),n=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let s=0;s<i;s++)this._bufferData[n+s]=t[s];else{let s=!1;for(let a=0;a<i;a++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[n+a]!==Ie.FloatRound(t[a]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+a]=t[a]);this._needSync=this._needSync||s}}updateUniformArray(e,t,i){this._checkNewFrame();const n=this._uniformLocations[e];if(void 0===n)return void H.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const s=this._uniformArraySizes[e];if(this._dynamic)for(let a=0;a<i;a++)this._bufferData[n+a]=t[a];else{let a=!1,o=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[n+4*l+o]!==Ie.FloatRound(t[c])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+4*l+o]=t[c]),o++,o===s.strideSize){for(;o<4;o++)this._bufferData[n+4*l+o]=0;o=0,l++}this._needSync=this._needSync||a}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],n=t.updateFlag;return(void 0===i||i!==n)&&(this._valueCache[e]=n,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)He._TempBuffer[4*i]=t[3*i],He._TempBuffer[4*i+1]=t[3*i+1],He._TempBuffer[4*i+2]=t[3*i+2],He._TempBuffer[4*i+3]=0;this.updateUniform(e,He._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)He._TempBuffer[4*i]=t[2*i],He._TempBuffer[4*i+1]=t[2*i+1],He._TempBuffer[4*i+2]=0,He._TempBuffer[4*i+3]=0;this.updateUniform(e,He._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){He._TempBuffer[0]=t,this.updateUniform(e,He._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,n=""){this._currentEffect.setFloat2(e+n,t,i)}_updateFloat2ForUniform(e,t,i){He._TempBuffer[0]=t,He._TempBuffer[1]=i,this.updateUniform(e,He._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,n,s=""){this._currentEffect.setFloat3(e+s,t,i,n)}_updateFloat3ForUniform(e,t,i,n){He._TempBuffer[0]=t,He._TempBuffer[1]=i,He._TempBuffer[2]=n,this.updateUniform(e,He._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,n,s,a=""){this._currentEffect.setFloat4(e+a,t,i,n,s)}_updateFloat4ForUniform(e,t,i,n,s){He._TempBuffer[0]=t,He._TempBuffer[1]=i,He._TempBuffer[2]=n,He._TempBuffer[3]=s,this.updateUniform(e,He._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){He._TempBufferInt32View.set(t),this.updateUniformArray(e,He._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){He._TempBufferUInt32View.set(t),this.updateUniformArray(e,He._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){He._TempBuffer[0]=t.x,He._TempBuffer[1]=t.y,He._TempBuffer[2]=t.z,this.updateUniform(e,He._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){He._TempBuffer[0]=t.x,He._TempBuffer[1]=t.y,He._TempBuffer[2]=t.z,He._TempBuffer[3]=t.w,this.updateUniform(e,He._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){He._TempBuffer[0]=t.r,He._TempBuffer[1]=t.g,He._TempBuffer[2]=t.b,this.updateUniform(e,He._TempBuffer,3)}_updateColor4ForEffect(e,t,i,n=""){this._currentEffect.setColor4(e+n,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){He._TempBuffer[0]=t.r,He._TempBuffer[1]=t.g,He._TempBuffer[2]=t.b,He._TempBuffer[3]=i,this.updateUniform(e,He._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){He._TempBuffer[0]=t.r,He._TempBuffer[1]=t.g,He._TempBuffer[2]=t.b,He._TempBuffer[3]=t.a,this.updateUniform(e,He._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){He._TempBufferInt32View[0]=t,this.updateUniform(e,He._TempBuffer,1)}_updateInt2ForEffect(e,t,i,n=""){this._currentEffect.setInt2(e+n,t,i)}_updateInt2ForUniform(e,t,i){He._TempBufferInt32View[0]=t,He._TempBufferInt32View[1]=i,this.updateUniform(e,He._TempBuffer,2)}_updateInt3ForEffect(e,t,i,n,s=""){this._currentEffect.setInt3(e+s,t,i,n)}_updateInt3ForUniform(e,t,i,n){He._TempBufferInt32View[0]=t,He._TempBufferInt32View[1]=i,He._TempBufferInt32View[2]=n,this.updateUniform(e,He._TempBuffer,3)}_updateInt4ForEffect(e,t,i,n,s,a=""){this._currentEffect.setInt4(e+a,t,i,n,s)}_updateInt4ForUniform(e,t,i,n,s){He._TempBufferInt32View[0]=t,He._TempBufferInt32View[1]=i,He._TempBufferInt32View[2]=n,He._TempBufferInt32View[3]=s,this.updateUniform(e,He._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){He._TempBufferUInt32View[0]=t,this.updateUniform(e,He._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,n=""){this._currentEffect.setUInt2(e+n,t,i)}_updateUInt2ForUniform(e,t,i){He._TempBufferUInt32View[0]=t,He._TempBufferUInt32View[1]=i,this.updateUniform(e,He._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,n,s=""){this._currentEffect.setUInt3(e+s,t,i,n)}_updateUInt3ForUniform(e,t,i,n){He._TempBufferUInt32View[0]=t,He._TempBufferUInt32View[1]=i,He._TempBufferUInt32View[2]=n,this.updateUniform(e,He._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,n,s,a=""){this._currentEffect.setUInt4(e+a,t,i,n,s)}_updateUInt4ForUniform(e,t,i,n,s){He._TempBufferUInt32View[0]=t,He._TempBufferUInt32View[1]=i,He._TempBufferUInt32View[2]=n,He._TempBufferUInt32View[3]=s,this.updateUniform(e,He._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i)this._engine._releaseBuffer(this._buffers[i][0]);else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}He._UpdatedUbosInFrame={},He._MAX_UNIFORM_SIZE=256,He._TempBuffer=new Float32Array(He._MAX_UNIFORM_SIZE),He._TempBufferInt32View=new Int32Array(He._TempBuffer.buffer),He._TempBufferUInt32View=new Uint32Array(He._TempBuffer.buffer);class Th{constructor(e,t,i,n=0,s=!1,a=!1,o=!1,l){this._isAlreadyOwned=!1,this._engine=e.getScene?e.getScene().getEngine():e,this._updatable=i,this._instanced=a,this._divisor=l||1,t instanceof Df?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?n:n*Float32Array.BYTES_PER_ELEMENT,s||this.create()}createVertexBuffer(e,t,i,n,s,a=!1,o){const l=a?t:t*Float32Array.BYTES_PER_ELEMENT,c=n?a?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new I(this._engine,this,e,this._updatable,!0,c,void 0===s?this._instanced:s,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,n=!1){!this._buffer||this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,n?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned)return void(this._isAlreadyOwned=!0);this._buffer.references++}}dispose(){!this._buffer||this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}let I=(()=>{class r{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(t){const i=0!=t;this._instanceDivisor=t,i!==this._instanced&&(this._instanced=i,this._computeHashCode())}constructor(t,i,n,s,a,o,l,c,u,h,d=!1,f=!1,p=1,g=!1){if(i instanceof Th?(this._buffer=i,this._ownsBuffer=g):(this._buffer=new Th(t,i,s,o,a,l,f),this._ownsBuffer=!0),this.uniqueId=r._Counter++,this._kind=n,null==h){const m=this.getData();this.type=r.FLOAT,m instanceof Int8Array?this.type=r.BYTE:m instanceof Uint8Array?this.type=r.UNSIGNED_BYTE:m instanceof Int16Array?this.type=r.SHORT:m instanceof Uint16Array?this.type=r.UNSIGNED_SHORT:m instanceof Int32Array?this.type=r.INT:m instanceof Uint32Array&&(this.type=r.UNSIGNED_INT)}else this.type=h;const _=r.GetTypeByteLength(this.type);f?(this._size=u||(o?o/_:r.DeduceStride(n)),this.byteStride=o||this._buffer.byteStride||this._size*_,this.byteOffset=c||0):(this._size=u||o||r.DeduceStride(n),this.byteStride=o?o*_:this._buffer.byteStride||this._size*_,this.byteOffset=(c||0)*_),this.normalized=d,this._instanced=void 0!==l&&l,this._instanceDivisor=l?p:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){!this._buffer||this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(t,i){const n=this.getData();if(!n)return null;const s=this.getSize()*r.GetTypeByteLength(this.type),a=t*this.getSize();if(this.type!==r.FLOAT||this.byteStride!==s){const o=new Float32Array(a);return this.forEach(a,(l,c)=>o[c]=l),o}if(!(n instanceof Array||n instanceof Float32Array)||0!==this.byteOffset||n.length!==a){if(n instanceof Array){const o=this.byteOffset/4;return n.slice(o,o+a)}if(n instanceof ArrayBuffer)return new Float32Array(n,this.byteOffset,a);{let o=n.byteOffset+this.byteOffset;if(i){const c=new Float32Array(a),u=new Float32Array(n.buffer,o,a);return c.set(u),c}const l=o%4;return l&&(o=Math.max(0,o-l)),new Float32Array(n.buffer,o,a)}}return i?n.slice():n}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/r.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/r.GetTypeByteLength(this.type)}getSize(t=!1){return t?this._size*r.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(t){this._buffer.create(t)}update(t){this._buffer.update(t)}updateDirectly(t,i,n=!1){this._buffer.updateDirectly(t,i,void 0,n)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(t,i){r.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,t,this.normalized,i)}static DeduceStride(t){switch(t){case r.UVKind:case r.UV2Kind:case r.UV3Kind:case r.UV4Kind:case r.UV5Kind:case r.UV6Kind:return 2;case r.NormalKind:case r.PositionKind:return 3;case r.ColorKind:case r.MatricesIndicesKind:case r.MatricesIndicesExtraKind:case r.MatricesWeightsKind:case r.MatricesWeightsExtraKind:case r.TangentKind:return 4;default:throw new Error("Invalid kind '"+t+"'")}}static GetTypeByteLength(t){switch(t){case r.BYTE:case r.UNSIGNED_BYTE:return 1;case r.SHORT:case r.UNSIGNED_SHORT:return 2;case r.INT:case r.UNSIGNED_INT:case r.FLOAT:return 4;default:throw new Error(`Invalid type '${t}'`)}}static ForEach(t,i,n,s,a,o,l,c){if(t instanceof Array){let u=i/4;const h=n/4;for(let d=0;d<o;d+=s){for(let f=0;f<s;f++)c(t[u+f],d+f);u+=h}}else{const u=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),h=r.GetTypeByteLength(a);for(let d=0;d<o;d+=s){let f=i;for(let p=0;p<s;p++)c(r._GetFloatValue(u,a,f,l),d+p),f+=h;i+=n}}}static _GetFloatValue(t,i,n,s){switch(i){case r.BYTE:{let a=t.getInt8(n);return s&&(a=Math.max(a/127,-1)),a}case r.UNSIGNED_BYTE:{let a=t.getUint8(n);return s&&(a/=255),a}case r.SHORT:{let a=t.getInt16(n,!0);return s&&(a=Math.max(a/32767,-1)),a}case r.UNSIGNED_SHORT:{let a=t.getUint16(n,!0);return s&&(a/=65535),a}case r.INT:return t.getInt32(n,!0);case r.UNSIGNED_INT:return t.getUint32(n,!0);case r.FLOAT:return t.getFloat32(n,!0);default:throw new Error(`Invalid component type ${i}`)}}}return r._Counter=0,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.PositionKind="position",r.NormalKind="normal",r.TangentKind="tangent",r.UVKind="uv",r.UV2Kind="uv2",r.UV3Kind="uv3",r.UV4Kind="uv4",r.UV5Kind="uv5",r.UV6Kind="uv6",r.ColorKind="color",r.ColorInstanceKind="instanceColor",r.MatricesIndicesKind="matricesIndices",r.MatricesWeightsKind="matricesWeights",r.MatricesIndicesExtraKind="matricesIndicesExtra",r.MatricesWeightsExtraKind="matricesWeightsExtra",r})();class Za{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(I.NormalKind))return null;const i=this.pickedMesh.getIndices();if(!i)return null;let n;if(t){const a=this.pickedMesh.getVerticesData(I.NormalKind);let o=E.FromArray(a,3*i[3*this.faceId]),l=E.FromArray(a,3*i[3*this.faceId+1]),c=E.FromArray(a,3*i[3*this.faceId+2]);o=o.scale(this.bu),l=l.scale(this.bv),c=c.scale(1-this.bu-this.bv),n=new E(o.x+l.x+c.x,o.y+l.y+c.y,o.z+l.z+c.z)}else{const a=this.pickedMesh.getVerticesData(I.PositionKind),o=E.FromArray(a,3*i[3*this.faceId]),l=E.FromArray(a,3*i[3*this.faceId+1]),c=E.FromArray(a,3*i[3*this.faceId+2]),u=o.subtract(l),h=c.subtract(l);n=E.Cross(u,h)}const s=(a,o)=>{let l=a.getWorldMatrix();a.nonUniformScaling&&(z.Matrix[0].copyFrom(l),l=z.Matrix[0],l.setTranslationFromFloats(0,0,0),l.invert(),l.transposeToRef(z.Matrix[1]),l=z.Matrix[1]),E.TransformNormalToRef(o,l,o)};if(e&&s(this.pickedMesh,n),this.ray){const a=z.Vector3[0].copyFrom(n);e||s(this.pickedMesh,a),E.Dot(a,this.ray.direction)>0&&n.negateInPlace()}return n.normalize(),n}getTextureCoordinates(e=I.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let n=We.FromArray(i,2*t[3*this.faceId]),s=We.FromArray(i,2*t[3*this.faceId+1]),a=We.FromArray(i,2*t[3*this.faceId+2]);return n=n.scale(this.bu),s=s.scale(this.bv),a=a.scale(1-this.bu-this.bv),new We(n.x+s.x+a.x,n.y+s.y+a.y)}}class Fn{constructor(e,t,i,n,s,a){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=n,this.sourceEvent=s,this.additionalData=a}static CreateNew(e,t,i){const n=e.getScene();return new Fn(e,n.pointerX,n.pointerY,n.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,n){return new Fn(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,n)}static CreateNewFromScene(e,t){return new Fn(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,n){return new Fn(e,t.x,t.y,null,i,n)}}class Lf{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[I.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[I.PositionKind]=new I(this._scene.getEngine(),e,I.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[I.PositionKind];!e||(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!!(i&&(t=t||i._postProcesses.filter(n=>null!=n),t&&0!==t.length&&this._scene.postProcessesEnabled))&&(t[0].activate(i,e,null!=t),!0)}directRender(e,t=null,i=!1,n=0,s=0,a=!1){var o;const l=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera,null==t?void 0:t.texture):(t?l.bindFramebuffer(t,n,void 0,void 0,i,s):a||l.restoreDefaultFramebuffer(),null===(o=l._debugInsertMarker)||void 0===o||o.call(l,`post process ${e[c].name} output`));const u=e[c],h=u.apply();h&&(u.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,h),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(h))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,n,s=!1){var a;const o=this._scene.activeCamera;if(!o||(0===(n=n||o._postProcesses.filter(c=>null!=c)).length||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let c=0,u=n.length;c<u;c++){const h=n[c];if(c<u-1?h._outputTexture=n[c+1].activate(o,null==t?void 0:t.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,s),h._outputTexture=t):(l.restoreDefaultFramebuffer(),h._outputTexture=null),null===(a=l._debugInsertMarker)||void 0===a||a.call(l,`post process ${n[c].name} output`)),e)break;const d=h.apply();d&&(h.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[I.PositionKind];e&&(e.dispose(),this._vertexBuffers[I.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class Zs{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||Zs.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||Zs.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||Zs.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,n=null,s=null){this.index=e,this._opaqueSubMeshes=new Qn(256),this._transparentSubMeshes=new Qn(256),this._alphaTestSubMeshes=new Qn(256),this._depthOnlySubMeshes=new Qn(256),this._particleSystems=new Qn(256),this._spriteManagers=new Qn(256),this._empty=!0,this._edgesRenderers=new ml(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=s}render(e,t,i,n){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const s=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const a=s.getStencilBuffer();if(s.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(s.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){const o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);s.setAlphaMode(0)}if(s.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();s.setAlphaMode(0)}s.setStencilBuffer(a)}_renderOpaqueSorted(e){return Zs._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return Zs._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return Zs._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,n){let a,s=0;const o=i?i.globalPosition:Zs._ZeroVector;if(n)for(;s<e.length;s++)a=e.data[s],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=E.Distance(a.getBoundingInfo().boundingSphere.centerWorld,o);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(s=0;s<l.length;s++)if(a=l[s],!c._activeMeshesFrozenButKeepClipping||a.isInFrustum(c._frustumPlanes)){if(n){const u=a.getMaterial();if(u&&u.needDepthPrePass){const h=u.getScene().getEngine();h.setColorWrite(!1),h.setAlphaMode(0),a.render(!1),h.setColorWrite(!0)}}a.render(n)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:Zs.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),n=t.getMesh();return i.material&&n.material?i.material.uniqueId-n.material.uniqueId:i.uniqueId-n.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const n=this._particleSystems.data[i];if(0===(t&&t.layerMask&n.layerMask))continue;const s=n.emitter;(!s.position||!e||-1!==e.indexOf(s))&&this._scene._activeParticles.addCount(n.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}Zs._ZeroVector=E.Zero();class zz{}let Bf=(()=>{class r{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(t){if(t!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=t,!this._maintainStateBetweenFrames)){for(const i of this._scene.meshes)if(i.subMeshes)for(const n of i.subMeshes)n._wasDispatched=!1;if(this._scene.spriteManagers)for(const i of this._scene.spriteManagers)i._wasDispatched=!1;for(const i of this._scene.particleSystems)i._wasDispatched=!1}}constructor(t){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new zz,this._maintainStateBetweenFrames=!1,this._scene=t;for(let i=r.MIN_RENDERINGGROUPS;i<r.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(t){const i=t||0;return this._prepareRenderingGroup(i),this._renderingGroups[i]}_clearDepthStencilBuffer(t=!0,i=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,t,i),this._depthStencilBufferAlreadyCleaned=!0)}render(t,i,n,s){const a=this._renderingGroupInfo;if(a.scene=this._scene,a.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(let o=0;o<this._scene.spriteManagers.length;o++)this.dispatchSprites(this._scene.spriteManagers[o]);for(let o=r.MIN_RENDERINGGROUPS;o<r.MAX_RENDERINGGROUPS;o++){this._depthStencilBufferAlreadyCleaned=o===r.MIN_RENDERINGGROUPS;const l=this._renderingGroups[o];if(!l||l._empty)continue;const c=Math.pow(2,o);if(a.renderingGroupId=o,this._scene.onBeforeRenderingGroupObservable.notifyObservers(a,c),r.AUTOCLEAR){const u=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(o):this._autoClearDepthStencil[o];u&&u.autoClear&&this._clearDepthStencilBuffer(u.depth,u.stencil)}for(const u of this._scene._beforeRenderingGroupDrawStage)u.action(o);l.render(t,s,n,i);for(const u of this._scene._afterRenderingGroupDrawStage)u.action(o);this._scene.onAfterRenderingGroupObservable.notifyObservers(a,c)}}reset(){if(!this.maintainStateBetweenFrames)for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++){const i=this._renderingGroups[t];i&&i.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++){const i=this._renderingGroups[t];i&&i.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++){const i=this._renderingGroups[t];i&&i.dispose()}}_prepareRenderingGroup(t){void 0===this._renderingGroups[t]&&(this._renderingGroups[t]=new Zs(t,this._scene,this._customOpaqueSortCompareFn[t],this._customAlphaTestSortCompareFn[t],this._customTransparentSortCompareFn[t]))}dispatchSprites(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchSprites(t))}dispatchParticles(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchParticles(t))}dispatch(t,i,n){void 0===i&&(i=t.getMesh()),(!this.maintainStateBetweenFrames||!t._wasDispatched)&&(t._wasDispatched=!0,this.getRenderingGroup(i.renderingGroupId).dispatch(t,i,n))}setRenderingOrder(t,i=null,n=null,s=null){if(this._customOpaqueSortCompareFn[t]=i,this._customAlphaTestSortCompareFn[t]=n,this._customTransparentSortCompareFn[t]=s,this._renderingGroups[t]){const a=this._renderingGroups[t];a.opaqueSortCompareFn=this._customOpaqueSortCompareFn[t],a.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[t],a.transparentSortCompareFn=this._customTransparentSortCompareFn[t]}}setRenderingAutoClearDepthStencil(t,i,n=!0,s=!0){this._autoClearDepthStencil[t]={autoClear:i,depth:n,stencil:s}}getAutoClearDepthStencilSetup(t){return this._autoClearDepthStencil[t]}}return r.MAX_RENDERINGGROUPS=4,r.MIN_RENDERINGGROUPS=0,r.AUTOCLEAR=!0,r})(),Bi=(()=>{class r{}return r.NAME_EFFECTLAYER="EffectLayer",r.NAME_LAYER="Layer",r.NAME_LENSFLARESYSTEM="LensFlareSystem",r.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",r.NAME_PARTICLESYSTEM="ParticleSystem",r.NAME_GAMEPAD="Gamepad",r.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",r.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",r.NAME_PREPASSRENDERER="PrePassRenderer",r.NAME_DEPTHRENDERER="DepthRenderer",r.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",r.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",r.NAME_SPRITE="Sprite",r.NAME_SUBSURFACE="SubSurface",r.NAME_OUTLINERENDERER="Outline",r.NAME_PROCEDURALTEXTURE="ProceduralTexture",r.NAME_SHADOWGENERATOR="ShadowGenerator",r.NAME_OCTREE="Octree",r.NAME_PHYSICSENGINE="PhysicsEngine",r.NAME_AUDIO="Audio",r.NAME_FLUIDRENDERER="FluidRenderer",r.STEP_ISREADYFORMESH_EFFECTLAYER=0,r.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,r.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_PREPASS=0,r.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_LAYER=2,r.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,r.STEP_BEFORERENDERTARGETDRAW_LAYER=1,r.STEP_BEFORERENDERINGMESH_PREPASS=0,r.STEP_BEFORERENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGMESH_PREPASS=0,r.STEP_AFTERRENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,r.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,r.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,r.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,r.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,r.STEP_BEFORECLEAR_PREPASS=1,r.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_LAYER=1,r.STEP_AFTERCAMERADRAW_PREPASS=0,r.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,r.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,r.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,r.STEP_AFTERCAMERADRAW_LAYER=4,r.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,r.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,r.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,r.STEP_AFTERRENDER_AUDIO=0,r.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,r.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,r.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,r.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,r.STEP_POINTERMOVE_SPRITE=0,r.STEP_POINTERDOWN_SPRITE=0,r.STEP_POINTERUP_SPRITE=0,r})();class Ki extends Array{constructor(e){super(...e)}static Create(){return Object.create(Ki.prototype)}registerStep(e,t,i){let n=0,s=Number.MAX_VALUE;for(;n<this.length&&(s=this[n].index,!(e<s));n++);this.splice(n,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}let Ct=(()=>{class r{}return r.POINTERDOWN=1,r.POINTERUP=2,r.POINTERMOVE=4,r.POINTERWHEEL=8,r.POINTERPICK=16,r.POINTERTAP=32,r.POINTERDOUBLETAP=64,r})();class tC{constructor(e,t){this.type=e,this.event=t}}class Wz extends tC{constructor(e,t,i,n){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new We(i,n)}}class qa extends tC{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,n=null){super(e,t),this._pickInfo=i,this._inputManager=n}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}let Lc=(()=>{class r{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t))return!0;return!1}static get HasPickTriggers(){for(const t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t)){const i=parseInt(t);if(i>=1&&i<=7)return!0}return!1}static HasSpecificTrigger(t){for(const i in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,i)&&parseInt(i)===t)return!0;return!1}}return r.Triggers={},r})(),Uf=(()=>{class r{}return r.KEYDOWN=1,r.KEYUP=2,r})();class aT{constructor(e,t){this.type=e,this.event=t}}class iC extends aT{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var je=(()=>{return(r=je||(je={}))[r.Generic=0]="Generic",r[r.Keyboard=1]="Keyboard",r[r.Mouse=2]="Mouse",r[r.Touch=3]="Touch",r[r.DualShock=4]="DualShock",r[r.Xbox=5]="Xbox",r[r.Switch=6]="Switch",r[r.DualSense=7]="DualSense",je;var r})(),pt=(()=>{return(r=pt||(pt={}))[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r[r.LeftClick=2]="LeftClick",r[r.MiddleClick=3]="MiddleClick",r[r.RightClick=4]="RightClick",r[r.BrowserBack=5]="BrowserBack",r[r.BrowserForward=6]="BrowserForward",r[r.MouseWheelX=7]="MouseWheelX",r[r.MouseWheelY=8]="MouseWheelY",r[r.MouseWheelZ=9]="MouseWheelZ",r[r.Move=12]="Move",pt;var r})(),Eh=(()=>{return(r=Eh||(Eh={}))[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r[r.LeftClick=2]="LeftClick",r[r.MiddleClick=3]="MiddleClick",r[r.RightClick=4]="RightClick",r[r.BrowserBack=5]="BrowserBack",r[r.BrowserForward=6]="BrowserForward",r[r.MouseWheelX=7]="MouseWheelX",r[r.MouseWheelY=8]="MouseWheelY",r[r.MouseWheelZ=9]="MouseWheelZ",r[r.DeltaHorizontal=10]="DeltaHorizontal",r[r.DeltaVertical=11]="DeltaVertical",Eh;var r})();let oT=(()=>{class r{}return r.DOM_DELTA_PIXEL=0,r.DOM_DELTA_LINE=1,r.DOM_DELTA_PAGE=2,r})();class Tl{static CreateDeviceEvent(e,t,i,n,s,a,o){switch(e){case je.Keyboard:return this._CreateKeyboardEvent(i,n,s,a);case je.Mouse:if(i===pt.MouseWheelX||i===pt.MouseWheelY||i===pt.MouseWheelZ)return this._CreateWheelEvent(e,t,i,n,s,a);case je.Touch:return this._CreatePointerEvent(e,t,i,n,s,a,o);default:throw`Unable to generate event for device ${je[e]}`}}static _CreatePointerEvent(e,t,i,n,s,a,o){const l=this._CreateMouseEvent(e,t,i,n,s,a);return e===je.Mouse?(l.deviceType=je.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=je.Touch,l.pointerId=null!=o?o:t,l.pointerType="touch"),i===pt.Move?l.type="pointermove":i>=pt.LeftClick&&i<=pt.RightClick&&(l.type=1===n?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,n,s,a){const o=this._CreateMouseEvent(e,t,i,n,s,a);switch(o.pointerId=1,o.type="wheel",o.deltaMode=oT.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case pt.MouseWheelX:o.deltaX=n;break;case pt.MouseWheelY:o.deltaY=n;break;case pt.MouseWheelZ:o.deltaZ=n}return o}static _CreateMouseEvent(e,t,i,n,s,a){const o=this._CreateEvent(a),l=s.pollInput(e,t,pt.Horizontal),c=s.pollInput(e,t,pt.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=s.pollInput(e,t,Eh.DeltaHorizontal),o.movementY=s.pollInput(e,t,Eh.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,s),o.clientX=l,o.clientY=c,o.x=l,o.y=c,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,n){const s=this._CreateEvent(n);return this._CheckNonCharacterKeys(s,i),s.deviceType=je.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=1===t?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(je.Keyboard),n=i&&1===t.pollInput(je.Keyboard,0,18),s=i&&1===t.pollInput(je.Keyboard,0,17),a=i&&(1===t.pollInput(je.Keyboard,0,91)||1===t.pollInput(je.Keyboard,0,92)||1===t.pollInput(je.Keyboard,0,93)),o=i&&1===t.pollInput(je.Keyboard,0,16);e.altKey=n,e.ctrlKey=s,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class Xz{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(n,s,a,o)=>{const l=Tl.CreateDeviceEvent(n,s,a,o,this);i(n,s,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===je.Mouse||e===je.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const rC=Object.keys(pt).length/2;class Yz{constructor(e,t,i,n){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Ie.IsSafari(),this._usingMacOS=Km()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=s=>{},this._keyboardUpEvent=s=>{},this._keyboardBlurEvent=s=>{},this._pointerMoveEvent=s=>{},this._pointerDownEvent=s=>{},this._pointerUpEvent=s=>{},this._pointerCancelEvent=s=>{},this._pointerWheelEvent=s=>{},this._pointerBlurEvent=s=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Qm.IsNavigatorAvailable()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=s=>{},this._gamepadDisconnectedEvent=s=>{},this._eventPrefix=Ie.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=n,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const n=this._inputs[e][t];if(!n)throw`Unable to find device ${je[e]}`;e>=je.DualShock&&e<=je.DualSense&&this._updateDevice(e,t,i);const s=n[i];if(void 0===s)throw`Unable to find input ${i} for device ${je[e]} in slot ${t}`;return i===pt.Move&&Ie.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const t of this._inputs)if(t)for(const i in t){const s=t[+i];if(s)for(let a=0;a<s.length;a++)s[a]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(je.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,n){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,rC);const s=this._inputs[e][t];s[0]=i,s[1]=n}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${je[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const n=new Array(i);n.fill(0),this._inputs[e][t]=n,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(je.Keyboard,0,255));const t=this._inputs[je.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(je.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(je.Keyboard,0,255));const t=this._inputs[je.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const n of this._metaKeys){const s=Tl.CreateDeviceEvent(je.Keyboard,0,n,0,this,this._elementToAttachTo);t[n]=0,this._onInputChanged(je.Keyboard,0,s)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(je.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[je.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=Tl.CreateDeviceEvent(je.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(je.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Qm.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const n=this._getPointerType(i),s=n===je.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);this._inputs[n]||(this._inputs[n]={}),this._inputs[n][s]||this._addPointerDevice(n,s,i.clientX,i.clientY);const a=this._inputs[n][s];if(a){const o=i;o.inputIndex=pt.Move,a[pt.Horizontal]=i.clientX,a[pt.Vertical]=i.clientY,void 0===i.pointerId&&(i.pointerId=this._mouseId),this._onInputChanged(n,s,o),!this._usingSafari&&-1!==i.button&&(o.inputIndex=i.button+2,a[i.button+2]=a[i.button+2]?0:1,this._onInputChanged(n,s,o))}},this._pointerDownEvent=i=>{const n=this._getPointerType(i);let s=n===je.Mouse?0:i.pointerId;if(n===je.Touch){const o=this._activeTouchIds.indexOf(-1);if(!(o>=0))return void Ie.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);s=o,this._activeTouchIds[o]=i.pointerId}this._inputs[n]||(this._inputs[n]={}),this._inputs[n][s]?n===je.Touch&&this._onDeviceConnected(n,s):this._addPointerDevice(n,s,i.clientX,i.clientY);const a=this._inputs[n][s];if(a){const o=a[pt.Horizontal],l=a[pt.Vertical];if(n===je.Mouse){if(void 0===i.pointerId&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(u){}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch(u){}a[pt.Horizontal]=i.clientX,a[pt.Vertical]=i.clientY,a[i.button+2]=1;const c=i;c.inputIndex=i.button+2,this._onInputChanged(n,s,c),(o!==i.clientX||l!==i.clientY)&&(c.inputIndex=pt.Move,this._onInputChanged(n,s,c))}},this._pointerUpEvent=i=>{var n,s,a,o,l;const c=this._getPointerType(i),u=c===je.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(c===je.Touch){if(-1===u)return;this._activeTouchIds[u]=-1}const h=null===(n=this._inputs[c])||void 0===n?void 0:n[u];if(h&&0!==h[i.button+2]){const d=h[pt.Horizontal],f=h[pt.Vertical];h[pt.Horizontal]=i.clientX,h[pt.Vertical]=i.clientY,h[i.button+2]=0;const p=i;void 0===i.pointerId&&(i.pointerId=this._mouseId),(d!==i.clientX||f!==i.clientY)&&(p.inputIndex=pt.Move,this._onInputChanged(c,u,p)),p.inputIndex=i.button+2,c===je.Mouse&&this._mouseId>=0&&(null===(a=(s=this._elementToAttachTo).hasPointerCapture)||void 0===a?void 0:a.call(s,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&(null===(l=(o=this._elementToAttachTo).hasPointerCapture)||void 0===l?void 0:l.call(o,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(c,u,p),c===je.Touch&&this._onDeviceDisconnected(c,u)}},this._pointerCancelEvent=i=>{var n,s,a,o;if("mouse"===i.pointerType){const l=this._inputs[je.Mouse][0];this._mouseId>=0&&(null===(s=(n=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(n,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=pt.LeftClick;c<=pt.BrowserForward;c++)if(1===l[c]){l[c]=0;const u=Tl.CreateDeviceEvent(je.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(je.Mouse,0,u)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);(null===(o=(a=this._elementToAttachTo).hasPointerCapture)||void 0===o?void 0:o.call(a,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[je.Touch][l][pt.LeftClick]=0;const c=Tl.CreateDeviceEvent(je.Touch,l,pt.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(je.Touch,l,c),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(je.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(i){}this._pointerBlurEvent=()=>{var i,n,s,a,o;if(this.isDeviceAvailable(je.Mouse)){const l=this._inputs[je.Mouse][0];this._mouseId>=0&&(null===(n=(i=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=pt.LeftClick;c<=pt.BrowserForward;c++)if(1===l[c]){l[c]=0;const u=Tl.CreateDeviceEvent(je.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(je.Mouse,0,u)}}if(this.isDeviceAvailable(je.Touch)){const l=this._inputs[je.Touch];for(let c=0;c<this._activeTouchIds.length;c++){const u=this._activeTouchIds[c];if((null===(a=(s=this._elementToAttachTo).hasPointerCapture)||void 0===a?void 0:a.call(s,u))&&this._elementToAttachTo.releasePointerCapture(u),-1!==u&&1===(null===(o=l[c])||void 0===o?void 0:o[pt.LeftClick])){l[c][pt.LeftClick]=0;const h=Tl.CreateDeviceEvent(je.Touch,c,pt.LeftClick,0,this,this._elementToAttachTo,u);this._onInputChanged(je.Touch,c,h),this._activeTouchIds[c]=-1,this._onDeviceDisconnected(je.Touch,c)}}}},this._pointerWheelEvent=i=>{const n=je.Mouse;this._inputs[n]||(this._inputs[n]=[]),this._inputs[n][0]||(this._pointerActive=!0,this._registerDevice(n,0,rC));const a=this._inputs[n][0];if(a){a[pt.MouseWheelX]=i.deltaX||0,a[pt.MouseWheelY]=i.deltaY||i.wheelDelta||0,a[pt.MouseWheelZ]=i.deltaZ||0;const o=i;void 0===i.pointerId&&(i.pointerId=this._mouseId),0!==a[pt.MouseWheelX]&&(o.inputIndex=pt.MouseWheelX,this._onInputChanged(n,0,o)),0!==a[pt.MouseWheelY]&&(o.inputIndex=pt.MouseWheelY,this._onInputChanged(n,0,o)),0!==a[pt.MouseWheelZ]&&(o.inputIndex=pt.MouseWheelZ,this._onInputChanged(n,0,o))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(je.Mouse)){const i=this._inputs[je.Mouse][0];i[pt.MouseWheelX]=0,i[pt.MouseWheelY]=0,i[pt.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const n=navigator.getGamepads()[t];if(n&&e===this._gamepads[t]){this._inputs[e][t][i]=i>=n.buttons.length?n.axes[i-n.buttons.length].valueOf():n.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?je.DualSense:je.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?je.Xbox:-1!==e.indexOf("057e")?je.Switch:je.Generic}_getPointerType(e){let t=je.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=je.Touch),t}}class sC{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new J,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class jz{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=a=>{for(let o=0;o<this._devices.length;o++){const l=this._devices[o];for(const c in l)a._addDevice(new sC(this._deviceInputSystem,o,+c))}this._registeredManagers.push(a)},this.unregisterManager=a=>{const o=this._registeredManagers.indexOf(a);o>-1&&this._registeredManagers.splice(o,1)};const t=Object.keys(je).length/2;this._devices=new Array(t);const i=(a,o)=>{this._devices[a]||(this._devices[a]=new Array),this._devices[a][o]||(this._devices[a][o]=o);for(const l of this._registeredManagers){const c=new sC(this._deviceInputSystem,a,o);l._addDevice(c)}},n=(a,o)=>{var l;(null===(l=this._devices[a])||void 0===l?void 0:l[o])&&delete this._devices[a][o];for(const c of this._registeredManagers)c._removeDevice(a,o)},s=(a,o,l)=>{if(l)for(const c of this._registeredManagers)c._onInputChanged(a,o,l)};this._deviceInputSystem="undefined"!=typeof _native?new Xz(i,n,s):new Yz(e,i,n,s)}dispose(){this._deviceInputSystem.dispose()}}class $z{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(je).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new jz(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new J(i=>{for(const n of this._devices)if(n)for(const s of n)s&&this.onDeviceConnectedObservable.notifyObserver(i,s)}),this.onDeviceDisconnectedObservable=new J,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,n;const s=null===(i=this._devices[e])||void 0===i?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(s),(null===(n=this._devices[e])||void 0===n?void 0:n[t])&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var n,s;null===(s=null===(n=this._devices[e])||void 0===n?void 0:n[t])||void 0===s||s.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case je.Keyboard:case je.Mouse:this._firstDevice[e]=0;break;case je.Touch:case je.DualSense:case je.DualShock:case je.Xbox:case je.Switch:case je.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}class aC{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}let Ja=(()=>{class r{constructor(t){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new We(0,0),this._previousStartingPointerPosition=new We(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=t||Je.LastCreatedScene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(t){return this._meshUnderPointerId[t]||null}get unTranslatedPointer(){return new We(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(t){this._pointerX=t}get pointerY(){return this._pointerY}set pointerY(t){this._pointerY=t}_updatePointerPosition(t){const i=this._scene.getEngine().getInputElementClientRect();!i||(this._pointerX=t.clientX-i.left,this._pointerY=t.clientY-i.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(t,i){const n=this._scene,s=n.getEngine(),a=s.getInputElement();a&&(a.tabIndex=s.canvasTabIndex,n.doNotHandleCursors||(a.style.cursor=n.defaultCursor)),this._setCursorAndPointerOverMesh(t,i,n);for(const c of n._pointerMoveStage)t=c.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,!!(null==t?void 0:t.pickedMesh),a);const o=i.inputIndex>=pt.MouseWheelX&&i.inputIndex<=pt.MouseWheelZ?Ct.POINTERWHEEL:Ct.POINTERMOVE;let l;n.onPointerMove&&(t=t||this._pickMove(i),n.onPointerMove(i,t,o)),t?(l=new qa(o,i,t),this._setRayOnPointerInfo(t,i)):(l=new qa(o,i,null,this),this._movePointerInfo=l),n.onPointerObservable.hasObservers()&&n.onPointerObservable.notifyObservers(l,o)}_setRayOnPointerInfo(t,i){const n=this._scene;t&&n._pickingAvailable&&(t.ray||(t.ray=n.createPickingRay(i.offsetX,i.offsetY,B.Identity(),n.activeCamera)))}_addCameraPointerObserver(t,i){return this._cameraObserverCount++,this._scene.onPointerObservable.add(t,i)}_removeCameraPointerObserver(t){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(t)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(t,i,n){const s=this._scene,a=new Wz(n,i,this._unTranslatedPointerX,this._unTranslatedPointerY);return t&&(a.originalPickingInfo=t,a.ray=t.ray,t.originMesh&&(a.nearInteractionPickingInfo=t)),s.onPrePointerObservable.notifyObservers(a,n),!!a.skipOnPointerObservable}_pickMove(t){const i=this._scene,n=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,i.pointerMovePredicate,!1,i.cameraToUseForPointers,i.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(n,t,i),n}_setCursorAndPointerOverMesh(t,i,n){const a=n.getEngine().getInputElement();if(null==t?void 0:t.pickedMesh){if(this.setPointerOverMesh(t.pickedMesh,i.pointerId,t,i),!n.doNotHandleCursors&&a&&this._pointerOverMesh){const o=this._pointerOverMesh._getActionManagerForTrigger();o&&o.hasPointerTriggers&&(a.style.cursor=o.hoverCursor||n.hoverCursor)}}else this.setPointerOverMesh(null,i.pointerId,t,i)}simulatePointerMove(t,i){const n=new PointerEvent("pointermove",i);n.inputIndex=pt.Move,!this._checkPrePointerObservable(t,n,Ct.POINTERMOVE)&&this._processPointerMove(t,n)}simulatePointerDown(t,i){const n=new PointerEvent("pointerdown",i);n.inputIndex=n.button+2,!this._checkPrePointerObservable(t,n,Ct.POINTERDOWN)&&this._processPointerDown(t,n)}_processPointerDown(t,i){const n=this._scene;if(null==t?void 0:t.pickedMesh){this._pickedDownMesh=t.pickedMesh;const o=t.pickedMesh._getActionManagerForTrigger();if(o){if(o.hasPickTriggers)switch(o.processTrigger(5,Fn.CreateNew(t.pickedMesh,i)),i.button){case 0:o.processTrigger(2,Fn.CreateNew(t.pickedMesh,i));break;case 1:o.processTrigger(4,Fn.CreateNew(t.pickedMesh,i));break;case 2:o.processTrigger(3,Fn.CreateNew(t.pickedMesh,i))}o.hasSpecificTrigger(8)&&window.setTimeout(()=>{const l=n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,c=>c.isPickable&&c.isVisible&&c.isReady()&&c.actionManager&&c.actionManager.hasSpecificTrigger(8)&&c===this._pickedDownMesh,!1,n.cameraToUseForPointers);(null==l?void 0:l.pickedMesh)&&o&&0!==this._totalPointersPressed&&Date.now()-this._startingPointerTime>r.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,o.processTrigger(8,Fn.CreateNew(l.pickedMesh,i)))},r.LongPressDelay)}}else for(const o of n._pointerDownStage)t=o.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,!1);let s;const a=Ct.POINTERDOWN;t?(n.onPointerDown&&n.onPointerDown(i,t,a),s=new qa(a,i,t),this._setRayOnPointerInfo(t,i)):s=new qa(a,i,null,this),n.onPointerObservable.hasObservers()&&n.onPointerObservable.notifyObservers(s,a)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(t,i,n){const s=new PointerEvent("pointerup",i);s.inputIndex=pt.Move;const a=new aC;n?a.doubleClick=!0:a.singleClick=!0,!this._checkPrePointerObservable(t,s,Ct.POINTERUP)&&this._processPointerUp(t,s,a)}_processPointerUp(t,i,n){const s=this._scene;if(null==t?void 0:t.pickedMesh){if(this._pickedUpMesh=t.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(i,t),n.singleClick&&!n.ignore&&s.onPointerObservable.observers.length>this._cameraObserverCount)){const o=Ct.POINTERPICK,l=new qa(o,i,t);this._setRayOnPointerInfo(t,i),s.onPointerObservable.notifyObservers(l,o)}const a=t.pickedMesh._getActionManagerForTrigger();if(a&&!n.ignore){a.processTrigger(7,Fn.CreateNew(t.pickedMesh,i,t)),!n.hasSwiped&&n.singleClick&&a.processTrigger(1,Fn.CreateNew(t.pickedMesh,i,t));const o=t.pickedMesh._getActionManagerForTrigger(6);n.doubleClick&&o&&o.processTrigger(6,Fn.CreateNew(t.pickedMesh,i,t))}}else if(!n.ignore)for(const a of s._pointerUpStage)t=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,n.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const a=this._pickedDownMesh._getActionManagerForTrigger(16);a&&a.processTrigger(16,Fn.CreateNew(this._pickedDownMesh,i))}if(!n.ignore){const a=new qa(Ct.POINTERUP,i,t);if(this._setRayOnPointerInfo(t,i),s.onPointerObservable.notifyObservers(a,Ct.POINTERUP),s.onPointerUp&&s.onPointerUp(i,t,Ct.POINTERUP),!n.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let o=0;if(n.singleClick?o=Ct.POINTERTAP:n.doubleClick&&(o=Ct.POINTERDOUBLETAP),o){const l=new qa(o,i,t);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(o)&&s.onPointerObservable.notifyObservers(l,o)}}}}isPointerCaptured(t=0){return this._pointerCaptures[t]}attachControl(t=!0,i=!0,n=!0,s=null){const a=this._scene,o=a.getEngine();s||(s=o.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new $z(o),this._initActionManager=l=>{if(!this._meshPickProceed){const c=a.skipPointerUpPicking||0===a._registeredActions&&!this._checkForPicking()&&!a.onPointerUp?null:a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);this._currentPickResult=c,c&&(l=c.hit&&c.pickedMesh?c.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return l},this._delayedSimpleClick=(l,c,u)=>{if((Date.now()-this._previousStartingPointerTime>r.DoubleClickDelay&&!this._doubleClickOccured||l!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,c.singleClick=!0,c.ignore=!1,this._delayedClicks[l])){const d=Ct.POINTERTAP,f=new qa(d,this._delayedClicks[l].evt,this._currentPickResult);a.onPointerObservable.hasObservers()&&a.onPointerObservable.hasSpecificMask(d)&&a.onPointerObservable.notifyObservers(f,d),this._delayedClicks[l]=null}},this._initClickEvent=(l,c,u,h)=>{var d,f;const p=new aC;this._currentPickResult=null;let g=null,_=l.hasSpecificMask(Ct.POINTERPICK)||c.hasSpecificMask(Ct.POINTERPICK)||l.hasSpecificMask(Ct.POINTERTAP)||c.hasSpecificMask(Ct.POINTERTAP)||l.hasSpecificMask(Ct.POINTERDOUBLETAP)||c.hasSpecificMask(Ct.POINTERDOUBLETAP);!_&&Lc&&(g=this._initActionManager(g,p),g&&(_=g.hasPickTriggers));let m=!1;if(_){const T=u.button;if(p.hasSwiped=this._isPointerSwiping(),!p.hasSwiped){let v=!r.ExclusiveDoubleClickMode;if(v||(v=!l.hasSpecificMask(Ct.POINTERDOUBLETAP)&&!c.hasSpecificMask(Ct.POINTERDOUBLETAP),v&&!Lc.HasSpecificTrigger(6)&&(g=this._initActionManager(g,p),g&&(v=!g.hasSpecificTrigger(6)))),v)(Date.now()-this._previousStartingPointerTime>r.DoubleClickDelay||T!==this._previousButtonPressed)&&(p.singleClick=!0,h(p,this._currentPickResult),m=!0);else{const S={evt:u,clickInfo:p,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,T,p,h),r.DoubleClickDelay)};this._delayedClicks[T]=S}let A=l.hasSpecificMask(Ct.POINTERDOUBLETAP)||c.hasSpecificMask(Ct.POINTERDOUBLETAP);!A&&Lc.HasSpecificTrigger(6)&&(g=this._initActionManager(g,p),g&&(A=g.hasSpecificTrigger(6))),A&&(T===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<r.DoubleClickDelay&&!this._doubleClickOccured?(p.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=T,r.ExclusiveDoubleClickMode?(this._delayedClicks[T]&&(clearTimeout(null===(f=this._delayedClicks[T])||void 0===f?void 0:f.timeoutId),this._delayedClicks[T]=null),h(p,this._previousPickResult)):h(p,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,p.doubleClick=!0,p.ignore=!1,r.ExclusiveDoubleClickMode&&this._delayedClicks[T]&&(clearTimeout(null===(d=this._delayedClicks[T])||void 0===d?void 0:d.timeoutId),this._delayedClicks[T]=null),h(p,this._currentPickResult)),m=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=T))}}m||h(p,this._currentPickResult)},this._onPointerMove=l=>{if(this._updatePointerPosition(l),!this._isSwiping&&-1!==this._swipeButtonPressed&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>r.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>r.DragMovementThreshold),o.isPointerLock&&o._verifyPointerLock(),this._checkPrePointerObservable(null,l,l.inputIndex>=pt.MouseWheelX&&l.inputIndex<=pt.MouseWheelZ?Ct.POINTERWHEEL:Ct.POINTERMOVE)||!a.cameraToUseForPointers&&!a.activeCamera)return;if(a.skipPointerMovePicking)return void this._processPointerMove(new Za,l);a.pointerMovePredicate||(a.pointerMovePredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(u.enablePointerMoveEvents||a.constantlyUpdateMeshUnderPointer||null!==u._getActionManagerForTrigger())&&(!a.cameraToUseForPointers||0!=(a.cameraToUseForPointers.layerMask&u.layerMask)));const c=a._registeredActions>0?this._pickMove(l):null;this._processPointerMove(c,l)},this._onPointerDown=l=>{var c;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,r.ExclusiveDoubleClickMode)for(let h=0;h<this._delayedClicks.length;h++)if(this._delayedClicks[h])if(l.button===h)clearTimeout(null===(c=this._delayedClicks[h])||void 0===c?void 0:c.timeoutId);else{const d=this._delayedClicks[h].clickInfo;this._doubleClickOccured=!1,d.singleClick=!0,d.ignore=!1;const p=Ct.POINTERTAP,g=new qa(p,this._delayedClicks[h].evt,this._currentPickResult);a.onPointerObservable.hasObservers()&&a.onPointerObservable.hasSpecificMask(p)&&a.onPointerObservable.notifyObservers(g,p),this._delayedClicks[h]=null}if(this._updatePointerPosition(l),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=l.button),a.preventDefaultOnPointerDown&&s&&(l.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,l,Ct.POINTERDOWN)||!a.cameraToUseForPointers&&!a.activeCamera)return;let u;this._pointerCaptures[l.pointerId]=!0,a.pointerDownPredicate||(a.pointerDownPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!a.cameraToUseForPointers||0!=(a.cameraToUseForPointers.layerMask&h.layerMask))),this._pickedDownMesh=null,u=a.skipPointerDownPicking||0===a._registeredActions&&!this._checkForPicking()&&!a.onPointerDown?new Za:a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers),this._processPointerDown(u,l)},this._onPointerUp=l=>{0!==this._totalPointersPressed&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(l),a.preventDefaultOnPointerUp&&s&&(l.preventDefault(),s.focus()),this._initClickEvent(a.onPrePointerObservable,a.onPointerObservable,l,(c,u)=>{if(a.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!c.ignore)){if(this._checkPrePointerObservable(null,l,Ct.POINTERUP))return void(this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1));c.hasSwiped||(c.singleClick&&a.onPrePointerObservable.hasSpecificMask(Ct.POINTERTAP)&&this._checkPrePointerObservable(null,l,Ct.POINTERTAP)&&(this._skipPointerTap=!0),c.doubleClick&&a.onPrePointerObservable.hasSpecificMask(Ct.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,l,Ct.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[l.pointerId]?(0===l.buttons&&(this._pointerCaptures[l.pointerId]=!1),(a.cameraToUseForPointers||a.activeCamera)&&(a.pointerUpPredicate||(a.pointerUpPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!a.cameraToUseForPointers||0!=(a.cameraToUseForPointers.layerMask&h.layerMask))),!this._meshPickProceed&&(Lc&&Lc.HasTriggers||this._checkForPicking()||a.onPointerUp)&&this._initActionManager(null,c),u||(u=this._currentPickResult),this._processPointerUp(u,l,c),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)}))},this._onKeyDown=l=>{const c=Uf.KEYDOWN;if(a.onPreKeyboardObservable.hasObservers()){const u=new iC(c,l);if(a.onPreKeyboardObservable.notifyObservers(u,c),u.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){const u=new aT(c,l);a.onKeyboardObservable.notifyObservers(u,c)}a.actionManager&&a.actionManager.processTrigger(14,Fn.CreateNewFromScene(a,l))},this._onKeyUp=l=>{const c=Uf.KEYUP;if(a.onPreKeyboardObservable.hasObservers()){const u=new iC(c,l);if(a.onPreKeyboardObservable.notifyObservers(u,c),u.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){const u=new aT(c,l);a.onKeyboardObservable.notifyObservers(u,c)}a.actionManager&&a.actionManager.processTrigger(15,Fn.CreateNewFromScene(a,l))},this._deviceSourceManager.onDeviceConnectedObservable.add(l=>{l.deviceType===je.Mouse?l.onInputChangedObservable.add(c=>{c.inputIndex===pt.LeftClick||c.inputIndex===pt.MiddleClick||c.inputIndex===pt.RightClick||c.inputIndex===pt.BrowserBack||c.inputIndex===pt.BrowserForward?i&&1===l.getInput(c.inputIndex)?this._onPointerDown(c):t&&0===l.getInput(c.inputIndex)&&this._onPointerUp(c):n&&(c.inputIndex===pt.Move||c.inputIndex===pt.MouseWheelX||c.inputIndex===pt.MouseWheelY||c.inputIndex===pt.MouseWheelZ)&&this._onPointerMove(c)}):l.deviceType===je.Touch?l.onInputChangedObservable.add(c=>{c.inputIndex===pt.LeftClick&&(i&&1===l.getInput(c.inputIndex)?(this._onPointerDown(c),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):t&&0===l.getInput(c.inputIndex)&&(this._onPointerUp(c),0===this._totalPointersPressed&&(this._isMultiTouchGesture=!1))),n&&c.inputIndex===pt.Move&&this._onPointerMove(c)}):l.deviceType===je.Keyboard&&l.onInputChangedObservable.add(c=>{"keydown"===c.type?this._onKeyDown(c):"keyup"===c.type&&this._onKeyUp(c)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(t,i=0,n,s){if(!(this._meshUnderPointerId[i]!==t||t&&t._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const a=this._meshUnderPointerId[i];let o;a&&(o=a._getActionManagerForTrigger(10),o&&o.processTrigger(10,Fn.CreateNew(a,s,{pointerId:i}))),t?(this._meshUnderPointerId[i]=t,this._pointerOverMesh=t,o=t._getActionManagerForTrigger(9),o&&o.processTrigger(9,Fn.CreateNew(t,s,{pointerId:i,pickResult:n}))):(delete this._meshUnderPointerId[i],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(t){this._pointerOverMesh===t&&(this._pointerOverMesh=null),this._pickedDownMesh===t&&(this._pickedDownMesh=null),this._pickedUpMesh===t&&(this._pickedUpMesh=null);for(const i in this._meshUnderPointerId)this._meshUnderPointerId[i]===t&&delete this._meshUnderPointerId[i]}}return r.DragMovementThreshold=10,r.LongPressDelay=500,r.DoubleClickDelay=300,r.ExclusiveDoubleClickMode=!1,r})(),El=(()=>{class r{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(t,i){!r.Enabled||(this._current+=t,i&&this._fetchResult())}beginMonitoring(){!r.Enabled||(this._startMonitoringTime=Qa.Now)}endMonitoring(t=!0){r.Enabled&&(t&&this.fetchNewFrame(),this._current=Qa.Now-this._startMonitoringTime,t&&this._fetchResult())}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const t=Qa.Now;t-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=t,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}return r.Enabled=!0,r})(),oC=(()=>{class r{static get UniqueId(){const t=this._UniqueIdCounter;return this._UniqueIdCounter++,t}}return r._UniqueIdCounter=1,r})(),Tn=(()=>{class r{static CompareLightsPriority(t,i){return t.shadowEnabled!==i.shadowEnabled?(i.shadowEnabled?1:0)-(t.shadowEnabled?1:0):i.renderPriority-t.renderPriority}}return r.FALLOFF_DEFAULT=0,r.FALLOFF_PHYSICAL=1,r.FALLOFF_GLTF=2,r.FALLOFF_STANDARD=3,r.LIGHTMAP_DEFAULT=0,r.LIGHTMAP_SPECULAR=1,r.LIGHTMAP_SHADOWSONLY=2,r.INTENSITYMODE_AUTOMATIC=0,r.INTENSITYMODE_LUMINOUSPOWER=1,r.INTENSITYMODE_LUMINOUSINTENSITY=2,r.INTENSITYMODE_ILLUMINANCE=3,r.INTENSITYMODE_LUMINANCE=4,r.LIGHTTYPEID_POINTLIGHT=0,r.LIGHTTYPEID_DIRECTIONALLIGHT=1,r.LIGHTTYPEID_SPOTLIGHT=2,r.LIGHTTYPEID_HEMISPHERICLIGHT=3,r})();var qs=(()=>{return(r=qs||(qs={}))[r.BackwardCompatible=0]="BackwardCompatible",r[r.Intermediate=1]="Intermediate",r[r.Aggressive=2]="Aggressive",qs;var r})();let dt=(()=>{class r extends cs{static DefaultMaterialFactory(t){throw ht("StandardMaterial")}static CollisionCoordinatorFactory(){throw ht("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(t){this._environmentTexture!==t&&(this._environmentTexture=t,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(t){if(t!==this._performancePriority){switch(this._performancePriority=t,t){case qs.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case qs.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case qs.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(t)}}set forceWireframe(t){this._forceWireframe!==t&&(this._forceWireframe=t,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(t){this._skipFrustumClipping!==t&&(this._skipFrustumClipping=t)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(t){this._forcePointsCloud!==t&&(this._forcePointsCloud=t,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(t){this._animationPropertiesOverride=t}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set beforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),t&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t))}set afterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),t&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(t))}set beforeCameraRender(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)}set afterCameraRender(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Ja.DragMovementThreshold}static set DragMovementThreshold(t){Ja.DragMovementThreshold=t}static get LongPressDelay(){return Ja.LongPressDelay}static set LongPressDelay(t){Ja.LongPressDelay=t}static get DoubleClickDelay(){return Ja.DoubleClickDelay}static set DoubleClickDelay(t){Ja.DoubleClickDelay=t}static get ExclusiveDoubleClickMode(){return Ja.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(t){Ja.ExclusiveDoubleClickMode=t}bindEyePosition(t,i="vEyePosition",n=!1){var s;const a=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:null!==(s=this.activeCamera.globalPosition)&&void 0!==s?s:this.activeCamera.devicePosition;return z.Vector4[0].set(a.x,a.y,a.z,this.useRightHandedSystem===(null!=this._mirroredCameraPosition)?-1:1),t&&(n?t.setFloat3(i,z.Vector4[0].x,z.Vector4[0].y,z.Vector4[0].z):t.setVector4(i,z.Vector4[0])),z.Vector4[0]}finalizeSceneUbo(){const t=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return t.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),t.update(),t}set useRightHandedSystem(t){this._useRightHandedSystem!==t&&(this._useRightHandedSystem=t,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(t){this._currentStepId=t}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(t){this._fogMode!==t&&(this._fogMode=t,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(t){this._lightsEnabled!==t&&(this._lightsEnabled=t,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(t){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),t&&(this._unObserveActiveCameras=Ob(t,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=t}get activeCamera(){return this._activeCamera}set activeCamera(t){t!==this._activeCamera&&(this._activeCamera=t,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=r.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(t){this._defaultMaterial=t}set texturesEnabled(t){this._texturesEnabled!==t&&(this._texturesEnabled=t,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(t){this._skeletonsEnabled!==t&&(this._skeletonsEnabled=t,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=r.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const t of this._transientComponents)t.register();this._transientComponents.length=0}}_addComponent(t){this._components.push(t),this._transientComponents.push(t),t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(t){for(const i of this._components)if(i.name===t)return i;return null}constructor(t,i){super(),this._inputManager=new Ja(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new ct(.2,.2,.3,1),this.ambientColor=new Fe(0,0,0),this.environmentIntensity=1,this._performancePriority=qs.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new J,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new J,this._onDisposeObserver=null,this.onBeforeRenderObservable=new J,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new J,this.onAfterRenderCameraObservable=new J,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new J,this.onAfterAnimationsObservable=new J,this.onBeforeDrawPhaseObservable=new J,this.onAfterDrawPhaseObservable=new J,this.onReadyObservable=new J,this.onBeforeCameraRenderObservable=new J,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new J,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new J,this.onAfterActiveMeshesEvaluationObservable=new J,this.onBeforeParticlesRenderingObservable=new J,this.onAfterParticlesRenderingObservable=new J,this.onDataLoadedObservable=new J,this.onNewCameraAddedObservable=new J,this.onCameraRemovedObservable=new J,this.onNewLightAddedObservable=new J,this.onLightRemovedObservable=new J,this.onNewGeometryAddedObservable=new J,this.onGeometryRemovedObservable=new J,this.onNewTransformNodeAddedObservable=new J,this.onTransformNodeRemovedObservable=new J,this.onNewMeshAddedObservable=new J,this.onMeshRemovedObservable=new J,this.onNewSkeletonAddedObservable=new J,this.onSkeletonRemovedObservable=new J,this.onNewMaterialAddedObservable=new J,this.onNewMultiMaterialAddedObservable=new J,this.onMaterialRemovedObservable=new J,this.onMultiMaterialRemovedObservable=new J,this.onNewTextureAddedObservable=new J,this.onTextureRemovedObservable=new J,this.onBeforeRenderTargetsRenderObservable=new J,this.onAfterRenderTargetsRenderObservable=new J,this.onBeforeStepObservable=new J,this.onAfterStepObservable=new J,this.onActiveCameraChanged=new J,this.onActiveCamerasChanged=new J,this.onBeforeRenderingGroupObservable=new J,this.onAfterRenderingGroupObservable=new J,this.onMeshImportedObservable=new J,this.onAnimationFileImportedObservable=new J,this._registeredForLateAnimationBindings=new ml(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new J,this.onPointerObservable=new J,this.onPreKeyboardObservable=new J,this.onKeyboardObservable=new J,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=r.FOGMODE_NONE,this.fogColor=new Fe(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new E(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new ml(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new El,this._activeIndices=new El,this._activeParticles=new El,this._activeBones=new El,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new Qn(256),this._processedMaterials=new Qn(256),this._renderTargets=new ml(256),this._materialsRenderTargets=new ml(256),this._activeParticleSystems=new Qn(256),this._activeSkeletons=new ml(32),this._softwareSkinnedMeshes=new ml(32),this._activeAnimatables=new Array,this._transformMatrix=B.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=Ki.Create(),this._beforeClearStage=Ki.Create(),this._beforeRenderTargetClearStage=Ki.Create(),this._gatherRenderTargetsStage=Ki.Create(),this._gatherActiveCameraRenderTargetsStage=Ki.Create(),this._isReadyForMeshStage=Ki.Create(),this._beforeEvaluateActiveMeshStage=Ki.Create(),this._evaluateSubMeshStage=Ki.Create(),this._preActiveMeshStage=Ki.Create(),this._cameraDrawRenderTargetStage=Ki.Create(),this._beforeCameraDrawStage=Ki.Create(),this._beforeRenderTargetDrawStage=Ki.Create(),this._beforeRenderingGroupDrawStage=Ki.Create(),this._beforeRenderingMeshStage=Ki.Create(),this._afterRenderingMeshStage=Ki.Create(),this._afterRenderingGroupDrawStage=Ki.Create(),this._afterCameraDrawStage=Ki.Create(),this._afterCameraPostProcessStage=Ki.Create(),this._afterRenderTargetDrawStage=Ki.Create(),this._afterRenderTargetPostProcessStage=Ki.Create(),this._afterRenderStage=Ki.Create(),this._pointerMoveStage=Ki.Create(),this._pointerDownStage=Ki.Create(),this._pointerUpStage=Ki.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;const n=Mi({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},i);this._engine=t||Je.LastCreatedEngine,n.virtual?this._engine._virtualScenes.push(this):(Je._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new Bf(this),Lf&&(this.postProcessManager=new Lf(this)),rn()&&this.attachControl(),this._createUbo(),Wt&&(this._imageProcessingConfiguration=new Wt),this.setDefaultCandidateProviders(),n.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=n.useMaterialMeshMap,this.useClonedMeshMap=n.useClonedMeshMap,(!i||!i.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(t){return this._defaultSubMeshCandidates.data=t.subMeshes,this._defaultSubMeshCandidates.length=t.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(t){this._inputManager.pointerX=t}get pointerY(){return this._inputManager.pointerY}set pointerY(t){this._inputManager.pointerY=t}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(t,i,n=1){return this._cachedEffect!==i||this._cachedMaterial!==t||this._cachedVisibility!==n}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(t,i){return this._inputManager.simulatePointerMove(t,i),this}simulatePointerDown(t,i){return this._inputManager.simulatePointerDown(t,i),this}simulatePointerUp(t,i,n){return this._inputManager.simulatePointerUp(t,i,n),this}isPointerCaptured(t=0){return this._inputManager.isPointerCaptured(t)}attachControl(t=!0,i=!0,n=!0){this._inputManager.attachControl(t,i,n)}detachControl(){this._inputManager.detachControl()}isReady(t=!0){if(this._isDisposed)return!1;let i;const n=this.getEngine();let s=!0;for(this._pendingData.length>0&&(s=!1),t&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),i=0;i<this.meshes.length;i++){const a=this.meshes[i];if(!a.subMeshes||0===a.subMeshes.length)continue;if(!a.isReady(!0)){s=!1;continue}const o=a.hasThinInstances||"InstancedMesh"===a.getClassName()||"InstancedLinesMesh"===a.getClassName()||n.getCaps().instancedArrays&&a.instances.length>0;for(const c of this._isReadyForMeshStage)c.action(a,o)||(s=!1);if(!t)continue;const l=a.material||this.defaultMaterial;if(l)if(l._storeEffectOnSubMeshes)for(const c of a.subMeshes){const u=c.getMaterial();u&&u.hasRenderTargetTextures&&null!=u.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(u)&&(this._processedMaterials.push(u),this._materialsRenderTargets.concatWithNoDuplicate(u.getRenderTargetTextures()))}else l.hasRenderTargetTextures&&null!=l.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(l)&&(this._processedMaterials.push(l),this._materialsRenderTargets.concatWithNoDuplicate(l.getRenderTargetTextures()))}if(!s||!n.areAllEffectsReady())return!1;if(t)for(i=0;i<this._materialsRenderTargets.length;++i)if(!this._materialsRenderTargets.data[i].isReadyForRendering())return!1;for(i=0;i<this.geometries.length;i++)if(2===this.geometries[i].delayLoadState)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(const a of this.activeCameras)if(!a.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(const a of this.particleSystems)if(!a.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(t){this.onBeforeRenderObservable.add(t)}unregisterBeforeRender(t){this.onBeforeRenderObservable.removeCallback(t)}registerAfterRender(t){this.onAfterRenderObservable.add(t)}unregisterAfterRender(t){this.onAfterRenderObservable.removeCallback(t)}_executeOnceBeforeRender(t){const i=()=>{t(),setTimeout(()=>{this.unregisterBeforeRender(i)})};this.registerBeforeRender(i)}executeOnceBeforeRender(t,i){void 0!==i?setTimeout(()=>{this._executeOnceBeforeRender(t)},i):this._executeOnceBeforeRender(t)}addPendingData(t){this._pendingData.push(t)}removePendingData(t){const i=this.isLoading,n=this._pendingData.indexOf(t);-1!==n&&this._pendingData.splice(n,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(t,i=!1){this.onReadyObservable.addOnce(t),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(i)}whenReadyAsync(t=!1){return new Promise(i=>{this.executeWhenReady(()=>{i()},t)})}_checkIsReady(t=!1){return this._registerTransientComponents(),this.isReady(t)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(t)},100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Qa.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(t,i,n,s){!n&&!s&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),(this._viewUpdateFlag!==t.updateFlag||this._projectionUpdateFlag!==i.updateFlag)&&(this._viewUpdateFlag=t.updateFlag,this._projectionUpdateFlag=i.updateFlag,this._viewMatrix=t,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?as.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=as.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(n,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(t){const i=new He(this._engine,void 0,!1,null!=t?t:"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(t){this._sceneUbo=t,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return oC.UniqueId}addMesh(t,i=!1){this._blockEntityCollection||(this.meshes.push(t),t._resyncLightSources(),t.parent||t._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(n=>{this.addMesh(n)}))}removeMesh(t,i=!1){const n=this.meshes.indexOf(t);return-1!==n&&(this.meshes[n]=this.meshes[this.meshes.length-1],this.meshes.pop(),t.parent||t._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(t),this.onMeshRemovedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(s=>{this.removeMesh(s)}),n}addTransformNode(t){this._blockEntityCollection||t.getScene()===this&&-1!==t._indexInSceneTransformNodesArray||(t._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(t),t.parent||t._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(t))}removeTransformNode(t){const i=t._indexInSceneTransformNodesArray;if(-1!==i){if(i!==this.transformNodes.length-1){const n=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=n,n._indexInSceneTransformNodesArray=i}t._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),t.parent||t._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(t),i}removeSkeleton(t){const i=this.skeletons.indexOf(t);return-1!==i&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(t),this._executeActiveContainerCleanup(this._activeSkeletons)),i}removeMorphTargetManager(t){const i=this.morphTargetManagers.indexOf(t);return-1!==i&&this.morphTargetManagers.splice(i,1),i}removeLight(t){const i=this.lights.indexOf(t);if(-1!==i){for(const n of this.meshes)n._removeLightSource(t,!1);this.lights.splice(i,1),this.sortLightsByPriority(),t.parent||t._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(t),i}removeCamera(t){const i=this.cameras.indexOf(t);if(-1!==i&&(this.cameras.splice(i,1),t.parent||t._removeFromSceneRootNodes()),this.activeCameras){const n=this.activeCameras.indexOf(t);-1!==n&&this.activeCameras.splice(n,1)}return this.activeCamera===t&&(this.activeCamera=this.cameras.length>0?this.cameras[0]:null),this.onCameraRemovedObservable.notifyObservers(t),i}removeParticleSystem(t){const i=this.particleSystems.indexOf(t);return-1!==i&&(this.particleSystems.splice(i,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),i}removeAnimation(t){const i=this.animations.indexOf(t);return-1!==i&&this.animations.splice(i,1),i}stopAnimation(t,i,n){}removeAnimationGroup(t){const i=this.animationGroups.indexOf(t);return-1!==i&&this.animationGroups.splice(i,1),i}removeMultiMaterial(t){const i=this.multiMaterials.indexOf(t);return-1!==i&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(t),i}removeMaterial(t){const i=t._indexInSceneMaterialArray;if(-1!==i&&i<this.materials.length){if(i!==this.materials.length-1){const n=this.materials[this.materials.length-1];this.materials[i]=n,n._indexInSceneMaterialArray=i}t._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(t),i}removeActionManager(t){const i=this.actionManagers.indexOf(t);return-1!==i&&this.actionManagers.splice(i,1),i}removeTexture(t){const i=this.textures.indexOf(t);return-1!==i&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(t),i}addLight(t){if(!this._blockEntityCollection){this.lights.push(t),this.sortLightsByPriority(),t.parent||t._addToSceneRootNodes();for(const i of this.meshes)-1===i.lightSources.indexOf(t)&&(i.lightSources.push(t),i._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(t)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Tn.CompareLightsPriority)}addCamera(t){this._blockEntityCollection||(this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t),t.parent||t._addToSceneRootNodes())}addSkeleton(t){this._blockEntityCollection||(this.skeletons.push(t),this.onNewSkeletonAddedObservable.notifyObservers(t))}addParticleSystem(t){this._blockEntityCollection||this.particleSystems.push(t)}addAnimation(t){this._blockEntityCollection||this.animations.push(t)}addAnimationGroup(t){this._blockEntityCollection||this.animationGroups.push(t)}addMultiMaterial(t){this._blockEntityCollection||(this.multiMaterials.push(t),this.onNewMultiMaterialAddedObservable.notifyObservers(t))}addMaterial(t){this._blockEntityCollection||t.getScene()===this&&-1!==t._indexInSceneMaterialArray||(t._indexInSceneMaterialArray=this.materials.length,this.materials.push(t),this.onNewMaterialAddedObservable.notifyObservers(t))}addMorphTargetManager(t){this._blockEntityCollection||this.morphTargetManagers.push(t)}addGeometry(t){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=this.geometries.length),this.geometries.push(t))}addActionManager(t){this.actionManagers.push(t)}addTexture(t){this._blockEntityCollection||(this.textures.push(t),this.onNewTextureAddedObservable.notifyObservers(t))}switchActiveCamera(t,i=!0){!this._engine.getInputElement()||(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=t,i&&t.attachControl())}setActiveCameraById(t){const i=this.getCameraById(t);return i?(this.activeCamera=i,i):null}setActiveCameraByName(t){const i=this.getCameraByName(t);return i?(this.activeCamera=i,i):null}getAnimationGroupByName(t){for(let i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===t)return this.animationGroups[i];return null}_getMaterial(t,i){for(let n=0;n<this.materials.length;n++){const s=this.materials[n];if(i(s))return s}if(t)for(let n=0;n<this.multiMaterials.length;n++){const s=this.multiMaterials[n];if(i(s))return s}return null}getMaterialByUniqueID(t,i=!1){return this._getMaterial(i,n=>n.uniqueId===t)}getMaterialById(t,i=!1){return this._getMaterial(i,n=>n.id===t)}getMaterialByName(t,i=!1){return this._getMaterial(i,n=>n.name===t)}getLastMaterialById(t,i=!1){for(let n=this.materials.length-1;n>=0;n--)if(this.materials[n].id===t)return this.materials[n];if(i)for(let n=this.multiMaterials.length-1;n>=0;n--)if(this.multiMaterials[n].id===t)return this.multiMaterials[n];return null}getTextureByUniqueId(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===t)return this.textures[i];return null}getTextureByName(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].name===t)return this.textures[i];return null}getCameraById(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].id===t)return this.cameras[i];return null}getCameraByUniqueId(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===t)return this.cameras[i];return null}getCameraByName(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].name===t)return this.cameras[i];return null}getBoneById(t){for(let i=0;i<this.skeletons.length;i++){const n=this.skeletons[i];for(let s=0;s<n.bones.length;s++)if(n.bones[s].id===t)return n.bones[s]}return null}getBoneByName(t){for(let i=0;i<this.skeletons.length;i++){const n=this.skeletons[i];for(let s=0;s<n.bones.length;s++)if(n.bones[s].name===t)return n.bones[s]}return null}getLightByName(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].name===t)return this.lights[i];return null}getLightById(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].id===t)return this.lights[i];return null}getLightByUniqueId(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===t)return this.lights[i];return null}getParticleSystemById(t){for(let i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===t)return this.particleSystems[i];return null}getGeometryById(t){for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].id===t)return this.geometries[i];return null}_getGeometryByUniqueId(t){if(this._geometriesByUniqueId){const i=this._geometriesByUniqueId[t];if(void 0!==i)return this.geometries[i]}else for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===t)return this.geometries[i];return null}pushGeometry(t,i){return!(!i&&this._getGeometryByUniqueId(t.uniqueId)||(this.addGeometry(t),this.onNewGeometryAddedObservable.notifyObservers(t),0))}removeGeometry(t){let i;if(this._geometriesByUniqueId){if(i=this._geometriesByUniqueId[t.uniqueId],void 0===i)return!1}else if(i=this.geometries.indexOf(t),i<0)return!1;if(i!==this.geometries.length-1){const n=this.geometries[this.geometries.length-1];n&&(this.geometries[i]=n,this._geometriesByUniqueId&&(this._geometriesByUniqueId[n.uniqueId]=i))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(t),!0}getGeometries(){return this.geometries}getMeshById(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].id===t)return this.meshes[i];return null}getMeshesById(t){return this.meshes.filter(function(i){return i.id===t})}getTransformNodeById(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===t)return this.transformNodes[i];return null}getTransformNodeByUniqueId(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===t)return this.transformNodes[i];return null}getTransformNodesById(t){return this.transformNodes.filter(function(i){return i.id===t})}getMeshByUniqueId(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===t)return this.meshes[i];return null}getLastMeshById(t){for(let i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];return null}getLastEntryById(t){let i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===t)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===t)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===t)return this.lights[i];return null}getNodeById(t){const i=this.getMeshById(t);if(i)return i;const n=this.getTransformNodeById(t);if(n)return n;const s=this.getLightById(t);if(s)return s;const a=this.getCameraById(t);return a||(this.getBoneById(t)||null)}getNodeByName(t){const i=this.getMeshByName(t);if(i)return i;const n=this.getTransformNodeByName(t);if(n)return n;const s=this.getLightByName(t);if(s)return s;const a=this.getCameraByName(t);return a||(this.getBoneByName(t)||null)}getMeshByName(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].name===t)return this.meshes[i];return null}getTransformNodeByName(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===t)return this.transformNodes[i];return null}getLastSkeletonById(t){for(let i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByUniqueId(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===t)return this.skeletons[i];return null}getSkeletonById(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByName(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===t)return this.skeletons[i];return null}getMorphTargetManagerById(t){for(let i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===t)return this.morphTargetManagers[i];return null}getMorphTargetById(t){for(let i=0;i<this.morphTargetManagers.length;++i){const n=this.morphTargetManagers[i];for(let s=0;s<n.numTargets;++s){const a=n.getTarget(s);if(a.id===t)return a}}return null}getMorphTargetByName(t){for(let i=0;i<this.morphTargetManagers.length;++i){const n=this.morphTargetManagers[i];for(let s=0;s<n.numTargets;++s){const a=n.getTarget(s);if(a.name===t)return a}}return null}getPostProcessByName(t){for(let i=0;i<this.postProcesses.length;++i){const n=this.postProcesses[i];if(n.name===t)return n}return null}isActiveMesh(t){return-1!==this._activeMeshes.indexOf(t)}get uid(){return this._uid||(this._uid=Ie.RandomId()),this._uid}addExternalData(t,i){return this._externalData||(this._externalData=new eC),this._externalData.add(t,i)}getExternalData(t){return this._externalData?this._externalData.get(t):null}getOrAddExternalDataWithFactory(t,i){return this._externalData||(this._externalData=new eC),this._externalData.getOrAddWithFactory(t,i)}removeExternalData(t){return this._externalData.remove(t)}_evaluateSubMesh(t,i,n,s){if(s||t.isInFrustum(this._frustumPlanes)){for(const o of this._evaluateSubMeshStage)o.action(i,t);const a=t.getMaterial();null!=a&&(a.hasRenderTargetTextures&&null!=a.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(a)&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures())),this._renderingManager.dispatch(t,i,a))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(t){this._preventFreeActiveMeshesAndRenderingGroups!==t&&(t&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=t)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let t=0;t<this.activeCameras.length;t++){const i=this.activeCameras[t];i&&i._activeMeshes&&i._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let t=0;t<this.textures.length;t++){const i=this.textures[t];i&&i.renderList&&i.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(t=!1,i,n,s=!0,a=!1){return this.executeWhenReady(()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=a,this._skipEvaluateActiveMeshesCompletely=t,s)for(let o=0;o<this._activeMeshes.length;o++)this._activeMeshes.data[o]._freeze();i&&i()}else n&&n("No active camera found")}),this}unfreezeActiveMeshes(){for(let t=0;t<this.meshes.length;t++){const i=this.meshes[t];i._internalAbstractMeshDataInfo&&(i._internalAbstractMeshDataInfo._isActive=!1)}for(let t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(t){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>t.dispose())}_evaluateActiveMeshes(){var t;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(null===(t=this.activeCamera)||void 0===t||t._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const s=this._activeMeshes.length;for(let a=0;a<s;a++)this._activeMeshes.data[a].computeWorldMatrix()}if(this._activeParticleSystems){const s=this._activeParticleSystems.length;for(let a=0;a<s;a++)this._activeParticleSystems.data[a].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const s of this._beforeEvaluateActiveMeshStage)s.action();const i=this.getActiveMeshCandidates(),n=i.length;for(let s=0;s<n;s++){const a=i.data[s];if(a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,a.isBlocked||(this._totalVertices.addCount(a.getTotalVertices(),!1),!a.isReady()||!a.isEnabled()||a.scaling.hasAZeroComponent))continue;a.computeWorldMatrix(),a.actionManager&&a.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(a);let o=this.customLODSelector?this.customLODSelector(a,this.activeCamera):a.getLOD(this.activeCamera);if(a._internalAbstractMeshDataInfo._currentLOD=o,a._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=o&&(o!==a&&0!==o.billboardMode&&o.computeWorldMatrix(),a._preActivate(),a.isVisible&&a.visibility>0&&0!=(a.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||a.alwaysSelectAsActiveMesh||a.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(a),this.activeCamera._activeMeshes.push(a),o!==a&&o._activate(this._renderId,!1);for(const l of this._preActiveMeshStage)l.action(a);a._activate(this._renderId,!1)&&(a.isAnInstance?a._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=a):o._internalAbstractMeshDataInfo._onlyForInstances=!1,o._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(a,o)),a._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let s=0;s<this.particleSystems.length;s++){const a=this.particleSystems[s];if(!a.isStarted()||!a.emitter)continue;const o=a.emitter;(!o.position||o.isEnabled())&&(this._activeParticleSystems.push(a),a.animate(),this._renderingManager.dispatchParticles(a))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(t,i){this._skeletonsEnabled&&null!=i.skeleton&&(this._activeSkeletons.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this._activeBones.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(i));let n=t.hasInstances||t.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||i.alwaysSelectAsActiveMesh;if(i&&i.subMeshes&&i.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(i),a=s.length;n=n||1===a;for(let o=0;o<a;o++)this._evaluateSubMesh(s.data[o],i,t,n)}}updateTransformMatrix(t){if(this.activeCamera)if(this.activeCamera._renderingMultiview){const i=this.activeCamera._rigCameras[0],n=this.activeCamera._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(t),n.getViewMatrix(),n.getProjectionMatrix(t))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))}_bindFrameBuffer(t,i=!0){t&&t._multiviewTexture?t._multiviewTexture._bindFrameBuffer():t&&t.outputRenderTarget?t.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),i&&this._clearFrameBuffer(t)}_clearFrameBuffer(t){if(!t||!t._multiviewTexture)if(t&&t.outputRenderTarget&&!t._renderingMultiview){const i=t.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this._engine):i.skipInitialClear||(this.autoClear&&this._engine.clear(i.clearColor||this.clearColor,!i._cleared,!0,!0),i._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(t,i,n=!0){var s,a,o;if(t&&t._skipRendering)return;const l=this._engine;if(this._activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");if(l.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&n){let u=!0;t._renderingMultiview&&t.outputRenderTarget&&(u=t.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,t.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),t._renderingMultiview&&t.outputRenderTarget&&(t.outputRenderTarget.skipInitialClear=u)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let u=0;u<this._softwareSkinnedMeshes.length;u++){const h=this._softwareSkinnedMeshes.data[u];h.applySkeleton(h.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const u of this._gatherActiveCameraRenderTargetsStage)u.action(this._renderTargets);let c=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Ie.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let u=0;u<this._renderTargets.length;u++){const h=this._renderTargets.data[u];h._shouldRender()&&(this._renderId++,h.render(h.activeCamera&&h.activeCamera!==this.activeCamera,this.dumpNextRenderTargets),c=!0)}Ie.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const u of this._cameraDrawRenderTargetStage)c=u.action(this.activeCamera)||c;this._intermediateRendering=!1}this._engine.currentRenderPassId=null!==(o=null!==(a=null===(s=t.outputRenderTarget)||void 0===s?void 0:s.renderPassId)&&void 0!==a?a:t.renderPassId)&&void 0!==o?o:0,c&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!t._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const u of this._beforeCameraDrawStage)u.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),l.snapshotRendering&&1===l.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const u of this._afterCameraDrawStage)u.action(this.activeCamera);this.postProcessManager&&!t._multiviewTexture&&this.postProcessManager._finalizeFrame(t.isIntermediate,t.outputRenderTarget?t.outputRenderTarget.renderTarget:void 0);for(const u of this._afterCameraPostProcessStage)u.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(t,i=!0){if(0===t.cameraRigMode||t._renderingMultiview)return t._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(t,void 0,i),void this.onAfterRenderCameraObservable.notifyObservers(t);if(t._useMultiviewToSingleView)this._renderMultiviewToSingleView(t);else{this.onBeforeCameraRenderObservable.notifyObservers(t);for(let n=0;n<t._rigCameras.length;n++)this._renderForCamera(t._rigCameras[n],t)}this._activeCamera=t,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(t)}_checkIntersections(){for(let t=0;t<this._meshesForIntersections.length;t++){const i=this._meshesForIntersections.data[t];if(i.actionManager)for(let n=0;i.actionManager&&n<i.actionManager.actions.length;n++){const s=i.actionManager.actions[n];if(12===s.trigger||13===s.trigger){const a=s.getTriggerParameter(),o=a.mesh?a.mesh:a,l=o.intersectsMesh(i,a.usePreciseIntersection),c=i._intersectionsInProgress.indexOf(o);l&&-1===c?12===s.trigger?(s._executeCurrent(Fn.CreateNew(i,void 0,o)),i._intersectionsInProgress.push(o)):13===s.trigger&&i._intersectionsInProgress.push(o):!l&&c>-1&&(13===s.trigger&&s._executeCurrent(Fn.CreateNew(i,void 0,o)),(!i.actionManager.hasSpecificTrigger(13,u=>o===(u.mesh?u.mesh:u))||13===s.trigger)&&i._intersectionsInProgress.splice(c,1))}}}}_advancePhysicsEngineStep(t){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let t=Math.max(r.MinDeltaTime,Math.min(this._engine.getDeltaTime(),r.MaxDeltaTime))+this._timeAccumulator;const i=this._engine.getTimeStep(),n=1e3/i/1e3;let s=0;const a=this._engine.getLockstepMaxSteps();let o=Math.floor(t/i);for(o=Math.min(o,a);t>0&&s<o;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*n,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,t-=i;this._timeAccumulator=t<0?0:t}else{const t=this.useConstantAnimationDeltaTime?16:Math.max(r.MinDeltaTime,Math.min(this._engine.getDeltaTime(),r.MaxDeltaTime));this._animationRatio=.06*t,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(t){var i;if((null==t?void 0:t.outputRenderTarget)&&!(null==t?void 0:t.isRigCamera)&&(t.outputRenderTarget._cleared=!1),null===(i=null==t?void 0:t.rigCameras)||void 0===i?void 0:i.length)for(let n=0;n<t.rigCameras.length;++n){const s=t.rigCameras[n].outputRenderTarget;s&&(s._cleared=!1)}}resetDrawCache(t){if(this.meshes)for(const i of this.meshes)i.resetDrawCache(t)}render(t=!0,i=!1){var n,s,a;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),(null===(n=this.activeCameras)||void 0===n?void 0:n.length)&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(const c of this._beforeCameraUpdateStage)c.action();if(t)if(this.activeCameras&&this.activeCameras.length>0)for(let c=0;c<this.activeCameras.length;c++){const u=this.activeCameras[c];if(u.update(),0!==u.cameraRigMode)for(let h=0;h<u._rigCameras.length;h++)u._rigCameras[h].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let c=0;c<this.activeCamera._rigCameras.length;c++)this.activeCamera._rigCameras[c].update();this.onBeforeRenderObservable.notifyObservers(this);const o=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const l=(null===(s=this.activeCameras)||void 0===s?void 0:s.length)?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Ie.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let c=0;c<this.customRenderTargets.length;c++){const u=this.customRenderTargets[c];if(u._shouldRender()){if(this._renderId++,this.activeCamera=u.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");o.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),u.render(l!==this.activeCamera,this.dumpNextRenderTargets)}}Ie.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!==(a=null==l?void 0:l.renderPassId)&&void 0!==a?a:0,this.activeCamera=l,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const c of this._beforeClearStage)c.action();this._clearFrameBuffer(this.activeCamera);for(const c of this._gatherRenderTargetsStage)c.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let c=0;c<this.activeCameras.length;c++)this._processSubCameras(this.activeCameras[c],c>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const c of this._afterRenderStage)c.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let c=0;c<this._toBeDisposed.length;c++){const u=this._toBeDisposed[c];u&&u.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].freeze()}unfreezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const t=this._activeRequests.slice();for(const a of t)a.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(a){console.error("An error occurred while calling onDisposeObservable!",a)}if(this.detachControl(),this._engine.getInputElement())for(let a=0;a<this.cameras.length;a++)this.cameras[a].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,a=>a.dispose(!0)),this._disposeList(this.transformNodes,a=>a.dispose(!0)),this._disposeList(this.cameras),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let s=this._engine.scenes.indexOf(this);s>-1&&this._engine.scenes.splice(s,1),Je._LastCreatedScene===this&&(Je._LastCreatedScene=this._engine.scenes.length>0?this._engine.scenes[this._engine.scenes.length-1]:null),s=this._engine._virtualScenes.indexOf(this),s>-1&&this._engine._virtualScenes.splice(s,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(t,i){const n=t.slice(0);i=null!=i?i:s=>s.dispose();for(const s of n)i(s);t.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let t=0;t<this.meshes.length;t++){const n=this.meshes[t].geometry;n&&n.clearCachedData()}}cleanCachedTextureBuffer(){for(const t of this.textures)t._buffer&&(t._buffer=null)}getWorldExtends(t){const i=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return this.meshes.filter(t=t||(()=>!0)).forEach(s=>{if(s.computeWorldMatrix(!0),!s.subMeshes||0===s.subMeshes.length||s.infiniteDistance)return;const a=s.getBoundingInfo(),l=a.boundingBox.maximumWorld;E.CheckExtends(a.boundingBox.minimumWorld,i,n),E.CheckExtends(l,i,n)}),{min:i,max:n}}createPickingRay(t,i,n,s,a=!1){throw ht("Ray")}createPickingRayToRef(t,i,n,s,a,o=!1,l=!1){throw ht("Ray")}createPickingRayInCameraSpace(t,i,n){throw ht("Ray")}createPickingRayInCameraSpaceToRef(t,i,n,s){throw ht("Ray")}get _pickingAvailable(){return!1}pick(t,i,n,s,a,o){return new Za}pickWithBoundingInfo(t,i,n,s,a){return new Za}pickWithRay(t,i,n,s){throw ht("Ray")}multiPick(t,i,n,s,a){throw ht("Ray")}multiPickWithRay(t,i,n){throw ht("Ray")}setPointerOverMesh(t,i,n){this._inputManager.setPointerOverMesh(t,i,n)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const t of this._components)t.rebuild();for(const t of this.particleSystems)t.rebuild();if(this.spriteManagers)for(const t of this.spriteManagers)t.rebuild()}_rebuildTextures(){for(const t of this.textures)t._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(t,i,n){if(void 0===i)return t;const s=[];n=n||(a=>{});for(const a in t){const o=t[a];Gt&&Gt.MatchesQuery(o,i)&&(s.push(o),n(o))}return s}getMeshesByTags(t,i){return this._getByTags(this.meshes,t,i)}getCamerasByTags(t,i){return this._getByTags(this.cameras,t,i)}getLightsByTags(t,i){return this._getByTags(this.lights,t,i)}getMaterialByTags(t,i){return this._getByTags(this.materials,t,i).concat(this._getByTags(this.multiMaterials,t,i))}getTransformNodesByTags(t,i){return this._getByTags(this.transformNodes,t,i)}setRenderingOrder(t,i=null,n=null,s=null){this._renderingManager.setRenderingOrder(t,i,n,s)}setRenderingAutoClearDepthStencil(t,i,n=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(t,i,n,s)}getAutoClearDepthStencilSetup(t){return this._renderingManager.getAutoClearDepthStencilSetup(t)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(t){this._blockMaterialDirtyMechanism!==t&&(this._blockMaterialDirtyMechanism=t,t||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(t,i){if(!this._blockMaterialDirtyMechanism)for(const n of this.materials)i&&!i(n)||n.markAsDirty(t)}_loadFile(t,i,n,s,a,o,l){const c=Bo(t,i,n,s?this.offlineProvider:void 0,a,o,l);return this._activeRequests.push(c),c.onCompleteObservable.add(u=>{this._activeRequests.splice(this._activeRequests.indexOf(u),1)}),c}_loadFileAsync(t,i,n,s,a){return new Promise((o,l)=>{this._loadFile(t,c=>{o(c)},i,n,s,(c,u)=>{l(u)},a)})}_requestFile(t,i,n,s,a,o,l){const c=nT(t,i,n,s?this.offlineProvider:void 0,a,o,l);return this._activeRequests.push(c),c.onCompleteObservable.add(u=>{this._activeRequests.splice(this._activeRequests.indexOf(u),1)}),c}_requestFileAsync(t,i,n,s,a){return new Promise((o,l)=>{this._requestFile(t,c=>{o(c)},i,n,s,c=>{l(c)},a)})}_readFile(t,i,n,s,a){const o=_h(t,i,n,s,a);return this._activeRequests.push(o),o.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),o}_readFileAsync(t,i,n){return new Promise((s,a)=>{this._readFile(t,o=>{s(o)},i,n,o=>{a(o)})})}getPerfCollector(){throw ht("performanceViewerSceneExtension")}}return r.FOGMODE_NONE=0,r.FOGMODE_EXP=1,r.FOGMODE_EXP2=2,r.FOGMODE_LINEAR=3,r.MinDeltaTime=1,r.MaxDeltaTime=1e3,r})();dt.prototype.setActiveCameraByID=function(r){return this.setActiveCameraById(r)},dt.prototype.getLastMaterialByID=function(r){return this.getLastMaterialById(r)},dt.prototype.getMaterialByID=function(r){return this.getMaterialById(r)},dt.prototype.getTextureByUniqueID=function(r){return this.getTextureByUniqueId(r)},dt.prototype.getCameraByID=function(r){return this.getCameraById(r)},dt.prototype.getCameraByUniqueID=function(r){return this.getCameraByUniqueId(r)},dt.prototype.getBoneByID=function(r){return this.getBoneById(r)},dt.prototype.getLightByID=function(r){return this.getLightById(r)},dt.prototype.getLightByUniqueID=function(r){return this.getLightByUniqueId(r)},dt.prototype.getParticleSystemByID=function(r){return this.getParticleSystemById(r)},dt.prototype.getGeometryByID=function(r){return this.getGeometryById(r)},dt.prototype.getMeshByID=function(r){return this.getMeshById(r)},dt.prototype.getMeshesByID=function(r){return this.getMeshesById(r)},dt.prototype.getTransformNodeByID=function(r){return this.getTransformNodeById(r)},dt.prototype.getTransformNodeByUniqueID=function(r){return this.getTransformNodeByUniqueId(r)},dt.prototype.getTransformNodesByID=function(r){return this.getTransformNodesById(r)},dt.prototype.getMeshByUniqueID=function(r){return this.getMeshByUniqueId(r)},dt.prototype.getLastMeshByID=function(r){return this.getLastMeshById(r)},dt.prototype.getLastEntryByID=function(r){return this.getLastEntryById(r)},dt.prototype.getNodeByID=function(r){return this.getNodeById(r)},dt.prototype.getLastSkeletonByID=function(r){return this.getLastSkeletonById(r)};class xi extends $i{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,n=null,s=null,a=null,o=null){super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._absoluteTransform=new B,this._invertedAbsoluteTransform=new B,this._scalingDeterminant=1,this._worldTransform=new B,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=n?n.clone():B.Identity(),this._restPose=s||this._localMatrix.clone(),this._baseMatrix=a||this._localMatrix.clone(),this._index=o,t.bones.push(this),this.setParent(i,!1),(a||n)&&this._updateDifferenceMatrix()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);-1!==i&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateDifferenceMatrix(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBaseMatrix(){return this._baseMatrix}getRestPose(){return this._restPose}setRestPose(e){this._restPose.copyFrom(e)}getBindPose(){return this._baseMatrix}setBindPose(e){this.updateMatrix(e)}getWorldMatrix(){return this._worldTransform}returnToRest(){var e;if(this._linkedTransformNode){const t=z.Vector3[0],i=z.Quaternion[0],n=z.Vector3[1];this.getRestPose().decompose(t,i,n),this._linkedTransformNode.position.copyFrom(n),this._linkedTransformNode.rotationQuaternion=null!==(e=this._linkedTransformNode.rotationQuaternion)&&void 0!==e?e:Be.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restPose}getInvertedAbsoluteTransform(){return this._invertedAbsoluteTransform}getAbsoluteTransform(){return this._absoluteTransform}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=E.Zero(),this._localRotation=Be.Zero(),this._localPosition=E.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling)return void(this._needToCompose=!1);this._needToCompose=!1,B.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._baseMatrix.copyFrom(e),t&&this._updateDifferenceMatrix(),i?this._matrix=e:this.markAsDirty()}_updateDifferenceMatrix(e,t=!0){if(e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}translate(e,t=Yt.LOCAL,i){const n=this.getLocalMatrix();if(t==Yt.LOCAL)n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z);else{let s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const a=xi._TmpMats[0],o=xi._TmpVecs[0];this.parent?i&&s?(a.copyFrom(this.parent.getAbsoluteTransform()),a.multiplyToRef(s,a)):a.copyFrom(this.parent.getAbsoluteTransform()):B.IdentityToRef(a),a.setTranslationFromFloats(0,0,0),a.invert(),E.TransformCoordinatesToRef(e,a,o),n.addAtIndex(12,o.x),n.addAtIndex(13,o.y),n.addAtIndex(14,o.z)}this._markAsDirtyAndDecompose()}setPosition(e,t=Yt.LOCAL,i){const n=this.getLocalMatrix();if(t==Yt.LOCAL)n.setTranslationFromFloats(e.x,e.y,e.z);else{let s=null;i&&(s=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const a=xi._TmpMats[0],o=xi._TmpVecs[0];this.parent?(i&&s?(a.copyFrom(this.parent.getAbsoluteTransform()),a.multiplyToRef(s,a)):a.copyFrom(this.parent.getAbsoluteTransform()),a.invert()):B.IdentityToRef(a),E.TransformCoordinatesToRef(e,a,o),n.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}setAbsolutePosition(e,t){this.setPosition(e,Yt.WORLD,t)}scale(e,t,i,n=!1){const s=this.getLocalMatrix(),a=xi._TmpMats[0];B.ScalingToRef(e,t,i,a),a.multiplyToRef(s,s),a.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),n)for(const o of this.children)o.scale(e,t,i,n)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,n=Yt.LOCAL,s){if(n===Yt.LOCAL){const l=xi._TmpQuat;return Be.RotationYawPitchRollToRef(e,t,i,l),void this.setRotationQuaternion(l,n,s)}const a=xi._TmpMats[0];if(!this._getNegativeRotationToRef(a,s))return;const o=xi._TmpMats[1];B.RotationYawPitchRollToRef(e,t,i,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,n,s)}rotate(e,t,i=Yt.LOCAL,n){const s=xi._TmpMats[0];s.setTranslationFromFloats(0,0,0),B.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,i,n)}setAxisAngle(e,t,i=Yt.LOCAL,n){if(i===Yt.LOCAL){const o=xi._TmpQuat;return Be.RotationAxisToRef(e,t,o),void this.setRotationQuaternion(o,i,n)}const s=xi._TmpMats[0];if(!this._getNegativeRotationToRef(s,n))return;const a=xi._TmpMats[1];B.RotationAxisToRef(e,t,a),s.multiplyToRef(a,a),this._rotateWithMatrix(a,i,n)}setRotation(e,t=Yt.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Yt.LOCAL,i){if(t===Yt.LOCAL)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const n=xi._TmpMats[0];if(!this._getNegativeRotationToRef(n,i))return;const s=xi._TmpMats[1];B.FromQuaternionToRef(e,s),n.multiplyToRef(s,s),this._rotateWithMatrix(s,t,i)}setRotationMatrix(e,t=Yt.LOCAL,i){if(t===Yt.LOCAL){const a=xi._TmpQuat;return Be.FromRotationMatrixToRef(e,a),void this.setRotationQuaternion(a,t,i)}const n=xi._TmpMats[0];if(!this._getNegativeRotationToRef(n,i))return;const s=xi._TmpMats[1];s.copyFrom(e),n.multiplyToRef(e,s),this._rotateWithMatrix(s,t,i)}_rotateWithMatrix(e,t=Yt.LOCAL,i){const n=this.getLocalMatrix(),s=n.m[12],a=n.m[13],o=n.m[14],l=this.getParent(),c=xi._TmpMats[3],u=xi._TmpMats[4];l&&t==Yt.WORLD?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteTransform().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteTransform()),u.copyFrom(c),u.invert(),n.multiplyToRef(c,n),n.multiplyToRef(e,n),n.multiplyToRef(u,n)):t==Yt.WORLD&&i?(c.copyFrom(i.getWorldMatrix()),u.copyFrom(c),u.invert(),n.multiplyToRef(c,n),n.multiplyToRef(e,n),n.multiplyToRef(u,n)):n.multiplyToRef(e,n),n.setTranslationFromFloats(s,a,o),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()}_getNegativeRotationToRef(e,t){const i=xi._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t?(e.multiplyToRef(t.getWorldMatrix(),e),B.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):B.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Yt.LOCAL,t=null){const i=E.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Yt.LOCAL,t,i){if(e==Yt.LOCAL){const n=this.getLocalMatrix();i.x=n.m[12],i.y=n.m[13],i.z=n.m[14]}else{let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let s=xi._TmpMats[0];t&&n?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(n,s)):s=this.getAbsoluteTransform(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=E.Zero();return this.getPositionToRef(Yt.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Yt.WORLD,e,t)}computeAbsoluteTransforms(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteTransform.multiplyToRef(i,this._absoluteTransform)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteTransforms()}getDirection(e,t=null){const i=E.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const s=xi._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),t&&n&&s.multiplyToRef(n,s),E.TransformNormalToRef(e,s,i),i.normalize()}getRotation(e=Yt.LOCAL,t=null){const i=E.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Yt.LOCAL,t=null,i){const n=xi._TmpQuat;this.getRotationQuaternionToRef(e,t,n),n.toEulerAnglesToRef(i)}getRotationQuaternion(e=Yt.LOCAL,t=null){const i=Be.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Yt.LOCAL,t=null,i){if(e==Yt.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const n=xi._TmpMats[0],s=this.getAbsoluteTransform();t?s.multiplyToRef(t.getWorldMatrix(),n):n.copyFrom(s),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.decompose(void 0,i,void 0)}}getRotationMatrix(e=Yt.LOCAL,t){const i=B.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Yt.LOCAL,t,i){if(e==Yt.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const n=xi._TmpMats[0],s=this.getAbsoluteTransform();t?s.multiplyToRef(t.getWorldMatrix(),n):n.copyFrom(s),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=E.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let s=xi._TmpMats[0];t&&n?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(n,s)):s=this.getAbsoluteTransform(),E.TransformCoordinatesToRef(e,s,i)}getLocalPositionFromAbsolute(e,t=null){const i=E.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const s=xi._TmpMats[0];s.copyFrom(this.getAbsoluteTransform()),t&&n&&s.multiplyToRef(n,s),s.invert(),E.TransformCoordinatesToRef(e,s,i)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}xi._TmpVecs=mn.BuildArray(2,E.Zero),xi._TmpQuat=Be.Identity(),xi._TmpMats=mn.BuildArray(5,B.Identity);class lC{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,n=100,s=!1,a=1,o,l,c,u=!1){this.target=t,this.fromFrame=i,this.toFrame=n,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new J,this.onAnimationLoopObservable=new J,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=new Sz(e,t[i],this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const n=i[0].animation.framePerSecond;this._frameToSyncFromJump=null!==(t=this._frameToSyncFromJump)&&void 0!==t?t:i[0].currentFrame,this._manualJumpDelay=-(0===this.speedRatio?0:(e-this._frameToSyncFromJump)/n*1e3/this.speedRatio)}for(let n=0;n<i.length;n++)i[n].goToFrame(e);this._goToFrame=e}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){const s=this._runtimeAnimations;for(let a=s.length-1;a>=0;a--){const o=s[a];e&&o.animation.name!=e||t&&!t(o.target)||(o.dispose(),s.splice(a,1))}0==s.length&&(i||this._scene._activeAnimatables.splice(n,1),this._raiseOnAnimationEnd())}}else{const n=this._scene._activeAnimatables.indexOf(this);n>-1&&(i||this._scene._activeAnimatables.splice(n,1),this._runtimeAnimations.length=0,this._raiseOnAnimationEnd())}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let n;for(n=0;n<i.length;n++){const a=i[n].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||a}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(n=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(n,1),n=0;n<i.length;n++)i[n].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}dt.prototype._animate=function(){if(!this.animationsEnabled)return;const r=Qa.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=r}this.deltaTime=this.useConstantAnimationDeltaTime?16:(r-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=r;const e=this._activeAnimatables;if(0===e.length)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const n=e[i];!n._animate(t)&&n.disposeOnEnd&&i--}this._processLateAnimationBindings()},dt.prototype.beginWeightedAnimation=function(r,e,t,i=1,n,s=1,a,o,l,c,u=!1){const h=this.beginAnimation(r,e,t,n,s,a,o,!1,l,c,u);return h.weight=i,h},dt.prototype.beginAnimation=function(r,e,t,i,n=1,s,a,o=!0,l,c,u=!1){e>t&&n>0&&(n*=-1),o&&this.stopAnimation(r,void 0,l),a||(a=new lC(this,r,e,t,i,n,s,void 0,c,u));const h=!l||l(r);if(r.animations&&h&&a.appendAnimations(r,r.animations),r.getAnimatables){const d=r.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,n,s,a,o,l,c)}return a.reset(),a},dt.prototype.beginHierarchyAnimation=function(r,e,t,i,n,s=1,a,o,l=!0,c,u,h=!1){const d=r.getDescendants(e),f=[];f.push(this.beginAnimation(r,t,i,n,s,a,o,l,c,void 0,h));for(const p of d)f.push(this.beginAnimation(p,t,i,n,s,a,o,l,c,void 0,h));return f},dt.prototype.beginDirectAnimation=function(r,e,t,i,n,s,a,o,l=!1){if(void 0===s&&(s=1),t>i&&s>0)s*=-1;else if(i>t&&s<0){const u=i;i=t,t=u}return new lC(this,r,t,i,n,s,a,e,o,l)},dt.prototype.beginDirectHierarchyAnimation=function(r,e,t,i,n,s,a,o,l,c=!1){const u=r.getDescendants(e),h=[];h.push(this.beginDirectAnimation(r,t,i,n,s,a,o,l,c));for(const d of u)h.push(this.beginDirectAnimation(d,t,i,n,s,a,o,l,c));return h},dt.prototype.getAnimatableByTarget=function(r){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===r)return this._activeAnimatables[e];return null},dt.prototype.getAllAnimatablesByTarget=function(r){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===r&&e.push(this._activeAnimatables[t]);return e},dt.prototype.stopAnimation=function(r,e,t){const i=this.getAllAnimatablesByTarget(r);for(const n of i)n.stop(e,t)},dt.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const r of this.animationGroups)r.stop()},dt.prototype._registerTargetForLateAnimationBinding=function(r,e){const t=r.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[r.targetPath]||(t._lateAnimationHolders[r.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),r.isAdditive?(t._lateAnimationHolders[r.targetPath].additiveAnimations.push(r),t._lateAnimationHolders[r.targetPath].totalAdditiveWeight+=r.weight):(t._lateAnimationHolders[r.targetPath].animations.push(r),t._lateAnimationHolders[r.targetPath].totalWeight+=r.weight)},dt.prototype._processLateAnimationBindingsForMatrices=function(r){if(0===r.totalWeight&&0===r.totalAdditiveWeight)return r.originalValue;let e=1;const t=z.Vector3[0],i=z.Vector3[1],n=z.Quaternion[0];let s=0;const a=r.animations[0];let l=1,c=!1;if(r.totalWeight<1)l=1-r.totalWeight,r.originalValue.decompose(i,n,t);else{if(s=1,e=r.totalWeight,l=a.weight/e,1==l){if(!r.totalAdditiveWeight)return a.currentValue;c=!0}a.currentValue.decompose(i,n,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),n.scaleInPlace(l);for(let h=s;h<r.animations.length;h++){const d=r.animations[h];if(0===d.weight)continue;l=d.weight/e;const f=z.Vector3[2],p=z.Vector3[3],g=z.Quaternion[1];d.currentValue.decompose(p,g,f),p.scaleAndAddToRef(l,i),g.scaleAndAddToRef(Be.Dot(n,g)>0?l:-l,n),f.scaleAndAddToRef(l,t)}n.normalize()}for(let h=0;h<r.additiveAnimations.length;h++){const d=r.additiveAnimations[h];if(0===d.weight)continue;const f=z.Vector3[2],p=z.Vector3[3],g=z.Quaternion[1];d.currentValue.decompose(p,g,f),p.multiplyToRef(i,p),E.LerpToRef(i,p,d.weight,i),n.multiplyToRef(g,g),Be.SlerpToRef(n,g,d.weight,n),f.scaleAndAddToRef(d.weight,t)}const u=a?a._animationState.workValue:z.Matrix[0].clone();return B.ComposeToRef(i,n,t,u),u},dt.prototype._processLateAnimationBindingsForQuaternions=function(r,e){if(0===r.totalWeight&&0===r.totalAdditiveWeight)return e;const t=r.animations[0],i=r.originalValue;let n=e;if(0===r.totalWeight&&r.totalAdditiveWeight>0)n.copyFrom(i);else if(1===r.animations.length){if(Be.SlerpToRef(i,t.currentValue,Math.min(1,r.totalWeight),n),0===r.totalAdditiveWeight)return n}else if(r.animations.length>1){let a,o,s=1;if(r.totalWeight<1){const c=1-r.totalWeight;a=[],o=[],a.push(i),o.push(c)}else{if(2===r.animations.length&&(Be.SlerpToRef(r.animations[0].currentValue,r.animations[1].currentValue,r.animations[1].weight/r.totalWeight,e),0===r.totalAdditiveWeight))return e;a=[],o=[],s=r.totalWeight}for(let c=0;c<r.animations.length;c++){const u=r.animations[c];a.push(u.currentValue),o.push(u.weight/s)}let l=0;for(let c=0;c<a.length;)c?(l+=o[c],Be.SlerpToRef(n,a[c],o[c]/l,n),c++):(Be.SlerpToRef(a[c],a[c+1],o[c+1]/(o[c]+o[c+1]),e),n=e,l=o[c]+o[c+1],c+=2)}for(let s=0;s<r.additiveAnimations.length;s++){const a=r.additiveAnimations[s];0!==a.weight&&(n.multiplyToRef(a.currentValue,z.Quaternion[0]),Be.SlerpToRef(n,z.Quaternion[0],a.weight,n))}return n},dt.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let r=0;r<this._registeredForLateAnimationBindings.length;r++){const e=this._registeredForLateAnimationBindings.data[r];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],n=i.animations[0],s=i.originalValue;if(null==s)continue;let o=e[t];if(Me.AllowMatrixDecomposeForInterpolation&&s.m)o=this._processLateAnimationBindingsForMatrices(i);else if(void 0!==s.w)o=this._processLateAnimationBindingsForQuaternions(i,o||Be.Identity());else{let c=0,u=1;if(i.totalWeight<1)o=n&&s.scale?s.scale(1-i.totalWeight):n?s*(1-i.totalWeight):s.clone?s.clone():s;else if(n){u=i.totalWeight;const h=n.weight/u;o=1!==h?n.currentValue.scale?n.currentValue.scale(h):n.currentValue*h:n.currentValue,c=1}for(let h=c;h<i.animations.length;h++){const d=i.animations[h],f=d.weight/u;f&&(d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f)}for(let h=0;h<i.additiveAnimations.length;h++){const d=i.additiveAnimations[h],f=d.weight;f&&(d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f)}}e[t]=o}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},xi.prototype.copyAnimationRange=function(r,e,t,i=!1,n=null){0===this.animations.length&&(this.animations.push(new Me(this.name,"_matrix",r.animations[0].framePerSecond,Me.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const s=r.animations[0].getRange(e);if(!s)return!1;const a=s.from,o=s.to,l=r.animations[0].getKeys(),c=r.length,u=r.getParent(),h=this.getParent(),d=i&&u&&c&&this.length&&c!==this.length,f=d&&h&&u?h.length/u.length:1,p=i&&!h&&n&&(1!==n.x||1!==n.y||1!==n.z),g=this.animations[0].getKeys();let _,m,T;for(let v=0,A=l.length;v<A;v++)_=l[v],_.frame>=a&&_.frame<=o&&(i?(T=_.value.clone(),d?(m=T.getTranslation(),T.setTranslation(m.scaleInPlace(f))):p&&n?(m=T.getTranslation(),T.setTranslation(m.multiplyInPlace(n))):T=_.value):T=_.value,g.push({frame:_.frame+t,value:T}));return this.animations[0].createRange(e,a+t,o+t),!0};class Kz{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class Vf{get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++)this._animatables[t].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++)this._animatables[t].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++)this._animatables[t].isAdditive=this._isAdditive}}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}constructor(e,t=null){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new J,this.onAnimationLoopObservable=new J,this.onAnimationGroupLoopObservable=new J,this.onAnimationGroupEndObservable=new J,this.onAnimationGroupPauseObservable=new J,this.onAnimationGroupPlayObservable=new J,this.metadata=null,this._animationLoopFlags=[],this._scene=t||Je.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new Kz;i.animation=e,i.target=t;const n=e.getKeys();return this._from>n[0].frame&&(this._from=n[0].frame),this._to<n[n.length-1].frame&&(this._to=n[n.length-1].frame),this._targetedAnimations.push(i),i}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),a=s[0],o=s[s.length-1];a.frame>e&&s.splice(0,0,{frame:e,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation}),o.frame<t&&s.push({frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation})}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,n,s){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let a=0;a<this._targetedAnimations.length;a++){const o=this._targetedAnimations[a],l=this._scene.beginDirectAnimation(o.target,[o.animation],void 0!==i?i:this._from,void 0!==n?n:this._to,e,t,void 0,void 0,void 0!==s?s:this._isAdditive);l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,a),this._animatables.push(l)}return this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let i=0;i<e.length;i++)e[i].stop(void 0,void 0,!0);let t=0;for(let i=0;i<this._scene._activeAnimatables.length;i++){const n=this._scene._activeAnimatables[i];n._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=n)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),0===this._animatables.length&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const n=new Vf(e||this.name,this._scene);for(const s of this._targetedAnimations)n.addTargetedAnimation(i?s.animation.clone():s.animation,t?t(s.target):s.target);return n}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++)e.targetedAnimations[t]=this.targetedAnimations[t].serialize();return Gt&&Gt.HasTags(this)&&(e.tags=Gt.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new Vf(e.name,t);for(let n=0;n<e.targetedAnimations.length;n++){const s=e.targetedAnimations[n],a=Me.Parse(s.animation),o=s.targetId;if("influence"===s.animation.property){const l=t.getMorphTargetById(o);l&&i.addTargetedAnimation(a,l)}else{const l=t.getNodeById(o);null!=l&&i.addTargetedAnimation(a,l)}}return null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),Gt&&Gt.AddTagsTo(i,e.tags),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t=0,i,n=!1,s){let a=e;n&&(a=e.clone(s||a.name));const o=a.targetedAnimations;for(let l=0;l<o.length;l++)Me.MakeAnimationAdditive(o[l].animation,t,i);return a.isAdditive=!0,a}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}var Qz=L(3445),Zz=L(8687);class Rt extends $i{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,t){super(e,t),this.diffuse=new Fe(1,1,1),this.specular=new Fe(1,1,1),this.falloffType=Rt.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Rt.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new He(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,n,s=!0){var a;const o=e.toString();let l=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==t.getRenderId()||this._lastUseSpecular!==n||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=n;const c=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(c,ei.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",ei.Color3[0],this.range,o),n&&(this.specular.scaleToRef(c,ei.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",ei.Color3[1],this.radius,o)),l=!0}if(this.transferTexturesToEffect(i,o),t.shadowsEnabled&&this.shadowEnabled&&s){const c=null!==(a=this.getShadowGenerator(t.activeCamera))&&void 0!==a?a:this.getShadowGenerator();c&&(c.bindShadowLight(o,i),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return null===this._shadowGenerators?null:null!==(t=this._shadowGenerators.get(e))&&void 0!==t?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return E.Zero()}canAffectMesh(e){return!e||!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||0!==this.includeOnlyWithLayerMask&&0==(this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask)}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let n=i.next();!0!==n.done;n=i.next())n.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=Rt.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const n=lt.Clone(i,this);return e&&(n.name=e),t&&(n.parent=t),n.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(n),n}serialize(){const e=lt.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),lt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){return $i.Construct("Light_Type_"+e,t,i)||null}static Parse(e,t){const i=Rt.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const n=lt.Parse(i,e,t);if(e.excludedMeshesIds&&(n._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(n._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(n._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(n.falloffType=e.falloffType),void 0!==e.lightmapMode&&(n.lightmapMode=e.lightmapMode),e.animations){for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=zr("BABYLON.Animation");o&&n.animations.push(o.Parse(a))}$i.ParseAnimationRanges(n,e,t)}return e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&n.setEnabled(e.isEnabled),n}_hookArrayForExcluded(e){const t=e.push;e.push=(...n)=>{const s=t.apply(e,n);for(const a of n)a._resyncLightSource(this);return s};const i=e.splice;e.splice=(n,s)=>{const a=i.apply(e,[n,s]);for(const o of a)o._resyncLightSource(this);return a};for(const n of e)n._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...n)=>{const s=t.apply(e,n);return this._resyncMeshes(),s};const i=e.splice;e.splice=(n,s)=>{const a=i.apply(e,[n,s]);return this._resyncMeshes(),a},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===Rt.INTENSITYMODE_AUTOMATIC&&(i=t===Rt.LIGHTTYPEID_DIRECTIONALLIGHT?Rt.INTENSITYMODE_ILLUMINANCE:Rt.INTENSITYMODE_LUMINOUSINTENSITY),t){case Rt.LIGHTTYPEID_POINTLIGHT:case Rt.LIGHTTYPEID_SPOTLIGHT:switch(i){case Rt.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Rt.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Rt.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case Rt.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case Rt.INTENSITYMODE_ILLUMINANCE:e=1;break;case Rt.INTENSITYMODE_LUMINANCE:{let n=this.radius;n=Math.max(n,.001),e=2*Math.PI*(1-Math.cos(n));break}}break;case Rt.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Rt.FALLOFF_DEFAULT=Tn.FALLOFF_DEFAULT,Rt.FALLOFF_PHYSICAL=Tn.FALLOFF_PHYSICAL,Rt.FALLOFF_GLTF=Tn.FALLOFF_GLTF,Rt.FALLOFF_STANDARD=Tn.FALLOFF_STANDARD,Rt.LIGHTMAP_DEFAULT=Tn.LIGHTMAP_DEFAULT,Rt.LIGHTMAP_SPECULAR=Tn.LIGHTMAP_SPECULAR,Rt.LIGHTMAP_SHADOWSONLY=Tn.LIGHTMAP_SHADOWSONLY,Rt.INTENSITYMODE_AUTOMATIC=Tn.INTENSITYMODE_AUTOMATIC,Rt.INTENSITYMODE_LUMINOUSPOWER=Tn.INTENSITYMODE_LUMINOUSPOWER,Rt.INTENSITYMODE_LUMINOUSINTENSITY=Tn.INTENSITYMODE_LUMINOUSINTENSITY,Rt.INTENSITYMODE_ILLUMINANCE=Tn.INTENSITYMODE_ILLUMINANCE,Rt.INTENSITYMODE_LUMINANCE=Tn.INTENSITYMODE_LUMINANCE,Rt.LIGHTTYPEID_POINTLIGHT=Tn.LIGHTTYPEID_POINTLIGHT,Rt.LIGHTTYPEID_DIRECTIONALLIGHT=Tn.LIGHTTYPEID_DIRECTIONALLIGHT,Rt.LIGHTTYPEID_SPOTLIGHT=Tn.LIGHTTYPEID_SPOTLIGHT,Rt.LIGHTTYPEID_HEMISPHERICLIGHT=Tn.LIGHTTYPEID_HEMISPHERICLIGHT,b([cn()],Rt.prototype,"diffuse",void 0),b([cn()],Rt.prototype,"specular",void 0),b([O()],Rt.prototype,"falloffType",void 0),b([O()],Rt.prototype,"intensity",void 0),b([O()],Rt.prototype,"range",null),b([O()],Rt.prototype,"intensityMode",null),b([O()],Rt.prototype,"radius",null),b([O()],Rt.prototype,"_renderPriority",void 0),b([ee("_reorderLightsInScene")],Rt.prototype,"renderPriority",void 0),b([O("shadowEnabled")],Rt.prototype,"_shadowEnabled",void 0),b([O("excludeWithLayerMask")],Rt.prototype,"_excludeWithLayerMask",void 0),b([O("includeOnlyWithLayerMask")],Rt.prototype,"_includeOnlyWithLayerMask",void 0),b([O("lightmapMode")],Rt.prototype,"_lightmapMode",void 0);class vl extends Rt{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=E.Zero()),E.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=E.Zero()),E.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=E.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=E.Cross(this.direction,wo.Y),t=E.Cross(e,this.direction);return E.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=E.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=B.Identity()),B.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}b([Mr()],vl.prototype,"position",null),b([Mr()],vl.prototype,"direction",null),b([O()],vl.prototype,"shadowMinZ",null),b([O()],vl.prototype,"shadowMaxZ",null);class it extends $i{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,n;let s=0,a=0;if(this.mode===it.PERSPECTIVE_CAMERA)this.fovMode===it.FOVMODE_VERTICAL_FIXED?(a=2*this.minZ*Math.tan(this.fov/2),s=this.getEngine().getAspectRatio(this)*a):(s=2*this.minZ*Math.tan(this.fov/2),a=s/this.getEngine().getAspectRatio(this));else{const o=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;s=(null!==(e=this.orthoRight)&&void 0!==e?e:o)-(null!==(t=this.orthoLeft)&&void 0!==t?t:-o),a=(null!==(i=this.orthoTop)&&void 0!==i?i:l)-(null!==(n=this.orthoBottom)&&void 0!==n?n:-l)}return s*a}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,n=!0){super(e,i),this._position=E.Zero(),this._upVector=E.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=it.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new uh(0,0,1,1),this.layerMask=268435455,this.fovMode=it.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=it.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new J,this.onProjectionMatrixChangedObservable=new J,this.onAfterCheckInputsObservable=new J,this.onRestoreStateObservable=new J,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=B.Identity(),this._skipRendering=!1,this._projectionMatrix=new B,this._postProcesses=new Array,this._activeMeshes=new Qn(256),this._globalPosition=E.Zero(),this._computedViewMatrix=B.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=B.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=Be.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),n&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const t of this._postProcesses)if(t&&!t.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return e=this.mode===it.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==it.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const n=this._rigCameras[t],s=n._rigPostProcess;s?("pass"===s.getEffectName()&&(n.isIntermediate=0===this._postProcesses.length),n._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()):n._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(H.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return B.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,n,s,a,o,l,c;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const u=this.getEngine(),h=this.getScene(),d=u.useReverseDepthBuffer;if(this.mode===it.PERSPECTIVE_CAMERA){let f;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=u.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),f=h.useRightHandedSystem?B.PerspectiveFovRHToRef:B.PerspectiveFovLHToRef,f(this.fov,u.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===it.FOVMODE_VERTICAL_FIXED,u.isNDCHalfZRange,this.projectionPlaneTilt,d)}else{const f=u.getRenderWidth()/2,p=u.getRenderHeight()/2;h.useRightHandedSystem?B.OrthoOffCenterRHToRef(null!==(t=this.orthoLeft)&&void 0!==t?t:-f,null!==(i=this.orthoRight)&&void 0!==i?i:f,null!==(n=this.orthoBottom)&&void 0!==n?n:-p,null!==(s=this.orthoTop)&&void 0!==s?s:p,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,u.isNDCHalfZRange):B.OrthoOffCenterLHToRef(null!==(a=this.orthoLeft)&&void 0!==a?a:-f,null!==(o=this.orthoRight)&&void 0!==o?o:f,null!==(l=this.orthoBottom)&&void 0!==l?l:-p,null!==(c=this.orthoTop)&&void 0!==c?c:p,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,u.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=u.getRenderWidth(),this._cache.renderHeight=u.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?as.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=as.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(n=>{n._updateFrustumPlanes(),i=i||e.isInFrustum(n._frustumPlanes)}),i}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw ht("Ray")}getForwardRayToRef(e,t=100,i,n){throw ht("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const n=this._rigCameras.pop();n&&n.dispose()}if(this._parentContainer){const n=this._parentContainer.cameras.indexOf(this);n>-1&&this._parentContainer.cameras.splice(n,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==it.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let n=this._postProcesses.length;for(;--n>=0;){const s=this._postProcesses[n];s&&s.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Ie.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==it.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const n=this.createRigCamera(this.name+"_R",1);n&&(n._isRightCamera=!0),i&&n&&(this._rigCameras.push(i),this._rigCameras.push(n))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return B.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return B.Identity()}_getWebVRViewMatrix(){return B.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=Ie.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===it.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=lt.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),lt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=lt.Clone(it.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=E.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){E.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,n=0,s=!0){return $i.Construct(e,t,i,{interaxial_distance:n,isStereoscopicSideBySide:s})||(()=>it._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const n=it.GetConstructorFromName(e.type,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=lt.Parse(n,e,t);if(void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=E.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(E.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(E.FromArray(e.target)),e.cameraRigMode&&s.setCameraRigMode(e.cameraRigMode,e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{}),e.animations){for(let a=0;a<e.animations.length;a++){const o=e.animations[a],l=zr("BABYLON.Animation");l&&s.animations.push(l.Parse(o))}$i.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}}function Sl(r){-1===r.indexOf("vClipPlane")&&r.push("vClipPlane"),-1===r.indexOf("vClipPlane2")&&r.push("vClipPlane2"),-1===r.indexOf("vClipPlane3")&&r.push("vClipPlane3"),-1===r.indexOf("vClipPlane4")&&r.push("vClipPlane4"),-1===r.indexOf("vClipPlane5")&&r.push("vClipPlane5"),-1===r.indexOf("vClipPlane6")&&r.push("vClipPlane6")}function kf(r,e,t){var i,n,s,a,o,l;const c=!!(null!==(i=r.clipPlane)&&void 0!==i?i:e.clipPlane),u=!!(null!==(n=r.clipPlane2)&&void 0!==n?n:e.clipPlane2),h=!!(null!==(s=r.clipPlane3)&&void 0!==s?s:e.clipPlane3),d=!!(null!==(a=r.clipPlane4)&&void 0!==a?a:e.clipPlane4),f=!!(null!==(o=r.clipPlane5)&&void 0!==o?o:e.clipPlane5),p=!!(null!==(l=r.clipPlane6)&&void 0!==l?l:e.clipPlane6);c&&t.push("#define CLIPPLANE"),u&&t.push("#define CLIPPLANE2"),h&&t.push("#define CLIPPLANE3"),d&&t.push("#define CLIPPLANE4"),f&&t.push("#define CLIPPLANE5"),p&&t.push("#define CLIPPLANE6")}function Uo(r,e,t){var i,n,s,a,o,l;let c=null!==(i=e.clipPlane)&&void 0!==i?i:t.clipPlane;Bc(r,"vClipPlane",c),c=null!==(n=e.clipPlane2)&&void 0!==n?n:t.clipPlane2,Bc(r,"vClipPlane2",c),c=null!==(s=e.clipPlane3)&&void 0!==s?s:t.clipPlane3,Bc(r,"vClipPlane3",c),c=null!==(a=e.clipPlane4)&&void 0!==a?a:t.clipPlane4,Bc(r,"vClipPlane4",c),c=null!==(o=e.clipPlane5)&&void 0!==o?o:t.clipPlane5,Bc(r,"vClipPlane5",c),c=null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6,Bc(r,"vClipPlane6",c)}function Bc(r,e,t){t&&r.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}it._CreateDefaultParsedCamera=(r,e)=>{throw ht("UniversalCamera")},it.PERSPECTIVE_CAMERA=0,it.ORTHOGRAPHIC_CAMERA=1,it.FOVMODE_VERTICAL_FIXED=0,it.FOVMODE_HORIZONTAL_FIXED=1,it.RIG_MODE_NONE=0,it.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,it.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,it.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,it.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,it.RIG_MODE_STEREOSCOPIC_INTERLACED=14,it.RIG_MODE_VR=20,it.RIG_MODE_WEBVR=21,it.RIG_MODE_CUSTOM=22,it.ForceAttachControlToAlwaysPreventDefault=!1,b([Mr("position")],it.prototype,"_position",void 0),b([Mr("upVector")],it.prototype,"_upVector",void 0),b([O()],it.prototype,"orthoLeft",null),b([O()],it.prototype,"orthoRight",null),b([O()],it.prototype,"orthoBottom",null),b([O()],it.prototype,"orthoTop",null),b([O()],it.prototype,"fov",void 0),b([O()],it.prototype,"projectionPlaneTilt",void 0),b([O()],it.prototype,"minZ",void 0),b([O()],it.prototype,"maxZ",void 0),b([O()],it.prototype,"inertia",void 0),b([O()],it.prototype,"mode",null),b([O()],it.prototype,"layerMask",void 0),b([O()],it.prototype,"fovMode",void 0),b([O()],it.prototype,"cameraRigMode",void 0),b([O()],it.prototype,"interaxialDistance",void 0),b([O()],it.prototype,"isStereoscopicSideBySide",void 0);class fe{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const n=e.getTextureMatrix();t.updateMatrix(i+"Matrix",n)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==dt.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,n,s,a,o){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=n,o.FOG=s&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=a)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const s=t.CAMERA_PERSPECTIVE?1:0,a=e.activeCamera.mode===it.ORTHOGRAPHIC_CAMERA?1:0,o=e.activeCamera.mode===it.PERSPECTIVE_CAMERA?1:0;((t.CAMERA_ORTHOGRAPHIC?1:0)^a||s^o)&&(t.CAMERA_ORTHOGRAPHIC=1===a,t.CAMERA_PERSPECTIVE=1===o,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,n,s,a=null,o=!1){let l=fe.PrepareDefinesForCamera(e,n);!1!==a&&(l=function Jz(r,e,t){var i,n,s,a,o,l;let c=!1;const u=!!(null!==(i=r.clipPlane)&&void 0!==i?i:e.clipPlane),h=!!(null!==(n=r.clipPlane2)&&void 0!==n?n:e.clipPlane2),d=!!(null!==(s=r.clipPlane3)&&void 0!==s?s:e.clipPlane3),f=!!(null!==(a=r.clipPlane4)&&void 0!==a?a:e.clipPlane4),p=!!(null!==(o=r.clipPlane5)&&void 0!==o?o:e.clipPlane5),g=!!(null!==(l=r.clipPlane6)&&void 0!==l?l:e.clipPlane6);return t.CLIPPLANE!==u&&(t.CLIPPLANE=u,c=!0),t.CLIPPLANE2!==h&&(t.CLIPPLANE2=h,c=!0),t.CLIPPLANE3!==d&&(t.CLIPPLANE3=d,c=!0),t.CLIPPLANE4!==f&&(t.CLIPPLANE4=f,c=!0),t.CLIPPLANE5!==p&&(t.CLIPPLANE5=p,c=!0),t.CLIPPLANE6!==g&&(t.CLIPPLANE6=g,c=!0),c}(i,e,n)),n.DEPTHPREPASS!==!t.getColorWrite()&&(n.DEPTHPREPASS=!n.DEPTHPREPASS,l=!0),n.INSTANCES!==s&&(n.INSTANCES=s,l=!0),n.THIN_INSTANCES!==o&&(n.THIN_INSTANCES=o,l=!0),l&&n.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;const n=e.getScene().prePassRenderer;if(n&&n.enabled){const s=-1===n.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=s}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,n,s=!1,a=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(I.NormalKind),t._needNormals&&e.isVerticesDataPresent(I.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===l?"":l}`);if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(I.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&a}return e.isVerticesDataPresent(I.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),n&&this.PrepareDefinesForBones(e,t),s&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const n=t.ORDER_INDEPENDENT_TRANSPARENCY,s=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(n!==t.ORDER_INDEPENDENT_TRANSPARENCY||s!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const n=t.PREPASS;if(!t._arePrePassDirty)return;const s=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let a=0;a<s.length;a++){const o=e.prePassRenderer.getIndex(s[a].type);-1!==o?(t[s[a].define]=!0,t[s[a].index]=o):t[s[a].define]=!1}}else{t.PREPASS=!1;for(let a=0;a<s.length;a++)t[s[a].define]=!1}t.PREPASS!=n&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,n,s,a,o){var l;switch(o.needNormals=!0,void 0===s["LIGHT"+n]&&(o.needRebuild=!0),s["LIGHT"+n]=!0,s["SPOTLIGHT"+n]=!1,s["HEMILIGHT"+n]=!1,s["POINTLIGHT"+n]=!1,s["DIRLIGHT"+n]=!1,i.prepareLightSpecificDefines(s,n),s["LIGHT_FALLOFF_PHYSICAL"+n]=!1,s["LIGHT_FALLOFF_GLTF"+n]=!1,s["LIGHT_FALLOFF_STANDARD"+n]=!1,i.falloffType){case Tn.FALLOFF_GLTF:s["LIGHT_FALLOFF_GLTF"+n]=!0;break;case Tn.FALLOFF_PHYSICAL:s["LIGHT_FALLOFF_PHYSICAL"+n]=!0;break;case Tn.FALLOFF_STANDARD:s["LIGHT_FALLOFF_STANDARD"+n]=!0}if(a&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),s["SHADOW"+n]=!1,s["SHADOWCSM"+n]=!1,s["SHADOWCSMDEBUG"+n]=!1,s["SHADOWCSMNUM_CASCADES"+n]=!1,s["SHADOWCSMUSESHADOWMAXZ"+n]=!1,s["SHADOWCSMNOBLEND"+n]=!1,s["SHADOWCSM_RIGHTHANDED"+n]=!1,s["SHADOWPCF"+n]=!1,s["SHADOWPCSS"+n]=!1,s["SHADOWPOISSON"+n]=!1,s["SHADOWESM"+n]=!1,s["SHADOWCLOSEESM"+n]=!1,s["SHADOWCUBE"+n]=!1,s["SHADOWLOWQUALITY"+n]=!1,s["SHADOWMEDIUMQUALITY"+n]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const c=null!==(l=i.getShadowGenerator(e.activeCamera))&&void 0!==l?l:i.getShadowGenerator();if(c){const u=c.getShadowMap();u&&u.renderList&&u.renderList.length>0&&(o.shadowEnabled=!0,c.prepareDefines(s,n))}}i.lightmapMode!=Tn.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,s["LIGHTMAPEXCLUDED"+n]=!0,s["LIGHTMAPNOSPECULAR"+n]=i.lightmapMode==Tn.LIGHTMAP_SHADOWSONLY):(s["LIGHTMAPEXCLUDED"+n]=!1,s["LIGHTMAPNOSPECULAR"+n]=!1)}static PrepareDefinesForLights(e,t,i,n,s=4,a=!1){if(!i._areLightsDirty)return i._needNormals;let o=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!a)for(const u of t.lightSources)if(this.PrepareDefinesForLight(e,t,u,o,i,n,l),o++,o===s)break;i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let u=o;u<s;u++)void 0!==i["LIGHT"+u]&&(i["LIGHT"+u]=!1,i["HEMILIGHT"+u]=!1,i["POINTLIGHT"+u]=!1,i["DIRLIGHT"+u]=!1,i["SPOTLIGHT"+u]=!1,i["SHADOW"+u]=!1,i["SHADOWCSM"+u]=!1,i["SHADOWCSMDEBUG"+u]=!1,i["SHADOWCSMNUM_CASCADES"+u]=!1,i["SHADOWCSMUSESHADOWMAXZ"+u]=!1,i["SHADOWCSMNOBLEND"+u]=!1,i["SHADOWCSM_RIGHTHANDED"+u]=!1,i["SHADOWPCF"+u]=!1,i["SHADOWPCSS"+u]=!1,i["SHADOWPOISSON"+u]=!1,i["SHADOWESM"+u]=!1,i["SHADOWCLOSEESM"+u]=!1,i["SHADOWCUBE"+u]=!1,i["SHADOWLOWQUALITY"+u]=!1,i["SHADOWMEDIUMQUALITY"+u]=!1);const c=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(c.textureFloatRender&&c.textureFloatLinearFiltering||c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,n,s=null,a=!1){s&&s.push("Light"+e),!a&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),n&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,n=4){let s,a=null;e.uniformsNames?(s=e.uniformsNames,a=e.uniformBuffersNames,t=e.samplers,i=e.defines,n=e.maxSimultaneousLights||0):(s=e,t||(t=[]));for(let o=0;o<n&&i["LIGHT"+o];o++)this.PrepareUniformsAndSamplersForLight(o,s,t,i["PROJECTEDLIGHTTEXTURE"+o],a);i.NUM_MORPH_INFLUENCERS&&s.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(s.push("bakedVertexAnimationSettings"),s.push("bakedVertexAnimationTextureSizeInverted"),s.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,n=0){let s=0;for(let a=0;a<i&&e["LIGHT"+a];a++)a>0&&(s=n+a,t.addFallback(s,"LIGHT"+a)),e.SHADOWS||(e["SHADOW"+a]&&t.addFallback(n,"SHADOW"+a),e["SHADOWPCF"+a]&&t.addFallback(n,"SHADOWPCF"+a),e["SHADOWPCSS"+a]&&t.addFallback(n,"SHADOWPCSS"+a),e["SHADOWPOISSON"+a]&&t.addFallback(n,"SHADOWPOISSON"+a),e["SHADOWESM"+a]&&t.addFallback(n,"SHADOWESM"+a),e["SHADOWCLOSEESM"+a]&&t.addFallback(n,"SHADOWCLOSEESM"+a));return s++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const n=i.NUM_MORPH_INFLUENCERS;if(n>0&&Je.LastCreatedEngine){const s=Je.LastCreatedEngine.getCaps().maxVertexAttribs,a=t.morphTargetManager;if(null==a?void 0:a.isUsingTextureForTargets)return;const o=a&&a.supportsNormals&&i.NORMAL,l=a&&a.supportsTangents&&i.TANGENT,c=a&&a.supportsUVs&&i.UV1;for(let u=0;u<n;u++)e.push(I.PositionKind+u),o&&e.push(I.NormalKind+u),l&&e.push(I.TangentKind+u),c&&e.push(I.UVKind+"_"+u),e.length>s&&H.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,n){i.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,t),e.push(I.MatricesIndicesKind),e.push(I.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(I.MatricesIndicesExtraKind),e.push(I.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(I.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,n,s,a=!0){e._bindLight(t,i,n,s,a)}static BindLights(e,t,i,n,s=4){const a=Math.min(t.lightSources.length,s);for(let o=0;o<a;o++)this.BindLight(t.lightSources[o],o,e,i,"boolean"==typeof n?n:n.SPECULARTERM,t.receiveShadows)}static BindFogParameters(e,t,i,n=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==dt.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),n?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const n=e.skeleton;if(n.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const s=n.getTransformMatrixTexture(e);t.setTexture("boneSampler",s),t.setFloat("boneTextureWidth",4*(n.bones.length+1))}else{const s=n.getTransformMatrices(e);s&&(t.setMatrices("mBones",s),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=s.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),fe._CopyBonesTransformationMatrices(s,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const n=i.activeCamera;n.mode===it.ORTHOGRAPHIC_CAMERA&&H.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(n.maxZ+1)/Math.LN2))}}}fe._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},fe._TempFogColor=Fe.Black();class lT{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){!this._texture||(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==(null==e?void 0:e._shareDepth)}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=os.Zero(),this._cachedBaseSize=os.Zero(),this._initialSamplingMode=2,this._texture=lT._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class di extends lT{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Nf()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=di.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new J,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?di._IsScene(e)?this._scene=e:this._engine=e:this._scene=Je.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return null!==e}getTextureMatrix(){return B.IdentityReadOnly}getReflectionTextureMatrix(){return B.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,n,s,a){const o=this._getEngine();if(!o)return null;const l=o._getUseSRGBBuffer(!!s,t),c=o.getLoadedTexturesCache();for(let u=0;u<c.length;u++){const h=c[u];if(!(void 0!==s&&l!==h._useSRGBBuffer||void 0!==n&&n!==h.invertY||h.url!==e||h.generateMipMaps!==!t||i&&i!==h.samplingMode||void 0!==a&&a!==h.isCube))return h.incrementReferences(),h}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();!e||e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,n=!0,s=!1,a=0,o=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;const u=this._getEngine();if(!u)return null;const h=this.getSize();let d=h.width,f=h.height;0!==t&&(d/=Math.pow(2,t),f/=Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),c=Math.min(f,c);try{return u._readTexturePixels(this._texture,l,c,this._texture.isCube?e:-1,t,i,n,s,a,o)}catch(p){return null}}_readPixelsSync(e=0,t=0,i=null,n=!0,s=!1){if(!this._texture)return null;const a=this.getSize();let o=a.width,l=a.height;const c=this._getEngine();if(!c)return null;0!=t&&(o/=Math.pow(2,t),l/=Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return c._readTexturePixelsSync(this._texture,o,l,this._texture.isCube?e:-1,t,i,n,s)}catch(u){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=lt.Serialize(this);return lt.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let n=0;n<e.length;n++){const s=e[n];if(s.isReady())0==--i&&t();else{const a=s.onLoadObservable;a?a.addOnce(()=>{0==--i&&t()}):0==--i&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}}function cT(r,e,t=!1){const i=e.width,n=e.height;if(r instanceof Float32Array){let c=r.byteLength/r.BYTES_PER_ELEMENT;const u=new Uint8Array(c);for(;--c>=0;){let h=r[c];h<0?h=0:h>1&&(h=1),u[c]=255*h}r=u}const s=document.createElement("canvas");s.width=i,s.height=n;const a=s.getContext("2d");if(!a)return null;const o=a.createImageData(i,n);if(o.data.set(r),a.putImageData(o,0,0),t){const c=document.createElement("canvas");c.width=i,c.height=n;const u=c.getContext("2d");return u?(u.translate(0,n),u.scale(1,-1),u.drawImage(s,0,0),c.toDataURL("image/png")):null}return s.toDataURL("image/png")}function uT(){return uT=ls(function*(r,e=0,t=0){const i=r.getInternalTexture();if(!i)return null;const n=yield r.readPixels(e,t);return n?cT(n,r.getSize(),i.invertY):null}),uT.apply(this,arguments)}di.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,b([O()],di.prototype,"uniqueId",void 0),b([O()],di.prototype,"name",void 0),b([O()],di.prototype,"metadata",void 0),b([O("hasAlpha")],di.prototype,"_hasAlpha",void 0),b([O("getAlphaFromRGB")],di.prototype,"_getAlphaFromRGB",void 0),b([O()],di.prototype,"level",void 0),b([O("coordinatesIndex")],di.prototype,"_coordinatesIndex",void 0),b([O()],di.prototype,"optimizeUVAllocation",void 0),b([O("coordinatesMode")],di.prototype,"_coordinatesMode",void 0),b([O()],di.prototype,"wrapU",null),b([O()],di.prototype,"wrapV",null),b([O()],di.prototype,"wrapR",void 0),b([O()],di.prototype,"anisotropicFilteringLevel",void 0),b([O()],di.prototype,"isCube",null),b([O()],di.prototype,"is3D",null),b([O()],di.prototype,"is2DArray",null),b([O()],di.prototype,"gammaSpace",null),b([O()],di.prototype,"invertZ",void 0),b([O()],di.prototype,"lodLevelInAlpha",void 0),b([O()],di.prototype,"lodGenerationOffset",null),b([O()],di.prototype,"lodGenerationScale",null),b([O()],di.prototype,"linearSpecularLOD",null),b([Bt()],di.prototype,"irradianceTexture",null),b([O()],di.prototype,"isRenderTarget",void 0);let jt=(()=>{class r{}return r.UseOpenGLOrientationForUV=!1,r})();class j extends di{get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,n,s=j.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=null,c=!1,u,h,d,f,p){var g,_,m,T,v,A,S,x,C;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new J,this._isBlocking=!0,this.name=e||"",this.url=e;let R,D=!1,P=null;"object"==typeof i&&null!==i?(R=null!==(g=i.noMipmap)&&void 0!==g&&g,n=null!==(_=i.invertY)&&void 0!==_?_:!jt.UseOpenGLOrientationForUV,s=null!==(m=i.samplingMode)&&void 0!==m?m:j.TRILINEAR_SAMPLINGMODE,a=null!==(T=i.onLoad)&&void 0!==T?T:null,o=null!==(v=i.onError)&&void 0!==v?v:null,l=null!==(A=i.buffer)&&void 0!==A?A:null,c=null!==(S=i.deleteBuffer)&&void 0!==S&&S,u=i.format,h=i.mimeType,d=i.loaderOptions,f=i.creationFlags,D=null!==(x=i.useSRGBBuffer)&&void 0!==x&&x,P=null!==(C=i.internalTexture)&&void 0!==C?C:null):R=!!i,this._noMipmap=R,this._invertY=void 0===n?!jt.UseOpenGLOrientationForUV:n,this._initialSamplingMode=s,this._buffer=l,this._deleteBuffer=c,this._mimeType=h,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=D,this._forcedExtension=p,u&&(this._format=u);const N=this.getScene(),k=this._getEngine();if(!k)return;k.onBeforeTextureInitObservable.notifyObservers(this);const X=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&N&&N.resetCachedMaterial()},ne=(ge,ue)=>{this._loadingError=!0,this._errorObject={message:ge,exception:ue},o&&o(ge,ue),j.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!P)return this._delayedOnLoad=X,void(this._delayedOnError=ne);if(this._texture=null!=P?P:this._getFromCache(this.url,R,s,this._invertY,D),this._texture)if(this._texture.isReady)Nc.SetImmediate(()=>X());else{const ge=this._texture.onLoadedObservable.add(X);this._texture.onErrorObservable.add(ue=>{var ke;ne(ue.message,ue.exception),null===(ke=this._texture)||void 0===ke||ke.onLoadedObservable.remove(ge)})}else if(N&&N.useDelayedTextureLoading)this.delayLoadState=4,this._delayedOnLoad=X,this._delayedOnError=ne;else{try{this._texture=k.createTexture(this.url,R,this._invertY,N,s,X,ne,this._buffer,void 0,this._format,this._forcedExtension,h,d,f,D)}catch(ge){throw ne("error loading",ge),ge}c&&(this._buffer=null)}}updateURL(e,t=null,i,n){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=n,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const e=this.getScene();!e||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?Nc.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,n){e*=this._cachedUScale,t*=this._cachedVScale,E.TransformCoordinatesFromFloatsToRef(e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,this._rowGenerationMatrix,n),n.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,n.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,n.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return null!==e&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=B.Zero(),this._rowGenerationMatrix=new B,this._t0=E.Zero(),this._t1=E.Zero(),this._t2=E.Zero()),B.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(B.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,z.Matrix[0]),B.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,z.Matrix[1]),B.ScalingToRef(this._cachedUScale,this._cachedVScale,0,z.Matrix[2]),B.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,z.Matrix[3]),z.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(z.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(z.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(z.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),B.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==j.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=B.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=B.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case j.PLANAR_MODE:B.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case j.PROJECTION_MODE:{B.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:B.IdentityToRef(this._cachedReflectionTextureMatrix)}return t&&e.markAllMaterialsAsDirty(1,i=>-1!==i.getActiveTextures().indexOf(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return lt.Clone(()=>new j(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,t;const i=this.name;j.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const n=super.serialize(j._SerializeInternalTextureUniqueId);return n?((j.SerializeBuffers||j.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substr(0,5)?(n.base64String=this._buffer,n.name=n.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?n.base64String="data:image/png;base64,"+Zm(this._buffer):(j.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(n.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function uC(r,e=0,t=0){const i=r.getInternalTexture();if(!i)return null;const n=r._readPixelsSync(e,t);return n?cT(n,r.getSize(),i.invertY):null}(this):function hC(r){return uT.apply(this,arguments)}(this))),n.invertY=this._invertY,n.samplingMode=this.samplingMode,n._creationFlags=this._creationFlags,n._useSRGBBuffer=this._useSRGBBuffer,j._SerializeInternalTextureUniqueId&&(n.internalTextureUniqueId=null!==(t=null===(e=this._texture)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:void 0),this.name=i,n):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const c=Ff.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return j._CubeTextureParser(e,t,i);const n=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!n)return null;let s;if(n){const l=t.getEngine().getLoadedTexturesCache();for(const c of l)if(c.uniqueId===e.internalTextureUniqueId){s=c;break}}const a=l=>{var c;if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const u=e.samplingMode;l&&l.samplingMode!==u&&l.updateSamplingMode(u)}if(l&&e.animations)for(let u=0;u<e.animations.length;u++){const h=e.animations[u],d=zr("BABYLON.Animation");d&&l.animations.push(d.Parse(h))}n&&!s&&(null===(c=null==l?void 0:l._texture)||void 0===c||c._setUniqueId(e.internalTextureUniqueId))};return lt.Parse(()=>{var l,c,u;let h=!0;if(e.noMipmap&&(h=!1),e.mirrorPlane){const d=j._CreateMirror(e.name,e.renderTargetSize,t,h);return d._waitingRenderList=e.renderList,d.mirrorPlane=ss.FromArray(e.mirrorPlane),a(d),d}if(e.isRenderTarget){let d=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){const p=t.reflectionProbes[f];if(p.name===e.name)return p.cubeTexture}}else d=j._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,h,null!==(l=e._creationFlags)&&void 0!==l?l:0),d._waitingRenderList=e.renderList;return a(d),d}{let d;if(e.base64String&&!s)d=j.CreateFromBase64String(e.base64String,e.base64String,t,!h,e.invertY,e.samplingMode,()=>{a(d)},null!==(c=e._creationFlags)&&void 0!==c?c:0,null!==(u=e._useSRGBBuffer)&&void 0!==u&&u),d.name=e.name;else{let f;f=e.name&&e.name.indexOf("://")>0?e.name:i+e.name,e.url&&(e.url.startsWith("data:")||j.UseSerializedUrlIfAny)&&(f=e.url),d=new j(f,t,{noMipmap:!h,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{a(d)},internalTexture:s})}return d}},e,t)}static CreateFromBase64String(e,t,i,n,s,a=j.TRILINEAR_SAMPLINGMODE,o=null,l=null,c=5,u){return new j("data:"+t,i,n,s,a,o,l,e,!1,c,void 0,void 0,u)}static LoadFromDataString(e,t,i,n=!1,s,a=!0,o=j.TRILINEAR_SAMPLINGMODE,l=null,c=null,u=5,h){return"data:"!==e.substr(0,5)&&(e="data:"+e),new j(e,i,s,a,o,l,c,t,n,u,void 0,void 0,h)}}j.SerializeBuffers=!0,j.ForceSerializeBuffers=!1,j.OnTextureLoadErrorObservable=new J,j._SerializeInternalTextureUniqueId=!1,j._CubeTextureParser=(r,e,t)=>{throw ht("CubeTexture")},j._CreateMirror=(r,e,t,i)=>{throw ht("MirrorTexture")},j._CreateRenderTargetTexture=(r,e,t,i,n)=>{throw ht("RenderTargetTexture")},j.NEAREST_SAMPLINGMODE=1,j.NEAREST_NEAREST_MIPLINEAR=8,j.BILINEAR_SAMPLINGMODE=2,j.LINEAR_LINEAR_MIPNEAREST=11,j.TRILINEAR_SAMPLINGMODE=3,j.LINEAR_LINEAR_MIPLINEAR=3,j.NEAREST_NEAREST_MIPNEAREST=4,j.NEAREST_LINEAR_MIPNEAREST=5,j.NEAREST_LINEAR_MIPLINEAR=6,j.NEAREST_LINEAR=7,j.NEAREST_NEAREST=1,j.LINEAR_NEAREST_MIPNEAREST=9,j.LINEAR_NEAREST_MIPLINEAR=10,j.LINEAR_LINEAR=2,j.LINEAR_NEAREST=12,j.EXPLICIT_MODE=0,j.SPHERICAL_MODE=1,j.PLANAR_MODE=2,j.CUBIC_MODE=3,j.PROJECTION_MODE=4,j.SKYBOX_MODE=5,j.INVCUBIC_MODE=6,j.EQUIRECTANGULAR_MODE=7,j.FIXED_EQUIRECTANGULAR_MODE=8,j.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,j.CLAMP_ADDRESSMODE=0,j.WRAP_ADDRESSMODE=1,j.MIRROR_ADDRESSMODE=2,j.UseSerializedUrlIfAny=!1,b([O()],j.prototype,"url",void 0),b([O()],j.prototype,"uOffset",void 0),b([O()],j.prototype,"vOffset",void 0),b([O()],j.prototype,"uScale",void 0),b([O()],j.prototype,"vScale",void 0),b([O()],j.prototype,"uAng",void 0),b([O()],j.prototype,"vAng",void 0),b([O()],j.prototype,"wAng",void 0),b([O()],j.prototype,"uRotationCenter",void 0),b([O()],j.prototype,"vRotationCenter",void 0),b([O()],j.prototype,"wRotationCenter",void 0),b([O()],j.prototype,"homogeneousRotationInUVTransform",void 0),b([O()],j.prototype,"isBlocking",null),ye("BABYLON.Texture",j),lt._TextureParser=j.Parse;class hT{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return null!==(t=null===(e=this._textures)||void 0===e?void 0:e[0])&&void 0!==t?t:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const n=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,n}constructor(e,t,i,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=n,this._depthStencilTexture=null}setTextures(e){this._textures=Array.isArray(e)?e:e?[e]:null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==t&&t>=0&&(this._layerIndices[e]=t),void 0!==i&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,n=1,s=14,a){var o;return null===(o=this._depthStencilTexture)||void 0===o||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:n,depthTextureFormat:s,label:a},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,n,s,a,o,l;let c=null;if(this._isMulti){const u=this.textures;if(u&&u.length>0){let h=!1,d=u.length;const f=u[u.length-1]._source;(f===vt.Depth||f===vt.DepthStencil)&&(h=!0,d--);const p=[],g=[],_=[],m=[],T=[],v=[],A=[],S={};for(let R=0;R<d;++R){const D=u[R];p.push(D.samplingMode),g.push(D.type),_.push(D.format),void 0!==S[D.uniqueId]?(m.push(-1),A.push(0)):(S[D.uniqueId]=R,D.is2DArray?(m.push(35866),A.push(D.depth)):D.isCube?(m.push(34067),A.push(0)):D.is3D?(m.push(32879),A.push(D.depth)):(m.push(3553),A.push(0))),this._faceIndices&&T.push(null!==(e=this._faceIndices[R])&&void 0!==e?e:0),this._layerIndices&&v.push(null!==(t=this._layerIndices[R])&&void 0!==t?t:0)}c=this._engine.createMultipleRenderTarget({width:this.width,height:this.height},{samplingModes:p,generateMipMaps:u[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:h,types:g,formats:_,textureCount:d,targetTypes:m,faceIndex:T,layerIndex:v,layerCounts:A});for(let R=0;R<d;++R)-1===m[R]&&c.setTexture(c.textures[S[u[R].uniqueId]],R)}}else{const u={};if(u.generateDepthBuffer=this._generateDepthBuffer,u.generateMipMaps=null!==(n=null===(i=this.texture)||void 0===i?void 0:i.generateMipMaps)&&void 0!==n&&n,u.generateStencilBuffer=this._generateStencilBuffer,u.samplingMode=null===(s=this.texture)||void 0===s?void 0:s.samplingMode,u.type=null===(a=this.texture)||void 0===a?void 0:a.type,u.format=null===(o=this.texture)||void 0===o?void 0:o.format,this.isCube)c=this._engine.createRenderTargetCubeTexture(this.width,u);else{const h={width:this.width,height:this.height,layers:this.is2DArray?null===(l=this.texture)||void 0===l?void 0:l.depth:void 0};c=this._engine.createRenderTargetTexture(h,u)}c.texture.isReady=!0}return c}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,2===t||3===t||11===t,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;null!==(t=i<(null===(e=this._textures)||void 0===e?void 0:e.length))&&void 0!==t&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||(null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class eW extends hT{constructor(e,t,i,n,s){super(e,t,i,n),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=s}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,n=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(n),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,n=0){var s,a,o,l;if(!e._hardwareTexture)return;const u=this._engine._currentFramebuffer;if(this._engine._bindUnboundFramebuffer(this._framebuffer),this._engine.webGLVersion>1){const h=this._context,d=h["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=null!==(a=null!=i?i:null===(s=this.layerIndices)||void 0===s?void 0:s[t])&&void 0!==a?a:0,h.framebufferTextureLayer(h.FRAMEBUFFER,d,e._hardwareTexture.underlyingResource,n,i)):e.isCube?(i=null!==(l=null!=i?i:null===(o=this.faceIndices)||void 0===o?void 0:o[t])&&void 0!==l?l:0,h.framebufferTexture2D(h.FRAMEBUFFER,d,h.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,n)):h.framebufferTexture2D(h.FRAMEBUFFER,d,h.TEXTURE_2D,e._hardwareTexture.underlyingResource,n)}else{const h=this._context;h.framebufferTexture2D(h.FRAMEBUFFER,h["COLOR_ATTACHMENT"+t+"_WEBGL"],void 0!==i?h.TEXTURE_CUBE_MAP_POSITIVE_X+i:h.TEXTURE_2D,e._hardwareTexture.underlyingResource,n)}this._engine._bindUnboundFramebuffer(u)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var i,n;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=null!==(n=null===(i=this._attachments)||void 0===i?void 0:i.length)&&void 0!==n?n:this.textures.length;for(let a=0;a<s;a++){const o=this.textures[a];!o||(o.is2DArray||o.is3D?this._bindTextureRenderTarget(o,a,this.layerIndices[a]):o.isCube?this._bindTextureRenderTarget(o,a,this.faceIndices[a]):this._bindTextureRenderTarget(o,a))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const n=this.textures[e];n.is2DArray||n.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):n.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=!1){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}Ze.prototype._createHardwareRenderTargetWrapper=function(r,e,t){const i=new eW(r,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i},Ze.prototype.createRenderTargetTexture=function(r,e){var t,i;const n=this._createHardwareRenderTargetWrapper(!1,!1,r);let l,s=!0,a=!1,o=!1,c=1;void 0!==e&&"object"==typeof e&&(s=null===(t=e.generateDepthBuffer)||void 0===t||t,a=!!e.generateStencilBuffer,o=!!e.noColorAttachment,l=e.colorAttachment,c=null!==(i=e.samples)&&void 0!==i?i:1);const u=l||(o?null:this._createInternalTexture(r,e,!0,vt.RenderTarget)),h=r.width||r,d=r.height||r,f=this._currentFramebuffer,p=this._gl,g=p.createFramebuffer();return this._bindUnboundFramebuffer(g),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,s,h,d),u&&!u.is2DArray&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,u._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),n._framebuffer=g,n._generateDepthBuffer=s,n._generateStencilBuffer=a,n.setTextures(u),this.updateRenderTargetTextureSampleCount(n,c),n},Ze.prototype.createDepthStencilTexture=function(r,e,t){return e.isCube?this._createDepthStencilCubeTexture(r.width||r,e,t):this._createDepthStencilTexture(r,e,t)},Ze.prototype._createDepthStencilTexture=function(r,e,t){const i=this._gl,n=r.layers||0,s=0!==n?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,a=new hi(this,vt.DepthStencil);if(!this._caps.depthTextureExtension)return H.Error("Depth texture is not supported by your browser or hardware."),a;const o=Mi({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);if(this._bindTextureDirectly(s,a,!0),this._setupDepthStencilTexture(a,r,o.generateStencil,0!==o.comparisonFunction&&o.bilinearFiltering,o.comparisonFunction,o.samples),void 0!==o.depthTextureFormat){if(15!==o.depthTextureFormat&&16!==o.depthTextureFormat&&17!==o.depthTextureFormat&&13!==o.depthTextureFormat&&14!==o.depthTextureFormat&&18!==o.depthTextureFormat)return H.Error("Depth texture format is not supported."),a;a.format=o.depthTextureFormat}else a.format=o.generateStencil?13:16;const l=17===a.format||13===a.format||18===a.format;t._depthStencilTexture=a,t._depthStencilTextureWithStencil=l;let c=i.UNSIGNED_INT;15===a.format?c=i.UNSIGNED_SHORT:17===a.format||13===a.format?c=i.UNSIGNED_INT_24_8:14===a.format?c=i.FLOAT:18===a.format&&(c=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const u=l?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;let h=u;this.webGLVersion>1&&(15===a.format?h=i.DEPTH_COMPONENT16:16===a.format?h=i.DEPTH_COMPONENT24:17===a.format||13===a.format?h=i.DEPTH24_STENCIL8:14===a.format?h=i.DEPTH_COMPONENT32F:18===a.format&&(h=i.DEPTH32F_STENCIL8)),a.is2DArray?i.texImage3D(s,0,h,a.width,a.height,n,0,u,c,null):i.texImage2D(s,0,h,a.width,a.height,0,u,c,null),this._bindTextureDirectly(s,null),this._internalTexturesCache.push(a);const d=t;if(d._depthStencilBuffer){const f=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return a},Ze.prototype.updateRenderTargetTextureSampleCount=function(r,e){if(this.webGLVersion<2||!r||!r.texture)return 1;if(r.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),r._depthStencilBuffer&&(t.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(t.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null);const i=r.texture._hardwareTexture;if(i.releaseMSAARenderBuffers(),e>1&&"function"==typeof t.renderbufferStorageMultisample){const n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=n,this._bindUnboundFramebuffer(r._MSAAFramebuffer);const s=this._createRenderBuffer(r.texture.width,r.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(r.texture.type),t.COLOR_ATTACHMENT0,!1);if(!s)throw new Error("Unable to create multi sampled framebuffer");i.addMSAARenderBuffer(s)}else this._bindUnboundFramebuffer(r._framebuffer);return r.texture.samples=e,r._samples=e,r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.texture.width,r.texture.height,e),this._bindUnboundFramebuffer(null),e},Ze.prototype.createRenderTargetCubeTexture=function(r,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,r),i=Mi({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(1===i.type&&!this._caps.textureFloatLinearFiltering||2===i.type&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const n=this._gl,s=new hi(this,vt.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,s,!0);const a=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);1===i.type&&!this._caps.textureFloat&&(i.type=0,H.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,a.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let l=0;l<6;l++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),r,r,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const o=n.createFramebuffer();return this._bindUnboundFramebuffer(o),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,r,r),i.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=o,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,s.width=r,s.height=r,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,this._internalTexturesCache.push(s),t.setTextures(s),t};class tW{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new iW(e)}sampleFrame(e=Qa.Now){this._enabled&&(null!=this._lastFrameTimeMs&&this._rollingFrameTime.add(e-this._lastFrameTimeMs),this._lastFrameTimeMs=e)}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class iW{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}function dT(r,e,t=!1,i){switch(r){case 3:{const s=(ArrayBuffer,new Int8Array(e));return i&&s.set(new Int8Array(i)),s}case 0:{const s=(ArrayBuffer,new Uint8Array(e));return i&&s.set(new Uint8Array(i)),s}case 4:{const s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&s.set(new Int16Array(i)),s}case 5:case 8:case 9:case 10:case 2:{const s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&s.set(new Uint16Array(i)),s}case 6:{const s=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&s.set(new Int32Array(i)),s}case 7:case 11:case 12:case 13:case 14:case 15:{const s=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&s.set(new Uint32Array(i)),s}case 1:{const s=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&s.set(new Float32Array(i)),s}}const n=(ArrayBuffer,new Uint8Array(e));return i&&n.set(new Uint8Array(i)),n}Ze.prototype.setAlphaConstants=function(r,e,t,i){this._alphaState.setAlphaBlendConstants(r,e,t,i)},Ze.prototype.setAlphaMode=function(r,e=!1){if(this._alphaMode!==r){switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}e||(this.depthCullingState.depthMask=0===r),this._alphaMode=r}else if(!e){const t=0===r;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}},Ze.prototype.getAlphaMode=function(){return this._alphaMode},Ze.prototype.setAlphaEquation=function(r){if(this._alphaEquation!==r){switch(r){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=r}},Ze.prototype.getAlphaEquation=function(){return this._alphaEquation},Ze.prototype._readTexturePixelsSync=function(r,e,t,i=-1,n=0,s=null,a=!0,o=!1,l=0,c=0){var u,h;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=d.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,null===(u=r._hardwareTexture)||void 0===u?void 0:u.underlyingResource,n):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,null===(h=r._hardwareTexture)||void 0===h?void 0:h.underlyingResource,n);let f=void 0!==r.type?this._getWebGLTextureType(r.type):d.UNSIGNED_BYTE;return o?s||(s=dT(r.type,4*e*t)):f===d.UNSIGNED_BYTE?(s||(s=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE):(s||(s=new Float32Array(4*e*t)),f=d.FLOAT),a&&this.flushFramebuffer(),d.readPixels(l,c,e,t,d.RGBA,f,s),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),s},Ze.prototype._readTexturePixels=function(r,e,t,i=-1,n=0,s=null,a=!0,o=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(r,e,t,i,n,s,a,o,l,c))},Ze.prototype.updateDynamicIndexBuffer=function(r,e,t=0){let i;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(r),i=r.is32Bits?e instanceof Uint32Array?e:new Uint32Array(e):e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},Ze.prototype.updateDynamicVertexBuffer=function(r,e,t,i){this.bindArrayBuffer(r),void 0===t&&(t=0),void 0===i||i>=(e.byteLength||e.length)&&0===t?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e instanceof Array?new Float32Array(e):e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e=e instanceof ArrayBuffer?new Uint8Array(e,t,i):new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};let Ve=(()=>{class r extends Ze{static get NpmPackage(){return Ze.NpmPackage}static get Version(){return Ze.Version}static get Instances(){return Je.Instances}static get LastCreatedEngine(){return Je.LastCreatedEngine}static get LastCreatedScene(){return Je.LastCreatedScene}_createImageBitmapFromSource(t,i){return new Promise((s,a)=>{const o=new Image;o.onload=()=>{o.decode().then(()=>{this.createImageBitmap(o,i).then(l=>{s(l)})})},o.onerror=()=>{a(`Error loading image ${o.src}`)},o.src=t})}createImageBitmap(t,i){return createImageBitmap(t,i)}resizeImageBitmap(t,i,n){const a=this.createCanvas(i,n).getContext("2d");if(!a)throw new Error("Unable to get 2d context for resizeImageBitmap");return a.drawImage(t,0,0),a.getImageData(0,0,i,n).data}static MarkAllMaterialsAsDirty(t,i){for(let n=0;n<r.Instances.length;n++){const s=r.Instances[n];for(let a=0;a<s.scenes.length;a++)s.scenes[a].markAllMaterialsAsDirty(t,i)}}static DefaultLoadingScreenFactory(t){throw ht("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!r._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(t){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(t,i,n,s=!1){super(t,i,n,s),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new J,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new J,this.onCanvasBlurObservable=new J,this.onCanvasFocusObservable=new J,this.onCanvasPointerOutObservable=new J,this.onBeginFrameObservable=new J,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new J,this.onBeforeShaderCompilationObservable=new J,this.onAfterShaderCompilationObservable=new J,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new El,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new tW,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],r.Instances.push(this),t&&(this._features.supportRenderPasses=!0,n=this._creationOptions,t.getContext&&(this._sharedInit(t),this._connectVREvents()),this._prepareVRComponent(),n.autoEnableWebVR&&this.initWebVR())}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(t){super._sharedInit(t),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=n=>{this.disableContextMenu&&n.preventDefault()},t.addEventListener("focus",this._onCanvasFocus),t.addEventListener("blur",this._onCanvasBlur),t.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=n=>{document.elementFromPoint(n.clientX,n.clientY)!==t&&this.onCanvasPointerOutObservable.notifyObservers(n)};const i=this.getHostWindow();i&&"function"==typeof i.addEventListener&&(i.addEventListener("blur",this._onBlur),i.addEventListener("focus",this._onFocus)),t.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!r.audioEngine&&this._creationOptions.audioEngine&&r.AudioEngineFactory&&(r.audioEngine=r.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),dh()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&t&&r._RequestPointerlock(t)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===t},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=void 0!==r.OfflineProviderFactory,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var t;null===(t=this._onPointerLockChange)||void 0===t||t.call(this)}getAspectRatio(t,i=!1){const n=t.viewport;return this.getRenderWidth(i)*n.width/(this.getRenderHeight(i)*n.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}generateMipMapsForCubemap(t,i=!0){if(t.generateMipMaps){const n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,t,!0),n.generateMipmap(n.TEXTURE_CUBE_MAP),i&&this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(t){this._depthCullingState.depthMask=t}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(t){this._stencilState.stencilTest=t}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(t){this._stencilState.stencilMask=t}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(t){this._stencilState.stencilFunc=t}setStencilFunctionReference(t){this._stencilState.stencilFuncRef=t}setStencilFunctionMask(t){this._stencilState.stencilFuncMask=t}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(t){this._stencilState.stencilOpStencilFail=t}setStencilOperationDepthFail(t){this._stencilState.stencilOpDepthFail=t}setStencilOperationPass(t){this._stencilState.stencilOpStencilDepthPass=t}setDitheringState(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(t){this._depthCullingState.depthFunc=t}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(t,i,n,s){const a=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,i,n,s),a}scissorClear(t,i,n,s,a){this.enableScissor(t,i,n,s),this.clear(a,!0,!0,!0),this.disableScissor()}enableScissor(t,i,n,s){const a=this._gl;a.enable(a.SCISSOR_TEST),a.scissor(t,i,n,s)}disableScissor(){const t=this._gl;t.disable(t.SCISSOR_TEST)}_reportDrawCall(t=1){this._drawCalls.addCount(t,!1)}initWebVR(){throw ht("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(t,i){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(t,i,n){return new Promise((s,a)=>{this._loadFile(t,o=>{s(o)},void 0,i,n,(o,l)=>{a(l)})})}getVertexShaderSource(t){const i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[0]):null}getFragmentShaderSource(t){const i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[1]):null}setDepthStencilTexture(t,i,n,s){void 0!==t&&(i&&(this._boundUniforms[t]=i),n&&n.depthStencilTexture?this._setTexture(t,n,!1,!0,s):this._setTexture(t,null,void 0,void 0,s))}setTextureFromPostProcess(t,i,n){var s;let a=null;i&&(i._textures.data[i._currentRenderTextureInd]?a=i._textures.data[i._currentRenderTextureInd]:i._forcedOutputTexture&&(a=i._forcedOutputTexture)),this._bindTexture(t,null!==(s=null==a?void 0:a.texture)&&void 0!==s?s:null,n)}setTextureFromPostProcessOutput(t,i,n){var s,a;this._bindTexture(t,null!==(a=null===(s=null==i?void 0:i._outputTexture)||void 0===s?void 0:s.texture)&&void 0!==a?a:null,n)}_rebuildBuffers(){for(const t of this.scenes)t.resetCachedMaterial(),t._rebuildGeometries(),t._rebuildTextures();for(const t of this._virtualScenes)t.resetCachedMaterial(),t._rebuildGeometries(),t._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let t=0;t<this._activeRenderLoops.length;t++)this._activeRenderLoops[t]()}_renderLoop(){if(!this._contextWasLost){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)}enterFullscreen(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&r._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&r._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&r._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){r._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(t=!1){this.isVRPresenting()||super.resize(t)}setSize(t,i,n=!1){if(!this._renderingCanvas||!super.setSize(t,i,n))return!1;if(this.scenes){for(let s=0;s<this.scenes.length;s++){const a=this.scenes[s];for(let o=0;o<a.cameras.length;o++)a.cameras[o]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(t){const i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),super._deletePipelineContext(t)}createShaderProgram(t,i,n,s,a,o=null){a=a||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const l=super.createShaderProgram(t,i,n,s,a,o);return this.onAfterShaderCompilationObservable.notifyObservers(this),l}_createShaderProgram(t,i,n,s,a=null){const o=s.createProgram();if(t.program=o,!o)throw new Error("Unable to create program");if(s.attachShader(o,i),s.attachShader(o,n),this.webGLVersion>1&&a){const l=this.createTransformFeedback();this.bindTransformFeedback(l),this.setTranformFeedbackVaryings(o,a),t.transformFeedback=l}return s.linkProgram(o),this.webGLVersion>1&&a&&this.bindTransformFeedback(null),t.context=s,t.vertexShader=i,t.fragmentShader=n,t.isParallelCompiled||this._finalizePipelineContext(t),o}_releaseTexture(t){super._releaseTexture(t)}_releaseRenderTargetWrapper(t){super._releaseRenderTargetWrapper(t),this.scenes.forEach(i=>{i.postProcesses.forEach(n=>{n._outputTexture===t&&(n._outputTexture=null)}),i.cameras.forEach(n=>{n._postProcesses.forEach(s=>{s&&s._outputTexture===t&&(s._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(t){const i=++r._RenderPassIdCounter;return this._renderPassNames[i]=null!=t?t:"NONAME",i}releaseRenderPassId(t){this._renderPassNames[t]=void 0;for(let i=0;i<this.scenes.length;++i){const n=this.scenes[i];for(let s=0;s<n.meshes.length;++s){const a=n.meshes[s];if(a.subMeshes)for(let o=0;o<a.subMeshes.length;++o)a.subMeshes[o]._removeDrawWrapper(t)}}}_rescaleTexture(t,i,n,s,a){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const o=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&r._RescalePostProcessFactory&&(this._rescalePostProcess=r._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(c){c._bindTexture("textureSampler",t)};let l=n;l||(l=this.scenes[this.scenes.length-1]),l.postProcessManager.directRender([this._rescalePostProcess],o,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,i.width,i.height,0),this.unBindFramebuffer(o),o.dispose(),a&&a()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(t,i=!1,n=3){const s=new $b(t,this._gl),a=new hi(this,vt.Unknown,!0);return a._hardwareTexture=s,a.isReady=!0,a.useMipMaps=i,this.updateTextureSamplingMode(n,a),a}_uploadImageToTexture(t,i,n=0,s=0){const a=this._gl,o=this._getWebGLTextureType(t.type),l=this._getInternalFormat(t.format),c=this._getRGBABufferInternalSizedFormat(t.type,l),u=t.isCube?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;this._bindTextureDirectly(u,t,!0),this._unpackFlipY(t.invertY);let h=a.TEXTURE_2D;t.isCube&&(h=a.TEXTURE_CUBE_MAP_POSITIVE_X+n),a.texImage2D(h,s,c,l,o,i),this._bindTextureDirectly(u,null,!0)}updateTextureComparisonFunction(t,i){if(1===this.webGLVersion)return void H.Error("WebGL 1 does not support texture comparison.");const n=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),0===i?(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,i),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),0===i?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=i}createInstancesBuffer(t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");const n=new gh(i);return n.capacity=t,this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),n.references=1,n}deleteInstancesBuffer(t){this._gl.deleteBuffer(t)}_clientWaitAsync(t,i=0,n=10){const s=this._gl;return new Promise((a,o)=>{const l=()=>{const c=s.clientWaitSync(t,i,0);c!=s.WAIT_FAILED?c!=s.TIMEOUT_EXPIRED?a():setTimeout(l,n):o()};l()})}_readPixelsAsync(t,i,n,s,a,o,l){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const c=this._gl,u=c.createBuffer();c.bindBuffer(c.PIXEL_PACK_BUFFER,u),c.bufferData(c.PIXEL_PACK_BUFFER,l.byteLength,c.STREAM_READ),c.readPixels(t,i,n,s,a,o,0),c.bindBuffer(c.PIXEL_PACK_BUFFER,null);const h=c.fenceSync(c.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(c.flush(),this._clientWaitAsync(h,0,10).then(()=>(c.deleteSync(h),c.bindBuffer(c.PIXEL_PACK_BUFFER,u),c.getBufferSubData(c.PIXEL_PACK_BUFFER,0,l),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),c.deleteBuffer(u),l))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===Je.Instances.length&&r.audioEngine&&(r.audioEngine.dispose(),r.audioEngine=null),this.disableVR();const t=this.getHostWindow();t&&"function"==typeof t.removeEventListener&&(t.removeEventListener("blur",this._onBlur),t.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),dh()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const i=Je.Instances.indexOf(this);i>=0&&Je.Instances.splice(i,1),r.Instances.length||(Je.OnEnginesDisposedObservable.notifyObservers(this),Je.OnEnginesDisposedObservable.clear()),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!rn())return;const t=this.loadingScreen;t&&t.displayLoadingUI()}hideLoadingUI(){if(!rn())return;const t=this._loadingScreen;t&&t.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=r.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(t){this._loadingScreen=t}set loadingUIText(t){this.loadingScreen.loadingUIText=t}set loadingUIBackgroundColor(t){this.loadingScreen.loadingUIBackgroundColor=t}createVideoElement(t){return document.createElement("video")}static _RequestPointerlock(t){if(t.requestPointerLock){const i=t.requestPointerLock();i instanceof Promise?i.then(()=>{t.focus()}).catch(()=>{}):t.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(t){const i=t.requestFullscreen||t.webkitRequestFullscreen;!i||i.call(t)}static _ExitFullscreen(){const t=document;document.exitFullscreen?document.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()}getFontOffset(t){const i=document.createElement("span");i.innerHTML="Hg",i.setAttribute("style",`font: ${t} !important`);const n=document.createElement("div");n.style.display="inline-block",n.style.width="1px",n.style.height="0px",n.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(i),s.appendChild(n),document.body.appendChild(s);let a=0,o=0;try{o=n.getBoundingClientRect().top-i.getBoundingClientRect().top,n.style.verticalAlign="baseline",a=n.getBoundingClientRect().top-i.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:a,height:o,descent:o-a}}}return r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r._RescalePostProcessFactory=null,r._RenderPassIdCounter=0,r})();Z.ShadersStore.postprocessVertexShader="attribute vec2 position;\nuniform vec2 scale;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";const fT={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class pC{constructor(e,t=fT){var i,n;this._fullscreenViewport=new uh(0,0,1,1);const s=null!==(i=t.positions)&&void 0!==i?i:fT.positions,a=null!==(n=t.indices)&&void 0!==n?n:fT.indices;this.engine=e,this._vertexBuffers={[I.PositionKind]:new I(e,s,I.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(a),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(a);for(const o in this._vertexBuffers)this._vertexBuffers[o]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}restoreStates(){this.engine.depthCullingState.depthTest=!0,this.engine.stencilState.stencilTest=!0}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.setViewport();const i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[I.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[I.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class gC{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){let t;this.onApplyObservable=new J;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const n=e.defines?e.defines.join("\n"):"";this._drawWrapper=new Qs(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,n,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new Si(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,n,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const _C="passPixelShader",mC="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}";Z.ShadersStore[_C]=mC;const TC_name=_C,TC_shader=mC;class tr{static _CreateDumpRenderer(){if(!tr._DumpToolsEngine){const e=document.createElement("canvas"),t=new Ze(e,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});t.getCaps().parallelShaderCompile=void 0;const i=new pC(t),n=new gC({engine:t,name:TC_name,fragmentShader:TC_shader,samplerNames:["textureSampler"]});tr._DumpToolsEngine={canvas:e,engine:t,renderer:i,wrapper:n}}return tr._DumpToolsEngine}static DumpFramebuffer(e,t,i,n){return ls(function*(s,a,o,l,c="image/png",u){const h=yield o.readPixels(0,0,s,a),d=new Uint8Array(h.buffer);tr.DumpData(s,a,d,l,c,u,!0)}).apply(this,arguments)}static DumpDataAsync(e,t,i,n="image/png",s,a=!1,o=!1,l){return new Promise(c=>{tr.DumpData(e,t,i,u=>c(u),n,s,a,o,l)})}static DumpData(e,t,i,n,s="image/png",a,o=!1,l=!1,c){const u=tr._CreateDumpRenderer();if(u.engine.setSize(e,t,!0),i instanceof Float32Array){const d=new Uint8Array(i.length);let f=i.length;for(;f--;){const p=i[f];d[f]=p<0?0:p>1?1:Math.round(255*p)}i=d}const h=u.engine.createRawTexture(i,e,t,5,!1,!o,1);u.renderer.setViewport(),u.renderer.applyEffectWrapper(u.wrapper),u.wrapper.effect._bindTexture("textureSampler",h),u.renderer.draw(),l?Ie.ToBlob(u.canvas,d=>{const f=new FileReader;f.onload=p=>{n&&n(p.target.result)},f.readAsArrayBuffer(d)},s,c):Ie.EncodeScreenshotCanvasData(u.canvas,n,s,a,c),h.dispose()}static Dispose(){tr._DumpToolsEngine&&(tr._DumpToolsEngine.wrapper.dispose(),tr._DumpToolsEngine.renderer.dispose(),tr._DumpToolsEngine.engine.dispose()),tr._DumpToolsEngine=null}}Ie.DumpData=tr.DumpData,Ie.DumpDataAsync=tr.DumpDataAsync,Ie.DumpFramebuffer=tr.DumpFramebuffer;let ir=(()=>{class r extends j{get renderList(){return this._renderList}set renderList(t){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),t&&(this._unObserveRenderList=Ob(t,this._renderListHasChanged)),this._renderList=t}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}set onClear(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(t,i){let n;n=Array.isArray(t)?t:[t];for(let s=0;s<n.length;++s)for(let a=0;a<this._renderPassIds.length;++a)n[s].setMaterialForRenderPass(this._renderPassIds[a],void 0!==i?Array.isArray(i)?i[a]:i:void 0)}get isMulti(){var t,i;return null!==(i=null===(t=this._renderTarget)||void 0===t?void 0:t.isMulti)&&void 0!==i&&i}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var t,i;return null!==(i=null===(t=this._renderTarget)||void 0===t?void 0:t._depthStencilTexture)&&void 0!==i?i:null}constructor(t,i,n,s=!1,a=!0,o=0,l=!1,c=j.TRILINEAR_SAMPLINGMODE,u=!0,h=!1,d=!1,f=5,p=!1,g,_,m=!1,T=!1){var v,A,S,x,C,R;let D;if("object"==typeof s){const N=s;s=!!N.generateMipMaps,a=null===(v=N.doNotChangeAspectRatio)||void 0===v||v,o=null!==(A=N.type)&&void 0!==A?A:0,l=!!N.isCube,c=null!==(S=N.samplingMode)&&void 0!==S?S:j.TRILINEAR_SAMPLINGMODE,u=null===(x=N.generateDepthBuffer)||void 0===x||x,h=!!N.generateStencilBuffer,d=!!N.isMulti,f=null!==(C=N.format)&&void 0!==C?C:5,p=!!N.delayAllocation,g=N.samples,_=N.creationFlags,m=!!N.noColorAttachment,T=!!N.useSRGBBuffer,D=N.colorAttachment}if(super(null,n,!s,void 0,c,void 0,void 0,void 0,void 0,f),this._unObserveRenderList=null,this._renderListHasChanged=(N,k)=>{var X;const ne=this._renderList?this._renderList.length:0;(0===k&&ne>0||0===ne)&&(null===(X=this.getScene())||void 0===X||X.meshes.forEach(ge=>{ge._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new J,this.onAfterUnbindObservable=new J,this.onBeforeRenderObservable=new J,this.onAfterRenderObservable=new J,this.onClearObservable=new J,this.onResizeObservable=new J,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=E.Zero(),!(n=this.getScene()))return;const P=this.getScene().getEngine();this._coordinatesMode=j.PROJECTION_MODE,this.renderList=new Array,this.name=t,this.isRenderTarget=!0,this._initialSizeParameter=i,this._renderPassIds=[],this._isCubeData=l,this._processSizeParameter(i),this.renderPassId=this._renderPassIds[0],this._resizeObserver=P.onResizeObservable.add(()=>{}),this._generateMipMaps=!!s,this._doNotChangeAspectRatio=a,this._renderingManager=new Bf(n),this._renderingManager._useSceneAutoClearSetup=!0,!d&&(this._renderTargetOptions={generateMipMaps:s,type:o,format:null!==(R=this._format)&&void 0!==R?R:void 0,samplingMode:this.samplingMode,generateDepthBuffer:u,generateStencilBuffer:h,samples:g,creationFlags:_,noColorAttachment:m,useSRGBBuffer:T,colorAttachment:D,label:this.name},this.samplingMode===j.NEAREST_SAMPLINGMODE&&(this.wrapU=j.CLAMP_ADDRESSMODE,this.wrapV=j.CLAMP_ADDRESSMODE),p||(l?(this._renderTarget=n.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=j.INVCUBIC_MODE,this._textureMatrix=B.Identity()):this._renderTarget=n.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==g&&(this.samples=g)))}createDepthStencilTexture(t=0,i=!0,n=!1,s=1,a=14){var o;null===(o=this._renderTarget)||void 0===o||o.createDepthStencilTexture(t,i,n,s,a)}_releaseRenderPassId(){if(this._scene){const t=this._scene.getEngine();for(let i=0;i<this._renderPassIds.length;++i)t.releaseRenderPassId(this._renderPassIds[i])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const t=this._scene.getEngine(),i=this._isCubeData?6:this.getRenderLayers()||1;for(let n=0;n<i;++n)this._renderPassIds[n]=t.createRenderPassId(`RenderTargetTexture - ${this.name}#${n}`)}_processSizeParameter(t){if(t.ratio){this._sizeRatio=t.ratio;const i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=t;this._createRenderPassId()}get samples(){var t,i;return null!==(i=null===(t=this._renderTarget)||void 0===t?void 0:t.samples)&&void 0!==i?i:this._samples}set samples(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(t){this._refreshRate=t,this.resetRefreshCounter()}addPostProcess(t){if(!this._postProcessManager){const i=this.getScene();if(!i)return;this._postProcessManager=new Lf(i),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].autoClear=!1}clearPostProcesses(t=!1){if(this._postProcesses){if(t)for(const i of this._postProcesses)i.dispose();this._postProcesses=[]}}removePostProcess(t){if(!this._postProcesses)return;const i=this._postProcesses.indexOf(t);-1!==i&&(this._postProcesses.splice(i,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){return this._size.layers||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(t){const i=Math.max(1,this.getRenderSize()*t);this.resize(i)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(t){var i;const n=this.isCube;null===(i=this._renderTarget)||void 0===i||i.dispose(),this._renderTarget=null;const s=this.getScene();!s||(this._processSizeParameter(t),this._renderTarget=n?s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(t=!1,i=!1){this._render(t,i)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(t=!1,i=!1,n=!1){var s;const a=this.getScene();if(!a)return n;const o=a.getEngine();if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let d=0;d<this._waitingRenderList.length;d++){const p=a.getMeshById(this._waitingRenderList[d]);p&&this.renderList.push(p)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const d=this.getScene();if(!d)return n;const f=d.meshes;for(let p=0;p<f.length;p++){const g=f[p];this.renderListPredicate(g)&&this.renderList.push(g)}}const l=o.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const c=null!==(s=this.activeCamera)&&void 0!==s?s:a.activeCamera,u=a.activeCamera;c&&(c!==a.activeCamera&&(a.setTransformMatrix(c.getViewMatrix(),c.getProjectionMatrix(!0)),a.activeCamera=c),o.setViewport(c.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let h=n;if(n){a.getViewMatrix()||a.updateTransformMatrix();const d=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let f=0;f<d&&h;f++){let p=null;const g=this.renderList?this.renderList:a.getActiveMeshes().data,_=this.renderList?this.renderList.length:a.getActiveMeshes().length;o.currentRenderPassId=this._renderPassIds[f],this.onBeforeRenderObservable.notifyObservers(f),this.getCustomRenderList&&(p=this.getCustomRenderList(f,g,_)),p||(p=g),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0);for(let m=0;m<p.length&&h;++m){const T=p[m];if(T.isEnabled()&&!T.isBlocked&&T.isVisible&&T.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(T,this.refreshRate,n)){h=!1;continue}}else if(!T.isReady(!0)){h=!1;continue}}this.onAfterRenderObservable.notifyObservers(f),(this.is2DArray||this.isCube)&&(a.incrementRenderId(),a.resetCachedMaterial())}}else if(this.is2DArray&&!this.isMulti)for(let d=0;d<this.getRenderLayers();d++)this._renderToTarget(0,t,i,d,c),a.incrementRenderId(),a.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let d=0;d<6;d++)this._renderToTarget(d,t,i,void 0,c),a.incrementRenderId(),a.resetCachedMaterial();else this._renderToTarget(0,t,i,void 0,c);return this.onAfterUnbindObservable.notifyObservers(this),o.currentRenderPassId=l,u&&(a.activeCamera=u,(a.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==a.activeCamera)&&a.setTransformMatrix(a.activeCamera.getViewMatrix(),a.activeCamera.getProjectionMatrix(!0)),o.setViewport(a.activeCamera.viewport)),a.resetCachedMaterial(),h}_bestReflectionRenderTargetDimension(t,i){const s=t*i,a=Ve.NearestPOT(s+16384/(128+s));return Math.min(Ve.FloorPOT(t),a)}_prepareRenderingManager(t,i,n,s){const a=this.getScene();if(!a)return;this._renderingManager.reset();const o=a.getRenderId();for(let l=0;l<i;l++){const c=t[l];if(c&&!c.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!c.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!c._internalAbstractMeshDataInfo._currentLODIsUpToDate&&a.activeCamera&&(c._internalAbstractMeshDataInfo._currentLOD=a.customLODSelector?a.customLODSelector(c,this.activeCamera||a.activeCamera):c.getLOD(this.activeCamera||a.activeCamera),c._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!c._internalAbstractMeshDataInfo._currentLOD)continue;let h,u=c._internalAbstractMeshDataInfo._currentLOD;if(u._preActivateForIntermediateRendering(o),h=!(!s||!n)&&0==(c.layerMask&n.layerMask),c.isEnabled()&&c.isVisible&&c.subMeshes&&!h&&(u!==c&&u._activate(o,!0),c._activate(o,!0)&&c.subMeshes.length)){c.isAnInstance?c._internalAbstractMeshDataInfo._actAsRegularMesh&&(u=c):u._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,u._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let d=0;d<u.subMeshes.length;d++)this._renderingManager.dispatch(u.subMeshes[d],u)}}}for(let l=0;l<a.particleSystems.length;l++){const c=a.particleSystems[l],u=c.emitter;!c.isStarted()||!u||u.position&&!u.isEnabled()||this._renderingManager.dispatchParticles(c)}}_bindFrameBuffer(t=0,i=0){const n=this.getScene();if(!n)return;const s=n.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,i)}_unbindFrameBuffer(t,i){!this._renderTarget||t.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(i)})}_prepareFrame(t,i,n,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!s||!t.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(i,n)}_renderToTarget(t,i,n,s=0,a=null){var o,l,c,u,h,d;const f=this.getScene();if(!f)return;const p=f.getEngine();if(null===(o=p._debugPushGroup)||void 0===o||o.call(p,`render to face #${t} layer #${s}`,1),this._prepareFrame(f,t,s,i),this.is2DArray?(p.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(p.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t)),p.snapshotRendering&&1===p.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(p):this.skipInitialClear||p.clear(this.clearColor||f.clearColor,!0,!0,!0);else{let _=null;const m=this.renderList?this.renderList:f.getActiveMeshes().data,T=this.renderList?this.renderList.length:f.getActiveMeshes().length;this.getCustomRenderList&&(_=this.getCustomRenderList(this.is2DArray?s:t,m,T)),_?this._prepareRenderingManager(_,_.length,a,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(m,T,a,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),_=m);for(const A of f._beforeRenderTargetClearStage)A.action(this,t,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(p):this.skipInitialClear||p.clear(this.clearColor||f.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0);for(const A of f._beforeRenderTargetDrawStage)A.action(this,t,s);this._renderingManager.render(this.customRenderFunction,_,this.renderParticles,this.renderSprites);for(const A of f._afterRenderTargetDrawStage)A.action(this,t,s);const v=null!==(c=null===(l=this._texture)||void 0===l?void 0:l.generateMipMaps)&&void 0!==c&&c;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,null!==(u=this._renderTarget)&&void 0!==u?u:void 0,t,this._postProcesses,this.ignoreCameraViewport):i&&f.postProcessManager._finalizeFrame(!1,null!==(h=this._renderTarget)&&void 0!==h?h:void 0,t);for(const A of f._afterRenderTargetPostProcessStage)A.action(this,t,s);this._texture&&(this._texture.generateMipMaps=v),this._doNotChangeAspectRatio||f.updateTransformMatrix(!0),n&&tr.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),p)}this._unbindFrameBuffer(p,t),this._texture&&this.isCube&&5===t&&p.generateMipMapsForCubemap(this._texture),null===(d=p._debugPopGroup)||void 0===d||d.call(p,1)}setRenderingOrder(t,i=null,n=null,s=null){this._renderingManager.setRenderingOrder(t,i,n,s)}setRenderingAutoClearDepthStencil(t,i){this._renderingManager.setRenderingAutoClearDepthStencil(t,i),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const t=this.getSize(),i=new r(this.name,t,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const t=super.serialize();if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(let i=0;i<this.renderList.length;i++)t.renderList.push(this.renderList[i].id);return t}disposeFramebufferObjects(){var t;null===(t=this._renderTarget)||void 0===t||t.dispose(!0)}releaseInternalTexture(){var t;null===(t=this._renderTarget)||void 0===t||t.releaseTextures(),this._texture=null}dispose(){var t;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const i=this.getScene();if(!i)return;let n=i.customRenderTargets.indexOf(this);n>=0&&i.customRenderTargets.splice(n,1);for(const s of i.cameras)n=s.customRenderTargets.indexOf(this),n>=0&&s.customRenderTargets.splice(n,1);null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===r.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=r.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}return r.REFRESHRATE_RENDER_ONCE=0,r.REFRESHRATE_RENDER_ONEVERYFRAME=1,r.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,r})();j._CreateRenderTargetTexture=(r,e,t,i,n)=>new ir(r,e,t,i);class li{static RegisterShaderCodeProcessing(e,t){t?li._CustomShaderCodeProcessing[null!=e?e:""]=t:delete li._CustomShaderCodeProcessing[null!=e?e:""]}static _GetShaderCodeProcessing(e){var t;return null!==(t=li._CustomShaderCodeProcessing[e])&&void 0!==t?t:li._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,n,s,a,o=1,l,c,u=null,h=0,d="postprocess",f,p=!1,g=5,_=Ri.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Qn(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new We(1,1),this._texelSize=We.Zero(),this.onActivateObservable=new J,this.onSizeChangedObservable=new J,this.onApplyObservable=new J,this.onBeforeRenderObservable=new J,this.onAfterRenderObservable=new J,this.name=e,null!=a?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=s,this.renderTargetSamplingMode=o||1,this._reusable=c||!1,this._textureType=h,this._textureFormat=g,this._shaderLanguage=_,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new Qs(this._engine),p||this.updateEffect(u)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new Qn(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,n,s,a,o,l){var c,u;const h=li._GetShaderCodeProcessing(this.name);if(null==h?void 0:h.defineCustomBindings){const d=null!==(c=null==t?void 0:t.slice())&&void 0!==c?c:[];d.push(...this._parameters);const f=null!==(u=null==i?void 0:i.slice())&&void 0!==u?u:[];f.push(...this._samplers),e=h.defineCustomBindings(this.name,e,d,f),t=d,i=f}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:null!=o?o:this._vertexUrl,fragment:null!=l?l:this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:[],samplers:i||this._samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:null!=s?s:null,onError:null!=a?a:null,indexParameters:n||this._indexParameters,processCodeAfterIncludes:(null==h?void 0:h.processCodeAfterIncludes)?(d,f)=>h.processCodeAfterIncludes(this.name,d,f):null,processFinalCode:(null==h?void 0:h.processFinalCode)?(d,f)=>h.processFinalCode(this.name,d,f):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const n=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:n,postProcessChannel:i,lastUsedRenderId:-1}),n}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}_resize(e,t,i,n,s){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let a=null;for(let c=0;c<i._postProcesses.length;c++)if(null!==i._postProcesses[c]){a=i._postProcesses[c];break}const o={width:this.width,height:this.height},l={generateMipMaps:n,generateDepthBuffer:s||a===this,generateStencilBuffer:(s||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,t=null,i){var n,s;const a=(e=e||this._camera).getScene(),o=a.getEngine(),l=o.getCaps().maxTextureSize;let c=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0;const u=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,h=e.parent;h&&(h.leftCamera==e||h.rightCamera==e)&&(c/=2);let d=this._options.width||c,f=this._options.height||u;const p=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const _=o.currentViewport;_&&(d*=_.width,f*=_.height)}(p||this.alwaysForcePOT)&&(this._options.width||(d=o.needPOTTextures?Ve.GetExponentOfTwo(d,l,this.scaleMode):d),this._options.height||(f=o.needPOTTextures?Ve.GetExponentOfTwo(f,l,this.scaleMode):f)),(this.width!==d||this.height!==f)&&this._resize(d,f,e,p,i),this._textures.forEach(_=>{_.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(_,this.samples)}),this._flushTextureCache(),this._renderId++}let g;if(this._shareOutputWithPostProcess)g=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)g=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let _;g=this.inputTexture;for(let m=0;m<this._textureCache.length;m++)if(this._textureCache[m].texture===g){_=this._textureCache[m];break}_&&(_.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(c/d,u/f),this._engine.bindFramebuffer(g,0,c,u,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(g,0,void 0,void 0,this.forceFullscreenViewport)),null===(s=(n=this._engine)._debugInsertMarker)||void 0===s||s.call(n,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:a.clearColor,a._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),g}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return null!==(t=null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}apply(){var e,t,i;if(!(null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady()))return null;let n;return this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),n=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",null==n?void 0:n.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),null===(i=null===(t=li._GetShaderCodeProcessing(this.name))||void 0===t?void 0:t.bindCustomBindings)||void 0===i||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=lt.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=li.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const n=zr(e.customType);if(!n||!n._Parse)return null;const s=t?t.getCameraById(e.cameraId):null;return n._Parse(e,s,t,i)}static _Parse(e,t,i,n){return lt.Parse(()=>new li(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,n)}}li._CustomShaderCodeProcessing={},b([O()],li.prototype,"uniqueId",void 0),b([O()],li.prototype,"name",void 0),b([O()],li.prototype,"width",void 0),b([O()],li.prototype,"height",void 0),b([O()],li.prototype,"renderTargetSamplingMode",void 0),b([jm()],li.prototype,"clearColor",void 0),b([O()],li.prototype,"autoClear",void 0),b([O()],li.prototype,"forceAutoClearInAlphaMode",void 0),b([O()],li.prototype,"alphaMode",void 0),b([O()],li.prototype,"alphaConstants",void 0),b([O()],li.prototype,"enablePixelPerfectMode",void 0),b([O()],li.prototype,"forceFullscreenViewport",void 0),b([O()],li.prototype,"scaleMode",void 0),b([O()],li.prototype,"alwaysForcePOT",void 0),b([O("samples")],li.prototype,"_samples",void 0),b([O()],li.prototype,"adaptScaleToCurrentViewport",void 0),ye("BABYLON.PostProcess",li);Z.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};";Z.IncludesShadersStore.packingFunctions="vec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}";Z.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";Z.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});\ncomputedWeight=KERNEL_DEP_WEIGHT{X}*factor;\nsumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";Z.ShadersStore.kernelBlurPixelShader="uniform sampler2D textureSampler;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;\nfloat sampleCoC(in vec2 offset) {\nfloat coc=texture2D(circleOfConfusionSampler,offset).r;\nreturn coc; \n}\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";Z.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";Z.ShadersStore.kernelBlurVertexShader="attribute vec2 position;\nuniform vec2 delta;\nvarying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class dr extends li{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,n,s,a=j.BILINEAR_SAMPLINGMODE,o,l,c=0,u="",h=!1,d=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],n,s,a,o,l,null,c,"kernelBlur",{varyingCount:0,depCount:0},!0,d),this._blockCompilation=h,this._packedFloat=!1,this._staticDefines="",this._staticDefines=u,this.direction=t,this.onApplyObservable.add(f=>{this._outputTexture?f.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):f.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}updateEffect(e=null,t=null,i=null,n,s,a){this._updateParameters(s,a)}_updateParameters(e,t){const i=this._kernel,n=(i-1)/2;let s=[],a=[],o=0;for(let _=0;_<i;_++){const T=this._gaussianWeight(_/(i-1)*2-1);s[_]=_-n,a[_]=T,o+=T}for(let _=0;_<a.length;_++)a[_]/=o;const l=[],c=[],u=[];for(let _=0;_<=n;_+=2){const m=Math.min(_+1,Math.floor(n));if(_===m)u.push({o:s[_],w:a[_]});else{const A=a[_]+a[m]*(m===n?.5:1),S=s[_]+1/(1+a[_]/a[m]);0===S?(u.push({o:s[_],w:a[_]}),u.push({o:s[_+1],w:a[_+1]})):(u.push({o:S,w:A}),u.push({o:-S,w:A}))}}for(let _=0;_<u.length;_++)c[_]=u[_].o,l[_]=u[_].w;s=c,a=l;const h=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(h,0)-1;let f=Math.min(s.length,d),p="";p+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(a[f-1])}\r\n`,f--);for(let _=0;_<f;_++)p+=`#define KERNEL_OFFSET${_} ${this._glslFloat(s[_])}\r\n`,p+=`#define KERNEL_WEIGHT${_} ${this._glslFloat(a[_])}\r\n`;let g=0;for(let _=d;_<s.length;_++)p+=`#define KERNEL_DEP_OFFSET${g} ${this._glslFloat(s[_])}\r\n`,p+=`#define KERNEL_DEP_WEIGHT${g} ${this._glslFloat(a[_])}\r\n`,g++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(p,null,null,{varyingCount:f,depCount:g},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!=0&&Math.floor(i/2)%2==0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333;return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(-e*e/(2*t*t))}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,n){return lt.Parse(()=>new dr(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,n)}}b([O("kernel")],dr.prototype,"_kernel",void 0),b([O("packedFloat")],dr.prototype,"_packedFloat",void 0),b([Lb()],dr.prototype,"direction",void 0),ye("BABYLON.BlurPostProcess",dr);class xl{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let n=0;n<i.meshes.length;n++){const s=i.meshes[n];if(s.material){if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers)if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes)for(const a of s.subMeshes)if(a.effect===t){s.computeBonesUsingShaders=!1;break}}else!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1)}}else{const i=this._defines[this._currentRank];if(i)for(let n=0;n<i.length;n++)e=e.replace("#define "+i[n],"");this._currentRank++}return e}}Z.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {\nreturn mod(2.0*_P.y+_P.x+1.0,4.0);\n}\nfloat bayerDither4(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);\n}\nfloat bayerDither8(vec2 _P) {\nvec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);\n}\n";Z.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform float softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;\nvarying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";Z.IncludesShadersStore.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";Z.IncludesShadersStore.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";Z.IncludesShadersStore.shadowMapFragment="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";Z.ShadersStore.shadowMapPixelShader="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nfloat alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";Z.IncludesShadersStore.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform sampler2D boneSampler;\nuniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{\nfloat offset=index *4.0;\nfloat dx=1.0/boneTextureWidth;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;\nuniform vec2 bakedVertexAnimationTextureSizeInverted;\nuniform vec4 bakedVertexAnimationSettings;\nuniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{\nfloat offset=index*4.0;\nfloat frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;\nfloat dx=bakedVertexAnimationTextureSizeInverted.x;\nvec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));\nvec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));\nvec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));\nvec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));\nreturn mat4(m0,m1,m2,m3);\n}\n#endif\n";Z.IncludesShadersStore.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nprecision mediump sampler2DArray; \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];\nuniform vec3 morphTargetTextureInfo;\nuniform sampler2DArray morphTargets;\nvec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);\nfloat x=vertexIndex-y*morphTargetTextureInfo.y;\nvec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);\nreturn texture(morphTargets,textureUV).xyz;\n}\n#endif\n#endif\n";Z.IncludesShadersStore.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.helperFunctions="const float PI=3.1415926535897932384626433832795;\nconst float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nconst float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=0.0773993808*color;\nvec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{\nvec3 nearZeroSection=12.92*color;\nvec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;\nfloat remainingSection=pow(0.947867299*(color+0.055),2.4);\nreturn color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;\nfloat remainingSection=1.055*pow(color,0.41666)-0.055;\nreturn color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nvec3 square(vec3 value)\n{\nreturn value*value;\n}\nfloat pow5(float value) {\nfloat sq=value*value;\nreturn sq*sq*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat normVariance=varianceAmount/255.0;\nfloat dither=mix(-normVariance,normVariance,rand);\nreturn dither;\n}\nconst float rgbdMaxRange=255.0;\nvec4 toRGBD(vec3 color) {\nfloat maxRGB=maxEps(max(color.r,max(color.g,color.b)));\nfloat D =max(rgbdMaxRange/maxRGB,1.);\nD =clamp(floor(D)/255.0,0.,1.);\nvec3 rgb=color.rgb*D;\nrgb=toGammaSpace(rgb);\nreturn vec4(clamp(rgb,0.,1.),D); \n}\nvec3 fromRGBD(vec4 rgbd) {\nrgbd.rgb=toLinearSpace(rgbd.rgb);\nreturn rgbd.rgb/rgbd.a;\n}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\nvec3 intersectPositionWS=vertexPos+origVec*distance;\nreturn intersectPositionWS-cubePos;\n}\n";Z.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;\nuniform mat4 projection;\nuniform vec4 vEyePosition;\n";Z.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;\nuniform float visibility;\n";Z.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";Z.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;\nuniform Scene {\nmat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;\nmat4 projection;\nvec4 vEyePosition;\n};\n";Z.IncludesShadersStore.meshUboDeclaration="#ifdef WEBGL2\nuniform mat4 world;\nuniform float visibility;\n#else\nlayout(std140,column_major) uniform;\nuniform Mesh\n{\nmat4 world;\nfloat visibility;\n};\n#endif\n#define WORLD_UBO\n";Z.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";Z.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;\nuniform vec2 depthValuesSM;\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";Z.IncludesShadersStore.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;\nvarying float fClipDistance6;\n#endif\n";Z.IncludesShadersStore.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";Z.IncludesShadersStore.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=float(gl_VertexID)*morphTargetTextureInfo.x;\npositionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n";Z.IncludesShadersStore.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";Z.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;\nfloat VATEndFrame=BVASNAME.y;\nfloat VATOffsetFrame=BVASNAME.z;\nfloat VATSpeed=BVASNAME.w;\nfloat totalFrames=VATEndFrame-VATStartFrame+1.0;\nfloat time=bakedVertexAnimationTime*VATSpeed/totalFrames;\nfloat frameCorrection=time<1.0 ? 0.0 : 1.0;\nfloat numOfFrames=totalFrames-frameCorrection;\nfloat VATFrameNum=fract(time)*numOfFrames;\nVATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum+=VATStartFrame+frameCorrection;\nmat4 VATInfluence;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";Z.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;\nvec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);\nfloat sinNLSM=sqrt(1.0-ndlSM*ndlSM);\nfloat normalBiasSM=biasAndScaleSM.y*sinNLSM;\nworldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";Z.IncludesShadersStore.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;\ngl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";Z.IncludesShadersStore.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";Z.ShadersStore.shadowMapVertexShader="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));\nvNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";Z.ShadersStore.depthBoxBlurPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}";Z.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;\n#endif\n";let fr=(()=>{class r{get bias(){return this._bias}set bias(t){this._bias=t}get normalBias(){return this._normalBias}set normalBias(t){this._normalBias=t}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(t){this._blurBoxOffset!==t&&(this._blurBoxOffset=t,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(t){this._blurScale!==t&&(this._blurScale=t,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(t){this._blurKernel!==t&&(this._blurKernel=t,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(t){this._useKernelBlur!==t&&(this._useKernelBlur=t,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(t){this._depthScale=t}_validateFilter(t){return t}get filter(){return this._filter}set filter(t){if(t=this._validateFilter(t),this._light.needCube()){if(t===r.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(t===r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(t===r.FILTER_PCF||t===r.FILTER_PCSS)return void(this.usePoissonSampling=!0)}t!==r.FILTER_PCF&&t!==r.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==t&&(this._filter=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===r.FILTER_POISSONSAMPLING}set usePoissonSampling(t){const i=this._validateFilter(r.FILTER_POISSONSAMPLING);!t&&this.filter!==r.FILTER_POISSONSAMPLING||(this.filter=t?i:r.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===r.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_EXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_EXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===r.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_BLUREXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===r.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_CLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(t){const i=this._validateFilter(r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:r.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===r.FILTER_PCF}set usePercentageCloserFiltering(t){const i=this._validateFilter(r.FILTER_PCF);!t&&this.filter!==r.FILTER_PCF||(this.filter=t?i:r.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(t){this._filteringQuality!==t&&(this._filteringQuality=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===r.FILTER_PCSS}set useContactHardeningShadow(t){const i=this._validateFilter(r.FILTER_PCSS);!t&&this.filter!==r.FILTER_PCSS||(this.filter=t?i:r.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(t){this._contactHardeningLightSizeUVRatio=t}get darkness(){return this._darkness}set darkness(t){this.setDarkness(t)}getDarkness(){return this._darkness}setDarkness(t){return this._darkness=t>=1?1:t<=0?0:t,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(t){this.setTransparencyShadow(t)}setTransparencyShadow(t){return this._transparencyShadow=t,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return r.CLASSNAME}addShadowCaster(t,i=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t),i)for(const n of t.getChildMeshes())-1===this._shadowMap.renderList.indexOf(n)&&this._shadowMap.renderList.push(n);return this}removeShadowCaster(t,i=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const n=this._shadowMap.renderList.indexOf(t);if(-1!==n&&this._shadowMap.renderList.splice(n,1),i)for(const s of t.getChildren())this.removeShadowCaster(s);return this}getLight(){return this._light}_getCamera(){var t;return null!==(t=this._camera)&&void 0!==t?t:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(t){this._mapSize=t,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(t,i,n,s){this.onBeforeShadowMapRenderObservable=new J,this.onAfterShadowMapRenderObservable=new J,this.onBeforeShadowMapRenderMeshObservable=new J,this.onAfterShadowMapRenderMeshObservable=new J,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=r.FILTER_NONE,this._filteringQuality=r.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=E.Zero(),this._viewMatrix=B.Zero(),this._projectionMatrix=B.Zero(),this._transformMatrix=B.Zero(),this._cachedPosition=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=B.Identity(),this._mapSize=t,this._light=i,this._scene=i.getScene(),this._camera=null!=s?s:null;let a=i._shadowGenerators;a||(a=i._shadowGenerators=new Map),a.set(this._camera,this),this.id=i.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),r._SceneComponentInitialization(this._scene);const o=this._scene.getEngine().getCaps();this._textureType=n?o.textureFloatRender&&o.textureFloatLinearFiltering?1:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?2:0:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?2:o.textureFloatRender&&o.textureFloatLinearFiltering?1:0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const t=this._scene.getEngine();t._features.supportDepthStencilTexture?(this._shadowMap=new ir(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new ir(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=j.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=j.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(j.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=()=>!0;const t=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var s;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(s=t._debugPushGroup)||void 0===s||s.call(t,`shadow map generation for pass id ${t.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(s=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=s,this._filter===r.FILTER_PCF&&t.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var s,a;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===r.FILTER_PCF&&t.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void(null===(s=t._debugPopGroup)||void 0===s||s.call(t,1));const o=this.getShadowMapForRendering();o&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,o.renderTarget,!0),t.unBindFramebuffer(o.renderTarget,!0),null===(a=t._debugPopGroup)||void 0===a||a.call(t,1))});const i=new ct(0,0,0,0),n=new ct(1,1,1,1);this._shadowMap.onClearObservable.add(s=>{this._filter===r.FILTER_PCF?s.clear(n,!1,!0,!1):s.clear(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?i:n,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(s=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=s.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let s=Bf.MIN_RENDERINGGROUPS;s<Bf.MAX_RENDERINGGROUPS;s++)this._shadowMap.setRenderingAutoClearDepthStencil(s,!1)}_initializeBlurRTTAndPostProcesses(){const t=this._scene.getEngine(),i=this._mapSize/this.blurScale;(!this.useKernelBlur||1!==this.blurScale)&&(this._shadowMap2=new ir(this._light.name+"_shadowMap2",i,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=j.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=j.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(j.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new dr(this._light.name+"KernelBlurX",new We(1,0),this.blurKernel,1,null,j.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.width=i,this._kernelBlurXPostprocess.height=i,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(n=>{n.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new dr(this._light.name+"KernelBlurY",new We(0,1),this.blurKernel,1,null,j.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new li(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,j.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(n=>{n.setFloat2("screenSize",i,i),n.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(t,i,n,s){let a;if(s.length)for(a=0;a<s.length;a++)this._renderSubMeshForShadowMap(s.data[a]);for(a=0;a<t.length;a++)this._renderSubMeshForShadowMap(t.data[a]);for(a=0;a<i.length;a++)this._renderSubMeshForShadowMap(i.data[a]);if(this._transparencyShadow)for(a=0;a<n.length;a++)this._renderSubMeshForShadowMap(n.data[a],!0);else for(a=0;a<n.length;a++)n.data[a].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(t,i,n){i.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(t,i=!1){var n,s;const a=t.getRenderingMesh(),o=t.getEffectiveMesh(),l=this._scene,c=l.getEngine(),u=t.getMaterial();if(o._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!u||0===t.verticesCount||t._renderId===l.getRenderId())return;const h=o._getWorldMatrixDeterminant()<0;let d=null!==(n=a.overrideMaterialSideOrientation)&&void 0!==n?n:u.sideOrientation;h&&(d=0===d?1:0),c.setState(u.backFaceCulling,void 0,void 0,0===d,u.cullBackFaces);const p=a._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(p.mustReturn)return;const g=c.getCaps().instancedArrays&&(null!=p.visibleInstances[t._id]||a.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(t))if(this.isReady(t,g,i)){t._renderId=l.getRenderId();const _=u.shadowDepthWrapper,m=null!==(s=null==_?void 0:_.getEffect(t,this,c.currentRenderPassId))&&void 0!==s?s:t._getDrawWrapper(),T=Qs.GetEffect(m);c.enableEffect(m),g||a._bind(t,T,u.fillMode),this.getTransformMatrix(),T.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Rt.LIGHTTYPEID_DIRECTIONALLIGHT?T.setVector3("lightDataSM",this._cachedDirection):T.setVector3("lightDataSM",this._cachedPosition);const v=this._getCamera();if(v&&T.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(v),this.getLight().getDepthMinZ(v)+this.getLight().getDepthMaxZ(v)),i&&this.enableSoftTransparentShadow&&T.setFloat("softTransparentShadowSM",o.visibility*u.alpha),_)t._setMainDrawWrapperOverride(m),_.standalone?_.baseMaterial.bindForSubMesh(o.getWorldMatrix(),a,t):u.bindForSubMesh(o.getWorldMatrix(),a,t),t._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(T.setTexture("diffuseSampler",this._opacityTexture),T.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){const S=a.skeleton;if(S.isUsingTextureForMatrices){const x=S.getTransformMatrixTexture(a);if(!x)return;T.setTexture("boneSampler",x),T.setFloat("boneTextureWidth",4*(S.bones.length+1))}else T.setMatrices("mBones",S.getTransformMatrices(a))}fe.BindMorphTargetParameters(a,T),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(T),Uo(T,u,l)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(t,T,o),fe.BindSceneUniformBuffer(T,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const A=o.getWorldMatrix();g&&(o.getMeshUniformBuffer().bindToEffect(T,"Mesh"),o.transferToEffect(A)),this.forceBackFacesOnly&&c.setState(!0,0,!1,!0,u.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(a),this.onBeforeShadowMapRenderObservable.notifyObservers(T),a._processRendering(o,t,T,u.fillMode,p,g,(S,x)=>{o===a||S?(o.getMeshUniformBuffer().bindToEffect(T,"Mesh"),o.transferToEffect(S?x:A)):(a.getMeshUniformBuffer().bindToEffect(T,"Mesh"),a.transferToEffect(x))}),this.forceBackFacesOnly&&c.setState(!0,0,!1,!1,u.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(T),this.onAfterShadowMapRenderMeshObservable.notifyObservers(a)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){!this._shadowMap||this._shadowMap.updateSamplingMode(this.filter===r.FILTER_NONE||this.filter===r.FILTER_PCSS?j.NEAREST_SAMPLINGMODE:j.BILINEAR_SAMPLINGMODE)}forceCompilation(t,i){const n=Mi({useInstances:!1},i),s=this.getShadowMap();if(!s)return void(t&&t(this));const a=s.renderList;if(!a)return void(t&&t(this));const o=new Array;for(const u of a)o.push(...u.subMeshes);if(0===o.length)return void(t&&t(this));let l=0;const c=()=>{var u,h;if(this._scene&&this._scene.getEngine()){for(;this.isReady(o[l],n.useInstances,null!==(h=null===(u=o[l].getMaterial())||void 0===u?void 0:u.needAlphaBlendingForMesh(o[l].getMesh()))&&void 0!==h&&h);)if(l++,l>=o.length)return void(t&&t(this));setTimeout(c,16)}};c()}forceCompilationAsync(t){return new Promise(i=>{this.forceCompilation(()=>{i()},t)})}_isReadyCustomDefines(t,i,n){}_prepareShadowDefines(t,i,n,s){n.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),n.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),n.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),n.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const a=t.getMesh();return n.push("#define SM_NORMALBIAS "+(this.normalBias&&a.isVerticesDataPresent(I.NormalKind)?"1":"0")),n.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Rt.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),n.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),n.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(n,t,i),n}isReady(t,i,n){var s;const a=t.getMaterial(),o=null==a?void 0:a.shadowDepthWrapper;if(this._opacityTexture=null,!a)return!1;const l=[];if(this._prepareShadowDefines(t,i,l,n),o){if(!o.isReadyForSubMesh(t,l,this,i,this._scene.getEngine().currentRenderPassId))return!1}else{const c=t._getDrawWrapper(void 0,!0);let u=c.effect,h=c.defines;const d=[I.PositionKind],f=t.getMesh();this.normalBias&&f.isVerticesDataPresent(I.NormalKind)&&(d.push(I.NormalKind),l.push("#define NORMAL"),f.nonUniformScaling&&l.push("#define NONUNIFORMSCALING"));const p=a.needAlphaTesting();if((p||a.needAlphaBlending())&&(this._opacityTexture=this.useOpacityTextureForTransparentShadow?a.opacityTexture:a.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const v=null!==(s=a.alphaCutOff)&&void 0!==s?s:r.DEFAULT_ALPHA_CUTOFF;l.push("#define ALPHATEXTURE"),p&&l.push(`#define ALPHATESTVALUE ${v}${v%1==0?".":""}`),f.isVerticesDataPresent(I.UVKind)&&(d.push(I.UVKind),l.push("#define UV1")),f.isVerticesDataPresent(I.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(d.push(I.UV2Kind),l.push("#define UV2"))}const g=new xl;if(f.useBones&&f.computeBonesUsingShaders&&f.skeleton){d.push(I.MatricesIndicesKind),d.push(I.MatricesWeightsKind),f.numBoneInfluencers>4&&(d.push(I.MatricesIndicesExtraKind),d.push(I.MatricesWeightsExtraKind));const v=f.skeleton;l.push("#define NUM_BONE_INFLUENCERS "+f.numBoneInfluencers),f.numBoneInfluencers>0&&g.addCPUSkinningFallback(0,f),l.push(v.isUsingTextureForMatrices?"#define BONETEXTURE":"#define BonesPerMesh "+(v.bones.length+1))}else l.push("#define NUM_BONE_INFLUENCERS 0");const _=f.morphTargetManager;let m=0;if(_&&_.numInfluencers>0&&(l.push("#define MORPHTARGETS"),m=_.numInfluencers,l.push("#define NUM_MORPH_INFLUENCERS "+m),_.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),fe.PrepareAttributesForMorphTargetsInfluencers(d,f,m)),kf(a,this._scene,l),i&&(l.push("#define INSTANCES"),fe.PushAttributesForInstances(d),t.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const v of this.customShaderOptions.defines)-1===l.indexOf(v)&&l.push(v);const T=l.join("\n");if(h!==T){h=T;let v="shadowMap";const A=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],S=["diffuseSampler","boneSampler","morphTargets"],x=["Scene","Mesh"];if(Sl(A),this.customShaderOptions){if(v=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const R of this.customShaderOptions.attributes)-1===d.indexOf(R)&&d.push(R);if(this.customShaderOptions.uniforms)for(const R of this.customShaderOptions.uniforms)-1===A.indexOf(R)&&A.push(R);if(this.customShaderOptions.samplers)for(const R of this.customShaderOptions.samplers)-1===S.indexOf(R)&&S.push(R)}const C=this._scene.getEngine();u=C.createEffect(v,{attributes:d,uniformsNames:A,uniformBuffersNames:x,samplers:S,defines:T,fallbacks:g,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:m}},C),c.setEffect(u,h)}if(!u.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(t,i){const s=this._light;!this._scene.shadowsEnabled||!s.shadowEnabled||(t["SHADOW"+i]=!0,this.useContactHardeningShadow?(t["SHADOWPCSS"+i]=!0,this._filteringQuality===r.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===r.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePercentageCloserFiltering?(t["SHADOWPCF"+i]=!0,this._filteringQuality===r.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===r.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePoissonSampling?t["SHADOWPOISSON"+i]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t["SHADOWESM"+i]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t["SHADOWCLOSEESM"+i]=!0),s.needCube()&&(t["SHADOWCUBE"+i]=!0))}bindShadowLight(t,i){const n=this._light;if(!this._scene.shadowsEnabled||!n.shadowEnabled)return;const a=this._getCamera();if(!a)return;const o=this.getShadowMap();!o||(n.needCube()||i.setMatrix("lightMatrix"+t,this.getTransformMatrix()),this._filter===r.FILTER_PCF?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o.getSize().width,1/o.getSize().width,this.frustumEdgeFalloff,t)):this._filter===r.FILTER_PCSS?(i.setDepthStencilTexture("shadowSampler"+t,this.getShadowMapForRendering()),i.setTexture("depthSampler"+t,this.getShadowMapForRendering()),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o.getSize().width,this._contactHardeningLightSizeUVRatio*o.getSize().width,this.frustumEdgeFalloff,t)):(i.setTexture("shadowSampler"+t,this.getShadowMapForRendering()),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/o.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),n._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(a),this.getLight().getDepthMinZ(a)+this.getLight().getDepthMaxZ(a),t))}getTransformMatrix(){const t=this._scene;if(this._currentRenderId===t.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=t.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let i=this._light.position;if(this._light.computeTransformedInformation()&&(i=this._light.transformedPosition),E.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(E.Dot(this._lightDirection,E.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!i.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(i),this._cachedDirection.copyFrom(this._lightDirection),B.LookAtLHToRef(i,i.add(this._lightDirection),E.Up(),this._viewMatrix);const n=this.getShadowMap();if(n){const s=n.renderList;s&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,s)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const t=this._shadowMap;if(!t)return;const i=t.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),i){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const n of i)this._shadowMap.renderList.push(n)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const t=this._light._shadowGenerators.entries();for(let i=t.next();!0!==i.done;i=t.next()){const[n,s]=i.value;s===this&&this._light._shadowGenerators.delete(n)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var t;const i={},n=this.getShadowMap();if(!n)return i;if(i.className=this.getClassName(),i.lightId=this._light.id,i.cameraId=null===(t=this._camera)||void 0===t?void 0:t.id,i.id=this.id,i.mapSize=n.getRenderSize(),i.forceBackFacesOnly=this.forceBackFacesOnly,i.darkness=this.getDarkness(),i.transparencyShadow=this._transparencyShadow,i.frustumEdgeFalloff=this.frustumEdgeFalloff,i.bias=this.bias,i.normalBias=this.normalBias,i.usePercentageCloserFiltering=this.usePercentageCloserFiltering,i.useContactHardeningShadow=this.useContactHardeningShadow,i.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,i.filteringQuality=this.filteringQuality,i.useExponentialShadowMap=this.useExponentialShadowMap,i.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,i.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,i.usePoissonSampling=this.usePoissonSampling,i.depthScale=this.depthScale,i.blurBoxOffset=this.blurBoxOffset,i.blurKernel=this.blurKernel,i.blurScale=this.blurScale,i.useKernelBlur=this.useKernelBlur,i.renderList=[],n.renderList)for(let s=0;s<n.renderList.length;s++)i.renderList.push(n.renderList[s].id);return i}static Parse(t,i,n){const s=i.getLightById(t.lightId),a=void 0!==t.cameraId?i.getCameraById(t.cameraId):null,o=n?n(t.mapSize,s,a):new r(t.mapSize,s,void 0,a),l=o.getShadowMap();for(let c=0;c<t.renderList.length;c++)i.getMeshesById(t.renderList[c]).forEach(function(h){!l||(l.renderList||(l.renderList=[]),l.renderList.push(h))});return void 0!==t.id&&(o.id=t.id),o.forceBackFacesOnly=!!t.forceBackFacesOnly,void 0!==t.darkness&&o.setDarkness(t.darkness),t.transparencyShadow&&o.setTransparencyShadow(!0),void 0!==t.frustumEdgeFalloff&&(o.frustumEdgeFalloff=t.frustumEdgeFalloff),void 0!==t.bias&&(o.bias=t.bias),void 0!==t.normalBias&&(o.normalBias=t.normalBias),t.usePercentageCloserFiltering?o.usePercentageCloserFiltering=!0:t.useContactHardeningShadow?o.useContactHardeningShadow=!0:t.usePoissonSampling?o.usePoissonSampling=!0:t.useExponentialShadowMap?o.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?o.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?o.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?o.useBlurCloseExponentialShadowMap=!0:t.useVarianceShadowMap?o.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(o.useBlurExponentialShadowMap=!0),void 0!==t.contactHardeningLightSizeUVRatio&&(o.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio),void 0!==t.filteringQuality&&(o.filteringQuality=t.filteringQuality),t.depthScale&&(o.depthScale=t.depthScale),t.blurScale&&(o.blurScale=t.blurScale),t.blurBoxOffset&&(o.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(o.useKernelBlur=t.useKernelBlur),t.blurKernel&&(o.blurKernel=t.blurKernel),o}}return r.CLASSNAME="ShadowGenerator",r.FILTER_NONE=0,r.FILTER_EXPONENTIALSHADOWMAP=1,r.FILTER_POISSONSAMPLING=2,r.FILTER_BLUREXPONENTIALSHADOWMAP=3,r.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,r.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,r.FILTER_PCF=6,r.FILTER_PCSS=7,r.QUALITY_HIGH=0,r.QUALITY_MEDIUM=1,r.QUALITY_LOW=2,r.DEFAULT_ALPHA_CUTOFF=.5,r._SceneComponentInitialization=e=>{throw ht("ShadowGeneratorSceneComponent")},r})();class eo{constructor(e,t,i){this.vectors=mn.BuildArray(8,E.Zero),this.center=E.Zero(),this.centerWorld=E.Zero(),this.extendSize=E.Zero(),this.extendSizeWorld=E.Zero(),this.directions=mn.BuildArray(3,E.Zero),this.vectorsWorld=mn.BuildArray(8,E.Zero),this.minimumWorld=E.Zero(),this.maximumWorld=E.Zero(),this.minimum=E.Zero(),this.maximum=E.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const n=e.x,s=e.y,a=e.z,o=t.x,l=t.y,c=t.z,u=this.vectors;this.minimum.copyFromFloats(n,s,a),this.maximum.copyFromFloats(o,l,c),u[0].copyFromFloats(n,s,a),u[1].copyFromFloats(o,l,c),u[2].copyFromFloats(o,s,a),u[3].copyFromFloats(n,l,a),u[4].copyFromFloats(n,s,c),u[5].copyFromFloats(o,l,a),u[6].copyFromFloats(n,l,c),u[7].copyFromFloats(o,s,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||B.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=eo._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),n=i.length();i.normalizeFromLength(n);const a=i.scaleInPlace(n*e*.5),o=this.center.subtractToRef(a,t[1]),l=this.center.addToRef(a,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,n=this.directions,s=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)s[o].copyFrom(a[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){const l=s[o];E.TransformCoordinatesToRef(a[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}E.FromArrayToRef(e.m,0,n[0]),E.FromArrayToRef(e.m,4,n[1]),E.FromArrayToRef(e.m,8,n[2]),this._worldMatrix=e}isInFrustum(e){return eo.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return eo.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,u=e.x,h=e.y,d=e.z,f=-kt;return!(i.x-u<f||f>u-t.x||i.y-h<f||f>h-t.y||i.z-d<f||f>d-t.z)}intersectsSphere(e){return eo.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,n=this.maximumWorld;return!(n.x<e.x||i.x>t.x||n.y<e.y||i.y>t.y||n.z<e.z||i.z>t.z)}dispose(){var e,t;null===(e=this._drawWrapperFront)||void 0===e||e.dispose(),null===(t=this._drawWrapperBack)||void 0===t||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,n){const s=eo._TmpVector3[0];return E.ClampToRef(i,e,t,s),E.DistanceSquared(i,s)<=n*n}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const n=t[i];for(let s=0;s<8;++s)if(n.dotCoordinate(e[s])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let n=!0;const s=t[i];for(let a=0;a<8;++a)if(s.dotCoordinate(e[a])>=0){n=!1;break}if(n)return!1}return!0}}eo._TmpVector3=mn.BuildArray(3,E.Zero);class Al{constructor(e,t,i){this.center=E.Zero(),this.centerWorld=E.Zero(),this.minimum=E.Zero(),this.maximum=E.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const n=E.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*n,this._update(i||B.IdentityReadOnly)}scale(e){const i=Al._TmpVector3,n=i[0].setAll(this.radius*e),s=this.center.subtractToRef(n,i[1]),a=this.center.addToRef(n,i[2]);return this.reConstruct(s,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{E.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=Al._TmpVector3[0];E.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let n=0;n<6;n++)if(e[n].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=E.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=E.DistanceSquared(e.centerWorld,t.centerWorld),n=e.radiusWorld+t.radiusWorld;return!(n*n<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const n=new Al(this._TmpVector3[0],this._TmpVector3[2]);return n._worldMatrix=i||B.Identity(),n}}Al._TmpVector3=mn.BuildArray(3,E.Zero);const pT={min:0,max:0},gT={min:0,max:0},VI=(r,e,t)=>{const i=E.Dot(e.centerWorld,r),o=Math.abs(E.Dot(e.directions[0],r))*e.extendSize.x+Math.abs(E.Dot(e.directions[1],r))*e.extendSize.y+Math.abs(E.Dot(e.directions[2],r))*e.extendSize.z;t.min=i-o,t.max=i+o},Dr=(r,e,t)=>(VI(r,e,pT),VI(r,t,gT),!(pT.min>gT.max||gT.min>pT.max));class Xr{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new eo(e,t,i),this.boundingSphere=new Al(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Xr._TmpVector3[0].copyFrom(e).subtractInPlace(t),n=Xr._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,n,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,n,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=E.Minimize(this.minimum,e),i=E.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=z.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=z.Vector3[0];return E.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),E.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(1===t||3===t||this.boundingBox.isInFrustum(e))}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Xr._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Al.Intersects(this.boundingSphere,e.boundingSphere)||!eo.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,n=e.boundingBox;return!!(Dr(i.directions[0],i,n)&&Dr(i.directions[1],i,n)&&Dr(i.directions[2],i,n)&&Dr(n.directions[0],i,n)&&Dr(n.directions[1],i,n)&&Dr(n.directions[2],i,n)&&Dr(E.Cross(i.directions[0],n.directions[0]),i,n)&&Dr(E.Cross(i.directions[0],n.directions[1]),i,n)&&Dr(E.Cross(i.directions[0],n.directions[2]),i,n)&&Dr(E.Cross(i.directions[1],n.directions[0]),i,n)&&Dr(E.Cross(i.directions[1],n.directions[1]),i,n)&&Dr(E.Cross(i.directions[1],n.directions[2]),i,n)&&Dr(E.Cross(i.directions[2],n.directions[0]),i,n)&&Dr(E.Cross(i.directions[2],n.directions[1]),i,n)&&Dr(E.Cross(i.directions[2],n.directions[2]),i,n))}}Xr._TmpVector3=mn.BuildArray(2,E.Zero);Z.ShadersStore.depthPixelShader="#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";Z.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute vec4 previousWorld0;\nattribute vec4 previousWorld1;\nattribute vec4 previousWorld2;\nattribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform mat4 previousWorld;\n#endif\n#endif\n";Z.ShadersStore.depthVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nuniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;\nvarying vec4 vViewPos;\n#endif\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";let nW=(()=>{class r{setMaterialForRendering(t,i){this._depthMap.setMaterialForRendering(t,i)}constructor(t,i=1,n=null,s=!1,a=j.TRILINEAR_SAMPLINGMODE,o=!1,l){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=t,this._storeNonLinearDepth=s,this._storeCameraSpaceZ=o,this.isPacked=0===i,this.clearColor=this.isPacked?new ct(1,1,1,1):new ct(o?1e8:1,0,0,1),r._SceneComponentInitialization(this._scene);const c=t.getEngine();this._camera=n,a!==j.NEAREST_SAMPLINGMODE&&(1===i&&!c._caps.textureFloatLinearFiltering&&(a=j.NEAREST_SAMPLINGMODE),2===i&&!c._caps.textureHalfFloatLinearFiltering&&(a=j.NEAREST_SAMPLINGMODE));const u=this.isPacked||!c._features.supportExtendedTextureFormats?5:6;this._depthMap=new ir(null!=l?l:"DepthRenderer",{width:c.getRenderWidth(),height:c.getRenderHeight()},this._scene,!1,!0,i,!1,a,void 0,void 0,void 0,u),this._depthMap.wrapU=j.CLAMP_ADDRESSMODE,this._depthMap.wrapV=j.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(d=>{d.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var d;null===(d=c._debugPushGroup)||void 0===d||d.call(c,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var d;null===(d=c._debugPopGroup)||void 0===d||d.call(c,1)}),this._depthMap.customIsReadyFunction=(d,f,p)=>{if((p||0===f)&&d.subMeshes)for(let g=0;g<d.subMeshes.length;++g){const _=d.subMeshes[g],m=_.getRenderingMesh(),T=m._getInstancesRenderList(_._id,!!_.getReplacementMesh()),v=c.getCaps().instancedArrays&&(null!=T.visibleInstances[_._id]||m.hasThinInstances);if(!this.isReady(_,v))return!1}return!0};const h=d=>{var f,p;const g=d.getRenderingMesh(),_=d.getEffectiveMesh(),m=this._scene,T=m.getEngine(),v=d.getMaterial();if(_._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!v||_.infiniteDistance||v.disableDepthWrite||0===d.verticesCount||d._renderId===m.getRenderId())return;const A=_._getWorldMatrixDeterminant()<0;let S=null!==(f=g.overrideMaterialSideOrientation)&&void 0!==f?f:v.sideOrientation;A&&(S=0===S?1:0),T.setState(v.backFaceCulling,0,!1,0===S,this.reverseCulling?!v.cullBackFaces:v.cullBackFaces);const C=g._getInstancesRenderList(d._id,!!d.getReplacementMesh());if(C.mustReturn)return;const R=T.getCaps().instancedArrays&&(null!=C.visibleInstances[d._id]||g.hasThinInstances),D=this._camera||m.activeCamera;if(this.isReady(d,R)&&D){d._renderId=m.getRenderId();const P=null===(p=_._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===p?void 0:p[T.currentRenderPassId];let N=d._getDrawWrapper();!N&&P&&(N=P._getDrawWrapper());const k=D.mode===it.ORTHOGRAPHIC_CAMERA;if(!N)return;const X=N.effect;let ne,ge;if(T.enableEffect(N),R||g._bind(d,X,v.fillMode),P?P.bindForSubMesh(_.getWorldMatrix(),_,d):(X.setMatrix("viewProjection",m.getTransformMatrix()),X.setMatrix("world",_.getWorldMatrix()),this._storeCameraSpaceZ&&X.setMatrix("view",m.getViewMatrix())),k?(ne=!T.useReverseDepthBuffer&&T.isNDCHalfZRange?0:1,ge=T.useReverseDepthBuffer&&T.isNDCHalfZRange?0:1):(ne=T.useReverseDepthBuffer&&T.isNDCHalfZRange?D.minZ:T.isNDCHalfZRange?0:D.minZ,ge=T.useReverseDepthBuffer&&T.isNDCHalfZRange?0:D.maxZ),X.setFloat2("depthValues",ne,ne+ge),!P){if(v.needAlphaTesting()){const ue=v.getAlphaTestTexture();ue&&(X.setTexture("diffuseSampler",ue),X.setMatrix("diffuseMatrix",ue.getTextureMatrix()))}if(g.useBones&&g.computeBonesUsingShaders&&g.skeleton){const ue=g.skeleton;if(ue.isUsingTextureForMatrices){const ke=ue.getTransformMatrixTexture(g);if(!ke)return;X.setTexture("boneSampler",ke),X.setFloat("boneTextureWidth",4*(ue.bones.length+1))}else X.setMatrices("mBones",ue.getTransformMatrices(g))}Uo(X,v,m),fe.BindMorphTargetParameters(g,X),g.morphTargetManager&&g.morphTargetManager.isUsingTextureForTargets&&g.morphTargetManager._bind(X)}g._processRendering(_,d,X,v.fillMode,C,R,(ue,ke)=>X.setMatrix("world",ke))}};this._depthMap.customRenderFunction=(d,f,p,g)=>{let _;if(g.length)for(_=0;_<g.length;_++)h(g.data[_]);for(_=0;_<d.length;_++)h(d.data[_]);for(_=0;_<f.length;_++)h(f.data[_]);if(this.forceDepthWriteTransparentMeshes)for(_=0;_<p.length;_++)h(p.data[_]);else for(_=0;_<p.length;_++)p.data[_].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(t,i){var n;const s=this._scene.getEngine(),a=t.getMesh(),o=a.getScene(),l=null===(n=a._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===n?void 0:n[s.currentRenderPassId];if(l)return l.isReadyForSubMesh(a,t,i);const c=t.getMaterial();if(!c||c.disableDepthWrite)return!1;const u=[],h=[I.PositionKind];if(c&&c.needAlphaTesting()&&c.getAlphaTestTexture()&&(u.push("#define ALPHATEST"),a.isVerticesDataPresent(I.UVKind)&&(h.push(I.UVKind),u.push("#define UV1")),a.isVerticesDataPresent(I.UV2Kind)&&(h.push(I.UV2Kind),u.push("#define UV2"))),a.useBones&&a.computeBonesUsingShaders){h.push(I.MatricesIndicesKind),h.push(I.MatricesWeightsKind),a.numBoneInfluencers>4&&(h.push(I.MatricesIndicesExtraKind),h.push(I.MatricesWeightsExtraKind)),u.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),u.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0));const m=t.getRenderingMesh().skeleton;(null==m?void 0:m.isUsingTextureForMatrices)&&u.push("#define BONETEXTURE")}else u.push("#define NUM_BONE_INFLUENCERS 0");const d=a.morphTargetManager;let f=0;d&&d.numInfluencers>0&&(f=d.numInfluencers,u.push("#define MORPHTARGETS"),u.push("#define NUM_MORPH_INFLUENCERS "+f),d.isUsingTextureForTargets&&u.push("#define MORPHTARGETS_TEXTURE"),fe.PrepareAttributesForMorphTargetsInfluencers(h,a,f)),i&&(u.push("#define INSTANCES"),fe.PushAttributesForInstances(h),t.getRenderingMesh().hasThinInstances&&u.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&u.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&u.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&u.push("#define PACKED"),kf(c,o,u);const p=t._getDrawWrapper(void 0,!0),g=p.defines,_=u.join("\n");if(g!==_){const m=["world","mBones","boneTextureWidth","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Sl(m),p.setEffect(s.createEffect("depth",h,m,["diffuseSampler","morphTargets","boneSampler"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:f}),_)}return p.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const t=[];for(const i in this._scene._depthRenderer)this._scene._depthRenderer[i]===this&&t.push(i);if(t.length>0){this._depthMap.dispose();for(const i of t)delete this._scene._depthRenderer[i]}}}return r._SceneComponentInitialization=e=>{throw ht("DepthRendererSceneComponent")},r})();Z.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nfloat f1=texelFetch(sourceTexture,coord,0).r;\nfloat f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;\nfloat f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;\nfloat f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;\nfloat minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(MAIN)\nuniform vec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*(texSize-1.0));\nvec2 f1=texelFetch(textureSampler,coord,0).rg;\nvec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;\nvec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;\nvec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;\nfloat minz=min(min(min(f1.x,f2.x),f3.x),f4.x);\nfloat maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;\nvoid main(void)\n{\nivec2 coord=ivec2(vUV*vec2(texSize-1));\nvec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;\nvec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;\nvec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;\nvec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;\nfloat minz=min(f1.x,f2.x);\nfloat maxz=max(f1.y,f2.y);\nglFragColor=vec4(minz,maxz,0.,0.);\n}\n#elif defined(LAST)\nvoid main(void)\n{\nglFragColor=vec4(0.);\nif (true) { \ndiscard;\n}\n}\n#endif\n";class sW extends class rW{constructor(e){this.onAfterReductionPerformed=new J,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new Lf(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,n=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=n;const s=this._camera.getScene(),a=new li("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);a.autoClear=!1,a.forceFullscreenViewport=n;let o=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();a.onApply=((u,h)=>d=>{d.setTexture("sourceTexture",this._sourceTexture),d.setFloat2("texSize",u,h)})(o,l),this._reductionSteps.push(a);let c=1;for(;o>1||l>1;){o=Math.max(Math.round(o/2),1),l=Math.max(Math.round(l/2),1);const u=new li("Reduction phase "+c,"minmaxRedux",["texSize"],null,{width:o,height:l},null,1,s.getEngine(),!1,"#define "+(1==o&&1==l?"LAST":1==o||1==l?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);u.autoClear=!1,u.forceFullscreenViewport=n,u.onApply=((h,d)=>f=>{1==h||1==d?f.setInt2("texSize",h,d):f.setFloat2("texSize",h,d)})(o,l),this._reductionSteps.push(u),c++,1==o&&1==l&&u.onAfterRenderObservable.add(((d,f,p)=>{const g=new Float32Array(4*d*f),_={min:0,max:0};return()=>{s.getEngine()._readTexturePixels(p.inputTexture.texture,d,f,-1,0,g,!1),_.min=g[0],_.max=g[1],this.onAfterReductionPerformed.notifyObservers(_)}})(o,l,u))}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var e,t;const i=this._camera.getScene().getEngine();null===(e=i._debugPushGroup)||void 0===e||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),null===(t=i._debugPopGroup)||void 0===t||t.call(i,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const n=this._camera.getScene();this._depthRenderer&&(delete n._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(n._depthRenderer||(n._depthRenderer={}),(e=this._depthRenderer=new nW(n,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,n._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,n=!0){super.setSourceTexture(e,t,i,n)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const $I=E.Up(),aW=E.Zero(),un=new E,Uc=new E,Gf=new B;class Cn extends fr{_validateFilter(e){return e===fr.FILTER_NONE||e===fr.FILTER_PCF||e===fr.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),fr.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,Cn.MIN_CASCADES_COUNT),Cn.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){const n=e[i];if(!n)continue;const a=n.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(a.minimumWorld),this._scbiMax.maximizeInPlace(a.maximumWorld)}const t=this._scene.meshes;for(let i=0;i<t.length;i++){const n=t[i];if(!(n&&n.isVisible&&n.isEnabled&&n.receiveShadows))continue;const a=n.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(a.minimumWorld),this._scbiMax.maximizeInPlace(a.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Cn.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new sW(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let n=i.min,s=i.max;n>=s&&(n=0,s=1),(n!=this._minDistance||s!=this._maxDistance)&&this.setMinMaxDistance(n,s)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return null!==(i=null===(t=null===(e=this._depthReducer)||void 0===e?void 0:e.depthRenderer)||void 0===t?void 0:t.getDepthMap().refreshRate)&&void 0!==i?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;(null===(t=this._depthReducer)||void 0===t?void 0:t.depthRenderer)&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ,n=i-t,s=this._minDistance,o=t+s*n,l=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*n,c=l-o,u=l/o;for(let h=0;h<this._cascades.length;++h){const d=(h+1)/this._numCascades,p=o+c*d,g=this._lambda*(o*u**d-p)+p;this._cascades[h].prevBreakDistance=0===h?s:this._cascades[h-1].breakDistance,this._cascades[h].breakDistance=(g-t)/n,this._viewSpaceFrustumsZ[h]=g,this._frustumLengths[h]=(this._cascades[h].breakDistance-this._cascades[h].prevBreakDistance)*n}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;E.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(E.Dot(this._lightDirection,E.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const i=e.getEngine().useReverseDepthBuffer;for(let n=0;n<this._numCascades;++n){this._computeFrustumInWorldSpace(n),this._computeCascadeFrustum(n),this._cascadeMaxExtents[n].subtractToRef(this._cascadeMinExtents[n],un),this._frustumCenter[n].addToRef(this._lightDirection.scale(this._cascadeMinExtents[n].z),this._shadowCameraPos[n]),B.LookAtLHToRef(this._shadowCameraPos[n],this._frustumCenter[n],$I,this._viewMatrices[n]);let s=0,a=un.z;const o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[n]),a=Math.min(a,o.boundingBox.maximumWorld.z),s=this._depthClamp&&this.filter!==fr.FILTER_PCSS?Math.max(s,o.boundingBox.minimumWorld.z):Math.min(s,o.boundingBox.minimumWorld.z),B.OrthoOffCenterLHToRef(this._cascadeMinExtents[n].x,this._cascadeMaxExtents[n].x,this._cascadeMinExtents[n].y,this._cascadeMaxExtents[n].y,i?a:s,i?s:a,this._projectionMatrices[n],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[n].z=s,this._cascadeMaxExtents[n].z=a,this._viewMatrices[n].multiplyToRef(this._projectionMatrices[n],this._transformMatrices[n]),E.TransformCoordinatesToRef(aW,this._transformMatrices[n],un),un.scaleInPlace(this._mapSize/2),Uc.copyFromFloats(Math.round(un.x),Math.round(un.y),Math.round(un.z)),Uc.subtractInPlace(un).scaleInPlace(2/this._mapSize),B.TranslationToRef(Uc.x,Uc.y,0,Gf),this._projectionMatrices[n].multiplyToRef(Gf,this._projectionMatrices[n]),this._viewMatrices[n].multiplyToRef(this._projectionMatrices[n],this._transformMatrices[n]),this._transformMatrices[n].copyToArray(this._transformMatricesAsArray,16*n)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,n=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const a=B.Invert(t.getTransformationMatrix()),o=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let l=0;l<Cn._FrustumCornersNDCSpace.length;++l)un.copyFrom(Cn._FrustumCornersNDCSpace[(l+o)%Cn._FrustumCornersNDCSpace.length]),s&&-1===un.z&&(un.z=0),E.TransformCoordinatesToRef(un,a,this._frustumCornersWorldSpace[e][l]);for(let l=0;l<Cn._FrustumCornersNDCSpace.length/2;++l)un.copyFrom(this._frustumCornersWorldSpace[e][l+4]).subtractInPlace(this._frustumCornersWorldSpace[e][l]),Uc.copyFrom(un).scaleInPlace(i),un.scaleInPlace(n),un.addInPlace(this._frustumCornersWorldSpace[e][l]),this._frustumCornersWorldSpace[e][l+4].copyFrom(un),this._frustumCornersWorldSpace[e][l].addInPlace(Uc)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let n=0;n<this._frustumCornersWorldSpace[e].length;++n){const s=this._frustumCornersWorldSpace[e][n].subtractToRef(this._frustumCenter[e],un).length();i=Math.max(i,s)}i=Math.ceil(16*i)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{const i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,un),B.LookAtLHToRef(i,un,$I,Gf);for(let n=0;n<this._frustumCornersWorldSpace[e].length;++n)E.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][n],Gf,un),this._cascadeMinExtents[e].minimizeInPlace(un),this._cascadeMaxExtents[e].maximizeInPlace(un)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=Je.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,n){Cn.IsSupported?(super(e,t,i,n),this.usePercentageCloserFiltering=!0):H.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){var e,t,i,n,s,a,o,l,c,u,h,d,f,p,g,_,m,T,v,A;this.penumbraDarkness=null!==(e=this.penumbraDarkness)&&void 0!==e?e:1,this._numCascades=null!==(t=this._numCascades)&&void 0!==t?t:Cn.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(i=this.stabilizeCascades)&&void 0!==i&&i,this._freezeShadowCastersBoundingInfoObservable=null!==(n=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==n?n:null,this.freezeShadowCastersBoundingInfo=null!==(s=this.freezeShadowCastersBoundingInfo)&&void 0!==s&&s,this._scbiMin=null!==(a=this._scbiMin)&&void 0!==a?a:new E(0,0,0),this._scbiMax=null!==(o=this._scbiMax)&&void 0!==o?o:new E(0,0,0),this._shadowCastersBoundingInfo=null!==(l=this._shadowCastersBoundingInfo)&&void 0!==l?l:new Xr(new E(0,0,0),new E(0,0,0)),this._breaksAreDirty=null===(c=this._breaksAreDirty)||void 0===c||c,this._minDistance=null!==(u=this._minDistance)&&void 0!==u?u:0,this._maxDistance=null!==(h=this._maxDistance)&&void 0!==h?h:1,this._currentLayer=null!==(d=this._currentLayer)&&void 0!==d?d:0,this._shadowMaxZ=null!==(g=null!==(f=this._shadowMaxZ)&&void 0!==f?f:null===(p=this._getCamera())||void 0===p?void 0:p.maxZ)&&void 0!==g?g:1e4,this._debug=null!==(_=this._debug)&&void 0!==_&&_,this._depthClamp=null===(m=this._depthClamp)||void 0===m||m,this._cascadeBlendPercentage=null!==(T=this._cascadeBlendPercentage)&&void 0!==T?T:.1,this._lambda=null!==(v=this._lambda)&&void 0!==v?v:.5,this._autoCalcDepthBounds=null!==(A=this._autoCalcDepthBounds)&&void 0!==A&&A,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine();this._shadowMap=new ir(this._light.name+"_CSMShadowMap",{width:this._mapSize,height:this._mapSize,layers:this.numCascades},this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=B.Zero(),this._projectionMatrices[t]=B.Zero(),this._transformMatrices[t]=B.Zero(),this._cascadeMinExtents[t]=new E,this._cascadeMaxExtents[t]=new E,this._frustumCenter[t]=new E,this._shadowCameraPos[t]=new E,this._frustumCornersWorldSpace[t]=new Array(Cn._FrustumCornersNDCSpace.length);for(let i=0;i<Cn._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new E}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===fr.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==fr.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene;if(!i.shadowsEnabled||!this._light.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const s=this._getCamera();s&&this._shadowMaxZ<s.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const a=this.getShadowMap();if(!a)return;const o=a.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===fr.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);else if(this._filter===fr.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[2*l+0]=0===l?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[2*l+1]=0===l?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=0===l?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,a),t.setTexture("depthSampler"+e,a),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o,this._contactHardeningLightSizeUVRatio*o,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++)e.renderList.push(t.renderList[i].id);return e}static Parse(e,t){const i=fr.Parse(e,t,(n,s,a)=>new Cn(n,s,void 0,a));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Cn._FrustumCornersNDCSpace=[new E(-1,1,-1),new E(1,1,-1),new E(1,-1,-1),new E(-1,-1,-1),new E(-1,1,1),new E(1,1,1),new E(1,-1,1),new E(-1,-1,1)],Cn.CLASSNAME="CascadedShadowGenerator",Cn.DEFAULT_CASCADES_COUNT=4,Cn.MIN_CASCADES_COUNT=2,Cn.MAX_CASCADES_COUNT=4,Cn._SceneComponentInitialization=r=>{throw ht("ShadowGeneratorSceneComponent")},cs.AddParser(Bi.NAME_SHADOWGENERATOR,(r,e)=>{if(null!=r.shadowGenerators)for(let t=0,i=r.shadowGenerators.length;t<i;t++){const n=r.shadowGenerators[t];n.className===Cn.CLASSNAME?Cn.Parse(n,e):fr.Parse(n,e)}});class oW{constructor(e){this.name=Bi.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Bi.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const n=i.getShadowGenerators();if(n){const s=n.values();for(let a=s.next();!0!==a.done;a=s.next())e.shadowGenerators.push(a.value.serialize())}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const n=t.lights[i],s=n.getShadowGenerators();if(n.isEnabled()&&n.shadowEnabled&&s){const a=s.values();for(let o=a.next();!0!==o.done;o=a.next()){const c=o.value.getShadowMap();-1!==t.textures.indexOf(c)&&e.push(c)}}}}}fr._SceneComponentInitialization=r=>{let e=r._getComponent(Bi.NAME_SHADOWGENERATOR);e||(e=new oW(r),r._addComponent(e))},$i.AddNodeConstructor("Light_Type_1",(r,e)=>()=>new to(r,E.Zero(),e));class to extends vl{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return Rt.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;!t||B.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const u=E.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let h=Number.MAX_VALUE,d=Number.MIN_VALUE;for(let f=0;f<i.length;f++){const p=i[f];if(!p)continue;const _=p.getBoundingInfo().boundingBox;for(let m=0;m<_.vectorsWorld.length;m++)E.TransformCoordinatesToRef(_.vectorsWorld[m],t,u),u.x<this._orthoLeft&&(this._orthoLeft=u.x),u.y<this._orthoBottom&&(this._orthoBottom=u.y),u.x>this._orthoRight&&(this._orthoRight=u.x),u.y>this._orthoTop&&(this._orthoTop=u.y),this.autoCalcShadowZBounds&&(u.z<h&&(h=u.z),u.z>d&&(d=u.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=h,this._shadowMaxZ=d)}const s=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=void 0!==this.shadowMinZ?this.shadowMinZ:n.minZ,l=void 0!==this.shadowMaxZ?this.shadowMaxZ:n.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;B.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}b([O()],to.prototype,"shadowFrustumSize",null),b([O()],to.prototype,"shadowOrthoScale",null),b([O()],to.prototype,"autoUpdateExtends",void 0),b([O()],to.prototype,"autoCalcShadowZBounds",void 0),b([O("orthoLeft")],to.prototype,"_orthoLeft",void 0),b([O("orthoRight")],to.prototype,"_orthoRight",void 0),b([O("orthoTop")],to.prototype,"_orthoTop",void 0),b([O("orthoBottom")],to.prototype,"_orthoBottom",void 0),$i.AddNodeConstructor("Light_Type_3",(r,e)=>()=>new _T(r,E.Zero(),e));class _T extends Rt{constructor(e,t,i){super(e,i),this.groundColor=new Fe(0,0,0),this.direction=t||E.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=E.Normalize(e.subtract(E.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=E.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=E.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=B.Identity()),this._worldMatrix}getTypeID(){return Rt.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}b([cn()],_T.prototype,"groundColor",void 0),b([Mr()],_T.prototype,"direction",void 0),$i.AddNodeConstructor("Light_Type_0",(r,e)=>()=>new mT(r,E.Zero(),e));class mT extends vl{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let n=i.next();!0!==n.done;n=i.next())n.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Rt.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new E(1,0,0);case 1:return new E(-1,0,0);case 2:return new E(0,-1,0);case 3:return new E(0,1,0);case 4:return new E(0,0,1);case 5:return new E(0,0,-1)}return E.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;const s=void 0!==this.shadowMinZ?this.shadowMinZ:n.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:n.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;B.PerspectiveFovLHToRef(this.shadowAngle,1,o?a:s,o?s:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}b([O()],mT.prototype,"shadowAngle",null),$i.AddNodeConstructor("Light_Type_2",(r,e)=>()=>new hs(r,E.Zero(),E.Zero(),0,0,e));class hs extends vl{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(hs._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):hs._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,n,s,a){super(e,a),this._innerAngle=0,this._projectionTextureMatrix=B.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=E.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=E.Zero(),this._projectionTextureViewLightMatrix=B.Zero(),this._projectionTextureProjectionLightMatrix=B.Zero(),this._projectionTextureScalingMatrix=B.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=n,this.exponent=s}getClassName(){return"SpotLight"}getTypeID(){return Rt.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;this._shadowAngleScale=this._shadowAngleScale||1;const s=this._shadowAngleScale*this._angle,a=void 0!==this.shadowMinZ?this.shadowMinZ:n.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:n.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;B.PerspectiveFovLHToRef(s,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),B.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),n=-i*t,s=1/Math.tan(this._angle/2);B.FromValuesToRef(s/1,0,0,0,0,s,0,0,0,0,i,1,0,0,n,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof j&&B.FromValuesToRef(this._projectionTexture.uScale/2,0,0,0,0,this._projectionTexture.vScale/2,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix),this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=E.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=E.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return i=this.computeTransformedInformation()?E.Normalize(this.transformedDirection):E.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady())}}function TT(r,e,t){try{const i=r.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function KI(r,e,t,i,n){const s=()=>{let a;const o=l=>{l.done?t(l.value):void 0===a?a=!0:s()};do{a=void 0,n&&n.aborted?i(new Error("Aborted")):e(r,o,i),void 0===a&&(a=!1)}while(a)};s()}function ET(r,e){let t;return KI(r,TT,i=>t=i,i=>{throw i},e),t}b([O()],hs.prototype,"angle",null),b([O()],hs.prototype,"innerAngle",null),b([O()],hs.prototype,"shadowAngleScale",null),b([O()],hs.prototype,"exponent",void 0),b([O()],hs.prototype,"projectionTextureLightNear",null),b([O()],hs.prototype,"projectionTextureLightFar",null),b([O()],hs.prototype,"projectionTextureUpDirection",null),b([Bt("projectedLightTexture")],hs.prototype,"_projectionTexture",void 0);class be{constructor(){this._applyTo=function cW(r,e){return(...t)=>ET(r(...t),e)}(this._applyToCoroutine.bind(this))}set(e,t){switch(e.length||H.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case I.PositionKind:this.positions=e;break;case I.NormalKind:this.normals=e;break;case I.TangentKind:this.tangents=e;break;case I.UVKind:this.uvs=e;break;case I.UV2Kind:this.uvs2=e;break;case I.UV3Kind:this.uvs3=e;break;case I.UV4Kind:this.uvs4=e;break;case I.UV5Kind:this.uvs5=e;break;case I.UV6Kind:this.uvs6=e;break;case I.ColorKind:this.colors=e;break;case I.MatricesIndicesKind:this.matricesIndices=e;break;case I.MatricesWeightsKind:this.matricesWeights=e;break;case I.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case I.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){return this.positions&&(e.setVerticesData(I.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(I.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(I.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(I.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(I.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(I.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(I.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(I.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(I.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(I.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(I.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(I.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(I.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(I.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),this}_update(e,t,i){return this.positions&&e.updateVerticesData(I.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(I.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(I.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(I.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(I.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(I.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(I.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(I.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(I.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(I.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(I.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(I.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(I.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(I.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,n=e.length){const s=z.Vector3[0],a=z.Vector3[1];for(let o=i;o<i+n;o+=3)E.FromArrayToRef(e,o,s),E.TransformCoordinatesToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,i=0,n=e.length){const s=z.Vector3[0],a=z.Vector3[1];for(let o=i;o<i+n;o+=3)E.FromArrayToRef(e,o,s),E.TransformNormalToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,i=0,n=e.length){const s=z.Vector4[0],a=z.Vector4[1];for(let o=i;o<i+n;o+=4)Qt.FromArrayToRef(e,o,s),Qt.TransformNormalToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,i=e.length){for(let n=t;n<t+i;n+=3){const s=e[n+1];e[n+1]=e[n+2],e[n+2]=s}}transform(e){const t=e.determinant()<0;return this.positions&&be._TransformVector3Coordinates(this.positions,e),this.normals&&be._TransformVector3Normals(this.normals,e),this.tangents&&be._TransformVector4Normals(this.tangents,e),t&&this.indices&&be._FlipFaces(this.indices),this}merge(e,t=!1,i=!1){const n=Array.isArray(e)?e.map(s=>({vertexData:s})):[{vertexData:e}];return ET(this._mergeCoroutine(void 0,n,t,!1,i))}*_mergeCoroutine(e,t,i=!1,n,s){var a,o,l,c;this._validate();const u=t.map(p=>p.vertexData);for(const p of u)if(p._validate(),!this.normals!=!p.normals||!this.tangents!=!p.tangents||!this.uvs!=!p.uvs||!this.uvs2!=!p.uvs2||!this.uvs3!=!p.uvs3||!this.uvs4!=!p.uvs4||!this.uvs5!=!p.uvs5||!this.uvs6!=!p.uvs6||!this.colors!=!p.colors||!this.matricesIndices!=!p.matricesIndices||!this.matricesWeights!=!p.matricesWeights||!this.matricesIndicesExtra!=!p.matricesIndicesExtra||!this.matricesWeightsExtra!=!p.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const h=u.reduce((p,g)=>{var _,m;return p+(null!==(m=null===(_=g.indices)||void 0===_?void 0:_.length)&&void 0!==m?m:0)},null!==(o=null===(a=this.indices)||void 0===a?void 0:a.length)&&void 0!==o?o:0);let f=s||u.some(p=>p.indices===this.indices)?null===(l=this.indices)||void 0===l?void 0:l.slice():this.indices;if(h>0){let p=null!==(c=null==f?void 0:f.length)&&void 0!==c?c:0;if(f||(f=new Array(h)),f.length!==h){if(Array.isArray(f))f.length=h;else{const _=i||f instanceof Uint32Array?new Uint32Array(h):new Uint16Array(h);_.set(f),f=_}e&&e.determinant()<0&&be._FlipFaces(f,0,p)}let g=this.positions?this.positions.length/3:0;for(const{vertexData:_,transform:m}of t)if(_.indices){for(let T=0;T<_.indices.length;T++)f[p+T]=_.indices[T]+g;m&&m.determinant()<0&&be._FlipFaces(f,p,_.indices.length),g+=_.positions.length/3,p+=_.indices.length,n&&(yield)}}return this.indices=f,this.positions=be._MergeElement(I.PositionKind,this.positions,e,t.map(p=>[p.vertexData.positions,p.transform])),n&&(yield),this.normals=be._MergeElement(I.NormalKind,this.normals,e,t.map(p=>[p.vertexData.normals,p.transform])),n&&(yield),this.tangents=be._MergeElement(I.TangentKind,this.tangents,e,t.map(p=>[p.vertexData.tangents,p.transform])),n&&(yield),this.uvs=be._MergeElement(I.UVKind,this.uvs,e,t.map(p=>[p.vertexData.uvs,p.transform])),n&&(yield),this.uvs2=be._MergeElement(I.UV2Kind,this.uvs2,e,t.map(p=>[p.vertexData.uvs2,p.transform])),n&&(yield),this.uvs3=be._MergeElement(I.UV3Kind,this.uvs3,e,t.map(p=>[p.vertexData.uvs3,p.transform])),n&&(yield),this.uvs4=be._MergeElement(I.UV4Kind,this.uvs4,e,t.map(p=>[p.vertexData.uvs4,p.transform])),n&&(yield),this.uvs5=be._MergeElement(I.UV5Kind,this.uvs5,e,t.map(p=>[p.vertexData.uvs5,p.transform])),n&&(yield),this.uvs6=be._MergeElement(I.UV6Kind,this.uvs6,e,t.map(p=>[p.vertexData.uvs6,p.transform])),n&&(yield),this.colors=be._MergeElement(I.ColorKind,this.colors,e,t.map(p=>[p.vertexData.colors,p.transform])),n&&(yield),this.matricesIndices=be._MergeElement(I.MatricesIndicesKind,this.matricesIndices,e,t.map(p=>[p.vertexData.matricesIndices,p.transform])),n&&(yield),this.matricesWeights=be._MergeElement(I.MatricesWeightsKind,this.matricesWeights,e,t.map(p=>[p.vertexData.matricesWeights,p.transform])),n&&(yield),this.matricesIndicesExtra=be._MergeElement(I.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(p=>[p.vertexData.matricesIndicesExtra,p.transform])),n&&(yield),this.matricesWeightsExtra=be._MergeElement(I.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(p=>[p.vertexData.matricesWeightsExtra,p.transform])),this}static _MergeElement(e,t,i,n){const s=n.filter(l=>null!=l[0]);if(!t&&0==s.length)return t;if(!t)return this._MergeElement(e,s[0][0],s[0][1],s.slice(1));const a=s.reduce((l,c)=>l+c[0].length,t.length),o=e===I.PositionKind?be._TransformVector3Coordinates:e===I.NormalKind?be._TransformVector3Normals:e===I.TangentKind?be._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(a);l.set(t),i&&o(l,i,0,t.length);let c=t.length;for(const[u,h]of s)l.set(u,c),h&&o(l,h,c,u.length),c+=u.length;return l}{const l=new Array(a);for(let u=0;u<t.length;u++)l[u]=t[u];i&&o(l,i,0,t.length);let c=t.length;for(const[u,h]of s){for(let d=0;d<u.length;d++)l[c+d]=u[d];h&&o(l,h,c,u.length),c+=u.length}return l}}_validate(){if(!this.positions)throw new xa("Positions are required",0);const e=(n,s)=>{const a=I.DeduceStride(n);if(s.length%a!=0)throw new Error("The "+n+"s array count must be a multiple of "+a);return s.length/a},t=e(I.PositionKind,this.positions),i=(n,s)=>{const a=e(n,s);if(a!==t)throw new Error("The "+n+"s element count ("+a+") does not match the positions count ("+t+")")};this.normals&&i(I.NormalKind,this.normals),this.tangents&&i(I.TangentKind,this.tangents),this.uvs&&i(I.UVKind,this.uvs),this.uvs2&&i(I.UV2Kind,this.uvs2),this.uvs3&&i(I.UV3Kind,this.uvs3),this.uvs4&&i(I.UV4Kind,this.uvs4),this.uvs5&&i(I.UV5Kind,this.uvs5),this.uvs6&&i(I.UV6Kind,this.uvs6),this.colors&&i(I.ColorKind,this.colors),this.matricesIndices&&i(I.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(I.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(I.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(I.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,t,i){return be._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return be._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const n=new be;return e.isVerticesDataPresent(I.PositionKind)&&(n.positions=e.getVerticesData(I.PositionKind,t,i)),e.isVerticesDataPresent(I.NormalKind)&&(n.normals=e.getVerticesData(I.NormalKind,t,i)),e.isVerticesDataPresent(I.TangentKind)&&(n.tangents=e.getVerticesData(I.TangentKind,t,i)),e.isVerticesDataPresent(I.UVKind)&&(n.uvs=e.getVerticesData(I.UVKind,t,i)),e.isVerticesDataPresent(I.UV2Kind)&&(n.uvs2=e.getVerticesData(I.UV2Kind,t,i)),e.isVerticesDataPresent(I.UV3Kind)&&(n.uvs3=e.getVerticesData(I.UV3Kind,t,i)),e.isVerticesDataPresent(I.UV4Kind)&&(n.uvs4=e.getVerticesData(I.UV4Kind,t,i)),e.isVerticesDataPresent(I.UV5Kind)&&(n.uvs5=e.getVerticesData(I.UV5Kind,t,i)),e.isVerticesDataPresent(I.UV6Kind)&&(n.uvs6=e.getVerticesData(I.UV6Kind,t,i)),e.isVerticesDataPresent(I.ColorKind)&&(n.colors=e.getVerticesData(I.ColorKind,t,i)),e.isVerticesDataPresent(I.MatricesIndicesKind)&&(n.matricesIndices=e.getVerticesData(I.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(I.MatricesWeightsKind)&&(n.matricesWeights=e.getVerticesData(I.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(I.MatricesIndicesExtraKind)&&(n.matricesIndicesExtra=e.getVerticesData(I.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(I.MatricesWeightsExtraKind)&&(n.matricesWeightsExtra=e.getVerticesData(I.MatricesWeightsExtraKind,t,i)),n.indices=e.getIndices(t,i),n}static CreateRibbon(e){throw ht("ribbonBuilder")}static CreateBox(e){throw ht("boxBuilder")}static CreateTiledBox(e){throw ht("tiledBoxBuilder")}static CreateTiledPlane(e){throw ht("tiledPlaneBuilder")}static CreateSphere(e){throw ht("sphereBuilder")}static CreateCylinder(e){throw ht("cylinderBuilder")}static CreateTorus(e){throw ht("torusBuilder")}static CreateLineSystem(e){throw ht("linesBuilder")}static CreateDashedLines(e){throw ht("linesBuilder")}static CreateGround(e){throw ht("groundBuilder")}static CreateTiledGround(e){throw ht("groundBuilder")}static CreateGroundFromHeightMap(e){throw ht("groundBuilder")}static CreatePlane(e){throw ht("planeBuilder")}static CreateDisc(e){throw ht("discBuilder")}static CreatePolygon(e,t,i,n,s,a,o){throw ht("polygonBuilder")}static CreateIcoSphere(e){throw ht("icoSphereBuilder")}static CreatePolyhedron(e){throw ht("polyhedronBuilder")}static CreateCapsule(e={orientation:E.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw ht("capsuleBuilder")}static CreateTorusKnot(e){throw ht("torusKnotBuilder")}static ComputeNormals(e,t,i,n){let s=0,a=0,o=0,l=0,c=0,u=0,h=0,d=0,f=0,p=0,g=0,_=0,m=0,T=0,v=0,A=0,S=0,x=0,C=0,R=0,D=!1,P=!1,N=!1,k=!1,X=1,ne=0,ge=null;n&&(D=!!n.facetNormals,P=!!n.facetPositions,N=!!n.facetPartitioning,X=!0===n.useRightHandedSystem?-1:1,ne=n.ratio||0,k=!!n.depthSort,ge=n.distanceTo,k&&void 0===ge&&(ge=E.Zero()));let ue=0,ke=0,me=0,$=0;for(N&&n&&n.bbSize&&(ue=n.subDiv.X*ne/n.bbSize.x,ke=n.subDiv.Y*ne/n.bbSize.y,me=n.subDiv.Z*ne/n.bbSize.z,$=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0),s=0;s<e.length;s++)i[s]=0;const Q=t.length/3|0;for(s=0;s<Q;s++){if(_=3*t[3*s],m=_+1,T=_+2,v=3*t[3*s+1],A=v+1,S=v+2,x=3*t[3*s+2],C=x+1,R=x+2,a=e[_]-e[v],o=e[m]-e[A],l=e[T]-e[S],c=e[x]-e[v],u=e[C]-e[A],h=e[R]-e[S],d=X*(o*h-l*u),f=X*(l*c-a*h),p=X*(a*u-o*c),g=Math.sqrt(d*d+f*f+p*p),g=0===g?1:g,d/=g,f/=g,p/=g,D&&n&&(n.facetNormals[s].x=d,n.facetNormals[s].y=f,n.facetNormals[s].z=p),P&&n&&(n.facetPositions[s].x=(e[_]+e[v]+e[x])/3,n.facetPositions[s].y=(e[m]+e[A]+e[C])/3,n.facetPositions[s].z=(e[T]+e[S]+e[R])/3),N&&n){const w=Math.floor((n.facetPositions[s].x-n.bInfo.minimum.x*ne)*ue),Y=Math.floor((n.facetPositions[s].y-n.bInfo.minimum.y*ne)*ke),se=Math.floor((n.facetPositions[s].z-n.bInfo.minimum.z*ne)*me),Re=Math.floor((e[_]-n.bInfo.minimum.x*ne)*ue),mt=Math.floor((e[m]-n.bInfo.minimum.y*ne)*ke),$e=Math.floor((e[T]-n.bInfo.minimum.z*ne)*me),_e=Math.floor((e[v]-n.bInfo.minimum.x*ne)*ue),Xe=Math.floor((e[A]-n.bInfo.minimum.y*ne)*ke),Xt=Math.floor((e[S]-n.bInfo.minimum.z*ne)*me),ti=Math.floor((e[x]-n.bInfo.minimum.x*ne)*ue),Mt=Math.floor((e[C]-n.bInfo.minimum.y*ne)*ke),qe=Math.floor((e[R]-n.bInfo.minimum.z*ne)*me),qt=Re+n.subDiv.max*mt+$*$e,Ei=_e+n.subDiv.max*Xe+$*Xt,Ci=ti+n.subDiv.max*Mt+$*qe,qi=w+n.subDiv.max*Y+$*se;n.facetPartitioning[qi]=n.facetPartitioning[qi]?n.facetPartitioning[qi]:new Array,n.facetPartitioning[qt]=n.facetPartitioning[qt]?n.facetPartitioning[qt]:new Array,n.facetPartitioning[Ei]=n.facetPartitioning[Ei]?n.facetPartitioning[Ei]:new Array,n.facetPartitioning[Ci]=n.facetPartitioning[Ci]?n.facetPartitioning[Ci]:new Array,n.facetPartitioning[qt].push(s),Ei!=qt&&n.facetPartitioning[Ei].push(s),Ci==Ei||Ci==qt||n.facetPartitioning[Ci].push(s),qi==qt||qi==Ei||qi==Ci||n.facetPartitioning[qi].push(s)}if(k&&n&&n.facetPositions){const w=n.depthSortedFacets[s];w.ind=3*s,w.sqDistance=E.DistanceSquared(n.facetPositions[s],ge)}i[_]+=d,i[m]+=f,i[T]+=p,i[v]+=d,i[A]+=f,i[S]+=p,i[x]+=d,i[C]+=f,i[R]+=p}for(s=0;s<i.length/3;s++)d=i[3*s],f=i[3*s+1],p=i[3*s+2],g=Math.sqrt(d*d+f*f+p*p),g=0===g?1:g,d/=g,f/=g,p/=g,i[3*s]=d,i[3*s+1]=f,i[3*s+2]=p}static _ComputeSides(e,t,i,n,s,a,o){const l=i.length,c=n.length;let u,h;switch(e=e||be.DEFAULTSIDE){case be.FRONTSIDE:break;case be.BACKSIDE:for(u=0;u<l;u+=3){const d=i[u];i[u]=i[u+2],i[u+2]=d}for(h=0;h<c;h++)n[h]=-n[h];break;case be.DOUBLESIDE:{const d=t.length,f=d/3;for(let _=0;_<d;_++)t[d+_]=t[_];for(u=0;u<l;u+=3)i[u+l]=i[u+2]+f,i[u+1+l]=i[u+1]+f,i[u+2+l]=i[u]+f;for(h=0;h<c;h++)n[c+h]=-n[h];const p=s.length;let g=0;for(g=0;g<p;g++)s[g+p]=s[g];for(a=a||new Qt(0,0,1,1),o=o||new Qt(0,0,1,1),g=0,u=0;u<p/2;u++)s[g]=a.x+(a.z-a.x)*s[g],s[g+1]=a.y+(a.w-a.y)*s[g+1],s[g+p]=o.x+(o.z-o.x)*s[g+p],s[g+p+1]=o.y+(o.w-o.y)*s[g+p+1],g+=2;break}}}static ImportVertexData(e,t){const i=new be,n=e.positions;n&&i.set(n,I.PositionKind);const s=e.normals;s&&i.set(s,I.NormalKind);const a=e.tangents;a&&i.set(a,I.TangentKind);const o=e.uvs;o&&i.set(o,I.UVKind);const l=e.uv2s;l&&i.set(l,I.UV2Kind);const c=e.uv3s;c&&i.set(c,I.UV3Kind);const u=e.uv4s;u&&i.set(u,I.UV4Kind);const h=e.uv5s;h&&i.set(h,I.UV5Kind);const d=e.uv6s;d&&i.set(d,I.UV6Kind);const f=e.colors;f&&i.set(ct.CheckColors4(f,n.length/3),I.ColorKind);const p=e.matricesIndices;p&&i.set(p,I.MatricesIndicesKind);const g=e.matricesWeights;g&&i.set(g,I.MatricesWeightsKind);const _=e.indices;_&&(i.indices=_),t.setAllVerticesData(i,e.updatable)}}be.FRONTSIDE=0,be.BACKSIDE=1,be.DOUBLESIDE=2,be.DEFAULTSIDE=0,b([Po.filter((...[r])=>!Array.isArray(r))],be,"_TransformVector3Coordinates",null),b([Po.filter((...[r])=>!Array.isArray(r))],be,"_TransformVector3Normals",null),b([Po.filter((...[r])=>!Array.isArray(r))],be,"_TransformVector4Normals",null),b([Po.filter((...[r])=>!Array.isArray(r))],be,"_FlipFaces",null);class gt extends $i{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=0!=(this._billboardMode&gt.BILLBOARDMODE_USE_POSITION),this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==gt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new E(0,0,1),this._up=new E(0,1,0),this._right=new E(1,0,0),this._position=E.Zero(),this._rotation=E.Zero(),this._rotationQuaternion=null,this._scaling=E.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=gt.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=B.Zero(),this._usePivotMatrix=!1,this._absolutePosition=E.Zero(),this._absoluteScaling=E.Zero(),this._absoluteRotationQuaternion=Be.Identity(),this._pivotMatrix=B.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new J,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return E.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return E.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return E.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=B.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==gt.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=B.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);n&&i&&i(this,n);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(n,t,i);return n}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||Be.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,n;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],n=arguments[2]}else t=e.x,i=e.y,n=e.z;if(this.parent){const s=z.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),E.TransformCoordinatesFromFloatsToRef(t,i,n,s,this.position)}else this.position.x=t,this.position.y=i,this.position.z=n;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=E.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=z.Matrix[0];return this._localMatrix.invertToRef(e),E.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=E.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,n=0,s=Yt.LOCAL){const a=gt._LookAtVectorCache,o=s===Yt.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,i,n),s===Yt.WORLD&&this.parent)if(this.rotationQuaternion){const l=z.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const c=z.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=z.Quaternion[0];Be.FromEulerVectorToRef(this.rotation,l);const c=z.Matrix[0];l.toRotationMatrix(c);const u=z.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(u),u.invert(),c.multiplyToRef(u,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=E.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return E.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,n=0){const s=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?Be.RotationYawPitchRollToRef(s+t,o+i,n,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=s+t,this.rotation.z=n),this}setPivotPoint(e,t=Yt.LOCAL){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==Yt.WORLD){const n=z.Matrix[0];i.invertToRef(n),e=E.TransformCoordinates(e,n)}return this.setPivotMatrix(B.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=E.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=E.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),E.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const n=z.Quaternion[0],s=z.Vector3[0],a=z.Vector3[1],o=z.Matrix[1];B.IdentityToRef(o);const l=z.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=gt._TmpRotation,Be.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),B.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,n,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(s),this.parent=e,i&&this.setPivotMatrix(B.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){let n;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&i!==Yt.LOCAL){if(this.parent){const s=z.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),e=E.TransformNormal(e,s)}n=Be.RotationAxisToRef(e,t,gt._RotationAxisCache),n.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else n=Be.RotationAxisToRef(e,t,gt._RotationAxisCache),this.rotationQuaternion.multiplyToRef(n,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=Be.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const n=z.Vector3[0],s=z.Vector3[1],a=z.Vector3[2],o=z.Quaternion[0],l=z.Matrix[0],c=z.Matrix[1],u=z.Matrix[2],h=z.Matrix[3];return e.subtractToRef(this.position,n),B.TranslationToRef(n.x,n.y,n.z,l),B.TranslationToRef(-n.x,-n.y,-n.z,c),B.RotationAxisToRef(t,i,u),c.multiplyToRef(u,h),h.multiplyToRef(l,h),h.decompose(s,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const n=e.scale(t);if(i&&i!==Yt.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(n));else{const s=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(s)}return this}addRotation(e,t,i){let n;this.rotationQuaternion?n=this.rotationQuaternion:(n=z.Quaternion[1],Be.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n));const s=z.Quaternion[0];return Be.RotationYawPitchRollToRef(t,e,i,s),n.multiplyInPlace(s),this.rotationQuaternion||n.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==gt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const n=this._cache;n.pivotMatrixUpdated=!1,n.billboardMode=this.billboardMode,n.infiniteDistance=this.infiniteDistance,n.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const s=this._getEffectiveParent(),a=gt._TmpScaling;let l,o=this._position;if(this._infiniteDistance&&!this.parent&&t){const c=t.getWorldMatrix(),u=new E(c.m[12],c.m[13],c.m[14]);o=gt._TmpTranslation,o.copyFromFloats(this._position.x+u.x,this._position.y+u.y,this._position.z+u.z)}if(a.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(Be.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=gt._TmpRotation,Be.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const c=z.Matrix[1];B.ScalingToRef(a.x,a.y,a.z,c);const u=z.Matrix[0];l.toRotationMatrix(u),this._pivotMatrix.multiplyToRef(c,z.Matrix[4]),z.Matrix[4].multiplyToRef(u,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else B.ComposeToRef(a,l,o,this._localMatrix);if(s&&s.getWorldMatrix){if(e&&s.computeWorldMatrix(e),n.useBillboardPath){this._transformToBoneReferal?s.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),z.Matrix[7]):z.Matrix[7].copyFrom(s.getWorldMatrix());const c=z.Vector3[5],u=z.Vector3[6],h=z.Quaternion[0];z.Matrix[7].decompose(u,h,c),B.ScalingToRef(u.x,u.y,u.z,z.Matrix[7]),z.Matrix[7].setTranslation(c),gt.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(h,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(z.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(s.getWorldMatrix(),z.Matrix[6]),z.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(s.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(n.useBillboardPath&&t&&this.billboardMode&&!n.useBillboardPosition){if(this._worldMatrix.getTranslationToRef(z.Vector3[0]),z.Matrix[1].copyFrom(t.getViewMatrix()),z.Matrix[1].setTranslationFromFloats(0,0,0),z.Matrix[1].invertToRef(z.Matrix[0]),(this.billboardMode&gt.BILLBOARDMODE_ALL)!==gt.BILLBOARDMODE_ALL){z.Matrix[0].decompose(void 0,z.Quaternion[0],void 0);const u=z.Vector3[1];z.Quaternion[0].toEulerAnglesToRef(u),(this.billboardMode&gt.BILLBOARDMODE_X)!==gt.BILLBOARDMODE_X&&(u.x=0),(this.billboardMode&gt.BILLBOARDMODE_Y)!==gt.BILLBOARDMODE_Y&&(u.y=0),(this.billboardMode&gt.BILLBOARDMODE_Z)!==gt.BILLBOARDMODE_Z&&(u.z=0),B.RotationYawPitchRollToRef(u.y,u.x,u.z,z.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(z.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(z.Vector3[0])}else if(n.useBillboardPath&&t&&n.useBillboardPosition){this._worldMatrix.getTranslationToRef(z.Vector3[0]);const u=t.globalPosition;this._worldMatrix.invertToRef(z.Matrix[1]);const h=z.Vector3[1];E.TransformCoordinatesToRef(u,z.Matrix[1],h),h.normalize();const d=-Math.atan2(h.z,h.x)+Math.PI/2,f=Math.sqrt(h.x*h.x+h.z*h.z),p=-Math.atan2(h.y,f);if(Be.RotationYawPitchRollToRef(d,p,0,z.Quaternion[0]),(this.billboardMode&gt.BILLBOARDMODE_ALL)!==gt.BILLBOARDMODE_ALL){const g=z.Vector3[1];z.Quaternion[0].toEulerAnglesToRef(g),(this.billboardMode&gt.BILLBOARDMODE_X)!==gt.BILLBOARDMODE_X&&(g.x=0),(this.billboardMode&gt.BILLBOARDMODE_Y)!==gt.BILLBOARDMODE_Y&&(g.y=0),(this.billboardMode&gt.BILLBOARDMODE_Z)!==gt.BILLBOARDMODE_Z&&(g.z=0),B.RotationYawPitchRollToRef(g.y,g.x,g.z,z.Matrix[0])}else B.FromQuaternionToRef(z.Quaternion[0],z.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(z.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(z.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):this._updateNonUniformScalingState(!(!s||!s._nonUniformScaling)&&s._nonUniformScaling),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=B.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const n=t[i];if(n){n.computeWorldMatrix();const s=z.Matrix[0];n._localMatrix.multiplyToRef(this._localMatrix,s);const a=z.Quaternion[0];s.decompose(n.scaling,a,n.position),n.rotationQuaternion?n.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(n.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=Be.Identity()),this._worldMatrix=B.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),E.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const n=lt.Clone(()=>new gt(e,this.getScene()),this);if(n.name=e,n.id=e,t&&(n.parent=t),!i){const s=this.getDescendants(!0);for(let a=0;a<s.length;a++){const o=s[a];o.clone&&o.clone(e+"."+o.name,n)}}return n}serialize(e){const t=lt.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const n=lt.Parse(()=>new gt(e.name,t),e,t,i);return e.localMatrix?n.setPreTransformMatrix(B.FromArray(e.localMatrix)):e.pivotMatrix&&n.setPivotMatrix(B.FromArray(e.pivotMatrix)),n.setEnabled(e.isEnabled),n._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(n._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,n=>(!t||t(n))&&n instanceof gt),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const n of i)n.parent=null,n.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let n=null,s=null;t&&(this.rotationQuaternion?(s=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(n=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const a=this.getHierarchyBoundingVectors(e,i),o=a.max.subtract(a.min),l=Math.max(o.x,o.y,o.z);return 0===l||(this.scaling.scaleInPlace(1/l),t&&(this.rotationQuaternion&&s?this.rotationQuaternion.copyFrom(s):this.rotation&&n&&this.rotation.copyFrom(n))),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}gt.BILLBOARDMODE_NONE=0,gt.BILLBOARDMODE_X=1,gt.BILLBOARDMODE_Y=2,gt.BILLBOARDMODE_Z=4,gt.BILLBOARDMODE_ALL=7,gt.BILLBOARDMODE_USE_POSITION=128,gt.BillboardUseParentOrientation=!1,gt._TmpRotation=Be.Zero(),gt._TmpScaling=E.Zero(),gt._TmpTranslation=E.Zero(),gt._LookAtVectorCache=new E(0,0,0),gt._RotationAxisCache=new Be,b([Mr("position")],gt.prototype,"_position",void 0),b([Mr("rotation")],gt.prototype,"_rotation",void 0),b([function lz(r){return rs(10,r)}("rotationQuaternion")],gt.prototype,"_rotationQuaternion",void 0),b([Mr("scaling")],gt.prototype,"_scaling",void 0),b([O("billboardMode")],gt.prototype,"_billboardMode",void 0),b([O()],gt.prototype,"scalingDeterminant",void 0),b([O("infiniteDistance")],gt.prototype,"_infiniteDistance",void 0),b([O()],gt.prototype,"ignoreNonUniformScaling",void 0),b([O()],gt.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class uW{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new E(0,0,0),this._diffPositionForCollisions=new E(0,0,0),this._collisionResponse=!0}}class hW{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=E.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class dW{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new hW,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new uW,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}let hn=(()=>{class r extends gt{static get BILLBOARDMODE_NONE(){return gt.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return gt.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return gt.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return gt.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return gt.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return gt.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(t){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=t}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(t){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=t}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=t}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=t}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(t){this._internalAbstractMeshDataInfo._collisionRetryCount=t}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(t){this._internalAbstractMeshDataInfo._morphTargetManager!==t&&(this._internalAbstractMeshDataInfo._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(t){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==t&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=t,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(t){return!!super._updateNonUniformScalingState(t)&&(this._markSubMeshesAsMiscDirty(),!0)}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(t){this._internalAbstractMeshDataInfo._rawBoundingInfo=t}set onCollide(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(t)}set onCollisionPositionChange(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(t){if(this._internalAbstractMeshDataInfo._visibility===t)return;const i=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=t,(1===i&&1!==t||1!==i&&1===t)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(t){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=t}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(t){this._internalAbstractMeshDataInfo._renderingGroupId=t}get material(){return this._internalAbstractMeshDataInfo._material}set material(t){this._internalAbstractMeshDataInfo._material!==t&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(t){var i;return null===(i=this._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[t]}setMaterialForRenderPass(t,i){this.resetDrawCache(t),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[t]=i}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(t){this._internalAbstractMeshDataInfo._receiveShadows!==t&&(this._internalAbstractMeshDataInfo._receiveShadows=t,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(t){this._internalAbstractMeshDataInfo._hasVertexAlpha!==t&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(t){this._internalAbstractMeshDataInfo._useVertexColors!==t&&(this._internalAbstractMeshDataInfo._useVertexColors=t,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(t){this._internalAbstractMeshDataInfo._numBoneInfluencers!==t&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(t){this._internalAbstractMeshDataInfo._applyFog!==t&&(this._internalAbstractMeshDataInfo._applyFog=t,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(t){this._internalAbstractMeshDataInfo._enableDistantPicking=t}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(t){t!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=t,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(t)?-1:t}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=t}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(t)?-1:t}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(t){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=t}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(t){const i=this._internalAbstractMeshDataInfo._skeleton;i&&i.needInitialSkinMatrix&&i._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=t,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(t,i=null){switch(super(t,i,!1),this._internalAbstractMeshDataInfo=new dW,this._waitingMaterialId=null,this.cullingStrategy=r.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new J,this.onCollisionPositionChangeObservable=new J,this.onMaterialChangedObservable=new J,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=Fe.Red(),this.outlineWidth=.02,this.overlayColor=Fe.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new E(.5,1,.5),this.ellipsoidOffset=new E(0,0,0),this.edgesWidth=1,this.edgesColor=new ct(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new J,this._onCollisionPositionChange=(n,s,a=null)=>{s.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Ve.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),a&&this.onCollideObservable.notifyObservers(a),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(i=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new He(this.getScene().getEngine(),void 0,void 0,t,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),i.performancePriority){case qs.Aggressive:this.doNotSyncBoundingInfo=!0;case qs.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(t){const i=this._uniformBuffer;i.updateMatrix("world",t),i.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),i.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(t){let i="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const n=this._internalAbstractMeshDataInfo._skeleton;return n&&(i+=", skeleton: "+n.name),t&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),i}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==gt.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(t,i=!0){if(this.actionManager&&(i||this.actionManager.isRecursive)){if(!t)return this.actionManager;if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(t,!1):null}_rebuild(t=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes)for(const i of this.subMeshes)i._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const t of this.getScene().lights)!t.isEnabled()||t.canAffectMesh(this)&&this._lightSources.push(t);this._markSubMeshesAsLightDirty()}_resyncLightSource(t){const i=t.isEnabled()&&t.canAffectMesh(this),n=this._lightSources.indexOf(t);let s=!1;if(-1===n){if(!i)return;this._lightSources.push(t)}else{if(i)return;s=!0,this._lightSources.splice(n,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(const t of this.subMeshes)t.setEffect(null)}_removeLightSource(t,i){const n=this._lightSources.indexOf(t);-1!==n&&(this._lightSources.splice(n,1),this._markSubMeshesAsLightDirty(i))}_markSubMeshesAsDirty(t){if(this.subMeshes)for(const i of this.subMeshes)for(let n=0;n<i._drawWrappers.length;++n){const s=i._drawWrappers[n];!s||!s.defines||!s.defines.markAllAsDirty||t(s.defines)}}_markSubMeshesAsLightDirty(t=!1){this._markSubMeshesAsDirty(i=>i.markAsLightDirty(t))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(t=>t.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(t=>t.markAsMiscDirty())}markAsDirty(t){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(t){if(this.subMeshes)for(const i of this.subMeshes)i.resetDrawCache(t)}get isBlocked(){return!1}getLOD(t){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(t){return null}setVerticesData(t,i,n,s){return this}updateVerticesData(t,i,n,s){return this}setIndices(t,i){return this}isVerticesDataPresent(t){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var t;return null!==(t=this.rawBoundingInfo)&&void 0!==t?t:this.getBoundingInfo()}setBoundingInfo(t){return this._boundingInfo=t,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(t,i,n){return this._boundingInfo=new Xr(t,i,n),this._boundingInfo}normalizeToUnitCube(t=!0,i=!1,n){return super.normalizeToUnitCube(t,i,n)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(I.MatricesIndicesKind)&&this.isVerticesDataPresent(I.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(t){}_activate(t,i){return this._renderId=t,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===gt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(t,i,n){return this.position.addInPlace(this.calcMovePOV(t,i,n)),this}calcMovePOV(t,i,n){const s=new B;(this.rotationQuaternion?this.rotationQuaternion:Be.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const o=E.Zero(),l=this.definedFacingForward?-1:1;return E.TransformCoordinatesFromFloatsToRef(t*l,i,n*l,s,o),o}rotatePOV(t,i,n){return this.rotation.addInPlace(this.calcRotatePOV(t,i,n)),this}calcRotatePOV(t,i,n){const s=this.definedFacingForward?1:-1;return new E(t*s,i,n*s)}refreshBoundingInfo(t=!1,i=!1){return this._boundingInfo&&this._boundingInfo.isLocked||this._refreshBoundingInfo(this._getPositionData(t,i),null),this}_refreshBoundingInfo(t,i){if(t){const n=Vb(t,0,this.getTotalVertices(),i);this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new Xr(n.minimum,n.maximum)}if(this.subMeshes)for(let n=0;n<this.subMeshes.length;n++)this.subMeshes[n].refreshBoundingInfo(t);this._updateBoundingInfo()}_getData(t=!1,i=!1,n,s=I.PositionKind){if((n=null!=n?n:this.getVerticesData(s).slice())&&i&&this.morphTargetManager){let a=0,o=0;for(let l=0;l<n.length;l++){for(let c=0;c<this.morphTargetManager.numTargets;c++){const u=this.morphTargetManager.getTarget(c),h=u.influence;if(h>0){const d=u.getPositions();d&&(n[l]+=(d[l]-n[l])*h)}}if(a++,s===I.PositionKind&&this._positions&&3===a){a=0;const c=3*o;this._positions[o++].copyFromFloats(n[c],n[c+1],n[c+2])}}}if(n&&t&&this.skeleton){const a=this.getVerticesData(I.MatricesIndicesKind),o=this.getVerticesData(I.MatricesWeightsKind);if(o&&a){const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(I.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(I.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this),d=z.Vector3[0],f=z.Matrix[0],p=z.Matrix[1];let g=0;for(let _=0;_<n.length;_+=3,g+=4){let m,T;for(f.reset(),m=0;m<4;m++)T=o[g+m],T>0&&(B.FromFloat32ArrayToRefScaled(h,Math.floor(16*a[g+m]),T,p),f.addToSelf(p));if(l)for(m=0;m<4;m++)T=u[g+m],T>0&&(B.FromFloat32ArrayToRefScaled(h,Math.floor(16*c[g+m]),T,p),f.addToSelf(p));s===I.NormalKind?E.TransformNormalFromFloatsToRef(n[_],n[_+1],n[_+2],f,d):E.TransformCoordinatesFromFloatsToRef(n[_],n[_+1],n[_+2],f,d),d.toArray(n,_),s===I.PositionKind&&this._positions&&this._positions[_/3].copyFrom(d)}}}return n}getNormalsData(t=!1,i=!1){return this._getData(t,i,null,I.NormalKind)}getPositionData(t=!1,i=!1,n){return this._getData(t,i,n,I.PositionKind)}_getPositionData(t,i){var n;let s=this.getVerticesData(I.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),s&&(t&&this.skeleton||i&&this.morphTargetManager)){if(s=s.slice(),this._generatePointsArray(),this._positions){const a=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(a.length);for(let o=0;o<a.length;o++)this._internalAbstractMeshDataInfo._positions[o]=(null===(n=a[o])||void 0===n?void 0:n.clone())||new E}return this.getPositionData(t,i,s)}return s}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Xr(E.Zero(),E.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(t){if(!this.subMeshes)return this;const i=this.subMeshes.length;for(let n=0;n<i;n++){const s=this.subMeshes[n];(i>1||!s.IsGlobal)&&s.updateBoundingInfo(t)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)}isCompletelyInFrustum(t){return this.getBoundingInfo().isCompletelyInFrustum(t)}intersectsMesh(t,i=!1,n){const s=this.getBoundingInfo(),a=t.getBoundingInfo();if(s.intersects(a,i))return!0;if(n)for(const o of this.getChildMeshes())if(o.intersectsMesh(t,i,!0))return!0;return!1}intersectsPoint(t){return this.getBoundingInfo().intersectsPoint(t)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(t){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=t}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(t){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const n=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=n.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,n.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,t,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(t,i,n){var s;if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];const o=t.verticesStart+t.verticesCount;for(let l=t.verticesStart;l<o;l++)t._lastColliderWorldVertices.push(E.TransformCoordinates(this._positions[l],i))}return n._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this._shouldConvertRHS(),7===(null===(s=t.getMaterial())||void 0===s?void 0:s.fillMode)),this}_processCollisionsForSubMeshes(t,i){const n=this._scene.getCollidingSubMeshCandidates(this,t),s=n.length;for(let a=0;a<s;a++){const o=n.data[a];s>1&&!o._checkCollision(t)||this._collideForSubMesh(o,i,t)}return this}_shouldConvertRHS(){return!1}_checkCollision(t){if(!this.getBoundingInfo()._checkCollision(t))return this;const i=z.Matrix[0],n=z.Matrix[1];return B.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,i),this.worldMatrixFromCache.multiplyToRef(i,n),this._processCollisionsForSubMeshes(t,n),this}_generatePointsArray(){return!1}intersects(t,i,n,s=!1,a,o=!1){const l=new Za,c="InstancedLinesMesh"===this.getClassName()||"LinesMesh"===this.getClassName()?this.intersectionThreshold:0,u=this.getBoundingInfo();if(!this.subMeshes||!(o||t.intersectsSphere(u.boundingSphere,c)&&t.intersectsBox(u.boundingBox,c)))return l;if(s)return l.hit=!o,l.pickedMesh=o?null:this,l.distance=o?0:E.Distance(t.origin,u.boundingSphere.center),l.subMeshId=0,l;if(!this._generatePointsArray())return l;let h=null;const d=this._scene.getIntersectingSubMeshCandidates(this,t),f=d.length;let p=!1;for(let g=0;g<f;g++){const m=d.data[g].getMaterial();if(m&&(7==m.fillMode||0==m.fillMode||1==m.fillMode||2==m.fillMode||4==m.fillMode)){p=!0;break}}if(!p)return l.hit=!0,l.pickedMesh=this,l.distance=E.Distance(t.origin,u.boundingSphere.center),l.subMeshId=-1,l;for(let g=0;g<f;g++){const _=d.data[g];if(f>1&&!_.canIntersects(t))continue;const m=_.intersects(t,this._positions,this.getIndices(),i,n);if(m&&(i||!h||m.distance<h.distance)&&(h=m,h.subMeshId=g,i))break}if(h){const g=null!=a?a:this.getWorldMatrix(),_=z.Vector3[0],m=z.Vector3[1];E.TransformCoordinatesToRef(t.origin,g,_),t.direction.scaleToRef(h.distance,m);const v=E.TransformNormal(m,g).addInPlace(_);return l.hit=!0,l.distance=E.Distance(_,v),l.pickedPoint=v,l.pickedMesh=this,l.bu=h.bu||0,l.bv=h.bv||0,l.subMeshFaceId=h.faceId,l.faceId=h.faceId+d.data[h.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),l.subMeshId=h.subMeshId,l}return l}clone(t,i,n){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(t,i=!1){let n;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),null!=this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),n=0;n<this._intersectionsInProgress.length;n++){const o=this._intersectionsInProgress[n],l=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(l,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(o=>{let l=o.includedOnlyMeshes.indexOf(this);-1!==l&&o.includedOnlyMeshes.splice(l,1),l=o.excludedMeshes.indexOf(this),-1!==l&&o.excludedMeshes.splice(l,1);const c=o.getShadowGenerators();if(c){const u=c.values();for(let h=u.next();!0!==h.done;h=u.next()){const f=h.value.getShadowMap();f&&f.renderList&&(l=f.renderList.indexOf(this),-1!==l&&f.renderList.splice(l,1))}}}),("InstancedMesh"!==this.getClassName()||"InstancedLinesMesh"!==this.getClassName())&&this.releaseSubMeshes();const a=this.getScene().getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const o=this._parentContainer.meshes.indexOf(this);o>-1&&this._parentContainer.meshes.splice(o,1),this._parentContainer=null}if(i&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(n=0;n<this.getScene().particleSystems.length;n++)this.getScene().particleSystems[n].emitter===this&&(this.getScene().particleSystems[n].dispose(),n--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(t,i)}addChild(t,i=!1){return t.setParent(this,i),this}removeChild(t,i=!1){return t.setParent(null,i),this}_initFacetData(){const t=this._internalAbstractMeshDataInfo._facetData;t.facetNormals||(t.facetNormals=new Array),t.facetPositions||(t.facetPositions=new Array),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(let i=0;i<t.facetNb;i++)t.facetNormals[i]=E.Zero(),t.facetPositions[i]=E.Zero();return t.facetDataEnabled=!0,this}updateFacetData(){const t=this._internalAbstractMeshDataInfo._facetData;t.facetDataEnabled||this._initFacetData();const i=this.getVerticesData(I.PositionKind),n=this.getIndices(),s=this.getVerticesData(I.NormalKind),a=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,n instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(n);else if(n instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(n);else{let l=!1;for(let c=0;c<n.length;c++)if(n[c]>65535){l=!0;break}t.depthSortedIndices=l?new Uint32Array(n):new Uint16Array(n)}if(t.facetDepthSortFunction=function(l,c){return c.sqDistance-l.sqDistance},!t.facetDepthSortFrom){const l=this.getScene().activeCamera;t.facetDepthSortFrom=l?l.position:E.Zero()}t.depthSortedFacets=[];for(let l=0;l<t.facetNb;l++)t.depthSortedFacets.push({ind:3*l,sqDistance:0});t.invertedMatrix=B.Identity(),t.facetDepthSortOrigin=E.Zero()}t.bbSize.x=a.maximum.x-a.minimum.x>kt?a.maximum.x-a.minimum.x:kt,t.bbSize.y=a.maximum.y-a.minimum.y>kt?a.maximum.y-a.minimum.y:kt,t.bbSize.z=a.maximum.z-a.minimum.z>kt?a.maximum.z-a.minimum.z:kt;let o=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(o=o>t.bbSize.z?o:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/o),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/o),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/o),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=a,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(t.invertedMatrix),E.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,s&&be.ComputeNormals(i,n,s,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);const l=t.depthSortedIndices.length/3|0;for(let c=0;c<l;c++){const u=t.depthSortedFacets[c].ind;t.depthSortedIndices[3*c]=n[u],t.depthSortedIndices[3*c+1]=n[u+1],t.depthSortedIndices[3*c+2]=n[u+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetNormals||this.updateFacetData(),t.facetNormals}getFacetLocalPositions(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetPositions||this.updateFacetData(),t.facetPositions}getFacetLocalPartitioning(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning}getFacetPosition(t){const i=E.Zero();return this.getFacetPositionToRef(t,i),i}getFacetPositionToRef(t,i){const n=this.getFacetLocalPositions()[t],s=this.getWorldMatrix();return E.TransformCoordinatesToRef(n,s,i),this}getFacetNormal(t){const i=E.Zero();return this.getFacetNormalToRef(t,i),i}getFacetNormalToRef(t,i){const n=this.getFacetLocalNormals()[t];return E.TransformNormalToRef(n,this.getWorldMatrix(),i),this}getFacetsAtLocalCoordinates(t,i,n){const s=this.getBoundingInfo(),a=this._internalAbstractMeshDataInfo._facetData,o=Math.floor((t-s.minimum.x*a.partitioningBBoxRatio)*a.subDiv.X*a.partitioningBBoxRatio/a.bbSize.x),l=Math.floor((i-s.minimum.y*a.partitioningBBoxRatio)*a.subDiv.Y*a.partitioningBBoxRatio/a.bbSize.y),c=Math.floor((n-s.minimum.z*a.partitioningBBoxRatio)*a.subDiv.Z*a.partitioningBBoxRatio/a.bbSize.z);return o<0||o>a.subDiv.max||l<0||l>a.subDiv.max||c<0||c>a.subDiv.max?null:a.facetPartitioning[o+a.subDiv.max*l+a.subDiv.max*a.subDiv.max*c]}getClosestFacetAtCoordinates(t,i,n,s,a=!1,o=!0){const l=this.getWorldMatrix(),c=z.Matrix[5];l.invertToRef(c);const u=z.Vector3[8];E.TransformCoordinatesFromFloatsToRef(t,i,n,c,u);const h=this.getClosestFacetAtLocalCoordinates(u.x,u.y,u.z,s,a,o);return s&&E.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,l,s),h}getClosestFacetAtLocalCoordinates(t,i,n,s,a=!1,o=!0){let l=null,c=0,u=0,h=0,d=0,f=0,p=0,g=0,_=0;const m=this.getFacetLocalPositions(),T=this.getFacetLocalNormals(),v=this.getFacetsAtLocalCoordinates(t,i,n);if(!v)return null;let x,C,R,A=Number.MAX_VALUE,S=A;for(let D=0;D<v.length;D++)x=v[D],C=T[x],R=m[x],d=(t-R.x)*C.x+(i-R.y)*C.y+(n-R.z)*C.z,(!a||a&&o&&d>=0||a&&!o&&d<=0)&&(d=C.x*R.x+C.y*R.y+C.z*R.z,f=-(C.x*t+C.y*i+C.z*n-d)/(C.x*C.x+C.y*C.y+C.z*C.z),p=t+C.x*f,g=i+C.y*f,_=n+C.z*f,c=p-t,u=g-i,h=_-n,S=c*c+u*u+h*h,S<A&&(A=S,l=x,s&&(s.x=p,s.y=g,s.z=_)));return l}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const t=this._internalAbstractMeshDataInfo._facetData;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=new Array,t.facetNormals=new Array,t.facetPartitioning=new Array,t.facetParameters=null,t.depthSortedIndices=new Uint32Array(0)),this}updateIndices(t,i,n=!1){return this}createNormals(t){const i=this.getVerticesData(I.PositionKind),n=this.getIndices();let s;return s=this.isVerticesDataPresent(I.NormalKind)?this.getVerticesData(I.NormalKind):[],be.ComputeNormals(i,n,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(I.NormalKind,s,t),this}alignWithNormal(t,i){i||(i=wo.Y);const n=z.Vector3[0],s=z.Vector3[1];return E.CrossToRef(i,t,s),E.CrossToRef(t,s,n),this.rotationQuaternion?Be.RotationQuaternionFromAxisToRef(n,t,s,this.rotationQuaternion):E.RotationFromAxisToRef(n,t,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw ht("EdgesRenderer")}enableEdgesRendering(t,i,n){throw ht("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(t=>t.emitter===this)}}return r.OCCLUSION_TYPE_NONE=0,r.OCCLUSION_TYPE_OPTIMISTIC=1,r.OCCLUSION_TYPE_STRICT=2,r.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,r.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,r.CULLINGSTRATEGY_STANDARD=0,r.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r})();ye("BABYLON.AbstractMesh",hn),Object.defineProperty(hn.prototype,"decalMap",{get:function(){return this._decalMap},set:function(r){this._decalMap=r},enumerable:!0,configurable:!0});let ZI=(()=>{class r extends class fW{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const n=this._pendingActions.shift();n?this._execute(e,n):e.idle=!0})})}}{constructor(t,i,n=r.DefaultOptions){super([]),this._maxWorkers=t,this._createWorkerAsync=i,this._options=n}push(t){if(!this._executeOnIdleWorker(t))if(this._workerInfos.length<this._maxWorkers){const i={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(i),this._execute(i,t)}else this._pendingActions.push(t)}_execute(t,i){t.timeoutId&&(clearTimeout(t.timeoutId),delete t.timeoutId),super._execute(t,(n,s)=>{i(n,()=>{s(),t.idle&&(t.timeoutId=setTimeout(()=>{t.workerPromise.then(o=>{o.terminate()});const a=this._workerInfos.indexOf(t);-1!==a&&this._workerInfos.splice(a,1)},this._options.idleTimeElapsedBeforeRelease))})})}}return r.DefaultOptions={idleTimeElapsedBeforeRelease:1e3},r})();function vT(r,e,t,i,n,s){const a=new r.DecoderBuffer;a.Init(e,e.byteLength);const o=new r.Decoder;let l,c;try{const u=o.GetEncodedGeometryType(a);switch(u){case r.TRIANGULAR_MESH:l=new r.Mesh,c=o.DecodeBufferToMesh(a,l);break;case r.POINT_CLOUD:l=new r.PointCloud,c=o.DecodeBufferToPointCloud(a,l);break;default:throw new Error(`Invalid geometry type ${u}`)}if(!c.ok()||!l.ptr)throw new Error(c.error_msg());if(u===r.TRIANGULAR_MESH){const f=3*l.num_faces(),p=4*f,g=r._malloc(p);try{o.GetTrianglesUInt32Array(l,p,g);const _=new Uint32Array(f);_.set(new Uint32Array(r.HEAPF32.buffer,g,f)),i(_)}finally{r._free(g)}}const h=(d,f,p=1)=>{const g=f.num_components(),_=l.num_points(),m=_*g,T=m*Float32Array.BYTES_PER_ELEMENT,v=r._malloc(T);try{o.GetAttributeDataArrayForAllPoints(l,f,r.DT_FLOAT32,T,v);const A=new Float32Array(r.HEAPF32.buffer,v,m);if("color"===d&&3===g){const S=new Float32Array(4*_);for(let x=0,C=0;x<S.length;x+=4,C+=g)S[x+0]=A[C+0],S[x+1]=A[C+1],S[x+2]=A[C+2],S[x+3]=1;n(d,S)}else{const S=new Float32Array(m);if(S.set(new Float32Array(r.HEAPF32.buffer,v,m)),1!==p)for(let x=0;x<S.length;x++)S[x]=S[x]/p;n(d,S)}}finally{r._free(v)}};if(t)for(const d in t){h(d,o.GetAttributeByUniqueId(l,t[d]),s&&s[d]||1)}else{const d={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const f in d){const p=o.GetAttributeId(l,r[d[f]]);-1!==p&&h(f,o.GetAttribute(l,p))}}}finally{l&&r.destroy(l),r.destroy(o),r.destroy(a)}}function gW(){let r;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const i=t.decoder;i.url&&(importScripts(i.url),r=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage("done");break}case"decodeMesh":if(!r)throw new Error("Draco decoder module is not available");r.then(i=>{vT(i,t.dataView,t.attributes,n=>{postMessage({id:"indices",value:n},[n.buffer])},(n,s)=>{postMessage({id:n,value:s},[s.buffer])}),postMessage("done")})}}}class Rs{static get DecoderAvailable(){const e=Rs.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly||e.fallbackUrl)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static get Default(){return Rs._Default||(Rs._Default=new Rs),Rs._Default}constructor(e=Rs.DefaultNumWorkers){const t=Rs.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:Ie.GetAbsoluteUrl(t.wasmUrl),wasmBinaryPromise:Ie.LoadFileAsync(Ie.GetAbsoluteUrl(t.wasmBinaryUrl))}:{url:Ie.GetAbsoluteUrl(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&"function"==typeof Worker&&"function"==typeof URL?this._workerPoolPromise=i.wasmBinaryPromise.then(n=>{const a=URL.createObjectURL(new Blob([`${vT}(${gW})()`],{type:"application/javascript"}));return new ZI(e,()=>new Promise((o,l)=>{const c=new Worker(a),u=d=>{c.removeEventListener("error",u),c.removeEventListener("message",h),l(d)},h=d=>{"done"===d.data&&(c.removeEventListener("error",u),c.removeEventListener("message",h),o(c))};c.addEventListener("error",u),c.addEventListener("message",h),c.postMessage({id:"init",decoder:{url:i.url,wasmBinary:n}})}))}):this._decoderModulePromise=i.wasmBinaryPromise.then(n=>{if(!i.url)throw new Error("Draco decoder module is not available");return Ie.LoadScriptAsync(i.url).then(()=>function pW(r){return new Promise(e=>{DracoDecoderModule({wasmBinary:r}).then(t=>{e({module:t})})})}(n))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}decodeMeshAsync(e,t,i){const n=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then(s=>new Promise((a,o)=>{s.push((l,c)=>{const u=new be,h=p=>{l.removeEventListener("error",h),l.removeEventListener("message",d),o(p),c()},d=p=>{if("done"===p.data)l.removeEventListener("error",h),l.removeEventListener("message",d),a(u),c();else if("indices"===p.data.id)u.indices=p.data.value;else{const g=i&&i[p.data.id]?i[p.data.id]:1;if(1!==g)for(let _=0;_<p.data.value.length;_++)p.data.value[_]=p.data.value[_]/g;u.set(p.data.value,p.data.id)}};l.addEventListener("error",h),l.addEventListener("message",d);const f=new Uint8Array(n.byteLength);f.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),l.postMessage({id:"decodeMesh",dataView:f,attributes:t},[f.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(s=>{const a=new be;return vT(s.module,n,t,o=>{a.indices=o},(o,l)=>{a.set(l,o)},i),a});throw new Error("Draco decoder module is not available")}}Rs.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},Rs.DefaultNumWorkers=Rs.GetDefaultNumWorkers(),Rs._Default=null;class ST{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class nr{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:null===(e=this._getDrawWrapper())||void 0===e?void 0:e.defines}set materialDefines(e){var t;(null!==(t=this._mainDrawWrapperOverride)&&void 0!==t?t:this._getDrawWrapper(void 0,!0)).defines=e}_getDrawWrapper(e,t=!1){let i=this._drawWrappers[e=null!=e?e:this._engine.currentRenderPassId];return!i&&t&&(this._drawWrappers[e]=i=new Qs(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&(null===(i=this._drawWrappers[e])||void 0===i||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:null!==(t=null===(e=this._getDrawWrapper())||void 0===e?void 0:e.effect)&&void 0!==t?t:null}get _drawWrapper(){var e;return null!==(e=this._mainDrawWrapperOverride)&&void 0!==e?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,n=!0){const s=this._drawWrapper;s.setEffect(e,t,n),void 0!==i&&(s.materialContext=i),e||(s.defines=null,s.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e);for(const t of this._drawWrappers)null==t||t.dispose()}this._drawWrappers=[]}static AddToMesh(e,t,i,n,s,a,o,l=!0){return new nr(e,t,i,n,s,a,o,l)}constructor(e,t,i,n,s,a,o,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=n,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,c&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,l&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){var t;const i=null!==(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))&&void 0!==t?t:this._renderingMesh.material;if(!i)return e?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(i)){const n=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==n&&(this._currentMaterial=n,this.resetDrawCache()),n}return i}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(I.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(0===this.indexStart&&this.indexCount===t.length){const n=this._renderingMesh.getBoundingInfo();i={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else i=function hz(r,e,t,i,n=null){const s=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return bf.extractMinAndMaxIndexed(r,e,t,i,s,a),n&&(s.x-=s.x*n.x+n.y,s.y-=s.y*n.x+n.y,s.z-=s.z*n.x+n.y,a.x+=a.x*n.x+n.y,a.y+=a.y*n.x+n.y,a.z+=a.z*n.x+n.y),{minimum:s,maximum:a}}(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Xr(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let n=this.indexStart;n<this.indexStart+this.indexCount;n+=3)i.push(e[n],e[n+1],e[n+1],e[n+2],e[n+2],e[n]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,i,n,s){const a=this.getMaterial();if(!a)return null;let o=3,l=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0}return 4===a.fillMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,n):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,n):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,n,s):this._intersectTriangles(e,t,i,o,l,n,s)}_intersectLines(e,t,i,n,s){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const u=e.intersectionSegment(t[i[o]],t[i[o+1]],n);if(!(u<0)&&(s||!a||u<a.distance)&&(a=new ST(null,null,u),a.faceId=o/2,s))break}return a}_intersectUnIndexedLines(e,t,i,n,s){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){const u=e.intersectionSegment(t[o],t[o+1],n);if(!(u<0)&&(s||!a||u<a.distance)&&(a=new ST(null,null,u),a.faceId=o/2,s))break}return a}_intersectTriangles(e,t,i,n,s,a,o){let l=null,c=-1;for(let u=this.indexStart;u<this.indexStart+this.indexCount-(3-n);u+=n){c++;const h=i[u],d=i[u+1],f=i[u+2];if(s&&4294967295===f){u+=2;continue}const p=t[h],g=t[d],_=t[f];if(!p||!g||!_||o&&!o(p,g,_,e,h,d,f))continue;const m=e.intersectsTriangle(p,g,_);if(m){if(m.distance<0)continue;if((a||!l||m.distance<l.distance)&&(l=m,l.faceId=c,a))break}}return l}_intersectUnIndexedTriangles(e,t,i,n,s){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=t[o],c=t[o+1],u=t[o+2];if(s&&!s(l,c,u,e,-1,-1,-1))continue;const h=e.intersectsTriangle(l,c,u);if(h){if(h.distance<0)continue;if((n||!a||h.distance<a.distance)&&(a=h,a.faceId=o/3,n))break}}return a}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new nr(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const n=this.getBoundingInfo();if(!n)return i;i._boundingInfo=new Xr(n.minimum,n.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,n,s,a=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE;const u=(s||n).getIndices();for(let h=t;h<t+i;h++){const d=u[h];d<o&&(o=d),d>l&&(l=d)}return new nr(e,o,l-o+1,t,i,n,s,a)}}let ya=(()=>{class r{static get ForceFullSceneLoadingForIncremental(){return r._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){r._ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return r._ShowLoadingScreen}static set ShowLoadingScreen(t){r._ShowLoadingScreen=t}static get loggingLevel(){return r._LoggingLevel}static set loggingLevel(t){r._LoggingLevel=t}static get CleanBoneMatrixWeights(){return r._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){r._CleanBoneMatrixWeights=t}}return r._ForceFullSceneLoadingForIncremental=!1,r._ShowLoadingScreen=!0,r._CleanBoneMatrixWeights=!1,r._LoggingLevel=0,r})();class pr{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new pr(pr.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,n=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||Je.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=n,i?this.setAllVerticesData(i,n):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,n){i&&Array.isArray(t)&&(t=new Float32Array(t));const s=new I(this._engine,t,e,i,0===this._meshes.length,n);this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const n=e.getKind();this._vertexBuffers[n]&&i&&this._vertexBuffers[n].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[n]=e;const s=this._meshes,a=s.length;if(n===I.PositionKind){const o=e.getData();null!=t?this._totalVertices=t:null!=o&&(this._totalVertices=o.length/(e.type===I.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(o),this._resetPointsArrayCache();for(let l=0;l<a;l++){const c=s[l];c.buildBoundingInfo(this._extend.minimum,this._extend.maximum),c._createGlobalSubMesh(c.isUnIndexed),c.computeWorldMatrix(!0),c.synchronizeInstances()}}this._notifyUpdate(n)}updateVerticesDataDirectly(e,t,i,n=!1){const s=this.getVertexBuffer(e);!s||(s.updateDirectly(t,i,n),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const n=this.getVertexBuffer(e);!n||(n.update(t),e===I.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const n of i){n.hasBoundingInfo?n.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):n.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const s=n.subMeshes;for(const a of s)a.refreshBoundingInfo()}}}_bind(e,t,i,n){if(!e)return;void 0===t&&(t=this._indexBuffer);const s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!n)return void this._engine.bindBuffers(s,t,e,i);const a=n||this._vertexArrayObjects;a[e.key]||(a[e.key]=this._engine.recordVertexArrayObject(s,t,e,i)),this._engine.bindVertexArrayObject(a[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const n=this.getVertexBuffer(e);return n?n.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const n=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),n)for(const s of this._meshes)s._createGlobalSubMesh(!0)}else this.setIndices(e,null,!0)}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),null!=t&&(this._totalVertices=t);for(const n of this._meshes)n._createGlobalSubMesh(!0),n.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,n=i.indexOf(e);-1!==n&&(i.splice(n,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(I.PositionKind)))return;this._extend=Vb(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)1===t&&this._vertexBuffers[i].create(),i===I.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(2!==this.delayLoadState){if(this.isReady())return void(t&&t());this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){!this.delayLoadingFile||(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const n=this._meshes,s=n.length;for(let a=0;a<s;a++)this._applyToMesh(n[a]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(null!=e&&e.length>0){for(let n=0;n<e.length;n+=3){const s=e[n+0];e[n+0]=e[n+2],e[n+2]=s}this.setIndices(e)}const t=this.getVerticesData(I.PositionKind,!1);if(null!=t&&t.length>0){for(let n=0;n<t.length;n+=3)t[n+2]=-t[n+2];this.setVerticesData(I.PositionKind,t,!1)}const i=this.getVerticesData(I.NormalKind,!1);if(null!=i&&i.length>0){for(let n=0;n<i.length;n+=3)i[n+2]=-i[n+2];this.setVerticesData(I.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(I.PositionKind);if(!e||0===e.length)return!1;for(let t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=E.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const n in this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const n=this._parentContainer.geometries.indexOf(this);n>-1&&this._parentContainer.geometries.splice(n,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new be;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let a,n=!1,s=!1;for(a in this._vertexBuffers){const l=this.getVerticesData(a);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),a):t.set(l.slice(0),a),!s)){const c=this.getVertexBuffer(a);c&&(n=c.isUpdatable(),s=!n)}}const o=new pr(e,this._scene,t,n);for(a in o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(a);return o._boundingInfo=new Xr(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Gt&&Gt.HasTags(this)&&(e.tags=Gt.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)||(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(I.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(I.PositionKind)),this.isVertexBufferUpdatable(I.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(I.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(I.NormalKind)),this.isVertexBufferUpdatable(I.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(I.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(I.TangentKind)),this.isVertexBufferUpdatable(I.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(I.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(I.UVKind)),this.isVertexBufferUpdatable(I.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(I.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(I.UV2Kind)),this.isVertexBufferUpdatable(I.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(I.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(I.UV3Kind)),this.isVertexBufferUpdatable(I.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(I.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(I.UV4Kind)),this.isVertexBufferUpdatable(I.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(I.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(I.UV5Kind)),this.isVertexBufferUpdatable(I.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(I.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(I.UV6Kind)),this.isVertexBufferUpdatable(I.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(I.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(I.ColorKind)),this.isVertexBufferUpdatable(I.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(I.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(I.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(I.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(I.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(I.MatricesWeightsKind)),this.isVertexBufferUpdatable(I.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return Ie.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),n=e.geometryUniqueId,s=e.geometryId;if(n||s){const a=n?this._GetGeometryByLoadedUniqueId(n,i):i.getGeometryById(s);a&&a.applyToMesh(t)}else if(e instanceof ArrayBuffer){const a=t._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){const o=new Float32Array(e,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);t.setVerticesData(I.PositionKind,o,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){const o=new Float32Array(e,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);t.setVerticesData(I.NormalKind,o,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){const o=new Float32Array(e,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);t.setVerticesData(I.TangentKind,o,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){const o=new Float32Array(e,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);if(jt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(I.UVKind,o,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){const o=new Float32Array(e,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);if(jt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(I.UV2Kind,o,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){const o=new Float32Array(e,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);if(jt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(I.UV3Kind,o,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){const o=new Float32Array(e,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);if(jt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(I.UV4Kind,o,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){const o=new Float32Array(e,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);if(jt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(I.UV5Kind,o,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){const o=new Float32Array(e,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);if(jt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(I.UV6Kind,o,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){const o=new Float32Array(e,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);t.setVerticesData(I.ColorKind,o,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){const o=new Int32Array(e,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const u=o[c];l.push(255&u),l.push((65280&u)>>8),l.push((16711680&u)>>16),l.push(u>>24&255)}t.setVerticesData(I.MatricesIndicesKind,l,!1)}if(a.matricesIndicesExtraAttrDesc&&a.matricesIndicesExtraAttrDesc.count>0){const o=new Int32Array(e,a.matricesIndicesExtraAttrDesc.offset,a.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const u=o[c];l.push(255&u),l.push((65280&u)>>8),l.push((16711680&u)>>16),l.push(u>>24&255)}t.setVerticesData(I.MatricesIndicesExtraKind,l,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){const o=new Float32Array(e,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);t.setVerticesData(I.MatricesWeightsKind,o,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){const o=new Int32Array(e,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);t.setIndices(o,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){const o=new Int32Array(e,a.subMeshesAttrDesc.offset,5*a.subMeshesAttrDesc.count);t.subMeshes=[];for(let l=0;l<a.subMeshesAttrDesc.count;l++)nr.AddToMesh(o[5*l+0],o[5*l+1],o[5*l+2],o[5*l+3],o[5*l+4],t)}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(I.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(I.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(I.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(I.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(I.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(I.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(I.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(I.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(I.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(I.ColorKind,ct.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(I.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const a=[];for(let o=0;o<e.matricesIndices.length;o++){const l=e.matricesIndices[o];a.push(255&l),a.push((65280&l)>>8),a.push((16711680&l)>>16),a.push(l>>24&255)}t.setVerticesData(I.MatricesIndicesKind,a,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(I.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const a=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){const l=e.matricesIndicesExtra[o];a.push(255&l),a.push((65280&l)>>8),a.push((16711680&l)>>16),a.push(l>>24&255)}t.setVerticesData(I.MatricesIndicesExtraKind,a,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(pr._CleanMatricesWeights(e,t),t.setVerticesData(I.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(I.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let a=0;a<e.subMeshes.length;a++){const o=e.subMeshes[a];nr.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!ya.CleanBoneMatrixWeights)return;let n=0;if(!(e.skeletonId>-1))return;{const h=t.getScene().getLastSkeletonById(e.skeletonId);if(!h)return;n=h.bones.length}const s=t.getVerticesData(I.MatricesIndicesKind),a=t.getVerticesData(I.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,u=o.length;for(let h=0;h<u;h+=4){let d=0,f=-1;for(let p=0;p<4;p++){const g=o[h+p];d+=g,g<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){const g=l[h+p];d+=g,g<.001&&f<0&&(f=p+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){const p=1/d;for(let g=0;g<4;g++)o[h+g]*=p;if(l)for(let g=0;g<4;g++)l[h+g]*=p}else f>=4?(l[h+f-4]=1-d,a[h+f-4]=n):(o[h+f]=1-d,s[h+f]=n)}t.setVerticesData(I.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(I.MatricesIndicesExtraKind,a)}static Parse(e,t,i){const n=new pr(e.id,t,void 0,e.updatable);return n._loadedUniqueId=e.uniqueId,Gt&&Gt.AddTagsTo(n,e.tags),e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=i+e.delayLoadingFile,n._boundingInfo=new Xr(E.FromArray(e.boundingBoxMinimum),E.FromArray(e.boundingBoxMaximum)),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(I.UVKind),e.hasUVs2&&n._delayInfo.push(I.UV2Kind),e.hasUVs3&&n._delayInfo.push(I.UV3Kind),e.hasUVs4&&n._delayInfo.push(I.UV4Kind),e.hasUVs5&&n._delayInfo.push(I.UV5Kind),e.hasUVs6&&n._delayInfo.push(I.UV6Kind),e.hasColors&&n._delayInfo.push(I.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(I.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(I.MatricesWeightsKind),n._delayLoadingFunction=be.ImportVertexData):be.ImportVertexData(e,n),t.pushGeometry(n,!0),n}}class io{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){lt.Clone(()=>e,this)}serialize(){return lt.Serialize(this)}parse(e,t,i){lt.Parse(()=>this,e,t,i)}}b([O()],io.prototype,"func",null),b([O()],io.prototype,"funcRef",null),b([O()],io.prototype,"funcMask",null),b([O()],io.prototype,"opStencilFail",null),b([O()],io.prototype,"opDepthFail",null),b([O()],io.prototype,"opStencilDepthPass",null),b([O()],io.prototype,"mask",null),b([O()],io.prototype,"enabled",null);var In=(()=>{return(r=In||(In={}))[r.Created=1]="Created",r[r.Disposed=2]="Disposed",r[r.GetDefineNames=4]="GetDefineNames",r[r.PrepareUniformBuffer=8]="PrepareUniformBuffer",r[r.IsReadyForSubMesh=16]="IsReadyForSubMesh",r[r.PrepareDefines=32]="PrepareDefines",r[r.BindForSubMesh=64]="BindForSubMesh",r[r.PrepareEffect=128]="PrepareEffect",r[r.GetAnimatables=256]="GetAnimatables",r[r.GetActiveTextures=512]="GetActiveTextures",r[r.HasTexture=1024]="HasTexture",r[r.FillRenderTargetTextures=2048]="FillRenderTargetTextures",r[r.HasRenderTargetTextures=4096]="HasRenderTargetTextures",r[r.HardBindForSubMesh=8192]="HardBindForSubMesh",In;var r})();class le{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(1===t||1===e)&&this.markAsDirty(le.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(le.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(le.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new J),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new J),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new J),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(le.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(le.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case le.WireFrameFillMode:case le.LineListDrawMode:case le.LineLoopDrawMode:case le.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?le.WireFrameFillMode:le.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case le.PointFillMode:case le.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?le.PointFillMode:le.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(le.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new J,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new io,this._useUBO=!1,this._fillMode=le.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const n=t||Je.LastCreatedScene;!n||(this._scene=n,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Ie.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Qs(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this.sideOrientation=this._scene.useRightHandedSystem?le.ClockWiseSideOrientation:le.CounterClockWiseSideOrientation,this._uniformBuffer=new He(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),le.OnEventObservable.notifyObservers(this,In.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const n=t.materialDefines;return!!n&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===le.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===le.MATERIAL_OPAQUE||this._transparencyMode===le.MATERIAL_ALPHATEST}needAlphaBlending(){return!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const n of i.subMeshes)n.getMaterial()===this&&(!n.effect||(n.effect._wasPreviouslyReady=!1,n.effect._wasPreviouslyUsingInstances=null,n.effect._forceRebindOnNextCall=e));e&&this.markAsDirty(le.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(null==t?this.sideOrientation:t)===le.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(In.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const n=i.effect;!n||(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),n._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,fe.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(0!==this.depthFunction){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(In.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(In.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(In.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,n){const s=Mi({clipPlane:!1,useInstances:!1},i),a=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const c=a.clipPlane;if(s.clipPlane&&(a.clipPlane=new ss(0,0,0,1)),this._storeEffectOnSubMeshes){let u=!0,h=null;if(e.subMeshes){const d=new nr(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,s.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?h=d.effect.getCompilationError():(u=!1,setTimeout(l,16)))}u&&(this.allowShaderHotSwapping=o,h&&n&&n(h),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);s.clipPlane&&(a.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,n)=>{this.forceCompilation(e,()=>{i()},t,s=>{n(s)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(le._DirtyCallbackArray.length=0,e&le.TextureDirtyFlag&&le._DirtyCallbackArray.push(le._TextureDirtyCallBack),e&le.LightDirtyFlag&&le._DirtyCallbackArray.push(le._LightsDirtyCallBack),e&le.FresnelDirtyFlag&&le._DirtyCallbackArray.push(le._FresnelDirtyCallBack),e&le.AttributesDirtyFlag&&le._DirtyCallbackArray.push(le._AttributeDirtyCallBack),e&le.MiscDirtyFlag&&le._DirtyCallbackArray.push(le._MiscDirtyCallBack),e&le.PrePassDirtyFlag&&le._DirtyCallbackArray.push(le._PrePassDirtyCallBack),le._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(le._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const n of i.subMeshes)if(n.getMaterial(!1)===this)for(const s of n._drawWrappers)!s||!s.defines||!s.defines.markAllAsDirty||this._materialContext===s.materialContext&&e(s.defines)}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(le._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(le._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(le._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(le._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(le._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(le._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(le._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(le._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(le._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(le._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==qs.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const n=this.getScene();if(n.stopAnimation(this),n.freeProcessedMaterials(),n.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(In.Disposed,this._eventInfo),this._parentContainer){const s=this._parentContainer.materials.indexOf(this);s>-1&&this._parentContainer.materials.splice(s,1),this._parentContainer=null}if(!0!==i)if(this.meshMap)for(const s in this.meshMap){const a=this.meshMap[s];a&&(a.material=null,this.releaseVertexArrayObject(a,e))}else{const s=n.meshes;for(const a of s)a.material===this&&!a.sourceMesh&&(a.material=null,this.releaseVertexArrayObject(a,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){if(e.geometry){const i=e.geometry;if(this._storeEffectOnSubMeshes)for(const n of e.subMeshes)i._releaseVertexArrayObject(n.effect),t&&n.effect&&n.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=lt.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}static Parse(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return H.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const s=Ie.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}}le.TriangleFillMode=0,le.WireFrameFillMode=1,le.PointFillMode=2,le.PointListDrawMode=3,le.LineListDrawMode=4,le.LineLoopDrawMode=5,le.LineStripDrawMode=6,le.TriangleStripDrawMode=7,le.TriangleFanDrawMode=8,le.ClockWiseSideOrientation=0,le.CounterClockWiseSideOrientation=1,le.TextureDirtyFlag=1,le.LightDirtyFlag=2,le.FresnelDirtyFlag=4,le.AttributesDirtyFlag=8,le.MiscDirtyFlag=16,le.PrePassDirtyFlag=32,le.AllDirtyFlag=63,le.MATERIAL_OPAQUE=0,le.MATERIAL_ALPHATEST=1,le.MATERIAL_ALPHABLEND=2,le.MATERIAL_ALPHATESTANDBLEND=3,le.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,le.MATERIAL_NORMALBLENDMETHOD_RNM=1,le.OnEventObservable=new J,Je.OnEnginesDisposedObservable.addOnce(()=>{le.OnEventObservable.clear()}),le._AllDirtyCallBack=r=>r.markAllAsDirty(),le._ImageProcessingDirtyCallBack=r=>r.markAsImageProcessingDirty(),le._TextureDirtyCallBack=r=>r.markAsTexturesDirty(),le._FresnelDirtyCallBack=r=>r.markAsFresnelDirty(),le._MiscDirtyCallBack=r=>r.markAsMiscDirty(),le._PrePassDirtyCallBack=r=>r.markAsPrePassDirty(),le._LightsDirtyCallBack=r=>r.markAsLightDirty(),le._AttributeDirtyCallBack=r=>r.markAsAttributesDirty(),le._FresnelAndMiscDirtyCallBack=r=>{le._FresnelDirtyCallBack(r),le._MiscDirtyCallBack(r)},le._TextureAndMiscDirtyCallBack=r=>{le._TextureDirtyCallBack(r),le._MiscDirtyCallBack(r)},le._DirtyCallbackArray=[],le._RunDirtyCallBacks=r=>{for(const e of le._DirtyCallbackArray)e(r)},b([O()],le.prototype,"id",void 0),b([O()],le.prototype,"uniqueId",void 0),b([O()],le.prototype,"name",void 0),b([O()],le.prototype,"metadata",void 0),b([O()],le.prototype,"checkReadyOnEveryCall",void 0),b([O()],le.prototype,"checkReadyOnlyOnce",void 0),b([O()],le.prototype,"state",void 0),b([O("alpha")],le.prototype,"_alpha",void 0),b([O("backFaceCulling")],le.prototype,"_backFaceCulling",void 0),b([O("cullBackFaces")],le.prototype,"_cullBackFaces",void 0),b([O()],le.prototype,"sideOrientation",void 0),b([O("alphaMode")],le.prototype,"_alphaMode",void 0),b([O()],le.prototype,"_needDepthPrePass",void 0),b([O()],le.prototype,"disableDepthWrite",void 0),b([O()],le.prototype,"disableColorWrite",void 0),b([O()],le.prototype,"forceDepthWrite",void 0),b([O()],le.prototype,"depthFunction",void 0),b([O()],le.prototype,"separateCullingPass",void 0),b([O("fogEnabled")],le.prototype,"_fogEnabled",void 0),b([O()],le.prototype,"pointSize",void 0),b([O()],le.prototype,"zOffset",void 0),b([O()],le.prototype,"zOffsetUnits",void 0),b([O()],le.prototype,"pointsCloud",null),b([O()],le.prototype,"fillMode",null),b([O()],le.prototype,"transparencyMode",null);class Vo extends le{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...n)=>{const s=t.apply(e,n);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(n,s)=>{const a=i.apply(e,[n,s]);return this._markAllSubMeshesAsTexturesDirty(),a}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(null===(t=this.subMaterials[i])||void 0===t?void 0:t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let n=0;n<this.subMaterials.length;n++){const s=this.subMaterials[n];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,i))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){const i=new Vo(e,this.getScene());for(let n=0;n<this.subMaterials.length;n++){let s=null;const a=this.subMaterials[n];s=t&&a?a.clone(e+"-"+a.name):this.subMaterials[n],i.subMaterials.push(s)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Gt&&(e.tags=Gt.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const n=this.getScene();if(!n)return;if(i)for(let a=0;a<this.subMaterials.length;a++){const o=this.subMaterials[a];o&&o.dispose(e,t)}const s=n.multiMaterials.indexOf(this);s>=0&&n.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new Vo(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Gt&&Gt.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(n=>i.subMaterials.push(t.getLastMaterialById(n))),i}}ye("BABYLON.MultiMaterial",Vo);class _W{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class qI{}class mW{constructor(){this.visibleInstances={},this.batchCache=new JI,this.batchCacheReplacementModeInFrozenMode=new JI,this.instancesBufferSize=2048}}class JI{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class TW{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class EW{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class U extends hn{static _GetDefaultSideOrientation(e){return e||U.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(I.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(I.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new J),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new J),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new J),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new J),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new J),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return(null!==(e=this._thinInstanceDataStorage.instancesCount)&&void 0!==e?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,n=null,s,a=!0){if(super(e,t),this._internalMeshDataInfo=new EW,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new mW,this._thinInstanceDataStorage=new TW,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=U.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(o,l,c)=>{o&&c&&(this._uniformBuffer?this.transferToEffect(l):c.bindOnlyWorldMatrix(l))},n){if(n._geometry&&n._geometry.applyToMesh(this),Wr.DeepCopy(n,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=n,t.useClonedMeshMap&&(n._internalMeshDataInfo.meshMap||(n._internalMeshDataInfo.meshMap={}),n._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=n._originalBuilderSideOrientation,this._creationDataStorage=n._creationDataStorage,n._ranges){const o=n._ranges;for(const l in o)!Object.prototype.hasOwnProperty.call(o,l)||!o[l]||this.createAnimationRange(l,o[l].from,o[l].to)}if(this.metadata=n.metadata&&n.metadata.clone?n.metadata.clone():n.metadata,this._internalMetadata=n._internalMetadata,Gt&&Gt.HasTags(n)&&Gt.AddTagsTo(this,Gt.GetTags(n,!0)),this.setEnabled(n.isEnabled(!1)),this.parent=n.parent,this.setPivotMatrix(n.getPivotMatrix()),this.id=e+"."+n.id,this.material=n.material,!s){const o=n.getDescendants(!0);for(let l=0;l<o.length;l++){const c=o[l];c.clone&&c.clone(e+"."+c.name,this)}}if(n.morphTargetManager&&(this.morphTargetManager=n.morphTargetManager),t.getPhysicsEngine){const o=t.getPhysicsEngine();if(a&&o)if(1===o.getPluginVersion()){const l=o.getImpostorForPhysicsObject(n);l&&(this.physicsImpostor=l.clone(this))}else 2===o.getPluginVersion()&&n.physicsBody&&n.physicsBody.clone(this)}for(let o=0;o<t.particleSystems.length;o++){const l=t.particleSystems[o];l.emitter===n&&l.clone(l.name,this)}this.skeleton=n.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}null!==i&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=o=>{o.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new J(this._internalMeshDataInfo._onMeshReadyObserverAdded),n&&n.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const n=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));n.parent=e||this.parent,n.position=this.position.clone(),n.scaling=this.scaling.clone(),this.rotationQuaternion?n.rotationQuaternion=this.rotationQuaternion.clone():n.rotation=this.rotation.clone(),i&&i(this,n);for(const s of this.getChildTransformNodes(!0))"InstancedMesh"===s.getClassName()&&"Mesh"===n.getClassName()&&s.sourceMesh===this?s.instantiateHierarchy(n,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:n},i):s.instantiateHierarchy(n,t,i);return n}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),n=this.getVerticesData(I.PositionKind);n&&i&&(t+=", flat shading: "+(n.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return H.Warn("You cannot use a mesh as LOD level twice"),this;const i=new _W(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const n=t._LODLevels[i];if(n.distanceOrScreenCoverage===e)return n.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const n=t||this.getBoundingInfo().boundingSphere,s=e.mode===it.ORTHOGRAPHIC_CAMERA?e.minZ:n.centerWorld.subtract(e.globalPosition).length();let a=s,o=1;if(i._useLODScreenCoverage){let c=n.radiusWorld*e.minZ/s;c=c*c*Math.PI,a=c/e.screenArea,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*a)return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const c=i._LODLevels[l];if(o*c.distanceOrScreenCoverage<o*a){if(c.mesh){if(4===c.mesh.delayLoadState)return c.mesh._checkDelayState(),this;if(2===c.mesh.delayLoadState)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null==this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,n){var s,a;if(!this._geometry)return null;let o=n||null===(a=null===(s=this._userInstancedBuffersStorage)||void 0===s?void 0:s.vertexBuffers[e])||void 0===a?void 0:a.getFloatData(this.instances.length+1,i||t&&1!==this._geometry.meshes.length);return o||(o=this._geometry.getVerticesData(e,t,i)),o}getVertexBuffer(e,t){var i,n;return this._geometry?null!==(n=t||null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])&&void 0!==n?n:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&void 0!==(null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return!!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){const n=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e];if(n)return n.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const i=new Array;return this._delayInfo&&this._delayInfo.forEach(function(n){i.push(n)}),i}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const i in this._userInstancedBuffersStorage.vertexBuffers)-1===t.indexOf(i)&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!=this._masterMesh}isReady(e=!1,t=!1){var i,n,s,a,o,l;if(2===this.delayLoadState||!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length||!e)return!0;const c=this.getEngine(),u=this.getScene(),h=t||c.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const d=this.material||u.defaultMaterial;if(d)if(d._storeEffectOnSubMeshes)for(const p of this.subMeshes){const g=p.getMaterial();if(g)if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,p,h))return!1}else if(!g.isReady(this,h))return!1}else if(!d.isReady(this,h))return!1;const f=c.currentRenderPassId;for(const p of this.lightSources){const g=p.getShadowGenerators();if(!g)continue;const _=g.values();for(let m=_.next();!0!==m.done;m=_.next()){const T=m.value;if(T&&(!(null===(i=T.getShadowMap())||void 0===i?void 0:i.renderList)||(null===(n=T.getShadowMap())||void 0===n?void 0:n.renderList)&&-1!==(null===(a=null===(s=T.getShadowMap())||void 0===s?void 0:s.renderList)||void 0===a?void 0:a.indexOf(this)))){T.getShadowMap()&&(c.currentRenderPassId=T.getShadowMap().renderPassId);for(const v of this.subMeshes)if(!T.isReady(v,h,null!==(l=null===(o=v.getMaterial())||void 0===o?void 0:o.needAlphaBlendingForMesh(this))&&void 0!==l&&l))return c.currentRenderPassId=f,!1;c.currentRenderPassId=f}}}for(const p of this._internalMeshDataInfo._LODLevels)if(p.mesh&&!p.mesh.isReady(h))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const n=i.length;let s=!1;if(e)s=!0;else for(const a of this.subMeshes){if(a.indexStart+a.indexCount>n){s=!0;break}if(a.verticesStart+a.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new nr(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,n=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let s=0;s<e&&!(n>=t);s++)nr.CreateFromIndices(0,n,s===e-1?t-n:i,this),n+=i;this.synchronizeInstances()}setVerticesData(e,t,i=!1,n){if(this._geometry)this._geometry.setVerticesData(e,t,i,n);else{const s=new be;s.set(t,e);const a=this.getScene();new pr(pr.RandomId(),a,s,i,this)}return this}removeVerticesData(e){!this._geometry||this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=pr.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,n){return this._geometry?(n?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(I.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(I.PositionKind,i,!1,!1),t){const n=this.getIndices(),s=this.getVerticesData(I.NormalKind);if(!s)return this;be.ComputeNormals(i,n,s),this.updateVerticesData(I.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(pr.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const n=new be;n.indices=e;const s=this.getScene();new pr(pr.RandomId(),s,n,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,n=!0){if(!this._geometry)return this;const s=this.getScene().getEngine();let a;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)a=null;else switch(this._getRenderingFillMode(i)){case le.PointFillMode:a=null;break;case le.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),s);break;default:a=this._geometry.getIndexBuffer()}return n&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(t,a,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,a),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed||t==le.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==le.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),n=i._isInIntermediateRendering(),s=n?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=this._instanceDataStorage.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=t||!s&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const o=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=n?o.intermediateDefaultRenderId:o.defaultRenderId;a.visibleInstances[e]=o[l],!a.visibleInstances[e]&&c&&(a.visibleInstances[e]=o[c])}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!=a.visibleInstances[e],this._instanceDataStorage.previousBatch=a,a}_renderWithInstances(e,t,i,n,s){var a;const o=i.visibleInstances[e._id],l=o?o.length:0,c=this._instanceDataStorage,u=c.instancesBufferSize;let h=c.instancesBuffer,d=c.instancesPreviousBuffer;const p=16*(l+1)*4;for(;c.instancesBufferSize<p;)c.instancesBufferSize*=2;(!c.instancesData||u!=c.instancesBufferSize)&&(c.instancesData=new Float32Array(c.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousData||u!=c.instancesBufferSize)&&(c.instancesPreviousData=new Float32Array(c.instancesBufferSize/4));let g=0,_=0;const m=i.renderSelf[e._id],T=!h||u!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||c.isFrozen&&!T)_=(m?1:0)+l;else{const v=this.getWorldMatrix();if(m&&(this._scene.needsPreviousWorldMatrices&&(c.masterMeshPreviousWorldMatrix?(c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,g),c.masterMeshPreviousWorldMatrix.copyFrom(v)):(c.masterMeshPreviousWorldMatrix=v.clone(),c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,g))),v.copyToArray(c.instancesData,g),g+=16,_++),o){if(U.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(null===(a=e.getMaterial())||void 0===a?void 0:a.needAlphaBlendingForMesh(e.getRenderingMesh()))){const A=this._scene.activeCamera.globalPosition;for(let S=0;S<o.length;S++){const x=o[S];x._distanceToCamera=E.Distance(x.getBoundingInfo().boundingSphere.centerWorld,A)}o.sort((S,x)=>S._distanceToCamera>x._distanceToCamera?-1:S._distanceToCamera<x._distanceToCamera?1:0)}for(let A=0;A<o.length;A++){const S=o[A],x=S.getWorldMatrix();x.copyToArray(c.instancesData,g),this._scene.needsPreviousWorldMatrices&&(S._previousWorldMatrix?(S._previousWorldMatrix.copyToArray(c.instancesPreviousData,g),S._previousWorldMatrix.copyFrom(x)):(S._previousWorldMatrix=x.clone(),S._previousWorldMatrix.copyToArray(c.instancesPreviousData,g))),g+=16,_++}}}return T?(h&&h.dispose(),d&&d.dispose(),h=new Th(s,c.instancesData,!0,16,!1,!0),c.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new Th(s,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(c.instancesData,0,_),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(c.instancesPreviousData,0,_)),this._processInstancedBuffers(o,m),this.getScene()._activeIndices.addCount(e.indexCount*_,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,n,t),this._draw(e,t,_),this._scene.needsPreviousWorldMatrices&&!T&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(c.instancesData,0,_),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,n){var s,a;const o=null!==(a=null===(s=this._thinInstanceDataStorage)||void 0===s?void 0:s.instancesCount)&&void 0!==a?a:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),n.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,n,s,a,o,l){const c=this.getScene(),u=c.getEngine();if(n=this._getRenderingFillMode(n),a&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,n,i,u),this;if(a)this._renderWithInstances(t,n,s,i,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);let h=0;s.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),h++,this._draw(t,n,this._instanceDataStorage.overridenInstanceCount));const d=s.visibleInstances[t._id];if(d){const f=d.length;h+=f;for(let p=0;p<f;p++){const _=d[p].getWorldMatrix();o&&o(!0,_,l),this._draw(t,n)}}c._activeIndices.addCount(t.indexCount*h,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var n,s,a;const o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const l=this._getInstancesRenderList(e._id,!!i);if(l.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const c=o.getEngine();let u=0,h=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(u=o.activeCamera.maxZ,h=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=l.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,p=this._instanceDataStorage,g=e.getMaterial();if(!g)return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;if(p.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===g){if(g._storeEffectOnSubMeshes&&!(null===(n=e.effect)||void 0===n?void 0:n._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(null===(s=g.getEffect())||void 0===s?void 0:s._wasPreviouslyReady))return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this}else{if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,f))return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this}else if(!g.isReady(this,f))return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}let _;t&&c.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),_=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const m=null!==(a=null==_?void 0:_.effect)&&void 0!==a?a:null;for(const R of o._beforeRenderingMeshStage)R.action(this,e,l,m);if(!_||!m)return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;const T=i||this;let v;if(p.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation)v=p.sideOrientation;else{const R=T._getWorldMatrixDeterminant();v=this.overrideMaterialSideOrientation,null==v&&(v=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),R<0&&(v=v===le.ClockWiseSideOrientation?le.CounterClockWiseSideOrientation:le.ClockWiseSideOrientation),p.sideOrientation=v}const A=this._internalMeshDataInfo._effectiveMaterial._preBind(_,v);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&c.setDepthWrite(!0);const S=this._internalMeshDataInfo._effectiveMaterial,x=S.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,m,x,!1);const C=T.getWorldMatrix();S._storeEffectOnSubMeshes?S.bindForSubMesh(C,this,e):S.bind(C,this),!S.backFaceCulling&&S.separateCullingPass&&(c.setState(!0,S.zOffset,!1,!A,S.cullBackFaces,S.stencil,S.zOffsetUnits),this._processRendering(this,e,m,x,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),c.setState(!0,S.zOffset,!1,A,S.cullBackFaces,S.stencil,S.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,m,x,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const R of o._afterRenderingMeshStage)R.action(this,e,l,m);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=u,o.updateTransformMatrix(!0)),o.performancePriority===qs.Aggressive&&!p.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(I.MatricesWeightsKind)&&(this.isVerticesDataPresent(I.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(I.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const n=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===n)e[i]=1;else{const s=1/n;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(I.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(I.MatricesWeightsExtraKind),t=this.getVerticesData(I.MatricesWeightsKind),i=t.length;for(let n=0;n<i;n+=4){let s=t[n]+t[n+1]+t[n+2]+t[n+3];if(s+=e[n]+e[n+1]+e[n+2]+e[n+3],0===s)t[n]=1;else{const a=1/s;t[n]*=a,t[n+1]*=a,t[n+2]*=a,t[n+3]*=a,e[n]*=a,e[n+1]*=a,e[n+2]*=a,e[n+3]*=a}}this.setVerticesData(I.MatricesWeightsKind,t),this.setVerticesData(I.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(I.MatricesWeightsExtraKind),t=this.getVerticesData(I.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let n=0,s=0,a=0,o=0;const l=null===e?4:8,c=new Array;for(let _=0;_<=l;_++)c[_]=0;for(let _=0;_<i;_+=4){let m=t[_],T=m,v=0===T?0:1;for(let A=1;A<l;A++){const S=A<4?t[_+A]:e[_+A-4];S>m&&n++,0!==S&&v++,T+=S,m=S}if(c[v]++,v>a&&(a=v),0===T)s++;else{const A=1/T;let S=0;for(let x=0;x<l;x++)S+=x<4?Math.abs(t[_+x]-t[_+x]*A):Math.abs(e[_+x-4]-e[_+x-4]*A);S>.001&&o++}}const h=this.skeleton.bones.length,d=this.getVerticesData(I.MatricesIndicesKind),f=this.getVerticesData(I.MatricesIndicesExtraKind);let p=0;for(let _=0;_<i;_+=4)for(let m=0;m<l;m++){const T=m<4?d[_+m]:f[_+m-4];(T>=h||T<0)&&p++}return{skinned:!0,valid:0===s&&0===o&&0===p,report:"Number of Weights = "+i/4+"\nMaximum influences = "+a+"\nMissing Weights = "+s+"\nNot Sorted = "+n+"\nNot Normalized = "+o+"\nWeightCounts = ["+c+"]\nNumber of bones = "+h+"\nBad Bone Indices = "+p}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return Ie.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(n=>{n.refreshBoundingInfo(),n._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return!(2===this.delayLoadState||!super.isInFrustum(e)||(this._checkDelayState(),0))}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const n=this.getScene().multiMaterials;for(i=n.length-1;i>-1;i--)if(n[i].id===e)return this.material=n[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(I.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(I.PositionKind);const n=E.Zero();let s;for(s=0;s<i.length;s+=3)E.TransformCoordinatesFromFloatsToRef(i[s],i[s+1],i[s+2],e,n).toArray(i,s);if(this.setVerticesData(I.PositionKind,i,this.getVertexBuffer(I.PositionKind).isUpdatable()),this.isVerticesDataPresent(I.NormalKind)){for(i=this.getVerticesData(I.NormalKind),s=0;s<i.length;s+=3)E.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,n).normalize().toArray(i,s);this.setVerticesData(I.NormalKind,i,this.getVertexBuffer(I.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,n=!0){return new U(e,this.getScene(),t,this,i,n)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const n in i.meshMap){const s=i.meshMap[n];s&&(s._internalMeshDataInfo._source=null,i.meshMap[n]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const n=this.getScene().meshes;for(const s of n){const a=s;a._internalMeshDataInfo&&a._internalMeshDataInfo._source&&a._internalMeshDataInfo._source===this&&(a._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,n,s,a,o=!1){const l=this.getScene();return Ie.LoadImage(e,u=>{const h=u.width,d=u.height,p=this.getEngine().createCanvas(h,d).getContext("2d");p.drawImage(u,0,0);const g=p.getImageData(0,0,h,d).data;this.applyDisplacementMapFromBuffer(g,h,d,t,i,s,a,o),n&&n(this)},()=>{},l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,n,s,a,o,l=!1){if(!this.isVerticesDataPresent(I.PositionKind)||!this.isVerticesDataPresent(I.NormalKind)||!this.isVerticesDataPresent(I.UVKind))return H.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(I.PositionKind,!0,!0),u=this.getVerticesData(I.NormalKind),h=this.getVerticesData(I.UVKind);let d=E.Zero();const f=E.Zero(),p=We.Zero();a=a||We.Zero(),o=o||new We(1,1);for(let g=0;g<c.length;g+=3){E.FromArrayToRef(c,g,d),E.FromArrayToRef(u,g,f),We.FromArrayToRef(h,g/3*2,p);const T=4*((Math.abs(p.x*o.x+a.x%1)*(t-1)%t|0)+(Math.abs(p.y*o.y+a.y%1)*(i-1)%i|0)*t),x=e[T]/255*.3+e[T+1]/255*.59+e[T+2]/255*.11;f.normalize(),f.scaleInPlace(n+(s-n)*x),d=d.add(f),d.toArray(c,g)}return be.ComputeNormals(c,this.getIndices(),u),l?(this.setVerticesData(I.PositionKind,c),this.setVerticesData(I.NormalKind,u),this.setVerticesData(I.UVKind,h)):(this.updateVerticesData(I.PositionKind,c),this.updateVerticesData(I.NormalKind,u)),this}convertToFlatShadedMesh(){const e=this.getVerticesDataKinds(),t={},i={},n={};let a,o,s=!1;for(a=0;a<e.length;a++){o=e[a];const _=this.getVertexBuffer(o),m=_.getData();if(!(m instanceof Array||m instanceof Float32Array)||0!==m.length){if(o===I.NormalKind){s=_.isUpdatable(),e.splice(a,1),a--;continue}t[o]=_,i[o]=this.getVerticesData(o),n[o]=[]}}const l=this.subMeshes.slice(0),c=this.getIndices(),u=this.getTotalIndices();let h;for(h=0;h<u;h++){const _=c[h];for(a=0;a<e.length;a++){if(o=e[a],!t[o])continue;const m=t[o].getStrideSize();for(let T=0;T<m;T++)n[o].push(i[o][_*m+T])}}const d=[],f=n[I.PositionKind];let g;for(g=this.getScene().useRightHandedSystem?1===this.overrideMaterialSideOrientation:0===this.overrideMaterialSideOrientation,h=0;h<u;h+=3){c[h]=h,c[h+1]=h+1,c[h+2]=h+2;const _=E.FromArray(f,3*h),m=E.FromArray(f,3*(h+1)),T=E.FromArray(f,3*(h+2)),v=_.subtract(m),A=T.subtract(m),S=E.Normalize(E.Cross(v,A));g&&S.scaleInPlace(-1);for(let x=0;x<3;x++)d.push(S.x),d.push(S.y),d.push(S.z)}for(this.setIndices(c),this.setVerticesData(I.NormalKind,d,s),a=0;a<e.length;a++)o=e[a],n[o]&&this.setVerticesData(o,n[o],t[o].isUpdatable());this.releaseSubMeshes();for(let _=0;_<l.length;_++){const m=l[_];nr.AddToMesh(m.materialIndex,m.indexStart,m.indexCount,m.indexStart,m.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const e=this.getVerticesDataKinds(),t={},i={},n={};let s,a;for(s=0;s<e.length;s++){a=e[s];const h=this.getVertexBuffer(a);t[a]=h,i[a]=t[a].getData(),n[a]=[]}const o=this.subMeshes.slice(0),l=this.getIndices(),c=this.getTotalIndices();let u;for(u=0;u<c;u++){const h=l[u];for(s=0;s<e.length;s++){a=e[s];const d=t[a].getStrideSize();for(let f=0;f<d;f++)n[a].push(i[a][h*d+f])}}for(u=0;u<c;u+=3)l[u]=u,l[u+1]=u+1,l[u+2]=u+2;for(this.setIndices(l),s=0;s<e.length;s++)a=e[s],this.setVerticesData(a,n[a],t[a].isUpdatable(),t[a].getStrideSize());this.releaseSubMeshes();for(let h=0;h<o.length;h++){const d=o[h];nr.AddToMesh(d.materialIndex,d.indexStart,d.indexCount,d.indexStart,d.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){const t=be.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(I.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let n;for(i=0;i<t.indices.length;i+=3)n=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=n}return t.applyToMesh(this,this.isVertexBufferUpdatable(I.PositionKind)),this}increaseVertices(e=1){const t=be.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,n=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,a=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&n){t.indices=i,t.positions=n,s&&(t.uvs=s),a&&(t.normals=a);const o=e+1,l=new Array;for(let S=0;S<o+1;S++)l[S]=new Array;let c,u;const h=new E(0,0,0),d=new E(0,0,0),f=new We(0,0),p=new Array,g=new Array,_=new Array;let m,v,A,T=n.length;s&&(v=s.length),a&&(A=a.length);for(let S=0;S<i.length;S+=3){g[0]=i[S],g[1]=i[S+1],g[2]=i[S+2];for(let x=0;x<3;x++)if(c=g[x],u=g[(x+1)%3],void 0===_[c]&&void 0===_[u]?(_[c]=new Array,_[u]=new Array):(void 0===_[c]&&(_[c]=new Array),void 0===_[u]&&(_[u]=new Array)),void 0===_[c][u]&&void 0===_[u][c]){_[c][u]=[],h.x=(n[3*u]-n[3*c])/o,h.y=(n[3*u+1]-n[3*c+1])/o,h.z=(n[3*u+2]-n[3*c+2])/o,a&&(d.x=(a[3*u]-a[3*c])/o,d.y=(a[3*u+1]-a[3*c+1])/o,d.z=(a[3*u+2]-a[3*c+2])/o),s&&(f.x=(s[2*u]-s[2*c])/o,f.y=(s[2*u+1]-s[2*c+1])/o),_[c][u].push(c);for(let C=1;C<o;C++)_[c][u].push(n.length/3),n[T++]=n[3*c]+C*h.x,n[T++]=n[3*c+1]+C*h.y,n[T++]=n[3*c+2]+C*h.z,a&&(a[A++]=a[3*c]+C*d.x,a[A++]=a[3*c+1]+C*d.y,a[A++]=a[3*c+2]+C*d.z),s&&(s[v++]=s[2*c]+C*f.x,s[v++]=s[2*c+1]+C*f.y);_[c][u].push(u),_[u][c]=new Array,m=_[c][u].length;for(let C=0;C<m;C++)_[u][c][C]=_[c][u][m-1-C]}l[0][0]=i[S],l[1][0]=_[i[S]][i[S+1]][1],l[1][1]=_[i[S]][i[S+2]][1];for(let x=2;x<o;x++){l[x][0]=_[i[S]][i[S+1]][x],l[x][x]=_[i[S]][i[S+2]][x],h.x=(n[3*l[x][x]]-n[3*l[x][0]])/x,h.y=(n[3*l[x][x]+1]-n[3*l[x][0]+1])/x,h.z=(n[3*l[x][x]+2]-n[3*l[x][0]+2])/x,a&&(d.x=(a[3*l[x][x]]-a[3*l[x][0]])/x,d.y=(a[3*l[x][x]+1]-a[3*l[x][0]+1])/x,d.z=(a[3*l[x][x]+2]-a[3*l[x][0]+2])/x),s&&(f.x=(s[2*l[x][x]]-s[2*l[x][0]])/x,f.y=(s[2*l[x][x]+1]-s[2*l[x][0]+1])/x);for(let C=1;C<x;C++)l[x][C]=n.length/3,n[T++]=n[3*l[x][0]]+C*h.x,n[T++]=n[3*l[x][0]+1]+C*h.y,n[T++]=n[3*l[x][0]+2]+C*h.z,a&&(a[A++]=a[3*l[x][0]]+C*d.x,a[A++]=a[3*l[x][0]+1]+C*d.y,a[A++]=a[3*l[x][0]+2]+C*d.z),s&&(s[v++]=s[2*l[x][0]]+C*f.x,s[v++]=s[2*l[x][0]+1]+C*f.y)}l[o]=_[i[S+1]][i[S+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let x=1;x<o;x++){let C;for(C=0;C<x;C++)p.push(l[x][C],l[x+1][C],l[x+1][C+1]),p.push(l[x][C],l[x+1][C+1],l[x][C+1]);p.push(l[x][C],l[x+1][C],l[x+1][C+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(I.PositionKind))}else H.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=be.ExtractFromMesh(this),t=e.uvs,i=e.indices,n=e.positions,s=e.colors,a=e.matricesIndices,o=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(void 0===i||void 0===n||null===i||null===n)H.Warn("VertexData contains empty entries");else{const u=new Array,h=new Array,d=new Array,f=new Array,p=new Array,g=new Array,_=new Array,m=new Array;let T=new Array,v=0;const A={};let S,x;for(let R=0;R<i.length;R+=3){x=[i[R],i[R+1],i[R+2]],T=new Array;for(let D=0;D<3;D++){T[D]="";for(let P=0;P<3;P++)Math.abs(n[3*x[D]+P])<1e-8&&(n[3*x[D]+P]=0),T[D]+=n[3*x[D]+P]+"|"}if(T[0]!=T[1]&&T[0]!=T[2]&&T[1]!=T[2])for(let D=0;D<3;D++){if(S=A[T[D]],void 0===S){A[T[D]]=v,S=v++;for(let P=0;P<3;P++)u.push(n[3*x[D]+P]);if(null!=s)for(let P=0;P<4;P++)f.push(s[4*x[D]+P]);if(null!=t)for(let P=0;P<2;P++)d.push(t[2*x[D]+P]);if(null!=a)for(let P=0;P<4;P++)p.push(a[4*x[D]+P]);if(null!=o)for(let P=0;P<4;P++)g.push(o[4*x[D]+P]);if(null!=l)for(let P=0;P<4;P++)_.push(l[4*x[D]+P]);if(null!=c)for(let P=0;P<4;P++)m.push(c[4*x[D]+P])}h.push(S)}}const C=new Array;be.ComputeNormals(u,h,C),e.positions=u,e.indices=h,e.normals=C,null!=t&&(e.uvs=d),null!=s&&(e.colors=f),null!=a&&(e.matricesIndices=p),null!=o&&(e.matricesWeights=g),null!=l&&(e.matricesIndicesExtra=_),null!=o&&(e.matricesWeightsExtra=m),e.applyToMesh(this,this.isVertexBufferUpdatable(I.PositionKind))}}static _instancedMeshFactory(e,t){throw ht("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw ht("PhysicsImpostor")}createInstance(e){return U._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(I.PositionKind);if(!i||!t)return this;const n=new Array;for(let a=0;a<i.length;a+=3)n.push(E.FromArray(i,a));const s=new Array;return Is.SyncAsyncForLoop(n.length,40,a=>{const o=n.length-1-a,l=n[o];for(let c=0;c<o;++c)if(l.equals(n[c])){s[o]=c;break}},()=>{for(let o=0;o<t.length;++o)t[o]=s[t[o]]||t[o];const a=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=a,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Gt&&Gt.HasTags(this)&&(e.tags=Gt.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const n=this.subMeshes[i];e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Bi.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const n=this.instances[i];if(n.doNotSerialize)continue;const s={name:n.name,id:n.id,isEnabled:n.isEnabled(!1),isVisible:n.isVisible,isPickable:n.isPickable,checkCollisions:n.checkCollisions,position:n.position.asArray(),scaling:n.scaling.asArray()};if(n.parent&&n.parent._serializeAsParent(s),n.rotationQuaternion?s.rotationQuaternion=n.rotationQuaternion.asArray():n.rotation&&(s.rotation=n.rotation.asArray()),this.getScene()._getComponent(Bi.NAME_PHYSICSENGINE)){const a=n.getPhysicsImpostor();a&&(s.physicsMass=a.getParam("mass"),s.physicsFriction=a.getParam("friction"),s.physicsRestitution=a.getParam("mass"),s.physicsImpostor=a.type)}n.metadata&&(s.metadata=n.metadata),n.actionManager&&(s.actions=n.actionManager.serialize(n.name)),e.instances.push(s),lt.AppendSerializedAnimations(n,s),s.ranges=n.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const n in this._userThinInstanceBuffersStorage.data)i.data[n]=Array.from(this._userThinInstanceBuffersStorage.data[n]),i.sizes[n]=this._userThinInstanceBuffersStorage.sizes[n],i.strides[n]=this._userThinInstanceBuffersStorage.strides[n];e.thinInstances.userThinInstance=i}return lt.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return H.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),n=i.getPositions();if(!n)return void H.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(I.PositionKind+t,n,!1,3);const s=i.getNormals();s&&this.geometry.setVerticesData(I.NormalKind+t,s,!1,3);const a=i.getTangents();a&&this.geometry.setVerticesData(I.TangentKind+t,a,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(I.UVKind+"_"+t,o,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(I.PositionKind+t);)this.geometry.removeVerticesData(I.PositionKind+t),this.geometry.isVerticesDataPresent(I.NormalKind+t)&&this.geometry.removeVerticesData(I.NormalKind+t),this.geometry.isVerticesDataPresent(I.TangentKind+t)&&this.geometry.removeVerticesData(I.TangentKind+t),this.geometry.isVerticesDataPresent(I.UVKind+t)&&this.geometry.removeVerticesData(I.UVKind+"_"+t),t++}}static Parse(e,t,i){let n;if(n=e.type&&"LinesMesh"===e.type?U._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?U._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?U._GoldbergMeshParser(e,t):new U(e.name,t),n.id=e.id,n._waitingParsedUniqueId=e.uniqueId,Gt&&Gt.AddTagsTo(n,e.tags),n.position=E.FromArray(e.position),void 0!==e.metadata&&(n.metadata=e.metadata),e.rotationQuaternion?n.rotationQuaternion=Be.FromArray(e.rotationQuaternion):e.rotation&&(n.rotation=E.FromArray(e.rotation)),n.scaling=E.FromArray(e.scaling),e.localMatrix?n.setPreTransformMatrix(B.FromArray(e.localMatrix)):e.pivotMatrix&&n.setPivotMatrix(B.FromArray(e.pivotMatrix)),n.setEnabled(e.isEnabled),n.isVisible=e.isVisible,n.infiniteDistance=e.infiniteDistance,n.showBoundingBox=e.showBoundingBox,n.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(n.applyFog=e.applyFog),void 0!==e.pickable&&(n.isPickable=e.pickable),void 0!==e.alphaIndex&&(n.alphaIndex=e.alphaIndex),n.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(n.billboardMode=e.billboardMode),void 0!==e.visibility&&(n.visibility=e.visibility),n.checkCollisions=e.checkCollisions,n.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,void 0!==e.isBlocker&&(n.isBlocker=e.isBlocker),n._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(n._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(n._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(n._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(n.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(n.overlayColor=Fe.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(n.renderOverlay=e.renderOverlay),n.isUnIndexed=!!e.isUnIndexed,n.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=i+e.delayLoadingFile,n.buildBoundingInfo(E.FromArray(e.boundingBoxMinimum),E.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(n._binaryInfo=e._binaryInfo),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(I.UVKind),e.hasUVs2&&n._delayInfo.push(I.UV2Kind),e.hasUVs3&&n._delayInfo.push(I.UV3Kind),e.hasUVs4&&n._delayInfo.push(I.UV4Kind),e.hasUVs5&&n._delayInfo.push(I.UV5Kind),e.hasUVs6&&n._delayInfo.push(I.UV6Kind),e.hasColors&&n._delayInfo.push(I.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(I.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(I.MatricesWeightsKind),n._delayLoadingFunction=pr._ImportGeometry,ya.ForceFullSceneLoadingForIncremental&&n._checkDelayState()):pr._ImportGeometry(e,n),e.materialUniqueId?n._waitingMaterialId=e.materialUniqueId:e.materialId&&(n._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(n.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),null!=e.skeletonId&&(n.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(n.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=zr("BABYLON.Animation");o&&n.animations.push(o.Parse(a))}$i.ParseAnimationRanges(n,e,t)}if(e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),n.layerMask=e.layerMask&&!isNaN(e.layerMask)?Math.abs(parseInt(e.layerMask)):268435455,e.physicsImpostor&&U._PhysicsImpostorParser(t,n,e),e.lodMeshIds&&(n._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){const a=e.instances[s],o=n.createInstance(a.name);if(a.id&&(o.id=a.id),Gt&&Gt.AddTagsTo(o,a.tags?a.tags:e.tags),o.position=E.FromArray(a.position),void 0!==a.metadata&&(o.metadata=a.metadata),void 0!==a.parentId&&(o._waitingParentId=a.parentId),void 0!==a.parentInstanceIndex&&(o._waitingParentInstanceIndex=a.parentInstanceIndex),null!=a.isEnabled&&o.setEnabled(a.isEnabled),null!=a.isVisible&&(o.isVisible=a.isVisible),null!=a.isPickable&&(o.isPickable=a.isPickable),a.rotationQuaternion?o.rotationQuaternion=Be.FromArray(a.rotationQuaternion):a.rotation&&(o.rotation=E.FromArray(a.rotation)),o.scaling=E.FromArray(a.scaling),null!=a.checkCollisions&&null!=a.checkCollisions&&(o.checkCollisions=a.checkCollisions),null!=a.pickable&&null!=a.pickable&&(o.isPickable=a.pickable),null!=a.showBoundingBox&&null!=a.showBoundingBox&&(o.showBoundingBox=a.showBoundingBox),null!=a.showSubMeshesBoundingBox&&null!=a.showSubMeshesBoundingBox&&(o.showSubMeshesBoundingBox=a.showSubMeshesBoundingBox),null!=a.alphaIndex&&null!=a.showSubMeshesBoundingBox&&(o.alphaIndex=a.alphaIndex),a.physicsImpostor&&U._PhysicsImpostorParser(t,o,a),void 0!==a.actions&&(o._waitingData.actions=a.actions),a.animations){for(let l=0;l<a.animations.length;l++){const c=a.animations[l],u=zr("BABYLON.Animation");u&&o.animations.push(u.Parse(c))}$i.ParseAnimationRanges(o,a,t),a.autoAnimate&&t.beginAnimation(o,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1)}}if(e.thinInstances){const s=e.thinInstances;if(n.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(n.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),n._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,n._thinInstanceDataStorage.instancesCount=s.instancesCount):n._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){const a=e.thinInstances.userThinInstance;for(const o in a.data)n.thinInstanceSetBuffer(o,new Float32Array(a.data[o]),a.strides[o],!1),n._userThinInstanceBuffersStorage.sizes[o]=a.sizes[o]}}return n}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(I.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(I.PositionKind)||this.setVerticesData(I.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(I.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(I.NormalKind)||this.setVerticesData(I.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(I.PositionKind))return this;if(!this.isVerticesDataPresent(I.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(I.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(I.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const m=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=m}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let n=this.getVerticesData(I.PositionKind);if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n));let s=this.getVerticesData(I.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}const a=this.getVerticesData(I.MatricesIndicesKind),o=this.getVerticesData(I.MatricesWeightsKind);if(!o||!a)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(I.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(I.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),d=E.Zero(),f=new B,p=new B;let _,g=0;for(let m=0;m<n.length;m+=3,g+=4){let T;for(_=0;_<4;_++)T=o[g+_],T>0&&(B.FromFloat32ArrayToRefScaled(h,Math.floor(16*a[g+_]),T,p),f.addToSelf(p));if(l)for(_=0;_<4;_++)T=u[g+_],T>0&&(B.FromFloat32ArrayToRefScaled(h,Math.floor(16*c[g+_]),T,p),f.addToSelf(p));E.TransformCoordinatesFromFloatsToRef(i._sourcePositions[m],i._sourcePositions[m+1],i._sourcePositions[m+2],f,d),d.toArray(n,m),t&&(E.TransformNormalFromFloatsToRef(i._sourceNormals[m],i._sourceNormals[m+1],i._sourceNormals[m+2],f,d),d.toArray(s,m)),f.reset()}return this.updateVerticesData(I.PositionKind,n),t&&this.updateVerticesData(I.NormalKind,s),this}static MinMax(e){let t=null,i=null;return e.forEach(function(n){const a=n.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(a.minimumWorld),i.maximizeInPlace(a.maximumWorld)):(t=a.minimumWorld,i=a.maximumWorld)}),t&&i?{min:t,max:i}:{min:E.Zero(),max:E.Zero()}}static Center(e){const t=e instanceof Array?U.MinMax(e):e;return E.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,n,s,a){return ET(U._MergeMeshesCoroutine(e,t,i,n,s,a,!1))}static MergeMeshesAsync(e,t=!0,i,n,s,a){return function QI(r,e,t){return new Promise((i,n)=>{KI(r,e,i,n,t)})}(U._MergeMeshesCoroutine(e,t,i,n,s,a,!0),function lW(r=25){let e;return(t,i,n)=>{const s=performance.now();void 0===e||s-e>r?(e=s,setTimeout(()=>{TT(t,i,n)},0)):TT(t,i,n)}}())}static*_MergeMeshesCoroutine(e,t=!0,i,n,s,a,o){if(0===(e=e.filter(Boolean)).length)return null;let l;if(!i){let C=0;for(l=0;l<e.length;l++)if(C+=e[l].getTotalVertices(),C>=65536)return H.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}a&&(s=!1);const c=new Array,u=new Array,h=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const C=e[l];if(C.isAnInstance)return H.Warn("Cannot merge instance meshes."),null;if(d!==C.overrideMaterialSideOrientation)return H.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(s&&h.push(C.getTotalIndices()),a)if(C.material){const R=C.material;if(R instanceof Vo){for(let D=0;D<R.subMaterials.length;D++)c.indexOf(R.subMaterials[D])<0&&c.push(R.subMaterials[D]);for(let D=0;D<C.subMeshes.length;D++)u.push(c.indexOf(R.subMaterials[C.subMeshes[D].materialIndex])),h.push(C.subMeshes[D].indexCount)}else{c.indexOf(R)<0&&c.push(R);for(let D=0;D<C.subMeshes.length;D++)u.push(c.indexOf(R)),h.push(C.subMeshes[D].indexCount)}}else for(let R=0;R<C.subMeshes.length;R++)u.push(0),h.push(C.subMeshes[R].indexCount)}const f=e[0],p=C=>{const R=C.computeWorldMatrix(!0);return{vertexData:be.ExtractFromMesh(C,!1,!1),transform:R}},{vertexData:g,transform:_}=p(f);o&&(yield);const m=new Array(e.length-1);for(let C=1;C<e.length;C++)m[C-1]=p(e[C]),o&&(yield);const T=g._mergeCoroutine(_,m,i,o,!t);let v=T.next();for(;!v.done;)o&&(yield),v=T.next();const A=v.value;n||(n=new U(f.name+"_merged",f.getScene()));const S=A._applyToCoroutine(n,void 0,o);let x=S.next();for(;!x.done;)o&&(yield),x=S.next();if(n.checkCollisions=f.checkCollisions,n.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||a){n.releaseSubMeshes(),l=0;let C=0;for(;l<h.length;)nr.CreateFromIndices(0,C,h[l],n,void 0,!1),C+=h[l],l++;for(const R of n.subMeshes)R.refreshBoundingInfo();n.computeWorldMatrix(!0)}if(a){const C=new Vo(f.name+"_merged",f.getScene());C.subMaterials=c;for(let R=0;R<n.subMeshes.length;R++)n.subMeshes[R].materialIndex=u[R];n.material=C}else n.material=f.material;return n}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===le.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?le.PointFillMode:i.forceWireframe?le.WireFrameFillMode:null!==(t=this.overrideRenderingFillMode)&&void 0!==t?t:e}}U.FRONTSIDE=be.FRONTSIDE,U.BACKSIDE=be.BACKSIDE,U.DOUBLESIDE=be.DOUBLESIDE,U.DEFAULTSIDE=be.DEFAULTSIDE,U.NO_CAP=0,U.CAP_START=1,U.CAP_END=2,U.CAP_ALL=3,U.NO_FLIP=0,U.FLIP_TILE=1,U.ROTATE_TILE=2,U.FLIP_ROW=3,U.ROTATE_ROW=4,U.FLIP_N_ROTATE_TILE=5,U.FLIP_N_ROTATE_ROW=6,U.CENTER=0,U.LEFT=1,U.RIGHT=2,U.TOP=3,U.BOTTOM=4,U.INSTANCEDMESH_SORT_TRANSPARENT=!1,U._GroundMeshParser=(r,e)=>{throw ht("GroundMesh")},U._GoldbergMeshParser=(r,e)=>{throw ht("GoldbergMesh")},U._LinesMeshParser=(r,e)=>{throw ht("LinesMesh")},ye("BABYLON.Mesh",U),U.prototype.setMaterialByID=function(r){return this.setMaterialById(r)},U.CreateDisc=U.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateBox=U.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateSphere=U.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateCylinder=U.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateTorusKnot=U.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateTorus=U.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreatePlane=U.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateGround=U.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateTiledGround=U.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateGroundFromHeightMap=U.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateTube=U.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreatePolyhedron=U.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateIcoSphere=U.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateDecal=U.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.CreateCapsule=U.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")}),U.ExtendToGoldberg=U.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});class vh extends le{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new B,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}_isReadyForSubMesh(e){const t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){!t||this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}const AT={effect:null,subMesh:null};class ba extends vh{constructor(e,t,i,n={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new B,this._cachedWorldViewProjectionMatrix=new B,this._multiview=!1,this._shaderPath=i,this._options=Mi({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},n)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,n)=>(n.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,n)=>(n.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,n)=>(n.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(16*t.length);for(let n=0;n<t.length;n++)t[n].copyToArray(i,16*n);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var n,s,a,o;const l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const D=this._drawWrapper.effect;if(D&&D._wasPreviouslyReady&&D._wasPreviouslyUsingInstances===t)return!0}const c=this.getScene(),u=c.getEngine(),h=[],d=[],f=new xl;let p=this._shaderPath,g=this._options.uniforms,_=this._options.uniformBuffers,m=this._options.samplers;u.getCaps().multiview&&c.activeCamera&&c.activeCamera.outputRenderTarget&&c.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,h.push("#define MULTIVIEW"),-1!==this._options.uniforms.indexOf("viewProjection")&&-1===this._options.uniforms.indexOf("viewProjectionR")&&this._options.uniforms.push("viewProjectionR"));for(let D=0;D<this._options.defines.length;D++){const P=0===this._options.defines[D].indexOf("#define")?this._options.defines[D]:`#define ${this._options.defines[D]}`;h.push(P)}for(let D=0;D<this._options.attributes.length;D++)d.push(this._options.attributes[D]);if(e&&e.isVerticesDataPresent(I.ColorKind)&&(d.push(I.ColorKind),h.push("#define VERTEXCOLOR")),t&&(h.push("#define INSTANCES"),fe.PushAttributesForInstances(d),(null==e?void 0:e.hasThinInstances)&&(h.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(I.ColorInstanceKind)&&(d.push(I.ColorInstanceKind),h.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(I.MatricesIndicesKind),d.push(I.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(I.MatricesIndicesExtraKind),d.push(I.MatricesWeightsExtraKind));const D=e.skeleton;h.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),f.addCPUSkinningFallback(0,e),D.isUsingTextureForMatrices?(h.push("#define BONETEXTURE"),-1===this._options.uniforms.indexOf("boneTextureWidth")&&this._options.uniforms.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(h.push("#define BonesPerMesh "+(D.bones.length+1)),-1===this._options.uniforms.indexOf("mBones")&&this._options.uniforms.push("mBones"))}else h.push("#define NUM_BONE_INFLUENCERS 0");let T=0;const v=e?e.morphTargetManager:null;if(v){const D=v.supportsUVs&&-1!==h.indexOf("#define UV1"),P=v.supportsTangents&&-1!==h.indexOf("#define TANGENT"),N=v.supportsNormals&&-1!==h.indexOf("#define NORMAL");T=v.numInfluencers,D&&h.push("#define MORPHTARGETS_UV"),P&&h.push("#define MORPHTARGETS_TANGENT"),N&&h.push("#define MORPHTARGETS_NORMAL"),T>0&&h.push("#define MORPHTARGETS"),v.isUsingTextureForTargets&&(h.push("#define MORPHTARGETS_TEXTURE"),-1===this._options.uniforms.indexOf("morphTargetTextureIndices")&&this._options.uniforms.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),h.push("#define NUM_MORPH_INFLUENCERS "+T);for(let k=0;k<T;k++)d.push(I.PositionKind+k),N&&d.push(I.NormalKind+k),P&&d.push(I.TangentKind+k),D&&d.push(I.UVKind+"_"+k);T>0&&(g=g.slice(),g.push("morphTargetInfluences"),g.push("morphTargetTextureInfo"),g.push("morphTargetTextureIndices"))}else h.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const D=e.bakedVertexAnimationManager;D&&D.isEnabled&&(h.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===this._options.uniforms.indexOf("bakedVertexAnimationSettings")&&this._options.uniforms.push("bakedVertexAnimationSettings"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTime")&&this._options.uniforms.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),fe.PrepareAttributesForBakedVertexAnimation(d,e,h)}for(const D in this._textures)if(!this._textures[D].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&h.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&(Sl(g),kf(this,c,h)),this.customShaderNameResolve&&(g=g.slice(),_=_.slice(),m=m.slice(),p=this.customShaderNameResolve(p,g,_,m,h,d));const A=l?i._getDrawWrapper():this._drawWrapper,S=null!==(n=null==A?void 0:A.effect)&&void 0!==n?n:null,x=null!==(s=null==A?void 0:A.defines)&&void 0!==s?s:null,C=h.join("\n");let R=S;return x!==C&&(R=u.createEffect(p,{attributes:d,uniformsNames:g,uniformBuffersNames:_,samplers:m,defines:C,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:T},shaderLanguage:this._options.shaderLanguage},u),l?i.setEffect(R,C,this._materialContext):A&&A.setEffect(R,C),this._onEffectCreatedObservable&&(AT.effect=R,AT.subMesh=null!==(a=null!=i?i:null==e?void 0:e.subMeshes[0])&&void 0!==a?a:null,this._onEffectCreatedObservable.notifyObservers(AT))),R._wasPreviouslyUsingInstances=!!t,null!==(o=!(null==R?void 0:R.isReady()))&&void 0!==o&&!o&&(S!==R&&c.resetCachedMaterial(),R._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),n=null!=t?t:this.getEffect();!n||(-1!==this._options.uniforms.indexOf("world")&&n.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),n.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),n.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var n;this.bind(e,t,null===(n=i._drawWrapperOverride)||void 0===n?void 0:n.effect,i)}bind(e,t,i,n){var s;const a=n&&this._storeEffectOnSubMeshes,o=null!=i?i:a?n.effect:this.getEffect();if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let c=!1;if(o&&l&&l.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let h=0;h<l.length;++h)switch(l[h]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":fe.BindSceneUniformBuffer(o,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),c=!0}const u=t&&a?this._mustRebind(this.getScene(),o,t.visibility):this.getScene().getCachedMaterial()!==this;if(o&&u){let h;for(h in!c&&-1!==this._options.uniforms.indexOf("view")&&o.setMatrix("view",this.getScene().getViewMatrix()),!c&&-1!==this._options.uniforms.indexOf("projection")&&o.setMatrix("projection",this.getScene().getProjectionMatrix()),!c&&-1!==this._options.uniforms.indexOf("viewProjection")&&(o.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&o.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),fe.BindBonesParameters(t,o),Uo(o,this,this.getScene()),this._textures)o.setTexture(h,this._textures[h]);for(h in this._textureArrays)o.setTextureArray(h,this._textureArrays[h]);for(h in this._externalTextures)o.setExternalTexture(h,this._externalTextures[h]);for(h in this._ints)o.setInt(h,this._ints[h]);for(h in this._uints)o.setUInt(h,this._uints[h]);for(h in this._floats)o.setFloat(h,this._floats[h]);for(h in this._floatsArrays)o.setArray(h,this._floatsArrays[h]);for(h in this._colors3)o.setColor3(h,this._colors3[h]);for(h in this._colors3Arrays)o.setArray3(h,this._colors3Arrays[h]);for(h in this._colors4){const d=this._colors4[h];o.setFloat4(h,d.r,d.g,d.b,d.a)}for(h in this._colors4Arrays)o.setArray4(h,this._colors4Arrays[h]);for(h in this._vectors2)o.setVector2(h,this._vectors2[h]);for(h in this._vectors3)o.setVector3(h,this._vectors3[h]);for(h in this._vectors4)o.setVector4(h,this._vectors4[h]);for(h in this._quaternions)o.setQuaternion(h,this._quaternions[h]);for(h in this._matrices)o.setMatrix(h,this._matrices[h]);for(h in this._matrixArrays)o.setMatrices(h,this._matrixArrays[h]);for(h in this._matrices3x3)o.setMatrix3x3(h,this._matrices3x3[h]);for(h in this._matrices2x2)o.setMatrix2x2(h,this._matrices2x2[h]);for(h in this._vectors2Arrays)o.setArray2(h,this._vectors2Arrays[h]);for(h in this._vectors3Arrays)o.setArray3(h,this._vectors3Arrays[h]);for(h in this._vectors4Arrays)o.setArray4(h,this._vectors4Arrays[h]);for(h in this._quaternionsArrays)o.setArray4(h,this._quaternionsArrays[h]);for(h in this._uniformBuffers){const d=this._uniformBuffers[h].getBuffer();d&&o.bindUniformBuffer(d,h)}for(h in this._textureSamplers)o.setTextureSampler(h,this._textureSamplers[h]);for(h in this._storageBuffers)o.setStorageBuffer(h,this._storageBuffers[h])}if(o&&t&&(u||!this.isFrozen)){const h=t.morphTargetManager;h&&h.numInfluencers>0&&fe.BindMorphTargetParameters(t,o);const d=t.bakedVertexAnimationManager;d&&d.isEnabled&&(null===(s=t.bakedVertexAnimationManager)||void 0===s||s.bind(o,!!o._wasPreviouslyUsingInstances))}this._afterBind(t,o)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let n=0;n<i.length;n++)e.push(i[n])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let n=0;n<i.length;n++)if(i[n]===e)return!0}return!1}clone(e){const t=lt.Clone(()=>new ba(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath=Mi({},t._shaderPath)),this._options=Mi({},this._options),Object.keys(this._options).forEach(i=>{const n=this._options[i];Array.isArray(n)&&(this._options[i]=n.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let n;for(n in this._textures)this._textures[n].dispose();for(n in this._textureArrays){const s=this._textureArrays[n];for(let a=0;a<s.length;a++)s[a].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=lt.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let n=0;n<i.length;n++)e.textureArrays[t].push(i[n].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.FloatArrays={},this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();for(t in e.vectors3={},this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();for(t in e.vectors4={},this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const n=lt.Parse(()=>new ba(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let s;for(s in e.stencil&&n.stencil.parse(e.stencil,t,i),e.textures)n.setTexture(s,j.Parse(e.textures[s],t,i));for(s in e.textureArrays){const a=e.textureArrays[s],o=new Array;for(let l=0;l<a.length;l++)o.push(j.Parse(a[l],t,i));n.setTextureArray(s,o)}for(s in e.ints)n.setInt(s,e.ints[s]);for(s in e.uints)n.setUInt(s,e.uints[s]);for(s in e.floats)n.setFloat(s,e.floats[s]);for(s in e.floatsArrays)n.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)n.setColor3(s,Fe.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const a=e.colors3Arrays[s].reduce((o,l,c)=>(c%3==0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>Fe.FromArray(o));n.setColor3Array(s,a)}for(s in e.colors4)n.setColor4(s,ct.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const a=e.colors4Arrays[s].reduce((o,l,c)=>(c%4==0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>ct.FromArray(o));n.setColor4Array(s,a)}for(s in e.vectors2)n.setVector2(s,We.FromArray(e.vectors2[s]));for(s in e.vectors3)n.setVector3(s,E.FromArray(e.vectors3[s]));for(s in e.vectors4)n.setVector4(s,Qt.FromArray(e.vectors4[s]));for(s in e.quaternions)n.setQuaternion(s,Be.FromArray(e.quaternions[s]));for(s in e.matrices)n.setMatrix(s,B.FromArray(e.matrices[s]));for(s in e.matrixArray)n._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)n.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)n.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)n.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)n.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)n.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)n.setArray4(s,e.quaternionsArrays[s]);return n}static ParseFromFileAsync(e,t,i,n=""){return new Promise((s,a)=>{const o=new Kn;o.addEventListener("readystatechange",()=>{if(4==o.readyState)if(200==o.status){const l=JSON.parse(o.responseText),c=this.Parse(l,i||Je.LastCreatedScene,n);e&&(c.name=e),s(c)}else a("Unable to load the ShaderMaterial")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((n,s)=>{const a=new Kn;a.addEventListener("readystatechange",()=>{if(4==a.readyState)if(200==a.status){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.shaderMaterial),c=this.Parse(l,t||Je.LastCreatedScene,i);c.snippetId=e,n(c)}else s("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}}ba.SnippetUrl="https://snippet.babylonjs.com",ba.CreateFromSnippetAsync=ba.ParseFromSnippetAsync,ye("BABYLON.ShaderMaterial",ba);Z.ShadersStore.meshUVSpaceRendererVertexShader="precision highp float;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nuniform mat4 projMatrix;\nvarying vec2 vDecalTC;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nvoid main(void) {\nvec3 positionUpdated=position;\nvec3 normalUpdated=normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nmat3 normWorldSM=mat3(finalWorld);\nvec3 vNormalW;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));\nvNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);\nvec3 decalTC=(projMatrix*worldPos).xyz;\nvDecalTC=decalTC.xy;\ngl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);\n}\n";Z.ShadersStore.meshUVSpaceRendererPixelShader="precision highp float;\nvarying vec2 vDecalTC;\nuniform sampler2D textureSampler;\nvoid main(void) {\nif (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {\ndiscard;\n}\ngl_FragColor=texture2D(textureSampler,vDecalTC);\n}\n",U._GroundMeshParser=(r,e)=>Sh.Parse(r,e);class Sh extends U{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e),this.createOrUpdateSubmeshesOctree&&this.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),n=z.Matrix[5];i.invertToRef(n);const s=z.Vector3[8];if(E.TransformCoordinatesFromFloatsToRef(e,0,t,n,s),t=s.z,(e=s.x)<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||0==this._heightQuads.length)&&(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t);return E.TransformCoordinatesFromFloatsToRef(0,-(a.x*e+a.z*t+a.w)/a.y,0,i,s),s.y}getNormalAtCoordinates(e,t){const i=new E(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const n=this.getWorldMatrix(),s=z.Matrix[5];n.invertToRef(s);const a=z.Vector3[8];if(E.TransformCoordinatesFromFloatsToRef(e,0,t,s,a),t=a.z,(e=a.x)<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||0==this._heightQuads.length)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return E.TransformNormalFromFloatsToRef(o.x,o.y,o.z,n,i),this}updateCoordinateHeights(){return(!this._heightQuads||0==this._heightQuads.length)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),n=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[n*this._subdivisionsX+i];let a;return a=t<s.slope.x*e+s.slope.y?s.facet1:s.facet2,a}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let n=0;n<e;n++){const s={slope:We.Zero(),facet1:new Qt(0,0,0,0),facet2:new Qt(0,0,0,0)};this._heightQuads[i*e+n]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(I.PositionKind);if(!e)return this;const t=z.Vector3[3],i=z.Vector3[2],n=z.Vector3[1],s=z.Vector3[0],a=z.Vector3[4],o=z.Vector3[5],l=z.Vector3[6],c=z.Vector3[7],u=z.Vector3[8];let h=0,d=0,f=0,p=0,g=0,_=0,m=0;const T=this._subdivisionsX,v=this._subdivisionsY;for(let A=0;A<v;A++)for(let S=0;S<T;S++){h=3*S,d=A*(T+1)*3,f=(A+1)*(T+1)*3,t.x=e[d+h],t.y=e[d+h+1],t.z=e[d+h+2],i.x=e[d+h+3],i.y=e[d+h+4],i.z=e[d+h+5],n.x=e[f+h],n.y=e[f+h+1],n.z=e[f+h+2],s.x=e[f+h+3],s.y=e[f+h+4],s.z=e[f+h+5],p=(s.z-t.z)/(s.x-t.x),g=t.z-p*t.x,i.subtractToRef(t,a),n.subtractToRef(t,o),s.subtractToRef(t,l),E.CrossToRef(l,o,c),E.CrossToRef(a,l,u),c.normalize(),u.normalize(),_=-(c.x*t.x+c.y*t.y+c.z*t.z),m=-(u.x*i.x+u.y*i.y+u.z*i.z);const x=this._heightQuads[A*T+S];x.slope.copyFromFloats(p,g),x.facet1.copyFromFloats(c.x,c.y,c.z,_),x.facet2.copyFromFloats(u.x,u.y,u.z,m)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Sh(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}U._GoldbergMeshParser=(r,e)=>zf.Parse(r,e);class zf extends U{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return void 0===t?(e>this.goldbergData.nbUnsharedFaces-1&&(H.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(H.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(H.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const s=e[i][1],a=e[i][2];for(let o=e[i][0];o<s+1;o++)this.goldbergData.faceColors[o]=a}const t=[];for(let i=0;i<12;i++)for(let n=0;n<5;n++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let n=0;n<6;n++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(I.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(I.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(I.UVKind);for(let i=0;i<e.length;i++){const n=e[i][0],s=e[i][1],a=e[i][2],o=e[i][3],l=e[i][4],c=[],u=[];let h,d;for(let f=0;f<5;f++)h=a.x+o*Math.cos(l+f*Math.PI/2.5),d=a.y+o*Math.sin(l+f*Math.PI/2.5),h<0&&(h=0),h>1&&(h=1),c.push(h,d);for(let f=0;f<6;f++)h=a.x+o*Math.cos(l+f*Math.PI/3),d=a.y+o*Math.sin(l+f*Math.PI/3),h<0&&(h=0),h>1&&(h=1),u.push(h,d);for(let f=n;f<Math.min(12,s+1);f++)for(let p=0;p<5;p++)t[10*f+2*p]=c[2*p],t[10*f+2*p+1]=c[2*p+1];for(let f=Math.max(12,n);f<s+1;f++)for(let p=0;p<6;p++)t[12*f-24+2*p]=u[2*p],t[12*f-23+2*p]=u[2*p+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(I.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(I.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const n=E.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=n,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(s=>ct.FromArray(s)),i.faceCenters=i.faceCenters.map(s=>E.FromArray(s)),i.faceZaxis=i.faceZaxis.map(s=>E.FromArray(s)),i.faceXaxis=i.faceXaxis.map(s=>E.FromArray(s)),i.faceYaxis=i.faceYaxis.map(s=>E.FromArray(s));const n=new zf(e.name,t);return n.goldbergData=i,n}}U._instancedMeshFactory=(r,e)=>{const t=new bT(r,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class bT extends hn{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())null!=i&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.receiveShadows)!==e&&Ie.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.material)!==e&&Ie.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.visibility)!==e&&Ie.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.skeleton)!==e&&Ie.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||H.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,n),this.sourceMesh}updateVerticesData(e,t,i,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,n),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||H.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==gt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new B);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,z.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(z.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,n){const s=(n||this._sourceMesh).createInstance(e);if(Wr.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(s.parent=t),!i)for(let a=0;a<this.getScene().meshes.length;a++){const o=this.getScene().meshes[a];o.parent===this&&o.clone(o.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);n&&i&&i(this,n);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(n,t,i);return n}}U.prototype.registerInstancedBuffer=function(r,e){var t,i;if(null===(i=null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[r])||void 0===i||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const n of this.instances)n.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[r]=null,this._userInstancedBuffersStorage.strides[r]=e,this._userInstancedBuffersStorage.sizes[r]=32*e,this._userInstancedBuffersStorage.data[r]=new Float32Array(this._userInstancedBuffersStorage.sizes[r]),this._userInstancedBuffersStorage.vertexBuffers[r]=new I(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,e,!0);for(const n of this.instances)n.instancedBuffers[r]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},U.prototype._processInstancedBuffers=function(r,e){const t=r?r.length:0;for(const i in this.instancedBuffers){let n=this._userInstancedBuffersStorage.sizes[i];const s=this._userInstancedBuffersStorage.strides[i],a=(t+1)*s;for(;n<a;)n*=2;this._userInstancedBuffersStorage.data[i].length!=n&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[i]=n,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const c=this.instancedBuffers[i];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=s}for(let c=0;c<t;c++){const h=r[c].instancedBuffers[i];h.toArray?h.toArray(o,l):h.copyToArray?h.copyToArray(o,l):o[l]=h,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new I(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}},U.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const r in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[r]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},U.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const r in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[r]&&this._userInstancedBuffersStorage.vertexBuffers[r].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};Z.ShadersStore.colorPixelShader="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}";Z.IncludesShadersStore.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=color;\n#else\nvColor.rgb*=color.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n";Z.ShadersStore.colorVertexShader="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}",U._LinesMeshParser=(r,e)=>kc.Parse(r,e);class kc extends U{_isShaderMaterial(e){return"ShaderMaterial"===e.getClassName()}constructor(e,t=null,i=null,n=null,s,a,o,l){super(e,t,i,n,s),this.useVertexColor=a,this.useVertexAlpha=o,this.color=new Fe(1,1,1),this.alpha=1,n&&(this.color=n.color.clone(),this.alpha=n.alpha,this.useVertexColor=n.useVertexColor,this.useVertexAlpha=n.useVertexAlpha),this.intersectionThreshold=.1;const u={attributes:[I.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null};!1===o?u.needAlphaBlending=!1:u.defines.push("#define VERTEXALPHA"),a?(u.defines.push("#define VERTEXCOLOR"),u.attributes.push(I.ColorKind)):(u.uniforms.push("color"),this._color4=new ct),l?this.material=l:(this.material=new ba("colorShader",this.getScene(),"color",u,!1),this.material.doNotSerialize=!0)}isReady(){return!!this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=le.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,i),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:n,g:s,b:a}=this.color;this._color4.set(n,s,a,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const n=this.getScene().getEngine();return this._unIndexed?n.drawArraysType(le.LineListDrawMode,e.verticesStart,e.verticesCount,i):n.drawElementsType(le.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new kc(e,this.getScene(),t,this,i)}createInstance(e){const t=new SW(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new kc(e.name,t);return i.color=Fe.FromArray(e.color),i.alpha=e.alpha,i}}class SW extends bT{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function hR(r){let e=r.pathArray;const t=r.closeArray||!1,i=r.closePath||!1,n=r.invertUV||!1,s=Math.floor(e[0].length/2);let a=r.offset||s;a=a>s?s:Math.floor(a);const o=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,l=r.uvs,c=r.colors,u=[],h=[],d=[],f=[],p=[],g=[],_=[],m=[];let T;const v=[],A=[];let S,x,C;if(e.length<2){const Mt=[],qe=[];for(x=0;x<e[0].length-a;x++)Mt.push(e[0][x]),qe.push(e[0][x+a]);e=[Mt,qe]}let R=0;const D=i?1:0;let P,N,k,X;for(T=e[0].length,S=0;S<e.length;S++){for(_[S]=0,p[S]=[0],P=e[S],N=P.length,T=T<N?T:N,C=0;C<N;)u.push(P[C].x,P[C].y,P[C].z),C>0&&(k=P[C].subtract(P[C-1]).length(),X=k+_[S],p[S].push(X),_[S]=X),C++;i&&(C--,u.push(P[0].x,P[0].y,P[0].z),k=P[C].subtract(P[0]).length(),X=k+_[S],p[S].push(X),_[S]=X),v[S]=N+D,A[S]=R,R+=N+D}let ne,ge,me,$,ue=null,ke=null;for(x=0;x<T+D;x++){for(m[x]=0,g[x]=[0],S=0;S<e.length-1;S++)ne=e[S],ge=e[S+1],x===T?(ue=ne[0],ke=ge[0]):(ue=ne[x],ke=ge[x]),k=ke.subtract(ue).length(),X=k+m[x],g[x].push(X),m[x]=X;t&&ke&&ue&&(ne=e[S],ge=e[0],x===T&&(ke=ge[0]),k=ke.subtract(ue).length(),X=k+m[x],m[x]=X)}if(l)for(S=0;S<l.length;S++)f.push(l[S].x,jt.UseOpenGLOrientationForUV?1-l[S].y:l[S].y);else for(S=0;S<e.length;S++)for(x=0;x<T+D;x++)me=0!=_[S]?p[S][x]/_[S]:0,$=0!=m[x]?g[x][S]/m[x]:0,n?f.push($,me):f.push(me,jt.UseOpenGLOrientationForUV?1-$:$);S=0;let Q=0,w=v[S]-1,Y=v[S+1]-1,se=w<Y?w:Y,Re=A[1]-A[0];const mt=t?v.length:v.length-1;for(;Q<=se&&S<mt;)h.push(Q,Q+Re,Q+1),h.push(Q+Re+1,Q+1,Q+Re),Q+=1,Q===se&&(S++,S===v.length-1?(Re=A[0]-A[S],w=v[S]-1,Y=v[0]-1):(Re=A[S+1]-A[S],w=v[S]-1,Y=v[S+1]-1),Q=A[S],se=w<Y?w+Q:Y+Q);if(be.ComputeNormals(u,h,d),i){let Mt=0,qe=0;for(S=0;S<e.length;S++)Mt=3*A[S],qe=S+1<e.length?3*(A[S+1]-1):d.length-3,d[Mt]=.5*(d[Mt]+d[qe]),d[Mt+1]=.5*(d[Mt+1]+d[qe+1]),d[Mt+2]=.5*(d[Mt+2]+d[qe+2]),d[qe]=d[Mt],d[qe+1]=d[Mt+1],d[qe+2]=d[Mt+2]}be._ComputeSides(o,u,h,d,f,r.frontUVs,r.backUVs);let $e=null;if(c){$e=new Float32Array(4*c.length);for(let Mt=0;Mt<c.length;Mt++)$e[4*Mt]=c[Mt].r,$e[4*Mt+1]=c[Mt].g,$e[4*Mt+2]=c[Mt].b,$e[4*Mt+3]=c[Mt].a}const _e=new be,Xe=new Float32Array(u),Xt=new Float32Array(d),ti=new Float32Array(f);return _e.indices=h,_e.positions=Xe,_e.normals=Xt,_e.uvs=ti,$e&&_e.set($e,I.ColorKind),i&&(_e._idx=A),_e}function ko(r,e,t=null){const i=e.pathArray,n=e.closeArray,s=e.closePath,a=U._GetDefaultSideOrientation(e.sideOrientation),o=e.instance,l=e.updatable;if(o){const c=z.Vector3[0].setAll(Number.MAX_VALUE),u=z.Vector3[1].setAll(-Number.MAX_VALUE),h=f=>{let p=i[0].length;const g=o;let _=0;const m=g._originalBuilderSideOrientation===U.DOUBLESIDE?2:1;for(let T=1;T<=m;++T)for(let v=0;v<i.length;++v){const A=i[v],S=A.length;p=p<S?p:S;for(let x=0;x<p;++x){const C=A[x];f[_]=C.x,f[_+1]=C.y,f[_+2]=C.z,c.minimizeInPlaceFromFloats(C.x,C.y,C.z),u.maximizeInPlaceFromFloats(C.x,C.y,C.z),_+=3}if(g._creationDataStorage&&g._creationDataStorage.closePath){const x=A[0];f[_]=x.x,f[_+1]=x.y,f[_+2]=x.z,_+=3}}},d=o.getVerticesData(I.PositionKind);if(h(d),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(c,u,o._worldMatrix):o.buildBoundingInfo(c,u,o._worldMatrix),o.updateVerticesData(I.PositionKind,d,!1,!1),e.colors){const f=o.getVerticesData(I.ColorKind);for(let p=0,g=0;p<e.colors.length;p++,g+=4){const _=e.colors[p];f[g]=_.r,f[g+1]=_.g,f[g+2]=_.b,f[g+3]=_.a}o.updateVerticesData(I.ColorKind,f,!1,!1)}if(e.uvs){const f=o.getVerticesData(I.UVKind);for(let p=0;p<e.uvs.length;p++)f[2*p]=e.uvs[p].x,f[2*p+1]=jt.UseOpenGLOrientationForUV?1-e.uvs[p].y:e.uvs[p].y;o.updateVerticesData(I.UVKind,f,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){const f=o.getIndices(),p=o.getVerticesData(I.NormalKind),g=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(be.ComputeNormals(d,f,p,g),o._creationDataStorage&&o._creationDataStorage.closePath){let _=0,m=0;for(let T=0;T<i.length;T++)_=3*o._creationDataStorage.idx[T],m=T+1<i.length?3*(o._creationDataStorage.idx[T+1]-1):p.length-3,p[_]=.5*(p[_]+p[m]),p[_+1]=.5*(p[_+1]+p[m+1]),p[_+2]=.5*(p[_+2]+p[m+2]),p[m]=p[_],p[m+1]=p[_+1],p[m+2]=p[_+2]}o.areNormalsFrozen||o.updateVerticesData(I.NormalKind,p,!1,!1)}return o}{const c=new U(r,t);c._originalBuilderSideOrientation=a,c._creationDataStorage=new qI;const u=hR(e);return s&&(c._creationDataStorage.idx=u._idx),c._creationDataStorage.closePath=s,c._creationDataStorage.closeArray=n,u.applyToMesh(c,l),c}}function dR(r){const e=new Array,t=new Array,i=new Array,n=new Array,s=r.radius||.5,a=r.tessellation||64,o=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,l=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE;e.push(0,0,0),n.push(.5,.5);const c=2*Math.PI*o,u=1===o?c/a:c/(a-1);let h=0;for(let p=0;p<a;p++){const g=Math.cos(h),_=Math.sin(h),m=(g+1)/2,T=(1-_)/2;e.push(s*g,s*_,0),n.push(m,jt.UseOpenGLOrientationForUV?1-T:T),h+=u}1===o&&(e.push(e[3],e[4],e[5]),n.push(n[2],jt.UseOpenGLOrientationForUV?1-n[3]:n[3]));const d=e.length/3;for(let p=1;p<d-1;p++)t.push(p+1,0,p);be.ComputeNormals(e,t,i),be._ComputeSides(l,e,t,i,n,r.frontUVs,r.backUVs);const f=new be;return f.indices=t,f.positions=e,f.normals=i,f.uvs=n,f}function Wf(r,e={},t=null){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,dR(e).applyToMesh(i,e.updatable),i}function CT(r){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[];let s=[];const a=r.width||r.size||1,o=r.height||r.size||1,l=r.depth||r.size||1;let u=void 0===r.topBaseAt?1:r.topBaseAt,h=void 0===r.bottomBaseAt?0:r.bottomBaseAt;u=(u+4)%4,h=(h+4)%4;let p=[2,0,3,1][u],g=[2,0,1,3][h],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(r.wrap){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let C=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],R=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const D=[17,18,19,16],P=[22,23,20,21];for(;p>0;)C.unshift(C.pop()),D.unshift(D.pop()),p--;for(;g>0;)R.unshift(R.pop()),P.unshift(P.pop()),g--;C=C.flat(),R=R.flat(),_=_.concat(C).concat(R),t.push(D[0],D[2],D[3],D[0],D[1],D[2]),t.push(P[0],P[2],P[3],P[0],P[1],P[2])}const m=[a/2,o/2,l/2];s=_.reduce((C,R,D)=>C.concat(R*m[D%3]),[]);const T=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,v=r.faceUV||new Array(6),A=r.faceColors,S=[];for(let C=0;C<6;C++)void 0===v[C]&&(v[C]=new Qt(0,0,1,1)),A&&void 0===A[C]&&(A[C]=new ct(1,1,1,1));for(let C=0;C<6;C++)if(n.push(v[C].z,jt.UseOpenGLOrientationForUV?1-v[C].w:v[C].w),n.push(v[C].x,jt.UseOpenGLOrientationForUV?1-v[C].w:v[C].w),n.push(v[C].x,jt.UseOpenGLOrientationForUV?1-v[C].y:v[C].y),n.push(v[C].z,jt.UseOpenGLOrientationForUV?1-v[C].y:v[C].y),A)for(let R=0;R<4;R++)S.push(A[C].r,A[C].g,A[C].b,A[C].a);be._ComputeSides(T,s,t,i,n,r.frontUVs,r.backUVs);const x=new be;if(x.indices=t,x.positions=s,x.normals=i,x.uvs=n,A){const C=T===be.DOUBLESIDE?S.concat(S):S;x.colors=C}return x}function xh(r){const e=r.pattern||U.NO_FLIP,t=r.tileWidth||r.tileSize||1,i=r.tileHeight||r.tileSize||1,n=r.alignHorizontal||0,s=r.alignVertical||0,a=r.width||r.size||1,o=Math.floor(a/t);let l=a-o*t;const c=r.height||r.size||1,u=Math.floor(c/i);let h=c-u*i;const d=t*o/2,f=i*u/2;let p=0,g=0,_=0,m=0,T=0,v=0;if(l>0||h>0){switch(_=-d,m=-f,T=d,v=f,n){case U.CENTER:l/=2,_-=l,T+=l;break;case U.LEFT:T+=l,p=-l/2;break;case U.RIGHT:_-=l,p=l/2}switch(s){case U.CENTER:h/=2,m-=h,v+=h;break;case U.BOTTOM:v+=h,g=-h/2;break;case U.TOP:m-=h,g=h/2}}const A=[],S=[],x=[];x[0]=[0,0,1,0,1,1,0,1],x[1]=[0,0,1,0,1,1,0,1],(e===U.ROTATE_TILE||e===U.ROTATE_ROW)&&(x[1]=[1,1,0,1,0,0,1,0]),(e===U.FLIP_TILE||e===U.FLIP_ROW)&&(x[1]=[1,0,0,0,0,1,1,1]),(e===U.FLIP_N_ROTATE_TILE||e===U.FLIP_N_ROTATE_ROW)&&(x[1]=[0,1,1,1,1,0,0,0]);let C=[];const R=[],D=[];let P=0;for(let ne=0;ne<u;ne++)for(let ge=0;ge<o;ge++)A.push(ge*t-d+p,ne*i-f+g,0),A.push((ge+1)*t-d+p,ne*i-f+g,0),A.push((ge+1)*t-d+p,(ne+1)*i-f+g,0),A.push(ge*t-d+p,(ne+1)*i-f+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),C=C.concat(e===U.FLIP_TILE||e===U.ROTATE_TILE||e===U.FLIP_N_ROTATE_TILE?x[(ge%2+ne%2)%2]:e===U.FLIP_ROW||e===U.ROTATE_ROW||e===U.FLIP_N_ROTATE_ROW?x[ne%2]:x[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),P+=4;if(l>0||h>0){const ne=h>0&&(s===U.CENTER||s===U.TOP),ge=h>0&&(s===U.CENTER||s===U.BOTTOM),ue=l>0&&(n===U.CENTER||n===U.RIGHT),ke=l>0&&(n===U.CENTER||n===U.LEFT);let $,Q,w,Y,me=[];if(ne&&ue&&(A.push(_+p,m+g,0),A.push(-d+p,m+g,0),A.push(-d+p,m+h+g,0),A.push(_+p,m+h+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,$=1-l/t,Q=1-h/i,w=1,Y=1,me=[$,Q,w,Q,w,Y,$,Y],e===U.ROTATE_ROW&&(me=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),e===U.FLIP_ROW&&(me=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),e===U.FLIP_N_ROTATE_ROW&&(me=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]),C=C.concat(me),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ne&&ke&&(A.push(d+p,m+g,0),A.push(T+p,m+g,0),A.push(T+p,m+h+g,0),A.push(d+p,m+h+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,$=0,Q=1-h/i,w=l/t,Y=1,me=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_ROW||e===U.ROTATE_TILE&&o%2==0)&&(me=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_ROW||e===U.FLIP_TILE&&o%2==0)&&(me=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_ROW||e===U.FLIP_N_ROTATE_TILE&&o%2==0)&&(me=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]),C=C.concat(me),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ge&&ue&&(A.push(_+p,f+g,0),A.push(-d+p,f+g,0),A.push(-d+p,v+g,0),A.push(_+p,v+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,$=1-l/t,Q=0,w=1,Y=h/i,me=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_ROW&&u%2==1||e===U.ROTATE_TILE&&u%1==0)&&(me=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_ROW&&u%2==1||e===U.FLIP_TILE&&u%2==0)&&(me=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_ROW&&u%2==1||e===U.FLIP_N_ROTATE_TILE&&u%2==0)&&(me=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]),C=C.concat(me),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ge&&ke&&(A.push(d+p,f+g,0),A.push(T+p,f+g,0),A.push(T+p,v+g,0),A.push(d+p,v+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,$=0,Q=0,w=l/t,Y=h/i,me=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_ROW&&u%2==1||e===U.ROTATE_TILE&&(u+o)%2==1)&&(me=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_ROW&&u%2==1||e===U.FLIP_TILE&&(u+o)%2==1)&&(me=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_ROW&&u%2==1||e===U.FLIP_N_ROTATE_TILE&&(u+o)%2==1)&&(me=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]),C=C.concat(me),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ne){const se=[];$=0,Q=1-h/i,w=1,Y=1,se[0]=[$,Q,w,Q,w,Y,$,Y],se[1]=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_TILE||e===U.ROTATE_ROW)&&(se[1]=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_TILE||e===U.FLIP_ROW)&&(se[1]=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_TILE||e===U.FLIP_N_ROTATE_ROW)&&(se[1]=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]);for(let Re=0;Re<o;Re++)A.push(Re*t-d+p,m+g,0),A.push((Re+1)*t-d+p,m+g,0),A.push((Re+1)*t-d+p,m+h+g,0),A.push(Re*t-d+p,m+h+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,C=C.concat(e===U.FLIP_TILE||e===U.ROTATE_TILE||e===U.FLIP_N_ROTATE_TILE?se[(Re+1)%2]:e===U.FLIP_ROW||e===U.ROTATE_ROW||e===U.FLIP_N_ROTATE_ROW?se[1]:se[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ge){const se=[];$=0,Q=0,w=1,Y=h/i,se[0]=[$,Q,w,Q,w,Y,$,Y],se[1]=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_TILE||e===U.ROTATE_ROW)&&(se[1]=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_TILE||e===U.FLIP_ROW)&&(se[1]=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_TILE||e===U.FLIP_N_ROTATE_ROW)&&(se[1]=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]);for(let Re=0;Re<o;Re++)A.push(Re*t-d+p,v-h+g,0),A.push((Re+1)*t-d+p,v-h+g,0),A.push((Re+1)*t-d+p,v+g,0),A.push(Re*t-d+p,v+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,C=C.concat(e===U.FLIP_TILE||e===U.ROTATE_TILE||e===U.FLIP_N_ROTATE_TILE?se[(Re+u)%2]:e===U.FLIP_ROW||e===U.ROTATE_ROW||e===U.FLIP_N_ROTATE_ROW?se[u%2]:se[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ue){const se=[];$=1-l/t,Q=0,w=1,Y=1,se[0]=[$,Q,w,Q,w,Y,$,Y],se[1]=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_TILE||e===U.ROTATE_ROW)&&(se[1]=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_TILE||e===U.FLIP_ROW)&&(se[1]=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_TILE||e===U.FLIP_N_ROTATE_ROW)&&(se[1]=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]);for(let Re=0;Re<u;Re++)A.push(_+p,Re*i-f+g,0),A.push(_+l+p,Re*i-f+g,0),A.push(_+l+p,(Re+1)*i-f+g,0),A.push(_+p,(Re+1)*i-f+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,C=C.concat(e===U.FLIP_TILE||e===U.ROTATE_TILE||e===U.FLIP_N_ROTATE_TILE?se[(Re+1)%2]:e===U.FLIP_ROW||e===U.ROTATE_ROW||e===U.FLIP_N_ROTATE_ROW?se[Re%2]:se[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ke){const se=[];$=0,Q=0,w=l/i,Y=1,se[0]=[$,Q,w,Q,w,Y,$,Y],se[1]=[$,Q,w,Q,w,Y,$,Y],(e===U.ROTATE_TILE||e===U.ROTATE_ROW)&&(se[1]=[1-$,1-Q,1-w,1-Q,1-w,1-Y,1-$,1-Y]),(e===U.FLIP_TILE||e===U.FLIP_ROW)&&(se[1]=[1-$,Q,1-w,Q,1-w,Y,1-$,Y]),(e===U.FLIP_N_ROTATE_TILE||e===U.FLIP_N_ROTATE_ROW)&&(se[1]=[$,1-Q,w,1-Q,w,1-Y,$,1-Y]);for(let Re=0;Re<u;Re++)A.push(T-l+p,Re*i-f+g,0),A.push(T+p,Re*i-f+g,0),A.push(T+p,(Re+1)*i-f+g,0),A.push(T-l+p,(Re+1)*i-f+g,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,C=C.concat(e===U.FLIP_TILE||e===U.ROTATE_TILE||e===U.FLIP_N_ROTATE_TILE?se[(Re+o)%2]:e===U.FLIP_ROW||e===U.ROTATE_ROW||e===U.FLIP_N_ROTATE_ROW?se[Re%2]:se[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),S.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const N=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE;be._ComputeSides(N,A,D,S,C,r.frontUVs,r.backUVs);const k=new be;k.indices=D,k.positions=A,k.normals=S,k.uvs=C;const X=N===be.DOUBLESIDE?R.concat(R):R;return k.colors=X,k}function _R(r){const e=r.segments||32,s=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,a=r.slice&&r.slice<=0?1:r.slice||1,o=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,l=!!r.dedupTopBottomIndices,c=new E((r.diameterX||r.diameter||1)/2,(r.diameterY||r.diameter||1)/2,(r.diameterZ||r.diameter||1)/2),u=2+e,h=2*u,d=[],f=[],p=[],g=[];for(let m=0;m<=u;m++){const T=m/u,v=T*Math.PI*a;for(let A=0;A<=h;A++){const S=A/h,x=S*Math.PI*2*s,C=B.RotationZ(-v),R=B.RotationY(x),D=E.TransformCoordinates(E.Up(),C),P=E.TransformCoordinates(D,R),N=P.multiply(c),k=P.divide(c).normalize();f.push(N.x,N.y,N.z),p.push(k.x,k.y,k.z),g.push(S,jt.UseOpenGLOrientationForUV?1-T:T)}if(m>0){const A=f.length/3;for(let S=A-2*(h+1);S+h+2<A;S++)l?(m>1&&(d.push(S),d.push(S+1),d.push(S+h+1)),(m<u||a<1)&&(d.push(S+h+1),d.push(S+1),d.push(S+h+2))):(d.push(S),d.push(S+1),d.push(S+h+1),d.push(S+h+1),d.push(S+1),d.push(S+h+2))}}be._ComputeSides(o,f,d,p,g,r.frontUVs,r.backUVs);const _=new be;return _.indices=d,_.positions=f,_.normals=p,_.uvs=g,_}function Xf(r,e={},t=null){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,_R(e).applyToMesh(i,e.updatable),i}function mR(r){const e=r.height||2;let t=0===r.diameterTop?0:r.diameterTop||r.diameter||1,i=0===r.diameterBottom?0:r.diameterBottom||r.diameter||1;t=t||1e-5,i=i||1e-5;const n=r.tessellation||24,s=r.subdivisions||1,a=!!r.hasRings,o=!!r.enclose,l=0===r.cap?0:r.cap||U.CAP_ALL,c=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,u=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,h=r.faceUV||new Array(3),d=r.faceColors,g=2+(1+(1!==c&&o?2:0))*(a?s:1);let _;for(_=0;_<g;_++)d&&void 0===d[_]&&(d[_]=new ct(1,1,1,1));for(_=0;_<g;_++)h&&void 0===h[_]&&(h[_]=new Qt(0,0,1,1));const m=new Array,T=new Array,v=new Array,A=new Array,S=new Array,x=2*Math.PI*c/n;let C,R,D;const P=(i-t)/2/e,N=E.Zero(),k=E.Zero(),X=E.Zero(),ne=E.Zero(),ge=E.Zero(),ue=wo.Y;let ke,me,$,Q=1,w=1,Y=0,se=0;for(ke=0;ke<=s;ke++)for(R=ke/s,D=(R*(t-i)+i)/2,Q=a&&0!==ke&&ke!==s?2:1,$=0;$<Q;$++){for(a&&(w+=$),o&&(w+=2*$),me=0;me<=n;me++)C=me*x,N.x=Math.cos(-C)*D,N.y=-e/2+R*e,N.z=Math.sin(-C)*D,0===t&&ke===s?(k.x=v[v.length-3*(n+1)],k.y=v[v.length-3*(n+1)+1],k.z=v[v.length-3*(n+1)+2]):(k.x=N.x,k.z=N.z,k.y=Math.sqrt(k.x*k.x+k.z*k.z)*P,k.normalize()),0===me&&(X.copyFrom(N),ne.copyFrom(k)),T.push(N.x,N.y,N.z),v.push(k.x,k.y,k.z),se=a?Y!==w?h[w].y:h[w].w:h[w].y+(h[w].w-h[w].y)*R,A.push(h[w].x+(h[w].z-h[w].x)*me/n,jt.UseOpenGLOrientationForUV?1-se:se),d&&S.push(d[w].r,d[w].g,d[w].b,d[w].a);1!==c&&o&&(T.push(N.x,N.y,N.z),T.push(0,N.y,0),T.push(0,N.y,0),T.push(X.x,X.y,X.z),E.CrossToRef(ue,k,ge),ge.normalize(),v.push(ge.x,ge.y,ge.z,ge.x,ge.y,ge.z),E.CrossToRef(ne,ue,ge),ge.normalize(),v.push(ge.x,ge.y,ge.z,ge.x,ge.y,ge.z),se=a?Y!==w?h[w+1].y:h[w+1].w:h[w+1].y+(h[w+1].w-h[w+1].y)*R,A.push(h[w+1].x,jt.UseOpenGLOrientationForUV?1-se:se),A.push(h[w+1].z,jt.UseOpenGLOrientationForUV?1-se:se),se=a?Y!==w?h[w+2].y:h[w+2].w:h[w+2].y+(h[w+2].w-h[w+2].y)*R,A.push(h[w+2].x,jt.UseOpenGLOrientationForUV?1-se:se),A.push(h[w+2].z,jt.UseOpenGLOrientationForUV?1-se:se),d&&(S.push(d[w+1].r,d[w+1].g,d[w+1].b,d[w+1].a),S.push(d[w+1].r,d[w+1].g,d[w+1].b,d[w+1].a),S.push(d[w+2].r,d[w+2].g,d[w+2].b,d[w+2].a),S.push(d[w+2].r,d[w+2].g,d[w+2].b,d[w+2].a))),Y!==w&&(Y=w)}const Re=1!==c&&o?n+4:n;for(ke=0,w=0;w<s;w++){let _e=0,Xe=0,Xt=0,ti=0;for(me=0;me<n;me++)_e=ke*(Re+1)+me,Xe=(ke+1)*(Re+1)+me,Xt=ke*(Re+1)+(me+1),ti=(ke+1)*(Re+1)+(me+1),m.push(_e,Xe,Xt),m.push(ti,Xt,Xe);1!==c&&o&&(m.push(_e+2,Xe+2,Xt+2),m.push(ti+2,Xt+2,Xe+2),m.push(_e+4,Xe+4,Xt+4),m.push(ti+4,Xt+4,Xe+4)),ke=a?ke+2:ke+1}const mt=_e=>{const Xe=_e?t/2:i/2;if(0===Xe)return;let Xt,ti,Mt;const qe=_e?h[g-1]:h[0];let qt=null;d&&(qt=_e?d[g-1]:d[0]);const Ei=T.length/3,Ci=_e?e/2:-e/2,qi=new E(0,Ci,0);T.push(qi.x,qi.y,qi.z),v.push(0,_e?1:-1,0);const Ps=qe.y+.5*(qe.w-qe.y);A.push(qe.x+.5*(qe.z-qe.x),jt.UseOpenGLOrientationForUV?1-Ps:Ps),qt&&S.push(qt.r,qt.g,qt.b,qt.a);const Tr=new We(.5,.5);for(Mt=0;Mt<=n;Mt++){Xt=2*Math.PI*Mt*c/n;const Qo=Math.cos(-Xt),Sn=Math.sin(-Xt);ti=new E(Qo*Xe,Ci,Sn*Xe);const Zo=new We(Qo*Tr.x+.5,Sn*Tr.y+.5);T.push(ti.x,ti.y,ti.z),v.push(0,_e?1:-1,0);const qn=qe.y+(qe.w-qe.y)*Zo.y;A.push(qe.x+(qe.z-qe.x)*Zo.x,jt.UseOpenGLOrientationForUV?1-qn:qn),qt&&S.push(qt.r,qt.g,qt.b,qt.a)}for(Mt=0;Mt<n;Mt++)_e?(m.push(Ei),m.push(Ei+(Mt+2)),m.push(Ei+(Mt+1))):(m.push(Ei),m.push(Ei+(Mt+1)),m.push(Ei+(Mt+2)))};(l===U.CAP_START||l===U.CAP_ALL)&&mt(!1),(l===U.CAP_END||l===U.CAP_ALL)&&mt(!0),be._ComputeSides(u,T,m,v,A,r.frontUVs,r.backUVs);const $e=new be;return $e.indices=m,$e.positions=T,$e.normals=v,$e.uvs=A,d&&($e.colors=S),$e}function TR(r){const e=[],t=[],i=[],n=[],s=r.diameter||1,a=r.thickness||.5,o=r.tessellation||16,l=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,c=o+1;for(let h=0;h<=o;h++){const d=h/o,f=h*Math.PI*2/o-Math.PI/2,p=B.Translation(s/2,0,0).multiply(B.RotationY(f));for(let g=0;g<=o;g++){const _=1-g/o,m=g*Math.PI*2/o+Math.PI,T=Math.cos(m),v=Math.sin(m);let A=new E(T,v,0),S=A.scale(a/2);const x=new We(d,_);S=E.TransformCoordinates(S,p),A=E.TransformNormal(A,p),t.push(S.x,S.y,S.z),i.push(A.x,A.y,A.z),n.push(x.x,jt.UseOpenGLOrientationForUV?1-x.y:x.y);const C=(h+1)%c,R=(g+1)%c;e.push(h*c+g),e.push(h*c+R),e.push(C*c+g),e.push(h*c+R),e.push(C*c+R),e.push(C*c+g)}}be._ComputeSides(l,t,e,i,n,r.frontUVs,r.backUVs);const u=new be;return u.indices=e,u.positions=t,u.normals=i,u.uvs=n,u}function ER(r){const e=new Array,t=new Array,i=new Array,n=new Array,s=r.radius||2,a=r.tube||.5,o=r.radialSegments||32,l=r.tubularSegments||32,c=r.p||2,u=r.q||3,h=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,d=_=>{const m=Math.cos(_),T=Math.sin(_),v=u/c*_,A=Math.cos(v),S=s*(2+A)*.5*m,x=s*(2+A)*T*.5,C=s*Math.sin(v)*.5;return new E(S,x,C)};let f,p;for(f=0;f<=o;f++){const m=f%o/o*2*c*Math.PI,T=d(m),v=d(m+.01),A=v.subtract(T);let S=v.add(T);const x=E.Cross(A,S);for(S=E.Cross(x,A),x.normalize(),S.normalize(),p=0;p<l;p++){const R=p%l/l*2*Math.PI,D=-a*Math.cos(R),P=a*Math.sin(R);t.push(T.x+D*S.x+P*x.x),t.push(T.y+D*S.y+P*x.y),t.push(T.z+D*S.z+P*x.z),n.push(f/o),n.push(jt.UseOpenGLOrientationForUV?1-p/l:p/l)}}for(f=0;f<o;f++)for(p=0;p<l;p++){const _=(p+1)%l,m=f*l+p,T=(f+1)*l+p,v=(f+1)*l+_,A=f*l+_;e.push(A),e.push(T),e.push(m),e.push(A),e.push(v),e.push(T)}be.ComputeNormals(t,e,i),be._ComputeSides(h,t,e,i,n,r.frontUVs,r.backUVs);const g=new be;return g.indices=e,g.positions=t,g.normals=i,g.uvs=n,g}function vR(r){const e=[],t=[],i=r.lines,n=r.colors,s=[];let a=0;for(let l=0;l<i.length;l++){const c=i[l];for(let u=0;u<c.length;u++){if(t.push(c[u].x,c[u].y,c[u].z),n){const h=n[l];s.push(h[u].r,h[u].g,h[u].b,h[u].a)}u>0&&(e.push(a-1),e.push(a)),a++}}const o=new be;return o.indices=e,o.positions=t,n&&(o.colors=s),o}function SR(r){const e=r.dashSize||3,t=r.gapSize||1,i=r.dashNb||200,n=r.points,s=new Array,a=new Array,o=E.Zero();let l=0,c=0,u=0,h=0,d=0,f=0,p=0;for(p=0;p<n.length-1;p++)n[p+1].subtractToRef(n[p],o),l+=o.length();for(u=l/i,h=e*u/(e+t),p=0;p<n.length-1;p++){n[p+1].subtractToRef(n[p],o),c=Math.floor(o.length()/u),o.normalize();for(let _=0;_<c;_++)d=u*_,s.push(n[p].x+d*o.x,n[p].y+d*o.y,n[p].z+d*o.z),s.push(n[p].x+(d+h)*o.x,n[p].y+(d+h)*o.y,n[p].z+(d+h)*o.z),a.push(f,f+1),f+=2}const g=new be;return g.positions=s,g.indices=a,g}function Yf(r,e,t=null){return function PT(r,e,t){const i=e.instance,n=e.lines,s=e.colors;if(i){const c=i.getVerticesData(I.PositionKind);let u,h;s&&(u=i.getVerticesData(I.ColorKind));let d=0,f=0;for(let p=0;p<n.length;p++){const g=n[p];for(let _=0;_<g.length;_++)c[d]=g[_].x,c[d+1]=g[_].y,c[d+2]=g[_].z,s&&u&&(h=s[p],u[f]=h[_].r,u[f+1]=h[_].g,u[f+2]=h[_].b,u[f+3]=h[_].a,f+=4),d+=3}return i.updateVerticesData(I.PositionKind,c,!1,!1),s&&u&&i.updateVerticesData(I.ColorKind,u,!1,!1),i}const o=new kc(r,t,null,void 0,void 0,!!s,e.useVertexAlpha,e.material);return vR(e).applyToMesh(o,e.updatable),o}(r,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:e.colors?[e.colors]:null,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}be.CreateRibbon=hR,U.CreateRibbon=(r,e,t=!1,i,n,s,a=!1,o,l)=>ko(r,{pathArray:e,closeArray:t,closePath:i,offset:n,updatable:a,sideOrientation:o,instance:l},s),be.CreateDisc=dR,U.CreateDisc=(r,e,t,i=null,n,s)=>Wf(r,{radius:e,tessellation:t,sideOrientation:s,updatable:n},i),be.CreateBox=CT,U.CreateBox=(r,e,t=null,i,n)=>function IT(r,e={},t=null){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,CT(e).applyToMesh(i,e.updatable),i}(r,{size:e,sideOrientation:n,updatable:i},t),be.CreateTiledPlane=xh,be.CreateTiledBox=function pR(r){const t=r.faceUV||new Array(6),i=r.faceColors,n=r.pattern||U.NO_FLIP,s=r.width||r.size||1,a=r.height||r.size||1,o=r.depth||r.size||1,l=r.tileWidth||r.tileSize||1,c=r.tileHeight||r.tileSize||1,u=r.alignHorizontal||0,h=r.alignVertical||0,d=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE;for(let w=0;w<6;w++)void 0===t[w]&&(t[w]=new Qt(0,0,1,1)),i&&void 0===i[w]&&(i[w]=new ct(1,1,1,1));const f=s/2,p=a/2,g=o/2,_=[];for(let w=0;w<2;w++)_[w]=xh({pattern:n,tileWidth:l,tileHeight:c,width:s,height:a,alignVertical:h,alignHorizontal:u,sideOrientation:d});for(let w=2;w<4;w++)_[w]=xh({pattern:n,tileWidth:l,tileHeight:c,width:o,height:a,alignVertical:h,alignHorizontal:u,sideOrientation:d});let m=h;h===U.BOTTOM?m=U.TOP:h===U.TOP&&(m=U.BOTTOM);for(let w=4;w<6;w++)_[w]=xh({pattern:n,tileWidth:l,tileHeight:c,width:s,height:o,alignVertical:m,alignHorizontal:u,sideOrientation:d});let T=[],v=[],A=[],S=[];const x=[],C=[],R=[],D=[];let P=0,N=0;for(let w=0;w<6;w++){const Y=_[w].positions.length;C[w]=[],R[w]=[];for(let se=0;se<Y/3;se++)C[w].push(new E(_[w].positions[3*se],_[w].positions[3*se+1],_[w].positions[3*se+2])),R[w].push(new E(_[w].normals[3*se],_[w].normals[3*se+1],_[w].normals[3*se+2]));P=_[w].uvs.length,D[w]=[];for(let se=0;se<P;se+=2)D[w][se]=t[w].x+(t[w].z-t[w].x)*_[w].uvs[se],D[w][se+1]=t[w].y+(t[w].w-t[w].y)*_[w].uvs[se+1],jt.UseOpenGLOrientationForUV&&(D[w][se+1]=1-D[w][se+1]);if(A=A.concat(D[w]),S=S.concat(_[w].indices.map(se=>se+N)),N+=C[w].length,i)for(let se=0;se<4;se++)x.push(i[w].r,i[w].g,i[w].b,i[w].a)}const k=new E(0,0,g),X=B.RotationY(Math.PI);T=C[0].map(w=>E.TransformNormal(w,X).add(k)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[]),v=R[0].map(w=>E.TransformNormal(w,X)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[]),T=T.concat(C[1].map(w=>w.subtract(k)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[])),v=v.concat(R[1].map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[]));const ne=new E(f,0,0),ge=B.RotationY(-Math.PI/2);T=T.concat(C[2].map(w=>E.TransformNormal(w,ge).add(ne)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[])),v=v.concat(R[2].map(w=>E.TransformNormal(w,ge)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[]));const ue=B.RotationY(Math.PI/2);T=T.concat(C[3].map(w=>E.TransformNormal(w,ue).subtract(ne)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[])),v=v.concat(R[3].map(w=>E.TransformNormal(w,ue)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[]));const ke=new E(0,p,0),me=B.RotationX(Math.PI/2);T=T.concat(C[4].map(w=>E.TransformNormal(w,me).add(ke)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[])),v=v.concat(R[4].map(w=>E.TransformNormal(w,me)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[]));const $=B.RotationX(-Math.PI/2);T=T.concat(C[5].map(w=>E.TransformNormal(w,$).subtract(ke)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[])),v=v.concat(R[5].map(w=>E.TransformNormal(w,$)).map(w=>[w.x,w.y,w.z]).reduce((w,Y)=>w.concat(Y),[])),be._ComputeSides(d,T,S,v,A);const Q=new be;if(Q.indices=S,Q.positions=T,Q.normals=v,Q.uvs=A,i){const w=d===be.DOUBLESIDE?x.concat(x):x;Q.colors=w}return Q},be.CreateSphere=_R,U.CreateSphere=(r,e,t,i,n,s)=>Xf(r,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:n},i),be.CreateCylinder=mR,U.CreateCylinder=(r,e,t,i,n,s,a,o,l)=>((void 0===a||!(a instanceof dt))&&(void 0!==a&&(l=o||U.DEFAULTSIDE,o=a),a=s,s=1),function RT(r,e={},t){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,mR(e).applyToMesh(i,e.updatable),i}(r,{height:e,diameterTop:t,diameterBottom:i,tessellation:n,subdivisions:s,sideOrientation:l,updatable:o},a)),be.CreateTorus=TR,U.CreateTorus=(r,e,t,i,n,s,a)=>function MT(r,e={},t){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,TR(e).applyToMesh(i,e.updatable),i}(r,{diameter:e,thickness:t,tessellation:i,sideOrientation:a,updatable:s},n),be.CreateTorusKnot=ER,U.CreateTorusKnot=(r,e,t,i,n,s,a,o,l,c)=>function DT(r,e={},t){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,ER(e).applyToMesh(i,e.updatable),i}(r,{radius:e,tube:t,radialSegments:i,tubularSegments:n,p:s,q:a,sideOrientation:c,updatable:l},o),be.CreateLineSystem=vR,be.CreateDashedLines=SR,U.CreateLines=(r,e,t=null,i=!1,n=null)=>Yf(r,{points:e,updatable:i,instance:n},t),U.CreateDashedLines=(r,e,t,i,n,s=null,a,o)=>function wT(r,e,t=null){const i=e.points,n=e.instance,s=e.gapSize||1,a=e.dashSize||3;if(n){const c=u=>{const h=E.Zero(),d=u.length/6;let f=0,p=0,g=0,_=0,m=0,T=0,v=0,A=0;for(v=0;v<i.length-1;v++)i[v+1].subtractToRef(i[v],h),f+=h.length();g=f/d;const S=n._creationDataStorage.dashSize;for(_=S*g/(S+n._creationDataStorage.gapSize),v=0;v<i.length-1;v++)for(i[v+1].subtractToRef(i[v],h),p=Math.floor(h.length()/g),h.normalize(),A=0;A<p&&T<u.length;)m=g*A,u[T]=i[v].x+m*h.x,u[T+1]=i[v].y+m*h.y,u[T+2]=i[v].z+m*h.z,u[T+3]=i[v].x+(m+_)*h.x,u[T+4]=i[v].y+(m+_)*h.y,u[T+5]=i[v].z+(m+_)*h.z,T+=6,A++;for(;T<u.length;)u[T]=i[v].x,u[T+1]=i[v].y,u[T+2]=i[v].z,T+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&H.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),n.updateMeshPositions(c,!1),n}const o=new kc(r,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return SR(e).applyToMesh(o,e.updatable),o._creationDataStorage=new qI,o._creationDataStorage.dashSize=a,o._creationDataStorage.gapSize=s,o}(r,{points:e,dashSize:t,gapSize:i,dashNb:n,updatable:a,instance:o},s);class xW extends We{constructor(e,t){super(e.x,e.y),this.index=t}}class OT{constructor(){this.elements=new Array}add(e){const t=new Array;return e.forEach(i=>{const n=new xW(i,this.elements.length);t.push(n),this.elements.push(n)}),t}computeBounds(){const e=new We(this.elements[0].x,this.elements[0].y),t=new We(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class AW{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,n=earcut){let s;this._points=new OT,this._outlinepoints=new OT,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=n,this._name=e,this._scene=i||Je.LastCreatedScene,s=t instanceof $m?t.getPoints():t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),void 0===this.bjsEarcut&&H.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new OT;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const n=new U(this._name,this._scene),s=this.buildVertexData(t,i);return n.setVerticesData(I.PositionKind,s.positions,e),n.setVerticesData(I.NormalKind,s.normals,e),n.setVerticesData(I.UVKind,s.uvs,e),n.setIndices(s.indices),n}buildVertexData(e=0,t=2){const i=new be,n=new Array,s=new Array,a=new Array,o=this._points.computeBounds();this._points.elements.forEach(u=>{n.push(0,1,0),s.push(u.x,0,u.y),a.push((u.x-o.min.x)/o.width,(u.y-o.min.y)/o.height)});const l=new Array,c=this.bjsEarcut(this._epoints,this._eholes,2);for(let u=0;u<c.length;u++)l.push(c[u]);if(e>0){const u=s.length/3;this._points.elements.forEach(d=>{n.push(0,-1,0),s.push(d.x,-e,d.y),a.push(1-(d.x-o.min.x)/o.width,1-(d.y-o.min.y)/o.height)});const h=l.length;for(let d=0;d<h;d+=3){const f=l[d+0],p=l[d+1];l.push(l[d+2]+u),l.push(p+u),l.push(f+u)}this._addSide(s,n,a,l,o,this._outlinepoints,e,!1,t),this._holes.forEach(d=>{this._addSide(s,n,a,l,o,d,e,!0,t)})}return i.indices=l,i.positions=s,i.normals=n,i.uvs=a,i}_addSide(e,t,i,n,s,a,o,l,c){let u=e.length/3,h=0;for(let d=0;d<a.elements.length;d++){const f=a.elements[d],p=a.elements[(d+1)%a.elements.length];e.push(f.x,0,f.y),e.push(f.x,-o,f.y),e.push(p.x,0,p.y),e.push(p.x,-o,p.y);const g=a.elements[(d+a.elements.length-1)%a.elements.length],_=a.elements[(d+2)%a.elements.length];let m=new E(-(p.y-f.y),0,p.x-f.x),T=new E(-(f.y-g.y),0,f.x-g.x),v=new E(-(_.y-p.y),0,_.x-p.x);l||(m=m.scale(-1),T=T.scale(-1),v=v.scale(-1));const A=m.normalizeToNew();let S=T.normalizeToNew(),x=v.normalizeToNew();const C=E.Dot(S,A);S=C>c?C<kt-1?new E(f.x,0,f.y).subtract(new E(p.x,0,p.y)).normalize():T.add(m).normalize():A;const R=E.Dot(v,m);x=R>c?R<kt-1?new E(p.x,0,p.y).subtract(new E(f.x,0,f.y)).normalize():v.add(m).normalize():A,i.push(h/s.width,0),i.push(h/s.width,1),h+=m.length(),i.push(h/s.width,0),i.push(h/s.width,1),t.push(S.x,S.y,S.z),t.push(S.x,S.y,S.z),t.push(x.x,x.y,x.z),t.push(x.x,x.y,x.z),l?(n.push(u),n.push(u+2),n.push(u+1),n.push(u+1),n.push(u+2),n.push(u+3)):(n.push(u),n.push(u+1),n.push(u+2),n.push(u+1),n.push(u+3),n.push(u+2)),u+=4}}}function xR(r,e,t,i,n,s,a){const o=t||new Array(3),l=i,c=[],u=a||!1;for(let D=0;D<3;D++)void 0===o[D]&&(o[D]=new Qt(0,0,1,1)),l&&void 0===l[D]&&(l[D]=new ct(1,1,1,1));const h=r.getVerticesData(I.PositionKind),d=r.getVerticesData(I.NormalKind),f=r.getVerticesData(I.UVKind),p=r.getIndices(),g=h.length/9;let _=0,m=0,T=0,v=0,A=0;const S=[0];if(u)for(let D=g;D<h.length/3;D+=4)m=h[3*(D+2)]-h[3*D],T=h[3*(D+2)+2]-h[3*D+2],v=Math.sqrt(m*m+T*T),A+=v,S.push(A);let x=0,C=0;for(let D=0;D<d.length;D+=3)Math.abs(d[D+1])<.001&&(C=1),Math.abs(d[D+1]-1)<.001&&(C=0),Math.abs(d[D+1]+1)<.001&&(C=2),x=D/3,1===C?(_=x-g,f[2*x]=_%4<1.5?u?o[C].x+(o[C].z-o[C].x)*S[Math.floor(_/4)]/A:o[C].x:u?o[C].x+(o[C].z-o[C].x)*S[Math.floor(_/4)+1]/A:o[C].z,f[2*x+1]=_%2==0?jt.UseOpenGLOrientationForUV?1-o[C].w:o[C].w:jt.UseOpenGLOrientationForUV?1-o[C].y:o[C].y):(f[2*x]=(1-f[2*x])*o[C].x+f[2*x]*o[C].z,f[2*x+1]=(1-f[2*x+1])*o[C].y+f[2*x+1]*o[C].w,jt.UseOpenGLOrientationForUV&&(f[2*x+1]=1-f[2*x+1])),l&&c.push(l[C].r,l[C].g,l[C].b,l[C].a);be._ComputeSides(e,h,p,d,f,n,s);const R=new be;if(R.indices=p,R.positions=h,R.normals=d,R.uvs=f,l){const D=e===be.DOUBLESIDE?c.concat(c):c;R.colors=D}return R}function jf(r,e,t=null,i=earcut){e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation);const n=e.shape,s=e.holes||[],a=e.depth||0,o=e.smoothingThreshold||2,l=[];let c=[];for(let p=0;p<n.length;p++)l[p]=new We(n[p].x,n[p].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();const h=new AW(r,l,t||Je.LastCreatedScene,i);for(let p=0;p<s.length;p++){c=[];for(let g=0;g<s[p].length;g++)c.push(new We(s[p][g].x,s[p][g].z));h.addHole(c)}const d=h.build(!1,a,o);return d._originalBuilderSideOrientation=e.sideOrientation,xR(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function $f(r,e,t=null){const i=e.path,n=e.shape,s=e.scale||1,a=e.rotation||0,o=0===e.cap?0:e.cap||U.NO_CAP,l=e.updatable,c=U._GetDefaultSideOrientation(e.sideOrientation);return AR(r,n,i,s,a,null,null,e.closePath||!1,e.closeShape||!1,o,!1,t,!!l,c,e.instance||null,e.invertUV||!1,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function AR(r,e,t,i,n,s,a,o,l,c,u,h,d,f,p,g,_,m,T,v){const A=(D,P,N,k,X,ne,ge,ue,ke,me,$)=>{const Q=N.getTangents(),w=N.getNormals(),Y=N.getBinormals(),se=N.getDistances();if($)for(let qe=0;qe<Q.length;qe++)if(0==Q[qe].x&&0==Q[qe].y&&0==Q[qe].z&&Q[qe].copyFrom(Q[qe-1]),0==w[qe].x&&0==w[qe].y&&0==w[qe].z&&w[qe].copyFrom(w[qe-1]),0==Y[qe].x&&0==Y[qe].y&&0==Y[qe].z&&Y[qe].copyFrom(Y[qe-1]),qe>0){let qt=Q[qe-1];E.Dot(qt,Q[qe])<0&&Q[qe].scaleInPlace(-1),qt=w[qe-1],E.Dot(qt,w[qe])<0&&w[qe].scaleInPlace(-1),qt=Y[qe-1],E.Dot(qt,Y[qe])<0&&Y[qe].scaleInPlace(-1)}let Re=0;const _e=me&&ue?ue:()=>null!==ne?ne:0,Xe=me&&ge?ge:()=>null!==X?X:1;let Xt=ke===U.NO_CAP||ke===U.CAP_END?0:2;const ti=z.Matrix[0];for(let qe=0;qe<P.length;qe++){const qt=new Array,Ei=_e(qe,se[qe]),Ci=Xe(qe,se[qe]);B.RotationAxisToRef(Q[qe],Re,ti);for(let qi=0;qi<D.length;qi++){const Ps=Q[qe].scale(D[qi].z).add(w[qe].scale(D[qi].x)).add(Y[qe].scale(D[qi].y)),Tr=E.Zero();E.TransformCoordinatesToRef(Ps,ti,Tr),Tr.scaleInPlace(Ci).addInPlace(P[qe]),qt[qi]=Tr}k[Xt]=qt,Re+=Ei,Xt++}const Mt=qe=>{const qt=Array(),Ei=E.Zero();let Ci;for(Ci=0;Ci<qe.length;Ci++)Ei.addInPlace(qe[Ci]);for(Ei.scaleInPlace(1/qe.length),Ci=0;Ci<qe.length;Ci++)qt.push(Ei);return qt};switch(ke){case U.NO_CAP:break;case U.CAP_START:k[0]=Mt(k[2]),k[1]=k[2];break;case U.CAP_END:k[Xt]=k[Xt-1],k[Xt+1]=Mt(k[Xt-1]);break;case U.CAP_ALL:k[0]=Mt(k[2]),k[1]=k[2],k[Xt]=k[Xt-1],k[Xt+1]=Mt(k[Xt-1])}return k};let S,x;if(p){const D=p._creationDataStorage;return S=T?D.path3D.update(t,T):D.path3D.update(t),x=A(e,t,D.path3D,D.pathArray,i,n,s,a,D.cap,u,v),ko("",{pathArray:x,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},h||void 0)}S=T?new ch(t,T):new ch(t),x=A(e,t,S,new Array,i,n,s,a,c=c<0||c>3?0:c,u,v);const R=ko(r,{pathArray:x,closeArray:o,closePath:l,updatable:d,sideOrientation:f,invertUV:g,frontUVs:_||void 0,backUVs:m||void 0},h);return R._creationDataStorage.pathArray=x,R._creationDataStorage.path3D=S,R._creationDataStorage.cap=c,R}function yR(r){const e=[],t=[],i=[],n=[],o=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,l=(r.width||r.size||1)/2,c=(r.height||r.size||1)/2;t.push(-l,-c,0),i.push(0,0,-1),n.push(0,jt.UseOpenGLOrientationForUV?1:0),t.push(l,-c,0),i.push(0,0,-1),n.push(1,jt.UseOpenGLOrientationForUV?1:0),t.push(l,c,0),i.push(0,0,-1),n.push(1,jt.UseOpenGLOrientationForUV?0:1),t.push(-l,c,0),i.push(0,0,-1),n.push(0,jt.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),be._ComputeSides(o,t,e,i,n,r.frontUVs,r.backUVs);const u=new be;return u.indices=e,u.positions=t,u.normals=i,u.uvs=n,u}function bR(r){const e=[],t=[],i=[],n=[];let s,a;const o=r.width||1,l=r.height||1,c=r.subdivisionsX||r.subdivisions||1,u=r.subdivisionsY||r.subdivisions||1;for(s=0;s<=u;s++)for(a=0;a<=c;a++){const d=new E(a*o/c-o/2,0,(u-s)*l/u-l/2),f=new E(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),n.push(a/c,jt.UseOpenGLOrientationForUV?s/u:1-s/u)}for(s=0;s<u;s++)for(a=0;a<c;a++)e.push(a+1+(s+1)*(c+1)),e.push(a+1+s*(c+1)),e.push(a+s*(c+1)),e.push(a+(s+1)*(c+1)),e.push(a+1+(s+1)*(c+1)),e.push(a+s*(c+1));const h=new be;return h.indices=e,h.positions=t,h.normals=i,h.uvs=n,h}function CR(r){const e=null!=r.xmin?r.xmin:-1,t=null!=r.zmin?r.zmin:-1,i=null!=r.xmax?r.xmax:1,n=null!=r.zmax?r.zmax:1,s=r.subdivisions||{w:1,h:1},a=r.precision||{w:1,h:1},o=new Array,l=new Array,c=new Array,u=new Array;let h,d,f,p;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;const g_w=(i-e)/s.w,g_h=(n-t)/s.h;function _(T,v,A,S){const x=l.length/3,C=a.w+1;for(h=0;h<a.h;h++)for(d=0;d<a.w;d++){const P=[x+d+h*C,x+(d+1)+h*C,x+(d+1)+(h+1)*C,x+d+(h+1)*C];o.push(P[1]),o.push(P[2]),o.push(P[3]),o.push(P[0]),o.push(P[1]),o.push(P[3])}const R=E.Zero(),D=new E(0,1,0);for(h=0;h<=a.h;h++)for(R.z=h*(S-v)/a.h+v,d=0;d<=a.w;d++)R.x=d*(A-T)/a.w+T,R.y=0,l.push(R.x,R.y,R.z),c.push(D.x,D.y,D.z),u.push(d/a.w,h/a.h)}for(f=0;f<s.h;f++)for(p=0;p<s.w;p++)_(e+p*g_w,t+f*g_h,e+(p+1)*g_w,t+(f+1)*g_h);const m=new be;return m.indices=o,m.positions=l,m.normals=c,m.uvs=u,m}function IR(r){const e=[],t=[],i=[],n=[];let s,a;const o=r.colorFilter||new Fe(.3,.59,.11),l=r.alphaFilter||0;let c=!1;if(r.minHeight>r.maxHeight){c=!0;const h=r.maxHeight;r.maxHeight=r.minHeight,r.minHeight=h}for(s=0;s<=r.subdivisions;s++)for(a=0;a<=r.subdivisions;a++){const h=new E(a*r.width/r.subdivisions-r.width/2,0,(r.subdivisions-s)*r.height/r.subdivisions-r.height/2),p=4*(((h.x+r.width/2)/r.width*(r.bufferWidth-1)|0)+((1-(h.z+r.height/2)/r.height)*(r.bufferHeight-1)|0)*r.bufferWidth);let g=r.buffer[p]/255,_=r.buffer[p+1]/255,m=r.buffer[p+2]/255;c&&(g=1-g,_=1-_,m=1-m);const v=g*o.r+_*o.g+m*o.b;h.y=r.buffer[p+3]/255>=l?r.minHeight+(r.maxHeight-r.minHeight)*v:r.minHeight-kt,t.push(h.x,h.y,h.z),i.push(0,0,0),n.push(a/r.subdivisions,1-s/r.subdivisions)}for(s=0;s<r.subdivisions;s++)for(a=0;a<r.subdivisions;a++){const h=a+1+(s+1)*(r.subdivisions+1),d=a+1+s*(r.subdivisions+1),f=a+s*(r.subdivisions+1),p=a+(s+1)*(r.subdivisions+1),g=t[3*h+1]>=r.minHeight,_=t[3*d+1]>=r.minHeight,m=t[3*f+1]>=r.minHeight;g&&_&&m&&(e.push(h),e.push(d),e.push(f)),t[3*p+1]>=r.minHeight&&g&&m&&(e.push(p),e.push(h),e.push(f))}be.ComputeNormals(t,e,i);const u=new be;return u.indices=e,u.positions=t,u.normals=i,u.uvs=n,u}function RR(r){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const i=r.size,n=r.sizeX||i||1,s=r.sizeY||i||1,a=r.sizeZ||i||1,o=r.custom||e[r.type&&(r.type<0||r.type>=e.length)?0:r.type||0],l=o.face.length,c=r.faceUV||new Array(l),u=r.faceColors,h=void 0===r.flat||r.flat,d=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,f=new Array,p=new Array,g=new Array,_=new Array,m=new Array;let T=0,v=0;const A=new Array;let C,R,D,P,N,k,S=0,x=0;if(h)for(x=0;x<l;x++)u&&void 0===u[x]&&(u[x]=new ct(1,1,1,1)),c&&void 0===c[x]&&(c[x]=new Qt(0,0,1,1));if(h)for(x=0;x<l;x++){const ne=o.face[x].length;for(D=2*Math.PI/ne,P=.5*Math.tan(D/2),N=.5,S=0;S<ne;S++)f.push(o.vertex[o.face[x][S]][0]*n,o.vertex[o.face[x][S]][1]*s,o.vertex[o.face[x][S]][2]*a),A.push(T),T++,C=c[x].x+(c[x].z-c[x].x)*(.5+P),R=c[x].y+(c[x].w-c[x].y)*(N-.5),_.push(C,jt.UseOpenGLOrientationForUV?1-R:R),k=P*Math.cos(D)-N*Math.sin(D),N=P*Math.sin(D)+N*Math.cos(D),P=k,u&&m.push(u[x].r,u[x].g,u[x].b,u[x].a);for(S=0;S<ne-2;S++)p.push(A[0+v],A[S+2+v],A[S+1+v]);v+=ne}else{for(S=0;S<o.vertex.length;S++)f.push(o.vertex[S][0]*n,o.vertex[S][1]*s,o.vertex[S][2]*a),_.push(0,jt.UseOpenGLOrientationForUV?1:0);for(x=0;x<l;x++)for(S=0;S<o.face[x].length-2;S++)p.push(o.face[x][0],o.face[x][S+2],o.face[x][S+1])}be.ComputeNormals(f,p,g),be._ComputeSides(d,f,p,g,_,r.frontUVs,r.backUVs);const X=new be;return X.positions=f,X.indices=p,X.normals=g,X.uvs=_,u&&h&&(X.colors=m),X}function MR(r){const e=r.sideOrientation||be.DEFAULTSIDE,t=r.radius||1,i=void 0===r.flat||r.flat,n=r.subdivisions||4,s=r.radiusX||t,a=r.radiusY||t,o=r.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],u=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],h=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],v=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],A=new Array,S=new Array,x=new Array,C=new Array;let R=0;const D=new Array(3),P=new Array(3);let N;for(N=0;N<3;N++)D[N]=E.Zero(),P[N]=We.Zero();for(let X=0;X<20;X++){for(N=0;N<3;N++){const ge=u[3*X+N];D[N].copyFromFloats(c[3*h[ge]],c[3*h[ge]+1],c[3*h[ge]+2]),D[N].normalize(),P[N].copyFromFloats(.134765625*d[2*ge]+.05859375+-.0390625*v[X],.2333984375*d[2*ge+1]+.025390625+.01953125*v[X])}const ne=(ge,ue,ke,me)=>{const $=E.Lerp(D[0],D[2],ue/n),Q=E.Lerp(D[1],D[2],ue/n),w=n===ue?D[2]:E.Lerp($,Q,ge/(n-ue));let Y;if(w.normalize(),i){const $e=E.Lerp(D[0],D[2],me/n),_e=E.Lerp(D[1],D[2],me/n);Y=E.Lerp($e,_e,ke/(n-me))}else Y=new E(w.x,w.y,w.z);Y.x/=s,Y.y/=a,Y.z/=o,Y.normalize();const se=We.Lerp(P[0],P[2],ue/n),Re=We.Lerp(P[1],P[2],ue/n),mt=n===ue?P[2]:We.Lerp(se,Re,ge/(n-ue));S.push(w.x*s,w.y*a,w.z*o),x.push(Y.x,Y.y,Y.z),C.push(mt.x,jt.UseOpenGLOrientationForUV?1-mt.y:mt.y),A.push(R),R++};for(let ge=0;ge<n;ge++)for(let ue=0;ue+ge<n;ue++)ne(ue,ge,ue+1/3,ge+1/3),ne(ue+1,ge,ue+1/3,ge+1/3),ne(ue,ge+1,ue+1/3,ge+1/3),ue+ge+1<n&&(ne(ue+1,ge,ue+2/3,ge+2/3),ne(ue+1,ge+1,ue+2/3,ge+2/3),ne(ue,ge+1,ue+2/3,ge+2/3))}be._ComputeSides(e,S,A,x,C,r.frontUVs,r.backUVs);const k=new be;return k.indices=A,k.positions=S,k.normals=x,k.uvs=C,k}be.CreatePolygon=xR,U.CreatePolygon=(r,e,t,i,n,s,a=earcut)=>jf(r,{shape:e,holes:i,updatable:n,sideOrientation:s},t,a),U.ExtrudePolygon=(r,e,t,i,n,s,a,o=earcut)=>function FT(r,e,t=null,i=earcut){return jf(r,e,t,i)}(r,{shape:e,holes:n,depth:t,updatable:s,sideOrientation:a},i,o),U.ExtrudeShape=(r,e,t,i,n,s,a=null,o,l,c)=>$f(r,{shape:e,path:t,scale:i,rotation:n,cap:0===s?0:s||U.NO_CAP,sideOrientation:l,instance:c,updatable:o},a),U.ExtrudeShapeCustom=(r,e,t,i,n,s,a,o,l,c,u,h)=>function NT(r,e,t=null){const h=e.firstNormal||null,d=e.adjustFrame||!1;return AR(r,e.shape,e.path,null,null,e.scaleFunction||(()=>1),e.rotationFunction||(()=>0),e.closePath||e.ribbonCloseArray||!1,e.closeShape||e.ribbonClosePath||!1,0===e.cap?0:e.cap||U.NO_CAP,!0,t,!!e.updatable,U._GetDefaultSideOrientation(e.sideOrientation),e.instance||null,e.invertUV||!1,e.frontUVs||null,e.backUVs||null,h,d)}(r,{shape:e,path:t,scaleFunction:i,rotationFunction:n,ribbonCloseArray:s,ribbonClosePath:a,cap:0===o?0:o||U.NO_CAP,sideOrientation:u,instance:h,updatable:c},l),U.CreateLathe=(r,e,t,i,n,s,a)=>function LT(r,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,n=void 0===e.closed||e.closed,s=e.shape,a=e.radius||1,o=e.tessellation||64,l=e.clip||0,c=e.updatable,u=U._GetDefaultSideOrientation(e.sideOrientation),h=e.cap||U.NO_CAP,d=2*Math.PI,f=new Array,p=e.invertUV||!1;let g=0,_=0;const m=d/o*i;let T,v;for(g=0;g<=o-l;g++){for(v=[],(h==U.CAP_START||h==U.CAP_ALL)&&(v.push(new E(0,s[0].y,0)),v.push(new E(Math.cos(g*m)*s[0].x*a,s[0].y,Math.sin(g*m)*s[0].x*a))),_=0;_<s.length;_++)T=new E(Math.cos(g*m)*s[_].x*a,s[_].y,Math.sin(g*m)*s[_].x*a),v.push(T);(h==U.CAP_END||h==U.CAP_ALL)&&(v.push(new E(Math.cos(g*m)*s[s.length-1].x*a,s[s.length-1].y,Math.sin(g*m)*s[s.length-1].x*a)),v.push(new E(0,s[s.length-1].y,0))),f.push(v)}return ko(r,{pathArray:f,closeArray:n,sideOrientation:u,updatable:c,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}(r,{shape:e,radius:t,tessellation:i,sideOrientation:a,updatable:s},n),be.CreatePlane=yR,U.CreatePlane=(r,e,t,i,n)=>function BT(r,e={},t=null){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,yR(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}(r,{size:e,width:e,height:e,sideOrientation:n,updatable:i},t),be.CreateGround=bR,be.CreateTiledGround=CR,be.CreateGroundFromHeightMap=IR,U.CreateGround=(r,e,t,i,n,s)=>function UT(r,e={},t){const i=new Sh(r,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,bR(e).applyToMesh(i,e.updatable),i._setReady(!0),i}(r,{width:e,height:t,subdivisions:i,updatable:s},n),U.CreateTiledGround=(r,e,t,i,n,s,a,o,l)=>function VT(r,e,t=null){const i=new U(r,t);return CR(e).applyToMesh(i,e.updatable),i}(r,{xmin:e,zmin:t,xmax:i,zmax:n,subdivisions:s,precision:a,updatable:l},o),U.CreateGroundFromHeightMap=(r,e,t,i,n,s,a,o,l,c,u)=>function kT(r,e,t={},i=null){const n=t.width||10,s=t.height||10,a=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new Fe(.3,.59,.11),u=t.alphaFilter||0,h=t.updatable,d=t.onReady,f=new Sh(r,i=i||Je.LastCreatedScene);return f._subdivisionsX=a,f._subdivisionsY=a,f._width=n,f._height=s,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1),Ie.LoadImage(e,g=>{const _=g.width,m=g.height;if(i.isDisposed)return;const T=null==i?void 0:i.getEngine().resizeImageBitmap(g,_,m);IR({width:n,height:s,subdivisions:a,minHeight:o,maxHeight:l,colorFilter:c,buffer:T,bufferWidth:_,bufferHeight:m,alphaFilter:u}).applyToMesh(f,h),d&&d(f),f._setReady(!0)},()=>{},i.offlineProvider),f}(r,e,{width:t,height:i,subdivisions:n,minHeight:s,maxHeight:a,updatable:l,onReady:c,alphaFilter:u},o),U.CreateTube=(r,e,t,i,n,s,a,o,l,c)=>function GT(r,e,t=null){const i=e.path;let n=e.instance,s=1;void 0!==e.radius?s=e.radius:n&&(s=n._creationDataStorage.radius);const a=e.tessellation||64,o=e.radiusFunction||null;let l=e.cap||U.NO_CAP;const c=e.invertUV||!1,u=e.updatable,h=U._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const d=(m,T,v,A,S,x,C,R)=>{const D=T.getTangents(),P=T.getNormals(),N=T.getDistances(),X=2*Math.PI/S*R,ge=x||(()=>A);let ue,ke,me,$;const Q=z.Matrix[0];let w=C===U.NO_CAP||C===U.CAP_END?0:2;for(let se=0;se<m.length;se++){ke=ge(se,N[se]),ue=Array(),me=P[se];for(let Re=0;Re<S;Re++)B.RotationAxisToRef(D[se],X*Re,Q),$=ue[Re]?ue[Re]:E.Zero(),E.TransformCoordinatesToRef(me,Q,$),$.scaleInPlace(ke).addInPlace(m[se]),ue[Re]=$;v[w]=ue,w++}const Y=(se,Re)=>{const mt=Array();for(let $e=0;$e<se;$e++)mt.push(m[Re]);return mt};switch(C){case U.NO_CAP:break;case U.CAP_START:v[0]=Y(S,0),v[1]=v[2].slice(0);break;case U.CAP_END:v[w]=v[w-1].slice(0),v[w+1]=Y(S,m.length-1);break;case U.CAP_ALL:v[0]=Y(S,0),v[1]=v[2].slice(0),v[w]=v[w-1].slice(0),v[w+1]=Y(S,m.length-1)}return v};let f,p;if(n){const m=n._creationDataStorage,T=e.arc||m.arc;return f=m.path3D.update(i),p=d(i,f,m.pathArray,s,m.tessellation,o,m.cap,T),n=ko("",{pathArray:p,instance:n}),m.path3D=f,m.pathArray=p,m.arc=T,m.radius=s,n}f=new ch(i),l=l<0||l>3?0:l,p=d(i,f,new Array,s,a,o,l,e.arc);const _=ko(r,{pathArray:p,closePath:!0,closeArray:!1,updatable:u,sideOrientation:h,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return _._creationDataStorage.pathArray=p,_._creationDataStorage.path3D=f,_._creationDataStorage.tessellation=a,_._creationDataStorage.cap=l,_._creationDataStorage.arc=e.arc,_._creationDataStorage.radius=s,_}(r,{path:e,radius:t,tessellation:i,radiusFunction:n,arc:1,cap:s,updatable:o,sideOrientation:l,instance:c},a),be.CreatePolyhedron=RR,U.CreatePolyhedron=(r,e,t)=>function Kf(r,e={},t=null){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,RR(e).applyToMesh(i,e.updatable),i}(r,e,t),be.CreateIcoSphere=MR,U.CreateIcoSphere=(r,e,t)=>function HT(r,e={},t=null){const i=new U(r,t);return e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,MR(e).applyToMesh(i,e.updatable),i}(r,e,t);const yW=new E(1,0,0),bW=new E(-1,0,0),CW=new E(0,1,0),IW=new E(0,-1,0),RW=new E(0,0,1),MW=new E(0,0,-1);class Qf{constructor(e=E.Zero(),t=E.Up(),i=We.Zero(),n=0,s=0,a=null,o=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=n,this.vertexIdxForBones=s,this.localPositionOverride=a,this.localNormalOverride=o,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){var e,t,i,n;return new Qf(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,null===(e=this.localPositionOverride)||void 0===e?void 0:e.slice(),null===(t=this.localNormalOverride)||void 0===t?void 0:t.slice(),null===(i=this.matrixIndicesOverride)||void 0===i?void 0:i.slice(),null===(n=this.matrixWeightsOverride)||void 0===n?void 0:n.slice())}}function DR(r={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(r.subdivisions?r.subdivisions:2,1),t=Math.max(r.tessellation?r.tessellation:16,3),i=Math.max(r.height?r.height:1,0),n=Math.max(r.radius?r.radius:.25,0),s=Math.max(r.capSubdivisions?r.capSubdivisions:6,1),a=t,o=e,l=Math.max(r.radiusTop?r.radiusTop:n,0),c=Math.max(r.radiusBottom?r.radiusBottom:n,0),u=i-(l+c),d=2*Math.PI,f=Math.max(r.topCapSubdivisions?r.topCapSubdivisions:s,1),p=Math.max(r.bottomCapSubdivisions?r.bottomCapSubdivisions:s,1),g=Math.acos((c-l)/i);let _=[];const m=[],T=[],v=[];let A=0;const S=[],x=.5*u,C=.5*Math.PI;let R,D;const P=E.Zero(),N=E.Zero(),k=Math.cos(g),X=Math.sin(g),ne=new We(l*X,x+l*k).subtract(new We(c*X,c*k-x)).length(),ge=l*g+ne+c*(C-g);let ue=0;for(D=0;D<=f;D++){const Q=[],w=C-g*(D/f);ue+=l*g/f;const Y=Math.cos(w),se=Math.sin(w),Re=Y*l;for(R=0;R<=a;R++){const mt=R/a,$e=mt*d+0,_e=Math.sin($e),Xe=Math.cos($e);N.x=Re*_e,N.y=x+se*l,N.z=Re*Xe,m.push(N.x,N.y,N.z),P.set(Y*_e,se,Y*Xe),T.push(P.x,P.y,P.z),v.push(mt,jt.UseOpenGLOrientationForUV?ue/ge:1-ue/ge),Q.push(A),A++}S.push(Q)}const ke=i-l-c+k*l-k*c,me=X*(c-l)/ke;for(D=1;D<=o;D++){const Q=[];ue+=ne/o;const w=X*(D*(c-l)/o+l);for(R=0;R<=a;R++){const Y=R/a,se=Y*d+0,Re=Math.sin(se),mt=Math.cos(se);N.x=w*Re,N.y=x+k*l-D*ke/o,N.z=w*mt,m.push(N.x,N.y,N.z),P.set(Re,me,mt).normalize(),T.push(P.x,P.y,P.z),v.push(Y,jt.UseOpenGLOrientationForUV?ue/ge:1-ue/ge),Q.push(A),A++}S.push(Q)}for(D=1;D<=p;D++){const Q=[],w=C-g-(Math.PI-g)*(D/p);ue+=c*g/p;const Y=Math.cos(w),se=Math.sin(w),Re=Y*c;for(R=0;R<=a;R++){const mt=R/a,$e=mt*d+0,_e=Math.sin($e),Xe=Math.cos($e);N.x=Re*_e,N.y=se*c-x,N.z=Re*Xe,m.push(N.x,N.y,N.z),P.set(Y*_e,se,Y*Xe),T.push(P.x,P.y,P.z),v.push(mt,jt.UseOpenGLOrientationForUV?ue/ge:1-ue/ge),Q.push(A),A++}S.push(Q)}for(R=0;R<a;R++)for(D=0;D<f+o+p;D++){const w=S[D+1][R],Y=S[D+1][R+1],se=S[D][R+1];_.push(S[D][R]),_.push(w),_.push(se),_.push(w),_.push(Y),_.push(se)}if(_=_.reverse(),r.orientation&&!r.orientation.equals(E.Up())){const Q=new B;r.orientation.clone().scale(.5*Math.PI).cross(E.Up()).toQuaternion().toRotationMatrix(Q);const w=E.Zero();for(let Y=0;Y<m.length;Y+=3)w.set(m[Y],m[Y+1],m[Y+2]),E.TransformCoordinatesToRef(w.clone(),Q,w),m[Y]=w.x,m[Y+1]=w.y,m[Y+2]=w.z}const $=new be;return $.positions=m,$.normals=T,$.uvs=v,$.indices=_,$}U.CreateDecal=(r,e,t,i,n,s)=>function zT(r,e,t){const i=!!e.skeleton,n=t.localMode||i,s=null!=e.overrideMaterialSideOrientation,a=e.getIndices(),o=i?e.getPositionData(!0,!0):e.getVerticesData(I.PositionKind),l=i?e.getNormalsData(!0,!0):e.getVerticesData(I.NormalKind),c=n?i?e.getVerticesData(I.PositionKind):o:null,u=n?i?e.getVerticesData(I.NormalKind):l:null,h=e.getVerticesData(I.UVKind),d=i?e.getVerticesData(I.MatricesIndicesKind):null,f=i?e.getVerticesData(I.MatricesWeightsKind):null,p=i?e.getVerticesData(I.MatricesIndicesExtraKind):null,g=i?e.getVerticesData(I.MatricesWeightsExtraKind):null,_=t.position||E.Zero();let m=t.normal||E.Up();const T=t.size||E.One(),v=t.angle||0;if(!m){const me=new E(0,0,1),$=e.getScene().activeCamera,Q=E.TransformCoordinates(me,$.getWorldMatrix());m=$.globalPosition.subtract(Q)}const A=-Math.atan2(m.z,m.x)-Math.PI/2,S=Math.sqrt(m.x*m.x+m.z*m.z),x=Math.atan2(m.y,S),C=B.RotationYawPitchRoll(A,x,v).multiply(B.Translation(_.x,_.y,_.z)),R=B.Invert(C),P=e.getWorldMatrix().multiply(R),N=new be;N.indices=[],N.positions=[],N.normals=[],N.uvs=[],N.matricesIndices=i?[]:null,N.matricesWeights=i?[]:null,N.matricesIndicesExtra=p?[]:null,N.matricesWeightsExtra=g?[]:null;let k=0;const X=me=>{const $=new Qf;if(!a||!o||!l)return $;const Q=a[me];if($.vertexIdx=3*Q,$.vertexIdxForBones=4*Q,$.position=new E(o[3*Q],o[3*Q+1],o[3*Q+2]),E.TransformCoordinatesToRef($.position,P,$.position),$.normal=new E(l[3*Q],l[3*Q+1],l[3*Q+2]),E.TransformNormalToRef($.normal,P,$.normal),t.captureUVS&&h){const w=h[2*Q+1];$.uv=new We(h[2*Q],jt.UseOpenGLOrientationForUV?1-w:w)}return $},ne=[0,0,0,0],ge=(me,$)=>{if(0===me.length)return me;const Q=.5*Math.abs(E.Dot(T,$)),w=(Re,mt,$e,_e)=>{for(let Xe=0;Xe<_e;++Xe)if(Re[$e+Xe]===mt)return $e+Xe;return-1},Y=(Re,mt)=>{var $e,_e,Xe,Xt,ti,Mt,qe,qt,Ei,Ci,qi,Ps,Tr,Qo,Sn,Zo;const qn=E.GetClipFactor(Re.position,mt.position,$,Q);let Na=ne,Fr=ne;if(d&&f){const $h=Re.matrixIndicesOverride?0:Re.vertexIdxForBones,rv=null!==($e=Re.matrixIndicesOverride)&&void 0!==$e?$e:d,jN=null!==(_e=Re.matrixWeightsOverride)&&void 0!==_e?_e:f,sv=mt.matrixIndicesOverride?0:mt.vertexIdxForBones,$N=null!==(Xe=mt.matrixIndicesOverride)&&void 0!==Xe?Xe:d,KN=null!==(Xt=mt.matrixWeightsOverride)&&void 0!==Xt?Xt:f;Na=[0,0,0,0],Fr=[0,0,0,0];let Ul=0;for(let aa=0;aa<4;++aa)if(jN[$h+aa]>0){const Kh=w($N,rv[$h+aa],sv,4);Na[Ul]=rv[$h+aa],Fr[Ul]=Se.Lerp(jN[$h+aa],Kh>=0?KN[Kh]:0,qn),Ul++}for(let aa=0;aa<4&&Ul<4;++aa){const Kh=$N[sv+aa];-1===w(rv,Kh,$h,4)&&(Na[Ul]=Kh,Fr[Ul]=Se.Lerp(0,KN[sv+aa],qn),Ul++)}const kp=Fr[0]+Fr[1]+Fr[2]+Fr[3];Fr[0]/=kp,Fr[1]/=kp,Fr[2]/=kp,Fr[3]/=kp}const Vp=Re.localPositionOverride?Re.localPositionOverride[0]:null!==(ti=null==c?void 0:c[Re.vertexIdx])&&void 0!==ti?ti:0,cu=Re.localPositionOverride?Re.localPositionOverride[1]:null!==(Mt=null==c?void 0:c[Re.vertexIdx+1])&&void 0!==Mt?Mt:0,zN=Re.localPositionOverride?Re.localPositionOverride[2]:null!==(qe=null==c?void 0:c[Re.vertexIdx+2])&&void 0!==qe?qe:0,k$=mt.localPositionOverride?mt.localPositionOverride[0]:null!==(qt=null==c?void 0:c[mt.vertexIdx])&&void 0!==qt?qt:0,G$=mt.localPositionOverride?mt.localPositionOverride[1]:null!==(Ei=null==c?void 0:c[mt.vertexIdx+1])&&void 0!==Ei?Ei:0,H$=mt.localPositionOverride?mt.localPositionOverride[2]:null!==(Ci=null==c?void 0:c[mt.vertexIdx+2])&&void 0!==Ci?Ci:0,WN=Re.localNormalOverride?Re.localNormalOverride[0]:null!==(qi=null==u?void 0:u[Re.vertexIdx])&&void 0!==qi?qi:0,XN=Re.localNormalOverride?Re.localNormalOverride[1]:null!==(Ps=null==u?void 0:u[Re.vertexIdx+1])&&void 0!==Ps?Ps:0,YN=Re.localNormalOverride?Re.localNormalOverride[2]:null!==(Tr=null==u?void 0:u[Re.vertexIdx+2])&&void 0!==Tr?Tr:0,ev=WN+((mt.localNormalOverride?mt.localNormalOverride[0]:null!==(Qo=null==u?void 0:u[mt.vertexIdx])&&void 0!==Qo?Qo:0)-WN)*qn,tv=XN+((mt.localNormalOverride?mt.localNormalOverride[1]:null!==(Sn=null==u?void 0:u[mt.vertexIdx+1])&&void 0!==Sn?Sn:0)-XN)*qn,iv=YN+((mt.localNormalOverride?mt.localNormalOverride[2]:null!==(Zo=null==u?void 0:u[mt.vertexIdx+2])&&void 0!==Zo?Zo:0)-YN)*qn,nv=Math.sqrt(ev*ev+tv*tv+iv*iv);return new Qf(E.Lerp(Re.position,mt.position,qn),E.Lerp(Re.normal,mt.normal,qn).normalize(),We.Lerp(Re.uv,mt.uv,qn),-1,-1,c?[Vp+(k$-Vp)*qn,cu+(G$-cu)*qn,zN+(H$-zN)*qn]:null,u?[ev/nv,tv/nv,iv/nv]:null,Na,Fr)};let se=null;me.length>3&&(se=new Array);for(let Re=0;Re<me.length;Re+=3){let mt=0,$e=null,_e=null,Xe=null,Xt=null;const qt=E.Dot(me[Re].position,$)-Q>0,Ei=E.Dot(me[Re+1].position,$)-Q>0,Ci=E.Dot(me[Re+2].position,$)-Q>0;switch(mt=(qt?1:0)+(Ei?1:0)+(Ci?1:0),mt){case 0:me.length>3?(se.push(me[Re]),se.push(me[Re+1]),se.push(me[Re+2])):se=me;break;case 1:if(se=null!=se?se:new Array,qt&&($e=me[Re+1],_e=me[Re+2],Xe=Y(me[Re],$e),Xt=Y(me[Re],_e)),Ei){$e=me[Re],_e=me[Re+2],Xe=Y(me[Re+1],$e),Xt=Y(me[Re+1],_e),se.push(Xe),se.push(_e.clone()),se.push($e.clone()),se.push(_e.clone()),se.push(Xe.clone()),se.push(Xt);break}Ci&&($e=me[Re],_e=me[Re+1],Xe=Y(me[Re+2],$e),Xt=Y(me[Re+2],_e)),$e&&_e&&Xe&&Xt&&(se.push($e.clone()),se.push(_e.clone()),se.push(Xe),se.push(Xt),se.push(Xe.clone()),se.push(_e.clone()));break;case 2:se=null!=se?se:new Array,qt||($e=me[Re].clone(),_e=Y($e,me[Re+1]),Xe=Y($e,me[Re+2]),se.push($e),se.push(_e),se.push(Xe)),Ei||($e=me[Re+1].clone(),_e=Y($e,me[Re+2]),Xe=Y($e,me[Re]),se.push($e),se.push(_e),se.push(Xe)),Ci||($e=me[Re+2].clone(),_e=Y($e,me[Re]),Xe=Y($e,me[Re+1]),se.push($e),se.push(_e),se.push(Xe))}}return se},ue=new Array(3);for(let me=0;me<a.length;me+=3){let $=ue;if($[0]=X(me),s&&n?($[1]=X(me+2),$[2]=X(me+1)):($[1]=X(me+1),$[2]=X(me+2)),!(t.cullBackFaces&&-$[0].normal.z<=0&&-$[1].normal.z<=0&&-$[2].normal.z<=0)&&($=ge($,yW),$&&($=ge($,bW),$&&($=ge($,CW),$&&($=ge($,IW),$&&($=ge($,RW),$&&($=ge($,MW),$)))))))for(let Q=0;Q<$.length;Q++){const w=$[Q];if(N.indices.push(k),n?(w.localPositionOverride?(N.positions[3*k]=w.localPositionOverride[0],N.positions[3*k+1]=w.localPositionOverride[1],N.positions[3*k+2]=w.localPositionOverride[2]):c&&(N.positions[3*k]=c[w.vertexIdx],N.positions[3*k+1]=c[w.vertexIdx+1],N.positions[3*k+2]=c[w.vertexIdx+2]),w.localNormalOverride?(N.normals[3*k]=w.localNormalOverride[0],N.normals[3*k+1]=w.localNormalOverride[1],N.normals[3*k+2]=w.localNormalOverride[2]):u&&(N.normals[3*k]=u[w.vertexIdx],N.normals[3*k+1]=u[w.vertexIdx+1],N.normals[3*k+2]=u[w.vertexIdx+2])):(w.position.toArray(N.positions,3*k),w.normal.toArray(N.normals,3*k)),N.matricesIndices&&N.matricesWeights&&(w.matrixIndicesOverride?(N.matricesIndices[4*k]=w.matrixIndicesOverride[0],N.matricesIndices[4*k+1]=w.matrixIndicesOverride[1],N.matricesIndices[4*k+2]=w.matrixIndicesOverride[2],N.matricesIndices[4*k+3]=w.matrixIndicesOverride[3]):(d&&(N.matricesIndices[4*k]=d[w.vertexIdxForBones],N.matricesIndices[4*k+1]=d[w.vertexIdxForBones+1],N.matricesIndices[4*k+2]=d[w.vertexIdxForBones+2],N.matricesIndices[4*k+3]=d[w.vertexIdxForBones+3]),p&&N.matricesIndicesExtra&&(N.matricesIndicesExtra[4*k]=p[w.vertexIdxForBones],N.matricesIndicesExtra[4*k+1]=p[w.vertexIdxForBones+1],N.matricesIndicesExtra[4*k+2]=p[w.vertexIdxForBones+2],N.matricesIndicesExtra[4*k+3]=p[w.vertexIdxForBones+3])),w.matrixWeightsOverride?(N.matricesWeights[4*k]=w.matrixWeightsOverride[0],N.matricesWeights[4*k+1]=w.matrixWeightsOverride[1],N.matricesWeights[4*k+2]=w.matrixWeightsOverride[2],N.matricesWeights[4*k+3]=w.matrixWeightsOverride[3]):(f&&(N.matricesWeights[4*k]=f[w.vertexIdxForBones],N.matricesWeights[4*k+1]=f[w.vertexIdxForBones+1],N.matricesWeights[4*k+2]=f[w.vertexIdxForBones+2],N.matricesWeights[4*k+3]=f[w.vertexIdxForBones+3]),g&&N.matricesWeightsExtra&&(N.matricesWeightsExtra[4*k]=g[w.vertexIdxForBones],N.matricesWeightsExtra[4*k+1]=g[w.vertexIdxForBones+1],N.matricesWeightsExtra[4*k+2]=g[w.vertexIdxForBones+2],N.matricesWeightsExtra[4*k+3]=g[w.vertexIdxForBones+3]))),t.captureUVS)w.uv.toArray(N.uvs,2*k);else{N.uvs.push(.5+w.position.x/T.x);const Y=.5+w.position.y/T.y;N.uvs.push(jt.UseOpenGLOrientationForUV?1-Y:Y)}k++}}const ke=new U(r,e.getScene());return N.applyToMesh(ke),n?(ke.skeleton=e.skeleton,ke.parent=e):(ke.position=_.clone(),ke.rotation=new E(x,A,v)),ke.computeWorldMatrix(!0),ke.refreshBoundingInfo(!0,!0),ke}(r,e,{position:t,normal:i,size:n,angle:s}),U.CreateCapsule=(r,e,t)=>function WT(r,e={orientation:E.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new U(r,t);return DR(e).applyToMesh(i,e.updatable),i}(r,e,t),be.CreateCapsule=DR;class ki{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(Math.floor(e),H.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(Math.floor(t),H.Warn("y is not an integer, floor(y) used"))}clone(){return new ki(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(Math.floor(e),H.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(Math.floor(t),H.Warn("n not an integer only floor(n) used"));const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&(Math.floor(e),H.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(Math.floor(t),H.Warn("n is not an integer,   floor(n) used"));const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=E.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new ki(0,0)}}class PR{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new XT("icosahedron","Regular",[[0,nn,-1],[-nn,1,0],[-1,0,-nn],[1,0,-nn],[nn,1,0],[0,nn,1],[-1,0,nn],[-nn,-1,0],[0,-nn,-1],[nn,-1,0],[1,0,nn],[0,-nn,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,n=this.n;let l,c,u,h,d,s=i,a=1,o=0;0!==n&&(s=Se.HCF(i,n)),a=i/s,o=n/s;const f=ki.Zero(),p=new ki(i,n),g=new ki(-n,i+n),_=ki.Zero(),m=ki.Zero(),T=ki.Zero();let A,S,x,C,v=[];const R=[],D=this.vertByDist,P=(N,k,X,ne)=>{A=N+"|"+X,S=k+"|"+ne,A in t||S in t?A in t&&!(S in t)?t[S]=t[A]:S in t&&!(A in t)&&(t[A]=t[S]):(t[A]=e,t[S]=e,e++),R[t[A]]=D[X][0]>2?[-D[X][0],D[X][1],t[A]]:[v[D[X][0]],D[X][1],t[A]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let N=0;N<20;N++){if(v=this.IDATA.face[N],u=v[2],h=v[1],d=v[0],x=f.x+"|"+f.y,A=N+"|"+x,A in t||(t[A]=u,R[u]=[v[D[x][0]],D[x][1]]),x=p.x+"|"+p.y,A=N+"|"+x,A in t||(t[A]=h,R[h]=[v[D[x][0]],D[x][1]]),x=g.x+"|"+g.y,A=N+"|"+x,A in t||(t[A]=d,R[d]=[v[D[x][0]],D[x][1]]),l=this.IDATA.edgematch[N][0],c=this.IDATA.edgematch[N][1],"B"===c)for(let k=1;k<s;k++)m.x=i-k*(a+o),m.y=n+k*a,T.x=-k*o,T.y=k*(a+o),x=m.x+"|"+m.y,C=T.x+"|"+T.y,P(N,l,x,C);if("O"===c)for(let k=1;k<s;k++)T.x=-k*o,T.y=k*(a+o),_.x=k*a,_.y=k*o,x=T.x+"|"+T.y,C=_.x+"|"+_.y,P(N,l,x,C);if(l=this.IDATA.edgematch[N][2],c=this.IDATA.edgematch[N][3],c&&"A"===c)for(let k=1;k<s;k++)_.x=k*a,_.y=k*o,m.x=i-(s-k)*(a+o),m.y=n+(s-k)*a,x=_.x+"|"+_.y,C=m.x+"|"+m.y,P(N,l,x,C);for(let k=0;k<this.vertices.length;k++)x=this.vertices[k].x+"|"+this.vertices[k].y,A=N+"|"+x,A in t||(t[A]=e++,R[t[A]]=D[x][0]>2?[-D[x][0],D[x][1],t[A]]:[v[D[x][0]],D[x][1],t[A]])}this.closestTo=R,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,n=e*e+t*t+e*t;this.coau=(e+t)/n,this.cobu=-t/n,this.coav=-i*(e-t)/n,this.cobv=i*(2*e+t)/n}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let n=this.min[i];n<this.max[i]+1;n++)n<this.max[i]&&n<this.max[i+1]+1&&this.innerFacets.push(["|"+n+"|"+i,"|"+n+"|"+(i+1),"|"+(n+1)+"|"+i]),i>0&&n<this.max[i-1]&&n+1<this.max[i]+1&&this.innerFacets.push(["|"+n+"|"+i,"|"+(n+1)+"|"+i,"|"+(n+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new ki(-t,e+t);for(let n=1;n<e+t;n++){const s=new ki(this.min[n],n),a=new ki(this.min[n-1],n-1),o=new ki(this.min[n+1],n+1),l=s.clone(),c=a.clone(),u=o.clone();l.rotate60About(i),c.rotate60About(i),u.rotate60About(i);const h=new ki(this.max[l.y],l.y),d=new ki(this.max[l.y-1],l.y-1),f=new ki(this.max[l.y-1]-1,l.y-1);(l.x!==h.x||l.y!==h.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,h])):l.y===u.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,a,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,d,o])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,a,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,h])))}}mapABOBtoOBOA(){const e=new ki(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let n=0;n<3;n++)e.x=this.isoVecsABOB[t][n].x,e.y=this.isoVecsABOB[t][n].y,0===this.vertexTypes[t][n]&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new ki(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let n=0;n<3;n++)e.x=this.isoVecsABOB[t][n].x,e.y=this.isoVecsABOB[t][n].y,1===this.vertexTypes[t][n]&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],s=i[1],a=i[0],o=E.FromArray(this.IDATA.vertex[i[2]]),l=E.FromArray(this.IDATA.vertex[s]),c=E.FromArray(this.IDATA.vertex[a]),u=l.subtract(o),h=c.subtract(o),d=u.scale(this.coau).add(h.scale(this.cobu)),f=u.scale(this.coav).add(h.scale(this.cobv)),p=[];let g,_=z.Vector3[0];for(let m=0;m<this.cartesian.length;m++)_=d.scale(this.cartesian[m].x).add(f.scale(this.cartesian[m].y)).add(o),p[m]=[_.x,_.y,_.z],g=e+"|"+this.vertices[m].x+"|"+this.vertices[m].y,t.vertex[this.vecToidx[g]]=[_.x,_.y,_.z]}build(e,t){const i=new Array,n=ki.Zero(),s=new ki(e,t),a=new ki(-t,e+t);i.push(n,s,a);for(let S=t;S<e+1;S++)for(let x=0;x<e+1-S;x++)i.push(new ki(x,S));if(t>0){const S=Se.HCF(e,t),x=e/S,C=t/S;for(let D=1;D<S;D++)i.push(new ki(D*x,D*C)),i.push(new ki(-D*C,D*(x+C))),i.push(new ki(e-D*(x+C),t+D*x));const R=e/t;for(let D=1;D<t;D++)for(let P=0;P<D*R;P++)i.push(new ki(P,D)),i.push(new ki(P,D).rotate120(e,t)),i.push(new ki(P,D).rotateNeg120(e,t))}i.sort((S,x)=>S.x-x.x),i.sort((S,x)=>S.y-x.y);const o=new Array(e+t+1),l=new Array(e+t+1);for(let S=0;S<o.length;S++)o[S]=1/0,l[S]=-1/0;let c=0,u=0;const h=i.length;for(let S=0;S<h;S++)u=i[S].x,c=i[S].y,o[c]=Math.min(u,o[c]),l[c]=Math.max(u,l[c]);const d=(S,x)=>{const C=S.clone();return"A"===x&&C.rotateNeg120(e,t),"B"===x&&C.rotate120(e,t),C.x<0?C.y:C.x+C.y},f=[],p=[],g=[],_=[],m={},T=[];let v=-1,A=-1;for(let S=0;S<h;S++)f[S]=i[S].toCartesianOrigin(new ki(0,0),.5),p[S]=d(i[S],"O"),g[S]=d(i[S],"A"),_[S]=d(i[S],"B"),p[S]===g[S]&&g[S]===_[S]?(v=3,A=p[S]):p[S]===g[S]?(v=4,A=p[S]):g[S]===_[S]?(v=5,A=g[S]):_[S]===p[S]&&(v=6,A=p[S]),p[S]<g[S]&&p[S]<_[S]&&(v=2,A=p[S]),g[S]<p[S]&&g[S]<_[S]&&(v=1,A=g[S]),_[S]<g[S]&&_[S]<p[S]&&(v=0,A=_[S]),T.push([v,A,i[S].x,i[S].y]);T.sort((S,x)=>S[2]-x[2]),T.sort((S,x)=>S[3]-x[3]),T.sort((S,x)=>S[1]-x[1]),T.sort((S,x)=>S[0]-x[0]);for(let S=0;S<T.length;S++)m[T[S][2]+"|"+T[S][3]]=[T[S][0],T[S][1],S];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=m,this.cartesian=f,this.min=o,this.max=l,this}}class XT{constructor(e,t,i,n){this.name=e,this.category=t,this.vertex=i,this.face=n}}class Zf extends XT{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(n=>t.vecToidx[e+n]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let n=0;n<t.isoVecsABOB.length;n++){const s=[];for(let a=0;a<3;a++)s.push(0===t.vertexTypes[n][a]?e+"|"+t.isoVecsABOB[n][a].x+"|"+t.isoVecsABOB[n][a].y:i+"|"+t.isoVecsABOB[n][a].x+"|"+t.isoVecsABOB[n][a].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let n=0;n<t.isoVecsOBOA.length;n++){const s=[];for(let a=0;a<3;a++)s.push(1===t.vertexTypes[n][a]?e+"|"+t.isoVecsOBOA[n][a].x+"|"+t.isoVecsOBOA[n][a].y:i+"|"+t.isoVecsOBOA[n][a].x+"|"+t.isoVecsOBOA[n][a].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let n=0;n<t.isoVecsBAOA.length;n++){const s=[];for(let a=0;a<3;a++)s.push(1===t.vertexTypes[n][a]?e+"|"+t.isoVecsBAOA[n][a].x+"|"+t.isoVecsBAOA[n][a].y:i+"|"+t.isoVecsBAOA[n][a].x+"|"+t.isoVecsBAOA[n][a].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){const t=[];for(let a=0;a<13;a++)t[a]=[];const i=e.closestTo;for(let a=0;a<i.length;a++)i[a][0]>-1?i[a][1]>0&&t[i[a][0]].push([a,i[a][1]]):t[12].push([a,i[a][0]]);const n=[];for(let a=0;a<12;a++)n[a]=a;let s=12;for(let a=0;a<12;a++){t[a].sort((o,l)=>o[1]-l[1]);for(let o=0;o<t[a].length;o++)n[t[a][o][0]]=s++}for(let a=0;a<t[12].length;a++)n[t[12][a][0]]=s++;for(let a=0;a<this.vertex.length;a++)this.vertex[a].push(n[a]);this.vertex.sort((a,o)=>a[3]-o[3]);for(let a=0;a<this.vertex.length;a++)this.vertex[a].pop();for(let a=0;a<this.face.length;a++)for(let o=0;o<this.face[a].length;o++)this.face[a][o]=n[this.face[a][o]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],n=[];let s=t.pop();n.push(s);let a=this.face[s].indexOf(e);a=(a+2)%3;let o=this.face[s][a];i.push(o);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(o)>-1?(a=(this.face[s].indexOf(o)+1)%3,o=this.face[s][a],i.push(o),n.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),n}toGoldbergPolyhedronData(){const e=new XT("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let c=0;c<t;c++)i[c]=[];for(let c=0;c<this.face.length;c++)for(let u=0;u<3;u++)i[this.face[c][u]].push(c);let n=0,s=0,a=0,o=[],l=[];this.adjacentFaces=[];for(let c=0;c<i.length;c++)e.face[c]=this.setOrder(c,i[c].concat([])),i[c].forEach(u=>{n=0,s=0,a=0,o=this.face[u];for(let h=0;h<3;h++)l=this.vertex[o[h]],n+=l[0],s+=l[1],a+=l[2];e.vertex[u]=[n/3,s/3,a/3]});return e}static BuildGeodesicData(e){const t=new Zf("Geodesic-m-n","Geodesic",[[0,nn,-1],[-nn,1,0],[-1,0,-nn],[1,0,-nn],[nn,1,0],[0,nn,1],[-1,0,nn],[-nn,-1,0],[0,-nn,-1],[nn,-1,0],[1,0,nn],[0,-nn,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let n=0;n<e.IDATA.face.length;n++)e.MapToFace(n,t),t.innerToData(n,e),"B"===e.IDATA.edgematch[n][1]&&t.mapABOBtoDATA(n,e),"O"===e.IDATA.edgematch[n][1]&&t.mapOBOAtoDATA(n,e),"A"===e.IDATA.edgematch[n][3]&&t.mapBAOAtoDATA(n,e);return t.orderData(e),t.vertex=t.vertex.map(function(n){const s=n[0],a=n[1],o=n[2],l=Math.sqrt(s*s+a*a+o*o);return n[0]*=1/l,n[1]*=1/l,n[2]*=1/l,n}),t}}U.CreateGoldberg=function wR(r,e,t=null){const i=e.size,n=e.sizeX||i||1,s=e.sizeY||i||1,a=e.sizeZ||i||1;let o=e.m||1;o!==Math.floor(o)&&(Math.floor(o),H.Warn("m not an integer only floor(m) used"));let l=e.n||0;if(l!==Math.floor(l)&&(Math.floor(l),H.Warn("n not an integer only floor(n) used")),l>o){const p=l;l=o,o=p,H.Warn("n > m therefore m and n swapped")}const c=new PR;c.build(o,l);const u=Zf.BuildGeodesicData(c),h=u.toGoldbergPolyhedronData(),d=new zf(r,t);e.sideOrientation=U._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,function PW(r,e){const t=r.size,i=r.sizeX||t||1,n=r.sizeY||t||1,s=r.sizeZ||t||1,a=0===r.sideOrientation?0:r.sideOrientation||be.DEFAULTSIDE,o=new Array,l=new Array,c=new Array,u=new Array;let h=1/0,d=-1/0,f=1/0,p=-1/0;for(let m=0;m<e.vertex.length;m++)h=Math.min(h,e.vertex[m][0]*i),d=Math.max(d,e.vertex[m][0]*i),f=Math.min(f,e.vertex[m][1]*n),p=Math.max(p,e.vertex[m][1]*n);let g=0;for(let m=0;m<e.face.length;m++){const T=e.face[m],v=E.FromArray(e.vertex[T[0]]),A=E.FromArray(e.vertex[T[2]]),S=E.FromArray(e.vertex[T[1]]),x=A.subtract(v),C=S.subtract(v),R=E.Cross(C,x).normalize();for(let D=0;D<T.length;D++){c.push(R.x,R.y,R.z);const P=e.vertex[T[D]];o.push(P[0]*i,P[1]*n,P[2]*s);const N=(P[1]*n-f)/(p-f);u.push((P[0]*i-h)/(d-h),jt.UseOpenGLOrientationForUV?1-N:N)}for(let D=0;D<T.length-2;D++)l.push(g,g+D+2,g+D+1);g+=T.length}be._ComputeSides(a,o,l,c,u);const _=new be;return _.positions=o,_.indices=l,_.normals=c,_.uvs=u,_}(e,h).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=u.sharedNodes,d.goldbergData.nbUnsharedFaces=u.poleNodes,d.goldbergData.adjacentFaces=u.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let p=0;p<u.vertex.length;p++)d.goldbergData.faceCenters.push(E.FromArray(u.vertex[p])),d.goldbergData.faceCenters[p].x*=n,d.goldbergData.faceCenters[p].y*=s,d.goldbergData.faceCenters[p].z*=a,d.goldbergData.faceColors.push(new ct(1,1,1,1));for(let p=0;p<h.face.length;p++){const g=h.face[p],_=E.FromArray(h.vertex[g[0]]),m=E.FromArray(h.vertex[g[2]]),T=E.FromArray(h.vertex[g[1]]),v=m.subtract(_),A=T.subtract(_),S=E.Cross(A,v).normalize(),x=E.Cross(A,S).normalize();d.goldbergData.faceXaxis.push(A.normalize()),d.goldbergData.faceYaxis.push(S),d.goldbergData.faceZaxis.push(x)}return d};class wW{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,n=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,n),n.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{const t=this._getSimplifier(e),i=(n,s)=>{t.simplify(n,a=>{void 0!==n.distance&&e.mesh.addLODLevel(n.distance,a),a.isVisible=!0,s()})};Is.Run(e.settings.length,n=>{i(e.settings[n.index],()=>{n.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){return new LW(e.mesh)}}var Ah=(()=>{return(r=Ah||(Ah={}))[r.QUADRATIC=0]="QUADRATIC",Ah;var r})();class OW{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class FW{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new Gc,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class Gc{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)this.data[t]=e&&e[t]?e[t]:0}det(e,t,i,n,s,a,o,l,c){return this.data[e]*this.data[s]*this.data[c]+this.data[i]*this.data[n]*this.data[l]+this.data[t]*this.data[a]*this.data[o]-this.data[i]*this.data[s]*this.data[o]-this.data[e]*this.data[a]*this.data[l]-this.data[t]*this.data[n]*this.data[c]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new Gc;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,n){return new Gc(Gc.DataFromNumbers(e,t,i,n))}static DataFromNumbers(e,t,i,n){return[e*e,e*t,e*i,e*n,t*t,t*i,t*n,i*i,i*n,n*n]}}class NW{constructor(e,t){this.vertexId=e,this.triangleId=t}}class LW{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=kt}simplify(e,t){this._initDecimatedMesh(),Is.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){const n=~~(this._triangles.length*e.quality);let s=0;const a=this._triangles.length,o=(l,c)=>{setTimeout(()=>{l%5==0&&this._updateMesh(0===l);for(let d=0;d<this._triangles.length;++d)this._triangles[d].isDirty=!1;const u=1e-9*Math.pow(l+3,this.aggressiveness);Is.SyncAsyncForLoop(this._triangles.length,this.syncIterations,d=>{const p=this._triangles[~~((this._triangles.length/2+d)%this._triangles.length)];if(p&&!(p.error[3]>u||p.deleted||p.isDirty))for(let g=0;g<3;++g)if(p.error[g]<u){const _=[],m=[],T=p._vertices[g],v=p._vertices[(g+1)%3];if(T.isBorder||v.isBorder)continue;const A=E.Zero();this._calculateError(T,v,A);const S=new Array;if(this._isFlipped(T,v,A,_,S)||this._isFlipped(v,T,A,m,S)||_.indexOf(!0)<0||m.indexOf(!0)<0)continue;const x=new Array;if(S.forEach(D=>{-1===x.indexOf(D)&&(D.deletePending=!0,x.push(D))}),x.length%2!=0)continue;T.q=v.q.add(T.q),T.updatePosition(A);const C=this._references.length;s=this._updateTriangles(T,T,_,s),s=this._updateTriangles(T,v,m,s);const R=this._references.length-C;if(R<=T.triangleCount){if(R)for(let D=0;D<R;D++)this._references[T.triangleStart+D]=this._references[C+D]}else T.triangleStart=C;T.triangleCount=R;break}},c,()=>a-s<=n)},0)};Is.Run(this.decimationIterations,l=>{a-s<=n?l.breakLoop():o(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const n=this._mesh.getVerticesData(I.PositionKind),s=this._mesh.getIndices(),a=this._mesh.subMeshes[e],o=h=>{if(i)for(let d=0;d<this._vertices.length;++d)if(this._vertices[d].position.equalsWithEpsilon(h,1e-4))return this._vertices[d];return null},l=[];Is.SyncAsyncForLoop(a.verticesCount,this.syncIterations/4>>0,h=>{if(!n)return;const d=h+a.verticesStart,f=E.FromArray(n,3*d),p=o(f)||new FW(f,this._vertices.length);p.originalOffsets.push(d),p.id===this._vertices.length&&this._vertices.push(p),l.push(p.id)},()=>{Is.SyncAsyncForLoop(a.indexCount/3,this.syncIterations,d=>{if(!s)return;const p=3*(a.indexStart/3+d),S=new OW([this._vertices[l[s[p+0]-a.verticesStart]],this._vertices[l[s[p+1]-a.verticesStart]],this._vertices[l[s[p+2]-a.verticesStart]]]);S.originalOffset=p,this._triangles.push(S)},()=>{this._init(t)})})}_init(e){Is.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i=>{const n=this._triangles[i];n.normal=E.Cross(n._vertices[1].position.subtract(n._vertices[0].position),n._vertices[2].position.subtract(n._vertices[0].position)).normalize();for(let s=0;s<3;s++)n._vertices[s].q.addArrayInPlace(Gc.DataFromNumbers(n.normal.x,n.normal.y,n.normal.z,-E.Dot(n.normal,n._vertices[0].position)))},()=>{Is.SyncAsyncForLoop(this._triangles.length,this.syncIterations,n=>{const s=this._triangles[n];for(let a=0;a<3;++a)s.error[a]=this._calculateError(s._vertices[a],s._vertices[(a+1)%3]);s.error[3]=Math.min(s.error[0],s.error[1],s.error[2])},()=>{e()})})}_reconstructMesh(e){const t=[];let i,n,s;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(n=this._triangles[i],s=0;s<3;++s)n._vertices[s].triangleCount=1;t.push(n)}const a=this._reconstructedMesh.getVerticesData(I.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(I.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(I.UVKind)||[],c=this._reconstructedMesh.getVerticesData(I.ColorKind)||[],u=this._mesh.getVerticesData(I.NormalKind),h=this._mesh.getVerticesData(I.UVKind),d=this._mesh.getVerticesData(I.ColorKind);let f=0;for(i=0;i<this._vertices.length;++i){const A=this._vertices[i];A.id=f,A.triangleCount&&A.originalOffsets.forEach(S=>{a.push(A.position.x),a.push(A.position.y),a.push(A.position.z),u&&u.length&&(o.push(u[3*S]),o.push(u[3*S+1]),o.push(u[3*S+2])),h&&h.length&&(l.push(h[2*S]),l.push(h[2*S+1])),d&&d.length&&(c.push(d[4*S]),c.push(d[4*S+1]),c.push(d[4*S+2]),c.push(d[4*S+3])),++f})}const p=this._reconstructedMesh.getTotalIndices(),g=this._reconstructedMesh.getTotalVertices(),_=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const m=this._reconstructedMesh.getIndices(),T=this._mesh.getIndices();for(i=0;i<t.length;++i)n=t[i],[0,1,2].forEach(A=>{let x=n._vertices[A].originalOffsets.indexOf(T[n.originalOffset+A]);x<0&&(x=0),m.push(n._vertices[A].id+x+g)});this._reconstructedMesh.setIndices(m),this._reconstructedMesh.setVerticesData(I.PositionKind,a),o.length>0&&this._reconstructedMesh.setVerticesData(I.NormalKind,o),l.length>0&&this._reconstructedMesh.setVerticesData(I.UVKind,l),c.length>0&&this._reconstructedMesh.setVerticesData(I.ColorKind,c);const v=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],_.forEach(A=>{nr.AddToMesh(A.materialIndex,A.verticesStart,A.verticesCount,A.indexStart,A.indexCount,A.getMesh())}),nr.AddToMesh(v.materialIndex,g,f,p,3*t.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new U(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,n,s){for(let a=0;a<e.triangleCount;++a){const o=this._triangles[this._references[e.triangleStart+a].triangleId];if(o.deleted)continue;const l=this._references[e.triangleStart+a].vertexId,c=o._vertices[(l+1)%3],u=o._vertices[(l+2)%3];if(c===t||u===t){n[a]=!0,s.push(o);continue}let h=c.position.subtract(i);h=h.normalize();let d=u.position.subtract(i);if(d=d.normalize(),Math.abs(E.Dot(h,d))>.999)return!0;const f=E.Cross(h,d).normalize();if(n[a]=!1,E.Dot(f,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,n){let s=n;for(let a=0;a<t.triangleCount;++a){const o=this._references[t.triangleStart+a],l=this._triangles[o.triangleId];if(!l.deleted){if(i[a]&&l.deletePending){l.deleted=!0,s++;continue}l._vertices[o.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(o)}}return s}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],n=this._vertices[e];let s;for(s=0;s<n.triangleCount;++s){const a=this._triangles[this._references[n.triangleStart+s].triangleId];for(let o=0;o<3;o++){let l=0;const c=a._vertices[o];for(;l<t.length&&i[l]!==c.id;)++l;l===t.length?(t.push(1),i.push(c.id)):t[l]++}}for(s=0;s<t.length;++s)this._vertices[i[s]].isBorder=1===t[s]}}_updateMesh(e=!1){let t,i,n,s;if(!e){const l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],n=0;n<3;++n)s=i._vertices[n],s.triangleCount++;let a=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=a,a+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],n=0;n<3;++n)s=i._vertices[n],o[s.triangleStart+s.triangleCount]=new NW(n,t),s.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,n=t.y,s=t.z;return e.data[0]*i*i+2*e.data[1]*i*n+2*e.data[2]*i*s+2*e.data[3]*i+e.data[4]*n*n+2*e.data[5]*n*s+2*e.data[6]*n+e.data[7]*s*s+2*e.data[8]*s+e.data[9]}_calculateError(e,t,i){const n=e.q.add(t.q),s=e.isBorder&&t.isBorder;let a=0;const o=n.det(0,1,2,1,4,5,2,5,7);if(0===o||s){const l=e.position.add(t.position).divide(new E(2,2,2)),c=this._vertexError(n,e.position),u=this._vertexError(n,t.position),h=this._vertexError(n,l);a=Math.min(c,u,h),a===c?i&&i.copyFrom(e.position):a===u?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}else i||(i=E.Zero()),i.x=-1/o*n.det(1,2,3,4,5,6,5,7,8),i.y=1/o*n.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*n.det(0,1,3,1,4,6,2,5,8),a=this._vertexError(n,i);return a}}Object.defineProperty(dt.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new wW;let r=this._getComponent(Bi.NAME_SIMPLIFICATIONQUEUE);r||(r=new BW(this),this._addComponent(r))}return this._simplificationQueue},set:function(r){this._simplificationQueue=r},enumerable:!0,configurable:!0}),U.prototype.simplify=function(r,e=!0,t=Ah.QUADRATIC,i){return this.getScene().simplificationQueue.addTask({settings:r,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};class BW{constructor(e){this.name=Bi.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Bi.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}nr.prototype._projectOnTrianglesToRef=function(r,e,t,i,n,s){const a=z.Vector3[0],o=z.Vector3[1];let l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){const u=t[c],h=t[c+1],d=t[c+2];if(n&&4294967295===d){c+=2;continue}const f=e[u],p=e[h],g=e[d];if(!f||!p||!g)continue;const _=E.ProjectOnTriangleToRef(r,f,p,g,o);_<l&&(a.copyFrom(o),l=_)}return s.copyFrom(a),l},nr.prototype._projectOnUnIndexedTrianglesToRef=function(r,e,t,i){const n=z.Vector3[0],s=z.Vector3[1];let a=1/0;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const h=E.ProjectOnTriangleToRef(r,e[o],e[o+1],e[o+2],s);h<a&&(n.copyFrom(s),a=h)}return i.copyFrom(n),a},nr.prototype.projectToRef=function(r,e,t,i){const n=this.getMaterial();if(!n)return-1;let s=3,a=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,a=!0}return 4===n.fillMode?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(r,e,t,i):this._projectOnTrianglesToRef(r,e,t,s,a,i)},U.CreateHemisphere=(r,e,t,i)=>function OR(r,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=Xf("",{slice:.5,diameter:e.diameter,segments:e.segments},t),n=Wf("",{radius:e.diameter/2,tessellation:3*e.segments+(4-e.segments)},t);n.rotation.x=-Math.PI/2,n.parent=i;const s=U.MergeMeshes([n,i],!0);return s.name=r,s}(r,{segments:e,diameter:t},i);class UW extends Df{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}U.prototype.thinInstanceAdd=function(r,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return H.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(r)?r.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(r))for(let i=0;i<r.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r[i],i===r.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,r,e);return t},U.prototype.thinInstanceAddSelf=function(r=!0){return this.thinInstanceAdd(B.IdentityReadOnly,r)},U.prototype.thinInstanceRegisterAttribute=function(r,e){r===I.ColorKind&&(r=I.ColorInstanceKind),this.removeVerticesData(r),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[r]=e,this._userThinInstanceBuffersStorage.sizes[r]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[r]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[r]),this._userThinInstanceBuffersStorage.vertexBuffers[r]=new I(this.getEngine(),this._userThinInstanceBuffersStorage.data[r],r,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])},U.prototype.thinInstanceSetMatrixAt=function(r,e,t=!0){return!(!this._thinInstanceDataStorage.matrixData||r>=this._thinInstanceDataStorage.instancesCount)&&(e.copyToArray(this._thinInstanceDataStorage.matrixData,16*r),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[r]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0)},U.prototype.thinInstanceSetAttributeAt=function(r,e,t,i=!0){return r===I.ColorKind&&(r=I.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[r]||e>=this._thinInstanceDataStorage.instancesCount||(this._thinInstanceUpdateBufferSize(r,0),this._userThinInstanceBuffersStorage.data[r].set(t,e*this._userThinInstanceBuffersStorage.strides[r]),i&&this.thinInstanceBufferUpdated(r),0))},Object.defineProperty(U.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(r){var e,t;const i=null!==(e=this._thinInstanceDataStorage.matrixData)&&void 0!==e?e:null===(t=this.source)||void 0===t?void 0:t._thinInstanceDataStorage.matrixData;r<=(i?i.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=r)},enumerable:!0,configurable:!0}),U.prototype._thinInstanceCreateMatrixBuffer=function(r,e,t=!1){r===I.ColorKind&&(r=I.ColorInstanceKind);const i=new Th(this.getEngine(),e,!t,16,!1,!0);for(let n=0;n<4;n++)this.setVerticesBuffer(i.createVertexBuffer(r+n,4*n,4));return i},U.prototype.thinInstanceSetBuffer=function(r,e,t=0,i=!1){var n,s,a;t=t||16,"matrix"===r?(null===(n=this._thinInstanceDataStorage.matrixBuffer)||void 0===n||n.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,null!==e?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===r?(null===(s=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===s||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,null!==e&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(r===I.ColorKind&&(r=I.ColorInstanceKind),null===e?(null===(a=this._userThinInstanceBuffersStorage)||void 0===a?void 0:a.data[r])&&(this.removeVerticesData(r),delete this._userThinInstanceBuffersStorage.data[r],delete this._userThinInstanceBuffersStorage.strides[r],delete this._userThinInstanceBuffersStorage.sizes[r],delete this._userThinInstanceBuffersStorage.vertexBuffers[r]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[r]=e,this._userThinInstanceBuffersStorage.strides[r]=t,this._userThinInstanceBuffersStorage.sizes[r]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new I(this.getEngine(),e,r,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r])))},U.prototype.thinInstanceBufferUpdated=function(r){var e,t,i;"matrix"===r?null===(e=this._thinInstanceDataStorage.matrixBuffer)||void 0===e||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):"previousMatrix"===r?null===(t=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===t||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(r===I.ColorKind&&(r=I.ColorInstanceKind),(null===(i=this._userThinInstanceBuffersStorage)||void 0===i?void 0:i.vertexBuffers[r])&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(this._userThinInstanceBuffersStorage.data[r],0))},U.prototype.thinInstancePartialBufferUpdate=function(r,e,t){var i;"matrix"===r?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(r===I.ColorKind&&(r=I.ColorInstanceKind),(null===(i=this._userThinInstanceBuffersStorage)||void 0===i?void 0:i.vertexBuffers[r])&&this._userThinInstanceBuffersStorage.vertexBuffers[r].updateDirectly(e,t))},U.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const r=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=B.FromArray(r,16*e)}return this._thinInstanceDataStorage.worldMatrices},U.prototype.thinInstanceRefreshBoundingInfo=function(r=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(r||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);const a=this.getBoundingInfo();this.rawBoundingInfo=new Xr(a.minimum,a.maximum)}const n=this.getBoundingInfo(),s=this._thinInstanceDataStorage.matrixData;if(0===i.length)for(let a=0;a<n.boundingBox.vectors.length;++a)i.push(n.boundingBox.vectors[a].clone());z.Vector3[0].setAll(Number.POSITIVE_INFINITY),z.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let a=0;a<this._thinInstanceDataStorage.instancesCount;++a){B.FromArrayToRef(s,16*a,z.Matrix[0]);for(let o=0;o<i.length;++o)E.TransformCoordinatesToRef(i[o],z.Matrix[0],z.Vector3[2]),z.Vector3[0].minimizeInPlace(z.Vector3[2]),z.Vector3[1].maximizeInPlace(z.Vector3[2])}n.reConstruct(z.Vector3[0],z.Vector3[1]),this._updateBoundingInfo()},U.prototype._thinInstanceUpdateBufferSize=function(r,e=1){var t,i,n;r===I.ColorKind&&(r=I.ColorInstanceKind);const s="matrix"===r;if(!(s||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[r]))return;const a=s?16:this._userThinInstanceBuffersStorage.strides[r],o=s?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[r];let l=s?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[r];const c=(this._thinInstanceDataStorage.instancesCount+e)*a;let u=o;for(;u<c;)u*=2;if(!l||o!=u){if(l){const h=new Float32Array(u);h.set(l,0),l=h}else l=new Float32Array(u);s?(null===(t=this._thinInstanceDataStorage.matrixBuffer)||void 0===t||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=u,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(null===(i=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===i||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):(null===(n=this._userThinInstanceBuffersStorage.vertexBuffers[r])||void 0===n||n.dispose(),this._userThinInstanceBuffersStorage.data[r]=l,this._userThinInstanceBuffersStorage.sizes[r]=u,this._userThinInstanceBuffersStorage.vertexBuffers[r]=new I(this.getEngine(),l,r,!0,!1,a,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[r]))}},U.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},U.prototype._disposeThinInstanceSpecificData=function(){var r;(null===(r=this._thinInstanceDataStorage)||void 0===r?void 0:r.matrixBuffer)&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};let De=(()=>{class r{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(t){this._DiffuseTextureEnabled!==t&&(this._DiffuseTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(t){this._DetailTextureEnabled!==t&&(this._DetailTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(t){this._DecalMapEnabled!==t&&(this._DecalMapEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(t){this._AmbientTextureEnabled!==t&&(this._AmbientTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(t){this._OpacityTextureEnabled!==t&&(this._OpacityTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(t){this._ReflectionTextureEnabled!==t&&(this._ReflectionTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(t){this._EmissiveTextureEnabled!==t&&(this._EmissiveTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(t){this._SpecularTextureEnabled!==t&&(this._SpecularTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(t){this._BumpTextureEnabled!==t&&(this._BumpTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(t){this._LightmapTextureEnabled!==t&&(this._LightmapTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(t){this._RefractionTextureEnabled!==t&&(this._RefractionTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(t){this._ColorGradingTextureEnabled!==t&&(this._ColorGradingTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(t){this._FresnelEnabled!==t&&(this._FresnelEnabled=t,Ve.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(t){this._ClearCoatTextureEnabled!==t&&(this._ClearCoatTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(t){this._ClearCoatBumpTextureEnabled!==t&&(this._ClearCoatBumpTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(t){this._ClearCoatTintTextureEnabled!==t&&(this._ClearCoatTintTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(t){this._SheenTextureEnabled!==t&&(this._SheenTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(t){this._AnisotropicTextureEnabled!==t&&(this._AnisotropicTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(t){this._ThicknessTextureEnabled!==t&&(this._ThicknessTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(t){this._RefractionIntensityTextureEnabled!==t&&(this._RefractionIntensityTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(t){this._TranslucencyIntensityTextureEnabled!==t&&(this._TranslucencyIntensityTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(t){this._IridescenceTextureEnabled!==t&&(this._IridescenceTextureEnabled=t,Ve.MarkAllMaterialsAsDirty(1))}}return r._DiffuseTextureEnabled=!0,r._DetailTextureEnabled=!0,r._DecalMapEnabled=!0,r._AmbientTextureEnabled=!0,r._OpacityTextureEnabled=!0,r._ReflectionTextureEnabled=!0,r._EmissiveTextureEnabled=!0,r._SpecularTextureEnabled=!0,r._BumpTextureEnabled=!0,r._LightmapTextureEnabled=!0,r._RefractionTextureEnabled=!0,r._ColorGradingTextureEnabled=!0,r._FresnelEnabled=!0,r._ClearCoatTextureEnabled=!0,r._ClearCoatBumpTextureEnabled=!0,r._ClearCoatTintTextureEnabled=!0,r._SheenTextureEnabled=!0,r._AnisotropicTextureEnabled=!0,r._ThicknessTextureEnabled=!0,r._RefractionIntensityTextureEnabled=!0,r._TranslucencyIntensityTextureEnabled=!0,r._IridescenceTextureEnabled=!0,r})();Z.IncludesShadersStore.backgroundFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;\nuniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n";Z.IncludesShadersStore.backgroundUboDeclaration="layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec4 vPrimaryColor;\nuniform vec4 vPrimaryColorShadow;\nuniform vec2 vDiffuseInfos;\nuniform vec2 vReflectionInfos;\nuniform mat4 diffuseMatrix;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\nuniform float pointSize;\nuniform float shadowLevel;\nuniform float alpha;\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n};\n#include<sceneUboDeclaration>\n";Z.IncludesShadersStore.reflectionFunction="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0); \n}\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{\nfloat lon=atan(direction.z,direction.x);\nfloat lat=acos(direction.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(1.0-s,t,0); \n}\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);\nvec3 r=normalize(reflect(cameraToVertex,worldNormal));\nr=vec3(reflectionMatrix*vec4(r,0));\nfloat lon=atan(r.z,r.x);\nfloat lat=acos(r.y);\nvec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;\nfloat s=sphereCoords.x*0.5+0.5;\nfloat t=sphereCoords.y;\nreturn vec3(s,t,0);\n}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr=vec3(reflectionMatrix*vec4(r,0));\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=worldPos.xyz-eyePosition;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{\nvec3 viewDir=normalize(worldPos.xyz-eyePosition);\nvec3 coords=reflect(viewDir,worldNormal);\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*(view*worldPos));\n}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{\nreturn vec3(reflectionMatrix*vec4(positionW,1.));\n}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nreturn computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";Z.IncludesShadersStore.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";Z.IncludesShadersStore.lightFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif\n";Z.IncludesShadersStore.lightUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float cascadeBlendFactor{X};\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\nuniform highp sampler2DArray depthSampler{X};\nuniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];\nuniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);\nvec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.lightsFragmentFunctions="struct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w==0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn textureColor;\n}";Z.IncludesShadersStore.shadowsFragmentFunctions="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\n#define inline\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;\n}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\n#define inline\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nvec3 uvLayer=vec3(uv.x,uv.y,layer);\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;\n}\n}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nelse\n{\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat shadow=texture2D(shadowSampler,uvDepthLayer);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);\nshadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);\nshadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);\nshadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);\nvec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);\nvec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec4 offset=vec4(poissonSamplers[i],0.);\noffset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);\nshadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));\nshadow=mix(darkness,1.,shadow);\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nelse\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nuvDepth.z=ZINCLIP;\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nelse\n{\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\nfloat AAOffset=shadowMapSizeInverse*10.;\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);\n}\nshadow/=float(pcfTapCount);\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n}\n}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{\nreturn computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);\n}\n#endif\n#endif\n";Z.IncludesShadersStore.imageProcessingFunctions="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=saturate(sliceUV);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\n#ifdef TONEMAPPING_ACES\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);\nconst mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);\nvec3 RRTAndODTFit(vec3 v)\n{\nvec3 a=v*(v+0.0245786)-0.000090537;\nvec3 b=v*(0.983729*v+0.4329510)+0.238081;\nreturn a/b;\n}\nvec3 ACESFitted(vec3 color)\n{\ncolor=ACESInputMat*color;\ncolor=RRTAndODTFit(color);\ncolor=ACESOutputMat*color;\ncolor=saturate(color);\nreturn color;\n}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\n#ifdef TONEMAPPING_ACES\nresult.rgb=ACESFitted(result.rgb);\n#else\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n#endif\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);\nif (contrast<1.0) {\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);\nfloat dither=mix(-ditherIntensity,ditherIntensity,rand);\nresult.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;\n}";Z.IncludesShadersStore.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR==vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif\n";Z.IncludesShadersStore.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);\ninfo.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {\nindex{X}=i;\nbreak;\n}\n}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];\nfloat diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};\nif (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{\nindex{X}+=1;\nfloat nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n";Z.ShadersStore.backgroundPixelShader="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;\nfloat globalShadow=0.;\nfloat shadowLightCount=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\nreflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);\nif(lodReflectionNormalizedDoubled<1.0){\nreflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nreflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);\nreflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);\nfloat finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;\nvec3 reflectionReflectance0=vReflectionControl.yyy;\nvec3 reflectionReflectance90=vReflectionControl.zzz;\nfloat VdotN=dot(normalize(vEyePosition.xyz),normalW);\nvec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);\nreflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);\nreflectionDistanceFalloff*=reflectionDistanceFalloff;\nreflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));\nconst float startAngle=0.1;\nfloat fadeFactor=saturate(viewAngleToFloor/startAngle);\nfinalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);\ncolor=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";Z.IncludesShadersStore.backgroundVertexDeclaration="uniform mat4 view;\nuniform mat4 viewProjection;\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";Z.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n";Z.IncludesShadersStore.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\nuniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";Z.IncludesShadersStore.lightVxUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\nvec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];\nvarying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n";Z.IncludesShadersStore.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {\nvPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";Z.ShadersStore.backgroundVertexShader="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n} else {\ngl_Position=viewProjectionR*finalWorld*vec4(position,1.0);\n}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));\nvec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));\nif (fFovMultiplier<=1.0) {\nvDirectionW=normalize(segment);\n} else {\nvDirectionW=normalize(vDirectionW+(vDirectionW-segment));\n}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";class VW extends us{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Nt extends vh{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=Nt.StandardReflectance0*t,this.reflectionReflectance90=Nt.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=Nt.StandardReflectance0+(1-Nt.StandardReflectance0)*t,this.reflectionReflectance90=Nt.StandardReflectance90+(1-Nt.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=Fe.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=E.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._renderTargets=new Qn(16),this._reflectionControls=Qt.Zero(),this._white=Fe.White(),this._primaryShadowColor=Fe.Black(),this._primaryHighlightColor=Fe.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new VW);const n=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=n.getEngine();if(fe.PrepareDefinesForLights(n,e,s,!1,this._maxSimultaneousLights),s._needNormals=!0,fe.PrepareDefinesForMultiview(n,s),s._areTexturesDirty){if(s._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(s.TEXTURELODSUPPORT=!0),this._diffuseTexture&&De.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE"),s.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,s.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,s.OPACITYFRESNEL=this._opacityFresnel}else s.DIFFUSE=!1,s.DIFFUSEDIRECTUV=0,s.DIFFUSEHASALPHA=!1,s.GAMMADIFFUSE=!1,s.OPACITYFRESNEL=!1;const o=this._reflectionTexture;if(o&&De.ReflectionTextureEnabled){if(!o.isReadyOrNotBlocking())return!1;switch(s.REFLECTION=!0,s.GAMMAREFLECTION=o.gammaSpace,s.RGBDREFLECTION=o.isRGBD,s.REFLECTIONBLUR=this._reflectionBlur>0,s.LODINREFLECTIONALPHA=o.lodLevelInAlpha,s.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,s.REFLECTIONBGR=this.switchToBGR,o.coordinatesMode===j.INVCUBIC_MODE&&(s.INVERTCUBICMAP=!0),s.REFLECTIONMAP_3D=o.isCube,s.REFLECTIONMAP_OPPOSITEZ=s.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!o.invertZ:o.invertZ,o.coordinatesMode){case j.EXPLICIT_MODE:s.REFLECTIONMAP_EXPLICIT=!0;break;case j.PLANAR_MODE:s.REFLECTIONMAP_PLANAR=!0;break;case j.PROJECTION_MODE:s.REFLECTIONMAP_PROJECTION=!0;break;case j.SKYBOX_MODE:s.REFLECTIONMAP_SKYBOX=!0;break;case j.SPHERICAL_MODE:s.REFLECTIONMAP_SPHERICAL=!0;break;case j.EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case j.FIXED_EQUIRECTANGULAR_MODE:s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case j.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;default:s.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(s.REFLECTIONFRESNEL=!0,s.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1)}else s.REFLECTION=!1,s.REFLECTIONFRESNEL=!1,s.REFLECTIONFALLOFF=!1,s.REFLECTIONBLUR=!1,s.REFLECTIONMAP_3D=!1,s.REFLECTIONMAP_SPHERICAL=!1,s.REFLECTIONMAP_PLANAR=!1,s.REFLECTIONMAP_CUBIC=!1,s.REFLECTIONMAP_PROJECTION=!1,s.REFLECTIONMAP_SKYBOX=!1,s.REFLECTIONMAP_EXPLICIT=!1,s.REFLECTIONMAP_EQUIRECTANGULAR=!1,s.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,s.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,s.INVERTCUBICMAP=!1,s.REFLECTIONMAP_OPPOSITEZ=!1,s.LODINREFLECTIONALPHA=!1,s.GAMMAREFLECTION=!1,s.RGBDREFLECTION=!1}s.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,s.USERGBCOLOR=this._useRGBColor,s.NOISE=this._enableNoise}if(s._areLightsDirty&&(s.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),s.BACKMAT_SHADOWONLY=this._shadowOnly),s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s)}if(fe.PrepareDefinesForMisc(e,n,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),s),fe.PrepareDefinesForFrameBoundValues(n,a,this,s,i,null,t.getRenderingMesh().hasThinInstances),fe.PrepareDefinesForAttributes(e,s,!1,!0,!1)&&e&&!n.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(I.NormalKind)&&(e.createNormals(!0),H.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),s.isDirty){s.markAsProcessed(),n.resetCachedMaterial();const o=new xl;s.FOG&&o.addFallback(0,"FOG"),s.POINTSIZE&&o.addFallback(1,"POINTSIZE"),s.MULTIVIEW&&o.addFallback(0,"MULTIVIEW"),fe.HandleFallbacksForShadows(s,o,this._maxSimultaneousLights);const l=[I.PositionKind];s.NORMAL&&l.push(I.NormalKind),s.UV1&&l.push(I.UVKind),s.UV2&&l.push(I.UV2Kind),fe.PrepareAttributesForBones(l,e,s,o),fe.PrepareAttributesForInstances(l,s);const c=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"];Sl(c);const u=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],h=["Material","Scene"];Wt&&(Wt.PrepareUniforms(c,s),Wt.PrepareSamplers(u,s)),fe.PrepareUniformsAndSamplersList({uniformsNames:c,uniformBuffersNames:h,samplers:u,defines:s,maxSimultaneousLights:this._maxSimultaneousLights});const d=s.toString(),f=n.getEngine().createEffect("background",{attributes:l,uniformsNames:c,uniformBuffersNames:h,samplers:u,defines:d,fallbacks:o,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},a);t.setEffect(f,s,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady()||(s._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}_computePrimaryColorFromPerceptualColor(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const n=this.getScene(),s=i.materialDefines;if(!s)return;const a=i.effect;if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e),fe.BindBonesParameters(t,this._activeEffect);const o=this._mustRebind(n,a,t.visibility);if(o){this._uniformBuffer.bindToEffect(a,"Material"),this.bindViewProjection(a);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(n.texturesEnabled&&(this._diffuseTexture&&De.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),fe.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&De.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),n.texturesEnabled&&(this._diffuseTexture&&De.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&De.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),Uo(this._activeEffect,this,n),n.bindEyePosition(a)}else n.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(a,"Material"),this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(n.lightsEnabled&&fe.BindLights(n,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(a),fe.BindFogParameters(n,t,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!(!super.hasTexture(e)&&this._reflectionTexture!==e&&this._diffuseTexture!==e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return lt.Clone(()=>new Nt(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return lt.Parse(()=>new Nt(e.name,t),e,t,i)}}Nt.StandardReflectance0=.05,Nt.StandardReflectance90=.5,b([cn()],Nt.prototype,"_primaryColor",void 0),b([ee("_markAllSubMeshesAsLightsDirty")],Nt.prototype,"primaryColor",void 0),b([cn()],Nt.prototype,"__perceptualColor",void 0),b([O()],Nt.prototype,"_primaryColorShadowLevel",void 0),b([O()],Nt.prototype,"_primaryColorHighlightLevel",void 0),b([ee("_markAllSubMeshesAsLightsDirty")],Nt.prototype,"primaryColorHighlightLevel",null),b([Bt()],Nt.prototype,"_reflectionTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionTexture",void 0),b([O()],Nt.prototype,"_reflectionBlur",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionBlur",void 0),b([Bt()],Nt.prototype,"_diffuseTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"diffuseTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"shadowLights",void 0),b([O()],Nt.prototype,"_shadowLevel",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"shadowLevel",void 0),b([Mr()],Nt.prototype,"_sceneCenter",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"sceneCenter",void 0),b([O()],Nt.prototype,"_opacityFresnel",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"opacityFresnel",void 0),b([O()],Nt.prototype,"_reflectionFresnel",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionFresnel",void 0),b([O()],Nt.prototype,"_reflectionFalloffDistance",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionFalloffDistance",void 0),b([O()],Nt.prototype,"_reflectionAmount",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionAmount",void 0),b([O()],Nt.prototype,"_reflectionReflectance0",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionReflectance0",void 0),b([O()],Nt.prototype,"_reflectionReflectance90",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"reflectionReflectance90",void 0),b([O()],Nt.prototype,"_useRGBColor",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"useRGBColor",void 0),b([O()],Nt.prototype,"_enableNoise",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"enableNoise",void 0),b([O()],Nt.prototype,"_maxSimultaneousLights",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Nt.prototype,"maxSimultaneousLights",void 0),b([O()],Nt.prototype,"_shadowOnly",void 0),b([ee("_markAllSubMeshesAsLightsDirty")],Nt.prototype,"shadowOnly",void 0),b([Ub()],Nt.prototype,"_imageProcessingConfiguration",void 0),ye("BABYLON.BackgroundMaterial",Nt);class qf{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,Ve.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||Fe.White(),this.rightColor=e.rightColor||Fe.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){const e=new qf;return Wr.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new qf({isEnabled:e.isEnabled,leftColor:Fe.FromArray(e.leftColor),rightColor:Fe.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}lt._FresnelParametersParser=qf.Parse;const kW=new RegExp("^([gimus]+)!");let GW=(()=>{class r{constructor(t){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=t,this._scene=t.getScene(),this._engine=this._scene.getEngine()}_addPlugin(t){for(let s=0;s<this._plugins.length;++s)if(this._plugins[s].name===t.name)throw`Plugin "${t.name}" already added to the material "${this._material.name}"!`;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${t.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const i=t.getClassName();r._MaterialPluginClassToMainDefine[i]||(r._MaterialPluginClassToMainDefine[i]="MATERIALPLUGIN_"+ ++r._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(t),this._plugins.sort((s,a)=>s.priority-a.priority),this._codeInjectionPoints={};const n={};n[r._MaterialPluginClassToMainDefine[i]]={type:"boolean",default:!0};for(const s of this._plugins)s.collectDefines(n),this._collectPointNames("vertex",s.getCustomCode("vertex")),this._collectPointNames("fragment",s.getCustomCode("fragment"));this._defineNamesFromPlugins=n}_activatePlugin(t){-1===this._activePlugins.indexOf(t)&&(this._activePlugins.push(t),this._activePlugins.sort((i,n)=>i.priority-n.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),t.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(t),this._activePluginsForExtraEvents.sort((i,n)=>i.priority-n.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(t){for(let i=0;i<this._plugins.length;++i)if(this._plugins[i].name===t)return this._plugins[i];return null}_handlePluginEventIsReadyForSubMesh(t){let i=!0;for(const n of this._activePlugins)i=i&&n.isReadyForSubMesh(t.defines,this._scene,this._engine,t.subMesh);t.isReadyForSubMesh=i}_handlePluginEventPrepareDefinesBeforeAttributes(t){for(const i of this._activePlugins)i.prepareDefinesBeforeAttributes(t.defines,this._scene,t.mesh)}_handlePluginEventPrepareDefines(t){for(const i of this._activePlugins)i.prepareDefines(t.defines,this._scene,t.mesh)}_handlePluginEventHardBindForSubMesh(t){for(const i of this._activePluginsForExtraEvents)i.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,t.subMesh)}_handlePluginEventBindForSubMesh(t){for(const i of this._activePlugins)i.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,t.subMesh)}_handlePluginEventHasRenderTargetTextures(t){let i=!1;for(const n of this._activePluginsForExtraEvents)if(i=n.hasRenderTargetTextures(),i)break;t.hasRenderTargetTextures=i}_handlePluginEventFillRenderTargetTextures(t){for(const i of this._activePluginsForExtraEvents)i.fillRenderTargetTextures(t.renderTargets)}_handlePluginEvent(t,i){var n;switch(t){case In.GetActiveTextures:{const s=i;for(const a of this._activePlugins)a.getActiveTextures(s.activeTextures);break}case In.GetAnimatables:{const s=i;for(const a of this._activePlugins)a.getAnimatables(s.animatables);break}case In.HasTexture:{const s=i;let a=!1;for(const o of this._activePlugins)if(a=o.hasTexture(s.texture),a)break;s.hasTexture=a;break}case In.Disposed:{const s=i;for(const a of this._plugins)a.dispose(s.forceDisposeTextures);break}case In.GetDefineNames:i.defineNames=this._defineNamesFromPlugins;break;case In.PrepareEffect:{const s=i;for(const a of this._activePlugins)s.fallbackRank=a.addFallbacks(s.defines,s.fallbacks,s.fallbackRank),a.getAttributes(s.attributes,this._scene,s.mesh);this._uniformList.length>0&&s.uniforms.push(...this._uniformList),this._samplerList.length>0&&s.samplers.push(...this._samplerList),this._uboList.length>0&&s.uniformBuffersNames.push(...this._uboList),s.customCode=this._injectCustomCode(s.customCode);break}case In.PrepareUniformBuffer:{const s=i;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const a of this._plugins){const o=a.getUniforms();if(o){if(o.ubo)for(const l of o.ubo){if(l.size&&l.type){const c=null!==(n=l.arraySize)&&void 0!==n?n:0;s.ubo.addUniform(l.name,l.size,c),this._uboDeclaration+=`${l.type} ${l.name}${c>0?`[${c}]`:""};\r\n`}this._uniformList.push(l.name)}o.vertex&&(this._vertexDeclaration+=o.vertex+"\r\n"),o.fragment&&(this._fragmentDeclaration+=o.fragment+"\r\n")}a.getSamplers(this._samplerList),a.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(t,i){if(i)for(const n in i)this._codeInjectionPoints[t]||(this._codeInjectionPoints[t]={}),this._codeInjectionPoints[t][n]=!0}_injectCustomCode(t){return(i,n)=>{var s;t&&(n=t(i,n)),this._uboDeclaration&&(n=n.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(n=n.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(n=n.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const a=null===(s=this._codeInjectionPoints)||void 0===s?void 0:s[i];if(!a)return n;for(let o in a){let l="";for(const c of this._activePlugins){const u=c.getCustomCode(i);(null==u?void 0:u[o])&&(l+=u[o]+"\r\n")}if(l.length>0)if("!"===o.charAt(0)){o=o.substring(1);let c="g";if("!"===o.charAt(0))c="",o=o.substring(1);else{const f=kW.exec(o);f&&f.length>=2&&(c=f[1],o=o.substring(c.length+1))}c.indexOf("g")<0&&(c+="g");const u=n,h=new RegExp(o,c);let d=h.exec(u);for(;null!==d;){let f=l;for(let p=0;p<d.length;++p)f=f.replace("$"+p,d[p]);n=n.replace(d[0],f),d=h.exec(u)}}else{const c="#define "+o;n=n.replace(c,"\r\n"+l+"\r\n"+c)}}return n}}}return r._MaterialPluginClassToMainDefine={},r._MaterialPluginCounter=0,r})();class Js{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,n,s=!0,a=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,e.pluginManager||(e.pluginManager=new GW(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=n,this._pluginManager=e.pluginManager,s&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,n){return!0}hardBindForSubMesh(e,t,i,n){}bindForSubMesh(e,t,i,n){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const i=typeof this._pluginDefineNames[t];e[t]={type:"number"===i?"number":"string"===i?"string":"boolean"===i?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){lt.Clone(()=>e,this)}serialize(){return lt.Serialize(this)}parse(e,t,i){lt.Parse(()=>this,e,t,i)}}b([O()],Js.prototype,"name",void 0),b([O()],Js.prototype,"priority",void 0),b([O()],Js.prototype,"registerForExtraEvents",void 0);class zW extends us{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.MAINUV1=!1}}class yh extends Js{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new zW,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new We(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&De.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(I.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.AnisotropicTextureEnabled?fe.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){this._isEnabled&&((!e.useUbo||!this._material.isFrozen||!e.isSync)&&(this._texture&&De.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),fe.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&De.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture))}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}}b([O(),ee("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"isEnabled",void 0),b([O()],yh.prototype,"intensity",void 0),b([Lb()],yh.prototype,"direction",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],yh.prototype,"texture",void 0);Z.ShadersStore.rgbdDecodePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);\n}";Z.ShadersStore.passCubePixelShader="varying vec2 vUV;\nuniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\nvec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";class Hc extends li{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,n,s,a,o=0,l=!1){super(e,"pass",null,null,t,i,n,s,a,void 0,o,void 0,null,l)}static _Parse(e,t,i,n){return lt.Parse(()=>new Hc(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,n)}}let Jf,IM;function Ca(r){Jf||(Jf=new Float32Array(1),IM=new Int32Array(Jf.buffer)),Jf[0]=r;const e=IM[0];let t=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?t:n>142?(t|=31744,t|=(255==n?0:1)&&8388607&e,t):n<113?(i|=2048,t|=(i>>114-n)+(i>>113-n&1),t):(t|=n-112<<10|i>>1,t+=1&i,t)}function Ia(r){const e=(32768&r)>>15,t=(31744&r)>>10,i=1023&r;return 0===t?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):31==t?i?NaN:1/0*(e?-1:1):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}ye("BABYLON.PassPostProcess",Hc),Ve._RescalePostProcessFactory=r=>new Hc("rescale",1,null,2,r,!1,0);class jT{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),n=i.getCaps(),s=t.isReady;let a=!1;n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(a=!0,t.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(a=!0,t.type=1),a&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=()=>{if(a){const l=new li("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;const c=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=u=>{u._bindTexture("textureSampler",t),u.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],c,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),c._swapAndDie(t),t.isReady=!0})}};s?o():e.onLoadObservable.addOnce(o)}static EncodeTextureToRGBD(e,t,i=0){return function CM(r,e,t,i,n,s,a,o){const l=e.getEngine();return e.isReady=!1,n=null!=n?n:e.samplingMode,s=null!=s?s:e.format,a=null!=a?a:e.width,o=null!=o?o:e.height,-1===(i=null!=i?i:e.type)&&(i=0),new Promise(c=>{const u=new li("postprocess",r,null,null,1,null,n,l,!1,void 0,i,void 0,null,!1,s);u.externalTextureSamplerBinding=!0;const h=l.createRenderTargetTexture({width:a,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:i,format:s});u.getEffect().executeWhenCompiled(()=>{u.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([u],h,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),u&&u.dispose(),h._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,c(e)})})}("rgbdEncode",e,t,i,1,5)}}let YW=0;const ep=r=>{if(!r.environmentBRDFTexture){const e=r.useDelayedTextureLoading;r.useDelayedTextureLoading=!1;const t=r._blockEntityCollection;r._blockEntityCollection=!1;const i=j.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+YW++,r,!0,!1,j.BILINEAR_SAMPLINGMODE);r._blockEntityCollection=t;const n=r.getEngine().getLoadedTexturesCache(),s=n.indexOf(i.getInternalTexture());-1!==s&&n.splice(s,1),i.isRGBD=!0,i.wrapU=j.CLAMP_ADDRESSMODE,i.wrapV=j.CLAMP_ADDRESSMODE,r.environmentBRDFTexture=i,r.useDelayedTextureLoading=e,jT.ExpandRGBDTexture(i);const a=r.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const o=()=>{i.isReady()?jT.ExpandRGBDTexture(i):Ie.SetImmediate(o)};o()});r.onDisposeObservable.add(()=>{r.getEngine().onContextRestoredObservable.remove(a)})}return r.environmentBRDFTexture};class jW extends us{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Zn extends Js{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new jW,t),this._useEnergyConservation=Zn.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Zn.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Zn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Zn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Zn.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Zn.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Zn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Zn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}Zn.DEFAULT_USE_ENERGY_CONSERVATION=!0,Zn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,Zn.DEFAULT_USE_SPHERICAL_HARMONICS=!0,Zn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,b([O(),ee("_markAllSubMeshesAsMiscDirty")],Zn.prototype,"useEnergyConservation",void 0),b([O(),ee("_markAllSubMeshesAsMiscDirty")],Zn.prototype,"useSmithVisibilityHeightCorrelated",void 0),b([O(),ee("_markAllSubMeshesAsMiscDirty")],Zn.prototype,"useSphericalHarmonics",void 0),b([O(),ee("_markAllSubMeshesAsMiscDirty")],Zn.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);class zc{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,n,s){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&-1!==t.prePassRenderer.getIndex(2)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=n.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const a=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==a.frameId&&(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=n.clone()}}}class Wc{constructor(e,t,i,n){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=n}}class tp{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;null===(t=e.getScene())||void 0===t||t.getEngine().flushFramebuffer();const i=e.getSize().width,n=e.readPixels(0,void 0,void 0,!1),s=e.readPixels(1,void 0,void 0,!1);let a,o;e.isRenderTarget?(a=e.readPixels(3,void 0,void 0,!1),o=e.readPixels(2,void 0,void 0,!1)):(a=e.readPixels(2,void 0,void 0,!1),o=e.readPixels(3,void 0,void 0,!1));const l=e.readPixels(4,void 0,void 0,!1),c=e.readPixels(5,void 0,void 0,!1),u=e.gammaSpace;let d=0;return(1==e.textureType||2==e.textureType)&&(d=1),new Promise(f=>{Promise.all([s,n,a,o,l,c]).then(([p,g,_,m,T,v])=>{f(this.ConvertCubeMapToSphericalPolynomial({size:i,right:g,left:p,up:_,down:m,front:T,back:v,format:5,type:d,gammaSpace:u}))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new hh;let i=0;const n=2/e.size,s=n,a=.5*n,o=a-1;for(let d=0;d<6;d++){const f=this._FileFaces[d],p=e[f.name];let g=o;const _=5===e.format?4:3;for(let m=0;m<e.size;m++){let T=o;for(let v=0;v<e.size;v++){const A=f.worldAxisForFileX.scale(T).add(f.worldAxisForFileY.scale(g)).add(f.worldAxisForNormal);A.normalize();const S=this._AreaElement(T-a,g-a)-this._AreaElement(T-a,g+a)-this._AreaElement(T+a,g-a)+this._AreaElement(T+a,g+a);let x=p[m*e.size*_+v*_+0],C=p[m*e.size*_+v*_+1],R=p[m*e.size*_+v*_+2];isNaN(x)&&(x=0),isNaN(C)&&(C=0),isNaN(R)&&(R=0),0===e.type&&(x/=255,C/=255,R/=255),e.gammaSpace&&(x=Math.pow(Se.Clamp(x),2.2),C=Math.pow(Se.Clamp(C),2.2),R=Math.pow(Se.Clamp(R),2.2));const D=4096;x=Se.Clamp(x,0,D),C=Se.Clamp(C,0,D),R=Se.Clamp(R,0,D);const P=new Fe(x,C,R);t.addLight(A,P,S),i+=S,T+=n}g+=s}}const h=4*Math.PI*6/6/i;return t.scaleInPlace(h),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),_l.FromHarmonics(t)}}tp._FileFaces=[new Wc("right",new E(1,0,0),new E(0,0,-1),new E(0,-1,0)),new Wc("left",new E(-1,0,0),new E(0,0,1),new E(0,-1,0)),new Wc("up",new E(0,1,0),new E(1,0,0),new E(0,0,1)),new Wc("down",new E(0,-1,0),new E(1,0,0),new E(0,0,-1)),new Wc("front",new E(0,0,1),new E(1,0,0),new E(0,-1,0)),new Wc("back",new E(0,0,-1),new E(-1,0,0),new E(0,-1,0))],di.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(di.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=tp.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(r=>{this._texture._sphericalPolynomial=r,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(r){this._texture&&(this._texture._sphericalPolynomial=r)},enumerable:!0,configurable:!0});Z.IncludesShadersStore.prePassDeclaration="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n";Z.IncludesShadersStore.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;\nlayout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;\nuniform sampler2D oitDepthSampler;\nuniform sampler2D oitFrontColorSampler;\n#endif\n";Z.IncludesShadersStore.decalFragmentDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\n#endif\n";Z.IncludesShadersStore.pbrFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec4 vMetallicReflectanceFactors;\nuniform vec3 vEmissiveColor;\nuniform float visibility;\nuniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;\nuniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform vec2 vClearCoatTangentSpaceParams;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;\nuniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;\nuniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;\nuniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;\nuniform vec3 vDiffusionDistance;\nuniform vec4 vTintColor;\nuniform vec3 vSubSurfaceIntensity;\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";Z.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;\nuniform Material {\nvec2 vAlbedoInfos;\nvec4 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec3 vReflectivityInfos;\nvec2 vMicroSurfaceSamplerInfos;\nvec2 vReflectionInfos;\nvec2 vReflectionFilteringInfo;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec3 vBumpInfos;\nmat4 albedoMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 reflectivityMatrix;\nmat4 microSurfaceSamplerMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nmat4 reflectionMatrix;\nvec3 vReflectionColor;\nvec4 vAlbedoColor;\nvec4 vLightingIntensity;\nvec3 vReflectionMicrosurfaceInfos;\nfloat pointSize;\nvec4 vReflectivityColor;\nvec3 vEmissiveColor;\nvec3 vAmbientColor;\nvec2 vDebugMode;\nvec4 vMetallicReflectanceFactors;\nvec2 vMetallicReflectanceInfos;\nmat4 metallicReflectanceMatrix;\nvec2 vReflectanceInfos;\nmat4 reflectanceMatrix;\nvec3 vSphericalL00;\nvec3 vSphericalL1_1;\nvec3 vSphericalL10;\nvec3 vSphericalL11;\nvec3 vSphericalL2_2;\nvec3 vSphericalL2_1;\nvec3 vSphericalL20;\nvec3 vSphericalL21;\nvec3 vSphericalL22;\nvec3 vSphericalX;\nvec3 vSphericalY;\nvec3 vSphericalZ;\nvec3 vSphericalXX_ZZ;\nvec3 vSphericalYY_ZZ;\nvec3 vSphericalZZ;\nvec3 vSphericalXY;\nvec3 vSphericalYZ;\nvec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";Z.IncludesShadersStore.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n";Z.IncludesShadersStore.pbrFragmentExtraDeclaration="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n";Z.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n";Z.IncludesShadersStore.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";Z.IncludesShadersStore.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;\nuniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;\nuniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#endif\n";Z.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif\n";Z.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{\nreturn diffusionProfile<1.;\n}";Z.IncludesShadersStore.importanceSampling="vec3 hemisphereCosSample(vec2 u) {\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=1.-u.y;\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;\nfloat sinTheta=pow(u.y,a/(2.*a+1.));\nfloat cosTheta=sqrt(1.-sinTheta*sinTheta);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}";Z.IncludesShadersStore.pbrHelperFunctions="#define RECIPROCAL_PI2 0.15915494\n#define RECIPROCAL_PI 0.31830988618\n#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{\nreturn square(roughness)+MINIMUMVARIANCE;\n}\nfloat fresnelGrazingReflectance(float reflectance0) {\nfloat reflectance90=saturate(reflectance0*25.0);\nreturn reflectance90;\n}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);\nvec3 nDfdy=dFdy(normalVector.xyz);\nfloat slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));\nfloat geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);\nfloat geometricAlphaGFactor=sqrt(slopeSquare);\ngeometricAlphaGFactor*=0.75;\nreturn vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {\nfloat alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);\nfloat alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);\nreturn vec2(alphaT,alphaB);\n}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {\nvec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);\nvec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);\nvec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));\nreturn anisotropicNormal;\n}\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {\nreturn exp(-alpha*distance);\n}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {\nreturn cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));\n}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {\nreturn -log(color)/distance;\n}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);\nreturn clearCoatAbsorption;\n}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n#endif\n";Z.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nreturn vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));\n}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz *Nz+C1;\nvec3 t2=a2 *Ny+t1;\nvec3 t3=b3 *Nx+t2;\nreturn t3;\n}\n#endif\n#endif\n";Z.IncludesShadersStore.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{\nvec3 lightOffset;\nfloat lightDistanceSquared;\nfloat lightDistance;\nfloat attenuation;\nvec3 L;\nvec3 H;\nfloat NdotV;\nfloat NdotLUnclamped;\nfloat NdotL;\nfloat VdotH;\nfloat roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n};\npreLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.lightOffset=lightData.xyz-vPositionW;\nresult.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);\nresult.lightDistance=sqrt(result.lightDistanceSquared);\nresult.L=normalize(result.lightOffset);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.lightDistance=length(-lightData.xyz);\nresult.L=normalize(-lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\nresult.NdotL=dot(N,lightData.xyz)*0.5+0.5;\nresult.NdotL=saturateEps(result.NdotL);\nresult.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;\n}";Z.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{\nreturn max(0.,1.0-length(lightOffset)/range);\n}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{\nreturn 1.0/maxEps(lightDistanceSquared);\n}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{\nfloat lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);\nfloat factor=lightDistanceSquared*inverseSquaredRange;\nfloat attenuation=saturate(1.0-factor*factor);\nattenuation*=attenuation;\nlightDistanceFalloff*=attenuation;\nreturn lightDistanceFalloff;\n}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\nfloat cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfloat falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{\nfloat cd=dot(-lightDirection,directionToLightCenterW);\nfloat falloff=saturate(cd*lightAngleScale+lightAngleOffset);\nfalloff*=falloff;\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";Z.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\nreturn 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);\n}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {\nvec2 UV=vec2(NdotV,perceptualRoughness);\nvec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;\n}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{\nfloat c=1.0-NdotV;\nfloat c3=c*c*c;\nreturn 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));\n}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {\nvec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;\nreturn sheenEnvironmentReflectance;\n}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);\nvec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);\nreturn square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);\nvec3 getIORTfromAirToSurfaceR0(vec3 f0) {\nvec3 sqrtF0=sqrt(f0);\nreturn (1.+sqrtF0)/(1.-sqrtF0);\n}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {\nreturn square((iorT-vec3(iorI))/(iorT+vec3(iorI)));\n}\nfloat getR0fromIORs(float iorT,float iorI) {\nreturn square((iorT-iorI)/(iorT+iorI));\n}\nvec3 evalSensitivity(float opd,vec3 shift) {\nfloat phase=2.0*PI*opd*1.0e-9;\nconst vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);\nconst vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);\nconst vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);\nvec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);\nxyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));\nxyz/=1.0685e-7;\nvec3 srgb=XYZ_TO_REC709*xyz;\nreturn srgb;\n}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {\nvec3 I=vec3(1.0);\nfloat iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));\nfloat sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));\nfloat cosTheta2Sq=1.0-sinTheta2Sq;\nif (cosTheta2Sq<0.0) {\nreturn I;\n}\nfloat cosTheta2=sqrt(cosTheta2Sq);\nfloat R0=getR0fromIORs(iridescenceIOR,outsideIOR);\nfloat R12=fresnelSchlickGGX(cosTheta1,R0,1.);\nfloat R21=R12;\nfloat T121=1.0-R12;\nfloat phi12=0.0;\nif (iridescenceIOR<outsideIOR) phi12=PI;\nfloat phi21=PI-phi12;\nvec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);\nvec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));\nvec3 phi23=vec3(0.0);\nif (baseIOR[0]<iridescenceIOR) phi23[0]=PI;\nif (baseIOR[1]<iridescenceIOR) phi23[1]=PI;\nif (baseIOR[2]<iridescenceIOR) phi23[2]=PI;\nfloat opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;\nvec3 phi=vec3(phi21)+phi23;\nvec3 R123=clamp(R12*R23,1e-5,0.9999);\nvec3 r123=sqrt(R123);\nvec3 Rs=square(T121)*R23/(vec3(1.0)-R123);\nvec3 C0=R12+Rs;\nI=C0;\nvec3 Cm=Rs-T121;\nfor (int m=1; m<=2; ++m)\n{\nCm*=r123;\nvec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);\nI+=Cm*Sm;\n}\nreturn max(I,vec3(0.0));\n}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{\nfloat invR=1./alphaG;\nfloat cos2h=NdotH*NdotH;\nfloat sin2h=1.-cos2h;\nreturn (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);\n}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {\nfloat a2=alphaTB.x*alphaTB.y;\nvec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);\nfloat v2=dot(v,v);\nfloat w2=a2/v2;\nreturn a2*w2*w2*RECIPROCAL_PI;\n}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);\nfloat GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);\nreturn 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;\nfloat GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);\nfloat GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);\nreturn 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;\nreturn 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{\nfloat visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);\nreturn visibility;\n}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {\nfloat lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));\nfloat lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));\nfloat v=0.5/(lambdaV+lambdaL);\nreturn v;\n}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {\nreturn 0.25/(VdotH*VdotH); \n}\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{\nreturn 1./(4.*(NdotL+NdotV-NdotL*NdotV));\n}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{\nfloat oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);\nfloat a=mix(21.5473,25.3245,oneMinusAlphaSq);\nfloat b=mix(3.82987,3.32435,oneMinusAlphaSq);\nfloat c=mix(0.19823,0.16801,oneMinusAlphaSq);\nfloat d=mix(-1.97760,-1.27393,oneMinusAlphaSq);\nfloat e=mix(-4.32054,-4.85967,oneMinusAlphaSq);\nreturn a/(1.0+b*pow(x,c))+d*x+e;\n}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{\nreturn abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));\n}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{\nfloat G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));\nreturn G/(4.0*NdotV*NdotL);\n}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {\nfloat diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));\nfloat diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel/PI;\n}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {\nvec3 S=1./maxEps(diffusionDistance);\nvec3 temp=exp((-0.333333333*thickness)*S);\nreturn tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);\n}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {\nfloat t=1.0+w;\nfloat invt2=1.0/square(t);\nreturn saturate((NdotL+w)*invt2);\n}\n#endif\n";Z.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{\nbits=(bits<<16u) | (bits>>16u);\nbits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);\nbits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);\nbits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);\nbits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);\nreturn float(bits)*2.3283064365386963e-10; \n}\nvec2 hammersley(uint i,uint N)\n{\nreturn vec2(float(i)/float(N),radicalInverse_VdC(i));\n}\n#else\nfloat vanDerCorpus(int n,int base)\n{\nfloat invBase=1.0/float(base);\nfloat denom =1.0;\nfloat result =0.0;\nfor(int i=0; i<32; ++i)\n{\nif(n>0)\n{\ndenom =mod(float(n),2.0);\nresult+=denom*invBase;\ninvBase=invBase/2.0;\nn =int(float(n)/2.0);\n}\n}\nreturn result;\n}\nvec2 hammersley(int i,int N)\n{\nreturn vec2(float(i)/float(N),vanDerCorpus(i,2));\n}\n#endif\nfloat log4(float x) {\nreturn log2(x)/2.;\n}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);\nconst float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;\nconst float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nvec3 result=vec3(0.0);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 Ls=hemisphereCosSample(Xi);\nLs=normalize(Ls);\nvec3 Ns=vec3(0.,0.,1.);\nfloat NoL=dot(Ns,Ls);\nif (NoL>0.) {\nfloat pdf_inversed=PI/NoL;\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(l,0.0,maxLevel);\nvec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c;\n}\n}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;\nreturn result;\n}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nif (alphaG==0.) {\nvec3 c=textureCube(inputTexture,n).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;\n} else {\nvec3 result=vec3(0.);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\nfloat weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);\nfloat NoV=1.;\nfloat NoH=H.z;\nfloat NoH2=H.z*H.z;\nfloat NoL=2.*NoH2-1.;\nvec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);\nL=normalize(L);\nif (NoL>0.) {\nfloat pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(float(l),0.0,maxLevel);\nweight+=NoL;\nvec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;\n}\n}\nresult=result/weight;\nreturn result;\n}\n}\n#endif\n#endif\n";Z.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;\nfloat totalRoughness=saturate(lightRoughness+roughness);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {\nreturn mix(groundColor,lightColor,info.NdotL);\n}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {\nfloat diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*info.attenuation*info.NdotL*lightColor;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn toLinearSpace(textureColor);\n}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {\nfloat NdotL=absEps(info.NdotLUnclamped);\nfloat wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);\nfloat trAdapt=step(0.,info.NdotLUnclamped);\nvec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);\nfloat diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;\n}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat TdotH=dot(T,info.H);\nfloat BdotH=dot(B,info.H);\nfloat TdotV=dot(T,V);\nfloat BdotV=dot(B,V);\nfloat TdotL=dot(T,info.L);\nfloat BdotL=dot(B,info.L);\nfloat alphaG=convertRoughnessToAverageSlope(info.roughness);\nvec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);\nalphaTB=max(alphaTB,square(geometricRoughnessFactor));\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);\nfloat smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {\nfloat NccdotL=saturateEps(dot(Ncc,info.L));\nfloat NccdotH=saturateEps(dot(Ncc,info.H));\nfloat clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\nfloat fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnel*=clearCoatIntensity;\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);\nfloat kelemenVisibility=visibility_Kelemen(info.VdotH);\nfloat clearCoatTerm=fresnel*distribution*kelemenVisibility;\nreturn vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);\n}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);\nfloat NdotLRefract=saturateEps(dot(Ncc,LRefract));\nvec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);\nreturn absorption;\n}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat fresnel=1.;\nfloat distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);\n/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);\n/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;\nreturn sheenTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n";Z.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {\nfloat microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {\nfloat lod=log2(cubeMapDimensionPixels)*roughness;\nreturn lod;\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn saturate(square(temp)-1.0+ambientOcclusion);\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {\nvec3 reflection=reflect(view,normal);\nfloat temp=saturate(1.0+1.1*dot(reflection,geometricNormal));\nreturn square(temp);\n}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nreturn getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);\n}\n#endif\n";Z.IncludesShadersStore.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{\nmat4 ret=inverse(wMatrix);\nret=transpose(ret);\nret[0][3]=0.;\nret[1][3]=0.;\nret[2][3]=0.;\nret[3]=vec4(0.,0.,0.,1.);\nreturn ret;\n}\n#else\nmat4 toNormalMatrix(mat4 m)\n{\nfloat\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;\nmat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;\nreturn mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);\n}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{\nreturn perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);\n}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\ntangent*=tangentSpaceParams.x;\nbitangent*=tangentSpaceParams.y;\nfloat det=max(dot(tangent,tangent),dot(bitangent,bitangent));\nfloat invmax=det==0.0 ? 0.0 : inversesqrt(det);\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\n#endif\n";Z.IncludesShadersStore.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nbool keepWorking=true;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;\nif (!keepWorking)\n{\n}\nelse if (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\nkeepWorking=false;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n";Z.IncludesShadersStore.decalFragment="#ifdef DECAL\n#ifdef GAMMADECAL\ndecalColor.rgb=toLinearSpace(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalColor.a*=decalColor.a;\n#endif\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);\n#endif\n";Z.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{\nvec3 surfaceAlbedo;\nfloat alpha;\n};\n#define pbr_inline\nvoid albedoOpacityBlock(\nin vec4 vAlbedoColor,\n#ifdef ALBEDO\nin vec4 albedoTexture,\nin vec2 albedoInfos,\n#endif\n#ifdef OPACITY\nin vec4 opacityMap,\nin vec2 vOpacityInfos,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\n#ifdef DECAL\nin vec4 decalColor,\nin vec4 vDecalInfos,\n#endif\nout albedoOpacityOutParams outParams\n)\n{\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#include<decalFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);\nsurfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;\noutParams.alpha=alpha;\n}\n";Z.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{\nfloat microSurface;\nfloat roughness;\nvec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\nvec4 surfaceMetallicColorMap;\nvec4 surfaceReflectivityColorMap;\nvec2 metallicRoughness;\nvec3 metallicF0;\n#endif\n};\n#define pbr_inline\nvoid reflectivityBlock(\nin vec4 vReflectivityColor,\n#ifdef METALLICWORKFLOW\nin vec3 surfaceAlbedo,\nin vec4 metallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nin vec3 reflectivityInfos,\nin vec4 surfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nin vec3 ambientOcclusionColorIn,\n#endif\n#ifdef MICROSURFACEMAP\nin vec4 microSurfaceTexel,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\nout reflectivityOutParams outParams\n)\n{\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);\noutParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);\nfloat loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);\nfloat hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);\nmetallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;\nvec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);\nsurfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);\nsurfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;\nmicroSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);\nfloat roughness=1.-microSurface;\noutParams.microSurface=microSurface;\noutParams.roughness=roughness;\noutParams.surfaceReflectivityColor=surfaceReflectivityColor;\n}\n";Z.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{\nvec3 ambientOcclusionColor;\n#if DEBUGMODE>0\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nvoid ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos,\n#endif\nout ambientOcclusionOutParams outParams\n)\n{\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;\n}\n";Z.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{\nfloat alpha;\n};\n#define pbr_inline\nvoid alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface,\nout alphaFresnelOutParams outParams\n)\n{\nfloat opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\noutParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\n}\n#endif\n#endif\n";Z.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{\nfloat anisotropy;\nvec3 anisotropicTangent;\nvec3 anisotropicBitangent;\nvec3 anisotropicNormal;\n#if DEBUGMODE>0\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nvoid anisotropicBlock(\nin vec3 vAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW,\nout anisotropicOutParams outParams\n)\n{\nfloat anisotropy=vAnisotropy.b;\nvec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\nanisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));\nvec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);\nvec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));\noutParams.anisotropy=anisotropy;\noutParams.anisotropicTangent=anisotropicTangent;\noutParams.anisotropicBitangent=anisotropicBitangent;\noutParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);\n}\n#endif\n";Z.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{\nvec4 environmentRadiance;\nvec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);\nif (lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nenvironmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;\nenvironmentRadiance.rgb*=vReflectionColor.rgb;\n}\n#define pbr_inline\n#define inline\nvoid reflectionBlock(\nin vec3 vPositionW,\nin vec3 normalW,\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nin vec3 vEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin mat4 reflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout reflectionOutParams outParams\n)\n{\nvec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);\nsampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);\nvec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;\noutParams.environmentRadiance=environmentRadiance;\noutParams.environmentIrradiance=environmentIrradiance;\noutParams.reflectionCoords=reflectionCoords;\n}\n#endif\n";Z.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{\nfloat sheenIntensity;\nvec3 sheenColor;\nfloat sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\nvec4 sheenMapData;\nvec3 sheenEnvironmentReflectance;\n#endif\n};\n#define pbr_inline\n#define inline\nvoid sheenBlock(\nin vec4 vSheenColor,\n#ifdef SHEEN_ROUGHNESS\nin float vSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 sheenMapRoughnessData,\n#endif\n#endif\nin float roughness,\n#ifdef SHEEN_TEXTURE\nin vec4 sheenMapData,\nin float sheenMapLevel,\n#endif\nin float reflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nin vec3 baseColor,\nin vec3 surfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nin float NdotV,\nin vec3 environmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nin vec2 AARoughnessFactors,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nin vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nin vec2 reflectionCoords,\n#endif\nin float NdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nin float seo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nin float eho,\n#endif\n#endif\nout sheenOutParams outParams\n)\n{\nfloat sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);\nvec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);\nfloat sheenRoughness=sheenIntensity;\noutParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\n#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL\nsheenRoughness*=sheenMapData.a;\n#else\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);\nsampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);\nvec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;\noutParams.sheenColor=sheenColor;\noutParams.sheenRoughness=sheenRoughness;\n}\n#endif\n";Z.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{\nvec3 specularEnvironmentR0;\nfloat conservationFactor;\nvec3 clearCoatNormalW;\nvec2 clearCoatAARoughnessFactors;\nfloat clearCoatIntensity;\nfloat clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;\nfloat clearCoatNdotVRefract;\nvec3 clearCoatColor;\nfloat clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\nmat3 TBNClearCoat;\nvec2 clearCoatMapData;\nvec4 clearCoatTintMapData;\nvec4 environmentClearCoatRadiance;\nfloat clearCoatNdotV;\nvec3 clearCoatEnvironmentReflectance;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nvoid clearcoatBlock(\nin vec3 vPositionW,\nin vec3 geometricNormalW,\nin vec3 viewDirectionW,\nin vec2 vClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 clearCoatMapRoughnessData,\n#endif\nin vec3 specularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nin vec4 vClearCoatTintParams,\nin float clearCoatColorAtDistance,\nin vec4 vClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nin vec4 clearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nin vec2 vClearCoatBumpInfos,\nin vec4 clearCoatBumpMapData,\nin vec2 vClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nin mat3 vTBN,\n#else\nin vec2 vClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nin mat4 normalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nin vec3 faceNormal,\n#endif\n#ifdef REFLECTION\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nin float ambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\nin float frontFacingMultiplier,\n#endif\nout clearcoatOutParams outParams\n)\n{\nfloat clearCoatIntensity=vClearCoatParams.x;\nfloat clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL\nclearCoatRoughness*=clearCoatMapData.y;\n#else\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;\noutParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;\nfloat clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);\noutParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);\nvec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;\nmat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);\nclearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;\noutParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);\nfloat clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);\nfloat clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);\noutParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);\nvec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);\nclearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnelIBLClearCoat*=clearCoatIntensity;\noutParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\n}\n#endif\n";Z.IncludesShadersStore.pbrBlockIridescence="struct iridescenceOutParams\n{\nfloat iridescenceIntensity;\nfloat iridescenceIOR;\nfloat iridescenceThickness;\nvec3 specularEnvironmentR0;\n};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\nvoid iridescenceBlock(\nin vec4 vIridescenceParams,\nin float viewAngle,\nin vec3 specularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\nin vec2 iridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nin vec2 iridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nin float NdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#endif\nout iridescenceOutParams outParams\n)\n{\nfloat iridescenceIntensity=vIridescenceParams.x;\nfloat iridescenceIOR=vIridescenceParams.y;\nfloat iridescenceThicknessMin=vIridescenceParams.z;\nfloat iridescenceThicknessMax=vIridescenceParams.w;\nfloat iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE\niridescenceThicknessWeight=iridescenceMapData.g;\n#endif\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);\nfloat topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);\nviewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);\noutParams.iridescenceIntensity=iridescenceIntensity;\noutParams.iridescenceThickness=iridescenceThickness;\noutParams.iridescenceIOR=iridescenceIOR;\n}\n#endif\n";Z.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{\nvec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;\nvec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;\nfloat translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\nvec4 thicknessMap;\nvec4 environmentRefraction;\nvec3 refractionTransmittance;\n#endif\n};\n#ifdef SUBSURFACE\n#define pbr_inline\n#define inline\nvoid subSurfaceBlock(\nin vec3 vSubSurfaceIntensity,\nin vec2 vThicknessParam,\nin vec4 vTintColor,\nin vec3 normalW,\nin vec3 specularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nin vec4 thicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nin vec4 refractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nin vec4 translucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nin mat4 reflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin vec3 irradianceVector_,\n#endif\n#if defined(REALTIME_FILTERING)\nin samplerCube reflectionSampler,\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nin vec3 surfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nin vec3 vPositionW,\nin vec3 viewDirectionW,\nin mat4 view,\nin vec4 vRefractionInfos,\nin mat4 refractionMatrix,\nin vec4 vRefractionMicrosurfaceInfos,\nin vec4 vLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nin float alpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nin float NdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nin float roughness,\n#endif\nin float alphaG,\n#ifdef SS_REFRACTIONMAP_3D\nin samplerCube refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin samplerCube refractionSamplerLow,\nin samplerCube refractionSamplerHigh,\n#endif\n#else\nin sampler2D refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin sampler2D refractionSamplerLow,\nin sampler2D refractionSamplerHigh,\n#endif\n#endif\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nin vec3 refractionPosition,\nin vec3 refractionSize,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nin vec3 vDiffusionDistance,\n#endif\nout subSurfaceOutParams outParams\n)\n{\noutParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);\noutParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#if defined(SS_USE_GLTF_TEXTURES)\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#ifdef SS_MASK_FROM_THICKNESS_TEXTURE\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)\n#if defined(SS_USE_GLTF_TEXTURES)\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);\nvec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);\ntransmittance*=translucencyIntensity;\noutParams.transmittance=transmittance;\noutParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;\nrefractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;\nrefractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;\nrefractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);\nif (lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n} else {\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);\nvec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);\nenvironmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\noutParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\n}\n#endif\n";Z.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n";Z.IncludesShadersStore.bumpFragment="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;\nmat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);\nvec2 detailNormalRG=detailColor.wy*2.0-1.0;\nfloat detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));\nvec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;\nvec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;\nbumpNormal+=vec3(0.0,0.0,1.0);\ndetailNormal*=vec3(-1.0,-1.0,1.0);\nvec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;\nnormalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";Z.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n";Z.IncludesShadersStore.depthPrePass="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif\n";Z.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";Z.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);\nfloat NdotV=absEps(NdotVUnclamped);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";Z.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);\nvec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nspecularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";Z.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";Z.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;\nlightingInfo info;\nfloat shadow=1.; \n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n";Z.IncludesShadersStore.pbrBlockFinalLitComponents="#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);\nfinalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;\nfinalIrradiance*=vLightingIntensity.z;\nfinalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;\nfinalRadiance*=subSurfaceOut.specularEnvironmentReflectance;\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;\nfinalSheen=max(finalSheen,0.0);\nvec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;\nfinalClearCoat=max(finalClearCoat,0.0);\nvec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";Z.IncludesShadersStore.pbrBlockFinalUnlitComponents="vec3 finalDiffuse=diffuseBase;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\nfinalDiffuse*=vLightingIntensity.x;\nvec3 finalAmbient=vAmbientColor;\nfinalAmbient*=surfaceAlbedo.rgb;\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;\nfinalDiffuse*=ambientOcclusionForDirectDiffuse;\n";Z.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n";Z.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n";Z.IncludesShadersStore.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";Z.IncludesShadersStore.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));\nvec2 full=unpackHalf2x16(halfFloat);\nfragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);\nvec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;\nvec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);\ndepth.rg=vec2(-MAX_DEPTH);\nfrontColor=lastFrontColor;\nbackColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;\nfloat nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;\nfloat furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;\n}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);\nreturn;\n}\n#endif\n";Z.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\nreturn;\n}\n#endif\n";Z.ShadersStore.pbrPixelShader="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityBlock(\nvAlbedoColor,\n#ifdef ALBEDO\nalbedoTexture,\nvAlbedoInfos,\n#endif\n#ifdef OPACITY\nopacityMap,\nvOpacityInfos,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\n#ifdef DECAL\ndecalColor,\nvDecalInfos,\n#endif\nalbedoOpacityOut\n);\nvec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;\nfloat alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\nambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos,\n#endif\naoOut\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\nvec3 baseColor=surfaceAlbedo;\nreflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nvec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityBlock(\nvReflectivityColor,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo,\nmetallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nvReflectivityInfos,\nsurfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor,\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurfaceTexel,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nreflectivityOut\n);\nfloat microSurface=reflectivityOut.microSurface;\nfloat roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;\nalphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface,\nalphaFresnelOut\n);\nalpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicBlock(\nvAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW,\nanisotropicOut\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionBlock(\nvPositionW,\nnormalW,\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\nreflectionSampler,\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nvEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nreflectionOut\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenBlock(\nvSheenColor,\n#ifdef SHEEN_ROUGHNESS\nvSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nsheenMapRoughnessData,\n#endif\n#endif\nroughness,\n#ifdef SHEEN_TEXTURE\nsheenMapData,\nvSheenInfos.y,\n#endif\nreflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nbaseColor,\nsurfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nNdotV,\nenvironmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nAARoughnessFactors,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\nreflectionOut.reflectionCoords,\nNdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nseo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\neho,\n#endif\n#endif\nsheenOut\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceBlock(\nvIridescenceParams,\nNdotV,\nspecularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\niridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\niridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nNdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#endif\niridescenceOut\n);\nfloat iridescenceIntensity=iridescenceOut.iridescenceIntensity;\nspecularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatBlock(\nvPositionW,\ngeometricNormalW,\nviewDirectionW,\nvClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatMapRoughnessData,\n#endif\nspecularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nvClearCoatTintParams,\nclearCoatColorAtDistance,\nvClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nvClearCoatBumpInfos,\nclearCoatBumpMapData,\nvClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nvTBN,\n#else\nvClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nnormalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nfaceNormal,\n#endif\n#ifdef REFLECTION\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n(gl_FrontFacing ? 1. : -1.),\n#endif\nclearcoatOut\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\nsubSurfaceBlock(\nvSubSurfaceIntensity,\nvThicknessParam,\nvTintColor,\nnormalW,\nspecularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nrefractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nreflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionOut.irradianceVector,\n#endif\n#if defined(REALTIME_FILTERING)\nreflectionSampler,\nvReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nsurfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nvPositionW,\nviewDirectionW,\nview,\nvRefractionInfos,\nrefractionMatrix,\nvRefractionMicrosurfaceInfos,\nvLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nNdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nroughness,\n#endif\nalphaG,\nrefractionSampler,\n#ifndef LODBASEDMICROSFURACE\nrefractionSamplerLow,\nrefractionSamplerHigh,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nvRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nvRefractionPosition,\nvRefractionSize,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvDiffusionDistance,\n#endif\nsubSurfaceOut\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\ngl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); \nirradiance/=sqAlbedo;\n#else\ngl_FragData[0]=finalColor; \nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#else\ngl_FragData[0]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);\n} else {\nbackColor+=finalColor;\n}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";Z.IncludesShadersStore.decalVertexDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\nuniform mat4 decalMatrix;\n#endif\n";Z.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;\nuniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;\nuniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;\nuniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;\nuniform mat4 translucencyIntensityMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";Z.IncludesShadersStore.uvAttributeDeclaration="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n";Z.IncludesShadersStore.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nuniform mat4 previousViewProjection;\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n#endif\n#endif\n";Z.IncludesShadersStore.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n";Z.IncludesShadersStore.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n";Z.IncludesShadersStore.prePassVertex="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;\npreviousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n";Z.IncludesShadersStore.uvVariableDeclaration="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n";Z.IncludesShadersStore.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));\n}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));\n}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));\n}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));\n}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{\nv_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));\n}\n#endif\n#endif\n";Z.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n";Z.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n";Z.ShadersStore.pbrVertexShader="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";class $W extends us{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class En extends Js{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new $W,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=En._DefaultIndexOfRefraction,this.indexOfRefraction=En._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=Fe.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const n=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&De.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&De.ClearCoatBumpTextureEnabled&&!n&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&De.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.ClearCoatTextureEnabled?fe.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&De.ClearCoatTextureEnabled?fe.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&De.ClearCoatBumpTextureEnabled?fe.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===En._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&De.ClearCoatTintTextureEnabled?(fe.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,n){var s,a,o,l,c,u,h,d;if(!this._isEnabled)return;const f=n.materialDefines,g=this._material._disableBumpMap,_=this._material._invertNormalMapX,m=this._material._invertNormalMapY,T=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!this._material.isFrozen||!e.isSync){T&&De.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),fe.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&De.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",null!==(a=null===(s=this._texture)||void 0===s?void 0:s.coordinatesIndex)&&void 0!==a?a:0,null!==(l=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==l?l:0,null!==(u=null===(c=this._textureRoughness)||void 0===c?void 0:c.coordinatesIndex)&&void 0!==u?u:0,null!==(d=null===(h=this._textureRoughness)||void 0===h?void 0:h.level)&&void 0!==d?d:0),this._texture&&fe.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!T&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&fe.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&De.ClearCoatTextureEnabled&&!g&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),fe.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",_?1:-1,m?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",_?-1:1,m?-1:1)),this._tintTexture&&De.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),fe.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const v=1-this._indexOfRefraction,A=1+this._indexOfRefraction,S=Math.pow(-v/A,2);e.updateFloat4("vClearCoatRefractionParams",S,1/this._indexOfRefraction,v,A),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&De.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!T&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&De.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&De.ClearCoatBumpTextureEnabled&&!g&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&De.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,n,s;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose(),null===(n=this._bumpTexture)||void 0===n||n.dispose(),null===(s=this._tintTexture)||void 0===s||s.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}En._DefaultIndexOfRefraction=1.5,b([O(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"isEnabled",void 0),b([O()],En.prototype,"intensity",void 0),b([O()],En.prototype,"roughness",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"indexOfRefraction",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"texture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"useRoughnessFromMainTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"textureRoughness",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"remapF0OnInterfaceChange",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"bumpTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"isTintEnabled",void 0),b([cn()],En.prototype,"tintColor",void 0),b([O()],En.prototype,"tintColorAtDistance",void 0),b([O()],En.prototype,"tintThickness",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],En.prototype,"tintTexture",void 0);class KW extends us{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class rr extends Js{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new KW,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=rr._DefaultMinimumThickness,this.maximumThickness=rr._DefaultMaximumThickness,this.indexOfRefraction=rr._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&De.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=null!==this._texture&&this._texture._texture===(null===(i=this._thicknessTexture)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.IridescenceTextureEnabled?fe.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&De.IridescenceTextureEnabled?fe.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,n){var s,a,o,l,c,u,h,d;if(!this._isEnabled)return;const f=n.materialDefines,g=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!this._material.isFrozen||!e.isSync)&&(g&&De.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),fe.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&De.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",null!==(a=null===(s=this._texture)||void 0===s?void 0:s.coordinatesIndex)&&void 0!==a?a:0,null!==(l=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==l?l:0,null!==(u=null===(c=this._thicknessTexture)||void 0===c?void 0:c.coordinatesIndex)&&void 0!==u?u:0,null!==(d=null===(h=this._thicknessTexture)||void 0===h?void 0:h.level)&&void 0!==d?d:0),this._texture&&fe.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!g&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&fe.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&De.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!g&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&De.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._thicknessTexture)||void 0===i||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}rr._DefaultMinimumThickness=100,rr._DefaultMaximumThickness=400,rr._DefaultIndexOfRefraction=1.3,b([O(),ee("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"isEnabled",void 0),b([O()],rr.prototype,"intensity",void 0),b([O()],rr.prototype,"minimumThickness",void 0),b([O()],rr.prototype,"maximumThickness",void 0),b([O()],rr.prototype,"indexOfRefraction",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"texture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"thicknessTexture",void 0);class QW extends us{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Ra extends Js{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new QW,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=Fe.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&De.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&De.SheenTextureEnabled?(fe.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&De.SheenTextureEnabled?fe.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,n){var s,a,o,l,c,u,h,d;if(!this._isEnabled)return;const f=n.materialDefines,g=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!this._material.isFrozen||!e.isSync)&&(g&&De.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),fe.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&De.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",null!==(a=null===(s=this._texture)||void 0===s?void 0:s.coordinatesIndex)&&void 0!==a?a:0,null!==(l=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==l?l:0,null!==(u=null===(c=this._textureRoughness)||void 0===c?void 0:c.coordinatesIndex)&&void 0!==u?u:0,null!==(d=null===(h=this._textureRoughness)||void 0===h?void 0:h.level)&&void 0!==d?d:0),this._texture&&fe.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!g&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&fe.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&De.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!g&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&De.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"isEnabled",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"linkSheenWithAlbedo",void 0),b([O()],Ra.prototype,"intensity",void 0),b([cn()],Ra.prototype,"color",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"texture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"useRoughnessFromMainTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"roughness",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"textureRoughness",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"albedoScaling",void 0);class ZW extends us{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Qi extends Js{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){!this._scene.enableSubSurfaceForPrePass()||e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new ZW,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=Fe.White(),this.tintColorAtDistance=1,this.diffusionDistance=Fe.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&De.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&De.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,void(e.SS_USE_GLTF_TEXTURES=!1);if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,n=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,s=(i||!this._refractionIntensityTexture)&&(n||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&De.ThicknessTextureEnabled&&fe.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&De.RefractionIntensityTextureEnabled&&!s&&fe.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&De.TranslucencyIntensityTextureEnabled&&!s&&fe.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&s,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&s,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&s,this._isRefractionEnabled&&t.texturesEnabled){const a=this._getRefractionTexture(t);a&&De.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=a.isCube,e.SS_GAMMAREFRACTION=a.gammaSpace,e.SS_RGBDREFRACTION=a.isRGBD,e.SS_LINEARSPECULARREFRACTION=a.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=a.invertZ,e.SS_LODINREFRACTIONALPHA=a.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=a.isCube&&a.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,n){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;n.getRenderingMesh().getWorldMatrix().decompose(z.Vector3[0]);const s=Math.max(Math.abs(z.Vector3[0].x),Math.abs(z.Vector3[0].y),Math.abs(z.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*s,(this.maximumThickness-this.minimumThickness)*s)}bindForSubMesh(e,t,i,n){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const s=n.materialDefines,a=this._material.isFrozen,o=this._material.realTimeFiltering,l=s.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!a||!e.isSync){if(this._thicknessTexture&&De.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),fe.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&De.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),fe.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&De.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),fe.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&De.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getReflectionTextureMatrix());let u=1;c.isCube||c.depth&&(u=c.depth);const h=c.getSize().width;if(e.updateFloat4("vRefractionInfos",c.level,1/this.volumeIndexOfRefraction,u,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",h,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",h,Se.Log2(h)),c.boundingBoxSize){const f=c;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&De.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&De.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&De.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),c&&De.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){De.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(De.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"isRefractionEnabled",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"isTranslucencyEnabled",void 0),b([O(),ee("_markScenePrePassDirty")],Qi.prototype,"isScatteringEnabled",void 0),b([O()],Qi.prototype,"_scatteringDiffusionProfileIndex",void 0),b([O()],Qi.prototype,"refractionIntensity",void 0),b([O()],Qi.prototype,"translucencyIntensity",void 0),b([O()],Qi.prototype,"useAlbedoToTintRefraction",void 0),b([O()],Qi.prototype,"useAlbedoToTintTranslucency",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"thicknessTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"refractionTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"indexOfRefraction",void 0),b([O()],Qi.prototype,"_volumeIndexOfRefraction",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"volumeIndexOfRefraction",null),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"invertRefractionY",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"linkRefractionWithTransparency",void 0),b([O()],Qi.prototype,"minimumThickness",void 0),b([O()],Qi.prototype,"maximumThickness",void 0),b([O()],Qi.prototype,"useThicknessAsDepth",void 0),b([cn()],Qi.prototype,"tintColor",void 0),b([O()],Qi.prototype,"tintColorAtDistance",void 0),b([cn()],Qi.prototype,"diffusionDistance",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"useMaskFromThicknessTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"refractionIntensityTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"translucencyIntensityTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Qi.prototype,"useGltfStyleTextures",void 0);class qW extends us{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class Ho extends Js{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new qW,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=le.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&De.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&De.DetailTextureEnabled&&this._isEnabled?(fe.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){this._isEnabled&&((!e.useUbo||!this._material.isFrozen||!e.isSync)&&this._texture&&De.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),fe.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&De.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture))}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}b([Bt("detailTexture"),ee("_markAllSubMeshesAsTexturesDirty")],Ho.prototype,"texture",void 0),b([O()],Ho.prototype,"diffuseBlendLevel",void 0),b([O()],Ho.prototype,"roughnessBlendLevel",void 0),b([O()],Ho.prototype,"bumpLevel",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ho.prototype,"normalBlendMethod",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ho.prototype,"isEnabled",void 0);const Xc={effect:null,subMesh:null};class YP extends us{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class ri extends vh{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new Qt(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=ri.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=Fe.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new Fe(0,0,0),this._albedoColor=new Fe(1,1,1),this._reflectivityColor=new Fe(1,1,1),this._reflectionColor=new Fe(1,1,1),this._emissiveColor=new Fe(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=ri.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new Qn(16),this._globalAmbientColor=new Fe(0,0,0),this._useLogarithmicDepth=!1,this._unlit=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Zn(this),this.clearCoat=new En(this),this.iridescence=new rr(this),this.anisotropy=new yh(this),this.sheen=new Ra(this),this.subSurface=new Qi(this),this.detailMap=new Ho(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),De.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=ep(this.getScene()),this.prePassConfiguration=new zc}get hasRenderTargetTextures(){return!!(De.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get _disableAlphaBlending(){var e;return this._transparencyMode===ri.PBRMATERIAL_OPAQUE||this._transparencyMode===ri.PBRMATERIAL_ALPHATEST||(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){var e;return!!this._forceAlphaTest||!(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===ri.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==ri.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(In.GetDefineNames,this._eventInfo),t.materialDefines=new YP(this._eventInfo.defineNames));const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const s=this.getScene(),a=s.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s.texturesEnabled)){if(this._albedoTexture&&De.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&De.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&De.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const h=this._getReflectionTexture();if(h&&De.ReflectionTextureEnabled&&(!h.isReadyOrNotBlocking()||h.irradianceTexture&&!h.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&De.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&De.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(De.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(a.getCaps().standardDerivatives&&this._bumpTexture&&De.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&De.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!a.getCaps().standardDerivatives&&!e.isVerticesDataPresent(I.NormalKind)&&(e.createNormals(!0),H.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const o=t.effect,l=n._areLightsDisposed;let c=this._prepareEffect(e,n,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),u=!1;if(c)if(this._onEffectCreatedObservable&&(Xc.effect=c,Xc.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Xc)),this.allowShaderHotSwapping&&o&&!c.isReady()){if(c=o,n.markAsUnprocessed(),u=this.isFrozen,l)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(c,n,this._materialContext);return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!u,t.effect._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i=null,n=null,s=null,a=null,o){if(this._prepareDefines(e,t,s,a,o),!t.isDirty)return null;t.markAsProcessed();const c=this.getScene().getEngine(),u=new xl;let h=0;t.USESPHERICALINVERTEX&&u.addFallback(h++,"USESPHERICALINVERTEX"),t.FOG&&u.addFallback(h,"FOG"),t.SPECULARAA&&u.addFallback(h,"SPECULARAA"),t.POINTSIZE&&u.addFallback(h,"POINTSIZE"),t.LOGARITHMICDEPTH&&u.addFallback(h,"LOGARITHMICDEPTH"),t.PARALLAX&&u.addFallback(h,"PARALLAX"),t.PARALLAXOCCLUSION&&u.addFallback(h++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&u.addFallback(h++,"ENVIRONMENTBRDF"),t.TANGENT&&u.addFallback(h++,"TANGENT"),t.BUMP&&u.addFallback(h++,"BUMP"),h=fe.HandleFallbacksForShadows(t,u,this._maxSimultaneousLights,h++),t.SPECULARTERM&&u.addFallback(h++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&u.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&u.addFallback(h++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&u.addFallback(h++,"LIGHTMAP"),t.NORMAL&&u.addFallback(h++,"NORMAL"),t.AMBIENT&&u.addFallback(h++,"AMBIENT"),t.EMISSIVE&&u.addFallback(h++,"EMISSIVE"),t.VERTEXCOLOR&&u.addFallback(h++,"VERTEXCOLOR"),t.MORPHTARGETS&&u.addFallback(h++,"MORPHTARGETS"),t.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const d=[I.PositionKind];t.NORMAL&&d.push(I.NormalKind),t.TANGENT&&d.push(I.TangentKind);for(let A=1;A<=6;++A)t["UV"+A]&&d.push(`uv${1===A?"":A}`);t.VERTEXCOLOR&&d.push(I.ColorKind),t.INSTANCESCOLOR&&d.push(I.ColorInstanceKind),fe.PrepareAttributesForBones(d,e,t,u),fe.PrepareAttributesForInstances(d,t),fe.PrepareAttributesForMorphTargets(d,e,t),fe.PrepareAttributesForBakedVertexAnimation(d,e,t);let f="pbr";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],g=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"];this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=h,this._eventInfo.defines=t,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(In.PrepareEffect,this._eventInfo),zc.AddUniforms(p),zc.AddSamplers(g),Sl(p),Wt&&(Wt.PrepareUniforms(p,t),Wt.PrepareSamplers(g,t)),fe.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:_,samplers:g,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const m={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,_,g,t,d,m));const T=t.toString(),v=c.createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:_,samplers:g,defines:T,fallbacks:u,onCompiled:i,onError:n,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS},processFinalCode:m.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},c);return this._eventInfo.customCode=void 0,v}_prepareDefines(e,t,i=null,n=null,s=!1){var a;const o=this.getScene(),l=o.getEngine();fe.PrepareDefinesForLights(o,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,fe.PrepareDefinesForMultiview(o,t);const c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(fe.PrepareDefinesForPrePass(o,t,this.canRenderToMRT&&!c),fe.PrepareDefinesForOIT(o,t,c),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let u=1;u<=6;++u)t["MAINUV"+u]=!1;if(o.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&De.DiffuseTextureEnabled?(fe.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&De.AmbientTextureEnabled?(fe.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&De.OpacityTextureEnabled?(fe.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const u=this._getReflectionTexture();if(u&&De.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=u.gammaSpace,t.RGBDREFLECTION=u.isRGBD,t.LODINREFLECTIONALPHA=u.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=u.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=u.coordinatesMode===j.INVCUBIC_MODE,t.REFLECTIONMAP_3D=u.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!u.invertZ:u.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,u.coordinatesMode){case j.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case j.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case j.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case j.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case j.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case j.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case j.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case j.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!u.boundingBoxSize}u.coordinatesMode!==j.SKYBOX_MODE&&(u.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):u.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!(this._forceIrradianceInFragment||this.realTimeFiltering||l.getCaps().maxVaryingVectors<=8)))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&De.LightmapTextureEnabled?(fe.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&De.EmissiveTextureEnabled?(fe.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,De.SpecularTextureEnabled){if(this._metallicTexture?(fe.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(fe.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const h=null!==this._metallicReflectanceTexture&&this._metallicReflectanceTexture._texture===(null===(a=this._reflectanceTexture)||void 0===a?void 0:a._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!h,this._metallicReflectanceTexture?(fe.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!h&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(fe.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?fe.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&De.BumpTextureEnabled&&!this._disableBumpMap?(fe.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&De.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&De.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),t.ALPHAFROMALBEDO=!!this._shouldUseAlphaFromAlbedoTexture()}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===ri.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===ri.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,t.TWOSIDEDLIGHTING=!(this.backFaceCulling||!this._twoSidedLighting),t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(fe.PrepareDefinesForMisc(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(I.NormalKind),t.DEBUGMODE=this._debugMode),fe.PrepareDefinesForFrameBoundValues(o,l,this,t,!!i,n,s),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),fe.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==ri.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const n=Mi({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(In.GetDefineNames,this._eventInfo);const s=new YP(this._eventInfo.defineNames),a=this._prepareEffect(e,s,void 0,void 0,n.useInstances,n.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Xc.effect=a,Xc.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Xc)),a.isReady()?t&&t(this):a.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var n,s,a,o;const l=this.getScene(),c=i.materialDefines;if(!c)return;const u=i.effect;if(!u)return;this._activeEffect=u,t.getMeshUniformBuffer().bindToEffect(u,"Mesh"),t.transferToEffect(e);const h=l.getEngine();this._uniformBuffer.bindToEffect(u,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),c.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=u._forceRebindOnNextCall||this._mustRebind(l,u,t.visibility);fe.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let f=null;const p=this._uniformBuffer;if(d){if(this.bindViewProjection(u),f=this._getReflectionTexture(),!p.useUbo||!this.isFrozen||!p.isSync||u._forceRebindOnNextCall){if(l.texturesEnabled){if(this._albedoTexture&&De.DiffuseTextureEnabled&&(p.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),fe.BindTextureMatrix(this._albedoTexture,p,"albedo")),this._ambientTexture&&De.AmbientTextureEnabled&&(p.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),fe.BindTextureMatrix(this._ambientTexture,p,"ambient")),this._opacityTexture&&De.OpacityTextureEnabled&&(p.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),fe.BindTextureMatrix(this._opacityTexture,p,"opacity")),f&&De.ReflectionTextureEnabled){if(p.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),p.updateFloat2("vReflectionInfos",f.level,0),f.boundingBoxSize){const g=f;p.updateVector3("vReflectionPosition",g.boundingBoxPosition),p.updateVector3("vReflectionSize",g.boundingBoxSize)}if(this.realTimeFiltering){const g=f.getSize().width;p.updateFloat2("vReflectionFilteringInfo",g,Se.Log2(g))}if(!c.USEIRRADIANCEMAP){const g=f.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&g)if(c.SPHERICAL_HARMONICS){const _=g.preScaledHarmonics;p.updateVector3("vSphericalL00",_.l00),p.updateVector3("vSphericalL1_1",_.l1_1),p.updateVector3("vSphericalL10",_.l10),p.updateVector3("vSphericalL11",_.l11),p.updateVector3("vSphericalL2_2",_.l2_2),p.updateVector3("vSphericalL2_1",_.l2_1),p.updateVector3("vSphericalL20",_.l20),p.updateVector3("vSphericalL21",_.l21),p.updateVector3("vSphericalL22",_.l22)}else p.updateFloat3("vSphericalX",g.x.x,g.x.y,g.x.z),p.updateFloat3("vSphericalY",g.y.x,g.y.y,g.y.z),p.updateFloat3("vSphericalZ",g.z.x,g.z.y,g.z.z),p.updateFloat3("vSphericalXX_ZZ",g.xx.x-g.zz.x,g.xx.y-g.zz.y,g.xx.z-g.zz.z),p.updateFloat3("vSphericalYY_ZZ",g.yy.x-g.zz.x,g.yy.y-g.zz.y,g.yy.z-g.zz.z),p.updateFloat3("vSphericalZZ",g.zz.x,g.zz.y,g.zz.z),p.updateFloat3("vSphericalXY",g.xy.x,g.xy.y,g.xy.z),p.updateFloat3("vSphericalYZ",g.yz.x,g.yz.y,g.yz.z),p.updateFloat3("vSphericalZX",g.zx.x,g.zx.y,g.zx.z)}p.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&De.EmissiveTextureEnabled&&(p.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),fe.BindTextureMatrix(this._emissiveTexture,p,"emissive")),this._lightmapTexture&&De.LightmapTextureEnabled&&(p.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),fe.BindTextureMatrix(this._lightmapTexture,p,"lightmap")),De.SpecularTextureEnabled&&(this._metallicTexture?(p.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),fe.BindTextureMatrix(this._metallicTexture,p,"reflectivity")):this._reflectivityTexture&&(p.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),fe.BindTextureMatrix(this._reflectivityTexture,p,"reflectivity")),this._metallicReflectanceTexture&&(p.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),fe.BindTextureMatrix(this._metallicReflectanceTexture,p,"metallicReflectance")),this._reflectanceTexture&&c.REFLECTANCE&&(p.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),fe.BindTextureMatrix(this._reflectanceTexture,p,"reflectance")),this._microSurfaceTexture&&(p.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),fe.BindTextureMatrix(this._microSurfaceTexture,p,"microSurfaceSampler"))),this._bumpTexture&&h.getCaps().standardDerivatives&&De.BumpTextureEnabled&&!this._disableBumpMap&&(p.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),fe.BindTextureMatrix(this._bumpTexture,p,"bump"),l._mirroredCameraPosition?p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&p.updateFloat("pointSize",this.pointSize),c.METALLICWORKFLOW){ei.Color3[0].r=null==this._metallic?1:this._metallic,ei.Color3[0].g=null==this._roughness?1:this._roughness,p.updateColor4("vReflectivityColor",ei.Color3[0],1);const g=null!==(s=null===(n=this.subSurface)||void 0===n?void 0:n._indexOfRefraction)&&void 0!==s?s:1.5,_=1,m=Math.pow((g-_)/(g+_),2);this._metallicReflectanceColor.scaleToRef(m*this._metallicF0Factor,ei.Color3[0]),p.updateColor4("vMetallicReflectanceFactors",ei.Color3[0],this._metallicF0Factor)}else p.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);p.updateColor3("vEmissiveColor",De.EmissiveTextureEnabled?this._emissiveColor:Fe.BlackReadOnly),p.updateColor3("vReflectionColor",this._reflectionColor),!c.SS_REFRACTION&&(null===(a=this.subSurface)||void 0===a?void 0:a._linkRefractionWithTransparency)?p.updateColor4("vAlbedoColor",this._albedoColor,1):p.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,p.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),p.updateColor3("vAmbientColor",this._globalAmbientColor),p.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}l.texturesEnabled&&(this._albedoTexture&&De.DiffuseTextureEnabled&&p.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&De.AmbientTextureEnabled&&p.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&De.OpacityTextureEnabled&&p.setTexture("opacitySampler",this._opacityTexture),f&&De.ReflectionTextureEnabled&&(c.LODBASEDMICROSFURACE?p.setTexture("reflectionSampler",f):(p.setTexture("reflectionSampler",f._lodTextureMid||f),p.setTexture("reflectionSamplerLow",f._lodTextureLow||f),p.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),c.USEIRRADIANCEMAP&&p.setTexture("irradianceSampler",f.irradianceTexture)),c.ENVIRONMENTBRDF&&p.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&De.EmissiveTextureEnabled&&p.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&De.LightmapTextureEnabled&&p.setTexture("lightmapSampler",this._lightmapTexture),De.SpecularTextureEnabled&&(this._metallicTexture?p.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&p.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&p.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&c.REFLECTANCE&&p.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&p.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&h.getCaps().standardDerivatives&&De.BumpTextureEnabled&&!this._disableBumpMap&&p.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(u),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Uo(this._activeEffect,this,l),this.bindEyePosition(u)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(d||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&fe.BindLights(l,t,this._activeEffect,c,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==dt.FOGMODE_NONE||f||t.receiveShadows||c.PREPASS)&&this.bindView(u),fe.BindFogParameters(l,t,this._activeEffect,!0),c.NUM_MORPH_INFLUENCERS&&fe.BindMorphTargetParameters(t,this._activeEffect),c.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(o=t.bakedVertexAnimationManager)||void 0===o||o.bind(u,c.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),fe.BindLogDepth(c,this._activeEffect,l)),this._afterBind(t,this._activeEffect),p.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!(!super.hasTexture(e)&&this._albedoTexture!==e&&this._ambientTexture!==e&&this._opacityTexture!==e&&this._reflectionTexture!==e&&this._emissiveTexture!==e&&this._reflectivityTexture!==e&&this._metallicTexture!==e&&this._metallicReflectanceTexture!==e&&this._reflectanceTexture!==e&&this._microSurfaceTexture!==e&&this._bumpTexture!==e&&this._lightmapTexture!==e)}setPrePassRenderer(){var e;if(!(null===(e=this.subSurface)||void 0===e?void 0:e.isScatteringEnabled))return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,n,s,a,o,l,c,u,h,d,f,p;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),null===(i=this._albedoTexture)||void 0===i||i.dispose(),null===(n=this._ambientTexture)||void 0===n||n.dispose(),null===(s=this._opacityTexture)||void 0===s||s.dispose(),null===(a=this._reflectionTexture)||void 0===a||a.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(l=this._metallicTexture)||void 0===l||l.dispose(),null===(c=this._reflectivityTexture)||void 0===c||c.dispose(),null===(u=this._bumpTexture)||void 0===u||u.dispose(),null===(h=this._lightmapTexture)||void 0===h||h.dispose(),null===(d=this._metallicReflectanceTexture)||void 0===d||d.dispose(),null===(f=this._reflectanceTexture)||void 0===f||f.dispose(),null===(p=this._microSurfaceTexture)||void 0===p||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}ri.PBRMATERIAL_OPAQUE=le.MATERIAL_OPAQUE,ri.PBRMATERIAL_ALPHATEST=le.MATERIAL_ALPHATEST,ri.PBRMATERIAL_ALPHABLEND=le.MATERIAL_ALPHABLEND,ri.PBRMATERIAL_ALPHATESTANDBLEND=le.MATERIAL_ALPHATESTANDBLEND,ri.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,ri.LIGHTFALLOFF_PHYSICAL=0,ri.LIGHTFALLOFF_GLTF=1,ri.LIGHTFALLOFF_STANDARD=2,b([Ub()],ri.prototype,"_imageProcessingConfiguration",void 0),b([ee("_markAllSubMeshesAsMiscDirty")],ri.prototype,"debugMode",void 0),b([O()],ri.prototype,"useLogarithmicDepth",null);class _r extends ri{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new Fe(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}b([O(),ee("_markAllSubMeshesAsLightsDirty")],_r.prototype,"maxSimultaneousLights",void 0),b([O(),ee("_markAllSubMeshesAsLightsDirty")],_r.prototype,"disableLighting",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],_r.prototype,"environmentTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],_r.prototype,"invertNormalMapX",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],_r.prototype,"invertNormalMapY",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],_r.prototype,"normalTexture",void 0),b([cn("emissive"),ee("_markAllSubMeshesAsTexturesDirty")],_r.prototype,"emissiveColor",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],_r.prototype,"emissiveTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],_r.prototype,"occlusionStrength",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],_r.prototype,"occlusionTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],_r.prototype,"alphaCutOff",void 0),b([O()],_r.prototype,"doubleSided",null),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty",null)],_r.prototype,"lightmapTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],_r.prototype,"useLightmapAsShadowmap",void 0);class at extends ri{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===ri.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?ri.LIGHTFALLOFF_PHYSICAL:ri.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===ri.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?ri.LIGHTFALLOFF_GLTF:ri.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=at.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=Fe.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new Fe(0,0,0),this.albedoColor=new Fe(1,1,1),this.reflectivityColor=new Fe(1,1,1),this.reflectionColor=new Fe(1,1,1),this.emissiveColor=new Fe(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this._environmentBRDFTexture=ep(this.getScene())}getClassName(){return"PBRMaterial"}clone(e){const t=lt.Clone(()=>new at(e,this.getScene()),this);return t.id=e,t.name=e,this.stencil.copyTo(t.stencil),this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),this.iridescence.copyTo(t.iridescence),t}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const n=lt.Parse(()=>new at(e.name,t),e,t,i);return e.stencil&&n.stencil.parse(e.stencil,t,i),e.clearCoat&&n.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&n.anisotropy.parse(e.anisotropy,t,i),e.brdf&&n.brdf.parse(e.brdf,t,i),e.sheen&&n.sheen.parse(e.sheen,t,i),e.subSurface&&n.subSurface.parse(e.subSurface,t,i),e.iridescence&&n.iridescence.parse(e.iridescence,t,i),n}}at.PBRMATERIAL_OPAQUE=ri.PBRMATERIAL_OPAQUE,at.PBRMATERIAL_ALPHATEST=ri.PBRMATERIAL_ALPHATEST,at.PBRMATERIAL_ALPHABLEND=ri.PBRMATERIAL_ALPHABLEND,at.PBRMATERIAL_ALPHATESTANDBLEND=ri.PBRMATERIAL_ALPHATESTANDBLEND,at.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=ri.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"directIntensity",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"emissiveIntensity",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"environmentIntensity",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"specularIntensity",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"disableBumpMap",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"albedoTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientTextureStrength",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"opacityTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectionTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"emissiveTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectivityTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallic",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"roughness",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicF0Factor",void 0),b([cn(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicReflectanceColor",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicReflectanceTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectanceTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"microSurfaceTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"bumpTexture",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty",null)],at.prototype,"lightmapTexture",void 0),b([cn("ambient"),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientColor",void 0),b([cn("albedo"),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"albedoColor",void 0),b([cn("reflectivity"),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectivityColor",void 0),b([cn("reflection"),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectionColor",void 0),b([cn("emissive"),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"emissiveColor",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"microSurface",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useLightmapAsShadowmap",void 0),b([O(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"useAlphaFromAlbedoTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"forceAlphaTest",void 0),b([O(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"alphaCutOff",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useSpecularOverAlpha",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRoughnessFromMetallicTextureGreen",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useMetallnessFromMetallicTextureBlue",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAmbientInGrayScale",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),b([O()],at.prototype,"usePhysicalLightFalloff",null),b([O()],at.prototype,"useGLTFLightFalloff",null),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRadianceOverAlpha",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useObjectSpaceNormalMap",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useParallax",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useParallaxOcclusion",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"parallaxScaleBias",void 0),b([O(),ee("_markAllSubMeshesAsLightsDirty")],at.prototype,"disableLighting",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"forceIrradianceInFragment",void 0),b([O(),ee("_markAllSubMeshesAsLightsDirty")],at.prototype,"maxSimultaneousLights",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"invertNormalMapX",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"invertNormalMapY",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"twoSidedLighting",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAlphaFresnel",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useLinearAlphaFresnel",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"environmentBRDFTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"forceNormalForward",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"enableSpecularAntiAliasing",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useHorizonOcclusion",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRadianceOcclusion",void 0),b([O(),ee("_markAllSubMeshesAsMiscDirty")],at.prototype,"unlit",void 0),ye("BABYLON.PBRMaterial",at);class Ma extends _r{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=lt.Clone(()=>new Ma(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=lt.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const n=lt.Parse(()=>new Ma(e.name,t),e,t,i);return e.clearCoat&&n.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&n.anisotropy.parse(e.anisotropy,t,i),e.brdf&&n.brdf.parse(e.brdf,t,i),e.sheen&&n.sheen.parse(e.sheen,t,i),e.subSurface&&n.subSurface.parse(e.subSurface,t,i),e.iridescence&&n.iridescence.parse(e.iridescence,t,i),n}}b([cn(),ee("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Ma.prototype,"baseColor",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Ma.prototype,"baseTexture",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ma.prototype,"metallic",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],Ma.prototype,"roughness",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],Ma.prototype,"metallicRoughnessTexture",void 0),ye("BABYLON.PBRMetallicRoughnessMaterial",Ma);class no extends _r{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=lt.Clone(()=>new no(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=lt.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const n=lt.Parse(()=>new no(e.name,t),e,t,i);return e.clearCoat&&n.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&n.anisotropy.parse(e.anisotropy,t,i),e.brdf&&n.brdf.parse(e.brdf,t,i),e.sheen&&n.sheen.parse(e.sheen,t,i),e.subSurface&&n.subSurface.parse(e.subSurface,t,i),e.iridescence&&n.iridescence.parse(e.iridescence,t,i),n}}b([cn("diffuse"),ee("_markAllSubMeshesAsTexturesDirty","_albedoColor")],no.prototype,"diffuseColor",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],no.prototype,"diffuseTexture",void 0),b([cn("specular"),ee("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],no.prototype,"specularColor",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty","_microSurface")],no.prototype,"glossiness",void 0),b([Bt(),ee("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],no.prototype,"specularGlossinessTexture",void 0),ye("BABYLON.PBRSpecularGlossinessMaterial",no);Z.IncludesShadersStore.defaultFragmentDeclaration="uniform vec4 vEyePosition;\nuniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\nuniform vec3 vAmbientColor;\nuniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;\nuniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";Z.IncludesShadersStore.defaultUboDeclaration="layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor;\nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix;\nvec2 vTangentSpaceParams;\nfloat pointSize;\nfloat alphaCutOff;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec3 vRefractionPosition;\nvec3 vRefractionSize;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nvec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";Z.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif\n";Z.ShadersStore.defaultPixelShader="#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#define RECIPROCAL_PI2 0.15915494\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\nfloat alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\nvec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);\nif (dot(refractionVector,viewDirectionW)<1.0) {\nrefractionColor=refractionLookup;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\ngl_FragData[0]=color; \n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULARTERM)\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {\nfrontColor.rgb+=color.rgb*color.a*alphaMultiplier;\nfrontColor.a=1.0-alphaMultiplier*(1.0-color.a);\n} else {\nbackColor+=color;\n}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";Z.IncludesShadersStore.defaultVertexDeclaration="uniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";Z.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";Z.ShadersStore.defaultVertexShader="#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";const $T={effect:null,subMesh:null};class JW extends us{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class Ue extends vh{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new Fe(0,0,0),this.diffuseColor=new Fe(1,1,1),this.specularColor=new Fe(1,1,1),this.emissiveColor=new Fe(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new Qn(16),this._worldViewProjectionMatrix=B.Zero(),this._globalAmbientColor=new Fe(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Ho(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new zc,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Ue.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),Ue.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!(Ue.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||Ue.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===le.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==le.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(In.GetDefineNames,this._eventInfo),t.materialDefines=new JW(this._eventInfo.defineNames));const n=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=n.getEngine();s._needNormals=fe.PrepareDefinesForLights(n,e,s,!0,this._maxSimultaneousLights,this._disableLighting),fe.PrepareDefinesForMultiview(n,s);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(fe.PrepareDefinesForPrePass(n,s,this.canRenderToMRT&&!o),fe.PrepareDefinesForOIT(n,s,o),s._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s._needUVs=!1;for(let c=1;c<=6;++c)s["MAINUV"+c]=!1;if(n.texturesEnabled){if(s.DIFFUSEDIRECTUV=0,s.BUMPDIRECTUV=0,s.AMBIENTDIRECTUV=0,s.OPACITYDIRECTUV=0,s.EMISSIVEDIRECTUV=0,s.SPECULARDIRECTUV=0,s.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&Ue.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._diffuseTexture,s,"DIFFUSE")}else s.DIFFUSE=!1;if(this._ambientTexture&&Ue.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._ambientTexture,s,"AMBIENT")}else s.AMBIENT=!1;if(this._opacityTexture&&Ue.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._opacityTexture,s,"OPACITY"),s.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else s.OPACITY=!1;if(this._reflectionTexture&&Ue.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(s._needNormals=!0,s.REFLECTION=!0,s.ROUGHNESS=this._roughness>0,s.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,s.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===j.INVCUBIC_MODE,s.REFLECTIONMAP_3D=this._reflectionTexture.isCube,s.REFLECTIONMAP_OPPOSITEZ=s.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,s.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case j.EXPLICIT_MODE:s.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case j.PLANAR_MODE:s.setReflectionMode("REFLECTIONMAP_PLANAR");break;case j.PROJECTION_MODE:s.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case j.SKYBOX_MODE:s.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case j.SPHERICAL_MODE:s.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case j.EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case j.FIXED_EQUIRECTANGULAR_MODE:s.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case j.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:s.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;default:s.setReflectionMode("REFLECTIONMAP_CUBIC")}s.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else s.REFLECTION=!1,s.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&Ue.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._emissiveTexture,s,"EMISSIVE")}else s.EMISSIVE=!1;if(this._lightmapTexture&&Ue.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._lightmapTexture,s,"LIGHTMAP"),s.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,s.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else s.LIGHTMAP=!1;if(this._specularTexture&&Ue.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;fe.PrepareDefinesForMergedUV(this._specularTexture,s,"SPECULAR"),s.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else s.SPECULAR=!1;if(n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&Ue.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;fe.PrepareDefinesForMergedUV(this._bumpTexture,s,"BUMP"),s.PARALLAX=this._useParallax,s.PARALLAXOCCLUSION=this._useParallaxOcclusion,s.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else s.BUMP=!1,s.PARALLAX=!1,s.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&Ue.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;s._needUVs=!0,s.REFRACTION=!0,s.REFRACTIONMAP_3D=this._refractionTexture.isCube,s.RGBDREFRACTION=this._refractionTexture.isRGBD,s.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else s.REFRACTION=!1;s.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else s.DIFFUSE=!1,s.AMBIENT=!1,s.OPACITY=!1,s.REFLECTION=!1,s.EMISSIVE=!1,s.LIGHTMAP=!1,s.BUMP=!1,s.REFRACTION=!1;s.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),s.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,s.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,s.SPECULAROVERALPHA=this._useSpecularOverAlpha,s.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,s.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,s.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(s._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(s),s.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,s.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}s._areFresnelDirty&&(Ue.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(s.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,s.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,s.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,s.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,s.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,s.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,s._needNormals=!0,s.FRESNEL=!0):s.FRESNEL=!1),fe.PrepareDefinesForMisc(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,s),fe.PrepareDefinesForFrameBoundValues(n,a,this,s,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=s,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),fe.PrepareDefinesForAttributes(e,s,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let l=!1;if(s.isDirty){const c=s._areLightsDisposed;s.markAsProcessed();const u=new xl;s.REFLECTION&&u.addFallback(0,"REFLECTION"),s.SPECULAR&&u.addFallback(0,"SPECULAR"),s.BUMP&&u.addFallback(0,"BUMP"),s.PARALLAX&&u.addFallback(1,"PARALLAX"),s.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION"),s.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA"),s.FOG&&u.addFallback(1,"FOG"),s.POINTSIZE&&u.addFallback(0,"POINTSIZE"),s.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH"),fe.HandleFallbacksForShadows(s,u,this._maxSimultaneousLights),s.SPECULARTERM&&u.addFallback(0,"SPECULARTERM"),s.DIFFUSEFRESNEL&&u.addFallback(1,"DIFFUSEFRESNEL"),s.OPACITYFRESNEL&&u.addFallback(2,"OPACITYFRESNEL"),s.REFLECTIONFRESNEL&&u.addFallback(3,"REFLECTIONFRESNEL"),s.EMISSIVEFRESNEL&&u.addFallback(4,"EMISSIVEFRESNEL"),s.FRESNEL&&u.addFallback(4,"FRESNEL"),s.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const h=[I.PositionKind];s.NORMAL&&h.push(I.NormalKind),s.TANGENT&&h.push(I.TangentKind);for(let A=1;A<=6;++A)s["UV"+A]&&h.push(`uv${1===A?"":A}`);s.VERTEXCOLOR&&h.push(I.ColorKind),fe.PrepareAttributesForBones(h,e,s,u),fe.PrepareAttributesForInstances(h,s),fe.PrepareAttributesForMorphTargets(h,e,s),fe.PrepareAttributesForBakedVertexAnimation(h,e,s);let d="default";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],p=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"];this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=0,this._eventInfo.defines=s,this._eventInfo.uniforms=f,this._eventInfo.attributes=h,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(In.PrepareEffect,this._eventInfo),zc.AddUniforms(f),zc.AddSamplers(p),Wt&&(Wt.PrepareUniforms(f,s),Wt.PrepareSamplers(p,s)),fe.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:g,samplers:p,defines:s,maxSimultaneousLights:this._maxSimultaneousLights}),Sl(f);const _={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,f,g,p,s,h,_));const m=s.toString(),T=t.effect;let v=n.getEngine().createEffect(d,{attributes:h,uniformsNames:f,uniformBuffersNames:g,samplers:p,defines:m,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS},processFinalCode:_.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:s.PREPASS},a);if(this._eventInfo.customCode=void 0,v)if(this._onEffectCreatedObservable&&($T.effect=v,$T.subMesh=t,this._onEffectCreatedObservable.notifyObservers($T)),this.allowShaderHotSwapping&&T&&!v.isReady()){if(v=T,s.markAsUnprocessed(),l=this.isFrozen,c)return s._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(v,s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!l,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var n;const s=this.getScene(),a=i.materialDefines;if(!a)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),a.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=o._forceRebindOnNextCall||this._mustRebind(s,o,t.visibility);fe.BindBonesParameters(t,o);const c=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!c.useUbo||!this.isFrozen||!c.isSync||o._forceRebindOnNextCall){if(Ue.FresnelEnabled&&a.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new Fe(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&Ue.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),fe.BindTextureMatrix(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&Ue.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),fe.BindTextureMatrix(this._ambientTexture,c,"ambient")),this._opacityTexture&&Ue.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),fe.BindTextureMatrix(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&Ue.ReflectionTextureEnabled&&(c.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),c.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const u=this._reflectionTexture;c.updateVector3("vReflectionPosition",u.boundingBoxPosition),c.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this._emissiveTexture&&Ue.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),fe.BindTextureMatrix(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&Ue.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),fe.BindTextureMatrix(this._lightmapTexture,c,"lightmap")),this._specularTexture&&Ue.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),fe.BindTextureMatrix(this._specularTexture,c,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Ue.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),fe.BindTextureMatrix(this._bumpTexture,c,"bump"),s._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&Ue.RefractionTextureEnabled){let u=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(u=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const h=this._refractionTexture;c.updateVector3("vRefractionPosition",h.boundingBoxPosition),c.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),a.SPECULARTERM&&c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",Ue.EmissiveTextureEnabled?this.emissiveColor:Fe.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}s.texturesEnabled&&(this._diffuseTexture&&Ue.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&Ue.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Ue.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&Ue.ReflectionTextureEnabled&&o.setTexture(this._reflectionTexture.isCube?"reflectionCubeSampler":"reflection2DSampler",this._reflectionTexture),this._emissiveTexture&&Ue.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Ue.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&Ue.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Ue.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&Ue.RefractionTextureEnabled&&o.setTexture(this._refractionTexture.isCube?"refractionCubeSampler":"refraction2DSampler",this._refractionTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Uo(o,this,s),this.bindEyePosition(o)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(s.lightsEnabled&&!this._disableLighting&&fe.BindLights(s,t,o,a,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==dt.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||a.PREPASS)&&this.bindView(o),fe.BindFogParameters(s,t,o),a.NUM_MORPH_INFLUENCERS&&fe.BindMorphTargetParameters(t,o),a.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(n=t.bakedVertexAnimationManager)||void 0===n||n.bind(o,a.INSTANCES)),this.useLogarithmicDepth&&fe.BindLogDepth(a,o,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),c.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!(!super.hasTexture(e)&&this._diffuseTexture!==e&&this._ambientTexture!==e&&this._opacityTexture!==e&&this._reflectionTexture!==e&&this._emissiveTexture!==e&&this._specularTexture!==e&&this._bumpTexture!==e&&this._lightmapTexture!==e&&this._refractionTexture!==e)}dispose(e,t){var i,n,s,a,o,l,c,u,h;t&&(null===(i=this._diffuseTexture)||void 0===i||i.dispose(),null===(n=this._ambientTexture)||void 0===n||n.dispose(),null===(s=this._opacityTexture)||void 0===s||s.dispose(),null===(a=this._reflectionTexture)||void 0===a||a.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(l=this._specularTexture)||void 0===l||l.dispose(),null===(c=this._bumpTexture)||void 0===c||c.dispose(),null===(u=this._lightmapTexture)||void 0===u||u.dispose(),null===(h=this._refractionTexture)||void 0===h||h.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e){const t=lt.Clone(()=>new Ue(e,this.getScene()),this);return t.name=e,t.id=e,this.stencil.copyTo(t.stencil),t}static Parse(e,t,i){const n=lt.Parse(()=>new Ue(e.name,t),e,t,i);return e.stencil&&n.stencil.parse(e.stencil,t,i),n}static get DiffuseTextureEnabled(){return De.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){De.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return De.DetailTextureEnabled}static set DetailTextureEnabled(e){De.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return De.AmbientTextureEnabled}static set AmbientTextureEnabled(e){De.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return De.OpacityTextureEnabled}static set OpacityTextureEnabled(e){De.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return De.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){De.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return De.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){De.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return De.SpecularTextureEnabled}static set SpecularTextureEnabled(e){De.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return De.BumpTextureEnabled}static set BumpTextureEnabled(e){De.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return De.LightmapTextureEnabled}static set LightmapTextureEnabled(e){De.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return De.RefractionTextureEnabled}static set RefractionTextureEnabled(e){De.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return De.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){De.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return De.FresnelEnabled}static set FresnelEnabled(e){De.FresnelEnabled=e}}function ow(r,e,t,i){let n,s=1;1===i?n=new Float32Array(e*t*4):2===i?(n=new Uint16Array(e*t*4),s=15360):n=7===i?new Uint32Array(e*t*4):new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){const l=3*(o*e+a),c=4*(o*e+a);n[c+0]=r[l+0],n[c+1]=r[l+1],n[c+2]=r[l+2],n[c+3]=s}return n}function lw(r){return function(e,t,i,n,s,a,o,l,c=null,u=0){const h=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=new hi(this,r?vt.Raw3D:vt.Raw2DArray);f.baseWidth=t,f.baseHeight=i,f.baseDepth=n,f.width=t,f.height=i,f.depth=n,f.format=s,f.type=u,f.generateMipMaps=a,f.samplingMode=l,r?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),r?this.updateRawTexture3D(f,e,s,o,c,u):this.updateRawTexture2DArray(f,e,s,o,c,u),this._bindTextureDirectly(h,f,!0);const p=this._getSamplingParameters(l,a);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,p.min),a&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(f),f}}function cw(r){return function(e,t,i,n,s=null,a=0){const o=r?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),c=this._getInternalFormat(i),u=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(void 0===n||!!n),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=n,e._compression=s),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,u,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}b([Bt("diffuseTexture")],Ue.prototype,"_diffuseTexture",void 0),b([ee("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"diffuseTexture",void 0),b([Bt("ambientTexture")],Ue.prototype,"_ambientTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"ambientTexture",void 0),b([Bt("opacityTexture")],Ue.prototype,"_opacityTexture",void 0),b([ee("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"opacityTexture",void 0),b([Bt("reflectionTexture")],Ue.prototype,"_reflectionTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"reflectionTexture",void 0),b([Bt("emissiveTexture")],Ue.prototype,"_emissiveTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"emissiveTexture",void 0),b([Bt("specularTexture")],Ue.prototype,"_specularTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"specularTexture",void 0),b([Bt("bumpTexture")],Ue.prototype,"_bumpTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"bumpTexture",void 0),b([Bt("lightmapTexture")],Ue.prototype,"_lightmapTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"lightmapTexture",void 0),b([Bt("refractionTexture")],Ue.prototype,"_refractionTexture",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"refractionTexture",void 0),b([cn("ambient")],Ue.prototype,"ambientColor",void 0),b([cn("diffuse")],Ue.prototype,"diffuseColor",void 0),b([cn("specular")],Ue.prototype,"specularColor",void 0),b([cn("emissive")],Ue.prototype,"emissiveColor",void 0),b([O()],Ue.prototype,"specularPower",void 0),b([O("useAlphaFromDiffuseTexture")],Ue.prototype,"_useAlphaFromDiffuseTexture",void 0),b([ee("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"useAlphaFromDiffuseTexture",void 0),b([O("useEmissiveAsIllumination")],Ue.prototype,"_useEmissiveAsIllumination",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useEmissiveAsIllumination",void 0),b([O("linkEmissiveWithDiffuse")],Ue.prototype,"_linkEmissiveWithDiffuse",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"linkEmissiveWithDiffuse",void 0),b([O("useSpecularOverAlpha")],Ue.prototype,"_useSpecularOverAlpha",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useSpecularOverAlpha",void 0),b([O("useReflectionOverAlpha")],Ue.prototype,"_useReflectionOverAlpha",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useReflectionOverAlpha",void 0),b([O("disableLighting")],Ue.prototype,"_disableLighting",void 0),b([ee("_markAllSubMeshesAsLightsDirty")],Ue.prototype,"disableLighting",void 0),b([O("useObjectSpaceNormalMap")],Ue.prototype,"_useObjectSpaceNormalMap",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useObjectSpaceNormalMap",void 0),b([O("useParallax")],Ue.prototype,"_useParallax",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useParallax",void 0),b([O("useParallaxOcclusion")],Ue.prototype,"_useParallaxOcclusion",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useParallaxOcclusion",void 0),b([O()],Ue.prototype,"parallaxScaleBias",void 0),b([O("roughness")],Ue.prototype,"_roughness",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"roughness",void 0),b([O()],Ue.prototype,"indexOfRefraction",void 0),b([O()],Ue.prototype,"invertRefractionY",void 0),b([O()],Ue.prototype,"alphaCutOff",void 0),b([O("useLightmapAsShadowmap")],Ue.prototype,"_useLightmapAsShadowmap",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useLightmapAsShadowmap",void 0),b([lh("diffuseFresnelParameters")],Ue.prototype,"_diffuseFresnelParameters",void 0),b([ee("_markAllSubMeshesAsFresnelDirty")],Ue.prototype,"diffuseFresnelParameters",void 0),b([lh("opacityFresnelParameters")],Ue.prototype,"_opacityFresnelParameters",void 0),b([ee("_markAllSubMeshesAsFresnelAndMiscDirty")],Ue.prototype,"opacityFresnelParameters",void 0),b([lh("reflectionFresnelParameters")],Ue.prototype,"_reflectionFresnelParameters",void 0),b([ee("_markAllSubMeshesAsFresnelDirty")],Ue.prototype,"reflectionFresnelParameters",void 0),b([lh("refractionFresnelParameters")],Ue.prototype,"_refractionFresnelParameters",void 0),b([ee("_markAllSubMeshesAsFresnelDirty")],Ue.prototype,"refractionFresnelParameters",void 0),b([lh("emissiveFresnelParameters")],Ue.prototype,"_emissiveFresnelParameters",void 0),b([ee("_markAllSubMeshesAsFresnelDirty")],Ue.prototype,"emissiveFresnelParameters",void 0),b([O("useReflectionFresnelFromSpecular")],Ue.prototype,"_useReflectionFresnelFromSpecular",void 0),b([ee("_markAllSubMeshesAsFresnelDirty")],Ue.prototype,"useReflectionFresnelFromSpecular",void 0),b([O("useGlossinessFromSpecularMapAlpha")],Ue.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useGlossinessFromSpecularMapAlpha",void 0),b([O("maxSimultaneousLights")],Ue.prototype,"_maxSimultaneousLights",void 0),b([ee("_markAllSubMeshesAsLightsDirty")],Ue.prototype,"maxSimultaneousLights",void 0),b([O("invertNormalMapX")],Ue.prototype,"_invertNormalMapX",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"invertNormalMapX",void 0),b([O("invertNormalMapY")],Ue.prototype,"_invertNormalMapY",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"invertNormalMapY",void 0),b([O("twoSidedLighting")],Ue.prototype,"_twoSidedLighting",void 0),b([ee("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"twoSidedLighting",void 0),b([O()],Ue.prototype,"useLogarithmicDepth",null),ye("BABYLON.StandardMaterial",Ue),dt.DefaultMaterialFactory=r=>new Ue("default material",r),Ze.prototype.updateRawTexture=function(r,e,t,i,n=null,s=0,a=!1){if(!r)return;const o=this._getRGBABufferInternalSizedFormat(s,t,a),l=this._getInternalFormat(t),c=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0),this._unpackFlipY(void 0===i||!!i),this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.type=s,r.invertY=i,r._compression=n),r.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],r.width,r.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,r.width,r.height,0,l,c,e),r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0},Ze.prototype.createRawTexture=function(r,e,t,i,n,s,a,o=null,l=0,c=0,u=!1){const h=new hi(this,vt.Raw);h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=n,h.samplingMode=a,h.invertY=s,h._compression=o,h.type=l,h._useSRGBBuffer=this._getUseSRGBBuffer(u,!n),this._doNotHandleContextLost||(h._bufferView=r),this.updateRawTexture(h,r,i,s,o,l,h._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0);const d=this._getSamplingParameters(a,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(h),h},Ze.prototype.createRawCubeTexture=function(r,e,t,i,n,s,a,o=null){const l=this._gl,c=new hi(this,vt.CubeRaw);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=r);const u=this._getWebGLTextureType(i);let h=this._getInternalFormat(t);h===l.RGB&&(h=l.RGBA),u!==l.FLOAT||this._caps.textureFloatLinearFiltering?u!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?u!==l.FLOAT||this._caps.textureFloatRender?u===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,H.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,H.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,a=1,H.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,a=1,H.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const f=e;if(c.width=e,c.height=f,c.invertY=s,c._compression=o,!this.needPOTTextures||Ie.IsExponentOfTwo(c.width)&&Ie.IsExponentOfTwo(c.height)||(n=!1),r)this.updateRawCubeTexture(c,r,t,i,s,o);else{const _=this._getRGBABufferInternalSizedFormat(i),m=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let T=0;T<6;T++)o?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+T,m,this.getCaps().s3tc[o],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+T,m,_,c.width,c.height,0,h,u,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),r&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const g=this._getSamplingParameters(a,n);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,g.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,g.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=n,c.samplingMode=a,c.isReady=!0,c},Ze.prototype.updateRawCubeTexture=function(r,e,t,i,n,s=null,a=0){r._bufferViewArray=e,r.format=t,r.type=i,r.invertY=n,r._compression=s;const o=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);const u=this._getRGBABufferInternalSizedFormat(i);let h=!1;c===o.RGB&&(c=o.RGBA,h=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,r,!0),this._unpackFlipY(void 0===n||!!n),r.width%4!=0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let p=e[f];s?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,a,this.getCaps().s3tc[s],r.width,r.height,0,p):(h&&(p=ow(p,r.width,r.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,a,u,r.width,r.height,0,c,l,p))}(!this.needPOTTextures||Ie.IsExponentOfTwo(r.width)&&Ie.IsExponentOfTwo(r.height))&&r.generateMipMaps&&0===a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),r.isReady=!0},Ze.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,n,s,a,o,l=null,c=null,u=3,h=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,n,!s,h,u,null);null==e||e.addPendingData(f),f.url=r,this._internalTexturesCache.push(f);const g=_=>{const m=f.width,T=a(_);if(T){if(o){const v=this._getWebGLTextureType(n);let A=this._getInternalFormat(i);const S=this._getRGBABufferInternalSizedFormat(n);let x=!1;A===d.RGB&&(A=d.RGBA,x=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const C=o(T);for(let R=0;R<C.length;R++){const D=m>>R;for(let P=0;P<6;P++){let N=C[R][P];x&&(N=ow(N,D,D,n)),d.texImage2D(P,R,S,D,D,0,A,v,N)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,T,i,n,h);f.isReady=!0,null==e||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(r,_=>{g(_)},void 0,null==e?void 0:e.offlineProvider,!0,(_,m)=>{null==e||e.removePendingData(f),c&&_&&c(_.status+" "+_.statusText,m)}),f},Ze.prototype.createRawTexture2DArray=lw(!1),Ze.prototype.createRawTexture3D=lw(!0),Ze.prototype.updateRawTexture2DArray=cw(!1),Ze.prototype.updateRawTexture3D=cw(!0),ye("BABYLON.ColorGradingTexture",(()=>{class r extends di{constructor(t,i,n=null){if(super(i),t)if(this._textureMatrix=B.Identity(),this.name=t,this.url=t,this._onLoad=n,this._texture=this._getFromCache(t,!0),this._texture)this._triggerOnLoad();else{const s=this.getScene();s&&s.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const t=this._getEngine();let i;i=t._features.support3DTextures?t.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=i,this._texture.isReady=!1,this.isCube=!1,this.is3D=t._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const n=a=>{if("string"!=typeof a)return;let c,o=null,l=null;const u=a.split("\n");let h=0,d=0,f=0,p=0,g=0;for(let _=0;_<u.length;_++){if(c=u[_],!r._NoneEmptyLineRegex.test(c)||0===c.indexOf("#"))continue;const m=c.split(" ");if(0!==h){if(0!=h){const T=Math.max(parseInt(m[0]),0),v=Math.max(parseInt(m[1]),0),A=Math.max(parseInt(m[2]),0);g=Math.max(T,g),g=Math.max(v,g),g=Math.max(A,g);const S=4*(d+p*h+f*h*h);l&&(l[S+0]=T,l[S+1]=v,l[S+2]=A),f++,f%h==0&&(p++,f=0,p%h==0&&(d++,p=0))}}else h=m.length,o=new Uint8Array(h*h*h*4),l=new Float32Array(h*h*h*4)}if(l&&o)for(let _=0;_<l.length;_++)o[_]=_>0&&(_+1)%4==0?255:l[_]/g*255;i.is3D?(i.updateSize(h,h,h),t.updateRawTexture3D(i,o,5,!1)):(i.updateSize(h*h,h),t.updateRawTexture(i,o,5,!1)),i.isReady=!0,this._triggerOnLoad()},s=this.getScene();return s?s._loadFile(this.url,n):t._loadFile(this.url,n),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const t=new r(this.url,this.getScene()||this._getEngine());return t.level=this.level,t}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(t,i){let n=null;return t.name&&!t.isRenderTarget&&(n=new r(t.name,i),n.name=t.name,n.level=t.level),n}serialize(){if(!this.name)return null;const t={};return t.name=this.name,t.level=this.level,t.customType="BABYLON.ColorGradingTexture",t}}return r._NoneEmptyLineRegex=/\S+/,r})()),Ze.prototype._createDepthStencilCubeTexture=function(r,e,t){const i=new hi(this,vt.DepthStencil);if(i.isCube=!0,1===this.webGLVersion)return H.Error("Depth cube texture is not supported by WebGL 1."),i;const n=Mi({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,r,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=n.generateStencil;for(let a=0;a<6;a++)n.generateStencil?s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.DEPTH24_STENCIL8,r,r,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.DEPTH_COMPONENT24,r,r,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null);return this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i},Ze.prototype._partialLoadFile=function(r,e,t,i,n=null){this._loadFile(r,o=>{t[e]=o,t._internalCount++,6===t._internalCount&&i(t)},void 0,void 0,!0,(o,l)=>{n&&o&&n(o.status+" "+o.statusText,l)})},Ze.prototype._cascadeLoadFiles=function(r,e,t,i=null){const n=[];n._internalCount=0;for(let s=0;s<6;s++)this._partialLoadFile(t[s],s,n,e,i)},Ze.prototype._cascadeLoadImgs=function(r,e,t,i,n=null,s){const a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,a,r,e,t,n,s)},Ze.prototype._partialLoadImg=function(r,e,t,i,n,s,a=null,o){const l=Nf();Of(r,h=>{t[e]=h,t._internalCount++,i&&i.removePendingData(l),6===t._internalCount&&s&&s(n,t)},(h,d)=>{i&&i.removePendingData(l),a&&a(h,d)},i?i.offlineProvider:null,o),i&&i.addPendingData(l)},Ze.prototype._setCubeMapTextureParams=function(r,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&void 0!==t&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),r._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)},Ze.prototype.createCubeTextureBase=function(r,e,t,i,n=null,s=null,a,o=null,l=!1,c=0,u=0,h=null,d=null,f=null,p=!1){const g=h||new hi(this,vt.Cube);g.isCube=!0,g.url=r,g.generateMipMaps=!i,g._lodGenerationScale=c,g._lodGenerationOffset=u,g._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),g!==h&&(g.label=r.substring(0,60)),this._doNotHandleContextLost||(g._extension=o,g._files=t);const _=r;this._transformTextureUrl&&!h&&(r=this._transformTextureUrl(r));const m=r.split("?")[0],T=m.lastIndexOf("."),v=o||(T>-1?m.substring(T).toLowerCase():"");let A=null;for(const x of Ze._TextureLoaders)if(x.canLoad(v)){A=x;break}const S=(x,C)=>{r===_?s&&x&&s(x.status+" "+x.statusText,C):(H.Warn(`Failed to load ${r}, falling back to the ${_}`),this.createCubeTextureBase(_,e,t,!!i,n,s,a,o,l,c,u,g,d,f,p))};if(A){const x=C=>{d&&d(g,C),A.loadCubeData(C,g,l,n,s)};t&&6===t.length?A.supportCascades?this._cascadeLoadFiles(e,C=>x(C.map(R=>new Uint8Array(R))),t,s):s?s("Textures type does not support cascades."):H.Warn("Texture loader does not support cascades."):this._loadFile(r,C=>x(new Uint8Array(C)),void 0,void 0,!0,S)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,g,(x,C)=>{f&&f(x,C)},t,s)}return this._internalTexturesCache.push(g),g},Ze.prototype.createCubeTexture=function(r,e,t,i,n=null,s=null,a,o=null,l=!1,c=0,u=0,h=null,d,f=!1){const p=this._gl;return this.createCubeTextureBase(r,e,t,!!i,n,s,a,o,l,c,u,h,g=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,g,!0),(g,_)=>{const m=this.needPOTTextures?Ze.GetExponentOfTwo(_[0].width,this._caps.maxCubemapTextureSize):_[0].width,T=m,v=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,g,!0),this._unpackFlipY(!1);const A=a?this._getInternalFormat(a,g._useSRGBBuffer):g._useSRGBBuffer?p.SRGB8_ALPHA8:p.RGBA;let S=a?this._getInternalFormat(a):p.RGBA;g._useSRGBBuffer&&1===this.webGLVersion&&(S=A);for(let x=0;x<v.length;x++)if(_[x].width!==m||_[x].height!==T){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void H.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=m,this._workingCanvas.height=T,this._workingContext.drawImage(_[x],0,0,_[x].width,_[x].height,0,0,m,T),p.texImage2D(v[x],0,A,S,p.UNSIGNED_BYTE,this._workingCanvas)}else p.texImage2D(v[x],0,A,S,p.UNSIGNED_BYTE,_[x]);i||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(g,!i),g.width=m,g.height=T,g.isReady=!0,a&&(g.format=a),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),n&&n()},!!f)};class Nn extends di{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(B.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let n="";return e.forEach(s=>n+=s),new Nn(n,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,n=!0){const s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const a=new Nn(e,t,null,!1,null,null,null,void 0,!0,i,n);return t.useDelayedTextureLoading=s,a}constructor(e,t,i=null,n=!1,s=null,a=null,o=null,l=5,c=!1,u=null,h=!1,d=.8,f=0,p,g){var _;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new J,this.boundingBoxPosition=E.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this.name=e,this.url=e,this._noMipmap=n,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=B.Identity(),this._createPolynomials=h,this.coordinatesMode=j.CUBIC_MODE,this._extensions=i,this._files=s,this._forcedExtension=u,this._loaderOptions=p,this._useSRGBBuffer=g,this._lodScale=d,this._lodOffset=f,(e||s)&&this.updateURL(e,u,a,c,o,i,null===(_=this.getScene())||void 0===_?void 0:_.useDelayedTextureLoading,s)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,n=!1,s=null,a=null,o=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const c=e.lastIndexOf("."),u=t||(c>-1?e.substring(c).toLowerCase():""),h=0===u.indexOf(".dds"),d=0===u.indexOf(".env"),f=0===u.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=n,n&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!f&&!d&&!h&&!a&&(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let p=0;p<a.length;p++)this._files.push(e+a[p]);this._extensions=a}o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,i=>-1!==i.getActiveTextures().indexOf(this))),this._textureMatrix=e)}_loadTexture(e=null,t=null){var i;const n=this.getScene(),s=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const a=()=>{var l;this.onLoadObservable.notifyObservers(this),s&&(s.dispose(),null===(l=this.getScene())||void 0===l||l.markAllMaterialsAsDirty(1)),e&&e()},o=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),j.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?Ie.SetImmediate(()=>a()):this._texture.onLoadedObservable.add(()=>a()):(this._texture=this._prefiltered?this._getEngine().createPrefilteredCubeTexture(this.url,n,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._getEngine().createCubeTexture(this.url,n,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),null===(i=this._texture)||void 0===i||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const n=lt.Parse(()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new Nn(i+e.name,t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(n.boundingBoxPosition=E.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(n.boundingBoxSize=E.FromArray(e.boundingBoxSize)),e.animations)for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=zr("BABYLON.Animation");o&&n.animations.push(o.Parse(a))}return n}clone(){let e=0;const t=lt.Clone(()=>{const i=new Nn(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}b([O()],Nn.prototype,"url",void 0),b([Mr()],Nn.prototype,"boundingBoxPosition",void 0),b([Mr()],Nn.prototype,"boundingBoxSize",null),b([O("rotationY")],Nn.prototype,"rotationY",null),b([O("files")],Nn.prototype,"_files",void 0),b([O("forcedExtension")],Nn.prototype,"_forcedExtension",void 0),b([O("extensions")],Nn.prototype,"_extensions",void 0),b([function cz(r){return rs(12,r)}("textureMatrix")],Nn.prototype,"_textureMatrix",void 0),j._CubeTextureParser=Nn.Parse,ye("BABYLON.CubeTexture",Nn),Ze.prototype.createDynamicTexture=function(r,e,t,i){const n=new hi(this,vt.Dynamic);return n.baseWidth=r,n.baseHeight=e,t&&(r=this.needPOTTextures?Ze.GetExponentOfTwo(r,this._caps.maxTextureSize):r,e=this.needPOTTextures?Ze.GetExponentOfTwo(e,this._caps.maxTextureSize):e),n.width=r,n.height=e,n.isReady=!1,n.generateMipMaps=t,n.samplingMode=i,this.updateTextureSamplingMode(i,n),this._internalTexturesCache.push(n),n},Ze.prototype.updateDynamicTexture=function(r,e,t,i=!1,n,s=!1,a=!1){if(!r)return;const o=this._gl,l=o.TEXTURE_2D,c=this._bindTextureDirectly(l,r,!0,s);this._unpackFlipY(void 0===t?r.invertY:t),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const u=this._getWebGLTextureType(r.type),h=this._getInternalFormat(n||r.format),d=this._getRGBABufferInternalSizedFormat(r.type,h);o.texImage2D(l,0,d,h,u,e),r.generateMipMaps&&o.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r.isReady=!0};class bl{static ConvertPanoramaToCubemap(e,t,i,n){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(n,this.FACE_FRONT,e,t,i),back:this.CreateCubemapTexture(n,this.FACE_BACK,e,t,i),left:this.CreateCubemapTexture(n,this.FACE_LEFT,e,t,i),right:this.CreateCubemapTexture(n,this.FACE_RIGHT,e,t,i),up:this.CreateCubemapTexture(n,this.FACE_UP,e,t,i),down:this.CreateCubemapTexture(n,this.FACE_DOWN,e,t,i),size:n,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,n,s){const a=new ArrayBuffer(e*e*4*3),o=new Float32Array(a),l=t[1].subtract(t[0]).scale(1/e),c=t[3].subtract(t[2]).scale(1/e),u=1/e;let h=0;for(let d=0;d<e;d++){let f=t[0],p=t[2];for(let g=0;g<e;g++){const _=p.subtract(f).scale(h).add(f);_.normalize();const m=this.CalcProjectionSpherical(_,i,n,s);o[d*e*3+3*g+0]=m.r,o[d*e*3+3*g+1]=m.g,o[d*e*3+3*g+2]=m.b,f=f.add(l),p=p.add(c)}h+=u}return o}static CalcProjectionSpherical(e,t,i,n){let s=Math.atan2(e.z,e.x);const a=Math.acos(e.y);for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;let o=s/Math.PI;const l=a/Math.PI;o=.5*o+.5;let c=Math.round(o*i);c<0?c=0:c>=i&&(c=i-1);let u=Math.round(l*n);u<0?u=0:u>=n&&(u=n-1);const h=n-u-1;return{r:t[h*i*3+3*c+0],g:t[h*i*3+3*c+1],b:t[h*i*3+3*c+2]}}}bl.FACE_LEFT=[new E(-1,-1,-1),new E(1,-1,-1),new E(-1,1,-1),new E(1,1,-1)],bl.FACE_RIGHT=[new E(1,-1,1),new E(-1,-1,1),new E(1,1,1),new E(-1,1,1)],bl.FACE_FRONT=[new E(1,-1,-1),new E(1,-1,1),new E(1,1,-1),new E(1,1,1)],bl.FACE_BACK=[new E(-1,-1,1),new E(-1,-1,-1),new E(-1,1,1),new E(-1,1,-1)],bl.FACE_DOWN=[new E(1,1,-1),new E(1,1,1),new E(-1,1,-1),new E(-1,1,1)],bl.FACE_UP=[new E(-1,-1,-1),new E(-1,-1,1),new E(1,-1,-1),new E(1,-1,1)];class uw{static IsExternalTexture(e){return void 0!==e.underlyingResource}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this._video=e,this.uniqueId=hi._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}Z.ShadersStore.hdrFilteringVertexShader="attribute vec2 position;\nvarying vec3 direction;\nuniform vec3 up;\nuniform vec3 right;\nuniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);\ndirection=view*vec3(position,1.0);\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";Z.ShadersStore.hdrFilteringPixelShader="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;\nuniform samplerCube inputTexture;\nuniform vec2 vFilteringInfo;\nuniform float hdrScale;\nvarying vec3 direction;\nvoid main() {\nvec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);\ngl_FragColor=vec4(color*hdrScale,1.0);\n}";class e5{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=Se.ILog2(t)+1,n=this._effectWrapper.effect,s=this._createRenderTarget(t);this._effectRenderer.setViewport();const a=e.getInternalTexture();a&&this._engine.updateTextureSamplingMode(3,a,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new E(0,0,-1),new E(0,-1,0),new E(1,0,0)],[new E(0,0,1),new E(0,-1,0),new E(-1,0,0)],[new E(1,0,0),new E(0,0,1),new E(0,1,0)],[new E(1,0,0),new E(0,0,-1),new E(0,-1,0)],[new E(1,0,0),new E(0,-1,0),new E(0,0,1)],[new E(-1,0,0),new E(0,-1,0),new E(0,0,-1)]];n.setFloat("hdrScale",this.hdrScale),n.setFloat2("vFilteringInfo",e.getSize().width,i),n.setTexture("inputTexture",e);for(let u=0;u<6;u++){n.setVector3("up",o[u][0]),n.setVector3("right",o[u][1]),n.setVector3("front",o[u][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(s,u,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let d=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;0===h&&(d=0),n.setFloat("alphaG",d),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);const l=s.texture.type,c=s.texture.format;return s._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){const i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new gC({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new pC(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(H.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class QT{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,n,s,a){s>0?(s=this._Ldexp(1,s-136),e[a+0]=t*s,e[a+1]=i*s,e[a+2]=n*s):(e[a+0]=0,e[a+1]=0,e[a+2]=0)}static _ReadStringLine(e,t){let i="",n="";for(let s=t;s<e.length-t&&(n=String.fromCharCode(e[s]),"\n"!=n);s++)i+=n;return i}static RGBE_ReadHeader(e){let t=0,i=0,n=this._ReadStringLine(e,0);if("#"!=n[0]||"?"!=n[1])throw"Bad HDR Format.";let s=!1,a=!1,o=0;do{o+=n.length+1,n=this._ReadStringLine(e,o),"FORMAT=32-bit_rle_rgbe"==n?a=!0:0==n.length&&(s=!0)}while(!s);if(!a)throw"HDR Bad header format, unsupported FORMAT";o+=n.length+1,n=this._ReadStringLine(e,o);const c=/^-Y (.*) \+X (.*)$/g.exec(n);if(!c||c.length<3)throw"HDR Bad header format, no size";if(i=parseInt(c[2]),t=parseInt(c[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return o+=n.length+1,{height:t,width:i,dataPosition:o}}static GetCubeMapTextureData(e,t){const i=new Uint8Array(e),n=this.RGBE_ReadHeader(i),s=this.RGBE_ReadPixels(i,n);return bl.ConvertPanoramaToCubemap(s,n.width,n.height,t)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const n=t.width;let s,a,o,l,c,u=t.dataPosition,h=0,d=0,f=0;const p=new ArrayBuffer(4*n),g=new Uint8Array(p),_=new ArrayBuffer(t.width*t.height*4*3),m=new Float32Array(_);for(;i>0;){if(s=e[u++],a=e[u++],o=e[u++],l=e[u++],2!=s||2!=a||128&o||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((o<<8|l)!=n)throw"HDR Bad header format, wrong scan line width";for(h=0,f=0;f<4;f++)for(d=(f+1)*n;h<d;)if(s=e[u++],a=e[u++],s>128){if(c=s-128,0==c||c>d-h)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)g[h++]=a}else{if(c=s,0==c||c>d-h)throw"HDR Bad Format, bad scanline data (non-run)";if(g[h++]=a,--c>0)for(let T=0;T<c;T++)g[h++]=e[u++]}for(f=0;f<n;f++)s=g[f],a=g[f+n],o=g[f+2*n],l=g[f+3*n],this._Rgbe2float(m,s,a,o,l,(t.height-i)*n*3+3*f);i--}return m}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const n=t.width;let s,a,o,l,c,u=t.dataPosition;const h=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(h);for(;i>0;){for(c=0;c<t.width;c++)s=e[u++],a=e[u++],o=e[u++],l=e[u++],this._Rgbe2float(d,s,a,o,l,(t.height-i)*n*3+3*c);i--}return d}}let gw=(()=>{class r extends di{set isBlocking(t){this._isBlocking=t}get isBlocking(){return this._isBlocking}set rotationY(t){this._rotationY=t,this.setReflectionTextureMatrix(B.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;const i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(t,i,n,s=!1,a=!0,o=!1,l=!1,c=null,u=null){var h;super(i),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=E.Zero(),this.onLoadObservable=new J,t&&(this._coordinatesMode=j.CUBIC_MODE,this.name=t,this.url=t,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=B.Identity(),this._prefilterOnLoad=l,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),c&&c()},this._onError=u,this.gammaSpace=o,this._noMipmap=s,this._size=n,this._generateHarmonics=a,this._texture=this._getFromCache(t,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?Ie.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):(null===(h=this.getScene())||void 0===h?void 0:h.useDelayedTextureLoading)?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const t=this._getEngine(),i=t.getCaps();let n=0;if(i.textureFloat&&i.textureFloatLinearFiltering?n=1:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(n=2),t._features.allowTexturePrefiltering&&this._prefilterOnLoad){const a=this._onLoad,o=new e5(t);this._onLoad=()=>{o.prefilter(this,a)}}this._texture=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,n,this._noMipmap,a=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const o=QT.GetCubeMapTextureData(a,this._size);if(this._generateHarmonics){const h=tp.ConvertCubeMapToSphericalPolynomial(o);this.sphericalPolynomial=h}const l=[];let c=null,u=null;for(let h=0;h<6;h++){2===n?u=new Uint16Array(this._size*this._size*3):0===n&&(c=new Uint8Array(this._size*this._size*3));const d=o[r._FacesMapping[h]];if(this.gammaSpace||u||c)for(let f=0;f<this._size*this._size;f++)if(this.gammaSpace&&(d[3*f+0]=Math.pow(d[3*f+0],Sf),d[3*f+1]=Math.pow(d[3*f+1],Sf),d[3*f+2]=Math.pow(d[3*f+2],Sf)),u&&(u[3*f+0]=Ca(d[3*f+0]),u[3*f+1]=Ca(d[3*f+1]),u[3*f+2]=Ca(d[3*f+2])),c){let p=Math.max(255*d[3*f+0],0),g=Math.max(255*d[3*f+1],0),_=Math.max(255*d[3*f+2],0);const m=Math.max(Math.max(p,g),_);if(m>255){const T=255/m;p*=T,g*=T,_*=T}c[3*f+0]=p,c[3*f+1]=g,c[3*f+2]=_}l.push(u||c||d)}return l},null,this._onLoad,this._onError)}clone(){const t=new r(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(t){var i;this._textureMatrix=t,t.updateFlag!==this._textureMatrix.updateFlag&&t.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(i=this.getScene())||void 0===i||i.markAllMaterialsAsDirty(1,n=>-1!==n.getActiveTextures().indexOf(this)))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(t,i,n){let s=null;return t.name&&!t.isRenderTarget&&(s=new r(n+t.name,i,t.size,t.noMipmap,t.generateHarmonics,t.useInGammaSpace),s.name=t.name,s.hasAlpha=t.hasAlpha,s.level=t.level,s.coordinatesMode=t.coordinatesMode,s.isBlocking=t.isBlocking),s&&(t.boundingBoxPosition&&(s.boundingBoxPosition=E.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(s.boundingBoxSize=E.FromArray(t.boundingBoxSize)),t.rotationY&&(s.rotationY=t.rotationY)),s}serialize(){if(!this.name)return null;const t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this._generateHarmonics,t.customType="BABYLON.HDRCubeTexture",t.noMipmap=this._noMipmap,t.isBlocking=this._isBlocking,t.rotationY=this._rotationY,t}}return r._FacesMapping=["right","left","up","down","front","back"],r})();function ip(r){return r.charCodeAt(0)+(r.charCodeAt(1)<<8)+(r.charCodeAt(2)<<16)+(r.charCodeAt(3)<<24)}ye("BABYLON.HDRCubeTexture",gw),Ze.prototype.updateVideoTexture=function(r,e,t){if(!r||r._isDisabled)return;const i=this._getInternalFormat(r.format),n=this._getRGBABufferInternalSizedFormat(0,r.format),s=this._bindTextureDirectly(this._gl.TEXTURE_2D,r,!0);this._unpackFlipY(!t);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,i,this._gl.UNSIGNED_BYTE,e),this._videoTextureSupported=0===this._gl.getError()),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,i,this._gl.UNSIGNED_BYTE,e);else{if(!r._workingCanvas){r._workingCanvas=this.createCanvas(r.width,r.height);const a=r._workingCanvas.getContext("2d");if(!a)throw new Error("Unable to get 2d context");r._workingContext=a,r._workingCanvas.width=r.width,r._workingCanvas.height=r.height}r._workingContext.clearRect(0,0,r.width,r.height),r._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,r.width,r.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,i,this._gl.UNSIGNED_BYTE,r._workingCanvas)}r.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),s||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r.isReady=!0}catch(a){r._isDisabled=!0}};const Sw=ip("DXT1"),xw=ip("DXT3"),Aw=ip("DXT5"),ZT=ip("DX10");let Cl=(()=>{class r{static GetDDSInfo(t){const i=new Int32Array(t.buffer,t.byteOffset,31),n=new Int32Array(t.buffer,t.byteOffset,35);let s=1;131072&i[2]&&(s=Math.max(1,i[7]));const a=i[21],o=a===ZT?n[32]:0;let l=0;switch(a){case 113:l=2;break;case 116:l=1;break;case ZT:if(10===o){l=2;break}if(2===o){l=1;break}}return{width:i[4],height:i[3],mipmapCount:s,isFourCC:4==(4&i[20]),isRGB:64==(64&i[20]),isLuminance:131072==(131072&i[20]),isCube:512==(512&i[28]),isCompressed:a===Sw||a===xw||a===Aw,dxgiFormat:o,textureType:l}}static _GetHalfFloatAsFloatRGBAArrayBuffer(t,i,n,s,a,o){const l=new Float32Array(s),c=new Uint16Array(a,n);let u=0;for(let h=0;h<i;h++)for(let d=0;d<t;d++){const f=4*(d+h*t);l[u]=Ia(c[f]),l[u+1]=Ia(c[f+1]),l[u+2]=Ia(c[f+2]),l[u+3]=r.StoreLODInAlphaChannel?o:Ia(c[f+3]),u+=4}return l}static _GetHalfFloatRGBAArrayBuffer(t,i,n,s,a,o){if(r.StoreLODInAlphaChannel){const l=new Uint16Array(s),c=new Uint16Array(a,n);let u=0;for(let h=0;h<i;h++)for(let d=0;d<t;d++){const f=4*(d+h*t);l[u]=c[f],l[u+1]=c[f+1],l[u+2]=c[f+2],l[u+3]=Ca(o),u+=4}return l}return new Uint16Array(a,n,s)}static _GetFloatRGBAArrayBuffer(t,i,n,s,a,o){if(r.StoreLODInAlphaChannel){const l=new Float32Array(s),c=new Float32Array(a,n);let u=0;for(let h=0;h<i;h++)for(let d=0;d<t;d++){const f=4*(d+h*t);l[u]=c[f],l[u+1]=c[f+1],l[u+2]=c[f+2],l[u+3]=o,u+=4}return l}return new Float32Array(a,n,s)}static _GetFloatAsHalfFloatRGBAArrayBuffer(t,i,n,s,a,o){const l=new Uint16Array(s),c=new Float32Array(a,n);let u=0;for(let h=0;h<i;h++)for(let d=0;d<t;d++)l[u]=Ca(c[u]),l[u+1]=Ca(c[u+1]),l[u+2]=Ca(c[u+2]),l[u+3]=Ca(r.StoreLODInAlphaChannel?o:c[u+3]),u+=4;return l}static _GetFloatAsUIntRGBAArrayBuffer(t,i,n,s,a,o){const l=new Uint8Array(s),c=new Float32Array(a,n);let u=0;for(let h=0;h<i;h++)for(let d=0;d<t;d++){const f=4*(d+h*t);l[u]=255*Se.Clamp(c[f]),l[u+1]=255*Se.Clamp(c[f+1]),l[u+2]=255*Se.Clamp(c[f+2]),l[u+3]=r.StoreLODInAlphaChannel?o:255*Se.Clamp(c[f+3]),u+=4}return l}static _GetHalfFloatAsUIntRGBAArrayBuffer(t,i,n,s,a,o){const l=new Uint8Array(s),c=new Uint16Array(a,n);let u=0;for(let h=0;h<i;h++)for(let d=0;d<t;d++){const f=4*(d+h*t);l[u]=255*Se.Clamp(Ia(c[f])),l[u+1]=255*Se.Clamp(Ia(c[f+1])),l[u+2]=255*Se.Clamp(Ia(c[f+2])),l[u+3]=r.StoreLODInAlphaChannel?o:255*Se.Clamp(Ia(c[f+3])),u+=4}return l}static _GetRGBAArrayBuffer(t,i,n,s,a,o,l,c,u){const h=new Uint8Array(s),d=new Uint8Array(a,n);let f=0;for(let p=0;p<i;p++)for(let g=0;g<t;g++){const _=4*(g+p*t);h[f]=d[_+o],h[f+1]=d[_+l],h[f+2]=d[_+c],h[f+3]=d[_+u],f+=4}return h}static _ExtractLongWordOrder(t){return 0===t||255===t||-16777216===t?0:1+r._ExtractLongWordOrder(t>>8)}static _GetRGBArrayBuffer(t,i,n,s,a,o,l,c){const u=new Uint8Array(s),h=new Uint8Array(a,n);let d=0;for(let f=0;f<i;f++)for(let p=0;p<t;p++){const g=3*(p+f*t);u[d]=h[g+o],u[d+1]=h[g+l],u[d+2]=h[g+c],d+=3}return u}static _GetLuminanceArrayBuffer(t,i,n,s,a){const o=new Uint8Array(s),l=new Uint8Array(a,n);let c=0;for(let u=0;u<i;u++)for(let h=0;h<t;h++)o[c]=l[h+u*t],c++;return o}static UploadDDSLevels(t,i,n,s,a,o,l=-1,c,u=!0){let h=null;s.sphericalPolynomial&&(h=new Array);const d=!!t.getCaps().s3tc;i.generateMipMaps=a;const f=new Int32Array(n.buffer,n.byteOffset,31);let p,g,_,T,v,A,S,m=0,x=0,C=1;if(542327876!==f[0])return void H.Error("Invalid magic number in DDS header");if(!s.isFourCC&&!s.isRGB&&!s.isLuminance)return void H.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(s.isCompressed&&!d)return void H.Error("Compressed textures are not supported on this platform.");let R=f[22];T=f[1]+4;let D=!1;if(s.isFourCC)switch(p=f[21],p){case Sw:C=8,x=33777;break;case xw:C=16,x=33778;break;case Aw:C=16,x=33779;break;case 113:D=!0,R=64;break;case 116:D=!0,R=128;break;case ZT:{T+=20;let ue=!1;switch(s.dxgiFormat){case 10:D=!0,R=64,ue=!0;break;case 2:D=!0,R=128,ue=!0;break;case 88:s.isRGB=!0,s.isFourCC=!1,R=32,ue=!0}if(ue)break}default:return void console.error("Unsupported FourCC code:",function i5(r){return String.fromCharCode(255&r,r>>8&255,r>>16&255,r>>24&255)}(p))}const P=r._ExtractLongWordOrder(f[23]),N=r._ExtractLongWordOrder(f[24]),k=r._ExtractLongWordOrder(f[25]),X=r._ExtractLongWordOrder(f[26]);D&&(x=t._getRGBABufferInternalSizedFormat(s.textureType)),A=1,131072&f[2]&&!1!==a&&(A=Math.max(1,f[7]));const ne=c||0,ge=t.getCaps();for(let ue=ne;ue<o;ue++){for(g=f[4],_=f[3],S=0;S<A;++S){if(-1===l||l===S){const ke=-1===l?S:0;if(!s.isCompressed&&s.isFourCC){i.format=5,m=g*_*4;let me=null;if(t._badOS||t._badDesktopOS||!ge.textureHalfFloat&&!ge.textureFloat)128===R?(me=r._GetFloatAsUIntRGBAArrayBuffer(g,_,n.byteOffset+T,m,n.buffer,ke),h&&0==ke&&h.push(r._GetFloatRGBAArrayBuffer(g,_,n.byteOffset+T,m,n.buffer,ke))):64===R&&(me=r._GetHalfFloatAsUIntRGBAArrayBuffer(g,_,n.byteOffset+T,m,n.buffer,ke),h&&0==ke&&h.push(r._GetHalfFloatAsFloatRGBAArrayBuffer(g,_,n.byteOffset+T,m,n.buffer,ke))),i.type=0;else{const $=ge.textureFloat&&(u&&ge.textureFloatLinearFiltering||!u),Q=ge.textureHalfFloat&&(u&&ge.textureHalfFloatLinearFiltering||!u),w=(128===R||64===R&&!Q)&&$?1:(64===R||128===R&&!$)&&Q?2:0;let Y,se=null;if(128===R)switch(w){case 1:Y=r._GetFloatRGBAArrayBuffer,se=null;break;case 2:Y=r._GetFloatAsHalfFloatRGBAArrayBuffer,se=r._GetFloatRGBAArrayBuffer;break;case 0:Y=r._GetFloatAsUIntRGBAArrayBuffer,se=r._GetFloatRGBAArrayBuffer}else switch(w){case 1:Y=r._GetHalfFloatAsFloatRGBAArrayBuffer,se=null;break;case 2:Y=r._GetHalfFloatRGBAArrayBuffer,se=r._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:Y=r._GetHalfFloatAsUIntRGBAArrayBuffer,se=r._GetHalfFloatAsFloatRGBAArrayBuffer}i.type=w,me=Y(g,_,n.byteOffset+T,m,n.buffer,ke),h&&0==ke&&h.push(se?se(g,_,n.byteOffset+T,m,n.buffer,ke):me)}me&&t._uploadDataToTextureDirectly(i,me,ue,ke)}else if(s.isRGB)i.type=0,24===R?(i.format=4,m=g*_*3,v=r._GetRGBArrayBuffer(g,_,n.byteOffset+T,m,n.buffer,P,N,k),t._uploadDataToTextureDirectly(i,v,ue,ke)):(i.format=5,m=g*_*4,v=r._GetRGBAArrayBuffer(g,_,n.byteOffset+T,m,n.buffer,P,N,k,X),t._uploadDataToTextureDirectly(i,v,ue,ke));else if(s.isLuminance){const me=t._getUnpackAlignement(),$=g;m=Math.floor((g+me-1)/me)*me*(_-1)+$,v=r._GetLuminanceArrayBuffer(g,_,n.byteOffset+T,m,n.buffer),i.format=1,i.type=0,t._uploadDataToTextureDirectly(i,v,ue,ke)}else m=Math.max(4,g)/4*Math.max(4,_)/4*C,v=new Uint8Array(n.buffer,n.byteOffset+T,m),i.type=0,t._uploadCompressedDataToTextureDirectly(i,x,g,_,v,ue,ke)}T+=R?g*_*(R/8):m,g*=.5,_*=.5,g=Math.max(1,g),_=Math.max(1,_)}if(void 0!==c)break}s.sphericalPolynomial=h&&h.length>0?tp.ConvertCubeMapToSphericalPolynomial({size:f[4],right:h[0],left:h[1],up:h[2],down:h[3],front:h[4],back:h[5],format:5,type:1,gammaSpace:!1}):void 0}}return r.StoreLODInAlphaChannel=!1,r})();Ze.prototype.createPrefilteredCubeTexture=function(r,e,t,i,n=null,s=null,a,o=null,l=!0){return this.createCubeTexture(r,e,null,!1,u=>{if(!u)return void(n&&n(null));const h=u.texture;if(l?u.info.sphericalPolynomial&&(h._sphericalPolynomial=u.info.sphericalPolynomial):h._sphericalPolynomial=new _l,h._source=vt.CubePrefiltered,this.getCaps().textureLOD)return void(n&&n(h));const f=this._gl,p=u.width;if(!p)return;const g=[];for(let _=0;_<3;_++){const T=1-_/2,v=i,A=Se.Log2(p)*t+i,x=Math.round(Math.min(Math.max(v+(A-v)*T,0),A)),C=new hi(this,vt.Temp);if(C.type=h.type,C.format=h.format,C.width=Math.pow(2,Math.max(Se.Log2(p)-x,0)),C.height=C.width,C.isCube=!0,C._cachedWrapU=0,C._cachedWrapV=0,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,C,!0),C.samplingMode=2,f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),u.isDDS){const D=u.info,P=u.data;this._unpackFlipY(D.isCompressed),Cl.UploadDDSLevels(this,C,P,D,!0,6,x)}else H.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null);const R=new di(e);R._isCube=!0,R._texture=C,C.isReady=!0,g.push(R)}h._lodTextureHigh=g[2],h._lodTextureMid=g[1],h._lodTextureLow=g[0],n&&n(h)},s,a,o,l,t,i)},Ve._TextureLoaders.push(new class f5{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,n){const s=t.getEngine();let a,o=!1,l=1e3;if(Array.isArray(e))for(let c=0;c<e.length;c++){const u=e[c];a=Cl.GetDDSInfo(u),t.width=a.width,t.height=a.height,o=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(a.isCompressed),Cl.UploadDDSLevels(s,t,u,a,o,6,-1,c),a.isFourCC||1!==a.mipmapCount?l=a.mipmapCount-1:s.generateMipMapsForCubemap(t)}else{const c=e;a=Cl.GetDDSInfo(c),t.width=a.width,t.height=a.height,i&&(a.sphericalPolynomial=new _l),o=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(a.isCompressed),Cl.UploadDDSLevels(s,t,c,a,o,6),a.isFourCC||1!==a.mipmapCount?l=a.mipmapCount-1:s.generateMipMapsForCubemap(t,!1)}s._setCubeMapTextureParams(t,o,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n({isDDS:!0,width:t.width,info:a,data:e,texture:t})}loadData(e,t,i){const n=Cl.GetDDSInfo(e),s=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps&&n.width>>n.mipmapCount-1==1;i(n.width,n.height,s,n.isFourCC,()=>{Cl.UploadDDSLevels(t.getEngine(),t,e,n,s,1)})}});Z.ShadersStore.rgbdEncodePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{\ngl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);\n}";const tE="image/png",bh=[134,22,135,150,246,214,150,54];function nE(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength);let t=0;for(let a=0;a<bh.length;a++)if(e.getUint8(t++)!==bh[a])return H.Error("Not a babylon environment map"),null;let i="",n=0;for(;n=e.getUint8(t++);)i+=String.fromCharCode(n);let s=JSON.parse(i);return s=np(s),s.specular&&(s.specular.specularDataPosition=t,s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s}function np(r){if(r.version>2)throw new Error(`Unsupported babylon environment map version "${r.version}". Latest supported version is "2".`);return 2===r.version||(r=Gp(Mi({},r),{version:2,imageType:tE})),r}function sE(r,e){const t=(e=np(e)).specular;let i=Se.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const n=new Array(i);for(let s=0;s<i;s++){n[s]=new Array(6);for(let a=0;a<6;a++){const o=t.mipmaps[6*s+a];n[s][a]=new Uint8Array(r.buffer,r.byteOffset+t.specularDataPosition+o.position,o.length)}}return n}function Fw(r,e,t){const i=(t=np(t)).specular;return i?(r._lodGenerationScale=i.lodGenerationScale,function rp(r,e,t=tE){if(!Ie.IsExponentOfTwo(r.width))throw new Error("Texture size must be a power of two");const i=Se.ILog2(r.width)+1,n=r.getEngine();let s=!1,a=!1,o=null,l=null,c=null;const u=n.getCaps();if(r.format=5,r.type=0,r.generateMipMaps=!0,r._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,r),u.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(s=!0,r.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(s=!0,r.type=1):s=!1:(s=!1,a=!0,c={}),s)o=new li("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,r.type,void 0,null,!1),r._isRGBD=!1,r.invertY=!1,l=n.createRenderTargetCubeTexture(r.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:r.type,format:5});else if(r._isRGBD=!0,r.invertY=!0,a){const f=r._lodGenerationScale,p=r._lodGenerationOffset;for(let g=0;g<3;g++){const v=(i-1)*f+p,S=Math.round(Math.min(Math.max(p+(v-p)*(1-g/2),0),v)),x=new hi(n,vt.Temp);x.isCube=!0,x.invertY=!0,x.generateMipMaps=!1,n.updateTextureSamplingMode(2,x);const C=new di(null);switch(C._isCube=!0,C._texture=x,c[S]=C,g){case 0:r._lodTextureLow=C;break;case 1:r._lodTextureMid=C;break;case 2:r._lodTextureHigh=C}}}const h=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){const g=new Blob([e[d][f]],{type:t}),_=URL.createObjectURL(g);let m;if("undefined"==typeof Image||n._features.forceBitmapOverHTMLImageElement)m=n.createImageBitmap(g,{premultiplyAlpha:"none"}).then(T=>Nw(T,n,s,o,_,f,d,a,c,l,r));else{const T=new Image;T.src=_,m=new Promise((v,A)=>{T.onload=()=>{Nw(T,n,s,o,_,f,d,a,c,l,r).then(()=>v()).catch(S=>{A(S)})},T.onerror=S=>{A(S)}})}h.push(m)}if(e.length<i){let d;const f=Math.pow(2,i-1-e.length),p=f*f*4;switch(r.type){case 0:d=new Uint8Array(p);break;case 2:d=new Uint16Array(p);break;case 1:d=new Float32Array(p)}for(let g=e.length;g<i;g++)for(let _=0;_<6;_++)n._uploadArrayBufferViewToTexture(r,d,_,g)}return Promise.all(h).then(()=>{l&&(n._releaseTexture(r),l._swapAndDie(r)),o&&o.dispose(),a&&(r._lodTextureHigh&&r._lodTextureHigh._texture&&(r._lodTextureHigh._texture.isReady=!0),r._lodTextureMid&&r._lodTextureMid._texture&&(r._lodTextureMid._texture.isReady=!0),r._lodTextureLow&&r._lodTextureLow._texture&&(r._lodTextureLow._texture.isReady=!0))})}(r,sE(e,t),t.imageType)):Promise.resolve()}function Nw(r,e,t,i,n,s,a,o,l,c,u){return new Promise((h,d)=>{if(t){const f=e.createTexture(null,!0,!0,null,1,null,p=>{d(p)},r);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=p=>{p._bindTexture("textureSampler",f),p.setFloat2("scale",1,e._features.needsInvertingBitmap&&r instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,s,a),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(n),h())})}else{if(e._uploadImageToTexture(u,r,s,a),o){const f=l[a];f&&e._uploadImageToTexture(f._texture,r,s,0)}h()}})}function aE(r,e){const t=(e=np(e)).irradiance;if(!t)return;const i=new _l;E.FromArrayToRef(t.x,0,i.x),E.FromArrayToRef(t.y,0,i.y),E.FromArrayToRef(t.z,0,i.z),E.FromArrayToRef(t.xx,0,i.xx),E.FromArrayToRef(t.yy,0,i.yy),E.FromArrayToRef(t.zz,0,i.zz),E.FromArrayToRef(t.yz,0,i.yz),E.FromArrayToRef(t.zx,0,i.zx),E.FromArrayToRef(t.xy,0,i.xy),r._sphericalPolynomial=i}Ve._TextureLoaders.push(new class _5{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,n,s){if(Array.isArray(e))return;const a=nE(e);if(a){t.width=a.width,t.height=a.width;try{aE(t,a),Fw(t,e,a).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()},o=>{null==s||s("Can not upload environment levels",o)})}catch(o){null==s||s("Can not upload environment file",o)}}else s&&s("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}});let oE=(()=>{class r{constructor(t,i){if(this.data=t,this.isInvalid=!1,!r.IsValid(t))return this.isInvalid=!0,void H.Error("texture missing KTX identifier");const n=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*n),o=67305985===s.getUint32(0,!0);return this.glType=s.getUint32(1*n,o),this.glTypeSize=s.getUint32(2*n,o),this.glFormat=s.getUint32(3*n,o),this.glInternalFormat=s.getUint32(4*n,o),this.glBaseInternalFormat=s.getUint32(5*n,o),this.pixelWidth=s.getUint32(6*n,o),this.pixelHeight=s.getUint32(7*n,o),this.pixelDepth=s.getUint32(8*n,o),this.numberOfArrayElements=s.getUint32(9*n,o),this.numberOfFaces=s.getUint32(10*n,o),this.numberOfMipmapLevels=s.getUint32(11*n,o),this.bytesOfKeyValueData=s.getUint32(12*n,o),0!==this.glType?(H.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(H.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(H.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==i?(H.Error("number of faces expected"+i+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=r.COMPRESSED_2D))}uploadLevels(t,i){this.loadType===r.COMPRESSED_2D&&this._upload2DCompressedLevels(t,i)}_upload2DCompressedLevels(t,i){let n=r.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,a=this.pixelHeight;const o=i?this.numberOfMipmapLevels:1;for(let l=0;l<o;l++){const c=new Int32Array(this.data.buffer,this.data.byteOffset+n,1)[0];n+=4;for(let u=0;u<this.numberOfFaces;u++){const h=new Uint8Array(this.data.buffer,this.data.byteOffset+n,c);t.getEngine()._uploadCompressedDataToTextureDirectly(t,t.format,s,a,h,u,l),n+=c,n+=3-(c+3)%4}s=Math.max(1,.5*s),a=Math.max(1,.5*a)}}static IsValid(t){if(t.byteLength>=12){const i=new Uint8Array(t.buffer,t.byteOffset,12);if(171===i[0]&&75===i[1]&&84===i[2]&&88===i[3]&&32===i[4]&&49===i[5]&&49===i[6]&&187===i[7]&&13===i[8]&&10===i[9]&&26===i[10]&&10===i[11])return!0}return!1}}return r.HEADER_LEN=64,r.COMPRESSED_2D=0,r.COMPRESSED_3D=1,r.TEX_2D=2,r.TEX_3D=3,r})();var Yc=(()=>{return(r=Yc||(Yc={}))[r.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",r[r.BC7_RGBA=1]="BC7_RGBA",r[r.BC3_RGBA=2]="BC3_RGBA",r[r.BC1_RGB=3]="BC1_RGB",r[r.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",r[r.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",r[r.ETC2_RGBA=6]="ETC2_RGBA",r[r.ETC1_RGB=7]="ETC1_RGB",r[r.RGBA32=8]="RGBA32",r[r.R8=9]="R8",r[r.RG8=10]="RG8",Yc;var r})(),sp=(()=>{return(r=sp||(sp={}))[r.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",r[r.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",r[r.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",r[r.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",r[r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",r[r.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",r[r.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",r[r.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",r[r.RGBA8Format=32856]="RGBA8Format",r[r.R8Format=33321]="R8Format",r[r.RG8Format=33323]="RG8Format",sp;var r})();function ro(r){return r?Ie.GetAbsoluteUrl(r):null}function lE(r){null!==r.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=r.wasmUASTCToASTC),null!==r.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=r.wasmUASTCToBC7),null!==r.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=r.wasmUASTCToRGBA_UNORM),null!==r.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=r.wasmUASTCToRGBA_SRGB),null!==r.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=r.wasmUASTCToR8_UNORM),null!==r.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=r.wasmUASTCToRG8_UNORM),null!==r.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=r.jsMSCTranscoder),null!==r.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=r.wasmMSCTranscoder),null!==r.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=r.wasmZSTDDecoder)}class Rn{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(Rn._WorkerPoolPromise||Rn._DecoderModulePromise)return;const t={jsDecoderModule:Ie.GetAbsoluteUrl(this.URLConfig.jsDecoderModule),wasmUASTCToASTC:ro(this.URLConfig.wasmUASTCToASTC),wasmUASTCToBC7:ro(this.URLConfig.wasmUASTCToBC7),wasmUASTCToRGBA_UNORM:ro(this.URLConfig.wasmUASTCToRGBA_UNORM),wasmUASTCToRGBA_SRGB:ro(this.URLConfig.wasmUASTCToRGBA_SRGB),wasmUASTCToR8_UNORM:ro(this.URLConfig.wasmUASTCToR8_UNORM),wasmUASTCToRG8_UNORM:ro(this.URLConfig.wasmUASTCToRG8_UNORM),jsMSCTranscoder:ro(this.URLConfig.jsMSCTranscoder),wasmMSCTranscoder:ro(this.URLConfig.wasmMSCTranscoder),wasmZSTDDecoder:ro(this.URLConfig.wasmZSTDDecoder)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?Rn._WorkerPoolPromise=new Promise(i=>{const s=URL.createObjectURL(new Blob([`${lE}(${T5})()`],{type:"application/javascript"}));i(new ZI(e,()=>new Promise((a,o)=>{const l=new Worker(s),c=h=>{l.removeEventListener("error",c),l.removeEventListener("message",u),o(h)},u=h=>{"init"===h.data.action&&(l.removeEventListener("error",c),l.removeEventListener("message",u),a(l))};l.addEventListener("error",c),l.addEventListener("message",u),l.postMessage({action:"init",urls:t})})))}):"undefined"==typeof KTX2DECODER?Rn._DecoderModulePromise=Ie.LoadScriptAsync(t.jsDecoderModule).then(()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,lE(t),new KTX2DECODER.KTX2Decoder)):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Rn._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=Rn.DefaultNumWorkers){this._engine=e,Rn._Initialize(t)}uploadAsync(e,t,i){const n=this._engine.getCaps(),s={astc:!!n.astc,bptc:!!n.bptc,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,etc1:!!n.etc1};if(Rn._WorkerPoolPromise)return Rn._WorkerPoolPromise.then(a=>new Promise((o,l)=>{a.push((c,u)=>{const h=p=>{c.removeEventListener("error",h),c.removeEventListener("message",d),l(p),u()},d=p=>{if("decoded"===p.data.action){if(c.removeEventListener("error",h),c.removeEventListener("message",d),p.data.success)try{this._createTexture(p.data.decodedData,t,i),o()}catch(g){l({message:g})}else l({message:p.data.msg});u()}};c.addEventListener("error",h),c.addEventListener("message",d),c.postMessage({action:"setDefaultDecoderOptions",options:Rn.DefaultDecoderOptions._getKTX2DecoderOptions()});const f=new Uint8Array(e.byteLength);f.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:f,caps:s,options:i},[f.buffer])})}));if(Rn._DecoderModulePromise)return Rn._DecoderModulePromise.then(a=>(Rn.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=Rn.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((o,l)=>{a.decode(e,n).then(c=>{this._createTexture(c,t),o()}).catch(c=>{l({message:c})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let a=0;a<e.mipmaps.length;++a){const o=e.mipmaps[a];if(!o||!o.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=o.width,t.height=o.height,this._engine._uploadDataToTextureDirectly(t,o.data,0,a,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,o.width,o.height,o.data,0,a)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}function T5(){let r;onmessage=e=>{if(e.data)switch(e.data.action){case"init":{const t=e.data.urls;importScripts(t.jsDecoderModule),lE(t),r=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=e.data.options;break;case"decode":r.decode(e.data.data,e.data.caps,e.data.options).then(t=>{const i=[];for(let n=0;n<t.mipmaps.length;++n){const s=t.mipmaps[n];s&&s.data&&i.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:t},i)}).catch(t=>{postMessage({action:"decoded",success:!1,msg:t})})}}}function cE(r){let e=0;return{id_length:r[e++],colormap_type:r[e++],image_type:r[e++],colormap_index:r[e++]|r[e++]<<8,colormap_length:r[e++]|r[e++]<<8,colormap_size:r[e++],origin:[r[e++]|r[e++]<<8,r[e++]|r[e++]<<8],width:r[e++]|r[e++]<<8,height:r[e++]|r[e++]<<8,pixel_size:r[e++],flags:r[e++]}}function Lw(r,e){if(e.length<19)return void H.Error("Unable to load TGA file - Not enough data to contain header");let t=18;const i=cE(e);if(i.id_length+t>e.length)return void H.Error("Unable to load TGA file - Not enough data");t+=i.id_length;let o,n=!1,s=!1,a=!1;switch(i.image_type){case 9:n=!0;case 1:s=!0;break;case 10:n=!0;case 2:break;case 11:n=!0;case 3:a=!0}const l=i.pixel_size>>3,c=i.width*i.height*l;let u,h,d,f,p,g,_;if(s&&(u=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),n){o=new Uint8Array(c);let A,S,x,C=0;const R=new Uint8Array(l);for(;t<c&&C<c;)if(A=e[t++],S=1+(127&A),128&A){for(x=0;x<l;++x)R[x]=e[t++];for(x=0;x<S;++x)o.set(R,C+x*l);C+=l*S}else{for(S*=l,x=0;x<S;++x)o[C+x]=e[t++];C+=S}}else o=e.subarray(t,t+=s?i.width*i.height:c);switch((48&i.flags)>>4){default:case 2:h=0,f=1,_=i.width,d=0,p=1,g=i.height;break;case 0:h=0,f=1,_=i.width,d=i.height-1,p=-1,g=-1;break;case 3:h=i.width-1,f=-1,_=-1,d=0,p=1,g=i.height;break;case 1:h=i.width-1,f=-1,_=-1,d=i.height-1,p=-1,g=-1}const T=V5["_getImageData"+(a?"Grey":"")+i.pixel_size+"bits"](i,u,o,d,p,g,h,f,_);r.getEngine()._uploadDataToTextureDirectly(r,T)}Rn.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},Rn.DefaultNumWorkers=Rn.GetDefaultNumWorkers(),Rn.DefaultDecoderOptions=new class m5{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[Yc.BC1_RGB,Yc.BC3_RGBA],yes:{transcodeFormat:Yc.RGBA32,engineFormat:sp.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}},Ve._TextureLoaders.unshift(new class v5{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||"image/ktx"===t||"image/ktx2"===t}loadCubeData(e,t,i,n){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const s=t.getEngine(),a=new oE(e,6),o=a.numberOfMipmapLevels>1&&t.generateMipMaps;s._unpackFlipY(!0),a.uploadLevels(t,t.generateMipMaps),t.width=a.pixelWidth,t.height=a.pixelHeight,s._setCubeMapTextureParams(t,o,a.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}loadData(e,t,i,n){if(oE.IsValid(e)){t._invertVScale=!t.invertY;const s=new oE(e,1),a=function E5(r){switch(r){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);a?(t.format=a,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,()=>{s.uploadLevels(t,t.generateMipMaps)},s.isInvalid)}else Rn.IsValid(e)?new Rn(t.getEngine()).uploadAsync(e,t,n).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},a=>{H.Warn(`Failed to load KTX2 texture data: ${a.message}`),i(0,0,!1,!1,()=>{},!0)}):(H.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}});const V5={GetTGAHeader:cE,UploadContent:Lw,_getImageData8bits:function O5(r,e,t,i,n,s,a,o,l){const c=t,u=e,h=r.width;let f,g,_,p=0;const m=new Uint8Array(h*r.height*4);for(_=i;_!==s;_+=n)for(g=a;g!==l;g+=o,p++)f=c[p],m[4*(g+h*_)+3]=255,m[4*(g+h*_)+2]=u[3*f+0],m[4*(g+h*_)+1]=u[3*f+1],m[4*(g+h*_)+0]=u[3*f+2];return m},_getImageData16bits:function F5(r,e,t,i,n,s,a,o,l){const c=t,u=r.width;let d,p,g,f=0;const _=new Uint8Array(u*r.height*4);for(g=i;g!==s;g+=n)for(p=a;p!==l;p+=o,f+=2){d=c[f+0]+(c[f+1]<<8);const T=255*((992&d)>>5)/31|0,v=255*(31&d)/31|0;_[4*(p+u*g)+0]=255*((31744&d)>>10)/31|0,_[4*(p+u*g)+1]=T,_[4*(p+u*g)+2]=v,_[4*(p+u*g)+3]=32768&d?0:255}return _},_getImageData24bits:function N5(r,e,t,i,n,s,a,o,l){const c=t,u=r.width;let f,p,d=0;const g=new Uint8Array(u*r.height*4);for(p=i;p!==s;p+=n)for(f=a;f!==l;f+=o,d+=3)g[4*(f+u*p)+3]=255,g[4*(f+u*p)+2]=c[d+0],g[4*(f+u*p)+1]=c[d+1],g[4*(f+u*p)+0]=c[d+2];return g},_getImageData32bits:function L5(r,e,t,i,n,s,a,o,l){const c=t,u=r.width;let f,p,d=0;const g=new Uint8Array(u*r.height*4);for(p=i;p!==s;p+=n)for(f=a;f!==l;f+=o,d+=4)g[4*(f+u*p)+2]=c[d+0],g[4*(f+u*p)+1]=c[d+1],g[4*(f+u*p)+0]=c[d+2],g[4*(f+u*p)+3]=c[d+3];return g},_getImageDataGrey8bits:function B5(r,e,t,i,n,s,a,o,l){const c=t,u=r.width;let d,p,g,f=0;const _=new Uint8Array(u*r.height*4);for(g=i;g!==s;g+=n)for(p=a;p!==l;p+=o,f++)d=c[f],_[4*(p+u*g)+0]=d,_[4*(p+u*g)+1]=d,_[4*(p+u*g)+2]=d,_[4*(p+u*g)+3]=255;return _},_getImageDataGrey16bits:function U5(r,e,t,i,n,s,a,o,l){const c=t,u=r.width;let f,p,d=0;const g=new Uint8Array(u*r.height*4);for(p=i;p!==s;p+=n)for(f=a;f!==l;f+=o,d+=2)g[4*(f+u*p)+0]=c[d+0],g[4*(f+u*p)+1]=c[d+0],g[4*(f+u*p)+2]=c[d+0],g[4*(f+u*p)+3]=c[d+1];return g}};Ve._TextureLoaders.push(new class k5{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=cE(n);i(s.width,s.height,t.generateMipMaps,!1,()=>{Lw(t,n)})}}),Ve._TextureLoaders.push(new class G5{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=QT.RGBE_ReadHeader(n),a=QT.RGBE_ReadPixels(n,s),o=s.width*s.height,l=new Float32Array(4*o);for(let c=0;c<o;c+=1)l[4*c]=a[3*c],l[4*c+1]=a[3*c+1],l[4*c+2]=a[3*c+2],l[4*c+3]=1;i(s.width,s.height,t.generateMipMaps,!1,()=>{const c=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,c._uploadDataToTextureDirectly(t,l)})}});var Da=(()=>{return(r=Da||(Da={}))[r.cTFETC1=0]="cTFETC1",r[r.cTFETC2=1]="cTFETC2",r[r.cTFBC1=2]="cTFBC1",r[r.cTFBC3=3]="cTFBC3",r[r.cTFBC4=4]="cTFBC4",r[r.cTFBC5=5]="cTFBC5",r[r.cTFBC7=6]="cTFBC7",r[r.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",r[r.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",r[r.cTFASTC_4x4=10]="cTFASTC_4x4",r[r.cTFATC_RGB=11]="cTFATC_RGB",r[r.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",r[r.cTFRGBA32=13]="cTFRGBA32",r[r.cTFRGB565=14]="cTFRGB565",r[r.cTFBGR565=15]="cTFBGR565",r[r.cTFRGBA4444=16]="cTFRGBA4444",r[r.cTFFXT1_RGB=17]="cTFFXT1_RGB",r[r.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",r[r.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",r[r.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",r[r.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11",Da;var r})();const zo={JSModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.wasm"};let uE=null,Pa=null,z5=0;const hE=(r,e)=>{const t=r instanceof ArrayBuffer?new Uint8Array(r):r;return new Promise((i,n)=>{(uE||(uE=new Promise((r,e)=>{Pa?r(Pa):Ie.LoadFileAsync(zo.WasmModuleURL).then(t=>{if("function"!=typeof URL)return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${Y5})()`],{type:"application/javascript"}));Pa=new Worker(i);const n=s=>{"init"===s.data.action?(Pa.removeEventListener("message",n),r(Pa)):"error"===s.data.action&&e(s.data.error||"error initializing worker")};Pa.addEventListener("message",n),Pa.postMessage({action:"init",url:zo.JSModuleURL,wasmBinary:t})}).catch(e)})),uE).then(()=>{const s=z5++,a=l=>{"transcode"===l.data.action&&l.data.id===s&&(Pa.removeEventListener("message",a),l.data.success?i(l.data):n("Transcode is not supported on this device"))};Pa.addEventListener("message",a);const o=new Uint8Array(t.byteLength);o.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),Pa.postMessage({action:"transcode",id:s,imageData:o,config:e,ignoreSupportedFormats:!1},[o.buffer])},s=>{n(s)})})},ap=(r,e)=>{var t,i;let n=null===(t=e._gl)||void 0===t?void 0:t.TEXTURE_2D;r.isCube&&(n=null===(i=e._gl)||void 0===i?void 0:i.TEXTURE_CUBE_MAP),e._bindTextureDirectly(n,r,!0)},dE=(r,e)=>{const t=r.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const n=e.fileInfo.images[i].levels[0];if(r._invertVScale=r.invertY,-1===e.format||e.format===Da.cTFRGB565)if(r.type=10,r.format=4,!t._features.basisNeedsPOT||Se.Log2(n.width)%1==0&&Se.Log2(n.height)%1==0)r._invertVScale=!r.invertY,r.width=n.width+3&-4,r.height=n.height+3&-4,r.samplingMode=2,ap(r,t),t._uploadDataToTextureDirectly(r,new Uint16Array(n.transcodedPixels.buffer),i,0,4,!0);else{const s=new hi(t,vt.Temp);r._invertVScale=r.invertY,s.type=10,s.format=4,s.width=n.width+3&-4,s.height=n.height+3&-4,ap(s,t),t._uploadDataToTextureDirectly(s,new Uint16Array(n.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(s,r,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(s),ap(r,t)})}else{r.width=n.width,r.height=n.height,r.generateMipMaps=e.fileInfo.images[i].levels.length>1;const s=fE.GetInternalFormatFromBasisFormat(e.format,t);r.format=s,ap(r,t),e.fileInfo.images[i].levels.forEach((a,o)=>{t._uploadCompressedDataToTextureDirectly(r,s,a.width,a.height,a.transcodedPixels,i,o)}),t._features.basisNeedsPOT&&(Se.Log2(r.width)%1!=0||Se.Log2(r.height)%1!=0)&&(Ie.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),r._cachedWrapU=j.CLAMP_ADDRESSMODE,r._cachedWrapV=j.CLAMP_ADDRESSMODE)}}},fE={JSModuleURL:zo.JSModuleURL,WasmModuleURL:zo.WasmModuleURL,GetInternalFormatFromBasisFormat:(r,e)=>{let t;switch(r){case Da.cTFETC1:t=36196;break;case Da.cTFBC1:t=33776;break;case Da.cTFBC4:t=33779;break;case Da.cTFASTC_4x4:t=37808;break;case Da.cTFETC2:t=37496;break;case Da.cTFBC7:t=36492}if(void 0===t)throw"The chosen Basis transcoder format is not currently supported";return t},TranscodeAsync:hE,LoadTextureFromTranscodeResult:dE};function Y5(){let e=null;function n(a,o,l,c,u){const h=a.getImageTranscodedSizeInBytes(o,l,c);let d=new Uint8Array(h);return a.transcodeImage(d,o,l,c,1,0)?(u&&(d=function s(a,o,l,c){const u=new Uint16Array(4),h=new Uint16Array(l*c),d=l/4,f=c/4;for(let p=0;p<f;p++)for(let g=0;g<d;g++){const _=o+8*(p*d+g);u[0]=a[_]|a[_+1]<<8,u[1]=a[_+2]|a[_+3]<<8,u[2]=(2*(31&u[0])+1*(31&u[1]))/3|(2*(2016&u[0])+1*(2016&u[1]))/3&2016|(2*(63488&u[0])+1*(63488&u[1]))/3&63488,u[3]=(2*(31&u[1])+1*(31&u[0]))/3|(2*(2016&u[1])+1*(2016&u[0]))/3&2016|(2*(63488&u[1])+1*(63488&u[0]))/3&63488;for(let m=0;m<4;m++){const T=a[_+4+m];let v=(4*p+m)*l+4*g;h[v++]=u[3&T],h[v++]=u[T>>2&3],h[v++]=u[T>>4&3],h[v++]=u[T>>6&3]}}return h}(d,0,a.getImageWidth(o,l)+3&-4,a.getImageHeight(o,l)+3&-4)),d):null}onmessage=a=>{if("init"===a.data.action){if(!e){try{importScripts(a.data.url)}catch(o){postMessage({action:"error",error:o})}e=BASIS({wasmBinary:a.data.wasmBinary})}null!==e&&e.then(o=>{BASIS=o,o.initializeBasis(),postMessage({action:"init"})})}else if("transcode"===a.data.action){const o=a.data.config,c=new BASIS.BasisFile(a.data.imageData),u=function i(a){const o=a.getHasAlpha(),l=a.getNumImages(),c=[];for(let h=0;h<l;h++){const d={levels:[]},f=a.getNumLevels(h);for(let p=0;p<f;p++){const g={width:a.getImageWidth(h,p),height:a.getImageHeight(h,p)};d.levels.push(g)}c.push(d)}return{hasAlpha:o,images:c}}(c);let h=a.data.ignoreSupportedFormats?null:function t(a,o){let l=null;return a.supportedCompressionFormats&&(l=a.supportedCompressionFormats.astc?10:a.supportedCompressionFormats.bc7?6:a.supportedCompressionFormats.s3tc?o.hasAlpha?3:2:a.supportedCompressionFormats.pvrtc?o.hasAlpha?9:8:a.supportedCompressionFormats.etc2?1:a.supportedCompressionFormats.etc1?0:14),l}(a.data.config,u),d=!1;null===h&&(d=!0,h=u.hasAlpha?3:2);let f=!0;c.startTranscoding()||(f=!1);const p=[];for(let g=0;g<u.images.length&&f;g++){const _=u.images[g];if(void 0===o.loadSingleImage||o.loadSingleImage===g){let m=_.levels.length;!1===o.loadMipmapLevels&&(m=1);for(let T=0;T<m;T++){const v=_.levels[T],A=n(c,g,T,h,d);if(!A){f=!1;break}v.transcodedPixels=A,p.push(v.transcodedPixels.buffer)}}}c.close(),c.delete(),d&&(h=-1),f?postMessage({action:"transcode",success:f,id:a.data.id,fileInfo:u,format:h},p):postMessage({action:"transcode",success:f,id:a.data.id})}}}Object.defineProperty(fE,"JSModuleURL",{get:function(){return zo.JSModuleURL},set:function(r){zo.JSModuleURL=r}}),Object.defineProperty(fE,"WasmModuleURL",{get:function(){return zo.WasmModuleURL},set:function(r){zo.WasmModuleURL=r}}),Ve._TextureLoaders.push(new class j5{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,n,s){if(Array.isArray(e))return;const a=t.getEngine().getCaps();hE(e,{supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2,astc:!!a.astc,bc7:!!a.bptc}}).then(l=>{const c=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;dE(t,l),t.getEngine()._setCubeMapTextureParams(t,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}).catch(l=>{Ie.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,s&&s(l)})}loadData(e,t,i){const n=t.getEngine().getCaps();hE(e,{supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}}).then(a=>{const o=a.fileInfo.images[0].levels[0];i(o.width,o.height,a.fileInfo.images[0].levels.length>1&&t.generateMipMaps,-1!==a.format,()=>{dE(t,a)})}).catch(a=>{Ie.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),Ie.Warn(`Failed to transcode Basis file: ${a}`),i(0,0,!1,!1,()=>{},!0)})}});class pE extends ir{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();!e||(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,n,s=0,a=j.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,n,!0,s,!1,a,o),this.mirrorPlane=new ss(0,1,0,1),this._transformMatrix=B.Zero(),this._mirrorMatrix=B.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});const l=i.getEngine();let c;l.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{var u;null===(u=l._debugPushGroup)||void 0===u||u.call(l,`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{var u;null===(u=l._debugPopGroup)||void 0===u||u.call(l,1)}),this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),B.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=E.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new dr("horizontal blur",new We(1,0),this._blurKernelX,this._blurRatio,null,j.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new dr("vertical blur",new We(0,1),this._blurKernelY,this._blurRatio,null,j.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new pE(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),null===(e=this._sceneUBO)||void 0===e||e.dispose()}}j._CreateMirror=(r,e,t,i)=>new pE(r,e,t,i),Ze.prototype.restoreSingleAttachment=function(){this.bindAttachments([this._gl.BACK])},Ze.prototype.restoreSingleAttachmentForRenderTarget=function(){this.bindAttachments([this._gl.COLOR_ATTACHMENT0])},Ze.prototype.buildTextureLayout=function(r){const e=this._gl,t=[];for(let i=0;i<r.length;i++)t.push(r[i]?e["COLOR_ATTACHMENT"+i]:e.NONE);return t},Ze.prototype.bindAttachments=function(r){this._gl.drawBuffers(r)},Ze.prototype.unBindMultiColorAttachmentFramebuffer=function(r,e=!1,t){this._currentRenderTarget=null;const i=this._gl,n=r._attachments,s=n.length;if(r._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,r._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,r._framebuffer);for(let a=0;a<s;a++){const o=r.textures[a];for(let l=0;l<s;l++)n[l]=i.NONE;n[a]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],i.readBuffer(n[a]),i.drawBuffers(n),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let a=0;a<s;a++)n[a]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"];i.drawBuffers(n)}for(let a=0;a<s;a++){const o=r.textures[a];(null==o?void 0:o.generateMipMaps)&&!e&&!o.isCube&&(this._bindTextureDirectly(i.TEXTURE_2D,o,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),t()),this._bindUnboundFramebuffer(null)},Ze.prototype.createMultipleRenderTarget=function(r,e,t=!0){var i;let n=!1,s=!0,a=!1,o=!1,l=15,c=1,g=new Array,_=new Array,m=new Array,T=new Array,v=new Array,A=new Array,S=new Array,x=new Array;const C=this._createHardwareRenderTargetWrapper(!0,!1,r);void 0!==e&&(n=void 0!==e.generateMipMaps&&e.generateMipMaps,s=void 0===e.generateDepthBuffer||e.generateDepthBuffer,a=void 0!==e.generateStencilBuffer&&e.generateStencilBuffer,o=void 0!==e.generateDepthTexture&&e.generateDepthTexture,c=e.textureCount||1,e.types&&(g=e.types),e.samplingModes&&(_=e.samplingModes),e.useSRGBBuffers&&(m=e.useSRGBBuffers),e.formats&&(T=e.formats),e.targetTypes&&(v=e.targetTypes),e.faceIndex&&(A=e.faceIndex),e.layerIndex&&(S=e.layerIndex),e.layerCounts&&(x=e.layerCounts),this.webGLVersion>1&&(13===e.depthTextureFormat||17===e.depthTextureFormat||16===e.depthTextureFormat||14===e.depthTextureFormat||18===e.depthTextureFormat)&&(l=e.depthTextureFormat));const R=this._gl,D=R.createFramebuffer();this._bindUnboundFramebuffer(D);const P=r.width||r,N=r.height||r,k=[],X=[],ne=this.webGLVersion>1&&o&&(13===e.depthTextureFormat||17===e.depthTextureFormat||18===e.depthTextureFormat),ge=this._setupFramebufferDepthAttachments(!ne&&a,!o&&s,P,N);C._framebuffer=D,C._depthStencilBuffer=ge,C._generateDepthBuffer=!o&&s,C._generateStencilBuffer=!ne&&a,C._attachments=X;for(let ue=0;ue<c;ue++){let ke=_[ue]||3,me=g[ue]||0,$=m[ue]||!1;const Q=T[ue]||5,w=v[ue]||3553,Y=null!==(i=x[ue])&&void 0!==i?i:1;(1===me&&!this._caps.textureFloatLinearFiltering||2===me&&!this._caps.textureHalfFloatLinearFiltering)&&(ke=1);const se=this._getSamplingParameters(ke,n);1===me&&!this._caps.textureFloat&&(me=0,H.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),$=$&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const Re=this.webGLVersion>1;if(X.push(R[Re?"COLOR_ATTACHMENT"+ue:"COLOR_ATTACHMENT"+ue+"_WEBGL"]),-1===w)continue;const $e=new hi(this,vt.MultiRenderTarget);k[ue]=$e,R.activeTexture(R["TEXTURE"+ue]),R.bindTexture(w,$e._hardwareTexture.underlyingResource),R.texParameteri(w,R.TEXTURE_MAG_FILTER,se.mag),R.texParameteri(w,R.TEXTURE_MIN_FILTER,se.min),R.texParameteri(w,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(w,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE);const _e=this._getRGBABufferInternalSizedFormat(me,Q,$),Xe=this._getInternalFormat(Q),Xt=this._getWebGLTextureType(me);if(!Re||35866!==w&&32879!==w)if(34067===w){for(let ti=0;ti<6;ti++)R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X+ti,0,_e,P,N,0,Xe,Xt,null);$e.isCube=!0}else R.texImage2D(R.TEXTURE_2D,0,_e,P,N,0,Xe,Xt,null);else 35866===w?$e.is2DArray=!0:$e.is3D=!0,$e.baseDepth=$e.depth=Y,R.texImage3D(w,0,_e,P,N,Y,0,Xe,Xt,null);n&&R.generateMipmap(w),this._bindTextureDirectly(w,null),$e.baseWidth=P,$e.baseHeight=N,$e.width=P,$e.height=N,$e.isReady=!0,$e.samples=1,$e.generateMipMaps=n,$e.samplingMode=ke,$e.type=me,$e._useSRGBBuffer=$,$e.format=Q,this._internalTexturesCache.push($e)}if(o&&this._caps.depthTextureExtension){const ue=new hi(this,vt.Depth);let ke=5,me=R.DEPTH_COMPONENT16,$=R.DEPTH_COMPONENT,Q=R.UNSIGNED_SHORT,w=R.DEPTH_ATTACHMENT;this.webGLVersion<2?me=R.DEPTH_COMPONENT:14===l?(ke=1,Q=R.FLOAT,me=R.DEPTH_COMPONENT32F):18===l?(ke=0,Q=R.FLOAT_32_UNSIGNED_INT_24_8_REV,me=R.DEPTH32F_STENCIL8,$=R.DEPTH_STENCIL,w=R.DEPTH_STENCIL_ATTACHMENT):16===l?(ke=0,Q=R.UNSIGNED_INT,me=R.DEPTH_COMPONENT24,w=R.DEPTH_ATTACHMENT):(13===l||17===l)&&(ke=12,Q=R.UNSIGNED_INT_24_8,me=R.DEPTH24_STENCIL8,$=R.DEPTH_STENCIL,w=R.DEPTH_STENCIL_ATTACHMENT),R.activeTexture(R.TEXTURE0),R.bindTexture(R.TEXTURE_2D,ue._hardwareTexture.underlyingResource),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_MAG_FILTER,R.NEAREST),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_MIN_FILTER,R.NEAREST),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),R.texImage2D(R.TEXTURE_2D,0,me,P,N,0,$,Q,null),R.framebufferTexture2D(R.FRAMEBUFFER,w,R.TEXTURE_2D,ue._hardwareTexture.underlyingResource,0),ue.baseWidth=P,ue.baseHeight=N,ue.width=P,ue.height=N,ue.isReady=!0,ue.samples=1,ue.generateMipMaps=n,ue.samplingMode=1,ue.format=l,ue.type=ke,k[c]=ue,this._internalTexturesCache.push(ue)}return C.setTextures(k),t&&R.drawBuffers(X),this._bindUnboundFramebuffer(null),C.setLayerAndFaceIndices(S,A),this.resetTextureCache(),C},Ze.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,e,t=!0){if(this.webGLVersion<2||!r||!r.texture)return 1;if(r.samples===e)return e;const i=r._attachments.length;if(0===i)return 1;const n=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples);const s=!!r._depthStencilBuffer;if(s&&(n.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(n.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null),e>1&&"function"==typeof n.renderbufferStorageMultisample){const a=n.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);const o=[];for(let l=0;l<i;l++)r.textures[l]._hardwareTexture.releaseMSAARenderBuffers();for(let l=0;l<i;l++){const c=r.textures[l],u=c._hardwareTexture,h=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBAMultiSampleBufferFormat(c.type),h);if(!d)throw new Error("Unable to create multi sampled framebuffer");u.addMSAARenderBuffer(d),c.samples=e,o.push(h)}t&&n.drawBuffers(o)}else this._bindUnboundFramebuffer(r._framebuffer);return s&&(r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.texture.width,r.texture.height,e)),this._bindUnboundFramebuffer(null),e};class $5{constructor(e){this.name=Bi.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=new Array}register(){this.scene._beforeClearStage.registerStep(Bi.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){Ie.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}Ie.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}Z.ShadersStore.proceduralVertexShader="attribute vec2 position;\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class wa extends j{constructor(e,t,i,n,s=null,a=!0,o=!1,l=0){super(null,n,!a),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new J,this.onBeforeGenerationObservable=new J,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null;let c=(n=this.getScene()||Je.LastCreatedScene)._getComponent(Bi.NAME_PROCEDURALTEXTURE);c||(c=new $5(n),n._addComponent(c)),n.proceduralTextures.push(this),this._fullEngine=n.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=a,this._drawWrapper=new Qs(this._fullEngine),this.setFragment(i),this._fallbackTexture=s;const u=this._createRtWrapper(o,t,a,l);this._texture=u.texture;const h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1),this._vertexBuffers[I.PositionKind]=new I(this._fullEngine,h,I.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,n){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:n}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:n}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[I.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===ir.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=ir.REFRESHRATE_RENDER_ONCE)}reset(){var e;null===(e=this._drawWrapper.effect)||void 0===e||e.dispose()}_getDefines(){return""}isReady(){const e=this._fullEngine;let t;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const i=this._getDefines();return!(!this._drawWrapper.effect||i!==this._cachedDefines||!this._drawWrapper.effect.isReady())||(t=void 0!==this._fragment.fragmentElement?{vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:{vertex:"procedural",fragment:this._fragment},this._cachedDefines!==i&&(this._cachedDefines=i,this._drawWrapper.effect=e.createEffect(t,[I.PositionKind],this._uniforms,this._samplers,i,void 0,void 0,()=>{var n;null===(n=this._rtWrapper)||void 0===n||n.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)):(this._texture&&(this._texture.isReady=!1),!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const n=this._createRtWrapper(i,e,t,this._textureType);this._texture=n.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){-1===this._uniforms.indexOf(e)&&this._uniforms.push(e)}setTexture(e,t){return-1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const n=this.getScene();if(!n)return;const s=this._fullEngine;if(s.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),s.setState(!1),!this.nodeMaterialSource){for(const o in this._textures)this._drawWrapper.effect.setTexture(o,this._textures[o]);for(const o in this._ints)this._drawWrapper.effect.setInt(o,this._ints[o]);for(const o in this._floats)this._drawWrapper.effect.setFloat(o,this._floats[o]);for(const o in this._floatsArrays)this._drawWrapper.effect.setArray(o,this._floatsArrays[o]);for(const o in this._colors3)this._drawWrapper.effect.setColor3(o,this._colors3[o]);for(const o in this._colors4){const l=this._colors4[o];this._drawWrapper.effect.setFloat4(o,l.r,l.g,l.b,l.a)}for(const o in this._vectors2)this._drawWrapper.effect.setVector2(o,this._vectors2[o]);for(const o in this._vectors3)this._drawWrapper.effect.setVector3(o,this._vectors3[o]);for(const o in this._matrices)this._drawWrapper.effect.setMatrix(o,this._matrices[o])}if(!this._texture||!this._rtWrapper)return;null===(t=s._debugPushGroup)||void 0===t||t.call(s,`procedural texture generation for ${this.name}`,1);const a=s.currentViewport;if(this.isCube)for(let o=0;o<6;o++)s.bindFramebuffer(this._rtWrapper,o,void 0,void 0,!0),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",o),this.autoClear&&s.clear(n.clearColor,!0,!1,!1),s.drawElementsType(le.TriangleFillMode,0,6);else s.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&s.clear(n.clearColor,!0,!1,!1),s.drawElementsType(le.TriangleFillMode,0,6);s.unBindFramebuffer(this._rtWrapper,this.isCube),a&&s.setViewport(a),this.isCube&&s.generateMipMapsForCubemap(this._texture),null===(i=s._debugPopGroup)||void 0===i||i.call(s,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new wa(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[I.PositionKind];i&&(i.dispose(),this._vertexBuffers[I.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}b([O()],wa.prototype,"isEnabled",void 0),b([O()],wa.prototype,"autoClear",void 0),b([O()],wa.prototype,"_generateMipMaps",void 0),b([O()],wa.prototype,"_size",void 0),b([O()],wa.prototype,"refreshRate",null),ye("BABYLON.ProceduralTexture",wa);Z.ShadersStore.noisePixelShader="uniform float brightness;\nuniform float persistence;\nuniform float timeScale;\nvarying vec2 vUV;\nvec2 hash22(vec2 p)\n{\np=p*mat2(127.1,311.7,269.5,183.3);\np=-1.0+2.0*fract(sin(p)*43758.5453123);\nreturn sin(p*6.283+timeScale);\n}\nfloat interpolationNoise(vec2 p)\n{\nvec2 pi=floor(p);\nvec2 pf=p-pi;\nvec2 w=pf*pf*(3.-2.*pf);\nfloat f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));\nfloat f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));\nfloat f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));\nfloat f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));\nfloat xm1=mix(f00,f10,w.x);\nfloat xm2=mix(f01,f11,w.x);\nfloat ym=mix(xm1,xm2,w.y); \nreturn ym;\n}\nfloat perlinNoise2D(float x,float y)\n{\nfloat sum=0.0;\nfloat frequency=0.0;\nfloat amplitude=0.0;\nfor(int i=0; i<OCTAVES; i++)\n{\nfrequency=pow(2.0,float(i));\namplitude=pow(persistence,float(i));\nsum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;\n}\nreturn sum;\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat x=abs(vUV.x);\nfloat y=abs(vUV.y);\nfloat noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);\ngl_FragColor=vec4(noise,noise,noise,1.0);\n}\n";class op extends wa{constructor(e,t=256,i=Je.LastCreatedScene,n,s){super(e,t,"noise",i,n,s),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();!e||(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(0|this.octaves)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={customType:"BABYLON.NoiseProceduralTexture"};return e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new op(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){var i;const n=new op(e.name,e.size,t,void 0,e.generateMipMaps);return n.brightness=e.brightness,n.octaves=e.octaves,n.persistence=e.persistence,n.animationSpeedFactor=e.animationSpeedFactor,n.time=null!==(i=e.time)&&void 0!==i?i:0,n}}ye("BABYLON.NoiseProceduralTexture",op);class ea extends j{constructor(e,t,i,n,s,a=!0,o=!1,l=3,c=0,u,h){super(null,s,!a,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=n,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&1===c&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&2===c&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,n,a,o,l,null,c,null!=u?u:0,null!=h&&h),this.wrapU=j.CLAMP_ADDRESSMODE,this.wrapV=j.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,n,s=!0,a=!1,o=3){return new ea(e,t,i,1,n,s,a,o)}static CreateLuminanceAlphaTexture(e,t,i,n,s=!0,a=!1,o=3){return new ea(e,t,i,2,n,s,a,o)}static CreateAlphaTexture(e,t,i,n,s=!0,a=!1,o=3){return new ea(e,t,i,0,n,s,a,o)}static CreateRGBTexture(e,t,i,n,s=!0,a=!1,o=3,l=0,c=0,u=!1){return new ea(e,t,i,4,n,s,a,o,l,c,u)}static CreateRGBATexture(e,t,i,n,s=!0,a=!1,o=3,l=0,c=0,u=!1){return new ea(e,t,i,5,n,s,a,o,l,c,u)}static CreateRGBAStorageTexture(e,t,i,n,s=!0,a=!1,o=3,l=0,c=!1){return new ea(e,t,i,5,n,s,a,o,l,1,c)}static CreateRTexture(e,t,i,n,s=!0,a=!1,o=j.TRILINEAR_SAMPLINGMODE,l=1){return new ea(e,t,i,6,n,s,a,o,l)}static CreateRStorageTexture(e,t,i,n,s=!0,a=!1,o=j.TRILINEAR_SAMPLINGMODE,l=1){return new ea(e,t,i,6,n,s,a,o,l,1)}}class gE extends j{get depth(){return this._depth}constructor(e,t,i,n,s,a,o=!0,l=!1,c=j.TRILINEAR_SAMPLINGMODE,u=0){super(null,a,!o,l),this.format=s,this._texture=a.getEngine().createRawTexture2DArray(e,t,i,n,s,o,l,c,null,u),this._depth=n,this.is2DArray=!0}update(e){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,n,s,a=!0,o=!1,l=3,c=0){return new gE(e,t,i,n,5,s,a,o,l,c)}}function zw(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.srcObject=null,r.src="",r.removeAttribute("src")}class jc extends j{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new J),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(null==e?void 0:e.message):H.Error(null==e?void 0:e.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if("NotAllowedError"===(null==e?void 0:e.name)){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers())return void this._onUserActionRequestedObservable.notifyObservers(this);if(!this.video.muted)return H.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,void this.video.play().catch(t=>{this._processError(t)})}this._processError(e)})}constructor(e,t,i,n=!1,s=!1,a=j.TRILINEAR_SAMPLINGMODE,o={},l,c=5){var u,h;super(null,i,!n,s),this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this._resizeInternalTexture=()=>{var f;null!=this._texture&&this._texture.dispose(),!this._getEngine().needPOTTextures||Ie.IsExponentOfTwo(this.video.videoWidth)&&Ie.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=j.WRAP_ADDRESSMODE,this.wrapV=j.WRAP_ADDRESSMODE):(this.wrapU=j.CLAMP_ADDRESSMODE,this.wrapV=j.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=null!==(f=this._format)&&void 0!==f?f:5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(null!=this._texture){if(!this._displayingPosterTexture)return;this._displayingPosterTexture=!1}if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),this.video.autoplay||this._settings.poster||this._settings.independentVideoSource)this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{const f=this.video.onplaying,p=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=p,this.video.onplaying=f,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}},this._reset=()=>{null!=this._texture&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(null==this._texture||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;const f=this.getScene().getFrameId();this._frameId!==f&&(this._frameId=f,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings=Mi({autoPlay:!0,loop:!0,autoUpdateTexture:!0},o),this._onError=l,this._generateMipMaps=n,this._initialSamplingMode=a,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t),this._externalTexture=null!==(h=null===(u=this._engine)||void 0===u?void 0:u.createExternalTexture(this.video))&&void 0!==h?h:null,this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),void 0!==this._settings.autoPlay&&(this.video.autoplay=this._settings.autoPlay),void 0!==this._settings.loop&&(this.video.loop=this._settings.loop),void 0!==this._settings.muted&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=c;const d=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this._settings.poster||this._settings.autoPlay&&d?d&&this._createInternalTexture():(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0)}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:"object"==typeof e?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return Ie.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return"string"==typeof e?(Ie.SetCorsBehavior(e,t),t.src=e):(Ie.SetCorsBehavior(e[0],t),e.forEach(i=>{const n=document.createElement("source");n.src=i,t.appendChild(n)})),this.onDisposeObservable.addOnce(()=>{zw(t)}),t}_rebuild(){this.update()}update(){!this.autoUpdateTexture||this.updateTexture(!0)}updateTexture(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new jc(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){var e;super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),null===(e=this._externalTexture)||void 0===e||e.dispose()}static CreateFromStreamAsync(e,t,i,n=!0){const s=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(s),s.style.transform="scale(0.0001, 0.0001)",s.style.opacity="0",s.style.position="fixed",s.style.bottom="0px",s.style.right="0px"),s.setAttribute("autoplay",""),s.setAttribute("muted","true"),s.setAttribute("playsinline",""),s.muted=!0,s.isNative||(void 0!==s.mozSrcObject?s.mozSrcObject=t:"object"==typeof s.srcObject?s.srcObject=t:s.src=window.URL&&window.URL.createObjectURL(t)),new Promise(a=>{const o=()=>{const l=new jc("video",s,e,!0,n,void 0,void 0,void 0,4);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{s.remove()}),l.onDisposeObservable.addOnce(()=>{zw(s)}),a(l),s.removeEventListener("playing",o)};s.addEventListener("playing",o),s.play()})}static CreateFromWebCamAsync(e,t){var i=this;return ls(function*(n,s,a=!1,o=!0){if(navigator.mediaDevices){const l=yield navigator.mediaDevices.getUserMedia({video:s,audio:a}),c=yield i.CreateFromStreamAsync(n,l,s,o);return c.onDisposeObservable.addOnce(()=>{l.getTracks().forEach(u=>{u.stop()})}),c}return Promise.reject("No support for userMedia on this device")}).apply(this,arguments)}static CreateFromWebCam(e,t,i,n=!1,s=!0){this.CreateFromWebCamAsync(e,i,n,s).then(function(a){t&&t(a)}).catch(function(a){H.Error(a.name)})}}var F=(()=>{return(r=F||(F={}))[r.Vertex=1]="Vertex",r[r.Fragment=2]="Fragment",r[r.Neutral=4]="Neutral",r[r.VertexAndFragment=3]="VertexAndFragment",F;var r})(),y=(()=>{return(r=y||(y={}))[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Vector2=4]="Vector2",r[r.Vector3=8]="Vector3",r[r.Vector4=16]="Vector4",r[r.Color3=32]="Color3",r[r.Color4=64]="Color4",r[r.Matrix=128]="Matrix",r[r.Object=256]="Object",r[r.AutoDetect=1024]="AutoDetect",r[r.BasedOnInput=2048]="BasedOnInput",r[r.All=4095]="All",y;var r})(),Ln=(()=>{return(r=Ln||(Ln={}))[r.Uniform=0]="Uniform",r[r.Attribute=1]="Attribute",r[r.Varying=2]="Varying",r[r.Undefined=3]="Undefined",Ln;var r})(),At=(()=>{return(r=At||(At={}))[r.World=1]="World",r[r.View=2]="View",r[r.Projection=3]="Projection",r[r.ViewProjection=4]="ViewProjection",r[r.WorldView=5]="WorldView",r[r.WorldViewProjection=6]="WorldViewProjection",r[r.CameraPosition=7]="CameraPosition",r[r.FogColor=8]="FogColor",r[r.DeltaTime=9]="DeltaTime",r[r.CameraParameters=10]="CameraParameters",r[r.MaterialAlpha=11]="MaterialAlpha",At;var r})(),mr=(()=>{return(r=mr||(mr={}))[r.Material=0]="Material",r[r.PostProcess=1]="PostProcess",r[r.Particle=2]="Particle",r[r.ProceduralTexture=3]="ProceduralTexture",mr;var r})(),Yr=(()=>{return(r=Yr||(Yr={}))[r.Compatible=0]="Compatible",r[r.TypeIncompatible=1]="TypeIncompatible",r[r.TargetIncompatible=2]="TargetIncompatible",r[r.HierarchyIssue=3]="HierarchyIssue",Yr;var r})(),Gi=(()=>{return(r=Gi||(Gi={}))[r.Input=0]="Input",r[r.Output=1]="Output",Gi;var r})();class $c{static AreEquivalentTypes(e,t){switch(e){case y.Vector3:if(t===y.Color3)return!0;break;case y.Vector4:if(t===y.Color4)return!0;break;case y.Color3:if(t===y.Vector3)return!0;break;case y.Color4:if(t===y.Vector4)return!0}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===y.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===y.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==F.VertexAndFragment?this._target:this._ownerBlock.target===F.Fragment?F.Fragment:F.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===F.Vertex||(e.ownerBlock.target===F.Neutral||e.ownerBlock.target===F.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===F.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===F.Vertex||e.target===F.Vertex||(e.ownerBlock.target===F.Neutral||e.ownerBlock.target===F.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===F.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===F.Fragment||(e.ownerBlock.target===F.Neutral||e.ownerBlock.target===F.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInFragmentShader))return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=y.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new J,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=F.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===Yr.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===F.Fragment){if(i.target===F.Vertex)return Yr.TargetIncompatible;for(const a of i.outputs)if(a.ownerBlock.target!=F.Neutral&&a.isConnectedInVertexShader)return Yr.TargetIncompatible}if(this.type!==e.type&&e.innerType!==y.AutoDetect)return $c.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&$c.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?Yr.Compatible:Yr.TypeIncompatible;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return Yr.TypeIncompatible;let n=i,s=t;return this.direction===Gi.Input&&(n=t,s=i),n.isAnAncestorOf(s)?Yr.HierarchyIssue:Yr.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<y.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class Ji extends $c{constructor(e,t,i,n,s){super(e,t,i),this._blockType=n,this._blockName=s,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Ji&&e._blockName===this._blockName?Yr.Compatible:Yr.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class Ye{get name(){return this._name}set name(e){!this.validateBlockName(e)||(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){0==(this._target&e)&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=F.Vertex,i=!1,n=!1){this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===F.Neutral,this._isFinalMerger=i,this._isInput=n,this._name=e,this.uniqueId=oC.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===F.Neutral}initialize(e){}bind(e,t,i,n){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}registerInput(e,t,i=!1,n,s){return(s=null!=s?s:new $c(e,this,Gi.Input)).type=t,s.isOptional=i,n&&(s.target=n),this._inputs.push(s),this}registerOutput(e,t,i,n){return(n=null!=n?n:new $c(e,this,Gi.Output)).type=t,i&&(n.target=i),this._outputs.push(n),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==y.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===F.Neutral||0!=(e.target&t.target))return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0;return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),n=!0;for(;n;){const s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),n=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,n){}provideFallbacks(e,t){}initializeDefines(e,t,i,n=!1){}prepareDefines(e,t,i,n=!1,s){}autoConfigure(e){}replaceRepeatableContent(e,t,i,n){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===F.Vertex||this.target!==F.VertexAndFragment&&this.target!==F.Neutral||!this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,n=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,n){if(e.build(t,n),null!=t._vertexState&&(0==(e.target&e._buildTarget)||0==(e.target&i.target)||this.target!==F.VertexAndFragment&&e._buildTarget===F.Vertex&&e.target!==F.VertexAndFragment)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const o=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+o.associatedVariableName,t._getGLType(o.type))&&(t._vertexState.compilationString+=`${"v_"+o.associatedVariableName} = ${o.associatedVariableName};\r\n`),i.associatedVariableName="v_"+o.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==F.Neutral&&(0==(i.target&this.target)||0==(i.target&e.target)))continue;const n=i.connectedPoint.ownerBlock;n&&n!==this&&this._processBuild(n,e,i,t)}if(this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===F.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case F.Vertex:e.sharedData.checks.emitVertex=!0;break;case F.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\r\n//${this.name}\r\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(0!=(i.target&e.target))for(const n of i.endpoints){const s=n.ownerBlock;s&&0!=(s.target&e.target)&&-1!==t.indexOf(s)&&this._processBuild(s,e,n,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\r\n${e}.visibleOnFrame = ${this.visibleOnFrame};\r\n${e}.target = ${this.target};\r\n`}_dumpCode(e,t){let i;t.push(this);const n=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=n||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let s=0;do{s++,this._codeVariableName=n+s}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName),i=`\r\n// ${this.getClassName()}\r\n`,this.comments&&(i+=`// ${this.comments}\r\n`),i+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\r\n`,i+=this._dumpPropertiesCode();for(const s of this.inputs){if(!s.isConnected)continue;const o=s.connectedPoint.ownerBlock;-1===t.indexOf(o)&&(i+=o._dumpCode(e,t))}for(const s of this.outputs)if(s.hasEndpoints)for(const a of s.endpoints){const o=a.ownerBlock;o&&-1===t.indexOf(o)&&(i+=o._dumpCode(e,t))}return i}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const n=i.connectedPoint,s=n.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(n.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\r\n`}return t}clone(e,t=""){const i=this.serialize(),n=zr(i.customType);if(n){const s=new n;return s._deserialize(i,e,t),s}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var n;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=null!==(n=e.target)&&void 0!==n?n:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((n,s)=>{n.displayName&&(this.inputs[s].displayName=n.displayName),n.isExposedOnFrame&&(this.inputs[s].isExposedOnFrame=n.isExposedOnFrame,this.inputs[s].exposedPortPosition=n.exposedPortPosition)}),i&&i.forEach((n,s)=>{n.displayName&&(this.outputs[s].displayName=n.displayName),n.isExposedOnFrame&&(this.outputs[s].isExposedOnFrame=n.isExposedOnFrame,this.outputs[s].exposedPortPosition=n.exposedPortPosition)})}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class Ww{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===F.Fragment;this.compilationString=`\r\n${t?"//Entry point\r\n":""}void main(void) {\r\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\r\n${t?"//Constants\r\n":""}${this._constantDeclaration}\r\n${this.compilationString}`);let n="";for(const s in this.functions)n+=this.functions[s]+"\r\n";this.compilationString=`\r\n${n}\r\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\r\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\r\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\r\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r\n${t?"//Varyings\r\n":""}${this.sharedData.varyingDeclaration}\r\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\r\n${t?"//Samplers\r\n":""}${this._samplerDeclaration}\r\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\r\n${t?"//Uniforms\r\n":""}${this._uniformDeclaration}\r\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\r\n${t?"//Attributes\r\n":""}${this._attributeDeclaration}\r\n${this.compilationString}`),this.compilationString="precision highp float;\r\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defines(WEBGPU)\r\nprecision highp sampler2DArray;\r\n#endif\r\n"+this.compilationString;for(const s in this.extensions)this.compilationString=`\r\n${this.extensions[s]}\r\n${this.compilationString}`;this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\r\n`,this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\r\n`,this.samplers.push(e))}_getGLType(e){switch(e){case y.Float:return"float";case y.Int:return"int";case y.Vector2:return"vec2";case y.Color3:case y.Vector3:return"vec3";case y.Color4:case y.Vector4:return"vec4";case y.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\r\n${t}\r\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\r\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r\n`;let n=Si.IncludesShadersStore[e]+"\r\n";if(this.sharedData.emitComments&&(n=t+"\r\n"+n),!i)return n;if(i.replaceStrings)for(let s=0;s<i.replaceStrings.length;s++){const a=i.replaceStrings[s];n=n.replace(a.search,a.replace)}return n}_emitFunctionFromInclude(e,t,i,n=""){const s=e+n;if(!this.functions[s]){if(!i||!(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings))return this.functions[s]=i&&i.repeatKey?`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r\n`:`#include<${e}>${(null==i?void 0:i.substitutionVars)?"("+(null==i?void 0:i.substitutionVars)+")":""}\r\n`,void(this.sharedData.emitComments&&(this.functions[s]=t+"\r\n"+this.functions[s]));if(this.functions[s]=Si.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[s]=t+"\r\n"+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(let a=0;a<i.replaceStrings.length;a++){const o=i.replaceStrings[a];this.functions[s]=this.functions[s].replace(o.search,o.replace)}}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",n=!1){return-1===this.sharedData.varyings.indexOf(e)&&(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\r\n`:this.sharedData.varyingDeclaration+=`${n?"#ifndef":"#ifdef"} ${i}\r\n`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\r\n`,i&&(this.sharedData.varyingDeclaration+="#endif\r\n"),!0)}_emitUniformFromString(e,t,i="",n=!1){-1===this.uniforms.indexOf(e)&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\r\n`:this._uniformDeclaration+=`${n?"#ifndef":"#ifdef"} ${i}\r\n`),this._uniformDeclaration+=`uniform ${t} ${e};\r\n`,i&&(this._uniformDeclaration+="#endif\r\n"))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class K5{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r\n"),this.checks.emitFragment||(e+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r\n");for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\r\n`;if(e)throw"Build of NodeMaterial failed:\r\n"+e}}class _E extends Ye{constructor(e){super(e,F.Neutral),this.complementW=1,this.complementZ=0,this.target=F.Vertex,this.registerInput("vector",y.AutoDetect),this.registerInput("transform",y.Matrix),this.registerOutput("output",y.Vector4),this.registerOutput("xyz",y.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;("normal"===i.name||"tangent"===i.name)&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(0===this.complementW){e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e.sharedData.blocksWithDefines.push(this);const s=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${s} = mat3(${i.associatedVariableName});\r\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\r\n",e.compilationString+=`${s} = transposeMat3(inverseMat3(${s}));\r\n`,e.compilationString+="#endif\r\n",t.connectedPoint.type){case y.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\r\n`;break;case y.Vector3:case y.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\r\n`}}else{const n=i.associatedVariableName;switch(t.connectedPoint.type){case y.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${n} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\r\n`;break;case y.Vector3:case y.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${n} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${n} * ${t.associatedVariableName};\r\n`}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\r\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\r\n`,e}}ye("BABYLON.TransformBlock",_E);class lp extends Ye{constructor(e){super(e,F.Vertex,!0),this.registerInput("vector",y.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e){for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){return super._buildBlock(e),e.compilationString+=`gl_Position = ${this.vector.associatedVariableName};\r\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+="vFragmentDepth = 1.0 + gl_Position.w;\r\n",e.compilationString+="gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r\n"),this}}ye("BABYLON.VertexOutputBlock",lp);var Dt=(()=>{return(r=Dt||(Dt={}))[r.Boolean=0]="Boolean",r[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Vector2=3]="Vector2",r[r.List=4]="List",Dt;var r})();function Ot(r,e=Dt.Boolean,t="PROPERTIES",i){return(n,s)=>{let a=n._propStore;a||(a=[],n._propStore=a),a.push({propertyName:s,displayName:r,type:e,groupName:t,options:null!=i?i:{}})}}class Wo extends Ye{constructor(e){super(e,F.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",y.Color4,!0),this.registerInput("rgb",y.AutoDetect,!0),this.registerInput("a",y.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){this.useLogarithmicDepth&&i&&fe.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,n=this.a;if(e.sharedData.hints.needAlphaBlending=t.isConnected||n.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA"),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),t.connectedPoint)e.compilationString+=n.isConnected?`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${n.associatedVariableName});\r\n`:`gl_FragColor = ${t.associatedVariableName};\r\n`;else if(i.connectedPoint){let a="1.0";n.connectedPoint&&(a=n.associatedVariableName),e.compilationString+=i.connectedPoint.type===y.Float?`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${a});\r\n`:`gl_FragColor = vec4(${i.associatedVariableName}, ${a});\r\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\r\n`,e.compilationString+="gl_FragColor = toLinearSpace(gl_FragColor);\r\n",e.compilationString+="#endif\r\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\r\n`,e.compilationString+="gl_FragColor = toGammaSpace(gl_FragColor);\r\n",e.compilationString+="#endif\r\n",this.useLogarithmicDepth&&(e.compilationString+="gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r\n"),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var n;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=null!==(n=e.useLogarithmicDepth)&&void 0!==n&&n}}b([Ot("Convert to gamma space",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Wo.prototype,"convertToGammaSpace",void 0),b([Ot("Convert to linear space",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Wo.prototype,"convertToLinearSpace",void 0),b([Ot("Use logarithmic depth",Dt.Boolean,"PROPERTIES")],Wo.prototype,"useLogarithmicDepth",void 0),ye("BABYLON.FragmentOutputBlock",Wo);var so=(()=>{return(r=so||(so={}))[r.None=0]="None",r[r.Time=1]="Time",r[r.RealTime=2]="RealTime",so;var r})();const Q5={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},mE={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Xw={particle_texturemask:!0};class xt extends Ye{get type(){if(this._type===y.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=y.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=y.Vector2,this._type;case"Vector3":return this._type=y.Vector3,this._type;case"Vector4":return this._type=y.Vector4,this._type;case"Color3":return this._type=y.Color3,this._type;case"Color4":return this._type=y.Color4,this._type;case"Matrix":return this._type=y.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=y.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=y.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=y.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=y.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case At.World:case At.WorldView:case At.WorldViewProjection:case At.View:case At.ViewProjection:case At.Projection:return this._type=y.Matrix,this._type;case At.CameraPosition:return this._type=y.Vector3,this._type;case At.FogColor:return this._type=y.Color3,this._type;case At.DeltaTime:case At.MaterialAlpha:return this._type=y.Float,this._type;case At.CameraParameters:return this._type=y.Vector4,this._type}}return this._type}constructor(e,t=F.Vertex,i=y.AutoDetect){super(e,t,!1,!0),this._mode=Ln.Undefined,this._animationType=so.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new J,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=Ln.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===y.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=Ln.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=Ln.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===Ln.Undefined}get isUniform(){return this._mode===Ln.Uniform}set isUniform(e){this._mode=e?Ln.Uniform:Ln.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===Ln.Attribute}set isAttribute(e){this._mode=e?Ln.Attribute:Ln.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===Ln.Varying}set isVarying(e){this._mode=e?Ln.Varying:Ln.Undefined,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=Ln.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case so.Time:this.type===y.Float&&(this.value+=.01*e.getAnimationRatio());break;case so.RealTime:this.type===y.Float&&(this.value=(Qa.Now-e.getEngine().startTime)/1e3)}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\r\n`:`#ifdef ${e}\r\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case y.Float:this.value=0;break;case y.Vector2:this.value=We.Zero();break;case y.Vector3:this.value=E.Zero();break;case y.Vector4:this.value=Qt.Zero();break;case y.Color3:this.value=Fe.White();break;case y.Color4:this.value=new ct(1,1,1,1);break;case y.Matrix:this.value=B.Identity()}}_emitConstant(e){switch(this.type){case y.Float:return`${e._emitFloat(this.value)}`;case y.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case y.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case y.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case y.Color3:return ei.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ei.Color3[0].toGammaSpaceToRef(ei.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ei.Color3[0].toLinearSpaceToRef(ei.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${ei.Color3[0].r}, ${ei.Color3[0].g}, ${ei.Color3[0].b})`;case y.Color4:return ei.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ei.Color4[0].toGammaSpaceToRef(ei.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ei.Color4[0].toLinearSpaceToRef(ei.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${ei.Color4[0].r}, ${ei.Color4[0].g}, ${ei.Color4[0].b}, ${ei.Color4[0].a})`}return""}get _noContextSwitch(){return mE[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\r\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\r\n`,t&&(e._uniformDeclaration+="#endif\r\n");const n=e.sharedData.hints;if(null!=this._systemValue)switch(this._systemValue){case At.WorldView:n.needWorldViewMatrix=!0;break;case At.WorldViewProjection:n.needWorldViewProjectionMatrix=!0}else this._animationType!==so.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=null!==(i=Q5[this.name])&&void 0!==i?i:this.name,this.target===F.Vertex&&e._vertexState)return void(mE[this.name]?Xw[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t));if(-1!==e.attributes.indexOf(this.associatedVariableName))return;e.attributes.push(this.associatedVariableName),mE[this.name]?Xw[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\r\n`,t&&(e._attributeDeclaration+="#endif\r\n"))}}_transmitWorld(e,t,i,n){if(!this._systemValue)return;const s=this.associatedVariableName;switch(this._systemValue){case At.World:e.setMatrix(s,t);break;case At.WorldView:e.setMatrix(s,i);break;case At.WorldViewProjection:e.setMatrix(s,n)}}_transmit(e,t,i){if(this.isAttribute)return;const n=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case At.World:case At.WorldView:case At.WorldViewProjection:return;case At.View:e.setMatrix(n,t.getViewMatrix());break;case At.Projection:e.setMatrix(n,t.getProjectionMatrix());break;case At.ViewProjection:e.setMatrix(n,t.getTransformMatrix());break;case At.CameraPosition:t.bindEyePosition(e,n,!0);break;case At.FogColor:e.setColor3(n,t.fogColor);break;case At.DeltaTime:e.setFloat(n,t.deltaTime/1e3);break;case At.CameraParameters:t.activeCamera&&e.setFloat4(n,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case At.MaterialAlpha:e.setFloat(n,i.alpha)}return}const s=this._valueCallback?this._valueCallback():this._storedValue;if(null!==s)switch(this.type){case y.Float:e.setFloat(n,s);break;case y.Int:e.setInt(n,s);break;case y.Color3:ei.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ei.Color3[0].toGammaSpaceToRef(ei.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ei.Color3[0].toLinearSpaceToRef(ei.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(n,ei.Color3[0]);break;case y.Color4:ei.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ei.Color4[0].toGammaSpaceToRef(ei.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ei.Color4[0].toLinearSpaceToRef(ei.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(n,ei.Color4[0]);break;case y.Vector2:e.setVector2(n,s);break;case y.Vector3:e.setVector3(n,s);break;case y.Vector4:e.setVector4(n,s);break;case y.Matrix:e.setMatrix(n,s)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\r\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${At[this._systemValue]});\r\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case y.Float:i=`${this.value}`;break;case y.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case y.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case y.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case y.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case y.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case y.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===y.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${so[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\r\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&this._mode===Ln.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&e.mode===Ln.Attribute&&e.type===y.Vector3&&(this._type=y.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const n=zr(e.valueType);n&&(this._storedValue=n.FromArray(e.value))}}}ye("BABYLON.InputBlock",xt);class Yw extends Ye{constructor(e){super(e,F.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",y.AutoDetect,!1,F.VertexAndFragment),this.registerOutput("rgba",y.Color4,F.Neutral),this.registerOutput("rgb",y.Color3,F.Neutral),this.registerOutput("r",y.Float,F.Neutral),this.registerOutput("g",y.Float,F.Neutral),this.registerOutput("b",y.Float,F.Neutral),this.registerOutput("a",y.Float,F.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector2|y.Vector3|y.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?F.VertexAndFragment:F.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r\n`,this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===F.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r\n`}else e.compilationString+=this.uv.ownerBlock.target!==F.Fragment?`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r\n`:`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r\n`}_writeOutput(e,t,i,n=!1){if(n){if(e.target===F.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}else this.uv.ownerBlock.target!==F.Fragment?(e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n"):e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==F.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some(i=>i.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=j.Parse(e.texture,t,i))}}ye("BABYLON.CurrentScreenBlock",Yw);class jw extends Ye{constructor(e){super(e,F.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",y.AutoDetect,!1,F.VertexAndFragment),this.registerOutput("rgba",y.Color4,F.Neutral),this.registerOutput("rgb",y.Color3,F.Neutral),this.registerOutput("r",y.Float,F.Neutral),this.registerOutput("g",y.Float,F.Neutral),this.registerOutput("b",y.Float,F.Neutral),this.registerOutput("a",y.Float,F.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector2|y.Vector3|y.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"particle_uv"===i.name);t||(t=new xt("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\r\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n"}_buildBlock(e){if(super._buildBlock(e),e.target!==F.Vertex){this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\r\n`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=j.Parse(e.texture,t,i))}}ye("BABYLON.ParticleTextureBlock",jw);class $w extends Ye{constructor(e){super(e,F.Fragment),this._isUnique=!0,this.registerInput("color",y.Color4,!1,F.Fragment),this.registerOutput("rampColor",y.Color4,F.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==F.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                vec4 baseColor = ${this.color.associatedVariableName};\n                float alpha = ${this.color.associatedVariableName}.a;\n\n                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));\n                baseColor.rgb *= rampColor.rgb;\n\n                // Remapped alpha\n                float finalAlpha = baseColor.a;\n                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);\n\n                ${this._declareOutput(this.rampColor,e)} = baseColor;\n            #else\n                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}ye("BABYLON.ParticleRampGradientBlock",$w);class Kw extends Ye{constructor(e){super(e,F.Fragment),this._isUnique=!0,this.registerInput("color",y.Color4,!1,F.Fragment),this.registerInput("alphaTexture",y.Float,!1,F.Fragment),this.registerInput("alphaColor",y.Float,!1,F.Fragment),this.registerOutput("blendColor",y.Color4,F.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==F.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${this._declareOutput(this.blendColor,e)};\n                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);\n                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;\n            #else\n                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}ye("BABYLON.ParticleBlendMultiplyBlock",Kw);class cp extends Ye{constructor(e){super(e,F.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",y.Vector4,!0),this.registerInput("xyz ",y.Vector3,!0),this.registerInput("xy ",y.Vector2,!0),this.registerInput("zw ",y.Vector2,!0),this.registerInput("x",y.Float,!0),this.registerInput("y",y.Float,!0),this.registerInput("z",y.Float,!0),this.registerInput("w",y.Float,!0),this.registerOutput("xyzw",y.Vector4),this.registerOutput("xyz",y.Vector3),this.registerOutput("xy",y.Vector2),this.registerOutput("zw",y.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,n=this.z,s=this.w,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this._outputs[0],h=this._outputs[1],d=this._outputs[2],f=this._outputs[3];return c.isConnected?(u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};\r\n`),h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};\r\n`)):l.isConnected?(u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec4(${l.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r\n`),h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\r\n`)):a.isConnected?(u.hasEndpoints&&(e.compilationString+=o.isConnected?this._declareOutput(u,e)+` = vec4(${a.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};\r\n`:this._declareOutput(u,e)+` = vec4(${a.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r\n`),h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = vec3(${a.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r\n`),f.hasEndpoints&&(e.compilationString+=o.isConnected?this._declareOutput(f,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\r\n`:this._declareOutput(f,e)+` = vec2(${n.isConnected?this._writeVariable(n):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r\n`)):(u.hasEndpoints&&(e.compilationString+=o.isConnected?this._declareOutput(u,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};\r\n`:this._declareOutput(u,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r\n`),h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(3)};\r\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\r\n`),f.hasEndpoints&&(e.compilationString+=o.isConnected?this._declareOutput(f,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\r\n`:this._declareOutput(f,e)+` = vec2(${n.isConnected?this._writeVariable(n):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var n,s,a,o;super._deserialize(e,t,i),this.xSwizzle=null!==(n=e.xSwizzle)&&void 0!==n?n:"x",this.ySwizzle=null!==(s=e.ySwizzle)&&void 0!==s?s:"y",this.zSwizzle=null!==(a=e.zSwizzle)&&void 0!==a?a:"z",this.wSwizzle=null!==(o=e.wSwizzle)&&void 0!==o?o:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\r\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\r\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\r\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\r\n`,e}}ye("BABYLON.VectorMergerBlock",cp);class up extends Ye{constructor(e){super(e,F.Neutral),this.sourceRange=new We(-1,1),this.targetRange=new We(0,1),this.registerInput("input",y.AutoDetect),this.registerInput("sourceMin",y.Float,!0),this.registerInput("sourceMax",y.Float,!0),this.registerInput("targetMin",y.Float,!0),this.registerInput("targetMax",y.Float,!0),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),n=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),a=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${a} - ${s}) / (${n} - ${i});\r\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=We.FromArray(e.sourceRange),this.targetRange=We.FromArray(e.targetRange)}}b([Ot("From",Dt.Vector2)],up.prototype,"sourceRange",void 0),b([Ot("To",Dt.Vector2)],up.prototype,"targetRange",void 0),ye("BABYLON.RemapBlock",up);class TE extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r\n`,this}}ye("BABYLON.MultiplyBlock",TE);class EE{constructor(){this.direction1=new E(0,1,0),this.direction2=new E(0,1,0),this.minEmitBox=new E(-.5,-.5,-.5),this.maxEmitBox=new E(.5,.5,.5)}startDirectionFunction(e,t,i,n){const s=Se.RandomRange(this.direction1.x,this.direction2.x),a=Se.RandomRange(this.direction1.y,this.direction2.y),o=Se.RandomRange(this.direction1.z,this.direction2.z);if(n)return t.x=s,t.y=a,void(t.z=o);E.TransformNormalFromFloatsToRef(s,a,o,e,t)}startPositionFunction(e,t,i,n){const s=Se.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),a=Se.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=Se.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(n)return t.x=s,t.y=a,void(t.z=o);E.TransformCoordinatesFromFloatsToRef(s,a,o,e,t)}clone(){const e=new EE;return Wr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){E.FromArrayToRef(e.direction1,0,this.direction1),E.FromArrayToRef(e.direction2,0,this.direction2),E.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),E.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class vE{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._height=0!==this._angle?this._radius/Math.tan(this._angle/2):1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,n){n?z.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),z.Vector3[0]).normalize();const s=Se.RandomRange(0,this.directionRandomizer),a=Se.RandomRange(0,this.directionRandomizer),o=Se.RandomRange(0,this.directionRandomizer);t.x=z.Vector3[0].x+s,t.y=z.Vector3[0].y+a,t.z=z.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,n){const s=Se.RandomRange(0,2*Math.PI);let a;this.emitFromSpawnPointOnly?a=1e-4:(a=Se.RandomRange(0,this.heightRange),a=1-a*a);let o=this._radius-Se.RandomRange(0,this._radius*this.radiusRange);o*=a;const l=o*Math.sin(s),c=o*Math.cos(s),u=a*this._height;if(n)return t.x=l,t.y=u,void(t.z=c);E.TransformCoordinatesFromFloatsToRef(l,u,c,e,t)}clone(){const e=new vE(this._radius,this._angle,this.directionRandomizer);return Wr.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=void 0!==e.radiusRange?e.radiusRange:1,this.heightRange=void 0!==e.radiusRange?e.heightRange:1,this.emitFromSpawnPointOnly=void 0!==e.emitFromSpawnPointOnly&&e.emitFromSpawnPointOnly}}class hp{constructor(e=1,t=1,i=1,n=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=n,this._tempVector=E.Zero()}startDirectionFunction(e,t,i,n,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),E.TransformNormalToRef(this._tempVector,s,this._tempVector);const a=Se.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);o+=Se.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=a,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),n?t.copyFrom(this._tempVector):E.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,n){const s=Se.RandomRange(-this.height/2,this.height/2),a=Se.RandomRange(0,2*Math.PI),o=Se.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(o)*this.radius,c=l*Math.cos(a),u=l*Math.sin(a);n?t.copyFromFloats(c,s,u):E.TransformCoordinatesFromFloatsToRef(c,s,u,e,t)}clone(){const e=new hp(this.radius,this.directionRandomizer);return Wr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class SE extends hp{constructor(e=1,t=1,i=1,n=new E(0,1,0),s=new E(0,1,0)){super(e,t,i),this.direction1=n,this.direction2=s}startDirectionFunction(e,t){const i=Se.RandomRange(this.direction1.x,this.direction2.x),n=Se.RandomRange(this.direction1.y,this.direction2.y),s=Se.RandomRange(this.direction1.z,this.direction2.z);E.TransformNormalFromFloatsToRef(i,n,s,e,t)}clone(){const e=new SE(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return Wr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class xE{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,n){const s=i.position.subtract(e.getTranslation()).normalize(),a=Se.RandomRange(0,this.directionRandomizer),o=Se.RandomRange(0,this.directionRandomizer),l=Se.RandomRange(0,this.directionRandomizer);s.x+=a,s.y+=o,s.z+=l,s.normalize(),n?t.copyFrom(s):E.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,n){const s=this.radius-Se.RandomRange(0,this.radius*this.radiusRange),a=Se.RandomRange(0,1),o=Se.RandomRange(0,2*Math.PI),l=Math.acos(2*a-1),c=s*Math.cos(o)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(o)*Math.sin(l);n?t.copyFromFloats(c,Math.abs(u),h):E.TransformCoordinatesFromFloatsToRef(c,Math.abs(u),h,e,t)}clone(){const e=new xE(this.radius,this.directionRandomizer);return Wr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class AE{constructor(){this.direction1=new E(0,1,0),this.direction2=new E(0,1,0)}startDirectionFunction(e,t,i,n){const s=Se.RandomRange(this.direction1.x,this.direction2.x),a=Se.RandomRange(this.direction1.y,this.direction2.y),o=Se.RandomRange(this.direction1.z,this.direction2.z);n?t.copyFromFloats(s,a,o):E.TransformNormalFromFloatsToRef(s,a,o,e,t)}startPositionFunction(e,t,i,n){n?t.copyFromFloats(0,0,0):E.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new AE;return Wr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){E.FromArrayToRef(e.direction1,0,this.direction1),E.FromArrayToRef(e.direction2,0,this.direction2)}}class dp{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,n){const s=i.position.subtract(e.getTranslation()).normalize(),a=Se.RandomRange(0,this.directionRandomizer),o=Se.RandomRange(0,this.directionRandomizer),l=Se.RandomRange(0,this.directionRandomizer);s.x+=a,s.y+=o,s.z+=l,s.normalize(),n?t.copyFrom(s):E.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,n){const s=this.radius-Se.RandomRange(0,this.radius*this.radiusRange),a=Se.RandomRange(0,1),o=Se.RandomRange(0,2*Math.PI),l=Math.acos(2*a-1),c=s*Math.cos(o)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(o)*Math.sin(l);n?t.copyFromFloats(c,u,h):E.TransformCoordinatesFromFloatsToRef(c,u,h,e,t)}clone(){const e=new dp(this.radius,this.directionRandomizer);return Wr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class yE extends dp{constructor(e=1,t=new E(0,1,0),i=new E(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=Se.RandomRange(this.direction1.x,this.direction2.x),n=Se.RandomRange(this.direction1.y,this.direction2.y),s=Se.RandomRange(this.direction1.z,this.direction2.z);E.TransformNormalFromFloatsToRef(i,n,s,e,t)}clone(){const e=new yE(this.radius,this.direction1,this.direction2);return Wr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}let qw=(()=>{class r{get noiseTexture(){return this._noiseTexture}set noiseTexture(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:E.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:E.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:E.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:E.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t)}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration=!t&&this._scene?this._scene.imageProcessingConfiguration:t)}_reset(){}_removeGradientAndTexture(t,i,n){if(!i)return this;let s=0;for(const a of i){if(a.gradient===t){i.splice(s,1);break}s++}return n&&n.dispose(),this}constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=E.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new E(10,10,10),this.onAnimationEnd=null,this.blendMode=r.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new We(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new E(0,0,0),this._useLogarithmicDepth=!1,this.gravity=E.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new ct(1,1,1,1),this.color2=new ct(1,1,1,1),this.colorDead=new ct(0,0,0,1),this.textureMask=new ct(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Hz,this.id=t,this.name=t}createPointEmitter(t,i){const n=new AE;return n.direction1=t,n.direction2=i,this.particleEmitterType=n,n}createHemisphericEmitter(t=1,i=1){const n=new xE(t,i);return this.particleEmitterType=n,n}createSphereEmitter(t=1,i=1){const n=new dp(t,i);return this.particleEmitterType=n,n}createDirectedSphereEmitter(t=1,i=new E(0,1,0),n=new E(0,1,0)){const s=new yE(t,i,n);return this.particleEmitterType=s,s}createCylinderEmitter(t=1,i=1,n=1,s=0){const a=new hp(t,i,n,s);return this.particleEmitterType=a,a}createDirectedCylinderEmitter(t=1,i=1,n=1,s=new E(0,1,0),a=new E(0,1,0)){const o=new SE(t,i,n,s,a);return this.particleEmitterType=o,o}createConeEmitter(t=1,i=Math.PI/4){const n=new vE(t,i);return this.particleEmitterType=n,n}createBoxEmitter(t,i,n,s){const a=new EE;return this.particleEmitterType=a,this.direction1=t,this.direction2=i,this.minEmitBox=n,this.maxEmitBox=s,a}}return r.BLENDMODE_ONEONE=0,r.BLENDMODE_STANDARD=1,r.BLENDMODE_ADD=2,r.BLENDMODE_MULTIPLY=3,r.BLENDMODE_MULTIPLYADD=4,r})();class Jw extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("rgba",y.Color4,!0),this.registerInput("rgb ",y.Color3,!0),this.registerOutput("rgb",y.Color3),this.registerOutput("r",y.Float),this.registerOutput("g",y.Float),this.registerOutput("b",y.Float),this.registerOutput("a",y.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],n=this._outputs[1],s=this._outputs[2],a=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\r\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.r;\r\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.g;\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.b;\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.a;\r\n`),this}}ye("BABYLON.ColorSplitterBlock",Jw);var sn=(()=>{return(r=sn||(sn={}))[r.Cos=0]="Cos",r[r.Sin=1]="Sin",r[r.Abs=2]="Abs",r[r.Exp=3]="Exp",r[r.Exp2=4]="Exp2",r[r.Round=5]="Round",r[r.Floor=6]="Floor",r[r.Ceiling=7]="Ceiling",r[r.Sqrt=8]="Sqrt",r[r.Log=9]="Log",r[r.Tan=10]="Tan",r[r.ArcTan=11]="ArcTan",r[r.ArcCos=12]="ArcCos",r[r.ArcSin=13]="ArcSin",r[r.Fract=14]="Fract",r[r.Sign=15]="Sign",r[r.Radians=16]="Radians",r[r.Degrees=17]="Degrees",sn;var r})();class eO extends Ye{constructor(e){super(e,F.Neutral),this.operation=sn.Cos,this.registerInput("input",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case sn.Cos:i="cos";break;case sn.Sin:i="sin";break;case sn.Abs:i="abs";break;case sn.Exp:i="exp";break;case sn.Exp2:i="exp2";break;case sn.Round:i="round";break;case sn.Floor:i="floor";break;case sn.Ceiling:i="ceil";break;case sn.Sqrt:i="sqrt";break;case sn.Log:i="log";break;case sn.Tan:i="tan";break;case sn.ArcTan:i="atan";break;case sn.ArcCos:i="acos";break;case sn.ArcSin:i="asin";break;case sn.Fract:i="fract";break;case sn.Sign:i="sign";break;case sn.Radians:i="radians";break;case sn.Degrees:i="degrees"}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\r\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${sn[this.operation]};\r\n`}}ye("BABYLON.TrigonometryBlock",eO);const bE={effect:null,subMesh:null};class fp extends us{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class Zi extends vh{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||Je.LastCreatedScene),this._buildId=Zi._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new B,this._cachedWorldViewProjectionMatrix=new B,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new J,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=mr.Material,this.forceAlphaBlending=!1,this._options=Mi({emitComments:!1},i),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return Ie.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return 0!=(e.target&F.Vertex)&&this._addVertexOutputNode(e),0!=(e.target&F.Fragment)&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(0!=(e.target&F.Vertex)&&this._removeVertexOutputNode(e),0!=(e.target&F.Fragment)&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=F.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=F.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_initializeBlock(e,t,i,n=!0){if(e.initialize(t),n&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const s=e.getClassName();for(const a of this.attachedBlocks)if(a.getClassName()===s)throw`Cannot have multiple blocks of type ${s} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const s of e.inputs){s.associatedVariableName="";const a=s.connectedPoint;if(a){const o=a.ownerBlock;o!==e&&((o.target===F.VertexAndFragment||t.target===F.Fragment&&o.target===F.Vertex&&o._preparationId!==this._buildId)&&i.push(o),this._initializeBlock(o,t,i,n))}}for(const s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===F.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const n=i.connectedPoint;if(n){const s=n.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!0){this._buildWasSuccessful=!1;const n=this.getScene().getEngine(),s=this._mode===mr.Particle;if(0===this._vertexOutputNodes.length&&!s)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Ww,this._vertexCompilationState.supportUniformBuffers=n.supportsUniformBuffers,this._vertexCompilationState.target=F.Vertex,this._fragmentCompilationState=new Ww,this._fragmentCompilationState.supportUniformBuffers=n.supportsUniformBuffers,this._fragmentCompilationState.target=F.Fragment,this._sharedData=new K5,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;const a=[],o=[];for(const c of this._vertexOutputNodes)a.push(c),this._initializeBlock(c,this._vertexCompilationState,o,i);for(const c of this._fragmentOutputNodes)o.push(c),this._initializeBlock(c,this._fragmentCompilationState,a,i);this.optimize();for(const c of a)c.build(this._vertexCompilationState,a);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const c of o)this._resetDualBlocks(c,this._buildId-1);for(const c of o)c.build(this._fragmentCompilationState,o);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=Zi._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const l=this.getScene().meshes;for(const c of l)if(c.subMeshes)for(const u of c.subMeshes){if(u.getMaterial()!==this||!u.materialDefines)continue;const h=u.materialDefines;h.markAllAsDirty(),h.reset()}}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,n=t.TANGENT;t.NORMAL=e.isVerticesDataPresent(I.NormalKind),t.TANGENT=e.isVerticesDataPresent(I.TangentKind);let s=!1;for(let a=1;a<=6;++a){const o=t["UV"+a];t["UV"+a]=e.isVerticesDataPresent(`uv${1===a?"":a}`),s=s||t["UV"+a]!==o}(i!==t.NORMAL||n!==t.TANGENT||s)&&t.markAsAttributesDirty()}createPostProcess(e,t=1,i=1,n,s,a=0,o=5){return this.mode!==mr.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,n,s,a,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,n=1,s,a,o=0,l=5){let c=this.name+this._buildId;const u=new fp,h=new hn(c+"PostProcess",this.getScene());let d=this._buildId;return this._processDefines(h,u),Si.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new li(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,n,s,a,u.toString(),o,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{d!==this._buildId&&(delete Si.ShadersStore[c+"VertexShader"],delete Si.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,u.markAllAsDirty(),d=this._buildId),this._processDefines(h,u)&&(Si.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Nc.SetImmediate(()=>e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==mr.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const n=new wa(i,e,null,t),s=new hn(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};const a=new fp,o=this._processDefines(s,a);Si.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[I.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString(),null==o?void 0:o.fallbacks,void 0);n.nodeMaterialSource=this,n._setEffect(l);let c=this._buildId;return n.onBeforeGenerationObservable.add(()=>{c!==this._buildId&&(delete Si.ShadersStore[i+"VertexShader"],delete Si.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,a.markAllAsDirty(),c=this._buildId);const u=this._processDefines(s,a);u&&(Si.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Nc.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[I.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString(),null==u?void 0:u.fallbacks,void 0),n._setEffect(l)})),this._checkInternals(l)}),n}_createEffectForParticles(e,t,i,n,s,a,o,l=""){let c=this.name+this._buildId+"_"+t;a||(a=new fp),o||(o=this.getScene().getMeshByName(this.name+"Particle"))||((o=new hn(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let u=this._buildId;const h=[];let d=l;if(!s){const f=this._processDefines(o,a);Si.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),e.fillDefines(h,t),d=h.join("\n"),s=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString()+"\n"+d,null==f?void 0:f.fallbacks,i,n,e),e.setCustomEffect(s,t)}s.onBindObservable.add(f=>{u!==this._buildId&&(delete Si.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,a.markAllAsDirty(),u=this._buildId),h.length=0,e.fillDefines(h,t);const p=h.join("\n");p!==d&&(a.markAllAsDirty(),d=p);const g=this._processDefines(o,a);if(g)return Si.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),f=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString()+"\n"+d,null==g?void 0:g.fallbacks,i,n,e),e.setCustomEffect(f,t),void this._createEffectForParticles(e,t,i,n,f,a,o,l);this._checkInternals(f)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const n of this._sharedData.animatedInputs)n.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===mr.Particle?(this._createEffectForParticles(e,qw.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,qw.BLENDMODE_MULTIPLY,t,i)):console.log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===mr.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):console.log("Incompatible material mode")}_processDefines(e,t,i=!1,n){let s=null;const a=this.getScene();if(fe.PrepareDefinesForCamera(a,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(o=>{o.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(o=>{o.prepareDefines(e,this,t,i,n)}),t.isDirty){const o=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(d=>{d.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const l=[];this._sharedData.dynamicUniformBlocks.forEach(d=>{d.updateUniformsAndSamples(this._vertexCompilationState,this,t,l)});const c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(d=>{-1===c.indexOf(d)&&c.push(d)});const u=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(d=>{-1===u.indexOf(d)&&u.push(d)});const h=new xl;this._sharedData.blocksWithFallbacks.forEach(d=>{d.provideFallbacks(e,h)}),s={lightDisposed:o,uniformBuffers:l,mergedUniforms:c,mergedSamplers:u,fallbacks:h}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const n=this.getScene();if(this._sharedData.animatedInputs){const l=n.getFrameId();if(this._animationFrame!==l){for(const c of this._sharedData.animatedInputs)c.animate(n);this._animationFrame=l}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new fp);const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=n.getEngine();if(this._prepareDefinesForAttributes(e,s),this._sharedData.blockingBlocks.some(l=>!l.isReady(e,this,s,i)))return!1;const o=this._processDefines(e,s,i,t);if(o){const l=t.effect,c=s.toString();let u=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:c,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS}},a);if(u)if(this._onEffectCreatedObservable&&(bE.effect=u,bE.subMesh=t,this._onEffectCreatedObservable.notifyObservers(bE)),this.allowShaderHotSwapping&&l&&!u.isReady()){if(u=l,s.markAsUnprocessed(),o.lightDisposed)return s._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(u,s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return`// Vertex shader\r\n${this._vertexCompilationState.compilationString}\r\n\r\n// Fragment shader\r\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const n of this._sharedData.inputBlocks)n._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const n=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);const a=this._mustRebind(n,s,t.visibility),o=this._sharedData;if(a){for(const l of o.bindableBlocks)l.bind(s,this,t,i);for(const l of o.forcedBindableBlocks)l.bind(s,this,t,i);for(const l of o.inputBlocks)l._transmit(s,n,this)}else if(!this.isFrozen)for(const l of o.forcedBindableBlocks)l.bind(s,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)Zi._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const n of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))n.dispose();for(const n of this.attachedBlocks)n.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})}edit(e){return new Promise(t=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR?Ie.LoadScript(e&&e.editorURL?e.editorURL:Zi.EditorURL,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(),t()}):(this._createNodeEditor(),t())})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new xt("Position");e.setAsAttribute("position");const t=new xt("World");t.setAsSystemValue(At.World);const i=new _E("WorldPos");e.connectTo(i),t.connectTo(i);const n=new xt("ViewProjection");n.setAsSystemValue(At.ViewProjection);const s=new _E("WorldPos * ViewProjectionTransform");i.connectTo(s),n.connectTo(s);const a=new lp("VertexOutput");s.connectTo(a);const o=new xt("color");o.value=new ct(.8,.8,.8,1);const l=new Wo("FragmentOutput");o.connectTo(l),this.addOutputNode(a),this.addOutputNode(l),this._mode=mr.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new xt("Position");e.setAsAttribute("position2d");const t=new xt("Constant1");t.isConstant=!0,t.value=1;const i=new cp("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const n=new lp("VertexOutput");i.connectTo(n);const s=new xt("Scale");s.visibleInInspector=!0,s.value=new We(1,1);const a=new up("uv0");e.connectTo(a);const o=new TE("UV scale");a.connectTo(o),s.connectTo(o);const l=new Yw("CurrentScreen");o.connectTo(l),l.texture=new j("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const c=new Wo("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(n),this.addOutputNode(c),this._mode=mr.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new xt("Position");e.setAsAttribute("position2d");const t=new xt("Constant1");t.isConstant=!0,t.value=1;const i=new cp("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const n=new lp("VertexOutput");i.connectTo(n);const s=new xt("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=so.Time,s.isConstant=!1;const a=new xt("Color3");a.value=new Fe(1,1,1),a.isConstant=!1;const o=new Wo("FragmentOutput"),l=new cp("VectorMerger");l.visibleInInspector=!1;const c=new eO("Cos");c.operation=sn.Cos,e.connectTo(l),s.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(o.rgb),this.addOutputNode(n),this.addOutputNode(o),this._mode=mr.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new xt("uv");e.setAsAttribute("particle_uv");const t=new jw("ParticleTexture");e.connectTo(t);const i=new xt("Color");i.setAsAttribute("particle_color");const n=new TE("Texture * Color");t.connectTo(n),i.connectTo(n);const s=new $w("ParticleRampGradient");n.connectTo(s);const a=new Jw("ColorSplitter");i.connectTo(a);const o=new Kw("ParticleBlendMultiply");s.connectTo(o),t.connectTo(o,{output:"a"}),a.connectTo(o,{output:"a"});const l=new Wo("FragmentOutput");o.connectTo(l),this.addOutputNode(l),this._mode=mr.Particle}loadAsync(e){var t=this;return ls(function*(i,n=""){return Zi.ParseFromFileAsync("",i,t.getScene(),n,!0,t)}).apply(this,arguments)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const n=i.connectedPoint;if(n){const s=n.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const a of this._vertexOutputNodes)this._gatherBlocks(a,t);const n=[];for(const a of this._fragmentOutputNodes)this._gatherBlocks(a,n);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r\n`;for(const a of t)a.isInput&&-1===e.indexOf(a)&&(s+=a._dumpCode(i,e));for(const a of n)a.isInput&&-1===e.indexOf(a)&&(s+=a._dumpCode(i,e));e=[],s+="\r\n// Connections\r\n";for(const a of this._vertexOutputNodes)s+=a._dumpCodeForOutputConnections(e);for(const a of this._fragmentOutputNodes)s+=a._dumpCodeForOutputConnections(e);s+="\r\n// Output nodes\r\n";for(const a of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${a._codeVariableName});\r\n`;for(const a of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${a._codeVariableName});\r\n`;return s+="nodeMaterial.build();\r\n",s}serialize(e){const t=e?{}:lt.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const n of this._vertexOutputNodes)this._gatherBlocks(n,i),t.outputNodes.push(n.uniqueId);for(const n of this._fragmentOutputNodes)this._gatherBlocks(n,i),-1===t.outputNodes.indexOf(n.uniqueId)&&t.outputNodes.push(n.uniqueId)}t.blocks=[];for(const n of i)t.blocks.push(n.serialize());if(!e)for(const n of this.attachedBlocks)-1===i.indexOf(n)&&t.blocks.push(n.serialize());return t}_restoreConnections(e,t,i){for(const n of e.outputs)for(const s of t.blocks){const a=i[s.id];if(a)for(const o of s.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===n.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;n.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}parseSerializedObject(e,t="",i=!1){var n;i||this.clear();const s={};for(const a of e.blocks){const o=zr(a.customType);if(o){const l=new o;l._deserialize(a,this.getScene(),t),s[a.id]=l,this.attachedBlocks.push(l)}}for(let a=0;a<e.blocks.length;a++){const l=s[e.blocks[a].id];!l||l.inputs.length&&!i||this._restoreConnections(l,e,s)}if(e.outputNodes)for(const a of e.outputNodes)this.addOutputNode(s[a]);if(e.locations||e.editorData&&e.editorData.locations){const a=e.locations||e.editorData.locations;for(const l of a)s[l.blockId]&&(l.blockId=s[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&a.concat(this.editorData.locations),e.locations?this.editorData={locations:a}:(this.editorData=e.editorData,this.editorData.locations=a);const o=[];for(const l in s)o[l]=s[l].uniqueId;this.editorData.map=o}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=null!==(n=e.mode)&&void 0!==n?n:mr.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),n=lt.Clone(()=>new Zi(e,this.getScene(),this.options),this);return n.id=e,n.name=e,n.parseSerializedObject(i),n._buildId=this._buildId,n.build(!1,!t),n}static Parse(e,t,i=""){const n=lt.Parse(()=>new Zi(e.name,t),e,t,i);return n.parseSerializedObject(e,i),n.build(),n}static ParseFromFileAsync(e,t,i){return ls(function*(n,s,a,o="",l=!1,c){const u=null!=c?c:new Zi(n,a),h=yield a._loadFileAsync(s),d=JSON.parse(h);return u.parseSerializedObject(d,o),l||u.build(),u}).apply(this,arguments)}static ParseFromSnippetAsync(e,t=Je.LastCreatedScene,i="",n,s=!1){return"_BLANK"===e?Promise.resolve(Zi.CreateDefault("blank",t)):new Promise((a,o)=>{const l=new Kn;l.addEventListener("readystatechange",()=>{if(4==l.readyState)if(200==l.status){const c=JSON.parse(JSON.parse(l.responseText).jsonPayload),u=JSON.parse(c.nodeMaterial);n||((n=lt.Parse(()=>new Zi(e,t),u,t,i)).uniqueId=t.getUniqueId()),n.parseSerializedObject(u),n.snippetId=e;try{s||n.build(),a(n)}catch(h){o(h)}}else o("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}static CreateDefault(e,t){const i=new Zi(e,t);return i.setToDefault(),i.build(),i}}Zi._BuildIdGenerator=0,Zi.EditorURL=`https://unpkg.com/babylonjs-node-editor@${Ve.Version}/babylon.nodeEditor.js`,Zi.SnippetUrl="https://snippet.babylonjs.com",Zi.IgnoreTexturesAtLoadTime=!1,b([O()],Zi.prototype,"ignoreAlpha",void 0),b([O()],Zi.prototype,"maxSimultaneousLights",void 0),b([O("mode")],Zi.prototype,"_mode",void 0),b([O("comment")],Zi.prototype,"comment",void 0),b([O()],Zi.prototype,"forceAlphaBlending",void 0),ye("BABYLON.NodeMaterial",Zi),ye("BABYLON.BonesBlock",class Z5 extends Ye{constructor(e){super(e,F.Vertex),this.registerInput("matricesIndices",y.Vector4),this.registerInput("matricesWeights",y.Vector4),this.registerInput("matricesIndicesExtra",y.Vector4,!0),this.registerInput("matricesWeightsExtra",y.Vector4,!0),this.registerInput("world",y.Matrix),this.registerOutput("output",y.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.matricesIndices.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"matricesIndices"===i.name);t||(t=new xt("matricesIndices"),t.setAsAttribute("matricesIndices")),t.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"matricesWeights"===i.name);t||(t=new xt("matricesWeights"),t.setAsAttribute("matricesWeights")),t.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.World);t||(t=new xt("world"),t.setAsSystemValue(At.World)),t.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){fe.BindBonesParameters(i,e)}prepareDefines(e,t,i){!i._areAttributesDirty||fe.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const n=this._outputs[0],s=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\r\n",e.compilationString+=this._declareOutput(n,e)+` = ${s.associatedVariableName} * ${i};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=this._declareOutput(n,e)+` = ${s.associatedVariableName};\r\n`,e.compilationString+="#endif\r\n",this}}),ye("BABYLON.InstancesBlock",class q5 extends Ye{constructor(e){super(e,F.Vertex),this.registerInput("world0",y.Vector4),this.registerInput("world1",y.Vector4),this.registerInput("world2",y.Vector4),this.registerInput("world3",y.Vector4),this.registerInput("world",y.Matrix,!0),this.registerOutput("output",y.Matrix),this.registerOutput("instanceID",y.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e){if(!this.world0.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world0"===i.name);t||(t=new xt("world0"),t.setAsAttribute("world0")),t.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world1"===i.name);t||(t=new xt("world1"),t.setAsAttribute("world1")),t.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world2"===i.name);t||(t=new xt("world2"),t.setAsAttribute("world2")),t.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world3"===i.name);t||(t=new xt("world3"),t.setAsAttribute("world3")),t.output.connectTo(this.world3)}if(!this.world.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"world"===i.name);t||(t=new xt("world"),t.setAsSystemValue(At.World)),t.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,n=!1,s){let a=!1;i.INSTANCES!==n&&(i.setValue("INSTANCES",n),a=!0),s&&i.THIN_INSTANCES!==!!(null==s?void 0:s.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(null==s?void 0:s.getRenderingMesh().hasThinInstances)),a=!0),a&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],n=this._outputs[1],s=this.world0,a=this.world1,o=this.world2,l=this.world3;return e.compilationString+="#ifdef INSTANCES\r\n",e.compilationString+=this._declareOutput(i,e)+` = mat4(${s.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName}, ${l.associatedVariableName});\r\n`,e.compilationString+="#ifdef THIN_INSTANCES\r\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=t._caps.canUseGLInstanceID?this._declareOutput(n,e)+" = float(gl_InstanceID);\r\n":this._declareOutput(n,e)+" = 0.0;\r\n",e.compilationString+="#else\r\n",e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\r\n`,e.compilationString+=this._declareOutput(n,e)+" = 0.0;\r\n",e.compilationString+="#endif\r\n",this}}),ye("BABYLON.MorphTargetsBlock",class J5 extends Ye{constructor(e){super(e,F.Vertex),this.registerInput("position",y.Vector3),this.registerInput("normal",y.Vector3),this.registerInput("tangent",y.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(y.Color4|y.Vector4|y.Vector3),this.registerInput("uv",y.Vector2),this.registerOutput("positionOutput",y.Vector3),this.registerOutput("normalOutput",y.Vector3),this.registerOutput("tangentOutput",y.Vector4),this.registerOutput("uvOutput",y.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"position"===i.name);t||(t=new xt("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"normal"===i.name);t||(t=new xt("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"tangent"===i.name);t||(t=new xt("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"uv"===i.name);t||(t=new xt("uv"),t.setAsAttribute("uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const n=e.morphTargetManager;(null==n?void 0:n.isUsingTextureForTargets)&&n.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}!i._areAttributesDirty||fe.PrepareDefinesForMorphTargets(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(fe.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,n){const s=this.position,a=this.normal,o=this.tangent,l=this.uv,c=this.positionOutput,u=this.normalOutput,h=this.tangentOutput,d=this.uvOutput,f=e,p=n.NUM_MORPH_INFLUENCERS,g=i.morphTargetManager,_=g&&g.supportsNormals&&n.NORMAL,m=g&&g.supportsTangents&&n.TANGENT,T=g&&g.supportsUVs&&n.UV1;let v="";(null==g?void 0:g.isUsingTextureForTargets)&&p>0&&(v+="float vertexID;\r\n");for(let A=0;A<p;A++)v+="#ifdef MORPHTARGETS\r\n",(null==g?void 0:g.isUsingTextureForTargets)?(v+="vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r\n",v+=`${c.associatedVariableName} += (readVector3FromRawSampler(${A}, vertexID) - ${s.associatedVariableName}) * morphTargetInfluences[${A}];\r\n`,v+="vertexID += 1.0;\r\n"):v+=`${c.associatedVariableName} += (position${A} - ${s.associatedVariableName}) * morphTargetInfluences[${A}];\r\n`,_&&(v+="#ifdef MORPHTARGETS_NORMAL\r\n",(null==g?void 0:g.isUsingTextureForTargets)?(v+=`${u.associatedVariableName} += (readVector3FromRawSampler(${A}, vertexID) - ${a.associatedVariableName}) * morphTargetInfluences[${A}];\r\n`,v+="vertexID += 1.0;\r\n"):v+=`${u.associatedVariableName} += (normal${A} - ${a.associatedVariableName}) * morphTargetInfluences[${A}];\r\n`,v+="#endif\r\n"),T&&(v+="#ifdef MORPHTARGETS_UV\r\n",(null==g?void 0:g.isUsingTextureForTargets)?(v+=`${d.associatedVariableName} += (readVector3FromRawSampler(${A}, vertexID).xy - ${l.associatedVariableName}) * morphTargetInfluences[${A}];\r\n`,v+="vertexID += 1.0;\r\n"):v+=`${d.associatedVariableName}.xy += (uv_${A} - ${l.associatedVariableName}.xy) * morphTargetInfluences[${A}];\r\n`,v+="#endif\r\n"),m&&(v+="#ifdef MORPHTARGETS_TANGENT\r\n",v+=(null==g?void 0:g.isUsingTextureForTargets)?`${h.associatedVariableName}.xyz += (readVector3FromRawSampler(${A}, vertexID) - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${A}];\r\n`:`${h.associatedVariableName}.xyz += (tangent${A} - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${A}];\r\n`,v+=o.type===y.Vector4?`${h.associatedVariableName}.w = ${o.associatedVariableName}.w;\r\n`:`${h.associatedVariableName}.w = 1.;\r\n`,v+="#endif\r\n"),v+="#endif\r\n";if(f.compilationString=f.compilationString.replace(this._repeatableContentAnchor,v),p>0)for(let A=0;A<p;A++)f.attributes.push(I.PositionKind+A),_&&f.attributes.push(I.NormalKind+A),m&&f.attributes.push(I.TangentKind+A),T&&f.attributes.push(I.UVKind+"_"+A)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,n=this.tangent,s=this.uv,a=this.positionOutput,o=this.normalOutput,l=this.tangentOutput,c=this.uvOutput,u=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",u),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",u,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${this._declareOutput(a,e)} = ${t.associatedVariableName};\r\n`,e.compilationString+="#ifdef NORMAL\r\n",e.compilationString+=`${this._declareOutput(o,e)} = ${i.associatedVariableName};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(o,e)} = vec3(0., 0., 0.);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef TANGENT\r\n",e.compilationString+=`${this._declareOutput(l,e)} = ${n.associatedVariableName};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(l,e)} = vec4(0., 0., 0., 0.);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef UV1\r\n",e.compilationString+=`${this._declareOutput(c,e)} = ${s.associatedVariableName};\r\n`,e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(c,e)} = vec2(0., 0.);\r\n`,e.compilationString+="#endif\r\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}),ye("BABYLON.LightInformationBlock",class eX extends Ye{constructor(e){super(e,F.Vertex),this.registerInput("worldPosition",y.Vector4,!1,F.Vertex),this.registerOutput("direction",y.Vector3),this.registerOutput("color",y.Color3),this.registerOutput("intensity",y.Float),this.registerOutput("shadowBias",y.Float),this.registerOutput("shadowNormalBias",y.Float),this.registerOutput("shadowDepthScale",y.Float),this.registerOutput("shadowDepthRange",y.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let n=this.light;const s=t.getScene();if(!n&&s.lights.length&&(n=this.light=s.lights[0],this._forcePrepareDefines=!0),!n||!n.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);n.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,n.diffuse,n.intensity);const a=n.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(a?e.setFloat3(this._lightShadowUniformName,a.bias,a.normalBias,a.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(a&&s.activeCamera){const o=n;e.setFloat2(this._lightShadowExtraUniformName,o.getDepthMinZ(s.activeCamera),o.getDepthMinZ(s.activeCamera)+o.getDepthMaxZ(s.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const n=this.light;i.setValue(this._lightTypeDefineName,!!(n&&n instanceof mT),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,n=this.intensity,s=this.shadowBias,a=this.shadowNormalBias,o=this.shadowDepthScale,l=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\r\n`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\r\n`,e.compilationString+="#else\r\n",e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\r\n`,e.compilationString+="#endif\r\n",e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\r\n`,e.compilationString+=this._declareOutput(n,e)+` = ${this._lightColorUniformName}.a;\r\n`,(s.hasEndpoints||a.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${this._lightShadowUniformName}.x;\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${this._lightShadowUniformName}.y;\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${this._lightShadowUniformName}.z;\r\n`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(l,e)+` = ${this._lightShadowUniformName};\r\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}});class tO extends Ye{constructor(e){super(e,F.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",y.AutoDetect),this.registerOutput("output",y.Color4),this.registerOutput("rgb",y.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Color4|y.Vector3|y.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){!i||!t.imageProcessingConfiguration||t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var t;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const i=this.color,n=this._outputs[0],s=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",s),e._emitFunctionFromInclude("imageProcessingDeclaration",s),e._emitFunctionFromInclude("imageProcessingFunctions",s),(null===(t=i.connectedPoint)||void 0===t?void 0:t.isConnected)&&(e.compilationString+=i.connectedPoint.type===y.Color4||i.connectedPoint.type===y.Vector4?`${this._declareOutput(n,e)} = ${i.associatedVariableName};\r\n`:`${this._declareOutput(n,e)} = vec4(${i.associatedVariableName}, 1.0);\r\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\r\n",this.convertInputToLinearSpace&&(e.compilationString+=`${n.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\r\n`),e.compilationString+="#else\r\n",e.compilationString+="#ifdef IMAGEPROCESSING\r\n",this.convertInputToLinearSpace&&(e.compilationString+=`${n.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\r\n`),e.compilationString+=`${n.associatedVariableName} = applyImageProcessing(${n.associatedVariableName});\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this.rgb.hasEndpoints&&(e.compilationString+=this._declareOutput(this.rgb,e)+` = ${this.output.associatedVariableName}.xyz;\r\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\r\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var n;super._deserialize(e,t,i),this.convertInputToLinearSpace=null===(n=e.convertInputToLinearSpace)||void 0===n||n}}b([Ot("Convert input to linear space",Dt.Boolean,"ADVANCED")],tO.prototype,"convertInputToLinearSpace",void 0),ye("BABYLON.ImageProcessingBlock",tO);class Kc extends Ye{constructor(e){super(e,F.Fragment,!0),this.registerInput("normal",y.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(y.Color4|y.Vector4|y.Vector3),this.registerInput("tangent",y.Vector4,!1),this.registerInput("world",y.Matrix,!1),this.registerOutput("TBN",y.Object,F.Fragment,new Ji("TBN",this,Gi.Output,Kc,"TBNBlock")),this.registerOutput("row0",y.Vector3,F.Fragment),this.registerOutput("row1",y.Vector3,F.Fragment),this.registerOutput("row2",y.Vector3,F.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return F.Fragment}set target(e){}autoConfigure(e){if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.isSystemValue&&i.systemValue===At.World);t||(t=new xt("world"),t.setAsSystemValue(At.World)),t.output.connectTo(this.world)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"normal"===i.name);t||(t=new xt("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"tangent"===i.name&&i.type===y.Vector4);t||(t=new xt("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var n,s,a,o;const l=this.normal,c=this.tangent;let u=l.isConnected;(null===(n=l.connectInputBlock)||void 0===n?void 0:n.isAttribute)&&!e.isVerticesDataPresent(null===(s=l.connectInputBlock)||void 0===s?void 0:s.name)&&(u=!1);let h=c.isConnected;(null===(a=c.connectInputBlock)||void 0===a?void 0:a.isAttribute)&&!e.isVerticesDataPresent(null===(o=c.connectInputBlock)||void 0===o?void 0:o.name)&&(h=!1),i.setValue("TBNBLOCK",u&&h,!0)}_buildBlock(e){super._buildBlock(e);const i=this.tangent,s=this.TBN,a=this.row0,o=this.row1,l=this.row2;return e.target===F.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                vec3 tbnNormal = normalize(${this.normal.associatedVariableName}).xyz;\n                vec3 tbnTangent = normalize(${i.associatedVariableName}.xyz);\n                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                mat3 ${s.associatedVariableName} = mat3(${this.world.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);\n            `,a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${s.associatedVariableName}[0][0], ${s.associatedVariableName}[0][1], ${s.associatedVariableName}[0][2]);\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec3(${s.associatedVariableName}[1[0], ${s.associatedVariableName}[1][1], ${s.associatedVariableName}[1][2]);\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${s.associatedVariableName}[2][0], ${s.associatedVariableName}[2][1], ${s.associatedVariableName}[2][2]);\r\n`),e.sharedData.blocksWithDefines.push(this)),this}}ye("BABYLON.TBNBlock",Kc);class Ch extends Ye{constructor(e){super(e,F.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",y.Vector4,!1),this.registerInput("worldNormal",y.Vector4,!1),this.registerInput("worldTangent",y.Vector4,!0),this.registerInput("uv",y.Vector2,!1),this.registerInput("normalMapColor",y.Color3,!1),this.registerInput("strength",y.Float,!1),this.registerInput("viewDirection",y.Vector3,!0),this.registerInput("parallaxScale",y.Float,!0),this.registerInput("parallaxHeight",y.Float,!0),this.registerInput("TBN",y.Object,!0,F.VertexAndFragment,new Ji("TBN",this,Gi.Input,Kc,"TBNBlock")),this.registerInput("world",y.Matrix,!0),this.registerOutput("output",y.Vector4),this.registerOutput("uvOffset",y.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const s=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&this.normalMapColor.connectedPoint._ownerBlock.samplerName||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",s,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"uv"===i.name);t||(t=new xt("uv"),t.setAsAttribute()),t.output.connectTo(this.uv)}if(!this.strength.isConnected){const t=new xt("strength");t.value=1,t.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,n=this.worldPosition,s=this.worldNormal,a=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2"),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float"),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,"mat4");let o=null;this.normalMapColor.connectedPoint&&(o=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const l=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&o||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),c=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",u=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r\n#if !defined(NORMALXYSCALE)\r\n1.0/\r\n#endif\r\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\r\n#if !defined(NORMALXYSCALE)\r\n1.0/\r\n#endif\r\n${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const h={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},p=this.TBN;p.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${p.associatedVariableName};\n            #endif\n            `:a.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${s.associatedVariableName}.xyz);\r\n`,e.compilationString+=`vec3 tbnTangent = normalize(${a.associatedVariableName}.xyz);\r\n`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r\n`,e.compilationString+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[h,{search:/varying mat3 vTBN/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:"#define inline\r\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const g=l&&o?`texture2D(${o}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName;return e.compilationString+=this._declareOutput(this.output,e)+" = vec4(0.);\r\n",e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture2D\(bumpSampler,vBumpUV\)/g,replace:`${g}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`mat4 normalMatrix = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${g}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${l&&this.useParallaxOcclusion?o:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${l?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:u},{search:/vBumpInfos.z/g,replace:c},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:n.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:s.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:l?this.viewDirection.associatedVariableName:"vec3(0.)"},h]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\r\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\r\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\r\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\r\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}b([Ot("Invert X axis",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Ch.prototype,"invertX",void 0),b([Ot("Invert Y axis",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Ch.prototype,"invertY",void 0),b([Ot("Use parallax occlusion",Dt.Boolean)],Ch.prototype,"useParallaxOcclusion",void 0),b([Ot("Object Space Mode",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Ch.prototype,"useObjectSpaceNormalMap",void 0),ye("BABYLON.PerturbNormalBlock",Ch),ye("BABYLON.DiscardBlock",class tX extends Ye{constructor(e){super(e,F.Fragment,!0),this.registerInput("value",y.Float,!0),this.registerInput("cutoff",y.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\r\n`,this}}),ye("BABYLON.FrontFacingBlock",class iX extends Ye{constructor(e){super(e,F.Fragment),this.registerOutput("output",y.Float,F.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===F.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";return e.compilationString+=this._declareOutput(this._outputs[0],e)+" = gl_FrontFacing ? 1.0 : 0.0;\r\n",this}}),ye("BABYLON.DerivativeBlock",class nX extends Ye{constructor(e){super(e,F.Fragment),this.registerInput("input",y.AutoDetect,!1),this.registerOutput("dx",y.BasedOnInput),this.registerOutput("dy",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\r\n`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\r\n`),this}}),ye("BABYLON.FragCoordBlock",class rX extends Ye{constructor(e){super(e,F.Fragment),this.registerOutput("xy",y.Vector2,F.Fragment),this.registerOutput("xyz",y.Vector3,F.Fragment),this.registerOutput("xyzw",y.Vector4,F.Fragment),this.registerOutput("x",y.Float,F.Fragment),this.registerOutput("y",y.Float,F.Fragment),this.registerOutput("z",y.Float,F.Fragment),this.registerOutput("w",y.Float,F.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\r\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===F.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}),ye("BABYLON.ScreenSizeBlock",class sX extends Ye{constructor(e){super(e,F.Fragment),this.registerOutput("xy",y.Vector2,F.Fragment),this.registerOutput("x",y.Float,F.Fragment),this.registerOutput("y",y.Float,F.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const n of this._outputs)n.hasEndpoints&&(i+=`${this._declareOutput(n,e)} = ${t}.${n.name};\r\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===F.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}),ye("BABYLON.ScreenSpaceBlock",class aX extends Ye{constructor(e){super(e,F.Fragment),this.registerInput("vector",y.AutoDetect),this.registerInput("worldViewProjection",y.Matrix),this.registerOutput("output",y.Vector2),this.registerOutput("x",y.Float),this.registerOutput("y",y.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e){if(!this.worldViewProjection.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.WorldViewProjection);t||(t=new xt("worldViewProjection"),t.setAsSystemValue(At.WorldViewProjection)),t.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector;if(!t.connectedPoint)return;const n=this.worldViewProjection.associatedVariableName,s=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case y.Vector3:e.compilationString+=`vec4 ${s} = ${n} * vec4(${t.associatedVariableName}, 1.0);\r\n`;break;case y.Vector4:e.compilationString+=`vec4 ${s} = ${n} * ${t.associatedVariableName};\r\n`}return e.compilationString+=`${s}.xy /= ${s}.w;`,e.compilationString+=`${s}.xy = ${s}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${s}.xy;\r\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${s}.x;\r\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${s}.y;\r\n`),this}}),ye("BABYLON.TwirlBlock",class oX extends Ye{constructor(e){super(e,F.Fragment),this.registerInput("input",y.Vector2),this.registerInput("strength",y.Float),this.registerInput("center",y.Vector2),this.registerInput("offset",y.Vector2),this.registerOutput("output",y.Vector2),this.registerOutput("x",y.Float),this.registerOutput("y",y.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new xt("center");e.value=new We(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new xt("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new xt("offset");e.value=new We(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),n=e._getFreeVariableName("x"),s=e._getFreeVariableName("y"),a=e._getFreeVariableName("result");return e.compilationString+=`\n            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            float ${i} = ${this.strength.associatedVariableName} * length(${t});\n            float ${n} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            float ${s} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            vec2 ${a} = vec2(${n} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${s} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${a};\r\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${a}.x;\r\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${a}.y;\r\n`),this}});class pp extends Ye{constructor(e){super(e,F.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",y.Float),this.registerInput("worldPosition",y.Vector3),this.registerInput("worldNormal",y.Vector3),this.registerInput("worldTangent",y.AutoDetect,!0),this.registerOutput("output",y.Vector4),this.registerOutput("xyz",y.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];!this.generateInWorldSpace&&!this.worldTangent.isConnected&&console.error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const s=`\n            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {\n                ${this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(normal, tangent);\n            mat3 TBN = mat3(tangent, biTangent, normal);\n            "}\n                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}\n                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(normal, worlddX);\n                vec3 crossY = cross(normal, worlddY);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * normal) - inToNormal);\n                ${this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            "}\n                return vec4(result, 0.);\n            }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",s,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\r\n`,this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\r\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\r\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\r\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}b([Ot("Generate in world space instead of tangent space",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],pp.prototype,"generateInWorldSpace",void 0),b([Ot("Force normalization for the worldNormal input",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],pp.prototype,"automaticNormalizationNormal",void 0),b([Ot("Force normalization for the worldTangent input",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],pp.prototype,"automaticNormalizationTangent",void 0),ye("BABYLON.HeightToNormalBlock",pp),ye("BABYLON.FragDepthBlock",class lX extends Ye{constructor(e){super(e,F.Fragment,!0),this.registerInput("depth",y.Float,!0),this.registerInput("worldPos",y.Vector4,!0),this.registerInput("viewProjection",y.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){return super._buildBlock(e),this.depth.isConnected?e.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\r\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                float v = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                gl_FragDepth = v;\n    \n            `:console.warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}),ye("BABYLON.ShadowMapBlock",class cX extends Ye{constructor(e){super(e,F.Fragment),this.registerInput("worldPosition",y.Vector4,!1),this.registerInput("viewProjection",y.Matrix,!1),this.registerInput("worldNormal",y.AutoDetect,!0),this.registerOutput("depth",y.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM","vec3"),e._emitUniformFromString("lightDataSM","vec3"),e._emitUniformFromString("depthValuesSM","vec2"),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\r\n`,e.compilationString+="vec3 vPositionWSM;\r\n",e.compilationString+="float vDepthMetricSM = 0.0;\r\n",e.compilationString+="float zSM;\r\n",this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+="\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    gl_FragDepth = (clipPos.z / clipPos.w);\n                #else\n                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        ",e.compilationString+=`${this._declareOutput(this.depth,e)} = vec3(depthSM, 1., 1.);\r\n`,this}}),ye("BABYLON.FogBlock",class uX extends Ye{constructor(e){super(e,F.VertexAndFragment,!1),this.registerInput("worldPosition",y.Vector4,!1,F.Vertex),this.registerInput("view",y.Matrix,!1,F.Vertex),this.registerInput("input",y.AutoDetect,!1,F.Fragment),this.registerInput("fogColor",y.AutoDetect,!1,F.Fragment),this.registerOutput("output",y.Color3,F.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.View);t||(t=new xt("view"),t.setAsSystemValue(At.View)),t.output.connectTo(this.view)}if(!this.fogColor.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.FogColor);t||(t=new xt("fogColor",void 0,y.Color3),t.setAsSystemValue(At.FogColor)),t.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const n=e.getScene();i.setValue("FOG",t.fogEnabled&&fe.GetFogState(e,n))}bind(e,t,i){if(!i)return;const n=i.getScene();e.setFloat4(this._fogParameters,n.fogMode,n.fogStart,n.fogEnd,n.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===F.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,n=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const s=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+="#ifdef FOG\r\n",e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\r\n`,e.compilationString+=this._declareOutput(s,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${n.associatedVariableName}.rgb;\r\n`,e.compilationString+=`#else\r\n${this._declareOutput(s,e)} =  ${i.associatedVariableName}.rgb;\r\n`,e.compilationString+="#endif\r\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\r\n`}return this}});class CE extends Ye{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?F.Fragment:F.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?F.Fragment:F.Vertex}constructor(e){super(e,F.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",y.Vector4,!1,F.Vertex),this.registerInput("worldNormal",y.Vector4,!1,F.Fragment),this.registerInput("cameraPosition",y.Vector3,!1,F.Fragment),this.registerInput("glossiness",y.Float,!0,F.Fragment),this.registerInput("glossPower",y.Float,!0,F.Fragment),this.registerInput("diffuseColor",y.Color3,!0,F.Fragment),this.registerInput("specularColor",y.Color3,!0,F.Fragment),this.registerInput("view",y.Matrix,!0),this.registerOutput("diffuseOutput",y.Color3,F.Fragment),this.registerOutput("specularOutput",y.Color3,F.Fragment),this.registerOutput("shadow",y.Float,F.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.CameraPosition);t||(t=new xt("cameraPosition"),t.setAsSystemValue(At.CameraPosition)),t.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const n=e.getScene();if(this.light){const s={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};fe.PrepareDefinesForLight(n,e,this.light,this._lightId,i,!0,s),s.needRebuild&&i.rebuild()}else fe.PrepareDefinesForLights(n,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,n){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const a=e.uniforms.indexOf("vLightData"+s)>=0;fe.PrepareUniformsAndSamplersForLight(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],n,a)}}bind(e,t,i){if(!i)return;const n=i.getScene();this.light?fe.BindLight(this.light,this._lightId,n,e,!0):fe.BindLights(n,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+t.associatedVariableName;e._emitVaryingFromString(n,"vec4")&&(e.compilationString+=`${n} = ${t.associatedVariableName};\r\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\r\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==F.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;let n=i.associatedVariableName;this.generateOnlyFragmentCode?(n=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`vec3 ${n};\r\n`,t),e.compilationString+=`${n} = ${i.associatedVariableName}.xyz;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${i.associatedVariableName}`:void 0})):n="v_"+n+".xyz",e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:n}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:n}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${n});\r\n`),e.compilationString+="lightingInfo info;\r\n",e.compilationString+="float shadow = 1.;\r\n",e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\r\n`,e.compilationString+="vec3 diffuseBase = vec3(0., 0., 0.);\r\n",e.compilationString+="vec3 specularBase = vec3(0., 0., 0.);\r\n",e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\r\n`),e.compilationString+=e._emitCodeFromInclude("lightFragment",t,this.light?{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}:{repeatKey:"maxSimultaneousLights"});const a=this.specularOutput;return e.compilationString+=this._declareOutput(this.diffuseOutput,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\r\n`,a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\r\n`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+" = shadow;\r\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}b([Ot("Generate only fragment code",Dt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:CE._OnGenerateOnlyFragmentCodeChanged}})],CE.prototype,"generateOnlyFragmentCode",void 0),ye("BABYLON.LightBlock",CE);class Il extends Ye{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:Je.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,F.VertexAndFragment),this.registerOutput("source",y.Object,F.VertexAndFragment,new Ji("source",this,Gi.Output,Il,"ImageSourceBlock"))}bind(e){!this.texture||e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===F.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Zi.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=j.Parse(e.texture,t,i))}}ye("BABYLON.ImageSourceBlock",Il),ye("BABYLON.TextureBlock",class hX extends Ye{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:Je.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(e))}get samplerName(){return this._imageSource?this._imageSource.samplerName:this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const i=null!==(t=this.texture.getScene())&&void 0!==t?t:Je.LastCreatedScene;null==i||i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const i=null!==(t=this.texture.getScene())&&void 0!==t?t:Je.LastCreatedScene;null==i||i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?F.Fragment:F.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",y.AutoDetect,!1,F.VertexAndFragment),this.registerInput("source",y.Object,!0,F.VertexAndFragment,new Ji("source",this,Gi.Input,Il,"ImageSourceBlock")),this.registerInput("layer",y.Float,!0),this.registerOutput("rgba",y.Color4,F.Neutral),this.registerOutput("rgb",y.Color3,F.Neutral),this.registerOutput("r",y.Float,F.Neutral),this.registerOutput("g",y.Float,F.Neutral),this.registerOutput("b",y.Float,F.Neutral),this.registerOutput("a",y.Float,F.Neutral),this.registerOutput("level",y.Float,F.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector2|y.Vector3|y.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return F.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return F.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===F.Fragment)return F.Fragment;if(e.target===F.Vertex)return F.VertexAndFragment;if(e.target===F.Neutral||e.target===F.VertexAndFragment){const t=e.ownerBlock;if(t.target===F.Fragment)return F.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return F.VertexAndFragment}set target(e){}autoConfigure(e){if(!this.uv.isConnected)if(e.mode===mr.PostProcess){const t=e.getBlockByPredicate(i=>"uv"===i.name);t&&t.connectTo(this)}else{const t=e.mode===mr.Particle?"particle_uv":"uv";let i=e.getInputBlockByPredicate(n=>n.isAttribute&&n.name===t);i||(i=new xt("uv"),i.setAsAttribute(t)),i.output.connectTo(this.uv)}}initializeDefines(e,t,i){!i._areTexturesDirty||void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,!0),i.setValue(this._gammaDefineName,s,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==F.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\r\n`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\r\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r\n`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r\n`,e.compilationString+="#endif\r\n",this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name,!0)}}_getUVW(e){var t,i,n;let s=e;return null!==(n=null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)&&void 0!==n&&n&&(s=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),s}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\r\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._getUVW(this._transformedUVName)});\r\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._getUVW(this._mainUVName?this._mainUVName:this.uv.associatedVariableName)});\r\n`,e.compilationString+="#endif\r\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===F.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==F.Fragment?this._generateTextureLookup(e):e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this.samplerName}, ${this._getUVW(i.associatedVariableName)});\r\n`}_generateConversionCode(e,t,i){"a"!==i&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i,n=!1){if(n){if(e.target===F.Fragment)return;return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===F.Fragment)return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`,void this._generateConversionCode(e,t,i);let s="";this.disableLevelMultiplication||(s=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${s};\r\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){var t,i,n,s;if(super._buildBlock(e),this._imageSource=this.source.isConnected?this.source.connectedPoint.ownerBlock:null,(e.target===F.Vertex||this._fragmentOnly||e.target===F.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===F.Fragment||this._isMixed&&e.target===F.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),(null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target===F.Fragment){if(this._outputs.some(o=>o.isConnectedInFragmentShader)){this._isMixed&&!this._imageSource&&((null===(s=null===(n=this._texture)||void 0===n?void 0:n._texture)||void 0===s?void 0:s.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const o of this._outputs)o.hasEndpoints&&"level"!==o.name&&this._writeOutput(e,o,o.name);return this}}else this._injectVertexCode(e)}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r\n`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Zi.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=j.Parse(e.texture,t,i))}});class Ih extends Ye{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:Je.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?F.Fragment:F.VertexAndFragment)}constructor(e){super(e,F.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&"position"===i.name);t||(t=new xt("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.World);t||(t=new xt("world"),t.setAsSystemValue(At.World)),t.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.View);t||(t=new xt("view"),t.setAsSystemValue(At.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const n=this._getTexture();!n||!n.getTextureMatrix||(i.setValue(this._define3DName,n.isCube,!0),i.setValue(this._defineLocalCubicName,!!n.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===n.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===n.coordinatesMode,!0),i.setValue(this._defineCubicName,3===n.coordinatesMode||6===n.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===n.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===n.coordinatesMode,!0),i.setValue(this._definePlanarName,2===n.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===n.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===n.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===n.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===n.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){const n=this._getTexture();if(i&&n&&(e.setMatrix(this._reflectionMatrixName,n.getReflectionTextureMatrix()),e.setTexture(n.isCube?this._cubeSamplerName:this._2DSamplerName,n),n.boundingBoxSize)){const s=n;e.setVector3(this._reflectionPositionName,s.boundingBoxPosition),e.setVector3(this._reflectionSizeName,s.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===F.Vertex)return"";this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");let t="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(i,"vec4"))&&(t+=`${this.generateOnlyFragmentCode?"vec4 ":""}${i} = ${this.worldPosition.associatedVariableName};\r\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName))&&(t+=`#ifdef ${this._defineSkyboxName}\r\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\r\n`,t+="#endif\r\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,"vec3",`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\r\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._directionWName} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\r\n`,t+="#endif\r\n"),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r\n`,e._samplerDeclaration+="#else\r\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r\n`,e._samplerDeclaration+="#endif\r\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")}handleFragmentSideCodeReflectionCoords(e,t,i=!1,n=!1){t||(t=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const s=this._reflectionMatrixName,a=`normalize(${this._directionWName})`,l=`${this.cameraPosition.associatedVariableName}`,c=`${this.view.associatedVariableName}`;let u=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeMirroredFixedEquirectangularCoords(${t}, ${e+=".xyz"}, ${a});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeFixedEquirectangularCoords(${t}, ${e}, ${a});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                vec3 ${this._reflectionVectorName} = computeEquirectangularCoords(${t}, ${e}, ${l}.xyz, ${s});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                vec3 ${this._reflectionVectorName} = computeSphericalCoords(${t}, ${e}, ${c}, ${s});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                vec3 ${this._reflectionVectorName} = computePlanarCoords(${t}, ${e}, ${l}.xyz, ${s});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    vec3 ${this._reflectionVectorName} = computeCubicLocalCoords(${t}, ${e}, ${l}.xyz, ${s}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                vec3 ${this._reflectionVectorName} = computeCubicCoords(${t}, ${e}, ${l}.xyz, ${s});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                vec3 ${this._reflectionVectorName} = computeProjectionCoords(${t}, ${c}, ${s});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                vec3 ${this._reflectionVectorName} = computeSkyBoxCoords(${this._positionUVWName}, ${s});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                vec3 ${this._reflectionVectorName} = vec3(0, 0, 0);\n            #endif\r\n`;return n||(u+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\r\n`),i||(u+=`\n                #ifdef ${this._define3DName}\n                    vec3 ${this._reflectionCoordsName} = ${this._reflectionVectorName};\n                #else\n                    vec2 ${this._reflectionCoordsName} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\r\n`),u}handleFragmentSideCodeReflectionColor(e,t=".rgb"){let n=`${"vec"+(0===t.length?"4":t.length-1)} ${this._reflectionColorName};\n            #ifdef ${this._define3DName}\r\n`;return n+=e?`${this._reflectionColorName} = textureCubeLodEXT(${this._cubeSamplerName}, ${this._reflectionVectorName}, ${e})${t};\r\n`:`${this._reflectionColorName} = textureCube(${this._cubeSamplerName}, ${this._reflectionVectorName})${t};\r\n`,n+="\n            #else\r\n",n+=e?`${this._reflectionColorName} = texture2DLodEXT(${this._2DSamplerName}, ${this._reflectionCoordsName}, ${e})${t};\r\n`:`${this._reflectionColorName} = texture2D(${this._2DSamplerName}, ${this._reflectionCoordsName})${t};\r\n`,n+="#endif\r\n",n}writeOutputs(e,t){let i="";if(e.target===F.Fragment)for(const n of this._outputs)n.hasEndpoints&&(i+=`${this._declareOutput(n,e)} = ${t}.${n.name};\r\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\r\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\r\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Zi.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=e.texture.isCube?Nn.Parse(e.texture,t,i):j.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}b([Ot("Generate only fragment code",Dt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Ih._OnGenerateOnlyFragmentCodeChanged}})],Ih.prototype,"generateOnlyFragmentCode",void 0),ye("BABYLON.ReflectionTextureBaseBlock",Ih),ye("BABYLON.ReflectionTextureBlock",class dX extends Ih{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?F.Fragment:F.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?F.Fragment:F.Vertex}constructor(e){super(e),this.registerInput("position",y.AutoDetect,!1,F.Vertex),this.registerInput("worldPosition",y.Vector4,!1,F.Vertex),this.registerInput("worldNormal",y.Vector4,!1,F.Fragment),this.registerInput("world",y.Matrix,!1,F.Vertex),this.registerInput("cameraPosition",y.Vector3,!1,F.Fragment),this.registerInput("view",y.Matrix,!1,F.Fragment),this.registerOutput("rgb",y.Color3,F.Fragment),this.registerOutput("rgba",y.Color4,F.Fragment),this.registerOutput("r",y.Float,F.Fragment),this.registerOutput("g",y.Float,F.Fragment),this.registerOutput("b",y.Float,F.Fragment),this.registerOutput("a",y.Float,F.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.CameraPosition);t||(t=new xt("cameraPosition"),t.setAsSystemValue(At.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==F.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\r\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}});class gp extends Ye{constructor(e){super(e,F.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",y.AutoDetect,!1,F.VertexAndFragment),this.registerOutput("depth",y.Float,F.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector2|y.Vector3|y.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?F.VertexAndFragment:F.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===y.Vector3?"3":t.type===y.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r\n`,this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===F.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r\n`}else e.compilationString+=this.uv.ownerBlock.target!==F.Fragment?`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r\n`:`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r\n`}_writeOutput(e,t,i,n=!1){if(n){if(e.target===F.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}else e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==F.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}b([Ot("Use non linear depth",Dt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(r,e)=>{let i=!1;return e.useNonLinearDepth&&(e.storeCameraSpaceZ=!1,i=!0),r.disableDepthRenderer(),i}}})],gp.prototype,"useNonLinearDepth",void 0),b([Ot("Store Camera space Z",Dt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(r,e)=>{let i=!1;return e.storeCameraSpaceZ&&(e.useNonLinearDepth=!1,i=!0),r.disableDepthRenderer(),i}}})],gp.prototype,"storeCameraSpaceZ",void 0),b([Ot("Force 32 bits float",Dt.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:r=>r.disableDepthRenderer()}})],gp.prototype,"force32itsFloat",void 0),ye("BABYLON.SceneDepthBlock",gp),ye("BABYLON.ClipPlanesBlock",class fX extends Ye{constructor(e){super(e,F.VertexAndFragment,!0),this.registerInput("worldPosition",y.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return F.VertexAndFragment}set target(e){}prepareDefines(e,t,i){var n,s,a,o,l,c;const u=e.getScene(),h=!!(null!==(n=t.clipPlane)&&void 0!==n?n:u.clipPlane),d=!!(null!==(s=t.clipPlane2)&&void 0!==s?s:u.clipPlane2),f=!!(null!==(a=t.clipPlane3)&&void 0!==a?a:u.clipPlane3),p=!!(null!==(o=t.clipPlane4)&&void 0!==o?o:u.clipPlane4),g=!!(null!==(l=t.clipPlane5)&&void 0!==l?l:u.clipPlane5),_=!!(null!==(c=t.clipPlane6)&&void 0!==c?c:u.clipPlane6);i.setValue("CLIPPLANE",h,!0),i.setValue("CLIPPLANE2",d,!0),i.setValue("CLIPPLANE3",f,!0),i.setValue("CLIPPLANE4",p,!0),i.setValue("CLIPPLANE5",g,!0),i.setValue("CLIPPLANE6",_,!0)}bind(e,t,i){i&&Uo(e,t,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==F.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),void e._emitUniformFromString("vClipPlane6","vec4")}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}),ye("BABYLON.AddBlock",class pX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\r\n`,this}}),ye("BABYLON.ScaleBlock",class gX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.AutoDetect),this.registerInput("factor",y.Float),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\r\n`,this}});class IE extends Ye{constructor(e){super(e,F.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\r\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\r\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\r\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}b([Ot("Minimum",Dt.Float)],IE.prototype,"minimum",void 0),b([Ot("Maximum",Dt.Float)],IE.prototype,"maximum",void 0),ye("BABYLON.ClampBlock",IE),ye("BABYLON.CrossBlock",class _X extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix),this._inputs[0].excludedConnectionPointTypes.push(y.Vector2),this._inputs[1].excludedConnectionPointTypes.push(y.Float),this._inputs[1].excludedConnectionPointTypes.push(y.Matrix),this._inputs[1].excludedConnectionPointTypes.push(y.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\r\n`,this}}),ye("BABYLON.CustomBlock",class mX extends Ye{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(s=>{const a=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),o=e._getGLType(s.type);t=t.replace(a,o),i=i.replace(a,o)}),this._outputs.forEach(s=>{const a=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),o=e._getGLType(s.type);t=t.replace(a,o),i=i.replace(a,o)}),e._emitFunction(i,t,""),this._outputs.forEach(s=>{e.compilationString+=this._declareOutput(s,e)+";\r\n"}),e.compilationString+=i+"(";let n=!1;return this._inputs.forEach((s,a)=>{a>0&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName,n=!0}),this._outputs.forEach((s,a)=>{(a>0||n)&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName}),e.compilationString+=");\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\r\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,n;this._options=e,this._code=e.code.join("\r\n")+"\r\n",this.name=this.name||e.name,this.target=F[e.target],null===(t=e.inParameters)||void 0===t||t.forEach((s,a)=>{this.registerInput(s.name,y[s.type]),Object.defineProperty(this,s.name,{get:function(){return this._inputs[a]},enumerable:!0,configurable:!0})}),null===(i=e.outParameters)||void 0===i||i.forEach((s,a)=>{this.registerOutput(s.name,y[s.type]),Object.defineProperty(this,s.name,{get:function(){return this._outputs[a]},enumerable:!0,configurable:!0}),"BasedOnInput"===s.type&&(this._outputs[a]._typeConnectionSource=this._findInputByName(s.typeFromInput)[0])}),null===(n=e.inLinkedConnectionTypes)||void 0===n||n.forEach(s=>{this._linkConnectionTypes(this._findInputByName(s.input1)[1],this._findInputByName(s.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}),ye("BABYLON.DotBlock",class TX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix),this._inputs[1].excludedConnectionPointTypes.push(y.Float),this._inputs[1].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),ye("BABYLON.NormalizeBlock",class EX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const i=this._inputs[0];return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = normalize(${i.associatedVariableName});\r\n`,this}}),ye("BABYLON.ColorMergerBlock",class vX extends Ye{constructor(e){super(e,F.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",y.Color3,!0),this.registerInput("r",y.Float,!0),this.registerInput("g",y.Float,!0),this.registerInput("b",y.Float,!0),this.registerInput("a",y.Float,!0),this.registerOutput("rgba",y.Color4),this.registerOutput("rgb",y.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,n=this.b,s=this.a,a=this.rgbIn,o=this._outputs[0],l=this._outputs[1];return a.isConnected?(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${a.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${a.associatedVariableName}${this._buildSwizzle(3)};\r\n`)):(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(3)};\r\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var n,s,a,o;super._deserialize(e,t,i),this.rSwizzle=null!==(n=e.rSwizzle)&&void 0!==n?n:"r",this.gSwizzle=null!==(s=e.gSwizzle)&&void 0!==s?s:"g",this.bSwizzle=null!==(a=e.bSwizzle)&&void 0!==a?a:"b",this.aSwizzle=null!==(o=e.aSwizzle)&&void 0!==o?o:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\r\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\r\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\r\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\r\n`,e}}),ye("BABYLON.VectorSplitterBlock",class SX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("xyzw",y.Vector4,!0),this.registerInput("xyz ",y.Vector3,!0),this.registerInput("xy ",y.Vector2,!0),this.registerOutput("xyz",y.Vector3),this.registerOutput("xy",y.Vector2),this.registerOutput("zw",y.Vector2),this.registerOutput("x",y.Float),this.registerOutput("y",y.Float),this.registerOutput("z",y.Float),this.registerOutput("w",y.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],n=this._outputs[1],s=this._outputs[2],a=this._outputs[3],o=this._outputs[4],l=this._outputs[5],c=this._outputs[6];return i.hasEndpoints&&(e.compilationString+=t===this.xyIn?this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\r\n`:this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\r\n`),s.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(s,e)+` = ${this.xyzw.associatedVariableName}.zw;\r\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.xy;\r\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.x;\r\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.y;\r\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${t.associatedVariableName}.z;\r\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${t.associatedVariableName}.w;\r\n`),this}}),ye("BABYLON.LerpBlock",class xX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerInput("gradient",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(y.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\r\n`,this}}),ye("BABYLON.DivideBlock",class AX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\r\n`,this}}),ye("BABYLON.SubtractBlock",class yX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\r\n`,this}}),ye("BABYLON.StepBlock",class bX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.Float),this.registerInput("edge",y.Float),this.registerOutput("output",y.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\r\n`,this}});class iO extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = 1. - ${this.input.associatedVariableName};\r\n`,this}}ye("BABYLON.OneMinusBlock",iO),ye("BABYLON.OppositeBlock",iO);class nO extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("worldPosition",y.Vector4),this.registerInput("cameraPosition",y.Vector3),this.registerOutput("output",y.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.CameraPosition);t||(t=new xt("cameraPosition"),t.setAsSystemValue(At.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\r\n`,this}}ye("BABYLON.ViewDirectionBlock",nO),ye("BABYLON.FresnelBlock",class CX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("worldNormal",y.Vector4),this.registerInput("viewDirection",y.Vector3),this.registerInput("bias",y.Float),this.registerInput("power",y.Float),this.registerOutput("fresnel",y.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new nO("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const t=new xt("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new xt("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){return super._buildBlock(e),e._emitFunctionFromInclude("fresnelFunction",`//${this.name}`,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\r\n`,this}}),ye("BABYLON.MaxBlock",class IX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),ye("BABYLON.MinBlock",class RX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),ye("BABYLON.DistanceBlock",class MX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix),this._inputs[1].excludedConnectionPointTypes.push(y.Float),this._inputs[1].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\r\n`,this}}),ye("BABYLON.LengthBlock",class DX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.AutoDetect),this.registerOutput("output",y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = length(${this.value.associatedVariableName});\r\n`,this}}),ye("BABYLON.NegateBlock",class PX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = -1.0 * ${this.value.associatedVariableName};\r\n`,this}}),ye("BABYLON.PowBlock",class wX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.AutoDetect),this.registerInput("power",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\r\n`,this}}),ye("BABYLON.RandomNumberBlock",class OX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("seed",y.AutoDetect),this.registerOutput("output",y.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector2|y.Vector3|y.Vector4|y.Color3|y.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\r\n`,this}}),ye("BABYLON.ArcTan2Block",class FX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("x",y.Float),this.registerInput("y",y.Float),this.registerOutput("output",y.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\r\n`,this}}),ye("BABYLON.SmoothStepBlock",class NX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.AutoDetect),this.registerInput("edge0",y.Float),this.registerInput("edge1",y.Float),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\r\n`,this}}),ye("BABYLON.ReciprocalBlock",class LX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this.input.type===y.Matrix?this._declareOutput(t,e)+` = inverse(${this.input.associatedVariableName});\r\n`:this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\r\n`,this}}),ye("BABYLON.ReplaceColorBlock",class BX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.AutoDetect),this.registerInput("reference",y.AutoDetect),this.registerInput("distance",y.Float),this.registerInput("replacement",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(y.Float),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix),this._inputs[1].excludedConnectionPointTypes.push(y.Float),this._inputs[1].excludedConnectionPointTypes.push(y.Matrix),this._inputs[3].excludedConnectionPointTypes.push(y.Float),this._inputs[3].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+";\r\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\r\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\r\n`,e.compilationString+="} else {\r\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\r\n`,e.compilationString+="}\r\n",this}}),ye("BABYLON.PosterizeBlock",class UX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("value",y.AutoDetect),this.registerInput("steps",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(y.Matrix),this._inputs[1].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\r\n`,this}});var Rl=(()=>{return(r=Rl||(Rl={}))[r.SawTooth=0]="SawTooth",r[r.Square=1]="Square",r[r.Triangle=2]="Triangle",Rl;var r})();ye("BABYLON.WaveBlock",class VX extends Ye{constructor(e){super(e,F.Neutral),this.kind=Rl.SawTooth,this.registerInput("input",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(y.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case Rl.SawTooth:e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\r\n`;break;case Rl.Square:e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\r\n`;break;case Rl.Triangle:e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\r\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}});class RE{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}ye("BABYLON.GradientBlock",class kX extends Ye{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,F.Neutral),this.colorSteps=[new RE(0,Fe.Black()),new RE(1,Fe.White())],this.onValueChangedObservable=new J,this.registerInput("gradient",y.AutoDetect),this.registerOutput("output",y.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Float|y.Vector2|y.Vector3|y.Vector4|y.Color3|y.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=this._declareOutput(t,e)+" = vec3(0., 0., 0.);\r\n");const i=e._getFreeVariableName("gradientTempColor"),n=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\r\n`,e.compilationString+=`float ${n};\r\n`;let s=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==y.Float&&(s+=".x");for(let a=1;a<this.colorSteps.length;a++){const o=this.colorSteps[a],l=this.colorSteps[a-1];e.compilationString+=`${n} = clamp((${s} - ${e._emitFloat(l.step)}) / (${e._emitFloat(o.step)} -  ${e._emitFloat(l.step)}), 0.0, 1.0) * step(${e._emitFloat(a)}, ${e._emitFloat(this.colorSteps.length-1)});\r\n`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(a)}, ${n});\r\n`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\r\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const n of e.colorSteps)this.colorSteps.push(new RE(n.step,new Fe(n.color.r,n.color.g,n.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\r\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\r\n`;return e}}),ye("BABYLON.NLerpBlock",class GX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerInput("gradient",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(y.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\r\n`,this}});class rO extends Ye{constructor(e){super(e,F.Neutral),this.manhattanDistance=!1,this.registerInput("seed",y.Vector3),this.registerInput("jitter",y.Float),this.registerOutput("output",y.Vector2),this.registerOutput("x",y.Float),this.registerOutput("y",y.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\r\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\r\n",t+="}\r\n\r\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r\n",t+="    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r\n",t+="}\r\n\r\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r\n",t+="    float K = 0.142857142857; // 1/7\r\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\r\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\r\n",t+="    float Kz = 0.166666666667; // 1/6\r\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\r\n",t+="\r\n",t+="    vec3 Pi = mod(floor(P), 289.0);\r\n",t+="    vec3 Pf = fract(P) - 0.5;\r\n",t+="\r\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r\n",t+="\r\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\r\n",t+="    vec3 p2 = permute(p + Pi.y);\r\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\r\n",t+="\r\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\r\n",t+="    vec3 p12 = permute(p1 + Pi.z);\r\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\r\n",t+="\r\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\r\n",t+="    vec3 p22 = permute(p2 + Pi.z);\r\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\r\n",t+="\r\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\r\n",t+="    vec3 p32 = permute(p3 + Pi.z);\r\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\r\n",t+="\r\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\r\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r\n",t+="\r\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\r\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\r\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\r\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\r\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\r\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\r\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\r\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\r\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r\n",t+="\r\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\r\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\r\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\r\n",t+="\r\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\r\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\r\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\r\n",t+="\r\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\r\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\r\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\r\n",t+="\r\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\r\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\r\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\r\n",t+="\r\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\r\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\r\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\r\n",t+="\r\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\r\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\r\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\r\n",t+="\r\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\r\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\r\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\r\n",t+="\r\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\r\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\r\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\r\n",t+="\r\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\r\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\r\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\r\n",t+="\r\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r\n",t+="    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r\n",t+="\r\n",t+="    vec3 d1a = min(d11, d12);\r\n",t+="    d12 = max(d11, d12);\r\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r\n",t+="    d13 = max(d1a, d13);\r\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\r\n",t+="    vec3 d2a = min(d21, d22);\r\n",t+="    d22 = max(d21, d22);\r\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r\n",t+="    d23 = max(d2a, d23);\r\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\r\n",t+="    vec3 d3a = min(d31, d32);\r\n",t+="    d32 = max(d31, d32);\r\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r\n",t+="    d33 = max(d3a, d33);\r\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\r\n",t+="    vec3 da = min(d11, d21);\r\n",t+="    d21 = max(d11, d21);\r\n",t+="    d11 = min(da, d31); // Smallest now in d11\r\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\r\n",t+="    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r\n",t+="    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\r\n",t+="    d12 = min(d12, d22); // nor in d22\r\n",t+="    d12 = min(d12, d31); // nor in d31\r\n",t+="    d12 = min(d12, d32); // nor in d32\r\n",t+="    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r\n",t+="    d11.y = min(d11.y,d12.z); // Only two more to go\r\n",t+="    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r\n",t+="    return sqrt(d11.xy); // F1, F2\r\n",t+="}\r\n\r\n",e._emitFunction("worley3D","vec3 permute(vec3 x){\r\n    return mod((34.0 * x + 1.0) * x, 289.0);\r\n}\r\n\r\nvec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r\n    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r\n}\r\n\r\nvec2 worley(vec3 P, float jitter, bool manhattanDistance){\r\n    float K = 0.142857142857; // 1/7\r\n    float Ko = 0.428571428571; // 1/2-K/2\r\n    float  K2 = 0.020408163265306; // 1/(7*7)\r\n    float Kz = 0.166666666667; // 1/6\r\n    float Kzo = 0.416666666667; // 1/2-1/6*2\r\n\r\n    vec3 Pi = mod(floor(P), 289.0);\r\n    vec3 Pf = fract(P) - 0.5;\r\n\r\n    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r\n    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r\n    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r\n\r\n    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r\n    vec3 p1 = permute(p + Pi.y - 1.0);\r\n    vec3 p2 = permute(p + Pi.y);\r\n    vec3 p3 = permute(p + Pi.y + 1.0);\r\n\r\n    vec3 p11 = permute(p1 + Pi.z - 1.0);\r\n    vec3 p12 = permute(p1 + Pi.z);\r\n    vec3 p13 = permute(p1 + Pi.z + 1.0);\r\n\r\n    vec3 p21 = permute(p2 + Pi.z - 1.0);\r\n    vec3 p22 = permute(p2 + Pi.z);\r\n    vec3 p23 = permute(p2 + Pi.z + 1.0);\r\n\r\n    vec3 p31 = permute(p3 + Pi.z - 1.0);\r\n    vec3 p32 = permute(p3 + Pi.z);\r\n    vec3 p33 = permute(p3 + Pi.z + 1.0);\r\n\r\n    vec3 ox11 = fract(p11*K) - Ko;\r\n    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r\n    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r\n\r\n    vec3 ox12 = fract(p12*K) - Ko;\r\n    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r\n    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r\n\r\n    vec3 ox13 = fract(p13*K) - Ko;\r\n    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r\n    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r\n\r\n    vec3 ox21 = fract(p21*K) - Ko;\r\n    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r\n    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r\n\r\n    vec3 ox22 = fract(p22*K) - Ko;\r\n    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r\n    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r\n\r\n    vec3 ox23 = fract(p23*K) - Ko;\r\n    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r\n    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r\n\r\n    vec3 ox31 = fract(p31*K) - Ko;\r\n    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r\n    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r\n\r\n    vec3 ox32 = fract(p32*K) - Ko;\r\n    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r\n    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r\n\r\n    vec3 ox33 = fract(p33*K) - Ko;\r\n    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r\n    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r\n\r\n    vec3 dx11 = Pfx + jitter*ox11;\r\n    vec3 dy11 = Pfy.x + jitter*oy11;\r\n    vec3 dz11 = Pfz.x + jitter*oz11;\r\n\r\n    vec3 dx12 = Pfx + jitter*ox12;\r\n    vec3 dy12 = Pfy.x + jitter*oy12;\r\n    vec3 dz12 = Pfz.y + jitter*oz12;\r\n\r\n    vec3 dx13 = Pfx + jitter*ox13;\r\n    vec3 dy13 = Pfy.x + jitter*oy13;\r\n    vec3 dz13 = Pfz.z + jitter*oz13;\r\n\r\n    vec3 dx21 = Pfx + jitter*ox21;\r\n    vec3 dy21 = Pfy.y + jitter*oy21;\r\n    vec3 dz21 = Pfz.x + jitter*oz21;\r\n\r\n    vec3 dx22 = Pfx + jitter*ox22;\r\n    vec3 dy22 = Pfy.y + jitter*oy22;\r\n    vec3 dz22 = Pfz.y + jitter*oz22;\r\n\r\n    vec3 dx23 = Pfx + jitter*ox23;\r\n    vec3 dy23 = Pfy.y + jitter*oy23;\r\n    vec3 dz23 = Pfz.z + jitter*oz23;\r\n\r\n    vec3 dx31 = Pfx + jitter*ox31;\r\n    vec3 dy31 = Pfy.z + jitter*oy31;\r\n    vec3 dz31 = Pfz.x + jitter*oz31;\r\n\r\n    vec3 dx32 = Pfx + jitter*ox32;\r\n    vec3 dy32 = Pfy.z + jitter*oy32;\r\n    vec3 dz32 = Pfz.y + jitter*oz32;\r\n\r\n    vec3 dx33 = Pfx + jitter*ox33;\r\n    vec3 dy33 = Pfy.z + jitter*oy33;\r\n    vec3 dz33 = Pfz.z + jitter*oz33;\r\n\r\n    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r\n    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r\n    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r\n    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r\n    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r\n    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r\n    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r\n    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r\n    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r\n\r\n    vec3 d1a = min(d11, d12);\r\n    d12 = max(d11, d12);\r\n    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r\n    d13 = max(d1a, d13);\r\n    d12 = min(d12, d13); // 2nd smallest now not in d13\r\n    vec3 d2a = min(d21, d22);\r\n    d22 = max(d21, d22);\r\n    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r\n    d23 = max(d2a, d23);\r\n    d22 = min(d22, d23); // 2nd smallest now not in d23\r\n    vec3 d3a = min(d31, d32);\r\n    d32 = max(d31, d32);\r\n    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r\n    d33 = max(d3a, d33);\r\n    d32 = min(d32, d33); // 2nd smallest now not in d33\r\n    vec3 da = min(d11, d21);\r\n    d21 = max(d11, d21);\r\n    d11 = min(da, d31); // Smallest now in d11\r\n    d31 = max(da, d31); // 2nd smallest now not in d31\r\n    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r\n    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r\n    d12 = min(d12, d21); // 2nd smallest now not in d21\r\n    d12 = min(d12, d22); // nor in d22\r\n    d12 = min(d12, d31); // nor in d31\r\n    d12 = min(d12, d32); // nor in d32\r\n    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r\n    d11.y = min(d11.y,d12.z); // Only two more to go\r\n    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r\n    return sqrt(d11.xy); // F1, F2\r\n}\r\n\r\n","// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\r\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\r\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\r\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\r\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}b([Ot("Use Manhattan Distance",Dt.Boolean,"PROPERTIES",{notifiers:{update:!1}})],rO.prototype,"manhattanDistance",void 0),ye("BABYLON.WorleyNoise3DBlock",rO),ye("BABYLON.SimplexPerlin3DBlock",class HX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("seed",y.Vector3),this.registerOutput("output",y.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\r\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\r\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\r\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r\n",t+="float SimplexPerlin3D( vec3 P ){\r\n",t+="    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\r\n",t+="    vec3 l = 1.0 - g;\r\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\r\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\r\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r\n",t+="    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r\n",t+="    Pt *= Pt;\r\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r\n",t+="    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r\n",t+="    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r\n",t+="    kernel_weights = max(0.5 - kernel_weights, 0.0);\r\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r\n",t+="}\r\n",e._emitFunction("SimplexPerlin3D","const float SKEWFACTOR = 1.0/3.0;\r\nconst float UNSKEWFACTOR = 1.0/6.0;\r\nconst float SIMPLEX_CORNER_POS = 0.5;\r\nconst float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r\nfloat SimplexPerlin3D( vec3 P ){\r\n    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r\n    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r\n    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r\n    vec3 g = step(x0.yzx, x0.xyz);\r\n    vec3 l = 1.0 - g;\r\n    vec3 Pi_1 = min( g.xyz, l.zxy );\r\n    vec3 Pi_2 = max( g.xyz, l.zxy );\r\n    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r\n    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r\n    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r\n    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r\n    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r\n    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r\n    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r\n    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r\n    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r\n    Pt *= Pt;\r\n    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r\n    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r\n    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r\n    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r\n    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r\n    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r\n    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r\n    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r\n    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r\n    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r\n    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r\n    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r\n    kernel_weights = max(0.5 - kernel_weights, 0.0);\r\n    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r\n    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r\n}\r\n","// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\r\n`,this}}),ye("BABYLON.NormalBlendBlock",class zX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("normalMap0",y.AutoDetect),this.registerInput("normalMap1",y.AutoDetect),this.registerOutput("output",y.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Color4|y.Vector3|y.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Color4|y.Vector3|y.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],n=this._inputs[1],s=e._getFreeVariableName("stepR"),a=e._getFreeVariableName("stepG");return e.compilationString+=`float ${s} = step(0.5, ${i.associatedVariableName}.r);\r\n`,e.compilationString+=`float ${a} = step(0.5, ${i.associatedVariableName}.g);\r\n`,e.compilationString+=this._declareOutput(t,e)+";\r\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${s}) * ${i.associatedVariableName}.r * ${n.associatedVariableName}.r * 2.0 + ${s} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${n.associatedVariableName}.r) * 2.0);\r\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${a}) * ${i.associatedVariableName}.g * ${n.associatedVariableName}.g * 2.0 + ${a} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${n.associatedVariableName}.g) * 2.0);\r\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${n.associatedVariableName}.b;\r\n`,this}}),ye("BABYLON.Rotate2dBlock",class WX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.Vector2),this.registerInput("angle",y.Float),this.registerOutput("output",y.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new xt("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const i=this.angle,n=this.input;return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = vec2(cos(${i.associatedVariableName}) * ${n.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${n.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${n.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${n.associatedVariableName}.y);\r\n`,this}}),ye("BABYLON.ReflectBlock",class XX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("incident",y.AutoDetect),this.registerInput("normal",y.AutoDetect),this.registerOutput("output",y.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector3|y.Vector4|y.Color3|y.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(y.Vector3|y.Vector4|y.Color3|y.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\r\n`,this}}),ye("BABYLON.RefractBlock",class YX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("incident",y.AutoDetect),this.registerInput("normal",y.AutoDetect),this.registerInput("ior",y.Float),this.registerOutput("output",y.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Vector3|y.Vector4|y.Color3|y.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(y.Vector3|y.Vector4|y.Color3|y.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\r\n`,this}}),ye("BABYLON.DesaturateBlock",class jX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("color",y.Color3),this.registerInput("level",y.Float),this.registerOutput("output",y.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],n=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),a=e._getFreeVariableName("colorMax"),o=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${s} = min(min(${n}.x, ${n}.y), ${n}.z);\r\n`,e.compilationString+=`float ${a} = max(max(${n}.x, ${n}.y), ${n}.z);\r\n`,e.compilationString+=`float ${o} = 0.5 * (${s} + ${a});\r\n`,e.compilationString+=this._declareOutput(t,e)+` = mix(${n}, vec3(${o}, ${o}, ${o}), ${this.level.associatedVariableName});\r\n`,this}});class Qc extends Ye{constructor(e){super(e,F.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",y.Float,!0,F.Fragment),this.registerInput("color",y.Color3,!0,F.Fragment),this.registerInput("roughness",y.Float,!0,F.Fragment),this.registerOutput("sheen",y.Object,F.Fragment,new Ji("sheen",this,Gi.Output,Qc,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="";return t=`#ifdef SHEEN\n            sheenOutParams sheenOut;\n\n            vec4 vSheenColor = vec4(${this.color.isConnected?this.color.associatedVariableName:"vec3(1.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1."});\n\n            sheenBlock(\n                vSheenColor,\n            #ifdef SHEEN_ROUGHNESS\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #endif\n                roughness,\n            #ifdef SHEEN_TEXTURE\n                vec4(0.),\n                1.0,\n            #endif\n                reflectance,\n            #ifdef SHEEN_LINKWITHALBEDO\n                baseColor,\n                surfaceAlbedo,\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                NdotV,\n                environmentBrdf,\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                AARoughnessFactors,\n                ${null==e?void 0:e._vReflectionMicrosurfaceInfosName},\n                ${null==e?void 0:e._vReflectionInfosName},\n                ${null==e?void 0:e.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==e?void 0:e._define3DName}\n                    ${null==e?void 0:e._cubeSamplerName},\n                #else\n                    ${null==e?void 0:e._2DSamplerName},\n                #endif\n                reflectionOut.reflectionCoords,\n                NdotVUnclamped,\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==e?void 0:e._define3DName}\n                        ${null==e?void 0:e._cubeSamplerName},\n                        ${null==e?void 0:e._cubeSamplerName},\n                    #else\n                        ${null==e?void 0:e._2DSamplerName},\n                        ${null==e?void 0:e._2DSamplerName},\n                    #endif\n                #endif\n                #if !defined(${null==e?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    seo,\n                #endif\n                #if !defined(${null==e?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${null==e?void 0:e._define3DName})\n                    eho,\n                #endif\n            #endif\n                sheenOut\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\r\n`,t}_buildBlock(e){return e.target===F.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\r\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\r\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}b([Ot("Albedo scaling",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Qc.prototype,"albedoScaling",void 0),b([Ot("Link sheen with albedo",Dt.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Qc.prototype,"linkSheenWithAlbedo",void 0),ye("BABYLON.SheenBlock",Qc);class _p extends Ye{constructor(e){super(e,F.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",y.Float,!0,F.Fragment),this.registerInput("direction",y.Vector2,!0,F.Fragment),this.registerInput("uv",y.Vector2,!0),this.registerInput("worldTangent",y.Vector4,!0),this.registerInput("TBN",y.Object,!0,F.VertexAndFragment,new Ji("TBN",this,Gi.Input,Kc,"TBNBlock")),this.registerOutput("anisotropy",y.Object,F.Fragment,new Ji("anisotropy",this,Gi.Output,_p,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,n=this.uv,s=this.worldPositionConnectionPoint,a=this.worldNormalConnectionPoint,o=this.worldTangent;n.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${c.associatedVariableName};\n            #endif\n            `:o.isConnected&&(t+=`vec3 tbnNormal = normalize(${a.associatedVariableName}.xyz);\r\n`,t+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);\r\n`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r\n`,t+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),t+=`\n            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                mat3 TBN = vTBN;\n            #else\n                mat3 TBN = cotangent_frame(${a.associatedVariableName+".xyz"}, ${"v_"+s.associatedVariableName+".xyz"}, ${n.isConnected?n.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));\n            #endif\r\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";return t&&(i+=this._generateTBNSpace(e)),i+=`anisotropicOutParams anisotropicOut;\n            anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1.0"}),\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW,\n                anisotropicOut\n            );\r\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===F.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}}ye("BABYLON.AnisotropyBlock",_p);class Zc extends Ih{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?F.Fragment:F.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",y.AutoDetect,!1,F.Vertex),this.registerInput("world",y.Matrix,!1,F.Vertex),this.registerInput("color",y.Color3,!0,F.Fragment),this.registerOutput("reflection",y.Object,F.Fragment,new Ji("reflection",this,Gi.Output,Zc,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const n=this._getTexture(),s=n&&n.getTextureMatrix;i.setValue("REFLECTION",s,!0),s&&(i.setValue(this._defineLODReflectionAlpha,n.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,n.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!n.invertZ:n.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",n.gammaSpace,!0),i.setValue("RGBDREFLECTION",n.isRGBD,!0),n&&n.coordinatesMode!==j.SKYBOX_MODE&&n.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,n){super.bind(e,t,i);const s=this._getTexture();if(!s||!n)return;e.setTexture(s.isCube?this._cubeSamplerName:this._2DSamplerName,s);const a=s.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,a,s.lodGenerationScale,s.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,a,Se.Log2(a));const o=n.materialDefines,l=s.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&l)if(o.SPHERICAL_HARMONICS){const c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${i}.z *= -1.0;\n                #endif\n                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});\n            #endif\r\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`\n            #ifdef ${this._define3DName}\n                #define sampleReflection(s, c) textureCube(s, c)\n            #else\n                #define sampleReflection(s, c) texture2D(s, c)\n            #endif\r\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\r\n`,`//${this.name}`);const n=`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\r\n`;return e._emitFunction("computeReflectionCoordsPBR",n,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION\n            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);\n\n            reflectionOutParams reflectionOut;\n\n            reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName}.xyz,\n                ${t},\n                alphaG,\n                ${this._vReflectionMicrosurfaceInfosName},\n                ${this._vReflectionInfosName},\n                ${this.reflectionColor},\n            #ifdef ANISOTROPIC\n                anisotropicOut,\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                NdotVUnclamped,\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                roughness,\n            #endif\n            #ifdef ${this._define3DName}\n                ${this._cubeSamplerName},\n            #else\n                ${this._2DSamplerName},\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                ${this._vEnvironmentIrradianceName},\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    ${this._reflectionMatrixName},\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                irradianceSampler, // ** not handled **\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    ${this._cubeSamplerName},\n                    ${this._cubeSamplerName},\n                #else\n                    ${this._2DSamplerName},\n                    ${this._2DSamplerName},\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                ${this._vReflectionFilteringInfoName},\n            #endif\n                reflectionOut\n            );\n        #endif\r\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==F.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\r\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\r\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\r\n`,e}serialize(){var e,t;const i=super.serialize();return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=null===(t=null===(e=this.texture)||void 0===e?void 0:e.gammaSpace)||void 0===t||t,i}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}b([Ot("Spherical Harmonics",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Zc.prototype,"useSphericalHarmonics",void 0),b([Ot("Force irradiance in fragment",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Zc.prototype,"forceIrradianceInFragment",void 0),ye("BABYLON.ReflectionBlock",Zc);class qc extends Ye{constructor(e){super(e,F.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",y.Float,!1,F.Fragment),this.registerInput("roughness",y.Float,!0,F.Fragment),this.registerInput("indexOfRefraction",y.Float,!0,F.Fragment),this.registerInput("normalMapColor",y.Color3,!0,F.Fragment),this.registerInput("uv",y.Vector2,!0,F.Fragment),this.registerInput("tintColor",y.Color3,!0,F.Fragment),this.registerInput("tintAtDistance",y.Float,!0,F.Fragment),this.registerInput("tintThickness",y.Float,!0,F.Fragment),this.registerInput("worldTangent",y.Vector4,!0),this.registerInput("worldNormal",y.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(y.Color4|y.Vector4|y.Vector3),this.registerInput("TBN",y.Object,!0,F.VertexAndFragment,new Ji("TBN",this,Gi.Input,Kc,"TBNBlock")),this.registerOutput("clearcoat",y.Object,F.Fragment,new Ji("clearcoat",this,Gi.Output,qc,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new xt("ClearCoat intensity",F.Fragment,y.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===En._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var n,s;super.bind(e,t,i);const a=null!==(s=null===(n=this.indexOfRefraction.connectInputBlock)||void 0===n?void 0:n.value)&&void 0!==s?s:En._DefaultIndexOfRefraction,o=1-a,l=1+a,c=Math.pow(-o/l,2);e.setFloat4("vClearCoatRefractionParams",c,1/a,o,l);const h=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,d=(null==h?void 0:h.perturbedNormal.isConnected)?h.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",(null==d?void 0:d.invertX)?1:-1,(null==d?void 0:d.invertY)?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",(null==d?void 0:d.invertX)?-1:1,(null==d?void 0:d.invertY)?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let n="";const s=`//${this.name}`,a=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${l.associatedVariableName};\n            #endif\n            `:a.isConnected&&(n+=`vec3 tbnNormal = normalize(${i}.xyz);\r\n`,n+=`vec3 tbnTangent = normalize(${a.associatedVariableName}.xyz);\r\n`,n+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\r\n`,n+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",s,{replaceStrings:[o]}),n}static GetCode(e,t,i,n,s,a,o){let l="";const c=(null==t?void 0:t.intensity.isConnected)?t.intensity.associatedVariableName:"1.",u=(null==t?void 0:t.roughness.isConnected)?t.roughness.associatedVariableName:"0.",h=(null==t?void 0:t.normalMapColor.isConnected)?t.normalMapColor.associatedVariableName:"vec3(0.)",d=(null==t?void 0:t.uv.isConnected)?t.uv.associatedVariableName:"vec2(0.)",f=(null==t?void 0:t.tintColor.isConnected)?t.tintColor.associatedVariableName:"vec3(1.)",p=(null==t?void 0:t.tintThickness.isConnected)?t.tintThickness.associatedVariableName:"1.",g=(null==t?void 0:t.tintAtDistance.isConnected)?t.tintAtDistance.associatedVariableName:"1.";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");const m=t.worldNormal;l+=`vec3 vGeometricNormaClearCoatW = ${m.isConnected?"normalize("+m.associatedVariableName+".xyz)":"geometricNormalW"};\r\n`}else l+="vec3 vGeometricNormaClearCoatW = geometricNormalW;\r\n";return s&&t&&(l+=t._generateTBNSpace(e,n,o),a=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;\n\n        #ifdef CLEARCOAT\n            vec2 vClearCoatParams = vec2(${c}, ${u});\n            vec4 vClearCoatTintParams = vec4(${f}, ${p});\n\n            clearcoatBlock(\n                ${n}.xyz,\n                vGeometricNormaClearCoatW,\n                viewDirectionW,\n                vClearCoatParams,\n                specularEnvironmentR0,\n            #ifdef CLEARCOAT_TEXTURE\n                vec2(0.),\n            #endif\n            #ifdef CLEARCOAT_TINT\n                vClearCoatTintParams,\n                ${g},\n                vClearCoatRefractionParams,\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    vec4(0.),\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                vec2(0., 1.),\n                vec4(${h}, 0.),\n                ${d},\n                #if defined(${a?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    vTBN,\n                #else\n                    vClearCoatTangentSpaceParams,\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    normalMatrix,\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                faceNormal,\n            #endif\n            #ifdef REFLECTION\n                ${null==i?void 0:i._vReflectionMicrosurfaceInfosName},\n                ${null==i?void 0:i._vReflectionInfosName},\n                ${null==i?void 0:i.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==i?void 0:i._define3DName}\n                    ${null==i?void 0:i._cubeSamplerName},\n                #else\n                    ${null==i?void 0:i._2DSamplerName},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==i?void 0:i._define3DName}\n                        ${null==i?void 0:i._cubeSamplerName},\n                        ${null==i?void 0:i._cubeSamplerName},\n                    #else\n                        ${null==i?void 0:i._2DSamplerName},\n                        ${null==i?void 0:i._2DSamplerName},\n                    #endif\n                #endif\n            #endif\n            #if defined(ENVIRONMENTBRDF) && !defined(${null==i?void 0:i._defineSkyboxName})\n                #ifdef RADIANCEOCCLUSION\n                    ambientMonochrome,\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                (gl_FrontFacing ? 1. : -1.),\n            #endif\n                clearcoatOut\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\r\n`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===F.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\r\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){var n;super._deserialize(e,t,i),this.remapF0OnInterfaceChange=null===(n=e.remapF0OnInterfaceChange)||void 0===n||n}}b([Ot("Remap F0 on interface change",Dt.Boolean,"ADVANCED")],qc.prototype,"remapF0OnInterfaceChange",void 0),ye("BABYLON.ClearCoatBlock",qc);class Rh extends Ye{constructor(e){super(e,F.Fragment),this._isUnique=!0,this.registerInput("intensity",y.Float,!0,F.Fragment),this.registerInput("indexOfRefraction",y.Float,!0,F.Fragment),this.registerInput("thickness",y.Float,!0,F.Fragment),this.registerOutput("iridescence",y.Object,F.Fragment,new Ji("iridescence",this,Gi.Output,Rh,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new xt("Iridescence intensity",F.Fragment,y.Float);e.value=1,e.output.connectTo(this.intensity);const t=new xt("Iridescence ior",F.Fragment,y.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new xt("Iridescence thickness",F.Fragment,y.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="";return t+=`iridescenceOutParams iridescenceOut;\n\n        #ifdef IRIDESCENCE\n            iridescenceBlock(\n                vec4(${(null==e?void 0:e.intensity.isConnected)?e.intensity.associatedVariableName:"1."}, ${(null==e?void 0:e.indexOfRefraction.isConnected)?e.indexOfRefraction.associatedVariableName:rr._DefaultIndexOfRefraction}, 1., ${(null==e?void 0:e.thickness.isConnected)?e.thickness.associatedVariableName:rr._DefaultMaximumThickness}),\n                NdotV,\n                specularEnvironmentR0,\n                #ifdef CLEARCOAT\n                    NdotVUnclamped,\n                #endif\n                iridescenceOut\n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\r\n`,t}_buildBlock(e){return e.target===F.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}ye("BABYLON.IridescenceBlock",Rh);class Ml extends Ye{constructor(e){super(e,F.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",y.Float,!1,F.Fragment),this.registerInput("tintAtDistance",y.Float,!0,F.Fragment),this.registerInput("volumeIndexOfRefraction",y.Float,!0,F.Fragment),this.registerOutput("refraction",y.Object,F.Fragment,new Ji("refraction",this,Gi.Output,Ml,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e){if(!this.intensity.isConnected){const t=new xt("Refraction intensity",F.Fragment,y.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.View);t||(t=new xt("view"),t.setAsSystemValue(At.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const n=this._getTexture(),s=n&&n.getTextureMatrix;i.setValue("SS_REFRACTION",s,!0),s&&(i.setValue(this._define3DName,n.isCube,!0),i.setValue(this._defineLODRefractionAlpha,n.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,n.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!n.invertZ:n.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",n.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",n.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!n.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var n,s,a,o;super.bind(e,t,i);const l=this._getTexture();if(!l)return;e.setTexture(l.isCube?this._cubeSamplerName:this._2DSamplerName,l),e.setMatrix(this._refractionMatrixName,l.getReflectionTextureMatrix());let c=1;l.isCube||l.depth&&(c=l.depth);const u=null!==(o=null!==(s=null===(n=this.volumeIndexOfRefraction.connectInputBlock)||void 0===n?void 0:n.value)&&void 0!==s?s:null===(a=this.indexOfRefractionConnectionPoint.connectInputBlock)||void 0===a?void 0:a.value)&&void 0!==o?o:1.5;e.setFloat4(this._vRefractionInfosName,l.level,1/u,c,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset,1/u);const h=l.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,h,Se.Log2(h)),l.boundingBoxSize){const d=l;e.setVector3("vRefractionPosition",d.boundingBoxPosition),e.setVector3("vRefractionSize",d.boundingBoxSize)}}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r\n`,e._samplerDeclaration+="#else\r\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r\n`,e._samplerDeclaration+="#endif\r\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`\n            #ifdef ${this._define3DName}\n                #define sampleRefraction(s, c) textureCube(s, c)\n            #else\n                #define sampleRefraction(s, c) texture2D(s, c)\n            #endif\r\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\r\n`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\r\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\r\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\r\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\r\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=e.texture.isCube?Nn.Parse(e.texture,t,i):j.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}b([Ot("Link refraction to transparency",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ml.prototype,"linkRefractionWithTransparency",void 0),b([Ot("Invert refraction Y",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ml.prototype,"invertRefractionY",void 0),b([Ot("Use thickness as depth",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ml.prototype,"useThicknessAsDepth",void 0),ye("BABYLON.RefractionBlock",Ml);class Mh extends Ye{constructor(e){super(e,F.Fragment),this._isUnique=!0,this.registerInput("thickness",y.Float,!1,F.Fragment),this.registerInput("tintColor",y.Color3,!0,F.Fragment),this.registerInput("translucencyIntensity",y.Float,!0,F.Fragment),this.registerInput("translucencyDiffusionDist",y.Color3,!0,F.Fragment),this.registerInput("refraction",y.Object,!0,F.Fragment,new Ji("refraction",this,Gi.Input,Ml,"RefractionBlock")),this.registerOutput("subsurface",y.Object,F.Fragment,new Ji("subsurface",this,Gi.Output,Mh,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new xt("SubSurface thickness",F.Fragment,y.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const n=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",n||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",n,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0)}static GetCode(e,t,i,n){var s,a,o,l,c,u,h,d,f,p,g,_,m,T,v,A;let S="";const x=(null==t?void 0:t.thickness.isConnected)?t.thickness.associatedVariableName:"0.",C=(null==t?void 0:t.tintColor.isConnected)?t.tintColor.associatedVariableName:"vec3(1.)",R=(null==t?void 0:t.translucencyIntensity.isConnected)?null==t?void 0:t.translucencyIntensity.associatedVariableName:"1.",D=(null==t?void 0:t.translucencyDiffusionDist.isConnected)?null==t?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",P=(null==t?void 0:t.refraction.isConnected)?null===(s=null==t?void 0:t.refraction.connectedPoint)||void 0===s?void 0:s.ownerBlock:null,N=(null==P?void 0:P.tintAtDistance.isConnected)?P.tintAtDistance.associatedVariableName:"1.",k=(null==P?void 0:P.intensity.isConnected)?P.intensity.associatedVariableName:"1.",X=(null==P?void 0:P.view.isConnected)?P.view.associatedVariableName:"";return S+=null!==(a=null==P?void 0:P.getCode(e))&&void 0!==a?a:"",S+=`subSurfaceOutParams subSurfaceOut;\n\n        #ifdef SUBSURFACE\n            vec2 vThicknessParam = vec2(0., ${x});\n            vec4 vTintColor = vec4(${C}, ${N});\n            vec3 vSubSurfaceIntensity = vec3(${k}, ${R}, 0.);\n\n            subSurfaceBlock(\n                vSubSurfaceIntensity,\n                vThicknessParam,\n                vTintColor,\n                normalW,\n                specularEnvironmentReflectance,\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                vec4(0.),\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    ${null==i?void 0:i._reflectionMatrixName},\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            reflectionOut.irradianceVector,\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            ${null==i?void 0:i._cubeSamplerName},\n                            ${null==i?void 0:i._vReflectionFilteringInfoName},\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        irradianceSampler,\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                surfaceAlbedo,\n            #endif\n            #ifdef SS_REFRACTION\n                ${n}.xyz,\n                viewDirectionW,\n                ${X},\n                ${null!==(o=null==P?void 0:P._vRefractionInfosName)&&void 0!==o?o:""},\n                ${null!==(l=null==P?void 0:P._refractionMatrixName)&&void 0!==l?l:""},\n                ${null!==(c=null==P?void 0:P._vRefractionMicrosurfaceInfosName)&&void 0!==c?c:""},\n                vLightingIntensity,\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha,\n                #endif\n                #ifdef ${null!==(u=null==P?void 0:P._defineLODRefractionAlpha)&&void 0!==u?u:"IGNORE"}\n                    NdotVUnclamped,\n                #endif\n                #ifdef ${null!==(h=null==P?void 0:P._defineLinearSpecularRefraction)&&void 0!==h?h:"IGNORE"}\n                    roughness,\n                #endif\n                alphaG,\n                #ifdef ${null!==(d=null==P?void 0:P._define3DName)&&void 0!==d?d:"IGNORE"}\n                    ${null!==(f=null==P?void 0:P._cubeSamplerName)&&void 0!==f?f:""},\n                #else\n                    ${null!==(p=null==P?void 0:P._2DSamplerName)&&void 0!==p?p:""},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null!==(g=null==P?void 0:P._define3DName)&&void 0!==g?g:"IGNORE"}\n                        ${null!==(_=null==P?void 0:P._cubeSamplerName)&&void 0!==_?_:""},\n                        ${null!==(m=null==P?void 0:P._cubeSamplerName)&&void 0!==m?m:""},\n                    #else\n                        ${null!==(T=null==P?void 0:P._2DSamplerName)&&void 0!==T?T:""},\n                        ${null!==(v=null==P?void 0:P._2DSamplerName)&&void 0!==v?v:""},\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    anisotropicOut,\n                #endif\n                #ifdef REALTIME_FILTERING\n                    ${null!==(A=null==P?void 0:P._vRefractionFilteringInfoName)&&void 0!==A?A:""},\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    vRefractionPosition,\n                    vRefractionSize,\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                ${D},\n            #endif\n                subSurfaceOut\n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\r\n`,S}_buildBlock(e){return e.target===F.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}ye("BABYLON.SubSurfaceBlock",Mh);const $X={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]};class dn extends Ye{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?F.Fragment:F.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?F.Fragment:F.Vertex}constructor(e){super(e,F.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=Fe.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",y.Vector4,!1,F.Vertex),this.registerInput("worldNormal",y.Vector4,!1,F.Fragment),this.registerInput("view",y.Matrix,!1),this.registerInput("cameraPosition",y.Vector3,!1,F.Fragment),this.registerInput("perturbedNormal",y.Vector4,!0,F.Fragment),this.registerInput("baseColor",y.Color3,!0,F.Fragment),this.registerInput("metallic",y.Float,!1,F.Fragment),this.registerInput("roughness",y.Float,!1,F.Fragment),this.registerInput("ambientOcc",y.Float,!0,F.Fragment),this.registerInput("opacity",y.Float,!0,F.Fragment),this.registerInput("indexOfRefraction",y.Float,!0,F.Fragment),this.registerInput("ambientColor",y.Color3,!0,F.Fragment),this.registerInput("reflection",y.Object,!0,F.Fragment,new Ji("reflection",this,Gi.Input,Zc,"ReflectionBlock")),this.registerInput("clearcoat",y.Object,!0,F.Fragment,new Ji("clearcoat",this,Gi.Input,qc,"ClearCoatBlock")),this.registerInput("sheen",y.Object,!0,F.Fragment,new Ji("sheen",this,Gi.Input,Qc,"SheenBlock")),this.registerInput("subsurface",y.Object,!0,F.Fragment,new Ji("subsurface",this,Gi.Input,Mh,"SubSurfaceBlock")),this.registerInput("anisotropy",y.Object,!0,F.Fragment,new Ji("anisotropy",this,Gi.Input,_p,"AnisotropyBlock")),this.registerInput("iridescence",y.Object,!0,F.Fragment,new Ji("iridescence",this,Gi.Input,Rh,"IridescenceBlock")),this.registerOutput("ambientClr",y.Color3,F.Fragment),this.registerOutput("diffuseDir",y.Color3,F.Fragment),this.registerOutput("specularDir",y.Color3,F.Fragment),this.registerOutput("clearcoatDir",y.Color3,F.Fragment),this.registerOutput("sheenDir",y.Color3,F.Fragment),this.registerOutput("diffuseInd",y.Color3,F.Fragment),this.registerOutput("specularInd",y.Color3,F.Fragment),this.registerOutput("clearcoatInd",y.Color3,F.Fragment),this.registerOutput("sheenInd",y.Color3,F.Fragment),this.registerOutput("refraction",y.Color3,F.Fragment),this.registerOutput("lighting",y.Color3,F.Fragment),this.registerOutput("shadow",y.Float,F.Fragment),this.registerOutput("alpha",y.Float,F.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.CameraPosition);t||(t=new xt("cameraPosition"),t.setAsSystemValue(At.CameraPosition)),t.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===At.View);t||(t=new xt("view"),t.setAsSystemValue(At.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===ri.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===ri.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const n=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",n.indexOf(".")<0?n+".":n,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const s=e.getScene();if(s.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&De.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const o={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};fe.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,o),o.needRebuild&&i.rebuild()}else fe.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,fe.PrepareDefinesForMultiview(s,i)}updateUniformsAndSamples(e,t,i,n){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const a=e.uniforms.indexOf("vLightData"+s)>=0;fe.PrepareUniformsAndSamplersForLight(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],n,a)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var n,s;if(!i)return;const a=i.getScene();this.light?fe.BindLight(this.light,this._lightId,a,e,!0):fe.BindLights(a,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const o=this._scene.ambientColor;o&&e.setColor3("ambientFromScene",o),e.setFloat(this._invertNormalName,a.useRightHandedSystem===(null!=a._mirroredCameraPosition)?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const u=null!==(s=null===(n=this.indexOfRefraction.connectInputBlock)||void 0===n?void 0:n.value)&&void 0!==s?s:1.5,h=Math.pow((u-1)/(u+1),2);this._metallicReflectanceColor.scaleToRef(h*this._metallicF0Factor,ei.Color3[0]),e.setColor4(this._vMetallicReflectanceFactorsName,ei.Color3[0],this._metallicF0Factor),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const n=this.worldPosition,s=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",s,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const a="v_"+n.associatedVariableName;e._emitVaryingFromString(a,"vec4")&&(e.compilationString+=`${a} = ${n.associatedVariableName};\r\n`);const o=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=null!==(i=null==o?void 0:o.handleVertexSide(e))&&void 0!==i?i:"",e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\r\n",e._injectAtEnd+="vClipSpacePosition = gl_Position;\r\n",e._injectAtEnd+="#endif\r\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:n.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${n.associatedVariableName};\r\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e="albedoOpacityOutParams albedoOpacityOut;\r\n";return e+=`albedoOpacityBlock(\n                vec4(${this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)"}, 1.),\n            #ifdef ALBEDO\n                vec4(1.),\n                vec2(1., 1.),\n            #endif\n            #ifdef OPACITY\n                vec4(${this.opacity.isConnected?this.opacity.associatedVariableName:"1."}),\n                vec2(1., 1.),\n            #endif\n                albedoOpacityOut\n            );\n\n            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;\n            float alpha = albedoOpacityOut.alpha;\r\n`,e}_getAmbientOcclusionCode(){let e="ambientOcclusionOutParams aoOut;\r\n";return e+=`ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),\n                vec4(0., 1.0, 1.0, 0.),\n            #endif\n                aoOut\n            );\r\n`,e}_getReflectivityCode(e){let t="reflectivityOutParams reflectivityOut;\r\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;\n\n            reflectivityBlock(\n                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo,\n                ${this._vMetallicReflectanceFactorsName},\n            #endif\n            #ifdef REFLECTIVITY\n                vec3(0., 0., 1.),\n                vec4(1.),\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor,\n            #endif\n            #ifdef MICROSURFACEMAP\n                microSurfaceTexel, <== not handled!\n            #endif\n                reflectivityOut\n            );\n\n            float microSurface = reflectivityOut.microSurface;\n            float roughness = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\r\n`,t}_buildBlock(e){var t,i,n,s,a,o,l,c,u,h,d,f,p,g,_,m,T,v,A,S,x,C,R,D,P,N,k,X,ne,ge,ue,ke,me,$,Q,w,Y,se,Re,mt,$e;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=ep(this._scene));const _e=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;if(_e&&(_e.worldPositionConnectionPoint=this.worldPosition,_e.cameraPositionConnectionPoint=this.cameraPosition,_e.worldNormalConnectionPoint=this.worldNormal,_e.viewConnectionPoint=this.view),e.target!==F.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const Xe=`//${this.name}`,Xt=this.perturbedNormal;let ti=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(ti=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${ti};\r\n`,Xe),e.compilationString+=`${ti} = ${this.worldPosition.associatedVariableName}.xyz;\r\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",Xe,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\r\n",e.compilationString+="vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\r\n",e.compilationString+="#endif\r\n"):ti="v_"+ti,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",Xe,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",Xe,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",Xe),e._emitFunctionFromInclude("importanceSampling",Xe),e._emitFunctionFromInclude("pbrHelperFunctions",Xe),e._emitFunctionFromInclude("imageProcessingDeclaration",Xe),e._emitFunctionFromInclude("imageProcessingFunctions",Xe),e._emitFunctionFromInclude("shadowsFragmentFunctions",Xe,{replaceStrings:[{search:/vPositionW/g,replace:ti+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",Xe,{replaceStrings:[{search:/vPositionW/g,replace:ti+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",Xe),e._emitFunctionFromInclude("pbrBRDFFunctions",Xe,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(i=null==_e?void 0:_e._defineSkyboxName)&&void 0!==i?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",Xe),e._emitFunctionFromInclude("pbrDirectLightingFunctions",Xe,{replaceStrings:[{search:/vPositionW/g,replace:ti+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",Xe),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",Xe),e._emitFunctionFromInclude("pbrBlockReflectivity",Xe),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",Xe),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",Xe),e._emitFunctionFromInclude("pbrBlockAnisotropic",Xe),e._emitUniformFromString("vLightingIntensity","vec4"),(null==_e?void 0:_e.generateOnlyFragmentCode)&&(e.compilationString+=_e.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\r\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${ti}.xyz);\r\n`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\r\n`,e.compilationString+=`vec3 normalW = ${Xt.isConnected?"normalize("+Xt.associatedVariableName+".xyz)":"geometricNormalW"};\r\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",Xe,{replaceStrings:[{search:/vPositionW/g,replace:ti+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",Xe),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",Xe),e.compilationString+="#ifdef UNLIT\n                vec3 diffuseBase = vec3(1., 1., 1.);\n            #else\r\n",e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",Xe,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(n=null==_e?void 0:_e._defineSkyboxName)&&void 0!==n?n:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(s=null==_e?void 0:_e._define3DName)&&void 0!==s?s:"REFLECTIONMAP_3D"}]});const Mt=this.anisotropy.isConnected?null===(a=this.anisotropy.connectedPoint)||void 0===a?void 0:a.ownerBlock:null;Mt&&(Mt.worldPositionConnectionPoint=this.worldPosition,Mt.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=Mt.getCode(e,!this.perturbedNormal.isConnected)),_e&&_e.hasTexture&&(e.compilationString+=_e.getCode(e,Mt?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",Xe,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(o=null==_e?void 0:_e._define3DName)&&void 0!==o?o:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(l=null==_e?void 0:_e._defineOppositeZ)&&void 0!==l?l:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(c=null==_e?void 0:_e._defineProjectionName)&&void 0!==c?c:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(u=null==_e?void 0:_e._defineSkyboxName)&&void 0!==u?u:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(h=null==_e?void 0:_e._defineLODReflectionAlpha)&&void 0!==h?h:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(d=null==_e?void 0:_e._defineLinearSpecularReflection)&&void 0!==d?d:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:null!==(f=null==_e?void 0:_e._vReflectionFilteringInfoName)&&void 0!==f?f:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",Xe,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const qe=this.sheen.isConnected?null===(p=this.sheen.connectedPoint)||void 0===p?void 0:p.ownerBlock:null;qe&&(e.compilationString+=qe.getCode(_e)),e._emitFunctionFromInclude("pbrBlockSheen",Xe,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(g=null==_e?void 0:_e._define3DName)&&void 0!==g?g:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(_=null==_e?void 0:_e._defineSkyboxName)&&void 0!==_?_:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(m=null==_e?void 0:_e._defineLODReflectionAlpha)&&void 0!==m?m:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(T=null==_e?void 0:_e._defineLinearSpecularReflection)&&void 0!==T?T:"LINEARSPECULARREFLECTION"}]});const qt=this.iridescence.isConnected?null===(v=this.iridescence.connectedPoint)||void 0===v?void 0:v.ownerBlock:null;e.compilationString+=Rh.GetCode(qt),e._emitFunctionFromInclude("pbrBlockIridescence",Xe,{replaceStrings:[]});const Ei=this.clearcoat.isConnected?null===(A=this.clearcoat.connectedPoint)||void 0===A?void 0:A.ownerBlock:null,Ci=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,qi=this.perturbedNormal.isConnected&&(null===(x=(null===(S=this.perturbedNormal.connectedPoint)||void 0===S?void 0:S.ownerBlock).worldTangent)||void 0===x?void 0:x.isConnected),Ps=this.anisotropy.isConnected&&(null===(C=this.anisotropy.connectedPoint)||void 0===C?void 0:C.ownerBlock).worldTangent.isConnected;let Tr=qi||!this.perturbedNormal.isConnected&&Ps;e.compilationString+=qc.GetCode(e,Ei,_e,ti,Ci,Tr,this.worldNormal.associatedVariableName),Ci&&(Tr=null!==(R=null==Ei?void 0:Ei.worldTangent.isConnected)&&void 0!==R&&R),e._emitFunctionFromInclude("pbrBlockClearcoat",Xe,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(D=null==_e?void 0:_e._define3DName)&&void 0!==D?D:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(P=null==_e?void 0:_e._defineOppositeZ)&&void 0!==P?P:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(N=null==_e?void 0:_e._defineProjectionName)&&void 0!==N?N:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(k=null==_e?void 0:_e._defineSkyboxName)&&void 0!==k?k:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(X=null==_e?void 0:_e._defineLODReflectionAlpha)&&void 0!==X?X:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(ne=null==_e?void 0:_e._defineLinearSpecularReflection)&&void 0!==ne?ne:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:Tr?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",Xe,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(ge=null==_e?void 0:_e._defineSkyboxName)&&void 0!==ge?ge:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(ue=null==_e?void 0:_e._define3DName)&&void 0!==ue?ue:"REFLECTIONMAP_3D"}]});const Qo=this.subsurface.isConnected?null===(ke=this.subsurface.connectedPoint)||void 0===ke?void 0:ke.ownerBlock:null,Sn=this.subsurface.isConnected?null===($=(null===(me=this.subsurface.connectedPoint)||void 0===me?void 0:me.ownerBlock).refraction.connectedPoint)||void 0===$?void 0:$.ownerBlock:null;Sn&&(Sn.viewConnectionPoint=this.view,Sn.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Mh.GetCode(e,Qo,_e,ti),e._emitFunctionFromInclude("pbrBlockSubSurface",Xe,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(Q=null==_e?void 0:_e._define3DName)&&void 0!==Q?Q:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(w=null==_e?void 0:_e._defineOppositeZ)&&void 0!==w?w:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(Y=null==_e?void 0:_e._defineProjectionName)&&void 0!==Y?Y:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:null!==(se=null==Sn?void 0:Sn._define3DName)&&void 0!==se?se:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:null!==(Re=null==Sn?void 0:Sn._defineLODRefractionAlpha)&&void 0!==Re?Re:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:null!==(mt=null==Sn?void 0:Sn._defineLinearSpecularRefraction)&&void 0!==mt?mt:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:null!==($e=null==Sn?void 0:Sn._defineOppositeZ)&&void 0!==$e?$e:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",Xe),e.compilationString+=e._emitCodeFromInclude("lightFragment",Xe,this.light?{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}:{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",Xe),e.compilationString+="#endif\r\n";const Zo=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let qn=ri.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===qn.indexOf(".")&&(qn+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",Xe,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:Zo+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:qn}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",Xe,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",Xe,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",Xe,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:ti},{search:/albedoTexture\.rgb;/g,replace:"vec3(1.);\r\ngl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r\n"}]});for(const Na of this._outputs)if(Na.hasEndpoints){const Fr=$X[Na.name];if(Fr){const[Vp,cu]=Fr;cu&&(e.compilationString+=`#if ${cu}\r\n`),e.compilationString+=`${this._declareOutput(Na,e)} = ${Vp};\r\n`,cu&&(e.compilationString+="#else\r\n",e.compilationString+=`${this._declareOutput(Na,e)} = vec3(0.);\r\n`,e.compilationString+="#endif\r\n")}else console.error(`There's no remapping for the ${Na.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\r\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\r\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\r\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\r\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\r\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\r\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\r\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\r\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\r\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\r\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\r\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\r\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\r\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\r\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\r\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\r\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\r\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){var n,s;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=null!==(n=e.lightFalloff)&&void 0!==n?n:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=null!==(s=e.realTimeFilteringQuality)&&void 0!==s?s:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}b([Ot("Direct lights",Dt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],dn.prototype,"directIntensity",void 0),b([Ot("Environment lights",Dt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],dn.prototype,"environmentIntensity",void 0),b([Ot("Specular highlights",Dt.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],dn.prototype,"specularIntensity",void 0),b([Ot("Light falloff",Dt.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:ri.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:ri.LIGHTFALLOFF_GLTF},{label:"Standard",value:ri.LIGHTFALLOFF_STANDARD}]})],dn.prototype,"lightFalloff",void 0),b([Ot("Alpha Testing",Dt.Boolean,"OPACITY")],dn.prototype,"useAlphaTest",void 0),b([Ot("Alpha CutOff",Dt.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],dn.prototype,"alphaTestCutoff",void 0),b([Ot("Alpha blending",Dt.Boolean,"OPACITY")],dn.prototype,"useAlphaBlending",void 0),b([Ot("Radiance over alpha",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],dn.prototype,"useRadianceOverAlpha",void 0),b([Ot("Specular over alpha",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],dn.prototype,"useSpecularOverAlpha",void 0),b([Ot("Specular anti-aliasing",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],dn.prototype,"enableSpecularAntiAliasing",void 0),b([Ot("Realtime filtering",Dt.Boolean,"RENDERING",{notifiers:{update:!0}})],dn.prototype,"realTimeFiltering",void 0),b([Ot("Realtime filtering quality",Dt.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],dn.prototype,"realTimeFilteringQuality",void 0),b([Ot("Energy Conservation",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],dn.prototype,"useEnergyConservation",void 0),b([Ot("Radiance occlusion",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],dn.prototype,"useRadianceOcclusion",void 0),b([Ot("Horizon occlusion",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],dn.prototype,"useHorizonOcclusion",void 0),b([Ot("Unlit",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],dn.prototype,"unlit",void 0),b([Ot("Force normal forward",Dt.Boolean,"ADVANCED",{notifiers:{update:!0}})],dn.prototype,"forceNormalForward",void 0),b([Ot("Generate only fragment code",Dt.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:dn._OnGenerateOnlyFragmentCodeChanged}})],dn.prototype,"generateOnlyFragmentCode",void 0),b([Ot("Debug mode",Dt.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],dn.prototype,"debugMode",void 0),b([Ot("Split position",Dt.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],dn.prototype,"debugLimit",void 0),b([Ot("Output factor",Dt.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],dn.prototype,"debugFactor",void 0),ye("BABYLON.PBRMetallicRoughnessBlock",dn),ye("BABYLON.ModBlock",class KX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("left",y.AutoDetect),this.registerInput("right",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r\n`,this}}),ye("BABYLON.MatrixBuilder",class QX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("row0",y.Vector4),this.registerInput("row1",y.Vector4),this.registerInput("row2",y.Vector4),this.registerInput("row3",y.Vector4),this.registerOutput("output",y.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new xt("row0");e.value=new Qt(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new xt("row1");e.value=new Qt(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new xt("row2");e.value=new Qt(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new xt("row3");e.value=new Qt(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const i=this.row0,n=this.row1,s=this.row2,a=this.row3;return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = mat4(${i.associatedVariableName}, ${n.associatedVariableName}, ${s.associatedVariableName}, ${a.associatedVariableName});\r\n`,this}});var jr=(()=>{return(r=jr||(jr={}))[r.Equal=0]="Equal",r[r.NotEqual=1]="NotEqual",r[r.LessThan=2]="LessThan",r[r.GreaterThan=3]="GreaterThan",r[r.LessOrEqual=4]="LessOrEqual",r[r.GreaterOrEqual=5]="GreaterOrEqual",r[r.Xor=6]="Xor",r[r.Or=7]="Or",r[r.And=8]="And",jr;var r})();ye("BABYLON.ConditionalBlock",class ZX extends Ye{constructor(e){super(e,F.Neutral),this.condition=jr.LessThan,this.registerInput("a",y.Float),this.registerInput("b",y.Float),this.registerInput("true",y.AutoDetect,!0),this.registerInput("false",y.AutoDetect,!0),this.registerOutput("output",y.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=y.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",n=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case jr.Equal:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${n};\r\n`;break;case jr.NotEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${n};\r\n`;break;case jr.LessThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${n};\r\n`;break;case jr.LessOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${n};\r\n`;break;case jr.GreaterThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${n};\r\n`;break;case jr.GreaterOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${n};\r\n`;break;case jr.Xor:e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${n};\r\n`;break;case jr.Or:e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${n};\r\n`;break;case jr.And:e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${n};\r\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${jr[this.condition]};\r\n`}});class sO extends Ye{constructor(e){super(e,F.Neutral),this.octaves=6,this.registerInput("seed",y.AutoDetect),this.registerInput("chaos",y.AutoDetect,!0),this.registerInput("offsetX",y.Float,!0),this.registerInput("offsetY",y.Float,!0),this.registerInput("offsetZ",y.Float,!0),this.registerOutput("output",y.Float),this._inputs[0].acceptedConnectionPointTypes.push(y.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(y.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;const a=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode","\n\n        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise(in vec2 x, in vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise(in vec3 x, in vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }","// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,"\n        float fbm(in vec2 st, in vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise(st, chaos);\n                st *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm(in vec3 x, in vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            for (int i = 0; i < OCTAVES; ++i) {\n                value += amplitude * cloudNoise(x, chaos);\n                x = x * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }".replace(/fbm/gi,a).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const o=e._getFreeVariableName("st"),l=(null===(t=this.seed.connectedPoint)||void 0===t?void 0:t.type)===y.Vector2?"vec2":"vec3";e.compilationString+=`${l} ${o} = ${this.seed.associatedVariableName};\r\n`,this.offsetX.isConnected&&(e.compilationString+=`${o}.x += 0.1 * ${this.offsetX.associatedVariableName};\r\n`),this.offsetY.isConnected&&(e.compilationString+=`${o}.y += 0.1 * ${this.offsetY.associatedVariableName};\r\n`),this.offsetZ.isConnected&&"vec3"===l&&(e.compilationString+=`${o}.z += 0.1 * ${this.offsetZ.associatedVariableName};\r\n`);let c="";return c=this.chaos.isConnected?this.chaos.associatedVariableName:(null===(i=this.seed.connectedPoint)||void 0===i?void 0:i.type)===y.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${a}(${o}, ${c});\r\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\r\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}b([Ot("Octaves",Dt.Int)],sO.prototype,"octaves",void 0),ye("BABYLON.CloudBlock",sO),ye("BABYLON.VoronoiNoiseBlock",class qX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("seed",y.Vector2),this.registerInput("offset",y.Float),this.registerInput("density",y.Float),this.registerOutput("output",y.Float),this.registerOutput("cells",y.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 seed, float offset){\n            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);\n            vec2 uv = fract(sin(m * seed) * 46839.32);\n            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);\n        }\n        ";e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 g = floor(seed * density);\n            vec2 f = fract(seed * density);\n            float t = 8.0;\n            vec3 res = vec3(8.0, 0.0, 0.0);\n\n            for(int y=-1; y<=1; y++)\n            {\n                for(int x=-1; x<=1; x++)\n                {\n                    vec2 lattice = vec2(x,y);\n                    vec2 randomOffset = voronoiRandom(lattice + g, offset);\n                    float d = distance(lattice + randomOffset, f);\n                    if(d < res.x)\n                    {\n                        res = vec3(d, randomOffset.x, randomOffset.y);\n                        outValue = res.x;\n                        cells = res.y;\n                    }\n                }\n            }\n        }\n        ",e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),n=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\r\n`,e.compilationString+=`float ${n} = 0.0;\r\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${n});\r\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r\n`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${n};\r\n`),this}}),ye("BABYLON.ElbowBlock",class JX extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.AutoDetect),this.registerOutput("output",y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==F.VertexAndFragment)return t.target;if(e.connectedPoint.target!==F.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){0==(this._target&e)&&(this._target=e)}_buildBlock(e){super._buildBlock(e);const i=this._inputs[0];return e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${i.associatedVariableName};\r\n`,this}});class aO extends Ye{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:Je.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,n=>n.hasTexture(e))}get textureY(){var e;return this.sourceY.isConnected?(null===(e=this.sourceY.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return(null===(e=this.sourceZ)||void 0===e?void 0:e.isConnected)?(null===(t=this.sourceY.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return(null==e?void 0:e.isConnected)?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceY))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get samplerZName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceZ))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const i=null!==(t=this.texture.getScene())&&void 0!==t?t:Je.LastCreatedScene;null==i||i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const i=null!==(t=this.texture.getScene())&&void 0!==t?t:Je.LastCreatedScene;null==i||i.markAllMaterialsAsDirty(1,n=>n.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,F.Neutral),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",y.AutoDetect,!1),this.registerInput("normal",y.AutoDetect,!1),this.registerInput("sharpness",y.Float,!0),this.registerInput("source",y.Object,!0,F.VertexAndFragment,new Ji("source",this,Gi.Input,Il,"ImageSourceBlock")),this.registerInput("sourceY",y.Object,!0,F.VertexAndFragment,new Ji("sourceY",this,Gi.Input,Il,"ImageSourceBlock")),t||this.registerInput("sourceZ",y.Object,!0,F.VertexAndFragment,new Ji("sourceZ",this,Gi.Input,Il,"ImageSourceBlock")),this.registerOutput("rgba",y.Color4,F.Neutral),this.registerOutput("rgb",y.Color3,F.Neutral),this.registerOutput("r",y.Float,F.Neutral),this.registerOutput("g",y.Float,F.Neutral),this.registerOutput("b",y.Float,F.Neutral),this.registerOutput("a",y.Float,F.Neutral),this.registerOutput("level",y.Float,F.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(y.Color3|y.Vector3|y.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,!0),i.setValue(this._gammaDefineName,s,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){!this.texture||(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_generateTextureLookup(e){var t,i;const n=this.samplerName,s=null!==(t=this.samplerYName)&&void 0!==t?t:n,a=null!==(i=this.samplerZName)&&void 0!==i?i:n,o=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",l=e._getFreeVariableName("x"),c=e._getFreeVariableName("y"),u=e._getFreeVariableName("z"),h=e._getFreeVariableName("z");e.compilationString+=`\n            vec4 ${l} = texture2D(${n}, ${this.position.associatedVariableName}.yz);\n            vec4 ${c} = texture2D(${s}, ${this.position.associatedVariableName}.zx);\n            vec4 ${u} = texture2D(${a}, ${this.position.associatedVariableName}.xy);\n            \n            // blend weights\n            vec3 ${h} = pow(abs(${this.normal.associatedVariableName}.xyz), vec3(${o}));\n\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${l}*${h}.x + ${c}*${h}.y + ${u}*${h}.z) / (${h}.x + ${h}.y + ${h}.z);        \n        `}_generateConversionCode(e,t,i){"a"!==i&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let n="";this.disableLevelMultiplication||(n=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${n};\r\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this._imageSource=this.source.isConnected?this.source.connectedPoint.ownerBlock:null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("helperFunctions",`//${this.name}`),e._emitUniformFromString(this._textureInfoName,"float"),this._generateTextureLookup(e);for(const i of this._outputs)i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r\n`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r\n`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Zi.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=j.Parse(e.texture,t,i))}}ye("BABYLON.TriPlanarBlock",aO),ye("BABYLON.BiPlanarBlock",class e6 extends aO{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_generateTextureLookup(e){var t;const i=this.samplerName,n=null!==(t=this.samplerYName)&&void 0!==t?t:this.samplerName,s=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",a=e._getFreeVariableName("dpdx"),o=e._getFreeVariableName("dpdy"),l=e._getFreeVariableName("n"),c=e._getFreeVariableName("ma"),u=e._getFreeVariableName("mi"),h=e._getFreeVariableName("me"),d=e._getFreeVariableName("x"),f=e._getFreeVariableName("y"),p=e._getFreeVariableName("y");e.compilationString+=`\n            // grab coord derivatives for texturing\n            vec3 ${a} = dFdx(${this.position.associatedVariableName}.xyz);\n            vec3 ${o} = dFdy(${this.position.associatedVariableName}.xyz);\n            vec3 ${l} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ivec3 ${c} = (${l}.x>${l}.y && ${l}.x>${l}.z) ? ivec3(0,1,2) :\n                    (${l}.y>${l}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine minor axis (in x; yz are following axis)\n            ivec3 ${u} = (${l}.x<${l}.y && ${l}.x<${l}.z) ? ivec3(0,1,2) :\n                    (${l}.y<${l}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine median axis (in x;  yz are following axis)\n            ivec3 ${h} = ivec3(3) - ${u} - ${c};\n            \n            // project+fetch\n            vec4 ${d} = textureGrad( ${i}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2(${a}[${c}.y],${a}[${c}.z]), \n                                    vec2(${o}[${c}.y],${o}[${c}.z]) );\n            vec4 ${f} = textureGrad( ${n}, vec2(   ${this.position.associatedVariableName}[${h}.y],   ${this.position.associatedVariableName}[${h}.z]), \n                                    vec2(${a}[${h}.y],${a}[${h}.z]),\n                                    vec2(${o}[${h}.y],${o}[${h}.z]) );\n            \n            // blend factors\n            vec2 ${p} = vec2(${l}[${c}.x],${l}[${h}.x]);\n            // make local support\n            ${p} = clamp( (${p}-0.5773)/(1.0-0.5773), 0.0, 1.0 );\n            // shape transition\n            ${p} = pow( ${p}, vec2(${s}/8.0) );\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${d}*${p}.x + ${f}*${p}.y) / (${p}.x + ${p}.y);\n        `}}),ye("BABYLON.MatrixDeterminantBlock",class t6 extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.Matrix),this.registerOutput("output",y.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = determinant(${i.associatedVariableName});\r\n`,this}}),ye("BABYLON.MatrixTransposeBlock",class i6 extends Ye{constructor(e){super(e,F.Neutral),this.registerInput("input",y.Matrix),this.registerOutput("output",y.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = transpose(${i.associatedVariableName});\r\n`,this}});class r6 extends us{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class mp extends Js{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DecalMap",150,new r6,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,n){const s=n.getMesh().decalMap;return!(this._isEnabled&&(null==s?void 0:s.texture)&&De.DecalMapEnabled&&t.texturesEnabled)||s.isReady()}prepareDefines(e,t,i){const n=i.decalMap;this._isEnabled&&(null==n?void 0:n.texture)&&De.DecalMapEnabled&&t.texturesEnabled?((!e.DECAL||e.GAMMADECAL!==n.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=n.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,fe.PrepareDefinesForMergedUV(n.texture,e,"DECAL")):(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1)}hardBindForSubMesh(e,t,i,n){const s=n.getMesh().decalMap;if(!(this._isEnabled&&(null==s?void 0:s.texture)&&De.DecalMapEnabled&&t.texturesEnabled))return;const o=s.texture;(!e.useUbo||!this._material.isFrozen||!e.isSync)&&(e.updateFloat4("vDecalInfos",o.coordinatesIndex,0,0,0),fe.BindTextureMatrix(o,e,"decal")),e.setTexture("decalSampler",o)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}b([O(),ee("_markAllSubMeshesAsTexturesDirty")],mp.prototype,"isEnabled",void 0),b([O(),ee("_markAllSubMeshesAsTexturesDirty")],mp.prototype,"smoothAlpha",void 0),Object.defineProperty(Ue.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new mp(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(ri.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new mp(this)}return this._decalMap},enumerable:!0,configurable:!0}),Ze.prototype._debugPushGroup=function(r,e){},Ze.prototype._debugPopGroup=function(r){},Ze.prototype._debugInsertMarker=function(r,e){},Ze.prototype._debugFlushPendingCommands=function(){};class a6{constructor(){this._timeElapsedQueryEnded=!1}}class o6{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=hn.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=hn.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}Ve.prototype.createQuery=function(){const r=this._gl.createQuery();if(!r)throw new Error("Unable to create Occlusion Query");return r},Ve.prototype.deleteQuery=function(r){return this._gl.deleteQuery(r),this},Ve.prototype.isQueryResultAvailable=function(r){return this._gl.getQueryParameter(r,this._gl.QUERY_RESULT_AVAILABLE)},Ve.prototype.getQueryResult=function(r){return this._gl.getQueryParameter(r,this._gl.QUERY_RESULT)},Ve.prototype.beginOcclusionQuery=function(r,e){const t=this._getGlAlgorithmType(r);return this._gl.beginQuery(t,e),!0},Ve.prototype.endOcclusionQuery=function(r){const e=this._getGlAlgorithmType(r);return this._gl.endQuery(e),this},Ve.prototype._createTimeQuery=function(){const r=this.getCaps().timerQuery;return r.createQueryEXT?r.createQueryEXT():this.createQuery()},Ve.prototype._deleteTimeQuery=function(r){const e=this.getCaps().timerQuery;e.deleteQueryEXT?e.deleteQueryEXT(r):this.deleteQuery(r)},Ve.prototype._getTimeQueryResult=function(r){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_EXT):this.getQueryResult(r)},Ve.prototype._getTimeQueryAvailability=function(r){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(r,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(r)},Ve.prototype.startTimeQuery=function(){const r=this.getCaps(),e=r.timerQuery;if(!e)return null;const t=new a6;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),r.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery),this._currentNonTimestampToken=t}return t},Ve.prototype.endTimeQuery=function(r){const e=this.getCaps(),t=e.timerQuery;if(!t||!r)return-1;if(e.canUseTimestampForTimerQuery){if(!r._startTimeQuery)return-1;r._endTimeQuery||(r._endTimeQuery=this._createTimeQuery(),t.queryCounterEXT(r._endTimeQuery,t.TIMESTAMP_EXT))}else if(!r._timeElapsedQueryEnded){if(!r._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),r._timeElapsedQueryEnded=!0}const i=this._gl.getParameter(t.GPU_DISJOINT_EXT);let n=!1;if(r._endTimeQuery?n=this._getTimeQueryAvailability(r._endTimeQuery):r._timeElapsedQuery&&(n=this._getTimeQueryAvailability(r._timeElapsedQuery)),n&&!i){let s=0;if(e.canUseTimestampForTimerQuery){if(!r._startTimeQuery||!r._endTimeQuery)return-1;const a=this._getTimeQueryResult(r._startTimeQuery);s=this._getTimeQueryResult(r._endTimeQuery)-a,this._deleteTimeQuery(r._startTimeQuery),this._deleteTimeQuery(r._endTimeQuery),r._startTimeQuery=null,r._endTimeQuery=null}else{if(!r._timeElapsedQuery)return-1;s=this._getTimeQueryResult(r._timeElapsedQuery),this._deleteTimeQuery(r._timeElapsedQuery),r._timeElapsedQuery=null,r._timeElapsedQueryEnded=!1}return s}return-1},Ve.prototype._captureGPUFrameTime=!1,Ve.prototype._gpuFrameTime=new El,Ve.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},Ve.prototype.captureGPUFrameTime=function(r){r!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=r,r?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},Ve.prototype._getGlAlgorithmType=function(r){return r===hn.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(hn.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(r){this._occlusionDataStorage.isOcclusionQueryInProgress=r},enumerable:!1,configurable:!0}),Object.defineProperty(hn.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new o6),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(hn.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(r){this._occlusionDataStorage.isOccluded=r},enumerable:!0,configurable:!0}),Object.defineProperty(hn.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(r){this._occlusionDataStorage.occlusionQueryAlgorithmType=r},enumerable:!0,configurable:!0}),Object.defineProperty(hn.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(r){this._occlusionDataStorage.occlusionType=r},enumerable:!0,configurable:!0}),Object.defineProperty(hn.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(r){this._occlusionDataStorage.occlusionRetryCount=r},enumerable:!0,configurable:!0}),Object.defineProperty(hn.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(r){this._occlusionDataStorage.forceRenderingWhenOccluded=r},enumerable:!0,configurable:!0}),hn.prototype._checkOcclusionQuery=function(){const r=this._occlusionDataStorage;if(r.occlusionType===hn.OCCLUSION_TYPE_NONE)return r.isOccluded=!1,!1;const e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return r.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery)if(e.isQueryResultAvailable(this._occlusionQuery)){const n=e.getQueryResult(this._occlusionQuery);r.isOcclusionQueryInProgress=!1,r.occlusionInternalRetryCounter=0,r.isOccluded=!(n>0)}else{if(r.occlusionInternalRetryCounter++,!(-1!==r.occlusionRetryCount&&r.occlusionInternalRetryCounter>r.occlusionRetryCount))return r.occlusionType!==hn.OCCLUSION_TYPE_OPTIMISTIC&&r.isOccluded;r.isOcclusionQueryInProgress=!1,r.occlusionInternalRetryCounter=0,r.isOccluded=r.occlusionType!==hn.OCCLUSION_TYPE_OPTIMISTIC&&r.isOccluded}const t=this.getScene();if(t.getBoundingBoxRenderer){const i=t.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=e.createQuery()),e.beginOcclusionQuery(r.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(r.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return r.isOccluded},Ve.prototype.createTransformFeedback=function(){const r=this._gl.createTransformFeedback();if(!r)throw new Error("Unable to create Transform Feedback");return r},Ve.prototype.deleteTransformFeedback=function(r){this._gl.deleteTransformFeedback(r)},Ve.prototype.bindTransformFeedback=function(r){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,r)},Ve.prototype.beginTransformFeedback=function(r=!0){this._gl.beginTransformFeedback(r?this._gl.POINTS:this._gl.TRIANGLES)},Ve.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},Ve.prototype.setTranformFeedbackVaryings=function(r,e){this._gl.transformFeedbackVaryings(r,e,this._gl.INTERLEAVED_ATTRIBS)},Ve.prototype.bindTransformFeedbackBuffer=function(r){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,r?r.underlyingResource:null)};class oO extends ir{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){!this._renderTarget||this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}function lO(r,e){const t=new He(r,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}Ve.prototype.createMultiviewRenderTargetTexture=function(r,e){const t=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const i=this._createHardwareRenderTargetWrapper(!1,!1,{width:r,height:e});i._framebuffer=t.createFramebuffer();const n=new hi(this,vt.Unknown,!0);return n.width=r,n.height=e,n.isMultiview=!0,i._colorTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._colorTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.RGBA8,r,e,2),i._depthStencilTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.DEPTH24_STENCIL8,r,e,2),n.isReady=!0,i.setTextures(n),i._depthStencilTexture=n,i},Ve.prototype.bindMultiviewFramebuffer=function(r){const e=r,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),!e._colorTextureArray||!e._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2))},it.prototype._useMultiviewToSingleView=!1,it.prototype._multiviewTexture=null,it.prototype._resizeOrCreateMultiviewTexture=function(r,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=r||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new oO(this.getScene(),{width:r,height:e})):this._multiviewTexture=new oO(this.getScene(),{width:r,height:e})};const l6=dt.prototype.createSceneUniformBuffer;dt.prototype._transformMatrixR=B.Zero(),dt.prototype._multiviewSceneUbo=null,dt.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=lO(this.getEngine(),"scene_multiview")},dt.prototype.createSceneUniformBuffer=function(r){return this._multiviewSceneUbo?lO(this.getEngine(),r):l6.bind(this)(r)},dt.prototype._updateMultiviewUbo=function(r,e){r&&e&&r.multiplyToRef(e,this._transformMatrixR),r&&e&&(r.multiplyToRef(e,z.Matrix[0]),as.GetRightPlaneToRef(z.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},dt.prototype._renderMultiviewToSingleView=function(r){r._resizeOrCreateMultiviewTexture(r._rigPostProcess&&r._rigPostProcess&&r._rigPostProcess.width>0?r._rigPostProcess.width:this.getEngine().getRenderWidth(!0),r._rigPostProcess&&r._rigPostProcess&&r._rigPostProcess.height>0?r._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),r.outputRenderTarget=r._multiviewTexture,this._renderForCamera(r),r.outputRenderTarget=null;for(let e=0;e<r._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=r._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}},Ze.prototype.createExternalTexture=function(r){return null},Ze.prototype.setExternalTexture=function(r,e){throw new Error("setExternalTexture: This engine does not support external textures!")},Ze.prototype.setTextureSampler=function(r,e){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")},Object.defineProperty(Ve.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),Ve.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new J,this.onVRRequestPresentComplete=new J,this.onVRRequestPresentStart=new J},Ve.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},Ve.prototype.getVRDevice=function(){return this._vrDisplay},Ve.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},Ve.prototype.initWebVRAsync=function(){const r=()=>{const e={vrDisplay:this._vrDisplay,vrSupported:this._vrSupported};this.onVRDisplayChangedObservable.notifyObservers(e),this._webVRInitPromise=new Promise(t=>{t(e)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=t=>{this._vrDisplay=t.display,r()},this._onVrDisplayDisconnect=()=>{this._vrDisplay.cancelAnimationFrame(this._frameHandler),this._vrDisplay=void 0,this._frameHandler=Ve.QueueNewFrame(this._boundRenderFunction),r()},this._onVrDisplayPresentChange=()=>{this._vrExclusivePointerMode=this._vrDisplay&&this._vrDisplay.isPresenting};const e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(r),this._webVRInitPromise},Ve.prototype._getVRDisplaysAsync=function(){return new Promise(r=>{navigator.getVRDisplays?navigator.getVRDisplays().then(e=>{this._vrSupported=!0,this._vrDisplay=e[0],r({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported})}):(this._vrDisplay=void 0,this._vrSupported=!1,r({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported}))})},Ve.prototype.enableVR=function(r){if(this._vrDisplay&&!this._vrDisplay.isPresenting){const e=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this._onVRFullScreenTriggered()},t=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const i={highRefreshRate:!!this.vrPresentationAttributes&&this.vrPresentationAttributes.highRefreshRate,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&r.useMultiview};this._vrDisplay.requestPresent([Mi({source:this.getRenderingCanvas(),attributes:i},i)]).then(e).catch(t)}},Ve.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new os(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();const r=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(2*r.renderWidth,r.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)},Ve.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(()=>this._onVRFullScreenTriggered()).catch(()=>this._onVRFullScreenTriggered()),rn()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))},Ve.prototype._connectVREvents=function(r,e){if(this._onVRDisplayPointerRestricted=()=>{r&&r.requestPointerLock()},this._onVRDisplayPointerUnrestricted=()=>{if(e)!e.exitPointerLock||e.exitPointerLock();else{const t=this.getHostWindow();t.document&&t.document.exitPointerLock&&t.document.exitPointerLock()}},rn()){const t=this.getHostWindow();t.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),t.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}},Ve.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(r){Ie.Warn("webVR submitFrame has had an unexpected failure: "+r)}},Ve.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting},Ve.prototype._requestVRFrame=function(){this._frameHandler=Ve.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)};const cO=new J,uO=new J;Object.defineProperty(Ve.prototype,"onBeforeViewRenderObservable",{get:function(){return cO}}),Object.defineProperty(Ve.prototype,"onAfterViewRenderObservable",{get:function(){return uO}}),Object.defineProperty(Ve.prototype,"inputElement",{get:function(){return this._inputElement},set:function(r){var e;this._inputElement!==r&&(this._inputElement=r,null===(e=this._onEngineViewChanged)||void 0===e||e.call(this))}}),Ve.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},Ve.prototype.registerView=function(r,e,t){this.views||(this.views=[]);for(const s of this.views)if(s.target===r)return s;const i=this.getRenderingCanvas();i&&(r.width=i.width,r.height=i.height);const n={target:r,camera:e,clearBeforeCopy:t,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(n),e&&e.onDisposeObservable.add(()=>{this.unRegisterView(r)}),n},Ve.prototype.unRegisterView=function(r){if(!this.views||0===this.views.length)return this;for(const e of this.views)if(e.target===r){const t=this.views.indexOf(e);-1!==t&&this.views.splice(t,1);break}return this},Ve.prototype._renderViewStep=function(r){const e=r.target,t=e.getContext("2d");if(!t)return!0;const i=this.getRenderingCanvas();cO.notifyObservers(r);const n=r.camera;let s=null,a=null;if(n){if(a=n.getScene(),!a||a.activeCameras&&a.activeCameras.length)return!0;this.activeView=r,s=a.activeCamera,a.activeCamera=n}if(r.customResize)r.customResize(e);else{const o=Math.floor(e.clientWidth/this._hardwareScalingLevel),l=Math.floor(e.clientHeight/this._hardwareScalingLevel),c=o!==e.width||i.width!==e.width||l!==e.height||i.height!==e.height;e.clientWidth&&e.clientHeight&&c&&(e.width=o,e.height=l,this.setSize(o,l))}return!(!i.width||!i.height||(this._renderFrame(),this.flushFramebuffer(),r.clearBeforeCopy&&t.clearRect(0,0,i.width,i.height),t.drawImage(i,0,0),s&&a&&(a.activeCamera=s),uO.notifyObservers(r),0))},Ve.prototype._renderViews=function(){if(!this.views||0===this.views.length||!this.getRenderingCanvas())return!1;let e;for(const t of this.views)if(t.enabled)if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t;return!(e&&!this._renderViewStep(e)||(this.activeView=null,0))};var Ms=(()=>{return(r=Ms||(Ms={}))[r.Texture=0]="Texture",r[r.StorageTexture=1]="StorageTexture",r[r.UniformBuffer=2]="UniformBuffer",r[r.StorageBuffer=3]="StorageBuffer",r[r.TextureWithoutSampler=4]="TextureWithoutSampler",r[r.Sampler=5]="Sampler",Ms;var r})();function c6(r){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(s=>r&&(r===s||r.match(new RegExp("\\b"+s+"\\b","g")))))return r;const t=r.lastIndexOf("."),i=r.lastIndexOf("?"),n=i>-1?r.substring(i,r.length):"";return(t>-1?r.substring(0,t):r)+this._textureFormatInUse+n}Ze.prototype.createComputeEffect=function(r,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")},Ze.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},Ze.prototype.createComputeContext=function(){},Ze.prototype.computeDispatch=function(r,e,t,i,n,s,a){throw new Error("computeDispatch: This engine does not support compute shaders!")},Ze.prototype.areAllComputeEffectsReady=function(){return!0},Ze.prototype.releaseComputeEffects=function(){},Ze.prototype._prepareComputePipelineContext=function(r,e,t,i,n){},Ze.prototype._rebuildComputeEffects=function(){},Ze.prototype._executeWhenComputeStateIsCompiled=function(r,e){e()},Ze.prototype._releaseComputeEffect=function(r){},Ze.prototype._deleteComputePipelineContext=function(r){},Ze.prototype.createStorageBuffer=function(r,e){throw new Error("createStorageBuffer: Unsupported method in this engine!")},Ze.prototype.updateStorageBuffer=function(r,e,t,i){},Ze.prototype.readFromStorageBuffer=function(r,e,t,i){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")},Ze.prototype.setStorageBuffer=function(r,e){throw new Error("setStorageBuffer: Unsupported method in this engine!")},Object.defineProperty(Ve.prototype,"texturesSupported",{get:function(){const r=new Array;return this._caps.astc&&r.push("-astc.ktx"),this._caps.s3tc&&r.push("-dxt.ktx"),this._caps.pvrtc&&r.push("-pvrtc.ktx"),this._caps.etc2&&r.push("-etc2.ktx"),this._caps.etc1&&r.push("-etc1.ktx"),r},enumerable:!0,configurable:!0}),Object.defineProperty(Ve.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),Ve.prototype.setCompressedTextureExclusions=function(r){this._excludedCompressedTextures=r},Ve.prototype.setTextureFormatToUse=function(r){const e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let n=0,s=r.length;n<s;n++)if(e[t]===r[n].toLowerCase())return this._transformTextureUrl=c6.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};let ME=(()=>{class r{constructor(){const t=new ArrayBuffer(r.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(t),this._int32s=new Int32Array(t),this._float32s=new Float32Array(t),this._length=r.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(t){this._flushIfNecessary(1),this._uint32s[this._position++]=t}writeInt32(t){this._flushIfNecessary(1),this._int32s[this._position++]=t}writeFloat32(t){this._flushIfNecessary(1),this._float32s[this._position++]=t}writeUint32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._uint32s.set(t,this._position),this._position+=t.length}writeInt32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._int32s.set(t,this._position),this._position+=t.length}writeFloat32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._float32s.set(t,this._position),this._position+=t.length}writeNativeData(t){this._flushIfNecessary(t.length),this._uint32s.set(t,this._position),this._position+=t.length}writeBoolean(t){this.writeUint32(t?1:0)}_flushIfNecessary(t){this._position+t>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}return r.DEFAULT_BUFFER_SIZE=65536,r})();function Tp(r,e,t,i){let n=i,s=0,a="";for(;n<t.length;){const o=t.charAt(n);if(a)o===a?'"'===a||"'"===a?"\\"!==t.charAt(n-1)&&(a=""):a="":"*/"===a&&"*"===o&&n+1<t.length&&("/"===t.charAt(n+1)&&(a=""),""===a&&n++);else switch(o){case r:s++;break;case e:s--;break;case'"':case"'":case"`":a=o;break;case"/":if(n+1<t.length){const l=t.charAt(n+1);"/"===l?a="\n":"*"===l&&(a="*/")}}if(n++,0===s)break}return 0===s?n-1:-1}function hO(r,e){for(;e<r.length;){const t=r[e];if(" "!==t&&"\n"!==t&&"\r"!==t&&"\t"!==t&&"\n"!==t&&"\xa0"!==t)break;e++}return e}function DE(r){const e=r.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||95==e}function PE(r){let e=0,t="",i=!1;const n=[];for(;e<r.length;){const s=r.charAt(e);if(t)s===t?'"'===t||"'"===t?("\\"!==r.charAt(e-1)&&(t=""),n.push(s)):(t="",i=!1):"*/"===t&&"*"===s&&e+1<r.length?("/"===r.charAt(e+1)&&(t=""),""===t&&(i=!1,e++)):i||n.push(s);else{switch(s){case'"':case"'":case"`":t=s;break;case"/":if(e+1<r.length){const a=r.charAt(e+1);"/"===a?(t="\n",i=!0):"*"===a&&(t="*/",i=!0)}}i||n.push(s)}e++}return n.join("")}function u6(r,e,t){for(;e>=0&&r.charAt(e)!==t;)e--;return e}function h6(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}let Ep=(()=>{class r{get code(){return this._sourceCode}constructor(t,i=20){this.debug=!1,this._sourceCode=t,this._numMaxIterations=i,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&console.log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")}_collectFunctions(){let t=0;for(;t<this._sourceCode.length;){const i=this._sourceCode.indexOf(this.inlineToken,t);if(i<0)break;const n=this._sourceCode.indexOf("(",i+this.inlineToken.length);if(n<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${t}`),t=i+this.inlineToken.length;continue}const s=r._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(i+this.inlineToken.length,n));if(!s){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(i+this.inlineToken.length,n)}`),t=i+this.inlineToken.length;continue}const[a,o]=[s[3],s[4]],l=Tp("(",")",this._sourceCode,n);if(l<0){this.debug&&console.warn(`Could not extract the parameters the function '${o}' (type=${a}). funcParamsStartIndex=${n}`),t=i+this.inlineToken.length;continue}const c=this._sourceCode.substring(n+1,l),u=hO(this._sourceCode,l+1);if(u===this._sourceCode.length){this.debug&&console.warn(`Could not extract the body of the function '${o}' (type=${a}). funcParamsEndIndex=${l}`),t=i+this.inlineToken.length;continue}const h=Tp("{","}",this._sourceCode,u);if(h<0){this.debug&&console.warn(`Could not extract the body of the function '${o}' (type=${a}). funcBodyStartIndex=${u}`),t=i+this.inlineToken.length;continue}const d=this._sourceCode.substring(u,h+1),f=PE(c).split(","),p=[];for(let m=0;m<f.length;++m){const T=f[m].trim(),v=T.lastIndexOf(" ");v>=0&&p.push(T.substring(v+1))}"void"!==a&&p.push("return"),this._functionDescr.push({name:o,type:a,parameters:p,body:d,callIndex:0}),t=h+1;const g=i>0?this._sourceCode.substring(0,i):"",_=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";this._sourceCode=g+_,t-=h+1-i}this.debug&&console.log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=`,this._functionDescr)}_processInlining(t=20){for(;t-- >=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log(`numMaxIterations is ${t} after inlining process`),t>=0}_replaceFunctionCallsByCode(){let t=!1;for(const i of this._functionDescr){const{name:n,type:s,parameters:a,body:o}=i;let l=0;for(;l<this._sourceCode.length;){const c=this._sourceCode.indexOf(n,l);if(c<0)break;if(0===c||DE(this._sourceCode.charAt(c-1))){l=c+n.length;continue}const u=hO(this._sourceCode,c+n.length);if(u===this._sourceCode.length||"("!==this._sourceCode.charAt(u)){l=c+n.length;continue}const h=Tp("(",")",this._sourceCode,u);if(h<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${n}' (type=${s}). callParamsStartIndex=${u}`),l=c+n.length;continue}const d=this._sourceCode.substring(u+1,h),p=(A=>{const S=[];let x=0,C=0;for(;x<A.length;){if("("===A.charAt(x)){const R=Tp("(",")",A,x);if(R<0)return null;x=R}else","===A.charAt(x)&&(S.push(A.substring(C,x)),C=x+1);x++}return C<x&&S.push(A.substring(C,x)),S})(PE(d));if(null===p){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${n}' (type=${s}). callParamsStartIndex=${u}, callParams=`+d),l=c+n.length;continue}const g=[];for(let A=0;A<p.length;++A){const S=p[A].trim();g.push(S)}const _="void"!==s?n+"_"+i.callIndex++:null;if(_&&g.push(_+" ="),g.length!==a.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${n}' (type=${s}). function parameters=${a}, call parameters=${g}`),l=c+n.length;continue}l=h+1;const m=this._replaceNames(o,a,g);let T=c>0?this._sourceCode.substring(0,c):"";const v=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(_){const A=u6(this._sourceCode,c-1,"\n");T=this._sourceCode.substring(0,A+1);const S=this._sourceCode.substring(A+1,c);this._sourceCode=T+s+" "+_+";\n"+m+"\n"+S+_+v,this.debug&&console.log(`Replace function call by code. Function '${n}' (type=${s}). injectDeclarationIndex=${A}, call parameters=${g}`)}else this._sourceCode=T+m+v,l+=m.length-(h+1-c),this.debug&&console.log(`Replace function call by code. Function '${n}' (type=${s}). functionCallIndex=${c}, call parameters=${g}`);t=!0}}return t}_replaceNames(t,i,n){for(let s=0;s<i.length;++s){const a=new RegExp(h6(i[s]),"g"),o=i[s].length,l=n[s];t=t.replace(a,(c,...u)=>{const h=u[0];return DE(t.charAt(h-1))||DE(t.charAt(h+o))?i[s]:l})}return t}}return r._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,r})();class d6{get isAsync(){return this.isParallelCompiled}get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}_handlesSpectorRebuildCallback(e){throw new Error("Not implemented")}constructor(e){this.isParallelCompiled=!0,this.isCompiled=!1,this._valueCache={},this._engine=e}_fillEffectInformation(e,t,i,n,s,a,o,l){const c=this._engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);let h;for(this._engine.getUniforms(this,i).forEach((d,f)=>{n[i[f]]=d}),this._uniforms=n,h=0;h<s.length;h++)null==e.getUniform(s[h])&&(s.splice(h,1),h--);s.forEach((d,f)=>{a[d]=f}),l.push(...c.getAttributes(this,o))}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],n=t.updateFlag;return(void 0===i||i!==n)&&(this._valueCache[e]=n,!0)}_cacheFloat2(e,t,i){let n=this._valueCache[e];if(!n)return n=[t,i],this._valueCache[e]=n,!0;let s=!1;return n[0]!==t&&(n[0]=t,s=!0),n[1]!==i&&(n[1]=i,s=!0),s}_cacheFloat3(e,t,i,n){let s=this._valueCache[e];if(!s)return s=[t,i,n],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==i&&(s[1]=i,a=!0),s[2]!==n&&(s[2]=n,a=!0),a}_cacheFloat4(e,t,i,n,s){let a=this._valueCache[e];if(!a)return a=[t,i,n,s],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==n&&(a[2]=n,o=!0),a[3]!==s&&(a[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this._engine.setInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setInt4(e,t,i,n,s){this._cacheFloat4(e,t,i,n,s)&&(this._engine.setInt4(this._uniforms[e],t,i,n,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this._engine.setUInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setUInt4(e,t,i,n,s){this._cacheFloat4(e,t,i,n,s)&&(this._engine.setUInt4(this._uniforms[e],t,i,n,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){!t||(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this._engine.setFloat3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,n,s){this._cacheFloat4(e,t,i,n,s)&&(this._engine.setFloat4(this._uniforms[e],t,i,n,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class f6 extends hT{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,n){super(e,t,i,n),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=n}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class dO{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}const fO=new J;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let r;Object.defineProperty(self,"_native",{get:()=>r,set:e=>{r=e,r&&fO.notifyObservers(r)}})}class pO extends Df{}class g6{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=gO._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}let gO=(()=>{class r extends Ve{setHardwareScalingLevel(t){super.setHardwareScalingLevel(t),this._engine.setHardwareScalingLevel(t)}constructor(t={}){if(super(null,!1,void 0,t.adaptToDeviceRatio),this._engine=new _native.Engine,this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new g6(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==r.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${r.PROTOCOL_VERSION} (JS)`);this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},Ie.Log("Babylon Native (v"+Ve.Version+") launched"),Ie.LoadScript=function(s,a,o,l){Ie.LoadFile(s,c=>{Function(c).apply(null),a&&a()},void 0,void 0,!1,(c,u)=>{o&&o("LoadScript Error",u)})},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(s){return s}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function s(){const a=isNaN(arguments[0])?1:Number(arguments[0]);return a?Array.prototype.reduce.call(this,function(o,l){return Array.isArray(l)?o.push.apply(o,s.call(l,a-1)):o.push(l),o},[]):Array.prototype.slice.call(this)},writable:!0});const i=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=t.adaptToDeviceRatio?1/i:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=i,this.resize();const n=this.getDepthFunction();n&&this.setDepthFunction(n),this._shaderProcessor=new jb,this.onNewSceneAddedObservable.add(s=>{const a=s.render;s.render=(...o)=>{this._commandBufferEncoder.beginCommandScope(),a.apply(s,o),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new ME}_queueNewFrame(t,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(t):this._engine.requestAnimationFrame(t),0}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=t)}getHostDocument(){return null}clear(t,i,n,s=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(i&&t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(n?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(t,i){const n=this._normalizeIndexData(t),s=new pO;return s.references=1,s.is32Bits=4===n.BYTES_PER_ELEMENT,n.byteLength&&(s.nativeIndexBuffer=this._engine.createIndexBuffer(n.buffer,n.byteOffset,n.byteLength,s.is32Bits,null!=i&&i)),s}createVertexBuffer(t,i){const n=ArrayBuffer.isView(t)?t:new Float32Array(t),s=new pO;return s.references=1,n.byteLength&&(s.nativeVertexBuffer=this._engine.createVertexBuffer(n.buffer,n.byteOffset,n.byteLength,null!=i&&i)),s}_recordVertexArrayObject(t,i,n,s,a){n&&this._engine.recordIndexBuffer(t,n.nativeIndexBuffer);const o=s.getAttributesNames();for(let l=0;l<o.length;l++){const c=s.getAttributeLocation(l);if(c>=0){const u=o[l];let h=null;if(a&&(h=a[u]),h||(h=i[u]),h){const d=h.getBuffer();d&&d.nativeVertexBuffer&&this._engine.recordVertexBuffer(t,d.nativeVertexBuffer,c,h.byteOffset,h.byteStride,h.getSize(),this._getNativeAttribType(h.type),h.normalized,h.getInstanceDivisor())}}}}bindBuffers(t,i,n){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,t,i,n),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(t,i,n,s){const a=this._engine.createVertexArray();return this._recordVertexArrayObject(a,t,i,n,s),a}_deleteVertexArray(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(t){this._deleteVertexArray(t)}getAttributes(t,i){return this._engine.getAttributes(t.nativeProgram,i)}drawElementsType(t,i,n,s){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(t,i,n,s){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(){return new d6(this)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(t,i,n,s,a,o,l,c){t.nativeProgram=s?this.createRawShaderProgram():this.createShaderProgram(t,i,n,c)}isAsync(t){return!(!t.isAsync||!this._engine.createProgramAsync)}_executeWhenRenderingStateIsCompiled(t,i){const n=t;if(!this.isAsync(t))return void i();const s=n.onCompiled;n.onCompiled=s?()=>{s(),i()}:i}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(t,i,n,s){const a=t;if(a.nativeProgram)throw new Error("Tried to create a second program in the same NativePipelineContext");this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=new Ep(i);o.processCode(),i=o.code;const l=new Ep(n);l.processCode(),n=l.code,i=Ze._ConcatenateShader(i,s),n=Ze._ConcatenateShader(n,s);const c=()=>{var u;a.isCompiled=!0,null===(u=a.onCompiled)||void 0===u||u.call(a),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(this.isAsync(t))return this._engine.createProgramAsync(i,n,c,u=>{a.compilationError=u});try{const u=a.nativeProgram=this._engine.createProgram(i,n);return c(),u}catch(u){const h=null==u?void 0:u.message;throw new Error("SHADER ERROR"+("string"==typeof h?"\n"+h:""))}}inlineShaderCode(t){const i=new Ep(t);return i.debug=!1,i.processCode(),i.code}_setProgram(t){this._currentProgram!==t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=t)}_deletePipelineContext(t){const i=t;i&&i.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(i.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(t,i){return this._engine.getUniforms(t.nativeProgram,i)}bindUniformBlock(t,i,n){throw new Error("Not Implemented")}bindSamplers(t){const i=t.getPipelineContext();this._setProgram(i.nativeProgram);const n=t.getSamplers();for(let s=0;s<n.length;s++){const a=t.getUniform(n[s]);a&&(this._boundUniforms[s]=a)}this._currentEffect=null}getRenderWidth(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(t,i,n){this._cachedViewport=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.height),this._commandBufferEncoder.finishEncodingCommand()}setState(t,i=0,n,s=!1,a,o,l=0){var c,u;this._zOffset=i,this._zOffsetUnits=l,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(l),this._commandBufferEncoder.encodeCommandArgAsUInt32(null===(u=null!==(c=this.cullBackFaces)&&void 0!==c?c:a)||void 0===u||u?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(t){t!==this._zOffset&&(this._zOffset=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(t){t!==this._zOffsetUnits&&(this._zOffsetUnits=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(t){let i=0;switch(t){case 512:i=_native.Engine.DEPTH_TEST_NEVER;break;case 519:i=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:i=_native.Engine.DEPTH_TEST_GREATER;break;case 518:i=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:i=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:i=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:i=_native.Engine.DEPTH_TEST_LESS;break;case 515:i=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=i,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(t){this._depthWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(t){this._colorWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,this._getStencilOpFail(this._stencilOpStencilFail),this._getStencilDepthFail(this._stencilOpDepthFail),this._getStencilDepthPass(this._stencilOpStencilDepthPass),this._getStencilFunc(this._stencilFunc),this._stencilFuncRef)}_setStencil(t,i,n,s,a,o){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.encodeCommandArgAsUInt32(o),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(t){this._stencilTest=t,t?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(t){this._stencilOpStencilDepthPass=t,this.applyStencil()}setStencilMask(t){this._stencilMask=t,this.applyStencil()}setStencilFunction(t){this._stencilFunc=t,this.applyStencil()}setStencilFunctionReference(t){this._stencilFuncRef=t,this.applyStencil()}setStencilFunctionMask(t){this._stencilFuncMask=t}setStencilOperationFail(t){this._stencilOpStencilFail=t,this.applyStencil()}setStencilOperationDepthFail(t){this._stencilOpDepthFail=t,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(t,i,n,s){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(t,i=!1){if(this._alphaMode===t)return;const n=this._getNativeAlphaMode(t);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand(),i||this.setDepthWrite(0===t),this._alphaMode=t}getAlphaMode(){return this._alphaMode}setInt(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(t,i){return!!t&&this.setFloatArray(t,new Float32Array(i))}setArray2(t,i){return!!t&&this.setFloatArray2(t,new Float32Array(i))}setArray3(t,i){return!!t&&this.setFloatArray3(t,new Float32Array(i))}setArray4(t,i){return!!t&&this.setFloatArray4(t,new Float32Array(i))}setMatrices(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(t,i){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(t,i,n){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(t,i,n,s){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(t,i,n,s,a){return!!t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.encodeCommandArgAsFloat32(a),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(t,i){return!!t&&(this.setFloat3(t,i.r,i.g,i.b),!0)}setColor4(t,i,n){return!!t&&(this.setFloat4(t,i.r,i.g,i.b,n),!0)}wipeCaches(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,t&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(t){t&&this._engine.deleteTexture(t)}updateDynamicTexture(t,i,n,s=!1,a){if(void 0===s&&(s=!1),t&&t._hardwareTexture){const o=i.getCanvasTexture();this._engine.copyTexture(t._hardwareTexture.underlyingResource,o),t.isReady=!0}}createDynamicTexture(t,i,n,s){return t=Math.max(t,1),i=Math.max(i,1),this.createRawTexture(new Uint8Array(t*i*4),t,i,5,!1,!1,s)}createVideoElement(t){return this._camera?this._camera.createVideo(t):null}updateVideoTexture(t,i,n){t&&t._hardwareTexture&&this._camera&&this._camera.updateVideoTexture(t._hardwareTexture.underlyingResource,i,n)}createRawTexture(t,i,n,s,a,o,l,c=null,u=0,h=0,d=!1){const f=new hi(this,vt.Raw);if(f.format=s,f.generateMipMaps=a,f.samplingMode=l,f.invertY=o,f.baseWidth=i,f.baseHeight=n,f.width=f.baseWidth,f.height=f.baseHeight,f._compression=c,f.type=u,f._useSRGBBuffer=this._getUseSRGBBuffer(d,!a),this.updateRawTexture(f,t,s,o,c,u,f._useSRGBBuffer),f._hardwareTexture){const p=f._hardwareTexture.underlyingResource,g=this._getNativeSamplingMode(l);this._setTextureSampling(p,g)}return this._internalTexturesCache.push(f),f}createRawTexture2DArray(t,i,n,s,a,o,l,c,u=null,h=0){const d=new hi(this,vt.Raw2DArray);if(d.baseWidth=i,d.baseHeight=n,d.baseDepth=s,d.width=i,d.height=n,d.depth=s,d.format=a,d.type=h,d.generateMipMaps=o,d.samplingMode=c,d.is2DArray=!0,d._hardwareTexture){const f=d._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(f,t,i,n,s,this._getNativeTextureFormat(a,h),o,l);const p=this._getNativeSamplingMode(c);this._setTextureSampling(f,p)}return d.isReady=!0,this._internalTexturesCache.push(d),d}updateRawTexture(t,i,n,s,a=null,o=0,l=!1){t&&(i&&t._hardwareTexture&&this._engine.loadRawTexture(t._hardwareTexture.underlyingResource,i,t.width,t.height,this._getNativeTextureFormat(n,o),t.generateMipMaps,t.invertY),t.isReady=!0)}createTexture(t,i,n,s,a=3,o=null,l=null,c=null,u=null,h=null,d=null,f,p,g,_=!1){const m="data:"===(t=t||"").substr(0,5),T=m&&-1!==t.indexOf(";base64,"),v=u||new hi(this,vt.Url),A=t;this._transformTextureUrl&&!T&&!u&&!c&&(t=this._transformTextureUrl(t));const S=t.lastIndexOf("."),x=d||(S>-1?t.substring(S).toLowerCase():"");let C=null;for(const P of Ve._TextureLoaders)if(P.canLoad(x)){C=P;break}s&&s.addPendingData(v),v.url=t,v.generateMipMaps=!i,v.samplingMode=a,v.invertY=n,v._useSRGBBuffer=this._getUseSRGBBuffer(_,i),this.doNotHandleContextLost||(v._buffer=c);let R=null;o&&!u&&(R=v.onLoadedObservable.add(o)),u||this._internalTexturesCache.push(v);const D=(P,N)=>{s&&s.removePendingData(v),t===A?(R&&v.onLoadedObservable.remove(R),Je.UseFallbackTexture&&this.createTexture(Je.FallbackTexture,i,v.invertY,s,a,null,l,c,v),l&&l((P||"Unknown error")+(Je.UseFallbackTexture?" - Fallback texture was used":""),N)):(H.Warn(`Failed to load ${t}, falling back to ${A}`),this.createTexture(A,i,v.invertY,s,a,o,l,c,v,h,d,f,p))};if(C)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const P=N=>{if(!v._hardwareTexture)return void(s&&s.removePendingData(v));const k=v._hardwareTexture.underlyingResource;this._engine.loadTexture(k,N,!i,n,_,()=>{v.baseWidth=this._engine.getTextureWidth(k),v.baseHeight=this._engine.getTextureHeight(k),v.width=v.baseWidth,v.height=v.baseHeight,v.isReady=!0;const X=this._getNativeSamplingMode(a);this._setTextureSampling(k,X),s&&s.removePendingData(v),v.onLoadedObservable.notifyObservers(v),v.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(m&&c)if(c instanceof ArrayBuffer)P(new Uint8Array(c));else if(ArrayBuffer.isView(c))P(c);else{if("string"!=typeof c)throw new Error("Unsupported buffer type");P(new Uint8Array(Ie.DecodeBase64(c)))}else T?P(new Uint8Array(Ie.DecodeBase64(t))):this._loadFile(t,N=>P(new Uint8Array(N)),void 0,void 0,!0,(N,k)=>{D("Unable to load "+k)})}return v}wrapNativeTexture(t,i=!1,n=3){const s=new dO(t,this._engine),a=new hi(this,vt.Unknown,!0);return a._hardwareTexture=s,a.isReady=!0,a.useMipMaps=i,this.updateTextureSamplingMode(n,a),a}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(t,i,n){const s=n,a=new hi(this,vt.DepthStencil),c=this._engine.createFrameBuffer(a._hardwareTexture.underlyingResource,t.width||t,t.height||t,!0,!0);return s._framebufferDepthStencil=c,a}_releaseFramebufferObjects(t){t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(t,i){return new Promise((s,a)=>{const o=this.createCanvasImage();o.onload=()=>{try{const l=this._engine.createImageBitmap(o);s(l)}catch(l){a(`Error loading image ${o.src} with exception: ${l}`)}},o.onerror=l=>{a(`Error loading image ${o.src} with exception: ${l}`)},o.src=t})}createImageBitmap(t,i){return new Promise((n,s)=>{if(Array.isArray(t)){const a=t;if(a.length){const o=this._engine.createImageBitmap(a[0]);if(o)return void n(o)}}s("Unsupported data for createImageBitmap.")})}resizeImageBitmap(t,i,n){return this._engine.resizeImageBitmap(t,i,n)}createCubeTexture(t,i,n,s,a=null,o=null,l,c=null,u=!1,h=0,d=0,f=null,p,g=!1){const _=f||new hi(this,vt.Cube);_.isCube=!0,_.url=t,_.generateMipMaps=!s,_._lodGenerationScale=h,_._lodGenerationOffset=d,this._doNotHandleContextLost||(_._extension=c,_._files=n);const m=t.lastIndexOf(".");if(".env"===(c||(m>-1?t.substring(m).toLowerCase():""))){const v=A=>{const S=nE(A);_.width=S.width,_.height=S.width,aE(_,S);const x=S.specular;if(!x)throw new Error("Nothing else parsed so far");_._lodGenerationScale=x.lodGenerationScale;const C=sE(A,S);_.format=5,_.type=0,_.generateMipMaps=!0,_.getEngine().updateTextureSamplingMode(j.TRILINEAR_SAMPLINGMODE,_),_._isRGBD=!0,_.invertY=!0,this._engine.loadCubeTextureWithMips(_._hardwareTexture.underlyingResource,C,!1,g,()=>{_.isReady=!0,a&&a()},()=>{throw new Error("Could not load a native cube texture.")})};if(n&&6===n.length)throw new Error("Multi-file loading not allowed on env files.");this._loadFile(t,S=>v(new Uint8Array(S)),void 0,void 0,!0,(S,x)=>{o&&S&&o(S.status+" "+S.statusText,x)})}else{if(!n||6!==n.length)throw new Error("Cannot load cubemap because 6 files were not defined");Promise.all([n[0],n[3],n[1],n[4],n[2],n[5]].map(A=>Ie.LoadFileAsync(A).then(S=>new Uint8Array(S)))).then(A=>new Promise((S,x)=>{this._engine.loadCubeTexture(_._hardwareTexture.underlyingResource,A,!s,!0,g,S,x)})).then(()=>{_.isReady=!0,a&&a()},A=>{o&&o(`Failed to load cubemap: ${A.message}`,A)})}return this._internalTexturesCache.push(_),_}_createHardwareTexture(){return new dO(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(t,i,n){const s=new f6(t,i,n,this);return this._renderTargetWrapperCache.push(s),s}_createInternalTexture(t,i,n=!0,s=vt.Unknown){var a;let f,o=!1,l=0,c=3,u=5,h=!1,d=1;void 0!==i&&"object"==typeof i?(o=!!i.generateMipMaps,l=void 0===i.type?0:i.type,c=void 0===i.samplingMode?3:i.samplingMode,u=void 0===i.format?5:i.format,h=void 0!==i.useSRGBBuffer&&i.useSRGBBuffer,d=null!==(a=i.samples)&&void 0!==a?a:1,f=i.label):o=!!i,h&&(h=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1===l&&!this._caps.textureFloatLinearFiltering||2===l&&!this._caps.textureHalfFloatLinearFiltering)&&(c=1),1===l&&!this._caps.textureFloat&&(l=0,H.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const p=new hi(this,s),g=t.width||t,_=t.height||t,m=t.layers||0;if(0!==m)throw new Error("Texture layers are not supported in Babylon Native");const T=p._hardwareTexture.underlyingResource,v=this._getNativeTextureFormat(u,l);return this._engine.initializeTexture(T,g,_,o,v,!0,h),this._setTextureSampling(T,this._getNativeSamplingMode(c)),p._useSRGBBuffer=h,p.baseWidth=g,p.baseHeight=_,p.width=g,p.height=_,p.depth=m,p.isReady=!0,p.samples=d,p.generateMipMaps=o,p.samplingMode=c,p.type=l,p.format=u,p.label=f,this._internalTexturesCache.push(p),p}createRenderTargetTexture(t,i){var n,s;const a=this._createHardwareRenderTargetWrapper(!1,!1,t);let u,o=!0,l=!1,c=!1,h=1;void 0!==i&&"object"==typeof i&&(o=null===(n=i.generateDepthBuffer)||void 0===n||n,l=!!i.generateStencilBuffer,c=!!i.noColorAttachment,u=i.colorAttachment,h=null!==(s=i.samples)&&void 0!==s?s:1);const d=u||(c?null:this._createInternalTexture(t,i,!0,vt.RenderTarget)),g=this._engine.createFrameBuffer(d?d._hardwareTexture.underlyingResource:null,t.width||t,t.height||t,l,o);return a._framebuffer=g,a._generateDepthBuffer=o,a._generateStencilBuffer=l,a.setTextures(d),this.updateRenderTargetTextureSampleCount(a,h),a}updateRenderTargetTextureSampleCount(t,i){return 1}updateTextureSamplingMode(t,i){if(i._hardwareTexture){const n=this._getNativeSamplingMode(t);this._setTextureSampling(i._hardwareTexture.underlyingResource,n)}i.samplingMode=t}bindFramebuffer(t,i,n,s,a){const o=t;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(n||s)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");this._bindUnboundFramebuffer(o._framebufferDepthStencil?o._framebufferDepthStencil:o._framebuffer)}unBindFramebuffer(t,i=!1,n){this._currentRenderTarget=null,n&&n(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t,!0)}updateDynamicIndexBuffer(t,i,n=0){const s=t,a=this._normalizeIndexData(i);s.is32Bits=4===a.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(s.nativeIndexBuffer,a.buffer,a.byteOffset,a.byteLength,n)}updateDynamicVertexBuffer(t,i,n,s){const a=t,o=ArrayBuffer.isView(i)?i:new Float32Array(i);this._engine.updateDynamicVertexBuffer(a.nativeVertexBuffer,o.buffer,o.byteOffset+(null!=n?n:0),null!=s?s:o.byteLength)}_setTexture(t,i,n=!1,s=!1){const a=this._boundUniforms[t];if(!a)return!1;if(!i)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._boundTexturesCache[t]=null),!1;if(i.video)this._activeChannel=t,i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let o;return o=s?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=t,!(!o||!o._hardwareTexture||(this._setTextureWrapMode(o._hardwareTexture.underlyingResource,this._getAddressMode(i.wrapU),this._getAddressMode(i.wrapV),this._getAddressMode(i.wrapR)),this._updateAnisotropicLevel(i),this._setTextureCore(a,o._hardwareTexture.underlyingResource),0))}_setTextureSampling(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(t,i,n,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}_setTextureCore(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsNativeData(i),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(t){const i=t.getInternalTexture(),n=t.anisotropicFilteringLevel;!i||!i._hardwareTexture||i._cachedAnisotropicFilteringLevel!==n&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(i._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand(),i._cachedAnisotropicFilteringLevel=n)}_getAddressMode(t){switch(t){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+t+".")}}_bindTexture(t,i){const n=this._boundUniforms[t];n&&i&&i._hardwareTexture&&this._setTextureCore(n,i._hardwareTexture.underlyingResource)}_deleteBuffer(t){t.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeIndexBuffer),t.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeVertexBuffer)}createCanvas(t,i){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const n=new _native.Canvas;return n.width=t,n.height=i,n}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(t,i,n,s,a,o,l=0,c=0,u=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(t,i,n,s,a,o=0,l=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(t,i,n=0,s=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(t,i,n=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(t,i,n=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_getNativeSamplingMode(t){switch(t){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${t}.`)}}_getStencilFunc(t){switch(t){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${t}.`)}}_getStencilOpFail(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${t}.`)}}_getStencilDepthFail(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${t}.`)}}_getStencilDepthPass(t){switch(t){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${t}.`)}}_getNativeTextureFormat(t,i){if(4==t&&0==i)return _native.Engine.TEXTURE_FORMAT_RGB8;if(5==t&&0==i)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(5==t&&2==i)return _native.Engine.TEXTURE_FORMAT_RGBA16F;if(5==t&&1==i)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new xa(`Unsupported texture format or type: format ${t}, type ${i}.`,1e3)}_getNativeAlphaMode(t){switch(t){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${t}.`)}}_getNativeAttribType(t){switch(t){case I.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case I.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case I.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case I.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case I.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${t}.`)}}getFontOffset(t){return{ascent:0,height:0,descent:0}}_readTexturePixels(t,i,n,s,a,o,l,c,u,h){var d,f,p,g;if(void 0!==s&&-1!==s)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${s}.`);return this._engine.readTexture(null===(d=t._hardwareTexture)||void 0===d?void 0:d.underlyingResource,null!=a?a:0,null!=u?u:0,null!=h?h:0,i,n,null!==(f=null==o?void 0:o.buffer)&&void 0!==f?f:null,null!==(p=null==o?void 0:o.byteOffset)&&void 0!==p?p:0,null!==(g=null==o?void 0:o.byteLength)&&void 0!==g?g:0).then(_=>(o||(o=new Uint8Array(_)),o))}}return r.PROTOCOL_VERSION=8,r})();gO._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new _6:new ME};class _6 extends ME{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}var ao=(()=>{return(r=ao||(ao={})).DepthClipControl="depth-clip-control",r.Depth32FloatStencil8="depth32float-stencil8",r.TextureCompressionBC="texture-compression-bc",r.TextureCompressionETC2="texture-compression-etc2",r.TextureCompressionASTC="texture-compression-astc",r.TimestampQuery="timestamp-query",r.IndirectFirstInstance="indirect-first-instance",r.ShaderF16="shader-f16",r.RG11B10UFloatRenderable="rg11b10ufloat-renderable",r.BGRA8UnormStorage="bgra8unorm-storage",r.Float32Filterable="float32-filterable",ao;var r})(),_i=(()=>{return(r=_i||(_i={}))[r.MapRead=1]="MapRead",r[r.MapWrite=2]="MapWrite",r[r.CopySrc=4]="CopySrc",r[r.CopyDst=8]="CopyDst",r[r.Index=16]="Index",r[r.Vertex=32]="Vertex",r[r.Uniform=64]="Uniform",r[r.Storage=128]="Storage",r[r.Indirect=256]="Indirect",r[r.QueryResolve=512]="QueryResolve",_i;var r})(),Xo=(()=>{return(r=Xo||(Xo={}))[r.Read=1]="Read",r[r.Write=2]="Write",Xo;var r})(),ds=(()=>{return(r=ds||(ds={})).E1d="1d",r.E2d="2d",r.E3d="3d",ds;var r})(),yi=(()=>{return(r=yi||(yi={}))[r.CopySrc=1]="CopySrc",r[r.CopyDst=2]="CopyDst",r[r.TextureBinding=4]="TextureBinding",r[r.StorageBinding=8]="StorageBinding",r[r.RenderAttachment=16]="RenderAttachment",yi;var r})(),fi=(()=>{return(r=fi||(fi={})).E1d="1d",r.E2d="2d",r.E2dArray="2d-array",r.Cube="cube",r.CubeArray="cube-array",r.E3d="3d",fi;var r})(),ta=(()=>{return(r=ta||(ta={})).All="all",r.StencilOnly="stencil-only",r.DepthOnly="depth-only",ta;var r})(),M=(()=>{return(r=M||(M={})).R8Unorm="r8unorm",r.R8Snorm="r8snorm",r.R8Uint="r8uint",r.R8Sint="r8sint",r.R16Uint="r16uint",r.R16Sint="r16sint",r.R16Float="r16float",r.RG8Unorm="rg8unorm",r.RG8Snorm="rg8snorm",r.RG8Uint="rg8uint",r.RG8Sint="rg8sint",r.R32Uint="r32uint",r.R32Sint="r32sint",r.R32Float="r32float",r.RG16Uint="rg16uint",r.RG16Sint="rg16sint",r.RG16Float="rg16float",r.RGBA8Unorm="rgba8unorm",r.RGBA8UnormSRGB="rgba8unorm-srgb",r.RGBA8Snorm="rgba8snorm",r.RGBA8Uint="rgba8uint",r.RGBA8Sint="rgba8sint",r.BGRA8Unorm="bgra8unorm",r.BGRA8UnormSRGB="bgra8unorm-srgb",r.RGB9E5UFloat="rgb9e5ufloat",r.RGB10A2Unorm="rgb10a2unorm",r.RG11B10UFloat="rg11b10ufloat",r.RG32Uint="rg32uint",r.RG32Sint="rg32sint",r.RG32Float="rg32float",r.RGBA16Uint="rgba16uint",r.RGBA16Sint="rgba16sint",r.RGBA16Float="rgba16float",r.RGBA32Uint="rgba32uint",r.RGBA32Sint="rgba32sint",r.RGBA32Float="rgba32float",r.Stencil8="stencil8",r.Depth16Unorm="depth16unorm",r.Depth24Plus="depth24plus",r.Depth24PlusStencil8="depth24plus-stencil8",r.Depth32Float="depth32float",r.BC1RGBAUnorm="bc1-rgba-unorm",r.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",r.BC2RGBAUnorm="bc2-rgba-unorm",r.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",r.BC3RGBAUnorm="bc3-rgba-unorm",r.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",r.BC4RUnorm="bc4-r-unorm",r.BC4RSnorm="bc4-r-snorm",r.BC5RGUnorm="bc5-rg-unorm",r.BC5RGSnorm="bc5-rg-snorm",r.BC6HRGBUFloat="bc6h-rgb-ufloat",r.BC6HRGBFloat="bc6h-rgb-float",r.BC7RGBAUnorm="bc7-rgba-unorm",r.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",r.ETC2RGB8Unorm="etc2-rgb8unorm",r.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",r.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",r.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",r.ETC2RGBA8Unorm="etc2-rgba8unorm",r.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",r.EACR11Unorm="eac-r11unorm",r.EACR11Snorm="eac-r11snorm",r.EACRG11Unorm="eac-rg11unorm",r.EACRG11Snorm="eac-rg11snorm",r.ASTC4x4Unorm="astc-4x4-unorm",r.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",r.ASTC5x4Unorm="astc-5x4-unorm",r.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",r.ASTC5x5Unorm="astc-5x5-unorm",r.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",r.ASTC6x5Unorm="astc-6x5-unorm",r.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",r.ASTC6x6Unorm="astc-6x6-unorm",r.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",r.ASTC8x5Unorm="astc-8x5-unorm",r.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",r.ASTC8x6Unorm="astc-8x6-unorm",r.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",r.ASTC8x8Unorm="astc-8x8-unorm",r.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",r.ASTC10x5Unorm="astc-10x5-unorm",r.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",r.ASTC10x6Unorm="astc-10x6-unorm",r.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",r.ASTC10x8Unorm="astc-10x8-unorm",r.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",r.ASTC10x10Unorm="astc-10x10-unorm",r.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",r.ASTC12x10Unorm="astc-12x10-unorm",r.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",r.ASTC12x12Unorm="astc-12x12-unorm",r.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",r.Depth24UnormStencil8="depth24unorm-stencil8",r.Depth32FloatStencil8="depth32float-stencil8",M;var r})(),Dl=(()=>{return(r=Dl||(Dl={})).ClampToEdge="clamp-to-edge",r.Repeat="repeat",r.MirrorRepeat="mirror-repeat",Dl;var r})(),Ft=(()=>{return(r=Ft||(Ft={})).Nearest="nearest",r.Linear="linear",Ft;var r})(),vn=(()=>{return(r=vn||(vn={})).Never="never",r.Less="less",r.Equal="equal",r.LessEqual="less-equal",r.Greater="greater",r.NotEqual="not-equal",r.GreaterEqual="greater-equal",r.Always="always",vn;var r})(),oo=(()=>{return(r=oo||(oo={}))[r.Vertex=1]="Vertex",r[r.Fragment=2]="Fragment",r[r.Compute=4]="Compute",oo;var r})(),lo=(()=>{return(r=lo||(lo={})).Uniform="uniform",r.Storage="storage",r.ReadOnlyStorage="read-only-storage",lo;var r})(),co=(()=>{return(r=co||(co={})).Filtering="filtering",r.NonFiltering="non-filtering",r.Comparison="comparison",co;var r})(),Pr=(()=>{return(r=Pr||(Pr={})).Float="float",r.UnfilterableFloat="unfilterable-float",r.Depth="depth",r.Sint="sint",r.Uint="uint",Pr;var r})(),vp=(()=>((vp||(vp={})).WriteOnly="write-only",vp))(),Jc=(()=>((Jc||(Jc={})).Auto="auto",Jc))(),wr=(()=>{return(r=wr||(wr={})).PointList="point-list",r.LineList="line-list",r.LineStrip="line-strip",r.TriangleList="triangle-list",r.TriangleStrip="triangle-strip",wr;var r})(),Dh=(()=>{return(r=Dh||(Dh={})).CCW="ccw",r.CW="cw",Dh;var r})(),eu=(()=>{return(r=eu||(eu={})).None="none",r.Front="front",r.Back="back",eu;var r})(),Yn=(()=>{return(r=Yn||(Yn={})).Zero="zero",r.One="one",r.Src="src",r.OneMinusSrc="one-minus-src",r.SrcAlpha="src-alpha",r.OneMinusSrcAlpha="one-minus-src-alpha",r.Dst="dst",r.OneMinusDst="one-minus-dst",r.DstAlpha="dst-alpha",r.OneMinusDstAlpha="one-minus-dst-alpha",r.SrcAlphaSaturated="src-alpha-saturated",r.Constant="constant",r.OneMinusConstant="one-minus-constant",Yn;var r})(),uo=(()=>{return(r=uo||(uo={})).Add="add",r.Subtract="subtract",r.ReverseSubtract="reverse-subtract",r.Min="min",r.Max="max",uo;var r})(),Ds=(()=>{return(r=Ds||(Ds={})).Keep="keep",r.Zero="zero",r.Replace="replace",r.Invert="invert",r.IncrementClamp="increment-clamp",r.DecrementClamp="decrement-clamp",r.IncrementWrap="increment-wrap",r.DecrementWrap="decrement-wrap",Ds;var r})(),ho=(()=>{return(r=ho||(ho={})).Uint16="uint16",r.Uint32="uint32",ho;var r})(),wi=(()=>{return(r=wi||(wi={})).Uint8x2="uint8x2",r.Uint8x4="uint8x4",r.Sint8x2="sint8x2",r.Sint8x4="sint8x4",r.Unorm8x2="unorm8x2",r.Unorm8x4="unorm8x4",r.Snorm8x2="snorm8x2",r.Snorm8x4="snorm8x4",r.Uint16x2="uint16x2",r.Uint16x4="uint16x4",r.Sint16x2="sint16x2",r.Sint16x4="sint16x4",r.Unorm16x2="unorm16x2",r.Unorm16x4="unorm16x4",r.Snorm16x2="snorm16x2",r.Snorm16x4="snorm16x4",r.Float16x2="float16x2",r.Float16x4="float16x4",r.Float32="float32",r.Float32x2="float32x2",r.Float32x3="float32x3",r.Float32x4="float32x4",r.Uint32="uint32",r.Uint32x2="uint32x2",r.Uint32x3="uint32x3",r.Uint32x4="uint32x4",r.Sint32="sint32",r.Sint32x2="sint32x2",r.Sint32x3="sint32x3",r.Sint32x4="sint32x4",wi;var r})(),Ph=(()=>{return(r=Ph||(Ph={})).Vertex="vertex",r.Instance="instance",Ph;var r})(),an=(()=>{return(r=an||(an={})).Load="load",r.Clear="clear",an;var r})(),$r=(()=>{return(r=$r||($r={})).Store="store",r.Discard="discard",$r;var r})(),wh=(()=>{return(r=wh||(wh={})).Occlusion="occlusion",r.Timestamp="timestamp",wh;var r})(),Oh=(()=>{return(r=Oh||(Oh={})).Opaque="opaque",r.Premultiplied="premultiplied",Oh;var r})();class Oi{constructor(){this.shaderLanguage=Ri.GLSL}_addUniformToLeftOverUBO(e,t,i){let n=0;[e,t,n]=this._getArraySize(e,t,i);for(let s=0;s<this._webgpuProcessingContext.leftOverUniforms.length;s++)if(this._webgpuProcessingContext.leftOverUniforms[s].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:n})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=Oi.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,lo.Uniform,!0),this._addBufferBindingDescription(e,t,lo.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let i=0;i<t.length;i++){const n=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][n.binding].name,a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][n.binding].nameInArrayOfTexture;n&&(n.texture||n.externalTexture||n.storageTexture?this._webgpuProcessingContext.textureNames.push(a):n.sampler?this._webgpuProcessingContext.samplerNames.push(s):n.buffer&&this._webgpuProcessingContext.bufferNames.push(s))}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[]}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],n=[];for(let s=0;s<i.length;s++){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[t][s];a.sampler||a.texture||a.storageTexture||a.externalTexture?n.push({binding:a.binding,resource:void 0}):a.buffer&&n.push({binding:a.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=n}}_addTextureBindingDescription(e,t,i,n,s,a){let{groupIndex:o,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]){let c;c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push(null===n?{binding:l,visibility:0,externalTexture:{}}:s?{binding:l,visibility:0,storageTexture:{access:vp.WriteOnly,format:s,viewDimension:n}}:{binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:n,multisampled:!1}}),this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]={name:e,index:c-1,nameInArrayOfTexture:t.isTextureArray?e+i:e}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l].index,this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=a?oo.Vertex:oo.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:n,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s]){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s]={name:e,index:a-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][s].index,this._webgpuProcessingContext.bindGroupLayoutEntries[n][s].visibility|=i?oo.Vertex:oo.Fragment}_addBufferBindingDescription(e,t,i,n){let{groupIndex:s,bindingIndex:a}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a]){const o=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:a,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a]={name:e,index:o-1}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][a].visibility|=n?oo.Vertex:oo.Fragment}_injectStartingAndEndingCode(e,t,i,n){let s=e.indexOf(t);if(s<0)return console.error('No "main" function found in shader code! Processing aborted.'),e;if(i){for(;s++<e.length&&"{"!=e.charAt(s););if(s<e.length){const a=e.substring(0,s+1),o=e.substring(s+1);e=a+i+o}}if(n){const a=e.lastIndexOf("}");e=e.substring(0,a),e+=n+"\n}"}return e}}Oi.AutoSamplerSuffix="Sampler",Oi.LeftOvertUBOName="LeftOver",Oi.InternalsUBOName="Internals",Oi.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16},Oi._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},Oi._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},Oi._GpuTextureViewDimensionByWebGPUTextureType={textureCube:fi.Cube,textureCubeArray:fi.CubeArray,texture2D:fi.E2d,texture2DArray:fi.E2dArray,texture3D:fi.E3d},Oi._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},Oi._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class m6{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,n,s,a,o,l){const c=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";const u=this.shaderProcessingContext.availableTextures;let h;for(h=0;h<s.length;h++){const p=s[h],g=u[s[h]];null==g||null==g?(s.splice(h,1),h--):a[p]=h}for(const p of c.getAttributes(this,o))l.push(p);this.buildUniformLayout();const d=[],f=[];for(h=0;h<o.length;h++){const p=l[h];p>=0&&(d.push(o[h]),f.push(p))}this.shaderProcessingContext.attributeNamesFromEffect=d,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new He(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1");this.uniformBuffer.addUniform(e.name,Oi.UniformSizes[t],e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,n)}setInt4(e,t,i,n,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,n,s)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,n)}setUInt4(e,t,i,n,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,n,s)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,n)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,n,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,n,s)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.vertex}_getFragmentShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.fragment}}const _O={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};let Fh=(()=>{class r{static get KnownUBOs(){return r._SimplifiedKnownBindings?r._SimplifiedKnownUBOs:r._KnownUBOs}constructor(t){this.shaderLanguage=t,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}_findStartingGroupBinding(){const t=r.KnownUBOs,i=[];for(const n in t){const s=t[n].binding;-1!==s.groupIndex&&(i[s.groupIndex]=void 0===i[s.groupIndex]?s.bindingIndex:Math.max(i[s.groupIndex],s.bindingIndex))}this.freeGroupIndex=i.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=i[i.length-1]+1}getAttributeNextLocation(t,i=0){var n;const s=this._attributeNextLocation;return this._attributeNextLocation+=(null!==(n=_O[t])&&void 0!==n?n:1)*(i||1),s}getVaryingNextLocation(t,i=0){var n;const s=this._varyingNextLocation;return this._varyingNextLocation+=(null!==(n=_O[t])&&void 0!==n?n:1)*(i||1),s}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(t){if(this.freeBindingIndex>65536-t&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const i={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,i}}return r._SimplifiedKnownBindings=!0,r._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},r._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}},r})();class v6 extends Oi{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=Ri.GLSL,this.parseGLES3=!0}_getArraySize(e,t,i){let n=0;const s=e.indexOf("["),a=e.indexOf("]");if(s>0&&a>0){const o=e.substring(s+1,a);n=+o,isNaN(n)&&(n=+i[o.trim()]),e=e.substr(0,s)}return[e,t,n]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO\r\nuniform ${Oi.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,n=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),n?e:i+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),n?e:i+e)}varyingProcessor(e,t,i){this._preProcessors=i;const l=(t&&this._fragmentIsGLES3?/\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==l){const c=l[1],u=l[2];let h;t?(h=this._webgpuProcessingContext.availableVaryings[u],this._missingVaryings[h]="",void 0===h&&H.Warn(`Invalid fragment shader: The varying named "${u}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this._webgpuProcessingContext.getVaryingNextLocation(c,this._getArraySize(u,c,i)[2]),this._webgpuProcessingContext.availableVaryings[u]=h,this._missingVaryings[h]=`layout(location = ${h}) in ${c} ${u};`),e=e.replace(l[0],void 0===h?"":`layout(location = ${h}) ${t?"in":"out"} ${c} ${u};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const a=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==a){const o=a[1],l=a[2],c=this._webgpuProcessingContext.getAttributeNextLocation(o,this._getArraySize(l,o,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l,e=e.replace(a[0],`layout(location = ${c}) in ${o} ${l};`)}return e}uniformProcessor(e,t,i){var n;this._preProcessors=i;const a=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==a){let o=a[1],l=a[2];if(0===o.indexOf("sampler")||1===o.indexOf("sampler")){let c=0;[l,o,c]=this._getArraySize(l,o,i);let u=this._webgpuProcessingContext.availableTextures[l];if(!u){u={autoBindSampler:!0,isTextureArray:c>0,isStorageTexture:!1,textures:[],sampleType:Pr.Float};for(let R=0;R<(c||1);++R)u.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const h=null!==(n=Oi._SamplerTypeByWebGLSamplerType[o])&&void 0!==n?n:"sampler",d=!!Oi._IsComparisonSamplerByWebGPUSamplerType[h],f=d?co.Comparison:co.Filtering,p=l+Oi.AutoSamplerSuffix;let g=this._webgpuProcessingContext.availableSamplers[p];g||(g={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:f});const _="u"===o.charAt(0)?"u":"i"===o.charAt(0)?"i":"";_&&(o=o.substr(1)),u.sampleType=d?Pr.Depth:"u"===_?Pr.Uint:"i"===_?Pr.Sint:Pr.Float;const v=g.binding.groupIndex,A=g.binding.bindingIndex,S=Oi._SamplerFunctionByWebGLSamplerType[o],x=Oi._TextureTypeByWebGLSamplerType[o],C=Oi._GpuTextureViewDimensionByWebGPUTextureType[x];if(c>0){const R=[];R.push(`layout(set = ${v}, binding = ${A}) uniform ${_}${h} ${p};`),e="\r\n";for(let D=0;D<c;++D)R.push(`layout(set = ${u.textures[D].groupIndex}, binding = ${u.textures[D].bindingIndex}) uniform ${x} ${l}Texture${D};`),e+=`${D>0?"\r\n":""}#define ${l}${D} ${_}${S}(${l}Texture${D}, ${p})`;e=R.join("\r\n")+e,this._textureArrayProcessing.push(l)}else c=1,e=`layout(set = ${v}, binding = ${A}) uniform ${_}${h} ${p};\n                        layout(set = ${u.textures[0].groupIndex}, binding = ${u.textures[0].bindingIndex}) uniform ${x} ${l}Texture;\n                        #define ${l} ${_}${S}(${l}Texture, ${p})`;this._webgpuProcessingContext.availableTextures[l]=u,this._webgpuProcessingContext.availableSamplers[p]=g,this._addSamplerBindingDescription(p,g,!t);for(let R=0;R<c;++R)this._addTextureBindingDescription(l,u,R,C,null,!t)}else this._addUniformToLeftOverUBO(l,o,i),e=""}return e}uniformBufferProcessor(e,t){const n=/uniform\s+(\w+)/gm.exec(e);if(null!==n){const s=n[1];let a=this._webgpuProcessingContext.availableBuffers[s];if(!a){const o=Fh.KnownUBOs[s];let l;l=o&&-1!==o.binding.groupIndex?o.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),a={binding:l},this._webgpuProcessingContext.availableBuffers[s]=a}this._addBufferBindingDescription(s,a,lo.Uniform,!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,n,s){const a=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const l=e.indexOf("gl_FragCoord")>=0,c="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",u=l?"vec4 glFragCoord_;\n":"";if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const h=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==h&&(e=e.substring(0,h.index)+"layout(location = 0) "+e.substring(h.index))}else e=e.replace(/void\s+?main\s*\(/g,(a?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",u),l&&(e=this._injectStartingAndEndingCode(e,"void main",c))}else if(e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex"),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;if(!i){const l=e.lastIndexOf("}");e=e.substring(0,l),e+="gl_Position.y *= yFactor_;\n",s.isNDCHalfZRange||(e+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;\n"),e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let n=i.exec(e);for(;null!==n;){const s=n[1];let a=+s;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[s.trim()]),e=e.replace(n[0],t+a),n=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const n of this._webgpuProcessingContext.leftOverUniforms)i+=n.length>0?`    ${n.type} ${n.name}[${n.length}];\n`:`    ${n.type} ${n.name};\n`;return i+="};\n\n",i}finalizeShaders(e,t){for(let n=0;n<this._textureArrayProcessing.length;++n){const s=this._textureArrayProcessing[n];e=this._applyTextureArrayProcessing(e,s),t=this._applyTextureArrayProcessing(t,s)}for(let n=0;n<this._missingVaryings.length;++n){const s=this._missingVaryings[n];s&&s.length>0&&(t=s+"\n"+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,{vertexCode:e,fragmentCode:t}}}Z.IncludesShadersStoreWGSL.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;\nattribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;\nattribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;\nuniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4,BonesPerMesh>;\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4,BonesPerMesh>;\n#endif\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{\nlet offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);\nlet m1=textureLoad(smp,vec2<i32>(offset+1,0),0);\nlet m2=textureLoad(smp,vec2<i32>(offset+2,0),0);\nlet m3=textureLoad(smp,vec2<i32>(offset+3,0),0);\nreturn mat4x4<f32>(m0,m1,m2,m3);\n}\n#endif\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;\nuniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;\nuniform bakedVertexAnimationSettings: vec4<f32>;\nvar bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{\nlet offset=i32(index)*4;\nlet frameUV=i32(frame);\nlet m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);\nlet m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);\nlet m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);\nlet m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);\nreturn mat4x4<f32>(m0,m1,m2,m3);\n}\n#endif\n";Z.IncludesShadersStoreWGSL.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;\nlet VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;\nlet VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;\nlet VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;\nlet VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;\nlet VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;\nlet VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;\nlet time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;\nlet frameCorrection: f32=select(1.0,0.0,time<1.0);\nlet numOfFrames: f32=totalFrames-frameCorrection;\nvar VATFrameNum: f32=fract(time)*numOfFrames;\nVATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;\nVATFrameNum=floor(VATFrameNum);\nVATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;\nvar VATInfluence : mat4x4<f32>;\nVATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;\n}\n#endif\n";Z.IncludesShadersStoreWGSL.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fragmentInputs.fClipDistance>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE2\nelse if (fragmentInputs.fClipDistance2>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE3\nelse if (fragmentInputs.fClipDistance3>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE4\nelse if (fragmentInputs.fClipDistance4>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE5\nelse if (fragmentInputs.fClipDistance5>0.0)\n{\ndiscard;\n}\n#endif\n#ifdef CLIPPLANE6\nelse if (fragmentInputs.fClipDistance6>0.0)\n{\ndiscard;\n}\n#endif\n";Z.IncludesShadersStoreWGSL.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n";Z.IncludesShadersStoreWGSL.clipPlaneVertex="#ifdef CLIPPLANE\nvertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nvertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nvertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nvertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nvertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nvertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n";Z.IncludesShadersStoreWGSL.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;\nvarying fClipDistance6: f32;\n#endif\n";Z.IncludesShadersStoreWGSL.instancesDeclaration="#ifdef INSTANCES\nattribute world0 : vec4<f32>;\nattribute world1 : vec4<f32>;\nattribute world2 : vec4<f32>;\nattribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute previousWorld0 : vec4<f32>;\nattribute previousWorld1 : vec4<f32>;\nattribute previousWorld2 : vec4<f32>;\nattribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.instancesVertex="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=previousWorld;\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.meshUboDeclaration="struct Mesh {\nworld : mat4x4<f32>,\nvisibility : f32,\n};\nvar<uniform> mesh : Mesh;\n#define WORLD_UBO\n";Z.IncludesShadersStoreWGSL.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;\npositionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated=positionUpdated+(position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute position{X} : vec3<f32>;\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;\nuniform morphTargetTextureInfo : vec3<f32>;\nvar morphTargets : texture_2d_array<f32>;\nvar morphTargetsSampler : sampler;\nfn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);\nlet x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;\nlet textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);\nreturn textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;\n}\n#endif\n#endif\n";Z.IncludesShadersStoreWGSL.sceneUboDeclaration="struct Scene {\nviewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,\n};\nvar<uniform> scene : Scene;\n";const KO="fragmentOutputs.fragDepth",A6={texture_1d:fi.E1d,texture_2d:fi.E2d,texture_2d_array:fi.E2dArray,texture_3d:fi.E3d,texture_cube:fi.Cube,texture_cube_array:fi.CubeArray,texture_multisampled_2d:fi.E2d,texture_depth_2d:fi.E2d,texture_depth_2d_array:fi.E2dArray,texture_depth_cube:fi.Cube,texture_depth_cube_array:fi.CubeArray,texture_depth_multisampled_2d:fi.E2d,texture_storage_1d:fi.E1d,texture_storage_2d:fi.E2d,texture_storage_2d_array:fi.E2dArray,texture_storage_3d:fi.E3d,texture_external:null};class y6 extends Oi{constructor(){super(...arguments),this.shaderLanguage=Ri.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}_getArraySize(e,t,i){let n=0;const s=t.lastIndexOf(">");if(t.indexOf("array")>=0&&s>0){let a=s;for(;a>0&&" "!==t.charAt(a)&&","!==t.charAt(a);)a--;const o=t.substring(a+1,s);for(n=+o,isNaN(n)&&(n=+i[o.trim()]);a>0&&(" "===t.charAt(a)||","===t.charAt(a));)a--;t=t.substring(t.indexOf("<")+1,a+1)}return[e,t,n]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesWGSL=[],this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){return`struct ${Oi.InternalsUBOName} {\n  yFactor_: f32,\n  textureOutputHeight_: f32,\n};\nvar<uniform> internals : ${Oi.InternalsUBOName};\n`+PE(e)}varyingProcessor(e,t,i){const s=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==s){const a=s[2],o=s[1];let l;t?(l=this._webgpuProcessingContext.availableVaryings[o],void 0===l&&H.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(a,this._getArraySize(o,a,i)[2]),this._webgpuProcessingContext.availableVaryings[o]=l,this._varyingsWGSL.push(`  @location(${l}) ${o} : ${a},`),this._varyingNamesWGSL.push(o)),e=""}return e}attributeProcessor(e,t){const n=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==n){const s=n[2],a=n[1],o=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(a,s,t)[2]);this._webgpuProcessingContext.availableAttributes[a]=o,this._webgpuProcessingContext.orderedAttributes[o]=a,this._attributesWGSL.push(`@location(${o}) ${a} : ${s},`),e=""}return e}uniformProcessor(e,t,i){const n=this.uniformRegexp.exec(e);return null!==n&&(this._addUniformToLeftOverUBO(n[1],n[2],i),e=""),e}textureProcessor(e,t,i){const n=this.textureRegexp.exec(e);if(null!==n){const s=n[1],a=n[2],o=!!n[3],l=n[4],c=l.indexOf("storage")>0,u=n[6],h=c?u.substring(0,u.indexOf(",")).trim():null;let d=o?this._getArraySize(s,a,i)[2]:0,f=this._webgpuProcessingContext.availableTextures[s];if(f)d=f.textures.length;else{f={isTextureArray:d>0,isStorageTexture:c,textures:[],sampleType:Pr.Float},d=d||1;for(let m=0;m<d;++m)f.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=f;const p=l.indexOf("depth")>0,g=A6[l];if(f.sampleType=p?Pr.Depth:"u32"===u?Pr.Uint:"i32"===u?Pr.Sint:Pr.Float,void 0===g)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let m=0;m<d;++m){const{groupIndex:T,bindingIndex:v}=f.textures[m];0===m&&(e=`@group(${T}) @binding(${v}) ${e}`),this._addTextureBindingDescription(s,f,m,g,h,!t)}}return e}postProcessor(e){return e}finalizeShaders(e,t){const i=t.indexOf("fragmentInputs.position")>=0?"\n            if (internals.yFactor_ == 1.) {\n                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;\n            }\n        ":"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const n=this._buildLeftOverUBO();t=n+t,e=(e=n+e).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let s="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesWGSL.length>0&&(s+=this._attributesWGSL.join("\n")),s+="\n};\nvar<private> vertexInputs : VertexInputs;\n";let a="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(a+=this._varyingsWGSL.join("\n")),a+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=this._injectStartingAndEndingCode(e=s+a+e,"fn main","\n  vertexInputs = input;\n","  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;\n  return vertexOutputs;"),t=t.replace(/#define /g,"//#define "),t=(t=this._processStridedUniformArrays(t)).replace(/dpdy/g,"(-internals.yFactor_)*dpdy");let c="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(c+=this._varyingsWGSL.join("\n")),c+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let u="struct FragmentOutputs {\n  @location(0) color : vec4<f32>,\n",h=!1,d=0;for(;!(h||(d=t.indexOf(KO,d),d<0));){const g=d;for(h=!0;d>1&&"\n"!==t.charAt(d);){if("/"===t.charAt(d)&&"/"===t.charAt(d-1)){h=!1;break}d--}d=g+KO.length}return h&&(u+="  @builtin(frag_depth) fragDepth: f32,\n"),u+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n",t=this._injectStartingAndEndingCode(t=c+u+t,"fn main","  fragmentInputs = input;\n  "+i,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",n=`struct ${e} {\n`;for(const s of this._webgpuProcessingContext.leftOverUniforms){const a=s.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=Oi.UniformSizes[a];if(s.length>0)if(o<=2){const l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {\n                        @size(16)\n                        el: ${a},\n                    }`,this._stridedUniformArrays.push(s.name),n+=` @align(16) ${s.name} : array<${l}, ${s.length}>,\n`}else n+=` ${s.name} : array<${s.type}, ${s.length}>,\n`;else n+=`  ${s.name} : ${s.type},\n`}return n+="};\n",n=`${i}\n${n}`,n+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,n}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const n=i.exec(e);if(null===n)break;const s=n[1],a=n[2],o=s.indexOf(Oi.AutoSamplerSuffix)===s.length-Oi.AutoSamplerSuffix.length?s.substring(0,s.indexOf(Oi.AutoSamplerSuffix)):null,l="sampler_comparison"===a?co.Comparison:co.Filtering;if(o){const f=this._webgpuProcessingContext.availableTextures[o];f&&(f.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[s];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[s]=c),this._addSamplerBindingDescription(s,c,t);const u=e.substring(0,n.index),h=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `,d=e.substring(n.index);e=u+h+d,i.lastIndex+=h.length}return e}_processCustomBuffers(e,t){const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const n=i.exec(e);if(null===n)break;const s=n[1],a=n[3];let o=n[4];const l=n[5];let c=this._webgpuProcessingContext.availableBuffers[o];if(!c){const g="uniform"===s?Fh.KnownUBOs[l]:null;let _;g?(o=l,_=g.binding,-1===_.groupIndex&&(_=this._webgpuProcessingContext.getNextFreeUBOBinding())):_=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:_},this._webgpuProcessingContext.availableBuffers[o]=c}this._addBufferBindingDescription(o,this._webgpuProcessingContext.availableBuffers[o],"read_write"===a?lo.Storage:"storage"===s?lo.ReadOnlyStorage:lo.Uniform,t);const u=c.binding.groupIndex,h=c.binding.bindingIndex,d=e.substring(0,n.index),f=`@group(${u}) @binding(${h}) `,p=e.substring(n.index);e=d+f+p,i.lastIndex+=f.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*)\\]`,"g"),`${t}[$1].el`);return e}}class Sp{get underlyingResource(){return this._webgpuTexture}get msaaTexture(){return this._webgpuMSAATexture}set msaaTexture(e){this._webgpuMSAATexture=e}constructor(e=null){this.format=M.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,n,s){this.createView({format:this.format,dimension:i?fi.Cube:fi.E2d,mipLevelCount:(t=e!==vt.RenderTarget&&t)?Se.ILog2(Math.max(n,s))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:ta.All})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t,i;null===(e=this._webgpuTexture)||void 0===e||e.destroy(),null===(t=this._webgpuMSAATexture)||void 0===t||t.destroy(),null===(i=this._copyInvertYTempTexture)||void 0===i||i.destroy(),this.reset()}}var fs=(()=>{return(r=fs||(fs={}))[r.MipMap=0]="MipMap",r[r.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",r[r.Clear=2]="Clear",r[r.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst",fs;var r})(),Pl=(()=>{return(r=Pl||(Pl={}))[r.DontInvertY=0]="DontInvertY",r[r.InvertY=1]="InvertY",Pl;var r})();const ZO=[{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(location = 0) out vec2 vTex;\n\n    void main() {\n        vTex = tex[gl_VertexIndex];\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\n    layout(set = 0, binding = 1) uniform texture2D img;\n\n    layout(location = 0) in vec2 vTex;\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = texture(sampler2D(img, imgSampler), vTex);\n    }\n    "},{vertex:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "},{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n\n    void main() {\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform Uniforms {\n        uniform vec4 color;\n    };\n\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = color;\n    }\n    "},{vertex:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n    layout(set = 0, binding = 1) uniform Params {\n        float ofstX;\n        float ofstY;\n        float width;\n        float height;\n    };\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\n            discard;\n        }\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\n            discard;\n        }\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "}],Nh={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38};class Ai{static ComputeNumMipmapLevels(e,t){return Se.ILog2(Math.max(e,t))+1}constructor(e,t,i,n){this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=n,this._mipmapSampler=e.createSampler({minFilter:Ft.Linear}),this._videoSampler=e.createSampler({minFilter:Ft.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,_i.Uniform|_i.CopyDst).underlyingResource,this._getPipeline(M.RGBA8Unorm),this._getVideoPipeline(M.RGBA8Unorm)}_getPipeline(e,t=fs.MipMap,i){const n=t===fs.MipMap?1:t===fs.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===fs.Clear?8:t===fs.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][n];if(!s){let a="#version 450\r\n";(t===fs.InvertYPremultiplyAlpha||t===fs.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(a+="#define INVERTY\r\n"),i.premultiplyAlpha&&(a+="#define PREMULTIPLYALPHA\r\n"));let o=this._compiledShaders[n];if(!o){let c=this._glslang.compileGLSL(a+ZO[t].vertex,"vertex"),u=this._glslang.compileGLSL(a+ZO[t].fragment,"fragment");this._tintWASM&&(c=this._tintWASM.convertSpirV2WGSL(c),u=this._tintWASM.convertSpirV2WGSL(u));const h=this._device.createShaderModule({code:c}),d=this._device.createShaderModule({code:u});o=this._compiledShaders[n]=[h,d]}const l=this._device.createRenderPipeline({layout:Jc.Auto,vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:wr.TriangleStrip,stripIndexFormat:ho.Uint16}});s=this._pipelines[e][n]=[l,l.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=Pl.DontInvertY){const i=t===Pl.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let n=this._videoPipelines[e][i];if(!n){let s=this._videoCompiledShaders[i];if(!s){const o=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n  \n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    "}),l=this._device.createShaderModule({code:0===i?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    "});s=this._videoCompiledShaders[i]=[o,l]}const a=this._device.createRenderPipeline({label:`CopyVideoToTexture_${e}_${0===i?"DontInvertY":"InvertY"}`,layout:Jc.Auto,vertex:{module:s[0],entryPoint:"main"},fragment:{module:s[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:wr.TriangleStrip,stripIndexFormat:ho.Uint16}});n=this._videoPipelines[e][i]=[a,a.getBindGroupLayout(0)]}return n}static _GetTextureTypeFromFormat(e){switch(e){case M.R8Unorm:case M.R8Snorm:case M.R8Uint:case M.R8Sint:case M.RG8Unorm:case M.RG8Snorm:case M.RG8Uint:case M.RG8Sint:case M.RGBA8Unorm:case M.RGBA8UnormSRGB:case M.RGBA8Snorm:case M.RGBA8Uint:case M.RGBA8Sint:case M.BGRA8Unorm:case M.BGRA8UnormSRGB:case M.RGB10A2Unorm:case M.RGB9E5UFloat:case M.RG11B10UFloat:case M.Depth24UnormStencil8:case M.Depth32FloatStencil8:case M.BC7RGBAUnorm:case M.BC7RGBAUnormSRGB:case M.BC6HRGBUFloat:case M.BC6HRGBFloat:case M.BC5RGUnorm:case M.BC5RGSnorm:case M.BC3RGBAUnorm:case M.BC3RGBAUnormSRGB:case M.BC2RGBAUnorm:case M.BC2RGBAUnormSRGB:case M.BC4RUnorm:case M.BC4RSnorm:case M.BC1RGBAUnorm:case M.BC1RGBAUnormSRGB:case M.ETC2RGB8Unorm:case M.ETC2RGB8UnormSRGB:case M.ETC2RGB8A1Unorm:case M.ETC2RGB8A1UnormSRGB:case M.ETC2RGBA8Unorm:case M.ETC2RGBA8UnormSRGB:case M.EACR11Unorm:case M.EACR11Snorm:case M.EACRG11Unorm:case M.EACRG11Snorm:case M.ASTC4x4Unorm:case M.ASTC4x4UnormSRGB:case M.ASTC5x4Unorm:case M.ASTC5x4UnormSRGB:case M.ASTC5x5Unorm:case M.ASTC5x5UnormSRGB:case M.ASTC6x5Unorm:case M.ASTC6x5UnormSRGB:case M.ASTC6x6Unorm:case M.ASTC6x6UnormSRGB:case M.ASTC8x5Unorm:case M.ASTC8x5UnormSRGB:case M.ASTC8x6Unorm:case M.ASTC8x6UnormSRGB:case M.ASTC8x8Unorm:case M.ASTC8x8UnormSRGB:case M.ASTC10x5Unorm:case M.ASTC10x5UnormSRGB:case M.ASTC10x6Unorm:case M.ASTC10x6UnormSRGB:case M.ASTC10x8Unorm:case M.ASTC10x8UnormSRGB:case M.ASTC10x10Unorm:case M.ASTC10x10UnormSRGB:case M.ASTC12x10Unorm:case M.ASTC12x10UnormSRGB:case M.ASTC12x12Unorm:case M.ASTC12x12UnormSRGB:return 0;case M.R16Uint:case M.R16Sint:case M.RG16Uint:case M.RG16Sint:case M.RGBA16Uint:case M.RGBA16Sint:case M.Depth16Unorm:return 5;case M.R16Float:case M.RG16Float:case M.RGBA16Float:return 2;case M.R32Uint:case M.R32Sint:case M.RG32Uint:case M.RG32Sint:case M.RGBA32Uint:case M.RGBA32Sint:return 7;case M.R32Float:case M.RG32Float:case M.RGBA32Float:case M.Depth32Float:return 1;case M.Stencil8:throw"No fixed size for Stencil8 format!";case M.Depth24Plus:throw"No fixed size for Depth24Plus format!";case M.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0}static _GetBlockInformationFromFormat(e){switch(e){case M.R8Unorm:case M.R8Snorm:case M.R8Uint:case M.R8Sint:return{width:1,height:1,length:1};case M.R16Uint:case M.R16Sint:case M.R16Float:case M.RG8Unorm:case M.RG8Snorm:case M.RG8Uint:case M.RG8Sint:return{width:1,height:1,length:2};case M.R32Uint:case M.R32Sint:case M.R32Float:case M.RG16Uint:case M.RG16Sint:case M.RG16Float:case M.RGBA8Unorm:case M.RGBA8UnormSRGB:case M.RGBA8Snorm:case M.RGBA8Uint:case M.RGBA8Sint:case M.BGRA8Unorm:case M.BGRA8UnormSRGB:case M.RGB9E5UFloat:case M.RGB10A2Unorm:case M.RG11B10UFloat:return{width:1,height:1,length:4};case M.RG32Uint:case M.RG32Sint:case M.RG32Float:case M.RGBA16Uint:case M.RGBA16Sint:case M.RGBA16Float:return{width:1,height:1,length:8};case M.RGBA32Uint:case M.RGBA32Sint:case M.RGBA32Float:return{width:1,height:1,length:16};case M.Stencil8:throw"No fixed size for Stencil8 format!";case M.Depth16Unorm:return{width:1,height:1,length:2};case M.Depth24Plus:throw"No fixed size for Depth24Plus format!";case M.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case M.Depth32Float:case M.Depth24UnormStencil8:return{width:1,height:1,length:4};case M.Depth32FloatStencil8:return{width:1,height:1,length:5};case M.BC7RGBAUnorm:case M.BC7RGBAUnormSRGB:case M.BC6HRGBUFloat:case M.BC6HRGBFloat:case M.BC5RGUnorm:case M.BC5RGSnorm:case M.BC3RGBAUnorm:case M.BC3RGBAUnormSRGB:case M.BC2RGBAUnorm:case M.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case M.BC4RUnorm:case M.BC4RSnorm:case M.BC1RGBAUnorm:case M.BC1RGBAUnormSRGB:case M.ETC2RGB8Unorm:case M.ETC2RGB8UnormSRGB:case M.ETC2RGB8A1Unorm:case M.ETC2RGB8A1UnormSRGB:case M.EACR11Unorm:case M.EACR11Snorm:return{width:4,height:4,length:8};case M.ETC2RGBA8Unorm:case M.ETC2RGBA8UnormSRGB:case M.EACRG11Unorm:case M.EACRG11Snorm:case M.ASTC4x4Unorm:case M.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case M.ASTC5x4Unorm:case M.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case M.ASTC5x5Unorm:case M.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case M.ASTC6x5Unorm:case M.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case M.ASTC6x6Unorm:case M.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case M.ASTC8x5Unorm:case M.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case M.ASTC8x6Unorm:case M.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case M.ASTC8x8Unorm:case M.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case M.ASTC10x5Unorm:case M.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case M.ASTC10x6Unorm:case M.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case M.ASTC10x8Unorm:case M.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case M.ASTC10x10Unorm:case M.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case M.ASTC12x10Unorm:case M.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case M.ASTC12x12Unorm:case M.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static _IsHardwareTexture(e){return!!e.release}static _IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}setCommandEncoder(e){this._commandEncoderForCreation=e}static IsCompressedFormat(e){switch(e){case M.BC7RGBAUnormSRGB:case M.BC7RGBAUnorm:case M.BC6HRGBFloat:case M.BC6HRGBUFloat:case M.BC5RGSnorm:case M.BC5RGUnorm:case M.BC4RSnorm:case M.BC4RUnorm:case M.BC3RGBAUnormSRGB:case M.BC3RGBAUnorm:case M.BC2RGBAUnormSRGB:case M.BC2RGBAUnorm:case M.BC1RGBAUnormSRGB:case M.BC1RGBAUnorm:case M.ETC2RGB8Unorm:case M.ETC2RGB8UnormSRGB:case M.ETC2RGB8A1Unorm:case M.ETC2RGB8A1UnormSRGB:case M.ETC2RGBA8Unorm:case M.ETC2RGBA8UnormSRGB:case M.EACR11Unorm:case M.EACR11Snorm:case M.EACRG11Unorm:case M.EACRG11Snorm:case M.ASTC4x4Unorm:case M.ASTC4x4UnormSRGB:case M.ASTC5x4Unorm:case M.ASTC5x4UnormSRGB:case M.ASTC5x5Unorm:case M.ASTC5x5UnormSRGB:case M.ASTC6x5Unorm:case M.ASTC6x5UnormSRGB:case M.ASTC6x6Unorm:case M.ASTC6x6UnormSRGB:case M.ASTC8x5Unorm:case M.ASTC8x5UnormSRGB:case M.ASTC8x6Unorm:case M.ASTC8x6UnormSRGB:case M.ASTC8x8Unorm:case M.ASTC8x8UnormSRGB:case M.ASTC10x5Unorm:case M.ASTC10x5UnormSRGB:case M.ASTC10x6Unorm:case M.ASTC10x6UnormSRGB:case M.ASTC10x8Unorm:case M.ASTC10x8UnormSRGB:case M.ASTC10x10Unorm:case M.ASTC10x10UnormSRGB:case M.ASTC12x10Unorm:case M.ASTC12x10UnormSRGB:case M.ASTC12x12Unorm:case M.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return M.Depth16Unorm;case 16:return M.Depth24Plus;case 13:return M.Depth24PlusStencil8;case 14:return M.Depth32Float;case 17:return M.Depth24UnormStencil8;case 18:return M.Depth32FloatStencil8;case 19:return M.Stencil8;case 36492:return i?M.BC7RGBAUnormSRGB:M.BC7RGBAUnorm;case 36495:return M.BC6HRGBUFloat;case 36494:return M.BC6HRGBFloat;case 33779:return i?M.BC3RGBAUnormSRGB:M.BC3RGBAUnorm;case 33778:return i?M.BC2RGBAUnormSRGB:M.BC2RGBAUnorm;case 33777:case 33776:return i?M.BC1RGBAUnormSRGB:M.BC1RGBAUnorm;case 37808:return i?M.ASTC4x4UnormSRGB:M.ASTC4x4Unorm;case 36196:case 37492:return i?M.ETC2RGB8UnormSRGB:M.ETC2RGB8Unorm;case 37496:return i?M.ETC2RGBA8UnormSRGB:M.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return M.R8Snorm;case 7:return M.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return M.R8Sint;case 9:return M.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return M.RGBA8Sint;default:return M.RGBA8Snorm}case 0:switch(t){case 6:return M.R8Unorm;case 7:return M.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?M.RGBA8UnormSRGB:M.RGBA8Unorm;case 12:return i?M.BGRA8UnormSRGB:M.BGRA8Unorm;case 8:return M.R8Uint;case 9:return M.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return M.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return M.RGBA8Unorm}case 4:switch(t){case 8:return M.R16Sint;case 9:return M.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return M.RGBA16Sint}case 5:switch(t){case 8:return M.R16Uint;case 9:return M.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return M.RGBA16Uint}case 6:switch(t){case 8:return M.R32Sint;case 9:return M.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return M.RGBA32Sint}case 7:switch(t){case 8:return M.R32Uint;case 9:return M.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return M.RGBA32Uint}case 1:switch(t){case 6:return M.R32Float;case 7:return M.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return M.RGBA32Float}case 2:switch(t){case 6:return M.R16Float;case 7:return M.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return M.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return M.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV"}}return i?M.RGBA8UnormSRGB:M.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case M.R8Unorm:case M.R8Snorm:case M.R8Uint:case M.R8Sint:case M.BC4RUnorm:case M.BC4RSnorm:case M.R16Uint:case M.R16Sint:case M.Depth16Unorm:case M.R16Float:case M.R32Uint:case M.R32Sint:case M.R32Float:case M.Depth32Float:case M.Stencil8:case M.Depth24Plus:case M.EACR11Unorm:case M.EACR11Snorm:return 1;case M.RG8Unorm:case M.RG8Snorm:case M.RG8Uint:case M.RG8Sint:case M.Depth24UnormStencil8:case M.Depth32FloatStencil8:case M.BC5RGUnorm:case M.BC5RGSnorm:case M.RG16Uint:case M.RG16Sint:case M.RG16Float:case M.RG32Uint:case M.RG32Sint:case M.RG32Float:case M.Depth24PlusStencil8:case M.EACRG11Unorm:case M.EACRG11Snorm:return 2;case M.RGB9E5UFloat:case M.RG11B10UFloat:case M.BC6HRGBUFloat:case M.BC6HRGBFloat:case M.ETC2RGB8Unorm:case M.ETC2RGB8UnormSRGB:return 3;case M.RGBA8Unorm:case M.RGBA8UnormSRGB:case M.RGBA8Snorm:case M.RGBA8Uint:case M.RGBA8Sint:case M.BGRA8Unorm:case M.BGRA8UnormSRGB:case M.RGB10A2Unorm:case M.BC7RGBAUnorm:case M.BC7RGBAUnormSRGB:case M.BC3RGBAUnorm:case M.BC3RGBAUnormSRGB:case M.BC2RGBAUnorm:case M.BC2RGBAUnormSRGB:case M.BC1RGBAUnorm:case M.BC1RGBAUnormSRGB:case M.RGBA16Uint:case M.RGBA16Sint:case M.RGBA16Float:case M.RGBA32Uint:case M.RGBA32Sint:case M.RGBA32Float:case M.ETC2RGB8A1Unorm:case M.ETC2RGB8A1UnormSRGB:case M.ETC2RGBA8Unorm:case M.ETC2RGBA8UnormSRGB:case M.ASTC4x4Unorm:case M.ASTC4x4UnormSRGB:case M.ASTC5x4Unorm:case M.ASTC5x4UnormSRGB:case M.ASTC5x5Unorm:case M.ASTC5x5UnormSRGB:case M.ASTC6x5Unorm:case M.ASTC6x5UnormSRGB:case M.ASTC6x6Unorm:case M.ASTC6x6UnormSRGB:case M.ASTC8x5Unorm:case M.ASTC8x5UnormSRGB:case M.ASTC8x6Unorm:case M.ASTC8x6UnormSRGB:case M.ASTC8x8Unorm:case M.ASTC8x8UnormSRGB:case M.ASTC10x5Unorm:case M.ASTC10x5UnormSRGB:case M.ASTC10x6Unorm:case M.ASTC10x6UnormSRGB:case M.ASTC10x8Unorm:case M.ASTC10x8UnormSRGB:case M.ASTC10x10Unorm:case M.ASTC10x10UnormSRGB:case M.ASTC12x10Unorm:case M.ASTC12x10UnormSRGB:case M.ASTC12x12Unorm:case M.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case M.Stencil8:case M.Depth24UnormStencil8:case M.Depth32FloatStencil8:case M.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case M.Depth24UnormStencil8:case M.Depth32FloatStencil8:case M.Depth24PlusStencil8:return!0}return!1}static GetDepthFormatOnly(e){switch(e){case M.Depth16Unorm:return M.Depth16Unorm;case M.Depth24Plus:case M.Depth24PlusStencil8:case M.Depth24UnormStencil8:return M.Depth24Plus;case M.Depth32Float:case M.Depth32FloatStencil8:return M.Depth32Float}return e}copyVideoToTexture(e,t,i,n=!1,s){var a,o,l,c;const u=void 0===s,[h,d]=this._getVideoPipeline(i,n?Pl.InvertY:Pl.DontInvertY);u&&(s=this._device.createCommandEncoder({})),null===(o=(a=s).pushDebugGroup)||void 0===o||o.call(a,`copy video to texture - invertY=${n}`);const p={colorAttachments:[{view:t._hardwareTexture.underlyingResource.createView({format:i,dimension:fi.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:ta.All}),loadOp:an.Load,storeOp:$r.Store}]},g=s.beginRenderPass(p),_={layout:d,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},m=this._device.createBindGroup(_);g.setPipeline(h),g.setBindGroup(0,m),g.draw(4,1,0,0),g.end(),null===(c=(l=s).popDebugGroup)||void 0===c||c.call(l),u&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,i,n,s=!1,a=!1,o=0,l=0,c=1,u=0,h=0,d=0,f=0,p,g){var _,m,T,v,A,S;const x=0!==d,C=void 0===p,[R,D]=this._getPipeline(n,x?fs.InvertYPremultiplyAlphaWithOfst:fs.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:a});let P;if(o=Math.max(o,0),C&&(p=this._device.createCommandEncoder({})),null===(m=(_=p).pushDebugGroup)||void 0===m||m.call(_,`internal process texture - invertY=${s} premultiplyAlpha=${a}`),Ai._IsHardwareTexture(e)?(P=e.underlyingResource,s&&!a&&1===c&&0===o||(e=void 0)):(P=e,e=void 0),!P)return;x&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([u,h,d,f]),0,16);const N=e,k=null!==(T=null==N?void 0:N._copyInvertYTempTexture)&&void 0!==T?T:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,n,1,p,yi.CopySrc|yi.RenderAttachment|yi.TextureBinding,void 0,"TempTextureForCopyWithInvertY"),X=null!==(v=null==N?void 0:N._copyInvertYRenderPassDescr)&&void 0!==v?v:{colorAttachments:[{view:k.createView({format:n,dimension:fi.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:an.Load,storeOp:$r.Store}]},ne=p.beginRenderPass(X);let ge=x?null==N?void 0:N._copyInvertYBindGroupWithOfst:null==N?void 0:N._copyInvertYBindGroup;if(!ge){const ue={layout:D,entries:[{binding:0,resource:P.createView({format:n,dimension:fi.E2d,baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:o})}]};x&&ue.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),ge=this._device.createBindGroup(ue)}ne.setPipeline(R),ne.setBindGroup(0,ge),ne.draw(4,1,0,0),ne.end(),p.copyTextureToTexture({texture:k},{texture:P,mipLevel:l,origin:{x:0,y:0,z:o}},{width:t,height:i,depthOrArrayLayers:1}),N?(N._copyInvertYTempTexture=k,N._copyInvertYRenderPassDescr=X,x?N._copyInvertYBindGroupWithOfst=ge:N._copyInvertYBindGroup=ge):this._deferredReleaseTextures.push([k,null]),null===(S=(A=p).popDebugGroup)||void 0===S||S.call(A),C&&(this._device.queue.submit([p.finish()]),p=null)}copyWithInvertY(e,t,i,n){var s,a,o,l;const c=void 0===n,[u,h]=this._getPipeline(t,fs.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});c&&(n=this._device.createCommandEncoder({})),null===(a=(s=n).pushDebugGroup)||void 0===a||a.call(s,"internal copy texture with invertY");const d=n.beginRenderPass(i),f=this._device.createBindGroup({layout:h,entries:[{binding:0,resource:e}]});d.setPipeline(u),d.setBindGroup(0,f),d.draw(4,1,0,0),d.end(),null===(l=(o=n).popDebugGroup)||void 0===l||l.call(o),c&&(this._device.queue.submit([n.finish()]),n=null)}createTexture(e,t=!1,i=!1,n=!1,s=!1,a=!1,o=M.RGBA8Unorm,l=1,c,u=-1,h=0,d){l>1&&(l=4);const f=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:f},g=Ai.IsCompressedFormat(o),_=t?Ai.ComputeNumMipmapLevels(e.width,e.height):1;h|=t&&!g?yi.CopySrc|yi.RenderAttachment:0,!g&&!a&&(h|=yi.RenderAttachment|yi.CopyDst);const T=this._device.createTexture({label:`Texture_${d?d+"_":""}${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${l}`,size:p,dimension:a?ds.E3d:ds.E2d,format:o,usage:(u>=0?u:yi.CopySrc|yi.CopyDst|yi.TextureBinding)|h,sampleCount:l,mipLevelCount:_});return Ai.IsImageBitmap(e)&&(this.updateTexture(e,T,e.width,e.height,f,o,0,0,n,s,0,0),t&&i&&this.generateMipmaps(T,o,_,0,c)),T}createCubeTexture(e,t=!1,i=!1,n=!1,s=!1,a=M.RGBA8Unorm,o=1,l,c=-1,u=0,h){o>1&&(o=4);const d=Ai.IsImageBitmapArray(e)?e[0].width:e.width,f=Ai.IsImageBitmapArray(e)?e[0].height:e.height,p=Ai.IsCompressedFormat(a),g=t?Ai.ComputeNumMipmapLevels(d,f):1;u|=t&&!p?yi.CopySrc|yi.RenderAttachment:0,p||(u|=yi.RenderAttachment|yi.CopyDst);const m=this._device.createTexture({label:`TextureCube_${h?h+"_":""}${d}x${f}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:d,height:f,depthOrArrayLayers:6},dimension:ds.E2d,format:a,usage:(c>=0?c:yi.CopySrc|yi.CopyDst|yi.TextureBinding)|u,sampleCount:o,mipLevelCount:g});return Ai.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,m,d,f,a,n,s,0,0),t&&i&&this.generateCubeMipmaps(m,a,g,l)),m}generateCubeMipmaps(e,t,i,n){var s,a,o,l;const c=void 0===n;c&&(n=this._device.createCommandEncoder({})),null===(a=(s=n).pushDebugGroup)||void 0===a||a.call(s,`create cube mipmaps - ${i} levels`);for(let u=0;u<6;++u)this.generateMipmaps(e,t,i,u,n);null===(l=(o=n).popDebugGroup)||void 0===l||l.call(o),c&&(this._device.queue.submit([n.finish()]),n=null)}generateMipmaps(e,t,i,n=0,s){var a,o,l,c,u,h,d,f;const p=void 0===s,[g,_]=this._getPipeline(t);let m;if(n=Math.max(n,0),p&&(s=this._device.createCommandEncoder({})),null===(o=(a=s).pushDebugGroup)||void 0===o||o.call(a,`create mipmaps for face #${n} - ${i} levels`),Ai._IsHardwareTexture(e)?(m=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(m=e,e=void 0),!m)return;const T=e;for(let v=1;v<i;++v){const A=null!==(c=null===(l=null==T?void 0:T._mipmapGenRenderPassDescr[n])||void 0===l?void 0:l[v-1])&&void 0!==c?c:{colorAttachments:[{view:m.createView({format:t,dimension:fi.E2d,baseMipLevel:v,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n}),loadOp:an.Load,storeOp:$r.Store}]};T&&(T._mipmapGenRenderPassDescr[n]=T._mipmapGenRenderPassDescr[n]||[],T._mipmapGenRenderPassDescr[n][v-1]=A);const S=s.beginRenderPass(A),x=null!==(h=null===(u=null==T?void 0:T._mipmapGenBindGroup[n])||void 0===u?void 0:u[v-1])&&void 0!==h?h:this._device.createBindGroup({layout:_,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:m.createView({format:t,dimension:fi.E2d,baseMipLevel:v-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:n})}]});T&&(T._mipmapGenBindGroup[n]=T._mipmapGenBindGroup[n]||[],T._mipmapGenBindGroup[n][v-1]=x),S.setPipeline(g),S.setBindGroup(0,x),S.draw(4,1,0,0),S.end()}null===(f=(d=s).popDebugGroup)||void 0===f||f.call(d),p&&(this._device.queue.submit([s.finish()]),s=null)}createGPUTextureForInternalTexture(e,t,i,n,s){e._hardwareTexture||(e._hardwareTexture=new Sp),void 0===t&&(t=e.width),void 0===i&&(i=e.height),void 0===n&&(n=e.depth);const a=e._hardwareTexture,o=0!=(1&(null!=s?s:0));a.format=Ai.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),a.textureUsages=e._source===vt.RenderTarget||e.source===vt.MultiRenderTarget?yi.TextureBinding|yi.CopySrc|yi.RenderAttachment:e._source===vt.DepthStencil?yi.TextureBinding|yi.RenderAttachment:-1,a.textureAdditionalUsages=o?yi.StorageBinding:0;const c=n||1;let u;if(u=null!==e._maxLodLevel?e._maxLodLevel:e.generateMipMaps?Ai.ComputeNumMipmapLevels(t,i):1,e.isCube){const h=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,a.format,1,this._commandEncoderForCreation,a.textureUsages,a.textureAdditionalUsages,e.label);a.set(h),a.createView({format:Ai.GetDepthFormatOnly(a.format),dimension:fi.Cube,mipLevelCount:u,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:Ai.HasDepthAndStencilAspects(a.format)?ta.DepthOnly:ta.All},o)}else{const h=this.createTexture({width:t,height:i,layers:c},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,a.format,1,this._commandEncoderForCreation,a.textureUsages,a.textureAdditionalUsages,e.label);a.set(h),a.createView({format:Ai.GetDepthFormatOnly(a.format),dimension:e.is2DArray?fi.E2dArray:e.is3D?ds.E3d:fi.E2d,mipLevelCount:u,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:c,aspect:Ai.HasDepthAndStencilAspects(a.format)?ta.DepthOnly:ta.All},o)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=n,this.createMSAATexture(e,e.samples),a}createMSAATexture(e,t){const i=e._hardwareTexture;if((null==i?void 0:i.msaaTexture)&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!i||(null!=t?t:1)<=1)return;const n=e.width,s=e.height,a=e.depth||1;if(e.isCube){const o=this.createCubeTexture({width:n,height:s},!1,!1,e.invertY,!1,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages,e.label?"MSAA"+e.label:void 0);i.msaaTexture=o}else{const o=this.createTexture({width:n,height:s,layers:a},!1,!1,e.invertY,!1,e.is3D,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages,e.label?"MSAA"+e.label:void 0);i.msaaTexture=o}}updateCubeTextures(e,t,i,n,s,a=!1,o=!1,l=0,c=0){const u=[0,3,1,4,2,5];for(let h=0;h<u.length;++h)this.updateTexture(e[u[h]],t,i,n,1,s,h,0,a,o,l,c)}updateTexture(e,t,i,n,s,a,o=0,l=0,c=!1,u=!1,h=0,d=0,f){const p=Ai._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,g=Ai._GetBlockInformationFromFormat(a),_=Ai._IsInternalTexture(t)?t._hardwareTexture:t,m={texture:p,origin:{x:h,y:d,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:u},T={width:Math.ceil(i/g.width)*g.width,height:Math.ceil(n/g.height)*g.height,depthOrArrayLayers:s||1};if(void 0!==e.byteLength){const v=Math.ceil(i/g.width)*g.length;if(256*Math.ceil(v/256)===v){const S=this._device.createCommandEncoder({}),x=this._bufferManager.createRawBuffer(e.byteLength,_i.MapWrite|_i.CopySrc,!0),C=x.getMappedRange();new Uint8Array(C).set(e),x.unmap(),S.copyBufferToTexture({buffer:x,offset:0,bytesPerRow:v,rowsPerImage:n},m,T),this._device.queue.submit([S.finish()]),this._bufferManager.releaseBuffer(x)}else this._device.queue.writeTexture(m,e,{offset:0,bytesPerRow:v,rowsPerImage:n},T);if(c||u){if(!Ai._IsInternalTexture(t))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const S=0===h&&0===d&&i===t.width&&n===t.height;this.invertYPreMultiplyAlpha(_,t.width,t.height,a,c,u,o,l,s||1,h,d,S?0:i,S?0:n,void 0,f)}}}else if(c)if(m.premultipliedAlpha=!1,Ai._IsInternalTexture(t)&&0===h&&0===d&&i===t.width&&n===t.height)this._device.queue.copyExternalImageToTexture({source:e},m,T),this.invertYPreMultiplyAlpha(_,i,n,a,c,u,o,l,s||1,0,0,0,0,void 0,f);else{const v=this._device.createCommandEncoder({}),A=this.createTexture({width:i,height:n,layers:1},!1,!1,!1,!1,!1,a,1,v,yi.CopySrc|yi.TextureBinding,void 0,"TempTextureForUpdateTexture");this._deferredReleaseTextures.push([A,null]),T.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:A},T),T.depthOrArrayLayers=s||1,this.invertYPreMultiplyAlpha(A,i,n,a,c,u,o,l,s||1,0,0,0,0,v,f),v.copyTextureToTexture({texture:A},m,T),this._device.queue.submit([v.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},m,T)}readPixels(e,t,i,n,s,a,o=0,l=0,c=null,u=!1){const h=Ai._GetBlockInformationFromFormat(a),d=Math.ceil(n/h.width)*h.length,f=256*Math.ceil(d/256),p=f*s,g=this._bufferManager.createRawBuffer(p,_i.MapRead|_i.CopyDst),_=this._device.createCommandEncoder({});return _.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:g,offset:0,bytesPerRow:f},{width:n,height:s,depthOrArrayLayers:1}),this._device.queue.submit([_.finish()]),this._bufferManager.readDataFromBuffer(g,p,n,s,d,f,Ai._GetTextureTypeFromFormat(a),0,c,!0,u)}releaseTexture(e){Ai._IsInternalTexture(e)?this._deferredReleaseTextures.push([e._hardwareTexture,e._irradianceTexture]):this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(Ai._IsHardwareTexture(t)?t.release():t.destroy()),null==i||i.dispose()}this._deferredReleaseTextures.length=0}}class OE{static _IsGPUBuffer(e){return void 0===e.underlyingResource}constructor(e){this._deferredReleaseBuffers=[],this._device=e}createRawBuffer(e,t,i=!1){return this._device.createBuffer({mappedAtCreation:i,size:void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,usage:t})}createBuffer(e,t){const i=void 0!==e.byteLength,n=this.createRawBuffer(e,t),s=new UW(n);return s.references=1,s.capacity=i?e.byteLength:e,i&&this.setSubData(s,0,e),s}setRawData(e,t,i,n,s){this._device.queue.writeBuffer(e,t,i.buffer,n,s)}setSubData(e,t,i,n=0,s=0){const a=e.underlyingResource;s=s||i.byteLength,s=Math.min(s,e.capacity-t);let o=i.byteOffset+n,l=o+s;const c=s+3&-4;if(c!==s){const d=new Uint8Array(i.buffer.slice(o,l));(i=new Uint8Array(c)).set(d),n=0,o=0,l=c,s=c}const u=15728640;let h=0;for(;l-(o+h)>u;)this._device.queue.writeBuffer(a,t+h,i.buffer,o+h,u),h+=u;this._device.queue.writeBuffer(a,t+h,i.buffer,o+h,s-h)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const n=new Uint16Array(t);for(;e--;)i[e]=Ia(n[e]);return i}readDataFromBuffer(e,t,i,n,s,a,o=0,l=0,c=null,u=!0,h=!1){const d=1===o?2:2===o?1:0;return new Promise((f,p)=>{e.mapAsync(Xo.Read,l,t).then(()=>{const g=e.getMappedRange(l,t);let _=c;if(h)_=null===_?dT(o,t,!0,g):dT(o,_.buffer,void 0,g);else if(null===_)switch(d){case 0:_=new Uint8Array(t),_.set(new Uint8Array(g));break;case 1:_=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,g);break;case 2:_=new Float32Array(t/4),_.set(new Float32Array(g))}else switch(d){case 0:_=new Uint8Array(_.buffer),_.set(new Uint8Array(g));break;case 1:_=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,g,c);break;case 2:_=new Float32Array(_.buffer),_.set(new Float32Array(g))}if(s!==a){1===d&&!h&&(s*=2,a*=2);const m=new Uint8Array(_.buffer);let T=s,v=0;for(let A=1;A<n;++A){v=A*a;for(let S=0;S<s;++S)m[T++]=m[v++]}_=0===d||h?new Uint8Array(m.buffer,0,T):new Float32Array(m.buffer,0,T/4)}e.unmap(),u&&this.releaseBuffer(e),f(_)},g=>p(g))})}releaseBuffer(e){return OE._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}class qO{constructor(){this.colorAttachmentGPUTextures=[],this.reset()}reset(e=!1){this.renderPass=null,e&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)}}const N6=[0,0,3,7,0,2,6,2,4,1,5,3,1],L6=[0,64,32,96,16,80,48,112,8],B6=[0,128,128,0,0,0,0,128,0,0,0,0,128];class wl{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){var t,i,n;return N6[e.samplingMode]+L6[(e._comparisonFunction||514)-512+1]+B6[e.samplingMode]+((null!==(t=e._cachedWrapU)&&void 0!==t?t:1)<<8)+((null!==(i=e._cachedWrapV)&&void 0!==i?i:1)<<10)+((null!==(n=e._cachedWrapR)&&void 0!==n?n:1)<<12)+((e.useMipMaps?1:0)<<14)+((e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1)<<15)}static _GetSamplerFilterDescriptor(e,t){let i,n,s,a,o;const l=e.useMipMaps;switch(e.samplingMode){case 11:i=Ft.Linear,n=Ft.Linear,s=Ft.Nearest,l||(a=o=0);break;case 3:case 3:i=Ft.Linear,n=Ft.Linear,l?s=Ft.Linear:(s=Ft.Nearest,a=o=0);break;case 8:i=Ft.Nearest,n=Ft.Nearest,l?s=Ft.Linear:(s=Ft.Nearest,a=o=0);break;case 4:i=Ft.Nearest,n=Ft.Nearest,s=Ft.Nearest,l||(a=o=0);break;case 5:i=Ft.Nearest,n=Ft.Linear,s=Ft.Nearest,l||(a=o=0);break;case 6:i=Ft.Nearest,n=Ft.Linear,l?s=Ft.Linear:(s=Ft.Nearest,a=o=0);break;case 7:i=Ft.Nearest,n=Ft.Linear,s=Ft.Nearest,a=o=0;break;case 1:case 1:default:i=Ft.Nearest,n=Ft.Nearest,s=Ft.Nearest,a=o=0;break;case 9:i=Ft.Linear,n=Ft.Nearest,s=Ft.Nearest,l||(a=o=0);break;case 10:i=Ft.Linear,n=Ft.Nearest,l?s=Ft.Linear:(s=Ft.Nearest,a=o=0);break;case 2:case 2:i=Ft.Linear,n=Ft.Linear,s=Ft.Nearest,a=o=0;break;case 12:i=Ft.Linear,n=Ft.Nearest,s=Ft.Nearest,a=o=0}return t>1&&(0!==a||0!==o)?{magFilter:Ft.Linear,minFilter:Ft.Linear,mipmapFilter:Ft.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:n,mipmapFilter:s,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return Dl.Repeat;case 0:return Dl.ClampToEdge;case 2:return Dl.MirrorRepeat}return Dl.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e){const t=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,i=this._GetSamplerFilterDescriptor(e,t);return Gp(Mi(Mi({},i),this._GetSamplerWrappingDescriptor(e)),{compare:e._comparisonFunction?wl.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:i.anisotropyEnabled?t:1})}static GetCompareFunction(e){switch(e){case 519:return vn.Always;case 514:return vn.Equal;case 516:return vn.Greater;case 518:return vn.GreaterEqual;case 513:default:return vn.Less;case 515:return vn.LessEqual;case 512:return vn.Never;case 517:return vn.NotEqual}}getSampler(e,t=!1,i=0){if(this.disabled)return this._device.createSampler(wl._GetSamplerDescriptor(e));t?i=0:0===i&&(i=wl.GetSamplerHashCode(e));let n=t?void 0:this._samplers[i];return n||(n=this._device.createSampler(wl._GetSamplerDescriptor(e)),t||(this._samplers[i]=n)),n}}var Wi=(()=>{return(r=Wi||(Wi={}))[r.StencilReadMask=0]="StencilReadMask",r[r.StencilWriteMask=1]="StencilWriteMask",r[r.DepthBias=2]="DepthBias",r[r.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",r[r.DepthStencilState=4]="DepthStencilState",r[r.MRTAttachments1=5]="MRTAttachments1",r[r.MRTAttachments2=6]="MRTAttachments2",r[r.RasterizationState=7]="RasterizationState",r[r.ColorStates=8]="ColorStates",r[r.ShaderStage=9]="ShaderStage",r[r.TextureStage=10]="TextureStage",r[r.VertexState=11]="VertexState",r[r.NumStates=12]="NumStates",Wi;var r})();const xp={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},tu={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};let U6=(()=>{class r{constructor(t,i,n){this.mrtTextureCount=0,this._device=t,this._useTextureStage=n,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=i,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=t.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[M.BGRA8Unorm],this.setColorFormat(M.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(M.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(t,i,n,s=0){if(n>1&&(n=4),this.disabled){const o=r._GetTopology(t);return this._setVertexState(i),this._parameter.pipeline=this._createRenderPipeline(i,o,n),r.NumCacheMiss++,r._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(i.uniqueId),this._setRasterizationState(t,n),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(i),this._setTextureState(s),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,r.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return r.NumCacheHitWithHash++,this._parameter.pipeline;const a=r._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(i,a,n),this._setRenderPipeline(this._parameter),r.NumCacheMiss++,r._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){r.NumPipelineCreationLastFrame=r._NumPipelineCreationCurrentFrame,r._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(t){this._alphaToCoverageEnabled=t}setFrontFace(t){this._frontFace=t}setCullEnabled(t){this._cullEnabled=t}setCullFace(t){this._cullFace=t}setClampDepth(t){this._clampDepth=t}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(t,i,n,s,a,o,l,c){this._depthWriteEnabled=l,this._depthTestEnabled=o,this._depthCompare=(null!=c?c:519)-512,this._cullFace=n,this._cullEnabled=t,this._frontFace=i,this.setDepthBiasSlopeScale(s),this.setDepthBias(a)}setDepthBias(t){this._depthBias!==t&&(this._depthBias=t,this._states[Wi.DepthBias]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.DepthBias))}setDepthBiasSlopeScale(t){this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this._states[Wi.DepthBiasSlopeScale]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.DepthBiasSlopeScale))}setColorFormat(t){this._webgpuColorFormat[0]=t,this._colorFormat=Nh[null!=t?t:""]}setMRTAttachments(t){this.mrtAttachments=t;let i=0;for(let n=0;n<t.length;++n)0!==t[n]&&(i+=1<<n);this._mrtEnabledMask!==i&&(this._mrtEnabledMask=i,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.MRTAttachments1))}setMRT(t,i){var n,s;if((i=null!=i?i:t.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=t,this.mrtTextureCount=i,this._mrtEnabledMask=65535;const a=[0,0];let o=0,l=0,c=0;for(let u=0;u<i;++u){const h=t[u],d=null==h?void 0:h._hardwareTexture;this._mrtFormats[c]=null!==(n=null==d?void 0:d.format)&&void 0!==n?n:this._webgpuColorFormat[0],a[o]+=Nh[null!==(s=this._mrtFormats[c])&&void 0!==s?s:""]<<l,l+=6,c++,l>=32&&(l=0,o++)}this._mrtFormats.length=c,(this._mrtAttachments1!==a[0]||this._mrtAttachments2!==a[1])&&(this._mrtAttachments1=a[0],this._mrtAttachments2=a[1],this._states[Wi.MRTAttachments1]=a[0],this._states[Wi.MRTAttachments2]=a[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.MRTAttachments1))}setAlphaBlendEnabled(t){this._alphaBlendEnabled=t}setAlphaBlendFactors(t,i){this._alphaBlendFuncParams=t,this._alphaBlendEqParams=i}setWriteMask(t){this._writeMask=t}setDepthStencilFormat(t){this._webgpuDepthStencilFormat=t,this._depthStencilFormat=void 0===t?0:Nh[t]}setDepthTestEnabled(t){this._depthTestEnabled=t}setDepthWriteEnabled(t){this._depthWriteEnabled=t}setDepthCompare(t){this._depthCompare=(null!=t?t:519)-512}setStencilEnabled(t){this._stencilEnabled=t}setStencilCompare(t){this._stencilFrontCompare=(null!=t?t:519)-512}setStencilDepthFailOp(t){this._stencilFrontDepthFailOp=null===t?1:tu[t]}setStencilPassOp(t){this._stencilFrontPassOp=null===t?2:tu[t]}setStencilFailOp(t){this._stencilFrontFailOp=null===t?1:tu[t]}setStencilReadMask(t){this._stencilReadMask!==t&&(this._stencilReadMask=t,this._states[Wi.StencilReadMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.StencilReadMask))}setStencilWriteMask(t){this._stencilWriteMask!==t&&(this._stencilWriteMask=t,this._states[Wi.StencilWriteMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(t,i,n,s,a,o,l){this._stencilEnabled=t,this._stencilFrontCompare=(null!=i?i:519)-512,this._stencilFrontDepthFailOp=null===n?1:tu[n],this._stencilFrontPassOp=null===s?2:tu[s],this._stencilFrontFailOp=null===a?1:tu[a],this.setStencilReadMask(o),this.setStencilWriteMask(l)}setBuffers(t,i,n){this._vertexBuffers=t,this._overrideVertexBuffers=n,this._indexBuffer=i}static _GetTopology(t){switch(t){case 0:default:return wr.TriangleList;case 2:case 3:return wr.PointList;case 1:case 4:return wr.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return wr.LineStrip;case 7:return wr.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(t){switch(t){case 32774:default:return uo.Add;case 32778:return uo.Subtract;case 32779:return uo.ReverseSubtract;case 32775:return uo.Min;case 32776:return uo.Max}}static _GetAphaBlendFactor(t){switch(t){case 0:return Yn.Zero;case 1:default:return Yn.One;case 768:return Yn.Src;case 769:return Yn.OneMinusSrc;case 770:return Yn.SrcAlpha;case 771:return Yn.OneMinusSrcAlpha;case 772:return Yn.DstAlpha;case 773:return Yn.OneMinusDstAlpha;case 774:return Yn.Dst;case 775:return Yn.OneMinusDst;case 776:return Yn.SrcAlphaSaturated;case 32769:case 32771:return Yn.Constant;case 32770:case 32772:return Yn.OneMinusConstant}}static _GetCompareFunction(t){switch(t){case 0:return vn.Never;case 1:return vn.Less;case 2:return vn.Equal;case 3:return vn.LessEqual;case 4:return vn.Greater;case 5:return vn.NotEqual;case 6:return vn.GreaterEqual;case 7:return vn.Always}return vn.Never}static _GetStencilOpFunction(t){switch(t){case 0:return Ds.Zero;case 1:return Ds.Keep;case 2:return Ds.Replace;case 3:return Ds.IncrementClamp;case 4:return Ds.DecrementClamp;case 5:return Ds.Invert;case 6:return Ds.IncrementWrap;case 7:return Ds.DecrementWrap}return Ds.Keep}static _GetVertexInputDescriptorFormat(t){const i=t.type,n=t.normalized,s=t.getSize();switch(i){case I.BYTE:switch(s){case 1:case 2:return n?wi.Snorm8x2:wi.Sint8x2;case 3:case 4:return n?wi.Snorm8x4:wi.Sint8x4}break;case I.UNSIGNED_BYTE:switch(s){case 1:case 2:return n?wi.Unorm8x2:wi.Uint8x2;case 3:case 4:return n?wi.Unorm8x4:wi.Uint8x4}break;case I.SHORT:switch(s){case 1:case 2:return n?wi.Snorm16x2:wi.Sint16x2;case 3:case 4:return n?wi.Snorm16x4:wi.Sint16x4}break;case I.UNSIGNED_SHORT:switch(s){case 1:case 2:return n?wi.Unorm16x2:wi.Uint16x2;case 3:case 4:return n?wi.Unorm16x4:wi.Uint16x4}break;case I.INT:switch(s){case 1:return wi.Sint32;case 2:return wi.Sint32x2;case 3:return wi.Sint32x3;case 4:return wi.Sint32x4}break;case I.UNSIGNED_INT:switch(s){case 1:return wi.Uint32;case 2:return wi.Uint32x2;case 3:return wi.Uint32x3;case 4:return wi.Uint32x4}break;case I.FLOAT:switch(s){case 1:return wi.Float32;case 2:return wi.Float32x2;case 3:return wi.Float32x3;case 4:return wi.Float32x4}}throw new Error(`Invalid Format '${t.getKind()}' - type=${i}, normalized=${n}, size=${s}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:r._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:r._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:r._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(t){this._shaderId!==t&&(this._shaderId=t,this._states[Wi.ShaderStage]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.ShaderStage))}_setRasterizationState(t,i){const l=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(t<<5)+(i<<8);this._rasterizationState!==l&&(this._rasterizationState=l,this._states[Wi.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.RasterizationState))}_setColorStates(){let t=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(t+=((null===this._alphaBlendFuncParams[0]?2:xp[this._alphaBlendFuncParams[0]])<<0)+((null===this._alphaBlendFuncParams[1]?2:xp[this._alphaBlendFuncParams[1]])<<4)+((null===this._alphaBlendFuncParams[2]?2:xp[this._alphaBlendFuncParams[2]])<<8)+((null===this._alphaBlendFuncParams[3]?2:xp[this._alphaBlendFuncParams[3]])<<12)+((null===this._alphaBlendEqParams[0]?1:this._alphaBlendEqParams[0]-32773)<<16)+((null===this._alphaBlendEqParams[1]?1:this._alphaBlendEqParams[1]-32773)<<19)),t!==this._colorStates&&(this._colorStates=t,this._states[Wi.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.ColorStates))}_setDepthStencilState(){const i=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+((this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591)<<10);this._depthStencilState!==i&&(this._depthStencilState=i,this._states[Wi.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.DepthStencilState))}_setVertexState(t){var i,n;const s=this._statesLength;let a=Wi.VertexState;const o=t._pipelineContext,l=o.shaderProcessingContext.attributeNamesFromEffect,c=o.shaderProcessingContext.attributeLocationsFromEffect;let u,h=0;for(let d=0;d<l.length;d++){const f=c[d];let p=null!==(i=this._overrideVertexBuffers&&this._overrideVertexBuffers[l[d]])&&void 0!==i?i:this._vertexBuffers[l[d]];p||(p=this._emptyVertexBuffer);const g=null===(n=p.getBuffer())||void 0===n?void 0:n.underlyingResource;if(void 0===p._validOffsetRange){const m=p.byteOffset,T=p.getSize(!0),v=p.byteStride;p._validOffsetRange=m<=this._kMaxVertexBufferStride-T&&(0===v||m+T<=v)}u&&u===g&&p._validOffsetRange||(this.vertexBuffers[h++]=p,u=p._validOffsetRange?g:null);const _=p.hashCode+(f<<7);this._isDirty=this._isDirty||this._states[a]!==_,this._states[a++]=_}this.vertexBuffers.length=h,this._statesLength=a,this._isDirty=this._isDirty||a!==s,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.VertexState))}_setTextureState(t){this._textureState!==t&&(this._textureState=t,this._states[Wi.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Wi.TextureStage))}_createPipelineLayout(t){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(t);const i=[],n=t.shaderProcessingContext.bindGroupLayoutEntries;for(let s=0;s<n.length;s++)i[s]=this._device.createBindGroupLayout({entries:n[s]});return t.bindGroupLayouts=i,this._device.createPipelineLayout({bindGroupLayouts:i})}_createPipelineLayoutWithTextureStage(t){var i;const n=t.shaderProcessingContext,s=n.bindGroupLayoutEntries;let a=1;for(let l=0;l<s.length;l++){const c=s[l];for(let u=0;u<c.length;u++){const h=s[l][u];if(h.texture){const d=n.bindGroupLayoutEntryInfo[l][h.binding].name,f=n.availableTextures[d],p=f.autoBindSampler?n.availableSamplers[d+Oi.AutoSamplerSuffix]:null;let g=f.sampleType,_=null!==(i=null==p?void 0:p.type)&&void 0!==i?i:co.Filtering;this._textureState&a&&g!==Pr.Depth&&(f.autoBindSampler&&(_=co.NonFiltering),g=Pr.UnfilterableFloat),h.texture.sampleType=g,p&&(s[p.binding.groupIndex][n.bindGroupLayoutEntryInfo[p.binding.groupIndex][p.binding.bindingIndex].index].sampler.type=_),a<<=1}}}const o=[];for(let l=0;l<s.length;++l)o[l]=this._device.createBindGroupLayout({entries:s[l]});return t.bindGroupLayouts=o,this._device.createPipelineLayout({bindGroupLayouts:o})}_getVertexInputDescriptor(t){var i,n;const s=[],a=t._pipelineContext,o=a.shaderProcessingContext.attributeNamesFromEffect,l=a.shaderProcessingContext.attributeLocationsFromEffect;let c,u;for(let h=0;h<o.length;h++){const d=l[h];let f=null!==(i=this._overrideVertexBuffers&&this._overrideVertexBuffers[o[h]])&&void 0!==i?i:this._vertexBuffers[o[h]];f||(f=this._emptyVertexBuffer);let p=null===(n=f.getBuffer())||void 0===n?void 0:n.underlyingResource,g=f.byteOffset;const _=!f._validOffsetRange;if(!c||!u||c!==p||_){const m={arrayStride:f.byteStride,stepMode:f.getIsInstanced()?Ph.Instance:Ph.Vertex,attributes:[]};s.push(m),u=m.attributes,_&&(g=0,p=null)}u.push({shaderLocation:d,offset:g,format:r._GetVertexInputDescriptorFormat(f)}),c=p}return s}_createRenderPipeline(t,i,n){var s,a,o;const l=t._pipelineContext,c=this._getVertexInputDescriptor(t),u=this._createPipelineLayout(l),h=[],d=this._getAphaBlendState(),f=this._getColorBlendState();if(this._mrtAttachments1>0)for(let m=0;m<this._mrtFormats.length;++m){const T=this._mrtFormats[m];if(T){const v={format:T,writeMask:0!=(this._mrtEnabledMask&1<<m)?this._writeMask:0};d&&f&&(v.blend={alpha:d,color:f}),h.push(v)}else h.push(null)}else if(this._webgpuColorFormat[0]){const m={format:this._webgpuColorFormat[0],writeMask:this._writeMask};d&&f&&(m.blend={alpha:d,color:f}),h.push(m)}else h.push(null);const p={compare:r._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:r._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let g;(i===wr.LineStrip||i===wr.TriangleStrip)&&(g=!this._indexBuffer||this._indexBuffer.is32Bits?ho.Uint32:ho.Uint16);const _=!!this._webgpuDepthStencilFormat&&Ai.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${null!==(a=null===(s=h[0])||void 0===s?void 0:s.format)&&void 0!==a?a:"nooutput"}_${null!==(o=this._webgpuDepthStencilFormat)&&void 0!==o?o:"nodepth"}_samples${n}`,layout:u,vertex:{module:l.stages.vertexStage.module,entryPoint:l.stages.vertexStage.entryPoint,buffers:c},primitive:{topology:i,stripIndexFormat:g,frontFace:1===this._frontFace?Dh.CCW:Dh.CW,cullMode:this._cullEnabled?2===this._cullFace?eu.Front:eu.Back:eu.None},fragment:l.stages.fragmentStage?{module:l.stages.fragmentStage.module,entryPoint:l.stages.fragmentStage.entryPoint,targets:h}:void 0,multisample:{count:n},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?r._GetCompareFunction(this._depthCompare):vn.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&_?p:void 0,stencilBack:this._stencilEnabled&&_?p:void 0,stencilReadMask:this._stencilEnabled&&_?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&_?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}return r.NumCacheHitWithoutHash=0,r.NumCacheHitWithHash=0,r.NumCacheMiss=0,r.NumPipelineCreationLastFrame=0,r._NumPipelineCreationCurrentFrame=0,r})();class JO{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const n=this.values[i],[s,a]=n.count();e+=s,t+=a,e++}return[e,t]}}class fo extends U6{static GetNodeCounts(){const e=fo._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,n){if(e.pipeline){const s=i.slice();s.length=n,t.push(s)}for(const s in e.values){const a=e.values[s];i[n]=parseInt(s),fo._GetPipelines(a,t,i,n+1)}}static GetPipelines(){const e=[];return fo._GetPipelines(fo._Cache,e,[],0),e}constructor(e,t,i){super(e,t,i),this._nodeStack=[],this._nodeStack[0]=fo._Cache}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let n=t.values[this._states[i]];n||(n=new JO,t.values[this._states[i]]=n),t=n,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}fo._Cache=new JO;class V6 extends Kb{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var e;const t=null===(e=this.stencilMaterial)||void 0===e?void 0:e.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class k6 extends Yb{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(null!=e?e:1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(null!=e?e:2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}let G6=(()=>{class r{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatTextures(){return this._numFloatTextures>0}constructor(){this.uniqueId=r._Counter++,this.updateId=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatTextures=0,this._numExternalTextures=0}setSampler(t,i){let n=this.samplers[t],s=-1;n?s=n.hashCode:this.samplers[t]=n={sampler:i,hashCode:0},n.sampler=i,n.hashCode=i?wl.GetSamplerHashCode(i):0;const a=s!==n.hashCode;a&&this.updateId++,this.isDirty||(this.isDirty=a)}setTexture(t,i){var n,s,a;let o=this.textures[t],l=-1;o?l=null!==(s=null===(n=o.texture)||void 0===n?void 0:n.uniqueId)&&void 0!==s?s:-1:this.textures[t]=o={texture:i,isFloatTexture:!1,isExternalTexture:!1},o.isExternalTexture&&this._numExternalTextures--,o.isFloatTexture&&this._numFloatTextures--,i?(o.isFloatTexture=1===i.type,o.isExternalTexture=uw.IsExternalTexture(i),o.isFloatTexture&&this._numFloatTextures++,o.isExternalTexture&&this._numExternalTextures++):(o.isFloatTexture=!1,o.isExternalTexture=!1),o.texture=i;const c=l!==(null!==(a=null==i?void 0:i.uniqueId)&&void 0!==a?a:-1);c&&this.updateId++,this.isDirty||(this.isDirty=c)}}return r._Counter=0,r})(),H6=(()=>{class r{isDirty(t){return this._isDirty||this._materialContextUpdateId!==t}resetIsDirty(t){this._isDirty=!1,this._materialContextUpdateId=t}get useInstancing(){return this._useInstancing}set useInstancing(t){this._useInstancing!==t&&(t?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(40,_i.CopyDst|_i.Indirect),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=t,this._currentInstanceCount=-1)}constructor(t){this._bufferManager=t,this.uniqueId=r._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(t,i){var n;this._isDirty||(this._isDirty=(null==i?void 0:i.uniqueId)!==(null===(n=this.buffers[t])||void 0===n?void 0:n.uniqueId)),this.buffers[t]=i}setIndirectData(t,i,n){i===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=i,this._indirectDrawData[0]=t,this._indirectDrawData[1]=i,this._indirectDrawData[2]=n,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}return r._Counter=0,r})();class Ap{constructor(){this.values={}}}class Hi{static get Statistics(){return{totalCreated:Hi.NumBindGroupsCreatedTotal,lastFrameCreated:Hi.NumBindGroupsCreatedLastFrame,lookupLastFrame:Hi.NumBindGroupsLookupLastFrame,noLookupLastFrame:Hi.NumBindGroupsNoLookupLastFrame}}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){Hi.NumBindGroupsCreatedLastFrame=Hi._NumBindGroupsCreatedCurrentFrame,Hi.NumBindGroupsLookupLastFrame=Hi._NumBindGroupsLookupCurrentFrame,Hi.NumBindGroupsNoLookupLastFrame=Hi._NumBindGroupsNoLookupCurrentFrame,Hi._NumBindGroupsCreatedCurrentFrame=0,Hi._NumBindGroupsLookupCurrentFrame=0,Hi._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var n,s,a,o,l,c,u,h,d,f;let p,g=Hi._Cache;const _=this.disabled||i.forceBindGroupCreation;if(!_){if(!t.isDirty(i.updateId)&&!i.isDirty)return Hi._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const T of e.shaderProcessingContext.bufferNames){const v=null!==(s=null===(n=t.buffers[T])||void 0===n?void 0:n.uniqueId)&&void 0!==s?s:0;let A=g.values[v];A||(A=new Ap,g.values[v]=A),g=A}for(const T of e.shaderProcessingContext.samplerNames){const v=null!==(o=null===(a=i.samplers[T])||void 0===a?void 0:a.hashCode)&&void 0!==o?o:0;let A=g.values[v];A||(A=new Ap,g.values[v]=A),g=A}for(const T of e.shaderProcessingContext.textureNames){const v=null!==(u=null===(c=null===(l=i.textures[T])||void 0===l?void 0:l.texture)||void 0===c?void 0:c.uniqueId)&&void 0!==u?u:0;let A=g.values[v];A||(A=new Ap,g.values[v]=A),g=A}p=g.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,p)return t.bindGroups=p,Hi._NumBindGroupsLookupCurrentFrame++,p;p=[],t.bindGroups=p,_||(g.bindGroups=p),Hi.NumBindGroupsCreatedTotal++,Hi._NumBindGroupsCreatedCurrentFrame++;const m=e.bindGroupLayouts;for(let T=0;T<e.shaderProcessingContext.bindGroupLayoutEntries.length;T++){const v=e.shaderProcessingContext.bindGroupLayoutEntries[T],A=e.shaderProcessingContext.bindGroupEntries[T];for(let x=0;x<v.length;x++){const C=e.shaderProcessingContext.bindGroupLayoutEntries[T][x],R=e.shaderProcessingContext.bindGroupLayoutEntryInfo[T][C.binding],D=null!==(h=R.nameInArrayOfTexture)&&void 0!==h?h:R.name;if(C.sampler){const P=i.samplers[D];if(P){const N=P.sampler;if(!N){this._engine.dbgSanityChecks&&H.Error(`Trying to bind a null sampler! entry=${JSON.stringify(C)}, name=${D}, bindingInfo=${JSON.stringify(P,(k,X)=>"texture"===k?"<no dump>":X)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}A[x].resource=this._cacheSampler.getSampler(N,!1,P.hashCode)}else H.Error(`Sampler "${D}" could not be bound. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(N,k)=>"texture"===N||"sampler"===N?"<no dump>":k)}`,50)}else if(C.texture||C.storageTexture){const P=i.textures[D];if(P){if(this._engine.dbgSanityChecks&&null===P.texture){H.Error(`Trying to bind a null texture! entry=${JSON.stringify(C)}, bindingInfo=${JSON.stringify(P,(k,X)=>"texture"===k?"<no dump>":X)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const N=P.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!N||C.texture&&!N.view||C.storageTexture&&!N.viewForWriting)){H.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(C)}, name=${D}, bindingInfo=${JSON.stringify(P,(k,X)=>"texture"===k?"<no dump>":X)}, isReady=${null===(d=P.texture)||void 0===d?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}A[x].resource=C.storageTexture?N.viewForWriting:N.view}else H.Error(`Texture "${D}" could not be bound. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(N,k)=>"texture"===N||"sampler"===N?"<no dump>":k)}`,50)}else if(C.externalTexture){const P=i.textures[D];if(P){if(this._engine.dbgSanityChecks&&null===P.texture){H.Error(`Trying to bind a null external texture! entry=${JSON.stringify(C)}, name=${D}, bindingInfo=${JSON.stringify(P,(k,X)=>"texture"===k?"<no dump>":X)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const N=P.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!N){H.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(C)}, name=${D}, bindingInfo=${JSON.stringify(P,(k,X)=>"texture"===k?"<no dump>":X)}, isReady=${null===(f=P.texture)||void 0===f?void 0:f.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}A[x].resource=this._device.importExternalTexture({source:N})}else H.Error(`Texture "${D}" could not be bound. entry=${JSON.stringify(C)}, materialContext=${JSON.stringify(i,(N,k)=>"texture"===N||"sampler"===N?"<no dump>":k)}`,50)}else if(C.buffer){const P=t.buffers[D];P?(A[x].resource.buffer=P.underlyingResource,A[x].resource.size=P.capacity):H.Error(`Can't find buffer "${D}". entry=${JSON.stringify(C)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}p[T]=this._device.createBindGroup({layout:m[T],entries:A})}return p}}Hi.NumBindGroupsCreatedTotal=0,Hi.NumBindGroupsCreatedLastFrame=0,Hi.NumBindGroupsLookupLastFrame=0,Hi.NumBindGroupsNoLookupLastFrame=0,Hi._Cache=new Ap,Hi._NumBindGroupsCreatedCurrentFrame=0,Hi._NumBindGroupsLookupCurrentFrame=0,Hi._NumBindGroupsNoLookupCurrentFrame=0;Z.ShadersStore.clearQuadVertexShader="uniform float depthValue;\nconst vec2 pos[4]={\nvec2(-1.0,1.0),\nvec2(1.0,1.0),\nvec2(-1.0,-1.0),\nvec2(1.0,-1.0)\n};\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\ngl_Position=vec4(pos[gl_VertexID],depthValue,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";Z.ShadersStore.clearQuadPixelShader="uniform vec4 color;\nvoid main() {\ngl_FragColor=color;\n}\n";class z6{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new fo(this._device,i,!t._caps.textureFloatLinearFiltering),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}clear(e,t,i,n,s=1){var a,o;let l,u,c=null;const h=!!this._engine._currentRenderTarget;if(e)l=e;else{let T=0;this._keyTemp.length=0;for(let A=0;A<this._cacheRenderPipeline.colorFormats.length;++A)this._keyTemp[T++]=Nh[null!==(a=this._cacheRenderPipeline.colorFormats[A])&&void 0!==a?a:""];const v=Nh[null!==(o=this._depthTextureFormat)&&void 0!==o?o:0];if(this._keyTemp[T]=(t?t.r+256*t.g+256*t.b*256+256*t.a*256*256:0)+(i?2**32:0)+(n?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(h?2**35:0)+(s>1?2**36:0)+v*2**37,u=this._keyTemp.join("_"),c=this._bundleCache[u],c)return c;l=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:s})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!n&&!!this._depthTextureFormat&&Ai.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(n?255:0),this._cacheRenderPipeline.setStencilCompare(n?519:512),this._cacheRenderPipeline.setStencilPassOp(n?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const d=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,s),f=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),f.uniformBuffer.update();const p=h?this._engine._ubInvertY:this._engine._ubDontInvertY,g=f.uniformBuffer.getBuffer(),_=g.uniqueId+"-"+p.uniqueId;let m=this._bindGroups[_];if(!m){const T=f.bindGroupLayouts;m=this._bindGroups[_]=[],m.push(this._device.createBindGroup({layout:T[0],entries:[]})),Fh._SimplifiedKnownBindings||m.push(this._device.createBindGroup({layout:T[1],entries:[]})),m.push(this._device.createBindGroup({layout:T[Fh._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:p.underlyingResource,size:p.capacity}},{binding:1,resource:{buffer:g.underlyingResource,size:g.capacity}}]}))}l.setPipeline(d);for(let T=0;T<m.length;++T)l.setBindGroup(T,m[T]);return l.draw(4,1,0,0),e||(c=l.finish(),this._bundleCache[u]=c),c}}class FE{constructor(e,t,i,n){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(n)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new FE(this.x,this.y,this.w,this.h)}}class Lh{constructor(e,t,i,n){this.x=e,this.y=t,this.w=i,this.h=n}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new Lh(this.x,this.y,this.w,this.h)}}class Bh{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new Bh(this.ref)}}class NE{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new NE(this.color)}}class LE{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new LE(this.query)}}class BE{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new BE}}class UE{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new UE;return e.bundles=this.bundles,e}}class yp{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const t=new UE;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:i})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new yp(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class rF{get querySet(){return this._querySet}constructor(e,t,i,n,s=!0){this._dstBuffers=[],this._device=i,this._bufferManager=n,this._count=e,this._canUseMultipleBuffers=s,this._querySet=i.createQuerySet({type:t,count:e}),this._queryBuffer=n.createRawBuffer(8*e,_i.QueryResolve|_i.CopySrc),s||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,_i.MapRead|_i.CopyDst))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const i=this._device.createCommandEncoder();let n;return 0===this._dstBuffers.length?n=this._bufferManager.createRawBuffer(8*this._count,_i.MapRead|_i.CopyDst):(n=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,n,0,8*t),this._device.queue.submit([i.finish()]),n}readValues(){var e=this;return ls(function*(t=0,i=1){const n=e._getBuffer(t,i);if(null===n)return null;yield n.mapAsync(Xo.Read);const s=new BigUint64Array(n.getMappedRange()).slice();return n.unmap(),e._dstBuffers[e._dstBuffers.length]=n,s}).apply(this,arguments)}readValue(){var e=this;return ls(function*(t=0){const i=e._getBuffer(t,1);if(null===i)return null;yield i.mapAsync(Xo.Read);const n=new BigUint64Array(i.getMappedRange()),s=Number(n[0]);return i.unmap(),e._dstBuffers[e._dstBuffers.length]=i,s}).apply(this,arguments)}readTwoValuesAndSubtract(){var e=this;return ls(function*(t=0){const i=e._getBuffer(t,2);if(null===i)return null;yield i.mapAsync(Xo.Read);const n=new BigUint64Array(i.getMappedRange()),s=Number(n[1]-n[0]);return i.unmap(),e._dstBuffers[e._dstBuffers.length]=i,s}).apply(this,arguments)}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class W6{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new El,this._measureDurationState=0,this._device=e,this._bufferManager=t}get enable(){return this._enabled}set enable(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new X6(this._device,this._bufferManager):this._measureDuration.dispose())}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{null!==t&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}}class X6{constructor(e,t){this._querySet=new rF(2,wh.Timestamp,e,t)}start(e){e.writeTimestamp(this._querySet.querySet,0)}stop(e){var t=this;return ls(function*(){return e.writeTimestamp(t._querySet.querySet,1),t._querySet.readTwoValuesAndSubtract(0)})()}dispose(){this._querySet.dispose()}}class Y6{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}get canBeginQuery(){switch(this._engine._getCurrentRenderPassIndex()){case 0:return void 0!==this._engine._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet;case 1:return void 0!==this._engine._rttRenderPassWrapper.renderPassDescriptor.occlusionQuerySet}return!1}constructor(e,t,i,n=50,s=100){this._availableIndices=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=s,this._allocateNewIndices(n)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length-1]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t,i;return Number(null!==(i=null===(t=this._lastBuffer)||void 0===t?void 0:t[e])&&void 0!==i?i:-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=null!=e?e:this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new rF(this._currentTotalIndices,wh.Occlusion,this._device,this._bufferManager,!1)}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){var e;null===(e=this._querySet)||void 0===e||e.dispose(),this._availableIndices.length=0}}let j6=(()=>{class r{initTwgsl(t){return ls(function*(){if(!r._twgsl)return t=t||{},(t=Mi(Mi({},r._TWgslDefaultOptions),t)).twgsl?(r._twgsl=t.twgsl,Promise.resolve()):(t.jsPath&&t.wasmPath&&(rn()?yield Ie.LoadScriptAsync(t.jsPath):importScripts(t.jsPath)),self.twgsl?(r._twgsl=yield self.twgsl(t.wasmPath),Promise.resolve()):Promise.reject("twgsl is not available."))})()}convertSpirV2WGSL(t,i=!1){const n=r._twgsl.convertSpirV2WGSL(t);return r.ShowWGSLShaderCode&&(console.log(n),console.log("***********************************************")),r.DisableUniformityAnalysis||i?"diagnostic(off, derivative_uniformity);\n"+n:n}}return r._TWgslDefaultOptions={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"},r.ShowWGSLShaderCode=!1,r.DisableUniformityAnalysis=!1,r._twgsl=null,r})();class $6{constructor(e,t,i,n){this._record=!1,this._play=!1,this._mainPassBundleList=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i,this._bundleListRenderTarget=n}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._mainPassBundleList.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endMainRenderPass(){this._record&&this._mainPassBundleList.push(this._bundleList.clone())}endRenderTargetPass(e,t){var i,n,s,a;if(this._play)null===(n=null===(i=t._bundleLists)||void 0===i?void 0:i[t._currentLayer])||void 0===n||n.run(e),1===this._mode&&this._engine._reportDrawCall(null===(a=null===(s=t._bundleLists)||void 0===s?void 0:s[t._currentLayer])||void 0===a?void 0:a.numDrawCalls);else{if(!this._record)return!1;t._bundleLists||(t._bundleLists=[]),t._bundleLists[t._currentLayer]=this._bundleListRenderTarget.clone(),t._bundleLists[t._currentLayer].run(e),this._bundleListRenderTarget.reset()}return!0}endFrame(e){if(this._record&&(this._mainPassBundleList.push(this._bundleList.clone()),this._record=!1,this._play=!0,this._mode=this._modeSaved),null!==e&&this._play)for(let t=0;t<this._mainPassBundleList.length;++t)this._mainPassBundleList[t].run(e),1===this._mode&&this._engine._reportDrawCall(this._mainPassBundleList[t].numDrawCalls)}reset(){this.enabled=!1,this.enabled=!0}}const sF={label:"TextureView_SwapChain_ResolveTarget",dimension:ds.E2d,format:void 0,mipLevelCount:1,arrayLayerCount:1},aF={label:"TextureView_SwapChain",dimension:ds.E2d,format:void 0,mipLevelCount:1,arrayLayerCount:1},bp="/* disable_uniformity_analysis */";let ft=(()=>{class r extends Ve{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(t){this._snapshotRendering.mode=t}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(t){this._snapshotRendering.enabled=t}get disableCacheSamplers(){return!!this._cacheSampler&&this._cacheSampler.disabled}set disableCacheSamplers(t){this._cacheSampler&&(this._cacheSampler.disabled=t)}get disableCacheRenderPipelines(){return!!this._cacheRenderPipeline&&this._cacheRenderPipeline.disabled}set disableCacheRenderPipelines(t){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=t)}get disableCacheBindGroups(){return!!this._cacheBindGroups&&this._cacheBindGroups.disabled}set disableCacheBindGroups(t){this._cacheBindGroups&&(this._cacheBindGroups.disabled=t)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(t=>!!t,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return H.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(t){this._compatibilityMode=t}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(t,i={}){const n=new r(t,i);return new Promise(s=>{n.initAsync(i.glslangOptions,i.twgslOptions).then(()=>s(n))})}constructor(t,i={}){var n,s;super(null,null===(n=i.antialias)||void 0===n||n,i),this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._renderTargetEncoderDescriptor={label:"renderTarget"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._adapterInfo={vendor:"",architecture:"",device:"",description:""},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this._commandBuffers=[null,null,null],this._currentRenderPass=null,this._mainRenderPassWrapper=new qO,this._rttRenderPassWrapper=new qO,this._pendingDebugCommands=[],this._onAfterUnbindFrameBufferObservable=new J,this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=[-1,-1],this._blendColorsCurrent=[[null,null,null,null],[null,null,null,null]],this._name="WebGPU",i.deviceDescriptor=i.deviceDescriptor||{},i.enableGPUDebugMarkers=null!==(s=i.enableGPUDebugMarkers)&&void 0!==s&&s,H.Log(`Babylon.js v${Ve.Version} - ${this.description} engine`),navigator.gpu?(i.swapChainFormat=i.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=t,this._options=i,this._mainPassSampleCount=i.antialias?this._defaultSampleCount:1,this._setupMobileChecks(),this._sharedInit(t),this._shaderProcessor=new v6,this._shaderProcessorWGSL=new y6):H.Error("WebGPU is not supported by your browser.")}initAsync(t,i){var n;return this._initGlslang(null!=t?t:null===(n=this._options)||void 0===n?void 0:n.glslangOptions).then(s=>{var a;return this._glslang=s,this._tintWASM=r.UseTWGSL?new j6:null,this._tintWASM?this._tintWASM.initTwgsl(null!=i?i:null===(a=this._options)||void 0===a?void 0:a.twgslOptions).then(()=>navigator.gpu.requestAdapter(this._options),o=>{throw H.Error("Can not initialize twgsl!"),H.Error(o),Error("WebGPU initializations stopped.")}):navigator.gpu.requestAdapter(this._options)},s=>{throw H.Error("Can not initialize glslang!"),H.Error(s),Error("WebGPU initializations stopped.")}).then(s=>{var a,o,l;if(s){this._adapter=s,this._adapterSupportedExtensions=[],null===(a=this._adapter.features)||void 0===a||a.forEach(h=>this._adapterSupportedExtensions.push(h)),this._adapterSupportedLimits=this._adapter.limits,this._adapter.requestAdapterInfo().then(h=>{this._adapterInfo=h});const c=null!==(o=this._options.deviceDescriptor)&&void 0!==o?o:{},u=null!==(l=null==c?void 0:c.requiredFeatures)&&void 0!==l?l:this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0;if(u){const h=u,d=[];for(const f of h)-1!==this._adapterSupportedExtensions.indexOf(f)&&d.push(f);c.requiredFeatures=d}if(this._options.setMaximumLimits&&!c.requiredLimits){c.requiredLimits={};for(const h in this._adapterSupportedLimits)c.requiredLimits[h]=this._adapterSupportedLimits[h]}return this._adapter.requestDevice(c)}throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(s=>{var a,o;this._device=s,this._deviceEnabledExtensions=[],null===(a=this._device.features)||void 0===a||a.forEach(c=>this._deviceEnabledExtensions.push(c)),this._deviceLimits=s.limits;let l=-1;this._device.addEventListener("uncapturederror",c=>{++l<this.numMaxUncapturedErrors?H.Warn(`WebGPU uncaptured error (${l+1}): ${c.error} - ${c.error.message}`):l++===this.numMaxUncapturedErrors&&H.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||null===(o=this._device.lost)||void 0===o||o.then(c=>{this._isDisposed||(this._contextWasLost=!0,H.Warn("WebGPU context lost. "+c),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(this.initAsync.bind(this)))})},s=>{H.Error("Could not retrieve a WebGPU device."),H.Error(s)}).then(()=>{this._bufferManager=new OE(this._device),this._textureHelper=new Ai(this._device,this._glslang,this._tintWASM,this._bufferManager),this._cacheSampler=new wl(this._device),this._cacheBindGroups=new Hi(this._device,this._cacheSampler,this),this._timestampQuery=new W6(this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new Y6(this,this._device,this._bufferManager):void 0,this._bundleList=new yp(this._device),this._bundleListRenderTarget=new yp(this._device),this._snapshotRendering=new $6(this,this._snapshotRenderingMode,this._bundleList,this._bundleListRenderTarget),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),_i.Uniform|_i.CopyDst),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),_i.Uniform|_i.CopyDst),this.dbgVerboseLogsForFirstFrames&&void 0===this._count&&(this._count=0,console.log("%c frame #"+this._count+" - begin","background: #ffff00")),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._emptyVertexBuffer=new I(this,[0],"",!1,!1,1,!1,0,1),this._initializeLimits(),this._cacheRenderPipeline=new fo(this._device,this._emptyVertexBuffer,!this._caps.textureFloatLinearFiltering),this._depthCullingState=new k6(this._cacheRenderPipeline),this._stencilStateComposer=new V6(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new z6(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(s=>{H.Error("Can not create WebGPU Device and/or context."),H.Error(s),console.trace&&console.trace()})}_initGlslang(t){return t=t||{},(t=Mi(Mi({},r._GLSLslangDefaultOptions),t)).glslang?Promise.resolve(t.glslang):self.glslang?self.glslang(t.wasmPath):t.jsPath&&t.wasmPath?rn()?Ie.LoadScriptAsync(t.jsPath).then(()=>self.glslang(t.wasmPath)):(importScripts(t.jsPath),self.glslang(t.wasmPath)):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:2*this._deviceLimits.maxSampledTexturesPerShaderStage,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(ao.TextureCompressionASTC)>=0||void 0,s3tc:this._deviceEnabledExtensions.indexOf(ao.TextureCompressionBC)>=0||void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(ao.TextureCompressionETC2)>=0||void 0,bptc:this._deviceEnabledExtensions.indexOf(ao.TextureCompressionBC)>=0||void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf(ao.Float32Filterable)>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:"undefined"!=typeof BigUint64Array&&-1!==this._deviceEnabledExtensions.indexOf(ao.TimestampQuery)||void 0,supportOcclusionQuery:"undefined"!=typeof BigUint64Array,canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Sp],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(!1),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};const t=new Float32Array([this.getRenderHeight(!0)]);let i;if(this._bufferManager.setSubData(this._ubInvertY,4,t),this._bufferManager.setSubData(this._ubDontInvertY,4,t),this._options.antialias){const a={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:ds.E2d,format:this._options.swapChainFormat,usage:yi.RenderAttachment};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(a),i=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:ds.E2d,format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new ct(0,0,0,1),loadOp:an.Clear,storeOp:$r.Store}]}else i=[{view:void 0,clearValue:new ct(0,0,0,1),loadOp:an.Clear,storeOp:$r.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?M.Depth24PlusStencil8:M.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);const n={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:ds.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:yi.RenderAttachment};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(n);const s={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:ds.E2d,format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:an.Clear,depthStoreOp:$r.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?an.Clear:void 0,stencilStoreOp:this.isStencilEnable?$r.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:i,depthStencilAttachment:s}}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:yi.RenderAttachment|yi.CopySrc,alphaMode:this.premultipliedAlpha?Oh.Premultiplied:Oh.Opaque})}setSize(t,i,n=!1){return!!super.setSize(t,i,n)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",t,i)),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0)}_getShaderProcessor(t){return t===Ri.WGSL?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(t){return new Fh(t)}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(t){this.preventCacheWipeBetweenFrames&&!t||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),t&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(t){this._colorWriteLocal=t,this._cacheRenderPipeline.setWriteMask(t?15:0)}getColorWrite(){return this._colorWriteLocal}_resetCurrentViewport(t){this._viewportsCurrent[t].x=0,this._viewportsCurrent[t].y=0,this._viewportsCurrent[t].w=0,this._viewportsCurrent[t].h=0,1===t&&(this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0)}_mustUpdateViewport(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,l=this._viewportsCurrent[i].x!==this._viewportCached.x||this._viewportsCurrent[i].y!==this._viewportCached.y||this._viewportsCurrent[i].w!==this._viewportCached.z||this._viewportsCurrent[i].h!==this._viewportCached.w;return l&&(this._viewportsCurrent[i].x=this._viewportCached.x,this._viewportsCurrent[i].y=this._viewportCached.y,this._viewportsCurrent[i].w=this._viewportCached.z,this._viewportsCurrent[i].h=this._viewportCached.w),l}_applyViewport(t){let i=Math.floor(this._viewportCached.y);const n=Math.floor(this._viewportCached.w);this._currentRenderTarget||(i=this.getRenderHeight(!0)-i-n),t.setViewport(Math.floor(this._viewportCached.x),i,Math.floor(this._viewportCached.z),n,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+(t===this._mainRenderPassWrapper.renderPass)))}_viewport(t,i,n,s){this._viewportCached.x=t,this._viewportCached.y=i,this._viewportCached.z=n,this._viewportCached.w=s}_resetCurrentScissor(t){this._scissorsCurrent[t].x=0,this._scissorsCurrent[t].y=0,this._scissorsCurrent[t].w=0,this._scissorsCurrent[t].h=0}_mustUpdateScissor(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,l=this._scissorsCurrent[i].x!==this._scissorCached.x||this._scissorsCurrent[i].y!==this._scissorCached.y||this._scissorsCurrent[i].w!==this._scissorCached.z||this._scissorsCurrent[i].h!==this._scissorCached.w;return l&&(this._scissorsCurrent[i].x=this._scissorCached.x,this._scissorsCurrent[i].y=this._scissorCached.y,this._scissorsCurrent[i].w=this._scissorCached.z,this._scissorsCurrent[i].h=this._scissorCached.w),l}_applyScissor(t){t.setScissorRect(this._scissorCached.x,this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+(t===this._mainRenderPassWrapper.renderPass)))}_scissorIsActive(){return 0!==this._scissorCached.x||0!==this._scissorCached.y||0!==this._scissorCached.z||0!==this._scissorCached.w}enableScissor(t,i,n,s){this._scissorCached.x=t,this._scissorCached.y=i,this._scissorCached.z=n,this._scissorCached.w=s}disableScissor(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=0,this._scissorCached.w=0,this._resetCurrentScissor(0),this._resetCurrentScissor(1)}_resetCurrentStencilRef(t){this._stencilRefsCurrent[t]=-1}_mustUpdateStencilRef(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,n=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent[i];return n&&(this._stencilRefsCurrent[i]=this._stencilStateComposer.funcRef),n}_applyStencilRef(t){var i;t.setStencilReference(null!==(i=this._stencilStateComposer.funcRef)&&void 0!==i?i:0)}_resetCurrentColorBlend(t){this._blendColorsCurrent[t][0]=this._blendColorsCurrent[t][1]=this._blendColorsCurrent[t][2]=this._blendColorsCurrent[t][3]=null}_mustUpdateBlendColor(t){const i=t===this._mainRenderPassWrapper.renderPass?0:1,n=this._alphaState._blendConstants,s=n[0]!==this._blendColorsCurrent[i][0]||n[1]!==this._blendColorsCurrent[i][1]||n[2]!==this._blendColorsCurrent[i][2]||n[3]!==this._blendColorsCurrent[i][3];return s&&(this._blendColorsCurrent[i][0]=n[0],this._blendColorsCurrent[i][1]=n[1],this._blendColorsCurrent[i][2]=n[2],this._blendColorsCurrent[i][3]=n[3]),s}_applyBlendColor(t){t.setBlendConstant(this._alphaState._blendConstants)}clear(t,i,n,s=!1){t&&void 0===t.a&&(t.a=1);const a=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",i," depth=",n," stencil=",s," scissor is active=",a)),this._currentRenderTarget?a?(this._rttRenderPassWrapper.renderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,i?t:null,n,s),this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleListRenderTarget.addItem(new Lh(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(i?t:null,n,s)):(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,i?t:null,n,s)):((!this._mainRenderPassWrapper.renderPass||!a)&&this._startMainRenderPass(!a,i?t:null,n,s),a&&(this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleList.addItem(new Lh(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(i?t:null,n,s)))}_clearFullQuad(t,i,n){var s,a,o;const l=this.compatibilityMode?this._getCurrentRenderPass():null,u=0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(null!==(s=this._cacheRenderPipeline.mrtAttachments)&&void 0!==s?s:[],null!==(a=this._cacheRenderPipeline.mrtTextureArray)&&void 0!==a?a:[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?l.setStencilReference(this._clearStencilValue):u.addItem(new Bh(this._clearStencilValue));const h=this._clearQuad.clear(l,t,i,n,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(l):(u.addBundle(h),u.addItem(new Bh(null!==(o=this._stencilStateComposer.funcRef)&&void 0!==o?o:0)),this._reportDrawCall())}createVertexBuffer(t){let i;return i=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.createBuffer(i,_i.Vertex|_i.CopyDst)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t)}createIndexBuffer(t){let n,i=!0;t instanceof Uint32Array||t instanceof Int32Array?n=t:t instanceof Uint16Array?(n=t,i=!1):t.length>65535?n=new Uint32Array(t):(n=new Uint16Array(t),i=!1);const s=this._bufferManager.createBuffer(n,_i.Index|_i.CopyDst);return s.is32Bits=i,s}_createBuffer(t,i){let n;n=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t;let s=0;return 1&i&&(s|=_i.CopySrc),2&i&&(s|=_i.CopyDst),4&i&&(s|=_i.Uniform),8&i&&(s|=_i.Vertex),16&i&&(s|=_i.Index),32&i&&(s|=_i.Storage),this._bufferManager.createBuffer(n,s)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}bindBuffers(t,i,n,s){this._currentIndexBuffer=i,this._currentOverrideVertexBuffers=null!=s?s:null,this._cacheRenderPipeline.setBuffers(t,i,this._currentOverrideVertexBuffers)}_releaseBuffer(t){return this._bufferManager.releaseBuffer(t)}createEffect(t,i,n,s,a,o,l,c,u,h=Ri.GLSL){var d;const f=t.vertexElement||t.vertex||t.vertexToken||t.vertexSource||t,p=t.fragmentElement||t.fragment||t.fragmentToken||t.fragmentSource||t,g=this._getGlobalDefines();let _=null!==(d=null!=a?a:i.defines)&&void 0!==d?d:"";g&&(_+="\n"+g);const m=f+"+"+p+"@"+_;if(this._compiledEffects[m]){const v=this._compiledEffects[m];return l&&v.isReady()&&l(v),v}const T=new Si(t,i,n,s,this,a,o,l,c,u,m,h);return this._compiledEffects[m]=T,T}_compileRawShaderToSpirV(t,i){return this._glslang.compileGLSL(t,i)}_compileShaderToSpirV(t,i,n,s){return this._compileRawShaderToSpirV(s+(n?n+"\n":"")+t,i)}_getWGSLShader(t,i,n){return(n=n?"//"+n.split("\n").join("\n//")+"\n":"")+t}_createPipelineStageDescriptor(t,i,n,s,a){return this._tintWASM&&n===Ri.GLSL&&(t=this._tintWASM.convertSpirV2WGSL(t,s),i=this._tintWASM.convertSpirV2WGSL(i,a)),{vertexStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:i}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(t,i,n){const s=t.indexOf(bp)>=0,a=i.indexOf(bp)>=0,o=n===Ri.GLSL?this._compileRawShaderToSpirV(t,"vertex"):t,l=n===Ri.GLSL?this._compileRawShaderToSpirV(i,"fragment"):i;return this._createPipelineStageDescriptor(o,l,n,s,a)}_compilePipelineStageDescriptor(t,i,n,s){this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=t.indexOf(bp)>=0,o=i.indexOf(bp)>=0,l="#version 450\n",c=s===Ri.GLSL?this._compileShaderToSpirV(t,"vertex",n,l):this._getWGSLShader(t,"vertex",n),u=s===Ri.GLSL?this._compileShaderToSpirV(i,"fragment",n,l):this._getWGSLShader(i,"fragment",n),h=this._createPipelineStageDescriptor(c,u,s,a,o);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(t){const i=new Ep(t);return i.debug=!1,i.processCode(),i.code}createPipelineContext(t){return new m6(t,this)}createMaterialContext(){return new G6}createDrawContext(){return new H6(this._bufferManager)}_preparePipelineContext(t,i,n,s,a,o,l,c){const u=t,h=u.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(c),console.log(i),console.log(n),console.log("***********************************************")),u.sources={fragment:n,vertex:i,rawVertex:a,rawFragment:o},u.stages=s?this._compileRawPipelineStageDescriptor(i,n,h):this._compilePipelineStageDescriptor(i,n,c,h)}getAttributes(t,i){const n=new Array(i.length),s=t;for(let a=0;a<i.length;a++){const l=s.shaderProcessingContext.availableAttributes[i[a]];void 0!==l&&(n[a]=l)}return n}enableEffect(t){if(!t)return;let i=!0;if(Qs.IsWrapper(t)){if(!t.effect||t.effect===this._currentEffect&&t.materialContext===this._currentMaterialContext&&t.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!t.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the effect property is empty!";return}if(i=t.effect!==this._currentEffect,this._currentEffect=t.effect,this._currentMaterialContext=t.materialContext,this._currentDrawContext=t.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw console.error("drawWrapper=",t),"Invalid call to enableEffect: the materialContext property is empty!"}else i=t!==this._currentEffect,this._currentEffect=t,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&H.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${t.uniqueId}, effect.name=${t.name}, effect.name.vertex=${t.name.vertex}, effect.name.fragment=${t.name.fragment}`,10);this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!i&&!this._forceEnableEffect&&this._forceEnableEffect,i&&(this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect))}_releaseEffect(t){this._compiledEffects[t._key]&&(delete this._compiledEffects[t._key],this._deletePipelineContext(t.getPipelineContext()))}releaseEffects(){for(const t in this._compiledEffects){const i=this._compiledEffects[t].getPipelineContext();this._deletePipelineContext(i)}this._compiledEffects={}}_deletePipelineContext(t){t&&t.dispose()}get needPOTTextures(){return!1}_createHardwareTexture(){return new Sp}_releaseTexture(t){const i=this._internalTexturesCache.indexOf(t);-1!==i&&this._internalTexturesCache.splice(i,1),this._textureHelper.releaseTexture(t)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(t,i){t._comparisonFunction=i}_createInternalTexture(t,i,n=!0,s=vt.Unknown){var a,o,l;const c={};void 0!==i&&"object"==typeof i?(c.generateMipMaps=i.generateMipMaps,c.type=void 0===i.type?0:i.type,c.samplingMode=void 0===i.samplingMode?3:i.samplingMode,c.format=void 0===i.format?5:i.format,c.samples=null!==(a=i.samples)&&void 0!==a?a:1,c.creationFlags=null!==(o=i.creationFlags)&&void 0!==o?o:0,c.useSRGBBuffer=null!==(l=i.useSRGBBuffer)&&void 0!==l&&l,c.label=i.label):(c.generateMipMaps=i,c.type=0,c.samplingMode=3,c.format=5,c.samples=1,c.creationFlags=0,c.useSRGBBuffer=!1),(1===c.type&&!this._caps.textureFloatLinearFiltering||2===c.type&&!this._caps.textureHalfFloatLinearFiltering)&&(c.samplingMode=1),1===c.type&&!this._caps.textureFloat&&(c.type=0,H.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const u=new hi(this,s),h=t.width||t,d=t.height||t,f=t.layers||0;return u.baseWidth=h,u.baseHeight=d,u.width=h,u.height=d,u.depth=f,u.isReady=!0,u.samples=c.samples,u.generateMipMaps=!!c.generateMipMaps,u.samplingMode=c.samplingMode,u.type=c.type,u.format=c.format,u.is2DArray=f>0,u._cachedWrapU=0,u._cachedWrapV=0,u._useSRGBBuffer=c.useSRGBBuffer,u.label=c.label,this._internalTexturesCache.push(u),n||this._textureHelper.createGPUTextureForInternalTexture(u,h,d,f||1,c.creationFlags),u}createTexture(t,i,n,s,a=3,o=null,l=null,c=null,u=null,h=null,d=null,f,p,g,_){return this._createTextureBase(t,i,n,s,a,o,l,(m,T,v,A,S,x,C,R)=>{var D;const P=A;if(m.baseWidth=P.width,m.baseHeight=P.height,m.width=P.width,m.height=P.height,m.format=null!=h?h:-1,R(m.width,m.height,P,T,m,()=>{}),null===(D=m._hardwareTexture)||void 0===D?void 0:D.underlyingResource)!x&&!C&&this._generateMipmaps(m,this._uploadEncoder);else{const N=this._textureHelper.createGPUTextureForInternalTexture(m,P.width,P.height,void 0,g);Ai.IsImageBitmap(P)&&(this._textureHelper.updateTexture(P,m,P.width,P.height,m.depth,N.format,0,0,S,!1,0,0),!x&&!C&&this._generateMipmaps(m,this._uploadEncoder))}v&&v.removePendingData(m),m.isReady=!0,m.onLoadedObservable.notifyObservers(m),m.onLoadedObservable.clear()},()=>!1,c,u,h,d,f,p,_)}wrapWebGPUTexture(t){const i=new Sp(t),n=new hi(this,vt.Unknown,!0);return n._hardwareTexture=i,n.isReady=!0,n}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}generateMipMapsForCubemap(t){var i;t.generateMipMaps&&((null===(i=t._hardwareTexture)||void 0===i?void 0:i.underlyingResource)||this._textureHelper.createGPUTextureForInternalTexture(t),this._generateMipmaps(t,t.source===vt.RenderTarget||t.source===vt.MultiRenderTarget?this._renderTargetEncoder:void 0))}updateTextureSamplingMode(t,i,n=!1){n&&(i.generateMipMaps=!0,this._generateMipmaps(i)),i.samplingMode=t}updateTextureWrappingMode(t,i,n=null,s=null){null!==i&&(t._cachedWrapU=i),null!==n&&(t._cachedWrapV=n),(t.is2DArray||t.is3D)&&null!==s&&(t._cachedWrapR=s)}updateTextureDimensions(t,i,n,s=1){if(!t._hardwareTexture||t.width===i&&t.height===n&&t.depth===s)return;const a=t._hardwareTexture.textureAdditionalUsages;t._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(t,i,n,s,a)}_setInternalTexture(t,i,n){if(n=null!=n?n:t,this._currentEffect){const a=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[n];this._currentMaterialContext.setTexture(t,i),a&&a.autoBindSampler&&this._currentMaterialContext.setSampler(n+Oi.AutoSamplerSuffix,i)}}setTexture(t,i,n,s){this._setTexture(t,n,!1,!1,s,s)}setTextureArray(t,i,n,s){for(let a=0;a<n.length;a++)this._setTexture(-1,n[a],!0,!1,s+a.toString(),s)}_setTexture(t,i,n=!1,s=!1,a="",o){if(o=null!=o?o:a,this._currentEffect){if(!i)return this._currentMaterialContext.setTexture(a,null),!1;if(i.video)i.update();else if(4===i.delayLoadState)return i.delayLoad(),!1;let l=null;if(l=s?i.depthStencilTexture:i.isReady()?i.getInternalTexture():i.isCube?this.emptyCubeTexture:i.is3D?this.emptyTexture3D:i.is2DArray?this.emptyTexture2DArray:this.emptyTexture,l&&!l.isMultiview){if(l.isCube&&l._cachedCoordinatesMode!==i.coordinatesMode){l._cachedCoordinatesMode=i.coordinatesMode;const c=3!==i.coordinatesMode&&5!==i.coordinatesMode?1:0;i.wrapU=c,i.wrapV=c}l._cachedWrapU=i.wrapU,l._cachedWrapV=i.wrapV,l.is3D&&(l._cachedWrapR=i.wrapR),this._setAnisotropicLevel(0,l,i.anisotropicFilteringLevel)}this._setInternalTexture(a,l,o)}else this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",i));return!0}_setAnisotropicLevel(t,i,n){i._cachedAnisotropicFilteringLevel!==n&&(i._cachedAnisotropicFilteringLevel=Math.min(n,this._caps.maxAnisotropy))}_bindTexture(t,i,n){void 0!==t&&this._setInternalTexture(n,i)}generateMipmaps(t){this._generateMipmaps(t,this._renderTargetEncoder)}_generateMipmaps(t,i){const n=t._hardwareTexture;if(!n)return;i=null!=i?i:this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder;const s=t._hardwareTexture.format,a=Ai.ComputeNumMipmapLevels(t.width,t.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",t.width,"height=",t.height,"isCube=",t.isCube)),t.isCube?this._textureHelper.generateCubeMipmaps(n,s,a,i):this._textureHelper.generateMipmaps(n,s,a,0,i)}updateTextureData(t,i,n,s,a,o,l=0,c=0,u=!1){var h;let d=t._hardwareTexture;(null===(h=t._hardwareTexture)||void 0===h?void 0:h.underlyingResource)||(d=this._textureHelper.createGPUTextureForInternalTexture(t));const f=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(f,t,a,o,t.depth,d.format,l,c,t.invertY,!1,n,s),u&&this._generateMipmaps(t,this._renderTargetEncoder)}_uploadCompressedDataToTextureDirectly(t,i,n,s,a,o=0,l=0){var c;let u=t._hardwareTexture;(null===(c=t._hardwareTexture)||void 0===c?void 0:c.underlyingResource)||(t.format=i,u=this._textureHelper.createGPUTextureForInternalTexture(t,n,s));const h=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);this._textureHelper.updateTexture(h,t,n,s,t.depth,u.format,o,l,!1,!1,0,0)}_uploadDataToTextureDirectly(t,i,n=0,s=0,a,o=!1){var l;const c=Math.round(Math.log(t.width)*Math.LOG2E),u=Math.round(Math.log(t.height)*Math.LOG2E),h=o?t.width:Math.pow(2,Math.max(c-s,0)),d=o?t.height:Math.pow(2,Math.max(u-s,0));let f=t._hardwareTexture;(null===(l=t._hardwareTexture)||void 0===l?void 0:l.underlyingResource)||(f=this._textureHelper.createGPUTextureForInternalTexture(t,h,d));const p=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._textureHelper.updateTexture(p,t,h,d,t.depth,f.format,n,s,t.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(t,i,n=0,s=0){this._uploadDataToTextureDirectly(t,i,n,s)}_uploadImageToTexture(t,i,n=0,s=0){var a;let o=t._hardwareTexture;if((null===(a=t._hardwareTexture)||void 0===a?void 0:a.underlyingResource)||(o=this._textureHelper.createGPUTextureForInternalTexture(t)),i instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const l=i,c=Math.ceil(t.width/(1<<s)),u=Math.ceil(t.height/(1<<s));this._textureHelper.updateTexture(l,t,c,u,t.depth,o.format,n,s,t.invertY,!1,0,0)}readPixels(t,i,n,s,a=!0,o=!0){const c=(this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper).colorAttachmentGPUTextures[0];if(!c)return Promise.resolve(new Uint8Array(0));const u=c.underlyingResource,h=c.format;return u?(o&&this.flushFramebuffer(),this._textureHelper.readPixels(u,t,i,n,s,h)):Promise.resolve(new Uint8Array(0))}beginFrame(){super.beginFrame()}endFrame(){if(this._snapshotRendering.endFrame(this._mainRenderPassWrapper.renderPass),this._endMainRenderPass(),this._timestampQuery.endFrame(this._renderEncoder),this.flushFramebuffer(!1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters")),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const t=[];for(const i in He._UpdatedUbosInFrame)t.push(i+":"+He._UpdatedUbosInFrame[i]);console.log("frame #"+this._count+" - updated ubos -",t.join(", "))}He._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,super.endFrame(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))}flushFramebuffer(t=!0){const i=!this._currentRenderPass;let n=0;this._currentRenderPass&&this._currentRenderTarget&&(n|=1,this._endRenderTargetRenderPass()),this._mainRenderPassWrapper.renderPass&&(n|=2,this._endMainRenderPass()),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset(),this._bundleListRenderTarget.reset(),t&&(2&n&&this._startMainRenderPass(!1),1&n&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),i&&this._currentRenderTarget&&(this._currentRenderPass=null))}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentRenderTarget}_startRenderTargetRenderPass(t,i,n,s,a){var o,l,c;const u=t,h=u._depthStencilTexture,d=null==h?void 0:h._hardwareTexture,f=null==d?void 0:d.underlyingResource,p=null==d?void 0:d.msaaTexture,g=null==f?void 0:f.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),_=null==p?void 0:p.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),m=!!d&&Ai.HasStencilAspect(d.format),T=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const v=i&&n,A=i&&s,S=i&&a;if(u._attachments&&u.isMulti){(!this._mrtAttachments||0===this._mrtAttachments.length)&&(this._mrtAttachments=u._defaultAttachments);for(let x=0;x<this._mrtAttachments.length;++x){const C=this._mrtAttachments[x],R=u.textures[x],D=null==R?void 0:R._hardwareTexture,P=null==D?void 0:D.underlyingResource;if(D&&P){const N=Gp(Mi({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{format:D.format}),k=D.msaaTexture,X=P.createView(N),ne=null==k?void 0:k.createView(N);T.push({view:ne||X,resolveTarget:k?X:void 0,clearValue:0!==C&&v?n:void 0,loadOp:0!==C&&v?an.Clear:an.Load,storeOp:$r.Store})}}this._cacheRenderPipeline.setMRT(u.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const x=u.texture;if(x){const C=x._hardwareTexture,D=C.msaaTexture,P=C.underlyingResource.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),N=null==D?void 0:D.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);T.push({view:N||P,resolveTarget:D?P:void 0,clearValue:v?n:void 0,loadOp:v?an.Clear:an.Load,storeOp:$r.Store})}else T.push(null)}if(null===(o=this._debugPushGroup)||void 0===o||o.call(this,"render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:T,depthStencilAttachment:h&&f?{view:_||g,depthClearValue:A?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:A?an.Clear:an.Load,depthStoreOp:$r.Store,stencilClearValue:u._depthStencilTextureWithStencil&&S?this._clearStencilValue:void 0,stencilLoadOp:m?u._depthStencilTextureWithStencil&&S?an.Clear:an.Load:void 0,stencilStoreOp:m?$r.Store:void 0}:void 0,occlusionQuerySet:(null===(l=this._occlusionQuery)||void 0===l?void 0:l.hasQueries)?this._occlusionQuery.querySet:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const x=u.texture;console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",x.uniqueId,"width=",x.width,"height=",x.height,this._rttRenderPassWrapper.renderPassDescriptor)}this._currentRenderPass=this._rttRenderPassWrapper.renderPass,null===(c=this._debugFlushPendingCommands)||void 0===c||c.call(this),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),(!d||!Ai.HasStencilAspect(d.format))&&(this._stencilStateComposer.enabled=!1)}_endRenderTargetRenderPass(){var t,i,n,s;if(this._currentRenderPass){const a=null===(t=this._currentRenderTarget.texture)||void 0===t?void 0:t._hardwareTexture;a&&!this._snapshotRendering.endRenderTargetPass(this._currentRenderPass,a)&&!this.compatibilityMode&&(this._bundleListRenderTarget.run(this._currentRenderPass),this._bundleListRenderTarget.reset()),this._currentRenderPass.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",null===(n=null===(i=this._currentRenderTarget)||void 0===i?void 0:i.texture)||void 0===n?void 0:n.uniqueId)),null===(s=this._debugPopGroup)||void 0===s||s.call(this,1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset()}}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassIndex(){return null===this._currentRenderPass?-1:this._currentRenderPass===this._mainRenderPassWrapper.renderPass?0:1}_startMainRenderPass(t,i,n,s){var a,o,l;this._mainRenderPassWrapper.renderPass&&this.flushFramebuffer(!1),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const c=t&&i,u=t&&n,h=t&&s;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=c?i:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=c?an.Clear:an.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=u?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=u?an.Clear:an.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=h?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?h?an.Clear:an.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=(null===(a=this._occlusionQuery)||void 0===a?void 0:a.hasQueries)?this._occlusionQuery.querySet:void 0;const d=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(d),this._options.antialias?(sF.format=d.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=d.createView(sF)):(aF.format=d.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=d.createView(aF)),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),null===(o=this._debugPushGroup)||void 0===o||o.call(this,"main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,null===(l=this._debugFlushPendingCommands)||void 0===l||l.call(this),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}_endMainRenderPass(){var t;null!==this._mainRenderPassWrapper.renderPass&&(this._snapshotRendering.endMainRenderPass(),!this.compatibilityMode&&!this._snapshotRendering.play&&(this._bundleList.run(this._mainRenderPassWrapper.renderPass),this._bundleList.reset()),this._mainRenderPassWrapper.renderPass.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),null===(t=this._debugPopGroup)||void 0===t||t.call(this,0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))}bindFramebuffer(t,i=0,n,s,a,o=0,l=0){var c,u;const h=null===(c=t.texture)||void 0===c?void 0:c._hardwareTexture;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,h&&(h._currentLayer=t.isCube?6*l+i:l),this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=h,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?Ai.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:fi.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?6*l+i:l,baseMipLevel:o,arrayLayerCount:1,aspect:ta.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:fi.E2d,mipLevelCount:1,baseArrayLayer:t.isCube?6*l+i:l,baseMipLevel:0,arrayLayerCount:1,aspect:ta.All},this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - internalTexture.uniqueId=",null===(u=t.texture)||void 0===u?void 0:u.uniqueId,"face=",i,"lodLevel=",o,"layer=",l,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this.snapshotRendering&&1===this.snapshotRenderingMode&&this._getCurrentRenderPass(),this._cachedViewport&&!a?this.setViewport(this._cachedViewport,n,s):(n||(n=t.width,o&&(n/=Math.pow(2,o))),s||(s=t.height,o&&(s/=Math.pow(2,o))),this._viewport(0,0,n,s)),this.wipeCaches()}unBindFramebuffer(t,i=!1,n){var s,a;const o=this._currentRenderTarget;this._currentRenderTarget=null,n&&n(),this._currentRenderTarget=o,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),(null===(s=t.texture)||void 0===s?void 0:s.generateMipMaps)&&!i&&!t.isCube&&this._generateMipmaps(t.texture),this._currentRenderTarget=null,this._onAfterUnbindFrameBufferObservable.notifyObservers(this),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - unBindFramebuffer called - internalTexture.uniqueId=",null===(a=t.texture)||void 0===a?void 0:a.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(t){var i,n;const s=null!==(n=null===(i=t.colorAttachmentGPUTextures[0])||void 0===i?void 0:i.format)&&void 0!==n?n:null;this._cacheRenderPipeline.setColorFormat(s),this._colorFormat!==s&&(this._colorFormat=s)}_setDepthTextureFormat(t){this._cacheRenderPipeline.setDepthStencilFormat(t.depthTextureFormat),this._depthTextureFormat!==t.depthTextureFormat&&(this._depthTextureFormat=t.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}setState(t,i=0,n,s=!1,a,o,l=0){var c,u;(this._depthCullingState.cull!==t||n)&&(this._depthCullingState.cull=t);const h=null===(u=null!==(c=this.cullBackFaces)&&void 0!==c?c:a)||void 0===u||u?1:2;(this._depthCullingState.cullFace!==h||n)&&(this._depthCullingState.cullFace=h),this.setZOffset(i),this.setZOffsetUnits(l);const d=s?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==d||n)&&(this._depthCullingState.frontFace=d),this._stencilStateComposer.stencilMaterial=o}_applyRenderPassChanges(t,i){var n;const s=this._mustUpdateViewport(t),a=this._mustUpdateScissor(t),o=!!this._stencilStateComposer.enabled&&this._mustUpdateStencilRef(t),l=!!this._alphaState.alphaBlend&&this._mustUpdateBlendColor(t);i?(s&&i.addItem(new FE(this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w)),a&&i.addItem(new Lh(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),o&&i.addItem(new Bh(null!==(n=this._stencilStateComposer.funcRef)&&void 0!==n?n:0)),l&&i.addItem(new NE(this._alphaState._blendConstants.slice()))):(s&&this._applyViewport(t),a&&this._applyScissor(t),o&&this._applyStencilRef(t),l&&this._applyBlendColor(t))}_draw(t,i,n,s,a){var o;const l=this._getCurrentRenderPass(),u=0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget;this.applyStates();const h=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,Oi.InternalsUBOName),h.uniformBuffer&&(h.uniformBuffer.update(),this.bindUniformBufferBase(h.uniformBuffer.getBuffer(),0,Oi.LeftOvertUBOName)),this._snapshotRendering.play)return void this._reportDrawCall();!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let f=l;if(!this.compatibilityMode&&this._currentDrawContext.fastBundle||this._snapshotRendering.record){if(this._applyRenderPassChanges(l,u),!this._snapshotRendering.record)return this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(s,a||1,n),u.addBundle(this._currentDrawContext.fastBundle),void this._reportDrawCall();f=u.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),u.numDrawCalls++}let p=0;if(!this._caps.textureFloatLinearFiltering&&this._currentMaterialContext.hasFloatTextures){let v=1;for(let A=0;A<h.shaderProcessingContext.textureNames.length;++A){const x=null===(o=this._currentMaterialContext.textures[h.shaderProcessingContext.textureNames[A]])||void 0===o?void 0:o.texture;1===(null==x?void 0:x.type)&&(p|=v),v<<=1}}const g=this._cacheRenderPipeline.getRenderPipeline(i,this._currentEffect,this.currentSampleCount,p),_=this._cacheBindGroups.getBindGroups(h,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(l,this.compatibilityMode?null:u),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,f=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:this.currentSampleCount}))),f.setPipeline(g),this._currentIndexBuffer&&f.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?ho.Uint32:ho.Uint16,0);const m=this._cacheRenderPipeline.vertexBuffers;for(let v=0;v<m.length;v++){const A=m[v],S=A.getBuffer();S&&f.setVertexBuffer(v,S.underlyingResource,A._validOffsetRange?0:A.byteOffset)}for(let v=0;v<_.length;v++)f.setBindGroup(v,_[v]);const T=!this.compatibilityMode&&!this._snapshotRendering.record;T&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(s,a||1,n),0===t?f.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):f.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):0===t?f.drawIndexed(s,a||1,n,0,0):f.draw(s,a||1,n,0),T&&(this._currentDrawContext.fastBundle=f.finish(),u.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(t,i,n,s=1){this._draw(0,t,i,n,s)}drawArraysType(t,i,n,s=1){this._currentIndexBuffer=null,this._draw(1,t,i,n,s)}dispose(){var t,i;this._isDisposed=!0,null===(t=this._mainTexture)||void 0===t||t.destroy(),null===(i=this._depthTexture)||void 0===i||i.destroy(),this._device.destroy(),super.dispose()}getRenderWidth(t=!1){var i,n;return!t&&this._currentRenderTarget?this._currentRenderTarget.width:null!==(n=null===(i=this._renderingCanvas)||void 0===i?void 0:i.width)&&void 0!==n?n:0}getRenderHeight(t=!1){var i,n;return!t&&this._currentRenderTarget?this._currentRenderTarget.height:null!==(n=null===(i=this._renderingCanvas)||void 0===i?void 0:i.height)&&void 0!==n?n:0}getError(){return 0}bindSamplers(){}_bindTextureDirectly(){return!1}areAllEffectsReady(){return!0}_executeWhenRenderingStateIsCompiled(t,i){i()}_isRenderingStateCompiled(){return!0}_getUnpackAlignement(){return 1}_unpackFlipY(){}_bindUnboundFramebuffer(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"}_getSamplingParameters(){throw"_getSamplingParameters is not available in WebGPU"}getUniforms(){return[]}setIntArray(){return!1}setIntArray2(){return!1}setIntArray3(){return!1}setIntArray4(){return!1}setArray(){return!1}setArray2(){return!1}setArray3(){return!1}setArray4(){return!1}setMatrices(){return!1}setMatrix3x3(){return!1}setMatrix2x2(){return!1}setFloat(){return!1}setFloat2(){return!1}setFloat3(){return!1}setFloat4(){return!1}}return r._GLSLslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"},r.UseTWGSL=!0,r})();ft.prototype.setAlphaMode=function(r,e=!1){if(this._alphaMode===r&&(0===r&&!this._alphaState.alphaBlend||0!==r&&this._alphaState.alphaBlend)){if(!e){const t=0===r;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}}else{switch(r){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0}e||(this.setDepthWrite(r===Ve.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(r===Ve.ALPHA_DISABLE)),this._alphaMode=r,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},ft.prototype.setAlphaEquation=function(r){Ve.prototype.setAlphaEquation.call(this,r),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};let K6=(()=>{class r{constructor(t,i,n,s=""){var a,o;let l;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new J,this.onErrorObservable=new J,this.onBindObservable=new J,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=Ri.WGSL,this.name=t,this._key=s,this._engine=n,this.uniqueId=r._UniqueIdSeed++,this.defines=null!==(a=i.defines)&&void 0!==a?a:"",this.onError=i.onError,this.onCompiled=i.onCompiled,this._entryPoint=null!==(o=i.entryPoint)&&void 0!==o?o:"main",this._shaderStore=Z.GetShadersStore(this._shaderLanguage),this._shaderRepository=Z.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=Z.GetIncludesShadersStore(this._shaderLanguage);const c=rn()?this._engine.getHostDocument():null;t.computeSource?l="source:"+t.computeSource:t.computeElement?(l=c?c.getElementById(t.computeElement):null,l||(l=t.computeElement)):l=t.compute||t;const u={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};this._loadShader(l,"Compute","",h=>{Aa.Initialize(u),Aa.PreProcess(h,u,d=>{this._rawComputeSourceCode=h,i.processFinalCode&&(d=i.processFinalCode(d));const f=Aa.Finalize(d,"",u);this._useFinalCode(f.vertexCode,t)},this._engine)})}_useFinalCode(t,i){this._computeSourceCode=i?"//#define SHADER_NAME compute:"+(i.computeElement||i.compute||i.spectorName||i)+"\n"+t:t,this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch(t){return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(t){this.isReady()?t(this):(this.onCompileObservable.add(i=>{t(i)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16))}_checkIsReady(t){try{if(this._isReadyInternal())return}catch(i){return void this._processCompilationErrors(i,t)}setTimeout(()=>{this._checkIsReady(t)},16)}_loadShader(t,i,n,s){if("undefined"!=typeof HTMLElement&&t instanceof HTMLElement)return void s(If(t));if("source:"===t.substr(0,7))return void s(t.substr(7));if("base64:"===t.substr(0,7))return void s(window.atob(t.substr(7)));if(this._shaderStore[t+i+"Shader"])return void s(this._shaderStore[t+i+"Shader"]);if(n&&this._shaderStore[t+n+"Shader"])return void s(this._shaderStore[t+n+"Shader"]);let a;a="."===t[0]||"/"===t[0]||t.indexOf("http")>-1?t:this._shaderRepository+t,this._engine._loadFile(a+"."+i.toLowerCase()+".fx",s)}get computeSourceCode(){var t,i;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:null!==(i=null===(t=this._pipelineContext)||void 0===t?void 0:t._getComputeShaderCode())&&void 0!==i?i:this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const n=this._engine;this._pipelineContext=n.createComputePipelineContext(),this._pipelineContext._name=this._key,n._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:t,this._entryPoint),n._executeWhenComputeStateIsCompiled(this._pipelineContext,()=>{this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),i&&this.getEngine()._deleteComputePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(n){this._processCompilationErrors(n,i)}}_getShaderCodeAndErrorLine(t,i){let s=null;if(i&&t){const a=i.match(/COMPUTE SHADER ERROR: 0:(\d+?):/);if(a&&2===a.length){const o=parseInt(a[1]),l=t.split("\n",-1);l.length>=o&&(s=`Offending line [${o}] in compute code: ${l[o-1]}`)}}return[t,s]}_processCompilationErrors(t,i=null){var n;if(this._compilationError=t.message,H.Error("Unable to compile compute effect:"),H.Error("Defines:\r\n"+this.defines),r.LogShaderCodeOnCompilationError){let s=null,a=null;(null===(n=this._pipelineContext)||void 0===n?void 0:n._getComputeShaderCode())&&([a,s]=this._getShaderCodeAndErrorLine(this._pipelineContext._getComputeShaderCode(),this._compilationError),a&&(H.Error("Compute code:"),H.Error(a))),s&&H.Error(s)}H.Error("Error: "+this._compilationError),i&&(this._pipelineContext=i,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this))}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(t,i){Z.GetShadersStore(Ri.WGSL)[`${t}ComputeShader`]=i}}return r._UniqueIdSeed=0,r.LogShaderCodeOnCompilationError=!0,r})(),Q6=(()=>{class r{getBindGroups(t,i,n){if(!n)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const s=this._bindGroupEntries.length>0;for(const a in t){const o=t[a],l=n[a],c=l.group,u=l.binding,h=o.type,d=o.object;let f=o.indexInGroupEntries,p=this._bindGroupEntries[c];switch(p||(p=this._bindGroupEntries[c]=[]),h){case Ms.Sampler:{const g=d;void 0!==f&&s?p[f].resource=this._cacheSampler.getSampler(g):(o.indexInGroupEntries=p.length,p.push({binding:u,resource:this._cacheSampler.getSampler(g)}));break}case Ms.Texture:case Ms.TextureWithoutSampler:{const g=d,_=g._texture._hardwareTexture;void 0!==f&&s?(h===Ms.Texture&&(p[f++].resource=this._cacheSampler.getSampler(g._texture)),p[f].resource=_.view):(o.indexInGroupEntries=p.length,h===Ms.Texture&&p.push({binding:u-1,resource:this._cacheSampler.getSampler(g._texture)}),p.push({binding:u,resource:_.view}));break}case Ms.StorageTexture:{const g=d,_=g._texture._hardwareTexture;0==(_.textureAdditionalUsages&yi.StorageBinding)&&H.Error(`computeDispatch: The texture (name=${g.name}, uniqueId=${g.uniqueId}) is not a storage texture!`,50),void 0!==f&&s?p[f].resource=_.viewForWriting:(o.indexInGroupEntries=p.length,p.push({binding:u,resource:_.viewForWriting}));break}case Ms.UniformBuffer:case Ms.StorageBuffer:{const _=d.getBuffer(),m=_.underlyingResource;void 0!==f&&s?(p[f].resource.buffer=m,p[f].resource.size=_.capacity):(o.indexInGroupEntries=p.length,p.push({binding:u,resource:{buffer:m,offset:0,size:_.capacity}}));break}}}for(let a=0;a<this._bindGroupEntries.length;++a){const o=this._bindGroupEntries[a];this._bindGroups[a]=o?this._device.createBindGroup({layout:i.getBindGroupLayout(a),entries:o}):void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(t,i){this._device=t,this._cacheSampler=i,this.uniqueId=r._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}return r._Counter=0,r})();class Z6{get isAsync(){return!1}get isReady(){return!!this.stage}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.compute}dispose(){}}ft.prototype.createComputeContext=function(){return new Q6(this._device,this._cacheSampler)},ft.prototype.createComputeEffect=function(r,e){const i=(r.computeElement||r.compute||r.computeToken||r.computeSource||r)+"@"+e.defines;if(this._compiledComputeEffects[i]){const s=this._compiledComputeEffects[i];return e.onCompiled&&s.isReady()&&e.onCompiled(s),s}const n=new K6(r,e,this,i);return this._compiledComputeEffects[i]=n,n},ft.prototype.createComputePipelineContext=function(){return new Z6(this)},ft.prototype.areAllComputeEffectsReady=function(){for(const r in this._compiledComputeEffects)if(!this._compiledComputeEffects[r].isReady())return!1;return!0},ft.prototype.computeDispatch=function(r,e,t,i,n,s,a){if(this._currentRenderTarget)return void this._onAfterUnbindFrameBufferObservable.addOnce(()=>{this.computeDispatch(r,e,t,i,n,s,a)});const o=r._pipelineContext,l=e;o.computePipeline||(o.computePipeline=this._device.createComputePipeline({layout:Jc.Auto,compute:o.stage}));const u=this._renderTargetEncoder.beginComputePass();u.setPipeline(o.computePipeline);const h=l.getBindGroups(t,o.computePipeline,a);for(let d=0;d<h.length;++d){const f=h[d];!f||u.setBindGroup(d,f)}u.dispatchWorkgroups(i,n,s),u.end()},ft.prototype.releaseComputeEffects=function(){for(const r in this._compiledComputeEffects){const e=this._compiledComputeEffects[r].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}},ft.prototype._prepareComputePipelineContext=function(r,e,t,i,n){const s=r;this.dbgShowShaderCode&&(console.log(i),console.log(e)),s.sources={compute:e,rawCompute:t},s.stage=this._createComputePipelineStageDescriptor(e,i,n)},ft.prototype._releaseComputeEffect=function(r){this._compiledComputeEffects[r._key]&&(delete this._compiledComputeEffects[r._key],this._deleteComputePipelineContext(r.getPipelineContext()))},ft.prototype._rebuildComputeEffects=function(){for(const r in this._compiledComputeEffects){const e=this._compiledComputeEffects[r];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}},ft.prototype._deleteComputePipelineContext=function(r){r&&r.dispose()},ft.prototype._createComputePipelineStageDescriptor=function(r,e,t){return e=e?"//"+e.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:e+r}),entryPoint:t}},ft.prototype._createDepthStencilCubeTexture=function(r,e){const t=new hi(this,vt.DepthStencil);t.isCube=!0;const i=Mi({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},e);return t.format=i.generateStencil?13:14,this._setupDepthStencilTexture(t,r,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t},ft.prototype.createCubeTexture=function(r,e,t,i,n=null,s=null,a,o=null,l=!1,c=0,u=0,h=null,d=!1){return this.createCubeTextureBase(r,e,t,!!i,n,s,a,o,l,c,u,h,null,(f,p)=>{const g=p,_=g[0].width,m=_;this._setCubeMapTextureParams(f,!i),f.format=null!=a?a:-1;const T=this._textureHelper.createGPUTextureForInternalTexture(f,_,m);this._textureHelper.updateCubeTextures(g,T.underlyingResource,_,m,T.format,!1,!1,0,0),i||this._generateMipmaps(f,this._uploadEncoder),f.isReady=!0,f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),n&&n()},!!d)},ft.prototype._setCubeMapTextureParams=function(r,e,t){r.samplingMode=e?3:2,r._cachedWrapU=0,r._cachedWrapV=0,t&&(r._maxLodLevel=t)},ft.prototype._debugPushGroup=function(r,e){!this._options.enableGPUDebugMarkers||(0===e||1===e?(0===e?this._renderEncoder:this._renderTargetEncoder).pushDebugGroup(r):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(r):this._pendingDebugCommands.push(["push",r]))},ft.prototype._debugPopGroup=function(r){!this._options.enableGPUDebugMarkers||(0===r||1===r?(0===r?this._renderEncoder:this._renderTargetEncoder).popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))},ft.prototype._debugInsertMarker=function(r,e){!this._options.enableGPUDebugMarkers||(0===e||1===e?(0===e?this._renderEncoder:this._renderTargetEncoder).insertDebugMarker(r):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(r):this._pendingDebugCommands.push(["insert",r]))},ft.prototype._debugFlushPendingCommands=function(){for(let r=0;r<this._pendingDebugCommands.length;++r){const[e,t]=this._pendingDebugCommands[r];switch(e){case"push":this._debugPushGroup(t);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(t)}}this._pendingDebugCommands.length=0},ft.prototype.updateDynamicIndexBuffer=function(r,e,t=0){const i=r;let n;n=r.is32Bits?e instanceof Uint32Array?e:new Uint32Array(e):e instanceof Uint16Array?e:new Uint16Array(e),this._bufferManager.setSubData(i,t,n)},ft.prototype.updateDynamicVertexBuffer=function(r,e,t,i){const n=r;let s;void 0===t&&(t=0),void 0===i?(s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,i=s.byteLength):s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,this._bufferManager.setSubData(n,t,s,0,i)},ft.prototype.updateDynamicTexture=function(r,e,t,i=!1,n,s,a){var o;if(!r)return;const l=e.width,c=e.height;let u=r._hardwareTexture;(null===(o=r._hardwareTexture)||void 0===o?void 0:o.underlyingResource)||(u=this._textureHelper.createGPUTextureForInternalTexture(r,l,c)),this._textureHelper.updateTexture(e,r,l,c,r.depth,u.format,0,0,t,i,0,0,a),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0};class q6 extends uw{constructor(e){super(e)}}function Uh(r,e,t,i){let n,s=1;1===i?n=new Float32Array(e*t*4):2===i?(n=new Uint16Array(e*t*4),s=15360):n=7===i?new Uint32Array(e*t*4):new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){const l=3*(o*e+a),c=4*(o*e+a);n[c+0]=r[l+0],n[c+1]=r[l+1],n[c+2]=r[l+2],n[c+3]=s}return n}Si.prototype.setExternalTexture=function(r,e){this._engine.setExternalTexture(r,e)},ft.prototype.createExternalTexture=function(r){return new q6(r)},ft.prototype.setExternalTexture=function(r,e){e?this._setInternalTexture(r,e):this._currentMaterialContext.setTexture(r,null)},ft.prototype.unBindMultiColorAttachmentFramebuffer=function(r,e=!1,t){t&&t();const n=r._attachments.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(let s=0;s<n;s++){const a=r.textures[s];a.generateMipMaps&&!e&&!a.isCube&&this._generateMipmaps(a)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)},ft.prototype.createMultipleRenderTarget=function(r,e,t){var i;let n=!1,s=!0,a=!1,o=!1,l=15,c=1,p=new Array,g=new Array,_=new Array,m=new Array;const T=this._createHardwareRenderTargetWrapper(!0,!1,r);void 0!==e&&(n=void 0!==e.generateMipMaps&&e.generateMipMaps,s=void 0===e.generateDepthBuffer||e.generateDepthBuffer,a=void 0!==e.generateStencilBuffer&&e.generateStencilBuffer,o=void 0!==e.generateDepthTexture&&e.generateDepthTexture,c=e.textureCount||1,l=null!==(i=e.depthTextureFormat)&&void 0!==i?i:15,e.types&&(p=e.types),e.samplingModes&&(g=e.samplingModes),e.useSRGBBuffers&&(_=e.useSRGBBuffers),e.formats&&(m=e.formats));const v=r.width||r,A=r.height||r;let S=null;(s||a||o)&&(o||(l=s&&a?13:s?14:19),S=T.createDepthStencilTexture(0,!1,a,1,l));const x=[],C=[],R=[];T._generateDepthBuffer=s,T._generateStencilBuffer=a,T._attachments=C,T._defaultAttachments=R;for(let D=0;D<c;D++){let P=g[D]||3,N=p[D]||0;const k=_[D]||!1,X=m[D]||5;(1===N&&!this._caps.textureFloatLinearFiltering||2===N&&!this._caps.textureHalfFloatLinearFiltering)&&(P=1),1===N&&!this._caps.textureFloat&&(N=0,H.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const ne=new hi(this,vt.MultiRenderTarget);x.push(ne),C.push(D+1),R.push(t?D+1:0===D?1:0),ne.baseWidth=v,ne.baseHeight=A,ne.width=v,ne.height=A,ne.isReady=!0,ne.samples=1,ne.generateMipMaps=n,ne.samplingMode=P,ne.type=N,ne._cachedWrapU=0,ne._cachedWrapV=0,ne._useSRGBBuffer=k,ne.format=X,this._internalTexturesCache.push(ne),this._textureHelper.createGPUTextureForInternalTexture(ne)}return S&&(S.incrementReferences(),x.push(S),this._internalTexturesCache.push(S)),T.setTextures(x),T},ft.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,e){if(!r||!r.textures||r.textures[0].samples===e)return e;const t=r.textures.length;if(0===t)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let i=0;i<t;++i){const n=r.textures[i];this._textureHelper.createMSAATexture(n,e),n.samples=e}return r._depthStencilTexture&&r._depthStencilTexture!==r.textures[r.textures.length-1]&&(this._textureHelper.createMSAATexture(r._depthStencilTexture,e),r._depthStencilTexture.samples=e),e},ft.prototype.bindAttachments=function(r){0===r.length||!this._currentRenderTarget||(this._mrtAttachments=r,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(r))},ft.prototype.buildTextureLayout=function(r){const e=[];for(let t=0;t<r.length;t++)e.push(r[t]?t+1:0);return e},ft.prototype.restoreSingleAttachment=function(){},ft.prototype.restoreSingleAttachmentForRenderTarget=function(){},ft.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},ft.prototype.captureGPUFrameTime=function(r){this._timestampQuery.enable=r&&!!this._caps.timerQuery},ft.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},ft.prototype.deleteQuery=function(r){return this._occlusionQuery.deleteQuery(r),this},ft.prototype.isQueryResultAvailable=function(r){return this._occlusionQuery.isQueryResultAvailable(r)},ft.prototype.getQueryResult=function(r){return this._occlusionQuery.getQueryResult(r)},ft.prototype.beginOcclusionQuery=function(r,e){var t;return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery&&(null===(t=this._currentRenderPass)||void 0===t||t.beginOcclusionQuery(e),!0):((0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget).addItem(new LE(e)),!0)},ft.prototype.endOcclusionQuery=function(){var r;return this.compatibilityMode?null===(r=this._currentRenderPass)||void 0===r||r.endOcclusionQuery():(0===this._getCurrentRenderPassIndex()?this._bundleList:this._bundleListRenderTarget).addItem(new BE),this},ft.prototype.createRawTexture=function(r,e,t,i,n,s,a,o=null,l=0,c=0,u=!1){const h=new hi(this,vt.Raw);return h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=n,h.samplingMode=a,h.invertY=s,h._compression=o,h.type=l,h._useSRGBBuffer=u,this._doNotHandleContextLost||(h._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(h,e,t,void 0,c),this.updateRawTexture(h,r,i,s,o,l,u),this._internalTexturesCache.push(h),h},ft.prototype.updateRawTexture=function(r,e,t,i,n=null,s=0,a=!1){if(r){if(this._doNotHandleContextLost||(r._bufferView=e,r.invertY=i,r._compression=n,r._useSRGBBuffer=a),e){const o=r._hardwareTexture;4===t&&(e=Uh(e,r.width,r.height,s));const c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,r,r.width,r.height,r.depth,o.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0}},ft.prototype.createRawCubeTexture=function(r,e,t,i,n,s,a,o=null){const l=new hi(this,vt.CubeRaw);return 1!==i||this._caps.textureFloatLinearFiltering?2!==i||this._caps.textureHalfFloatLinearFiltering?1!==i||this._caps.textureFloatRender?2===i&&!this._caps.colorBufferFloat&&(n=!1,H.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,H.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,a=1,H.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,a=1,H.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),l.isCube=!0,l.format=4===t?5:t,l.type=i,l.generateMipMaps=n,l.width=e,l.height=e,l.samplingMode=a,this._doNotHandleContextLost||(l._bufferViewArray=r),l.invertY=s,l._compression=o,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),r&&this.updateRawCubeTexture(l,r,t,i,s,o),l.isReady=!0,l},ft.prototype.updateRawCubeTexture=function(r,e,t,i,n,s=null){r._bufferViewArray=e,r.invertY=n,r._compression=s;const a=r._hardwareTexture,o=4===t,l=[];for(let c=0;c<e.length;++c){let u=e[c];o&&(u=Uh(e[c],r.width,r.height,i)),l.push(new Uint8Array(u.buffer,u.byteOffset,u.byteLength))}this._textureHelper.updateCubeTextures(l,a.underlyingResource,r.width,r.height,a.format,n,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0},ft.prototype.createRawCubeTextureFromUrl=function(r,e,t,i,n,s,a,o,l=null,c=null,u=3,h=!1){const d=this.createRawCubeTexture(null,t,i,n,!s,h,u,null);null==e||e.addPendingData(d),d.url=r,this._internalTexturesCache.push(d);const p=g=>{const _=d.width,m=a(g);if(!m)return;const T=[0,2,4,1,3,5];if(o){const v=4===i,A=o(m),S=d._hardwareTexture,x=[0,1,2,3,4,5];for(let C=0;C<A.length;C++){const R=_>>C,D=[];for(let P=0;P<6;P++){let N=A[C][x[P]];v&&(N=Uh(N,R,R,n)),D.push(new Uint8Array(N.buffer,N.byteOffset,N.byteLength))}this._textureHelper.updateCubeTextures(D,S.underlyingResource,R,R,S.format,h,!1,0,0)}}else{const v=[];for(let A=0;A<6;A++)v.push(m[T[A]]);this.updateRawCubeTexture(d,v,i,n,h)}d.isReady=!0,null==e||e.removePendingData(d),l&&l()};return this._loadFile(r,g=>{p(g)},void 0,null==e?void 0:e.offlineProvider,!0,(g,_)=>{null==e||e.removePendingData(d),c&&g&&c(g.status+" "+g.statusText,_)}),d},ft.prototype.createRawTexture3D=function(r,e,t,i,n,s,a,o,l=null,c=0,u=0){const d=new hi(this,vt.Raw3D);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=n,d.type=c,d.generateMipMaps=s,d.samplingMode=o,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,void 0,u),this.updateRawTexture3D(d,r,n,a,l,c),this._internalTexturesCache.push(d),d},ft.prototype.updateRawTexture3D=function(r,e,t,i,n=null,s=0){if(this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.invertY=i,r._compression=n),e){const a=r._hardwareTexture;4===t&&(e=Uh(e,r.width,r.height,s));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,r,r.width,r.height,r.depth,a.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0},ft.prototype.createRawTexture2DArray=function(r,e,t,i,n,s,a,o,l=null,c=0,u=0){const d=new hi(this,vt.Raw2DArray);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=n,d.type=c,d.generateMipMaps=s,d.samplingMode=o,d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=r),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,i,u),this.updateRawTexture2DArray(d,r,n,a,l,c),this._internalTexturesCache.push(d),d},ft.prototype.updateRawTexture2DArray=function(r,e,t,i,n=null,s=0){if(this._doNotHandleContextLost||(r._bufferView=e,r.format=t,r.invertY=i,r._compression=n),e){const a=r._hardwareTexture;4===t&&(e=Uh(e,r.width,r.height,s));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,r,r.width,r.height,r.depth,a.format,0,0,i,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder)}r.isReady=!0},ft.prototype._readTexturePixels=function(r,e,t,i=-1,n=0,s=null,a=!0,o=!1,l=0,c=0){const u=r._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(u.underlyingResource,l,c,e,t,u.format,i,n,s,o)},ft.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};class J6 extends hT{}ft.prototype._createHardwareRenderTargetWrapper=function(r,e,t){const i=new J6(r,e,t,this);return this._renderTargetWrapperCache.push(i),i},ft.prototype.createRenderTargetTexture=function(r,e){var t,i;const n=this._createHardwareRenderTargetWrapper(!1,!1,r),s={};void 0!==e&&"object"==typeof e?(s.generateMipMaps=e.generateMipMaps,s.generateDepthBuffer=void 0===e.generateDepthBuffer||e.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&e.generateStencilBuffer,s.samplingMode=void 0===e.samplingMode?3:e.samplingMode,s.creationFlags=null!==(t=e.creationFlags)&&void 0!==t?t:0,s.noColorAttachment=!!e.noColorAttachment,s.samples=e.samples,s.label=e.label):(s.generateMipMaps=e,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.samplingMode=3,s.creationFlags=0,s.noColorAttachment=!1);const a=s.noColorAttachment?null:this._createInternalTexture(r,e,!0,vt.RenderTarget);return n._samples=null!==(i=s.samples)&&void 0!==i?i:1,n._generateDepthBuffer=s.generateDepthBuffer,n._generateStencilBuffer=!!s.generateStencilBuffer,n.setTextures(a),(n._generateDepthBuffer||n._generateStencilBuffer)&&n.createDepthStencilTexture(0,this._caps.textureFloatLinearFiltering&&(void 0===s.samplingMode||2===s.samplingMode||2===s.samplingMode||3===s.samplingMode||3===s.samplingMode||5===s.samplingMode||6===s.samplingMode||7===s.samplingMode||11===s.samplingMode),n._generateStencilBuffer,n.samples,s.generateStencilBuffer?13:14,s.label?s.label+"-DepthStencil":void 0),a&&(void 0!==e&&"object"==typeof e&&e.createMipMaps&&!s.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,void 0,void 0,void 0,s.creationFlags),void 0!==e&&"object"==typeof e&&e.createMipMaps&&!s.generateMipMaps&&(a.generateMipMaps=!1)),n},ft.prototype._createDepthStencilTexture=function(r,e){const t=new hi(this,vt.DepthStencil);t.label=e.label;const i=Mi({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14},e);return t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,r,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t},ft.prototype._setupDepthStencilTexture=function(r,e,t,i,n,s=1){const a=e.width||e,o=e.height||e,l=e.layers||0;r.baseWidth=a,r.baseHeight=o,r.width=a,r.height=o,r.is2DArray=l>0,r.depth=l,r.isReady=!0,r.samples=s,r.generateMipMaps=!1,r.samplingMode=i?2:1,r.type=1,r._comparisonFunction=n,r._cachedWrapU=0,r._cachedWrapV=0},ft.prototype.updateRenderTargetTextureSampleCount=function(r,e){return!r||!r.texture||r.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(r.texture,e),r._depthStencilTexture&&(this._textureHelper.createMSAATexture(r._depthStencilTexture,e),r._depthStencilTexture.samples=e),r._samples=e,r.texture.samples=e),e},ft.prototype.createRenderTargetCubeTexture=function(r,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,r),i=Mi({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;const n=new hi(this,vt.RenderTarget);return n.width=r,n.height=r,n.depth=0,n.isReady=!0,n.isCube=!0,n.samples=i.samples,n.generateMipMaps=i.generateMipMaps,n.samplingMode=i.samplingMode,n.type=i.type,n.format=i.format,this._internalTexturesCache.push(n),t.setTextures(n),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,void 0===i.samplingMode||2===i.samplingMode||2===i.samplingMode||3===i.samplingMode||3===i.samplingMode||5===i.samplingMode||6===i.samplingMode||7===i.samplingMode||11===i.samplingMode,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(n.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(n),e&&e.createMipMaps&&!i.generateMipMaps&&(n.generateMipMaps=!1),t},Si.prototype.setTextureSampler=function(r,e){this._engine.setTextureSampler(r,e)},ft.prototype.setTextureSampler=function(r,e){var t;null===(t=this._currentMaterialContext)||void 0===t||t.setSampler(r,e)},Si.prototype.setStorageBuffer=function(r,e){this._engine.setStorageBuffer(r,e)},ft.prototype.createStorageBuffer=function(r,e){return this._createBuffer(r,32|e)},ft.prototype.updateStorageBuffer=function(r,e,t,i){const n=r;let s;void 0===t&&(t=0),void 0===i?(s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,i=s.byteLength):s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,this._bufferManager.setSubData(n,t,s,0,i)},ft.prototype.readFromStorageBuffer=function(r,e,t,i){const n=this._bufferManager.createRawBuffer(t=t||r.capacity,_i.MapRead|_i.CopyDst);return this._renderTargetEncoder.copyBufferToBuffer(r.underlyingResource,null!=e?e:0,n,0,t),new Promise((s,a)=>{this.onEndFrameObservable.addOnce(()=>{n.mapAsync(Xo.Read,0,t).then(()=>{const o=n.getMappedRange(0,t);let l=i;if(void 0===l)l=new Uint8Array(t),l.set(new Uint8Array(o));else{const c=l.constructor;l=new c(l.buffer),l.set(new c(o))}n.unmap(),this._bufferManager.releaseBuffer(n),s(l)},o=>a(o))})})},ft.prototype.setStorageBuffer=function(r,e){var t,i;null===(t=this._currentDrawContext)||void 0===t||t.setBuffer(r,null!==(i=null==e?void 0:e.getBuffer())&&void 0!==i?i:null)},ft.prototype.createUniformBuffer=function(r){let e;return e=r instanceof Array?new Float32Array(r):r,this._bufferManager.createBuffer(e,_i.Uniform|_i.CopyDst)},ft.prototype.createDynamicUniformBuffer=function(r){return this.createUniformBuffer(r)},ft.prototype.updateUniformBuffer=function(r,e,t,i){void 0===t&&(t=0);const n=r;let s;void 0===i?(s=e instanceof Float32Array?e:new Float32Array(e),i=s.byteLength):s=e instanceof Float32Array?e:new Float32Array(e),this._bufferManager.setSubData(n,t,s,0,i)},ft.prototype.bindUniformBufferBase=function(r,e,t){this._currentDrawContext.setBuffer(t,r)},ft.prototype.bindUniformBlock=function(){},ft.prototype.updateVideoTexture=function(r,e,t){var i;if(!r||r._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let n=r._hardwareTexture;(null===(i=r._hardwareTexture)||void 0===i?void 0:i.underlyingResource)||(n=this._textureHelper.createGPUTextureForInternalTexture(r)),function e8(r){return!(!r||void 0===r.underlyingResource)}(e)?(this._textureHelper.copyVideoToTexture(e,r,n.format,!t),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0):e&&this.createImageBitmap(e).then(s=>{this._textureHelper.updateTexture(s,r,r.width,r.height,r.depth,n.format,0,0,!t,!1,0,0),r.generateMipMaps&&this._generateMipmaps(r,this._uploadEncoder),r.isReady=!0}).catch(()=>{r.isReady=!0})},cs.prototype.removeReflectionProbe=function(r){if(!this.reflectionProbes)return-1;const e=this.reflectionProbes.indexOf(r);return-1!==e&&this.reflectionProbes.splice(e,1),e},cs.prototype.addReflectionProbe=function(r){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(r)};class iu{constructor(e,t,i,n=!0,s=!1,a=!1){if(this.name=e,this._viewMatrix=B.Identity(),this._target=E.Zero(),this._add=E.Zero(),this._invertYAxis=!1,this.position=E.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let u=0;u<6;++u)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${u}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);let o=0;if(s){const u=this._scene.getEngine().getCaps();u.textureHalfFloatRender?o=2:u.textureFloatRender&&(o=1)}this._renderTargetTexture=new ir(e,t,i,n,!0,o,!0),this._renderTargetTexture.gammaSpace=!a,this._renderTargetTexture.invertZ=i.useRightHandedSystem;const l=i.getEngine().useReverseDepthBuffer;let c;this._renderTargetTexture.onBeforeRenderObservable.add(u=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[u]),i.getSceneUniformBuffer().unbindEffect()),u){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const d=i.useRightHandedSystem?B.PerspectiveFovRH:B.PerspectiveFovLH;(i.useRightHandedSystem?B.LookAtRHToRef:B.LookAtLHToRef)(this.position,this._target,E.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position}),this._renderTargetTexture.onBeforeBindObservable.add(()=>{var u,h;this._currentSceneUBO=i.getSceneUniformBuffer(),null===(h=(u=i.getEngine())._debugPushGroup)||void 0===h||h.call(u,`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,a&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{var u,h;i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),null===(h=(u=i.getEngine())._debugPopGroup)||void 0===h||h.call(u,1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=lt.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let n=null;if(t.reflectionProbes)for(let s=0;s<t.reflectionProbes.length;s++){const a=t.reflectionProbes[s];if(a.name===e.name){n=a;break}}return n=lt.Parse(()=>n||new iu(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),n.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&n.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(n.metadata=e.metadata),n}}b([Bb()],iu.prototype,"_attachedMesh",void 0),b([Mr()],iu.prototype,"position",void 0);let t8=(()=>{class r{constructor(t,i="",n="black"){this._renderingCanvas=t,this._loadingText=i,this._loadingDivBackgroundColor=n,this._resizeLoadingUI=()=>{const s=this._renderingCanvas.getBoundingClientRect(),a=window.getComputedStyle(this._renderingCanvas).position;!this._loadingDiv||(this._loadingDiv.style.position="fixed"===a?"fixed":"absolute",this._loadingDiv.style.left=s.left+"px",this._loadingDiv.style.top=s.top+"px",this._loadingDiv.style.width=s.width+"px",this._loadingDiv.style.height=s.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const i=!!window.SVGSVGElement,n=new Image;n.src=r.DefaultLogoUrl?r.DefaultLogoUrl:i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",n.style.width="150px",n.style.gridColumn="1",n.style.gridRow="1",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.position="absolute";const s=document.createElement("div");s.style.width="300px",s.style.gridColumn="1",s.style.gridRow="1",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.position="absolute";const a=new Image;if(a.src=r.DefaultSpinnerUrl?r.DefaultSpinnerUrl:i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",a.style.animation="spin1 0.75s infinite linear",a.style.webkitAnimation="spin1 0.75s infinite linear",a.style.transformOrigin="50% 50%",a.style.webkitTransformOrigin="50% 50%",!i){const o={w:16,h:18.5},l={w:30,h:30};n.style.width=`${o.w}vh`,n.style.height=`${o.h}vh`,n.style.left=`calc(50% - ${o.w/2}vh)`,n.style.top=`calc(50% - ${o.h/2}vh)`,a.style.width=`${l.w}vh`,a.style.height=`${l.h}vh`,a.style.left=`calc(50% - ${l.w/2}vh)`,a.style.top=`calc(50% - ${l.h/2}vh)`}s.appendChild(a),this._loadingDiv.appendChild(n),this._loadingDiv.appendChild(s),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)}))}set loadingUIText(t){this._loadingText=t,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(t){this._loadingDivBackgroundColor=t,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}return r.DefaultLogoUrl="",r.DefaultSpinnerUrl="",r})();Ve.DefaultLoadingScreenFactory=r=>new t8(r);var po=(()=>{return(r=po||(po={}))[r.Clean=0]="Clean",r[r.Stop=1]="Stop",r[r.Sync=2]="Sync",r[r.NoSync=3]="NoSync",po;var r})();class yt{static get ForceFullSceneLoadingForIncremental(){return ya.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ya.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ya.ShowLoadingScreen}static set ShowLoadingScreen(e){ya.ShowLoadingScreen=e}static get loggingLevel(){return ya.loggingLevel}static set loggingLevel(e){ya.loggingLevel=e}static get CleanBoneMatrixWeights(){return ya.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ya.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return yt._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){return yt._RegisteredPlugins[e]||(H.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),yt.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in yt._RegisteredPlugins){const i=yt._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return yt._RegisteredPlugins[t]}return yt.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf("."),n=e.substring(i,e.length).toLowerCase();return yt._GetPluginForExtension(n)}static _GetDirectLoad(e){return"data:"===e.substr(0,5)?e.substr(5):null}static _FormatErrorMessage(e,t,i){let n="Unable to load from "+e.url;return t?n+=`: ${t}`:i&&(n+=`: ${i}`),n}static _LoadData(e,t,i,n,s,a,o){const l=yt._GetDirectLoad(e.url),c=o?yt._GetPluginForExtension(o):l?yt._GetPluginForDirectLoad(e.url):yt._GetPluginForFilename(e.url);let u;if(u=void 0!==c.plugin.createPlugin?c.plugin.createPlugin():c.plugin,!u)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(yt.OnPluginActivatedObservable.notifyObservers(u),l&&(u.canDirectLoad&&u.canDirectLoad(e.url)||!rT(e.url))){if(u.directLoad){const v=u.directLoad(t,l);v.then?v.then(A=>{i(u,A)}).catch(A=>{s("Error in directLoad of _loadData: "+A,A)}):i(u,v)}else i(u,l);return u}const h=c.isBinary,d=(v,A)=>{t.isDisposed?s("Scene has been disposed"):i(u,v,A)};let f=null,p=!1;const g=u.onDisposeObservable;g&&g.add(()=>{p=!0,f&&(f.abort(),f=null),a()});const _=()=>{if(p)return;const v=(S,x)=>{s(null==S?void 0:S.statusText,x)},A=e.file||e.url;f=u.loadFile?u.loadFile(t,A,d,n,h,v):t._loadFile(A,d,n,!0,h,v)},m=t.getEngine();let T=m.enableOfflineSupport;if(T){let v=!1;for(const A of t.disableOfflineSupportExceptionRules)if(A.test(e.url)){v=!0;break}T=!v}return T&&Ve.OfflineProviderFactory?t.offlineProvider=Ve.OfflineProviderFactory(e.url,_,m.disableManifestCheck):_(),u}static _GetFileInfo(e,t){let i,n,s=null;if(t)if(t.name)i=`file:${t.name}`,n=t.name,s=t;else if("string"==typeof t&&t.startsWith("data:"))i=t,n="";else{const a=t;if("/"===a.substr(0,1))return Ie.Error("Wrong sceneFilename parameter"),null;i=e+a,n=a}else i=e,n=Ie.GetFilename(e),e=Ie.GetFolderPath(e);return{url:i,rootUrl:e,name:n,file:s}}static GetPluginForExtension(e){return yt._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!yt._RegisteredPlugins[e]}static RegisterPlugin(e){if("string"==typeof e.extensions)yt._RegisteredPlugins[e.extensions.toLowerCase()]={plugin:e,isBinary:!1};else{const t=e.extensions;Object.keys(t).forEach(i=>{yt._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",n=Je.LastCreatedScene,s=null,a=null,o=null,l=null){if(!n)return H.Error("No scene available to import mesh to"),null;const c=yt._GetFileInfo(t,i);if(!c)return null;const u={};n.addPendingData(u);const h=()=>{n.removePendingData(u)},d=(g,_)=>{const m=yt._FormatErrorMessage(c,g,_);o?o(n,m,new xa(m,3e3,_)):H.Error(m),h()},f=a?g=>{try{a(g)}catch(_){d("Error in onProgress callback: "+_,_)}}:void 0,p=(g,_,m,T,v,A,S)=>{if(n.importedMeshesFiles.push(c.url),s)try{s(g,_,m,T,v,A,S)}catch(x){d("Error in onSuccess callback: "+x,x)}n.removePendingData(u)};return yt._LoadData(c,n,(g,_,m)=>{if(g.rewriteRootURL&&(c.rootUrl=g.rewriteRootURL(c.rootUrl,m)),g.importMesh){const T=g,v=new Array,A=new Array,S=new Array;if(!T.importMesh(e,n,_,c.rootUrl,v,A,S,d))return;n.loadingPluginName=g.name,p(v,A,S,[],[],[],[])}else g.importMeshAsync(e,n,_,c.rootUrl,f,c.name).then(v=>{n.loadingPluginName=g.name,p(v.meshes,v.particleSystems,v.skeletons,v.animationGroups,v.transformNodes,v.geometries,v.lights)}).catch(v=>{d(v.message,v)})},f,d,h,l)}static ImportMeshAsync(e,t,i="",n=Je.LastCreatedScene,s=null,a=null){return new Promise((o,l)=>{yt.ImportMesh(e,t,i,n,(c,u,h,d,f,p,g)=>{o({meshes:c,particleSystems:u,skeletons:h,animationGroups:d,transformNodes:f,geometries:p,lights:g})},s,(c,u,h)=>{l(h||new Error(u))},a)})}static Load(e,t="",i=Je.LastCreatedEngine,n=null,s=null,a=null,o=null){return i?yt.Append(e,t,new dt(i),n,s,a,o):(Ie.Error("No engine available"),null)}static LoadAsync(e,t="",i=Je.LastCreatedEngine,n=null,s=null){return new Promise((a,o)=>{yt.Load(e,t,i,l=>{a(l)},n,(l,c,u)=>{o(u||new Error(c))},s)})}static Append(e,t="",i=Je.LastCreatedScene,n=null,s=null,a=null,o=null){if(!i)return H.Error("No scene available to append to"),null;const l=yt._GetFileInfo(e,t);if(!l)return null;const c={};i.addPendingData(c);const u=()=>{i.removePendingData(c)};yt.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const h=(p,g)=>{const _=yt._FormatErrorMessage(l,p,g);a?a(i,_,new xa(_,3e3,g)):H.Error(_),u()},d=s?p=>{try{s(p)}catch(g){h("Error in onProgress callback",g)}}:void 0,f=()=>{if(n)try{n(i)}catch(p){h("Error in onSuccess callback",p)}i.removePendingData(c)};return yt._LoadData(l,i,(p,g)=>{if(p.load){if(!p.load(i,g,l.rootUrl,h))return;i.loadingPluginName=p.name,f()}else p.loadAsync(i,g,l.rootUrl,d,l.name).then(()=>{i.loadingPluginName=p.name,f()}).catch(m=>{h(m.message,m)})},d,h,u,o)}static AppendAsync(e,t="",i=Je.LastCreatedScene,n=null,s=null){return new Promise((a,o)=>{yt.Append(e,t,i,l=>{a(l)},n,(l,c,u)=>{o(u||new Error(c))},s)})}static LoadAssetContainer(e,t="",i=Je.LastCreatedScene,n=null,s=null,a=null,o=null){if(!i)return H.Error("No scene available to load asset container to"),null;const l=yt._GetFileInfo(e,t);if(!l)return null;const c={};i.addPendingData(c);const u=()=>{i.removePendingData(c)},h=(p,g)=>{const _=yt._FormatErrorMessage(l,p,g);a?a(i,_,new xa(_,3e3,g)):H.Error(_),u()},d=s?p=>{try{s(p)}catch(g){h("Error in onProgress callback",g)}}:void 0,f=p=>{if(n)try{n(p)}catch(g){h("Error in onSuccess callback",g)}i.removePendingData(c)};return yt._LoadData(l,i,(p,g)=>{if(p.loadAssetContainer){const m=p.loadAssetContainer(i,g,l.rootUrl,h);if(!m)return;i.loadingPluginName=p.name,f(m)}else p.loadAssetContainerAsync?p.loadAssetContainerAsync(i,g,l.rootUrl,d,l.name).then(m=>{i.loadingPluginName=p.name,f(m)}).catch(m=>{h(m.message,m)}):h("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,h,u,o)}static LoadAssetContainerAsync(e,t="",i=Je.LastCreatedScene,n=null,s=null){return new Promise((a,o)=>{yt.LoadAssetContainer(e,t,i,l=>{a(l)},n,(l,c,u)=>{o(u||new Error(c))},s)})}static ImportAnimations(e,t="",i=Je.LastCreatedScene,n=!0,s=po.Clean,a=null,o=null,l=null,c=null,u=null){if(!i)return void H.Error("No scene available to load animations to");if(n){for(const p of i.animatables)p.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(p=>{p.dispose()}),i.getNodes().forEach(p=>{p.animations&&(p.animations=[])})}else switch(s){case po.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case po.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case po.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case po.NoSync:break;default:return void H.Error("Unknown animation group loading mode value '"+s+"'")}const h=i.animatables.length;this.LoadAssetContainer(e,t,i,f=>{f.mergeAnimationsTo(i,i.animatables.slice(h),a),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),o&&o(i)},l,c,u)}static ImportAnimationsAsync(e,t="",i=Je.LastCreatedScene,n=!0,s=po.Clean,a=null,o=null,l=null,c=null,u=null){return new Promise((h,d)=>{yt.ImportAnimations(e,t,i,n,s,a,f=>{h(f)},l,(f,p,g)=>{d(g||new Error(p))},u)})}}yt.NO_LOGGING=0,yt.MINIMAL_LOGGING=1,yt.SUMMARY_LOGGING=2,yt.DETAILED_LOGGING=3,yt.OnPluginActivatedObservable=new J,yt._RegisteredPlugins={},yt._ShowingLoadingScreen=!1;class i8 extends cs{}class n8{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class r8 extends cs{constructor(e){super(),this._wasAddedToScene=!1,(e=e||Je.LastCreatedScene)&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const o of e)t.set(o.uniqueId,o);const i={dependsOn:new Map,dependedBy:new Map};for(const o of e){const l=o.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const o of e){const l=o.uniqueId,c=i.dependsOn.get(l);if(o instanceof bT){const h=o.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),i.dependedBy.get(h.uniqueId).add(l))}const u=i.dependedBy.get(l);for(const h of o.getDescendants()){const d=h.uniqueId;t.has(d)&&(u.add(d),i.dependsOn.get(d).add(l))}}const n=[],s=[];for(const o of e){const l=o.uniqueId;0===i.dependsOn.get(l).size&&(s.push(o),t.delete(l))}const a=s;for(;a.length>0;){const o=a.shift();n.push(o);const l=i.dependedBy.get(o.uniqueId);for(const c of Array.from(l.values())){const u=i.dependsOn.get(c);u.delete(o.uniqueId),0===u.size&&t.get(c)&&(a.push(t.get(c)),t.delete(c))}}return t.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(o=>console.error(o.name))),n}_addNodeAndDescendantsToList(e,t,i,n){if(i&&(!n||n(i))&&!t.has(i.uniqueId)){e.push(i),t.add(i.uniqueId);for(const s of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,s,n)}}_isNodeInContainer(e){return e instanceof U&&-1!==this.meshes.indexOf(e)||e instanceof gt&&-1!==this.transformNodes.indexOf(e)||e instanceof Rt&&-1!==this.lights.indexOf(e)||e instanceof it&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return H.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return H.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return H.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return H.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||Ie.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const n={},s={},a=new n8,o=[],l=[],c=Mi({doNotInstantiate:!0},i),h=[],d=new Set;for(const g of this.transformNodes)null===g.parent&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);for(const g of this.meshes)null===g.parent&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);const f=this._topologicalSort(h),p=(g,_)=>{if(((g,_)=>{if(n[g.uniqueId]=_.uniqueId,s[_.uniqueId]=_,e&&(_.name=e(g.name)),_ instanceof U){const m=_;if(m.morphTargetManager){const T=g.morphTargetManager;m.morphTargetManager=T.clone();for(let v=0;v<T.numTargets;v++){const A=T.getTarget(v),S=m.morphTargetManager.getTarget(v);n[A.uniqueId]=S.uniqueId,s[S.uniqueId]=S}}}})(g,_),g.parent){_.parent=s[n[g.parent.uniqueId]]||g.parent}if(_.position.copyFrom(g.position),_.rotation.copyFrom(g.rotation),_.scaling.copyFrom(g.scaling),_.material){const m=_;if(m.material)if(t){const T=g.material;if(-1===l.indexOf(T)){let v=T.clone(e?e(T.name):"Clone of "+T.name);if(l.push(T),n[T.uniqueId]=v.uniqueId,s[v.uniqueId]=v,"MultiMaterial"===T.getClassName()){const A=T;for(const S of A.subMaterials)!S||(v=S.clone(e?e(S.name):"Clone of "+S.name),l.push(S),n[S.uniqueId]=v.uniqueId,s[v.uniqueId]=v);A.subMaterials=A.subMaterials.map(S=>S&&s[n[S.uniqueId]])}}"InstancedMesh"!==m.getClassName()&&(m.material=s[n[T.uniqueId]])}else"MultiMaterial"===m.material.getClassName()?-1===this.scene.multiMaterials.indexOf(m.material)&&this.scene.addMultiMaterial(m.material):-1===this.scene.materials.indexOf(m.material)&&this.scene.addMaterial(m.material)}null===_.parent&&a.rootNodes.push(_)};return f.forEach(g=>{if("InstancedMesh"===g.getClassName()){const _=g,m=_.sourceMesh,T=n[m.uniqueId],A=("number"==typeof T?s[T]:m).createInstance(_.name);p(_,A)}else{let _=!0;"TransformNode"===g.getClassName()||g.skeleton||0===g.getTotalVertices()?_=!1:c.doNotInstantiate&&(_="function"==typeof c.doNotInstantiate?!c.doNotInstantiate(g):!c.doNotInstantiate);const m=_?g.createInstance(`instance of ${g.name}`):g.clone(`Clone of ${g.name}`,null,!0);if(!m)throw new Error(`Could not clone or instantiate node on Asset Container ${g.name}`);p(g,m)}}),this.skeletons.forEach(g=>{if(c.predicate&&!c.predicate(g))return;const _=g.clone(e?e(g.name):"Clone of "+g.name);for(const m of this.meshes)if(m.skeleton===g&&!m.isAnInstance){const T=s[n[m.uniqueId]];if(!T||T.isAnInstance||(T.skeleton=_,-1!==o.indexOf(_)))continue;o.push(_);for(const v of _.bones)v._linkedTransformNode&&(v._linkedTransformNode=s[n[v._linkedTransformNode.uniqueId]])}a.skeletons.push(_)}),this.animationGroups.forEach(g=>{if(c.predicate&&!c.predicate(g))return;const _=g.clone(e?e(g.name):"Clone of "+g.name,m=>s[n[m.uniqueId]]||m);a.animationGroups.push(_)}),a}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||Ie.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.addCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.addLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.addMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.addSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.addGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.addTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.addActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.addReflectionProbe(t)})}removeAllFromScene(){this._isValidHierarchy()||Ie.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(const n of e){let s=!0;if(i)for(const a of i)if(n===a){s=!1;break}s&&(t.push(n),n._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new i8);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new U("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=Je.LastCreatedScene,t,i=null){if(!e)return H.Error("No scene available to merge animations to"),[];const n=i||(o=>{let l=null;const c=o.animations.length?o.animations[0].targetProperty:"",u=o.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(o.name)||e.getTransformNodeByName(u);break;case"influence":l=e.getMorphTargetByName(o.name)||e.getMorphTargetByName(u);break;default:l=e.getNodeByName(o.name)||e.getNodeByName(u)}return l});this.getNodes().forEach(o=>{const l=n(o);if(null!==l){for(const c of o.animations){const u=l.animations.filter(h=>h.targetProperty===c.targetProperty);for(const h of u){const d=l.animations.indexOf(h,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(o.animations)}});const a=new Array;return this.animationGroups.slice().forEach(o=>{a.push(o.clone(o.name,n)),o.animatables.forEach(l=>{l.stop()})}),t.forEach(o=>{const l=n(o.target);l&&(e.beginAnimation(l,o.fromFrame,o.toFrame,o.loopAnimation,o.speedRatio,o.onAnimationEnd?o.onAnimationEnd:void 0,void 0,!0,void 0,o.onAnimationLoop?o.onAnimationLoop:void 0),e.stopAnimation(o.target))}),a}}let bi=(()=>{class r{constructor(t,i){this.triggerOptions=t,this.onBeforeExecuteObservable=new J,t.parameter?(this.trigger=t.trigger,this._triggerParameter=t.parameter):this.trigger=t.trigger?t.trigger:t,this._nextActiveAction=this,this._condition=i}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(t){this._triggerParameter=t}_evaluateConditionForCurrentFrame(){const t=this._condition;if(!t)return!0;const i=this._actionManager.getScene().getRenderId();return t._evaluationId!==i&&(t._evaluationId=i,t._currentResult=t.isValid()),t._currentResult}_executeCurrent(t){!this._evaluateConditionForCurrentFrame()||(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(t),this.skipToNextActiveAction())}execute(t){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t}_getProperty(t){return this._actionManager._getProperty(t)}_getEffectiveTarget(t,i){return this._actionManager._getEffectiveTarget(t,i)}serialize(t){}_serialize(t,i){const n={type:1,children:[],name:t.name,properties:t.properties||[]};if(this._child&&this._child.serialize(n),this._condition){const s=this._condition.serialize();return s.children.push(n),i&&i.children.push(s),s}return i&&i.children.push(n),n}}return r._SerializeValueAsString=e=>"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof We?e.x+", "+e.y:e instanceof E?e.x+", "+e.y+", "+e.z:e instanceof Fe?e.r+", "+e.g+", "+e.b:e instanceof ct?e.r+", "+e.g+", "+e.b+", "+e.a:e,r._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),r})();ye("BABYLON.Action",bi);class Vh{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}let oF=(()=>{class r extends Vh{static get IsEqual(){return r._IsEqual}static get IsDifferent(){return r._IsDifferent}static get IsGreater(){return r._IsGreater}static get IsLesser(){return r._IsLesser}constructor(t,i,n,s,a=r.IsEqual){super(t),this.propertyPath=n,this.value=s,this.operator=a,this._target=i,this._effectiveTarget=this._getEffectiveTarget(i,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case r.IsGreater:return this._effectiveTarget[this._property]>this.value;case r.IsLesser:return this._effectiveTarget[this._property]<this.value;case r.IsEqual:case r.IsDifferent:{let t;return t=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===r.IsEqual?t:!t}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[bi._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bi._SerializeValueAsString(this.value)},{name:"operator",value:r.GetOperatorName(this.operator)}]})}static GetOperatorName(t){switch(t){case r._IsEqual:return"IsEqual";case r._IsDifferent:return"IsDifferent";case r._IsGreater:return"IsGreater";case r._IsLesser:return"IsLesser";default:return""}}}return r._IsEqual=0,r._IsDifferent=1,r._IsGreater=2,r._IsLesser=3,r})();ye("BABYLON.ValueCondition",oF),ye("BABYLON.PredicateCondition",class s8 extends Vh{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}),ye("BABYLON.StateCondition",class a8 extends Vh{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[bi._GetTargetProperty(this._target),{name:"value",value:this.value}]})}});class lF extends bi{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class kh extends bi{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class cF extends bi{constructor(e,t,i,n){super(e,n),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=E.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[bi._GetTargetProperty(this._target),bi._GetTargetProperty(this._parent)]},e)}}ye("BABYLON.SetParentAction",cF),ye("BABYLON.ExecuteCodeAction",kh),ye("BABYLON.DoNothingAction",lF),ye("BABYLON.StopAnimationAction",class d8 extends bi{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[bi._GetTargetProperty(this._target)]},e)}}),ye("BABYLON.PlayAnimationAction",class h8 extends bi{constructor(e,t,i,n,s,a){super(e,a),this.from=i,this.to=n,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[bi._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:bi._SerializeValueAsString(this.loop)||!1}]},e)}}),ye("BABYLON.IncrementValueAction",class u8 extends bi{constructor(e,t,i,n,s){super(e,s),this.propertyPath=i,this.value=n,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&H.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[bi._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bi._SerializeValueAsString(this.value)}]},e)}}),ye("BABYLON.SetValueAction",class c8 extends bi{constructor(e,t,i,n,s){super(e,s),this.propertyPath=i,this.value=n,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[bi._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bi._SerializeValueAsString(this.value)}]},e)}}),ye("BABYLON.SetStateAction",class l8 extends bi{constructor(e,t,i,n){super(e,n),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[bi._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}),ye("BABYLON.SetParentAction",cF),ye("BABYLON.SwitchBooleanAction",class o8 extends bi{constructor(e,t,i,n){super(e,n),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[bi._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}),ye("BABYLON.CombineAction",class f8 extends bi{constructor(e,t,i,n=!0){super(e,i),this.children=t,this.enableChildrenConditions=n}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}});let Oa=(()=>{class r extends Lc{constructor(t){super(),(t=t||Je.LastCreatedScene)&&(this._scene=t,t.actionManagers.push(this))}dispose(){const t=this._scene.actionManagers.indexOf(this);for(let i=0;i<this.actions.length;i++){const n=this.actions[i];r.Triggers[n.trigger]--,0===r.Triggers[n.trigger]&&delete r.Triggers[n.trigger]}t>-1&&this._scene.actionManagers.splice(t,1)}getScene(){return this._scene}hasSpecificTriggers(t){for(let i=0;i<this.actions.length;i++)if(t.indexOf(this.actions[i].trigger)>-1)return!0;return!1}hasSpecificTriggers2(t,i){for(let n=0;n<this.actions.length;n++){const s=this.actions[n];if(t==s.trigger||i==s.trigger)return!0}return!1}hasSpecificTrigger(t,i){for(let n=0;n<this.actions.length;n++){const s=this.actions[n];if(s.trigger===t){if(!i)return!0;if(i(s.getTriggerParameter()))return!0}}return!1}get hasPointerTriggers(){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(i.trigger>=r.OnPickTrigger&&i.trigger<=r.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(i.trigger>=r.OnPickTrigger&&i.trigger<=r.OnPickUpTrigger)return!0}return!1}registerAction(t){return t.trigger===r.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(H.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(t),this.getScene()._registeredActions++,r.Triggers[t.trigger]?r.Triggers[t.trigger]++:r.Triggers[t.trigger]=1,t._actionManager=this,t._prepare(),t)}unregisterAction(t){const i=this.actions.indexOf(t);return-1!==i&&(this.actions.splice(i,1),r.Triggers[t.trigger]-=1,0===r.Triggers[t.trigger]&&delete r.Triggers[t.trigger],t._actionManager=null,this.getScene()._registeredActions--,!0)}processTrigger(t,i){for(let n=0;n<this.actions.length;n++){const s=this.actions[n];if(s.trigger===t){if(i&&(t===r.OnKeyUpTrigger||t===r.OnKeyDownTrigger)){const a=s.getTriggerParameter();if("function"==typeof a){if(!a(i))continue}else if(a&&a!==i.sourceEvent.keyCode){if(!a.toLowerCase)continue;const o=a.toLowerCase();if(o!==i.sourceEvent.key&&String.fromCharCode(i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode).toLowerCase()!==o)continue}}s._executeCurrent(i)}}}_getEffectiveTarget(t,i){const n=i.split(".");for(let s=0;s<n.length-1;s++)t=t[n[s]];return t}_getProperty(t){const i=t.split(".");return i[i.length-1]}serialize(t){const i={children:new Array,name:t,type:3,properties:new Array};for(let n=0;n<this.actions.length;n++){const s={type:0,children:new Array,name:r.GetTriggerName(this.actions[n].trigger),properties:new Array},a=this.actions[n].triggerOptions;if(a&&"number"!=typeof a)if(a.parameter instanceof Node)s.properties.push(bi._GetTargetProperty(a.parameter));else if("object"==typeof a.parameter){const o={};Wr.DeepCopy(a.parameter,o,["mesh"]),a.parameter&&a.parameter.mesh&&(o._meshId=a.parameter.mesh.id),s.properties.push({name:"parameter",targetType:null,value:o})}else s.properties.push({name:"parameter",targetType:null,value:a.parameter});this.actions[n].serialize(s),i.children.push(s)}return i}static Parse(t,i,n){const s=new r(n);null===i?n.actionManager=s:i.actionManager=s;const o=(c,u,h,d)=>{if(null===d){const _=parseFloat(u);return"true"===u||"false"===u?"true"===u:isNaN(_)?u:_}const f=d.split("."),p=u.split(",");for(let _=0;_<f.length;_++)h=h[f[_]];if("boolean"==typeof h)return"true"===p[0];if("string"==typeof h)return p[0];const g=new Array;for(let _=0;_<p.length;_++)g.push(parseFloat(p[_]));return h instanceof E?E.FromArray(g):h instanceof Qt?Qt.FromArray(g):h instanceof Fe?Fe.FromArray(g):h instanceof ct?ct.FromArray(g):parseFloat(p[0])},l=(c,u,h,d,f=null)=>{if(c.detached)return;const p=new Array;let g=null,_=null;const m=c.combine&&c.combine.length>0;if(p.push(2===c.type?s:u),m){const v=new Array;for(let A=0;A<c.combine.length;A++)l(c.combine[A],r.NothingTrigger,h,d,v);p.push(v)}else for(let v=0;v<c.properties.length;v++){let A=c.properties[v].value;const S=c.properties[v].name,x=c.properties[v].targetType;"target"===S?A=g="SceneProperties"===x?n:"MaterialProperties"===x?n.getMaterialByName(A):n.getNodeByName(A):"parent"===S?A=n.getNodeByName(A):"sound"===S?n.getSoundByName&&(A=n.getSoundByName(A)):"propertyPath"!==S?A=2===c.type&&"operator"===S?oF[A]:o(0,A,g,"value"===S?_:null):_=A,p.push(A)}p.push(null===f?h:null),"InterpolateValueAction"===c.name&&(p[p.length-1]=p[p.length-2],p[p.length-2]=h);let T=((c,u)=>{const h=zr("BABYLON."+c);return h&&new h(...u)})(c.name,p);if(T instanceof Vh&&null!==h){const v=new lF(u,h);d?d.then(v):s.registerAction(v),d=v}null===f?T instanceof Vh?(h=T,T=d):(h=null,d?d.then(T):s.registerAction(T)):f.push(T);for(let v=0;v<c.children.length;v++)l(c.children[v],u,h,T,null)};for(let c=0;c<t.children.length;c++){let u;const h=t.children[c];if(h.properties.length>0){const d=h.properties[0].value,f=null===h.properties[0].targetType?d:n.getMeshByName(d);f._meshId&&(f.mesh=n.getMeshById(f._meshId)),u={trigger:r[h.name],parameter:f}}else u=r[h.name];for(let d=0;d<h.children.length;d++)h.detached||l(h.children[d],u,null,null)}}static GetTriggerName(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}return r.NothingTrigger=0,r.OnPickTrigger=1,r.OnLeftPickTrigger=2,r.OnRightPickTrigger=3,r.OnCenterPickTrigger=4,r.OnPickDownTrigger=5,r.OnDoublePickTrigger=6,r.OnPickUpTrigger=7,r.OnPickOutTrigger=16,r.OnLongPressTrigger=8,r.OnPointerOverTrigger=9,r.OnPointerOutTrigger=10,r.OnEveryFrameTrigger=11,r.OnIntersectionEnterTrigger=12,r.OnIntersectionExitTrigger=13,r.OnKeyDownTrigger=14,r.OnKeyUpTrigger=15,r})();class Gh{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=B.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new J,this.bones=[],this._scene=i||Je.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):((!this._transformMatrices||this._isDirty)&&this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const n in this._ranges)i&&(t+=", ",i=!1),t+=n;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Oc(e,t,i);for(let n=0,s=this.bones.length;n<s;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,n=this.bones.length;i<n;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let n=!0;const s=this._getHighestAnimationFrame()+1,a={},o=e.bones;let l,c;for(c=0,l=o.length;c<l;c++)a[o[c].name]=o[c];this.bones.length!==o.length&&(H.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),n=!1);const u=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const d=this.bones[c].name,f=a[d];f?n=n&&this.bones[c].copyAnimationRange(f,t,s,i,u):(H.Warn("copyAnimationRange: not same rig, missing source bone "+d),n=!1)}const h=e.getAnimationRange(t);return h&&(this._ranges[t]=new Oc(t,h.from+s,h.to+s)),n}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const n=this.bones[t].animations[0].getHighestFrame();e<n&&(e=n)}return e}beginAnimation(e,t,i,n){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,n):null}static MakeAnimationAdditive(e,t=0,i){const n=e.getAnimationRange(i);if(!n)return null;const s=e._scene.getAllAnimatablesByTarget(e);let a=null;for(let l=0;l<s.length;l++){const c=s[l];if(c.fromFrame===(null==n?void 0:n.from)&&c.toFrame===(null==n?void 0:n.to)){a=c;break}}const o=e.getAnimatables();for(let l=0;l<o.length;l++){const u=o[l].animations;if(u)for(let h=0;h<u.length;h++)Me.MakeAnimationAdditive(u[h],t,i)}return a&&(a.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const n=this.bones[i];n._childUpdateId++;const s=n.getParent();if(s?n.getLocalMatrix().multiplyToRef(s.getWorldMatrix(),n.getWorldMatrix()):t?n.getLocalMatrix().multiplyToRef(t,n.getWorldMatrix()):n.getWorldMatrix().copyFrom(n.getLocalMatrix()),-1!==n._index){const a=null===n._index?i:n._index;n.getInvertedAbsoluteTransform().multiplyToArray(n.getWorldMatrix(),e,16*a)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(){if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if((!e._bonesTransformMatrices||e._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const n of this.bones)n.getParent()||(n.getBaseMatrix().multiplyToRef(t,z.Matrix[1]),n._updateDifferenceMatrix(z.Matrix[1]));if(this.isUsingTextureForMatrices){const n=4*(this.bones.length+1);(!e._transformMatrixTexture||e._transformMatrixTexture.getSize().width!==n)&&(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=ea.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=ea.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Gh(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let n=0;n<this.bones.length;n++){const s=this.bones[n];let a=null;const o=s.getParent();if(o){const c=this.bones.indexOf(o);a=i.bones[c]}const l=new xi(s.name,i,a,s.getBaseMatrix().clone(),s.getRestPose().clone());l._index=s._index,s._linkedTransformNode&&l.linkTransformNode(s._linkedTransformNode),Wr.DeepCopy(s.animations,l.animations)}if(this._ranges){i._ranges={};for(const n in this._ranges){const s=this._ranges[n];s&&(i._ranges[n]=s.clone())}}return this._isDirty=!0,i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const n=this.bones[i],s=n.getParent(),a={parentBoneIndex:s?this.bones.indexOf(s):-1,index:n.getIndex(),name:n.name,id:n.id,matrix:n.getBaseMatrix().toArray(),rest:n.getRestPose().toArray(),linkedTransformNodeId:null===(e=n.getTransformNode())||void 0===e?void 0:e.id};t.bones.push(a),n.length&&(a.length=n.length),n.metadata&&(a.metadata=n.metadata),n.animations&&n.animations.length>0&&(a.animation=n.animations[0].serialize()),t.ranges=[];for(const o in this._ranges){const l=this._ranges[o];if(!l)continue;const c={};c.name=o,c.from=l.from,c.to=l.to,t.ranges.push(c)}}return t}static Parse(e,t){const i=new Gh(e.name,e.id,t);let n;for(e.dimensionsAtRest&&(i.dimensionsAtRest=E.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,n=0;n<e.bones.length;n++){const s=e.bones[n],a=e.bones[n].index;let o=null;s.parentBoneIndex>-1&&(o=i.bones[s.parentBoneIndex]);const l=s.rest?B.FromArray(s.rest):null,c=new xi(s.name,i,o,B.FromArray(s.matrix),l,null,a);null!=s.id&&(c.id=s.id),s.length&&(c.length=s.length),s.metadata&&(c.metadata=s.metadata),s.animation&&c.animations.push(Me.Parse(s.animation)),null!=s.linkedTransformNodeId&&(i._hasWaitingData=!0,c._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(n=0;n<e.ranges.length;n++){const s=e.ranges[n];i.createAnimationRange(s.name,s.from,s.to)}return i}computeAbsoluteTransforms(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteTransforms(),this._absoluteTransformIsDirty=!1)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const n=this.bones[e];if(!n)return;void 0===n._index&&(n._index=e);const s=n.getParent();s&&this._sortBones(this.bones.indexOf(s),t,i),t.push(n)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}class nu{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new J,this._onDataLayoutChanged=new J,this._animationPropertiesOverride=null,this._scene=i||Je.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=lt.Clone(()=>new nu(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),lt.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new nu(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let n=0;n<e.animations.length;n++){const s=e.animations[n],a=zr("BABYLON.Animation");a&&i.animations.push(a.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const n=new nu(t,i,e.getScene());return n.setPositions(e.getVerticesData(I.PositionKind)),e.isVerticesDataPresent(I.NormalKind)&&n.setNormals(e.getVerticesData(I.NormalKind)),e.isVerticesDataPresent(I.TangentKind)&&n.setTangents(e.getVerticesData(I.TangentKind)),e.isVerticesDataPresent(I.UVKind)&&n.setUVs(e.getVerticesData(I.UVKind)),n}}b([O()],nu.prototype,"id",void 0);let uF=(()=>{class r{set areUpdatesFrozen(t){t?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(t=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Qn(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,t||(t=Je.LastCreatedScene),this._scene=t,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const i=this._scene.getEngine().getCaps();this._canUseTextureForTargets=i.canUseGLVertexID&&i.textureFloat&&i.maxVertexTextureImageUnits>0&&i.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(t){this._useTextureToStoreTargets=t}get isUsingTextureForTargets(){var t;return r.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(null===(t=this._scene)||void 0===t?void 0:t.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(t){return this._activeTargets.data[t]}getTarget(t){return this._targets[t]}addTarget(t){this._targets.push(t),this._targetInfluenceChangedObservers.push(t.onInfluenceChanged.add(i=>{this._syncActiveTargets(i)})),this._targetDataLayoutChangedObservers.push(t._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(t){const i=this._targets.indexOf(t);i>=0&&(this._targets.splice(i,1),t.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(i,1)[0]),t._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(i,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(t)}_bind(t){t.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),t.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),t.setTexture("morphTargets",this._targetStoreTexture)}clone(){const t=new r(this._scene);for(const i of this._targets)t.addTarget(i.clone());return t.enableNormalMorphing=this.enableNormalMorphing,t.enableTangentMorphing=this.enableTangentMorphing,t.enableUVMorphing=this.enableUVMorphing,t}serialize(){const t={};t.id=this.uniqueId,t.targets=[];for(const i of this._targets)t.targets.push(i.serialize());return t}_syncActiveTargets(t){if(this.areUpdatesFrozen)return;let i=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let n=-1;for(const s of this._targets){if(n++,0===s.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=r.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(s),this._morphTargetTextureIndices[i]=n,this._tempInfluences[i++]=s.influence,this._supportsNormals=this._supportsNormals&&s.hasNormals,this._supportsTangents=this._supportsTangents&&s.hasTangents,this._supportsUVs=this._supportsUVs&&s.hasUVs;const a=s.getPositions();if(a){const o=a.length/3;if(0===this._vertexCount)this._vertexCount=o;else if(this._vertexCount!==o)return void H.Error("Incompatible target. Targets must all have the same vertices count.")}}(!this._influences||this._influences.length!==i)&&(this._influences=new Float32Array(i));for(let s=0;s<i;s++)this._influences[s]=this._tempInfluences[s];t&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const t=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>t&&(this._textureHeight=Math.ceil(this._textureWidth/t),this._textureWidth=t);let i=!0;if(this._targetStoreTexture){const n=this._targetStoreTexture.getSize();n.width===this._textureWidth&&n.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(i=!1)}if(i){this._targetStoreTexture&&this._targetStoreTexture.dispose();const n=this._targets.length,s=new Float32Array(n*this._textureWidth*this._textureHeight*4);let a=0;for(let o=0;o<n;o++){const l=this._targets[o],c=l.getPositions(),u=l.getNormals(),h=l.getUVs(),d=l.getTangents();if(!c)return void(0===o&&H.Error("Invalid morph target. Target must have positions."));a=o*this._textureWidth*this._textureHeight*4;for(let f=0;f<this._vertexCount;f++)s[a]=c[3*f],s[a+1]=c[3*f+1],s[a+2]=c[3*f+2],a+=4,u&&(s[a]=u[3*f],s[a+1]=u[3*f+1],s[a+2]=u[3*f+2],a+=4),h&&(s[a]=h[2*f],s[a+1]=h[2*f+1],a+=4),d&&(s[a]=d[3*f],s[a+1]=d[3*f+1],s[a+2]=d[3*f+2],a+=4)}this._targetStoreTexture=gE.CreateRGBATexture(s,this._textureWidth,this._textureHeight,n,this._scene,!1,!1,1,1)}}for(const t of this._scene.meshes)t.morphTargetManager===this&&t._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const t=this._parentContainer.morphTargetManagers.indexOf(this);t>-1&&this._parentContainer.morphTargetManagers.splice(t,1),this._parentContainer=null}for(const t of this._targets)this._scene.stopAnimation(t)}}static Parse(t,i){const n=new r(i);n._uniqueId=t.id;for(const s of t.targets)n.addTarget(nu.Parse(s,i));return n}}return r.EnableTextureStorage=!0,r.MaxActiveMorphTargetsInVertexAttributeMode=8,r})();class mi{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}mi.DistanceJoint=0,mi.HingeJoint=1,mi.BallAndSocketJoint=2,mi.WheelJoint=3,mi.SliderJoint=4,mi.PrismaticJoint=5,mi.UniversalJoint=6,mi.Hinge2Joint=mi.WheelJoint,mi.PointToPointJoint=8,mi.SpringJoint=9,mi.LockJoint=10,U._PhysicsImpostorParser=function(r,e,t){return new ut(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},r)};class ut{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyPressure||t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyStiffness||t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyVelocityIterations||t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyPositionIterations||t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},n){this.object=e,this.type=t,this._options=i,this._scene=n,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=E.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new Be,this._tmpQuat2=new Be,this.beforeStep=()=>{!this._physicsEngine||(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new Be),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(s=>{s(this)}))},this.afterStep=()=>{!this._physicsEngine||(this._onAfterPhysicsStepCallbacks.forEach(s=>{s(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,ut._TmpVecs[0]),this.object.translate(ut._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=s=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const a=this._physicsEngine.getImpostorWithPhysicsBody(s.body);a&&(this.onCollideEvent&&this.onCollideEvent(this,a),this._onPhysicsCollideCallbacks.filter(o=>-1!==o.otherImpostors.indexOf(a)).forEach(o=>{o.callback(this,a,s.point,s.distance,s.impulse,s.normal)}))},this.object?(this.object.parent&&0!==i.mass&&H.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotationQuaternion=this.object.rotation?Be.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):new Be),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&H.Warn("You must affect impostors to children before affecting impostor to parent.")):H.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):H.Error("No object was provided. A physics object is obligatory")}_init(){!this._physicsEngine||(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof hn?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=ut.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}return ut.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):E.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):E.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):H.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):H.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:e instanceof Array?e:[e]})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let n=-1;this._onPhysicsCollideCallbacks.some((a,o)=>{if(a.callback===t&&a.otherImpostors.length===i.length){const l=a.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(n=o),l}return!1})?this._onPhysicsCollideCallbacks.splice(n,1):H.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):Be.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const n=new mi(t,i);return this.addJoint(e,n),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,n,s){if(!this._physicsEngine)return this;const a=this._physicsEngine.getPhysicsPlugin();return a.appendAnchor?(this._physicsEngine&&a.appendAnchor(this,e,t,i,n,s),this):this}addHook(e,t,i,n){if(!this._physicsEngine)return this;const s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,i,n),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new ut(e,this.type,this._options,this._scene):null}dispose(){!this._physicsEngine||(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new Be),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,n,s){const a=ut._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(s){const l=ut._TmpQuat;o.rotationQuaternion.multiplyToRef(s,l),e.setRotationQuaternion(l,Yt.WORLD,t)}else e.setRotationQuaternion(o.rotationQuaternion,Yt.WORLD,t);a.x=0,a.y=0,a.z=0,i&&(a.x=i.x,a.y=i.y,a.z=i.z,e.getDirectionToRef(a,t,a),null==n&&(n=i.length()),a.x*=n,a.y*=n,a.z*=n),e.getParent()?(a.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(a,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=a.x,t.position.y-=a.y,t.position.z-=a.z)}syncImpostorWithBone(e,t,i,n,s,a){const o=this.object;if(o.rotationQuaternion)if(s){const u=ut._TmpQuat;e.getRotationQuaternionToRef(Yt.WORLD,t,u),u.multiplyToRef(s,o.rotationQuaternion)}else e.getRotationQuaternionToRef(Yt.WORLD,t,o.rotationQuaternion);const l=ut._TmpVecs[0],c=ut._TmpVecs[1];a||((a=ut._TmpVecs[2]).x=0,a.y=1,a.z=0),e.getDirectionToRef(a,t,c),e.getAbsolutePositionToRef(t,l),null==n&&i&&(n=i.length()),null!=n&&(l.x+=c.x*n,l.y+=c.y*n,l.z+=c.z*n),o.setAbsolutePosition(l)}}ut.DEFAULT_OBJECT_SIZE=new E(1,1,1),ut.IDENTITY_QUATERNION=Be.Identity(),ut._TmpVecs=mn.BuildArray(3,E.Zero),ut._TmpQuat=Be.Identity(),ut.NoImpostor=0,ut.SphereImpostor=1,ut.BoxImpostor=2,ut.PlaneImpostor=3,ut.MeshImpostor=4,ut.CapsuleImpostor=6,ut.CylinderImpostor=7,ut.ParticleImpostor=8,ut.HeightmapImpostor=9,ut.ConvexHullImpostor=10,ut.CustomImpostor=100,ut.RopeImpostor=101,ut.ClothImpostor=102,ut.SoftbodyImpostor=103;class VE{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=E.Zero(),this._hitPointWorld=E.Zero(),this._rayFromWorld=E.Zero(),this._rayToWorld=E.Zero()}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitData(e,t){this._hasHit=!0,this._hitNormalWorld=new E(e.x,e.y,e.z),this._hitPointWorld=new E(t.x,t.y,t.z)}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=E.Distance(this._rayFromWorld,this._hitPointWorld)}reset(e=E.Zero(),t=E.Zero()){this._rayFromWorld=e,this._rayToWorld=t,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=E.Zero(),this._hitPointWorld=E.Zero()}}class kE{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw ht("CannonJSPlugin")}constructor(e,t=kE.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new E(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const n={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(n),this._physicsPlugin.generateJoint(n)}removeJoint(e,t,i){const n=this._joints.filter(function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e});n.length&&this._physicsPlugin.removeJoint(n[0])}_step(e){this._impostors.forEach(t=>{t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class GE{constructor(e=!0,t=10,i=CANNON){this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new Be,this._minus90X=new Be(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new Be(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=E.Zero(),this._tmpDeltaPosition=E.Zero(),this._tmpUnityRotation=new Be,this.BJSCANNON=i,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new VE):H.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const i of t)i.type==ut.HeightmapImpostor||i.type===ut.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const n=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(s,n)}applyForce(e,t,i){const n=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(s,n)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t)return void H.Warn("It was not possible to create a physics body for this object.");const i=e.physicsBody;i&&this.removePhysicsBody(e);const n=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),s={mass:e.getParam("mass"),material:n},a=e.getParam("nativeOptions");for(const o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o]);e.physicsBody=new this.BJSCANNON.Body(s),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(o){const l=i[o];e.physicsBody[o].set(l.x,l.y,l.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const n=s=>{if(!s.rotationQuaternion)return;const a=s.getPhysicsImpostor();if(a&&a.parent!==e&&s.parent){const l=s.getAbsolutePosition().subtract(s.parent.getAbsolutePosition()),c=s.rotationQuaternion.multiply(this._tmpQuaternion);a.physicsBody&&(this.removePhysicsBody(a),a.physicsBody=null),a.parent=e,a.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(a),new this.BJSCANNON.Vec3(l.x,l.y,l.z),new this.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w)),e.physicsBody.mass+=a.getParam("mass")}s.getChildMeshes(!0).filter(o=>!!o.physicsImpostor).forEach(n)};t.filter(s=>!!s.physicsImpostor).forEach(n)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let n;const s=e.joint.jointData,a={pivotA:s.mainPivot?(new this.BJSCANNON.Vec3).set(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z):null,pivotB:s.connectedPivot?(new this.BJSCANNON.Vec3).set(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z):null,axisA:s.mainAxis?(new this.BJSCANNON.Vec3).set(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z):null,axisB:s.connectedAxis?(new this.BJSCANNON.Vec3).set(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case mi.HingeJoint:case mi.Hinge2Joint:n=new this.BJSCANNON.HingeConstraint(t,i,a);break;case mi.DistanceJoint:n=new this.BJSCANNON.DistanceConstraint(t,i,s.maxDistance||2);break;case mi.SpringJoint:n=new this.BJSCANNON.Spring(t,i,{restLength:s.length,stiffness:s.stiffness,damping:s.damping,localAnchorA:a.pivotA,localAnchorB:a.pivotB});break;case mi.LockJoint:n=new this.BJSCANNON.LockConstraint(t,i,a);break;default:n=new this.BJSCANNON.PointToPointConstraint(t,a.pivotA,i,a.pivotB,a.maxForce)}n.collideConnected=!!s.collision,e.joint.physicsJoint=n,e.joint.type!==mi.SpringJoint?this.world.addConstraint(n):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){n.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==mi.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let n,s;for(n=0;n<this._physicsMaterials.length;n++)if(s=this._physicsMaterials[n],s.friction===t&&s.restitution===i)return s;const a=new this.BJSCANNON.Material(e);return a.friction=t,a.restitution=i,this._physicsMaterials.push(a),a}_checkWithEpsilon(e){return e<kt?kt:e}_createShape(e){const t=e.object;let i;const n=e.getObjectExtents();switch(e.type){case ut.SphereImpostor:{const a=n.y,o=n.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(n.x),this._checkWithEpsilon(a),this._checkWithEpsilon(o))/2);break}case ut.CylinderImpostor:{let s=e.getParam("nativeOptions");s||(s={});const a=void 0!==s.radiusTop?s.radiusTop:this._checkWithEpsilon(n.x)/2,o=void 0!==s.radiusBottom?s.radiusBottom:this._checkWithEpsilon(n.x)/2,l=void 0!==s.height?s.height:this._checkWithEpsilon(n.y);i=new this.BJSCANNON.Cylinder(a,o,l,void 0!==s.numSegments?s.numSegments:16);const u=new this.BJSCANNON.Quaternion;u.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const h=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(h,u);break}case ut.BoxImpostor:{const s=n.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(s.x),this._checkWithEpsilon(s.y),this._checkWithEpsilon(s.z)));break}case ut.PlaneImpostor:H.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case ut.MeshImpostor:{const s=t.getVerticesData?t.getVerticesData(I.PositionKind):[],a=t.getIndices?t.getIndices():[];if(!s)return void H.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const o=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const u=t.computeWorldMatrix(!0),h=new Array;let d;for(d=0;d<s.length;d+=3)E.TransformCoordinates(E.FromArray(s,d),u).toArray(h,d);H.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(h,a),t.position.copyFrom(o),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case ut.HeightmapImpostor:{const s=t.position.clone(),a=t.rotation&&t.rotation.clone(),o=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(s),a&&t.rotation&&t.rotation.copyFrom(a),o&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(o),t.computeWorldMatrix(!0);break}case ut.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case ut.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return i}_createHeightmap(e,t){let i=e.getVerticesData(I.PositionKind);const n=e.computeWorldMatrix(!0),s=new Array;let a;for(a=0;a<i.length;a+=3)E.TransformCoordinates(E.FromArray(i,a),n).toArray(s,a);i=s;const o=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),u=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),h=c.boundingBox.extendSizeWorld.z,d=2*u/l;for(let p=0;p<i.length;p+=3){const g=Math.round(i[p+0]/d+l/2),_=Math.round(-1*(i[p+1]/d-l/2)),m=-i[p+2]+h;o[g]||(o[g]=[]),o[g][_]||(o[g][_]=m),o[g][_]=Math.max(m,o[g][_])}for(let p=0;p<=l;++p){if(!o[p]){let g=1;for(;!o[(p+g)%l];)g++;o[p]=o[(p+g)%l].slice()}for(let g=0;g<=l;++g)if(!o[p][g]){let m,_=1;for(;void 0===m;)m=o[p][(g+_++)%l];o[p][g]=m}}const f=new this.BJSCANNON.Heightfield(o,{elementSize:d});return f.minY=h,f}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let n=t.rotationQuaternion;if(n){if((e.type===ut.PlaneImpostor||e.type===ut.HeightmapImpostor)&&(n=n.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===ut.HeightmapImpostor){const s=t;let a=s.getBoundingInfo();const o=s.rotationQuaternion;s.rotationQuaternion=this._tmpUnityRotation,s.computeWorldMatrix(!0);const l=i.clone();let c=s.getPivotMatrix();c=c?c.clone():B.Identity();const u=B.Translation(a.boundingBox.extendSizeWorld.x,0,-a.boundingBox.extendSizeWorld.z);s.setPreTransformMatrix(u),s.computeWorldMatrix(!0),a=s.getBoundingInfo();const h=a.boundingBox.centerWorld.subtract(i).subtract(s.position).negate();this._tmpPosition.copyFromFloats(h.x,h.y-a.boundingBox.extendSizeWorld.y,h.z),this._tmpDeltaPosition.copyFrom(a.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=a.boundingBox.extendSizeWorld.y,s.rotationQuaternion=o,s.setPreTransformMatrix(c),s.computeWorldMatrix(!0)}else e.type===ut.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(n.x,n.y,n.z,n.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new E(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new E(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,n){n||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,n,s){if(s=s||10,0===(n=n||0))this.internalStep(i),this.time+=i;else{let a=Math.floor((this.time+n)/i)-Math.floor(this.time/i);a=Math.min(a,s)||1;const o=performance.now();for(let d=0;d!==a&&(this.internalStep(i),!(performance.now()-o>1e3*i));d++);this.time+=n;const c=this.time%i/i,u=e,h=this.bodies;for(let d=0;d!==h.length;d++){const f=h[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,u),u.scale(c,u),f.position.vadd(u,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}kE.DefaultPluginFactory=()=>new GE;class hF{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=E.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new VE}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(n){n.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(n=>{n.afterStep(),this._tmpImpostorsArray[n.uniqueId]=n});let i=this.world.contacts;for(;null!==i;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const n=this._tmpImpostorsArray[+i.body1.name],s=this._tmpImpostorsArray[+i.body2.name];n&&s?(n.onCollide({body:s.physicsBody,point:null,distance:0,impulse:0,normal:null}),s.onCollide({body:n.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next):i=i.next}}applyImpulse(e,t,i){const n=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*n))}applyForce(e,t,i){H.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];!(o=e.object).getChildMeshes||o.getChildMeshes().forEach(function(l){l.physicsImpostor&&i.push(l.physicsImpostor)});const s=o=>Math.max(o,kt),a=new Be;i.forEach(o=>{if(!o.object.rotationQuaternion)return;const l=o.object.rotationQuaternion;a.copyFrom(l),o.object.rotationQuaternion.set(0,0,0,1),o.object.computeWorldMatrix(!0);const c=a.toEulerAngles(),u=o.getObjectExtents(),h=57.29577951308232;if(o===e){const d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const d=o.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(c.x*h,c.y*h,c.z*h)}switch(o.object.rotationQuaternion.copyFrom(a),o.type){case ut.ParticleImpostor:H.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case ut.SphereImpostor:{const f=u.y,p=u.z,g=Math.max(s(u.x),s(f),s(p))/2;t.type.push("sphere"),t.size.push(g),t.size.push(g),t.size.push(g);break}case ut.CylinderImpostor:{const d=s(u.x)/2,f=s(u.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}default:{const d=s(u.x),f=s(u.y),p=s(u.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(p);break}}o.object.rotationQuaternion=l}),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(a),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}var o}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const n=e.joint.jointData,s=n.nativeParams||{};let a;const o={body1:t,body2:i,axe1:s.axe1||(n.mainAxis?n.mainAxis.asArray():null),axe2:s.axe2||(n.connectedAxis?n.connectedAxis.asArray():null),pos1:s.pos1||(n.mainPivot?n.mainPivot.asArray():null),pos2:s.pos2||(n.connectedPivot?n.connectedPivot.asArray():null),min:s.min,max:s.max,collision:s.collision||n.collision,spring:s.spring,world:this.world};switch(e.joint.type){case mi.BallAndSocketJoint:a="jointBall";break;case mi.SpringJoint:H.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead"),o.min=n.length||o.min,o.max=Math.max(o.min,o.max);case mi.DistanceJoint:a="jointDistance",o.max=n.maxDistance;break;case mi.PrismaticJoint:a="jointPrisme";break;case mi.SliderJoint:a="jointSlide";break;case mi.WheelJoint:a="jointWheel";break;default:a="jointHinge"}o.type=a,e.joint.physicsJoint=this.world.add(o)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){H.Warn(t)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const n=e.physicsBody;e.physicsBody.shapes.next||(n.position.set(t.x,t.y,t.z),n.orientation.set(i.x,i.y,i.z,i.w),n.syncShapes(),n.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new E(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new E(t.x,t.y,t.z):null}setBodyMass(e,t){const i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,n){void 0!==i?H.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6;const s=n?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setMotor(t*=-1,i)}setLimit(e,t,i,n){const s=n?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setLimit(t,void 0===i?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth}dispose(){this.world.clear()}raycast(e,t){return H.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){H.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}let dF=(()=>{class r{constructor(t=!0,i=Ammo,n=null){this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new Be,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new E,this._tmpContactNormal=new E,this._tmpVec3=new E,this._tmpMatrix=new B,"function"!=typeof i?(this.bjsAMMO=i,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=n||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=s=>{const a=(s=this.bjsAMMO.wrapPointer(s,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),o=s.m_normalWorldOnB;this._tmpContactPoint.x=a.x(),this._tmpContactPoint.y=a.y(),this._tmpContactPoint.z=a.z(),this._tmpContactNormal.x=o.x(),this._tmpContactNormal.y=o.y(),this._tmpContactNormal.z=o.z(),this._tmpContactImpulse=s.getAppliedImpulse(),this._tmpContactDistance=s.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new VE,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):H.Error("AmmoJS is not available. Please make sure you included the js file.")):H.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(t){this._timeStep=t}setFixedTimeStep(t){this._fixedTimeStep=t}setMaxSteps(t){this._maxSteps=t}getTimeStep(){return this._timeStep}_isImpostorInContact(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(t,i){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,i.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(t=1/60,i=10,n=1/60){if(0==i)this.world.stepSimulation(t,0);else for(;i>0&&t>0;)t-n<n?(this.world.stepSimulation(t,0),t=0):(t-=n,this.world.stepSimulation(n,0)),i--}executeStep(t,i){for(const n of i)n.soft||n.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const n of i)if(n.soft?this._afterSoftStep(n):n.afterStep(),n._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(n))for(const s of n._onPhysicsCollideCallbacks)for(const a of s.otherImpostors)(n.physicsBody.isActive()||a.physicsBody.isActive())&&this._isImpostorPairInContact(n,a)&&(n.onCollide({body:a.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),a.onCollide({body:n.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(t){t.type===ut.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)}_ropeStep(t){const i=t.physicsBody.get_m_nodes(),n=i.size();let s,a,o,l,c;const u=new Array;for(let f=0;f<n;f++)s=i.at(f),a=s.get_m_x(),o=a.x(),l=a.y(),c=a.z(),u.push(new E(o,l,c));const h=t.object,d=t.getParam("shape");t.object=t._isFromLine?Yf("lines",{points:u,instance:h}):$f("ext",{shape:d,path:u,instance:h})}_softbodyOrClothStep(t){const i=t.type===ut.ClothImpostor?1:-1,n=t.object;let s=n.getVerticesData(I.PositionKind);s||(s=[]);let a=n.getVerticesData(I.NormalKind);a||(a=[]);const o=s.length/3,l=t.physicsBody.get_m_nodes();let c,u,h,d,f,p,g,_;for(let T=0;T<o;T++){c=l.at(T),u=c.get_m_x(),h=u.x(),d=u.y(),f=u.z()*i;const v=c.get_m_n();p=v.x(),g=v.y(),_=v.z()*i,s[3*T]=h,s[3*T+1]=d,s[3*T+2]=f,a[3*T]=p,a[3*T+1]=g,a[3*T+2]=_}const m=new be;m.positions=s,m.normals=a,m.uvs=n.getVerticesData(I.UVKind),m.colors=n.getVerticesData(I.ColorKind),n&&n.getIndices&&(m.indices=n.getIndices()),m.applyToMesh(n)}applyImpulse(t,i,n){if(t.soft)H.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const s=this._tmpAmmoVectorA,a=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&n.subtractInPlace(t.object.getWorldMatrix().getTranslation()),s.setValue(n.x,n.y,n.z),a.setValue(i.x,i.y,i.z),t.physicsBody.applyImpulse(a,s)}}applyForce(t,i,n){if(t.soft)H.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();const s=this._tmpAmmoVectorA,a=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){const o=t.object.getWorldMatrix().getTranslation();s.setValue(n.x-o.x,n.y-o.y,n.z-o.z)}else s.setValue(n.x,n.y,n.z);a.setValue(i.x,i.y,i.z),t.physicsBody.applyForce(a,s)}}generatePhysicsBody(t){if(t._pluginData.toDispose=[],t.parent)t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());else if(t.isBodyInitRequired()){const i=this._createShape(t),n=t.getParam("mass");if(t._pluginData.mass=n,t.soft)i.get_m_cfg().set_collisions(17),i.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(i,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),i.setActivationState(r._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(i,1,-1),t.physicsBody=i,t._pluginData.toDispose.push(i),this.setBodyPressure(t,0),t.type===ut.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{const s=new this.bjsAMMO.btVector3(0,0,0),a=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),a.setIdentity(),0!==n&&i.calculateLocalInertia(n,s),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),a.setOrigin(this._tmpAmmoVectorA),a.setRotation(this._tmpAmmoQuaternion);const o=new this.bjsAMMO.btDefaultMotionState(a),l=new this.bjsAMMO.btRigidBodyConstructionInfo(n,o,i,s),c=new this.bjsAMMO.btRigidBody(l);if(0===n&&(c.setCollisionFlags(c.getCollisionFlags()|r._KINEMATIC_FLAG),c.setActivationState(r._DISABLE_DEACTIVATION_FLAG)),t.type==ut.NoImpostor&&!i.getChildShape&&c.setCollisionFlags(c.getCollisionFlags()|r._DISABLE_COLLISION_FLAG),t.type!==ut.MeshImpostor&&t.type!==ut.NoImpostor){const d=t.object.getBoundingInfo();this._tmpVec3.copyFrom(t.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(d.boundingBox.centerWorld),this._tmpVec3.x/=t.object.scaling.x,this._tmpVec3.y/=t.object.scaling.y,this._tmpVec3.z/=t.object.scaling.z,t.setDeltaPosition(this._tmpVec3)}const u=t.getParam("group"),h=t.getParam("mask");u&&h?this.world.addRigidBody(c,u,h):this.world.addRigidBody(c),t.physicsBody=c,t._pluginData.toDispose=t._pluginData.toDispose.concat([c,l,o,a,s,i])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}}removePhysicsBody(t){this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData&&(t._pluginData.toDispose.forEach(i=>{this.bjsAMMO.destroy(i)}),t._pluginData.toDispose=[]))}generateJoint(t){const i=t.mainImpostor.physicsBody,n=t.connectedImpostor.physicsBody;if(!i||!n)return;const s=t.joint.jointData;let a;switch(s.mainPivot||(s.mainPivot=new E(0,0,0)),s.connectedPivot||(s.connectedPivot=new E(0,0,0)),t.joint.type){case mi.DistanceJoint:{const o=s.maxDistance;o&&(s.mainPivot=new E(0,-o/2,0),s.connectedPivot=new E(0,o/2,0)),a=new this.bjsAMMO.btPoint2PointConstraint(i,n,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break}case mi.HingeJoint:{s.mainAxis||(s.mainAxis=new E(0,0,0)),s.connectedAxis||(s.connectedAxis=new E(0,0,0));const o=new this.bjsAMMO.btVector3(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z),l=new this.bjsAMMO.btVector3(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z);a=new this.bjsAMMO.btHingeConstraint(i,n,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o,l);break}case mi.BallAndSocketJoint:a=new this.bjsAMMO.btPoint2PointConstraint(i,n,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break;default:H.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),a=new this.bjsAMMO.btPoint2PointConstraint(i,n,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z))}this.world.addConstraint(a,!t.joint.jointData.collision),t.joint.physicsJoint=a}removeJoint(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint)}_addMeshVerts(t,i,n){let s=0;if(n&&n.getIndices&&n.getWorldMatrix&&n.getChildMeshes){let a=n.getIndices();a||(a=[]);let l,o=n.getVerticesData(I.PositionKind);if(o||(o=[]),i&&i!==n){let u;u=i.rotationQuaternion?i.rotationQuaternion:i.rotation?Be.FromEulerAngles(i.rotation.x,i.rotation.y,i.rotation.z):Be.Identity(),B.Compose(E.One(),u,i.position).invertToRef(this._tmpMatrix),l=n.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else B.ScalingToRef(n.scaling.x,n.scaling.y,n.scaling.z,this._tmpMatrix),l=this._tmpMatrix;const c=a.length/3;for(let u=0;u<c;u++){const h=[];for(let d=0;d<3;d++){let p,f=new E(o[3*a[3*u+d]+0],o[3*a[3*u+d]+1],o[3*a[3*u+d]+2]);f=E.TransformCoordinates(f,l),p=0==d?this._tmpAmmoVectorA:1==d?this._tmpAmmoVectorB:this._tmpAmmoVectorC,p.setValue(f.x,f.y,f.z),h.push(p)}t.addTriangle(h[0],h[1],h[2]),s++}n.getChildMeshes().forEach(u=>{s+=this._addMeshVerts(t,i,u)})}return s}_softVertexData(t){const i=t.object;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let n=i.getIndices();n||(n=[]);let s=i.getVerticesData(I.PositionKind);s||(s=[]);let a=i.getVerticesData(I.NormalKind);a||(a=[]),i.computeWorldMatrix(!1);const o=[],l=[];for(let u=0;u<s.length;u+=3){let h=new E(s[u],s[u+1],s[u+2]),d=new E(a[u],a[u+1],a[u+2]);h=E.TransformCoordinates(h,i.getWorldMatrix()),d=E.TransformNormal(d,i.getWorldMatrix()),o.push(h.x,h.y,h.z),l.push(d.x,d.y,d.z)}const c=new be;return c.positions=o,c.normals=l,c.uvs=i.getVerticesData(I.UVKind),c.colors=i.getVerticesData(I.ColorKind),i&&i.getIndices&&(c.indices=i.getIndices()),c.applyToMesh(i),i.position=E.Zero(),i.rotationQuaternion=null,i.rotation=E.Zero(),i.computeWorldMatrix(!0),c}return be.ExtractFromMesh(i)}_createSoftbody(t){const i=t.object;if(i&&i.getIndices){let n=i.getIndices();n||(n=[]);const s=this._softVertexData(t),a=s.positions,o=s.normals;if(null===a||null===o)return new this.bjsAMMO.btCompoundShape;{const l=[],c=[];for(let g=0;g<a.length;g+=3){const _=new E(a[g],a[g+1],a[g+2]),m=new E(o[g],o[g+1],o[g+2]);l.push(_.x,_.y,-_.z),c.push(m.x,m.y,-m.z)}const u=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),l,i.getIndices(),n.length/3,!0),h=a.length/3,d=u.get_m_nodes();let f,p;for(let g=0;g<h;g++)f=d.at(g),p=f.get_m_n(),p.setX(c[3*g]),p.setY(c[3*g+1]),p.setZ(c[3*g+2]);return u}}}_createCloth(t){const i=t.object;if(i&&i.getIndices){let n=i.getIndices();n||(n=[]);const s=this._softVertexData(t),a=s.positions,o=s.normals;if(null===a||null===o)return new this.bjsAMMO.btCompoundShape;{const l=a.length,c=Math.sqrt(l/3);t.segments=c;const u=c-1;return this._tmpAmmoVectorA.setValue(a[0],a[1],a[2]),this._tmpAmmoVectorB.setValue(a[3*u],a[3*u+1],a[3*u+2]),this._tmpAmmoVectorD.setValue(a[l-3],a[l-2],a[l-1]),this._tmpAmmoVectorC.setValue(a[l-3-3*u],a[l-2-3*u],a[l-1-3*u]),(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,c,c,t.getParam("fixedPoints"),!0)}}}_createRope(t){let i,n;const s=this._softVertexData(t),a=s.positions,o=s.normals;if(null===a||null===o)return new this.bjsAMMO.btCompoundShape;if(s.applyToMesh(t.object,!0),t._isFromLine=!0,0===o.map(f=>f*f).reduce((f,p)=>f+p))i=a.length,n=i/3-1,this._tmpAmmoVectorA.setValue(a[0],a[1],a[2]),this._tmpAmmoVectorB.setValue(a[i-3],a[i-2],a[i-1]);else{t._isFromLine=!1;const f=t.getParam("path");if(null===t.getParam("shape"))return H.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=f.length,n=i-1,this._tmpAmmoVectorA.setValue(f[0].x,f[0].y,f[0].z),this._tmpAmmoVectorB.setValue(f[i-1].x,f[i-1].y,f[i-1].z)}t.segments=n;let h=t.getParam("fixedPoints");h=h>3?3:h;const d=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,n-1,h);return d.get_m_cfg().set_collisions(17),d}_createCustom(t){let i=null;return this.onCreateCustomShape&&(i=this.onCreateCustomShape(t)),null==i&&(i=new this.bjsAMMO.btCompoundShape),i}_addHullVerts(t,i,n){let s=0;if(n&&n.getIndices&&n.getWorldMatrix&&n.getChildMeshes){let a=n.getIndices();a||(a=[]);let o=n.getVerticesData(I.PositionKind);o||(o=[]),n.computeWorldMatrix(!1);const l=a.length/3;for(let c=0;c<l;c++){const u=[];for(let h=0;h<3;h++){let f,d=new E(o[3*a[3*c+h]+0],o[3*a[3*c+h]+1],o[3*a[3*c+h]+2]);B.ScalingToRef(n.scaling.x,n.scaling.y,n.scaling.z,this._tmpMatrix),d=E.TransformCoordinates(d,this._tmpMatrix),f=0==h?this._tmpAmmoVectorA:1==h?this._tmpAmmoVectorB:this._tmpAmmoVectorC,f.setValue(d.x,d.y,d.z),u.push(f)}t.addPoint(u[0],!0),t.addPoint(u[1],!0),t.addPoint(u[2],!0),s++}n.getChildMeshes().forEach(c=>{s+=this._addHullVerts(t,i,c)})}return s}_createShape(t,i=!1){const n=t.object;let s;const a=t.getObjectExtents();if(!i){const o=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];s=new this.bjsAMMO.btCompoundShape;let l=0;if(o.forEach(c=>{const u=c.getPhysicsImpostor();if(u){if(u.type==ut.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const h=this._createShape(u),d=c.parent.getWorldMatrix().clone(),f=new E;d.decompose(f),this._tmpAmmoTransform.getOrigin().setValue(c.position.x*f.x,c.position.y*f.y,c.position.z*f.z),this._tmpAmmoQuaternion.setValue(c.rotationQuaternion.x,c.rotationQuaternion.y,c.rotationQuaternion.z,c.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,h),u.dispose(),l++}}),l>0){if(t.type!=ut.NoImpostor){const c=this._createShape(t,!0);c&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,c))}return s}this.bjsAMMO.destroy(s),s=null}switch(t.type){case ut.SphereImpostor:if(Se.WithinEpsilon(a.x,a.y,1e-4)&&Se.WithinEpsilon(a.x,a.z,1e-4))s=new this.bjsAMMO.btSphereShape(a.x/2);else{const o=[new this.bjsAMMO.btVector3(0,0,0)];s=new this.bjsAMMO.btMultiSphereShape(o,[1],1),s.setLocalScaling(new this.bjsAMMO.btVector3(a.x/2,a.y/2,a.z/2))}break;case ut.CapsuleImpostor:{const o=a.x/2;s=new this.bjsAMMO.btCapsuleShape(o,a.y-2*o)}break;case ut.CylinderImpostor:this._tmpAmmoVectorA.setValue(a.x/2,a.y/2,a.z/2),s=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case ut.PlaneImpostor:case ut.BoxImpostor:this._tmpAmmoVectorA.setValue(a.x/2,a.y/2,a.z/2),s=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case ut.MeshImpostor:if(0==t.getParam("mass")){if(this.onCreateCustomMeshImpostor)s=this.onCreateCustomMeshImpostor(t);else{const o=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(o),s=0==this._addMeshVerts(o,n,n)?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(o)}break}case ut.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)s=this.onCreateCustomConvexHullImpostor(t);else{const o=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(o,n,n)?(t._pluginData.toDispose.push(o),s=new this.bjsAMMO.btCompoundShape):s=o}break;case ut.NoImpostor:s=new this.bjsAMMO.btSphereShape(a.x/2);break;case ut.CustomImpostor:s=this._createCustom(t);break;case ut.SoftbodyImpostor:s=this._createSoftbody(t);break;case ut.ClothImpostor:s=this._createCloth(t);break;case ut.RopeImpostor:s=this._createRope(t);break;default:H.Warn("The impostor type is not currently supported by the ammo plugin.")}return s}setTransformationFromPhysicsBody(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))}setPhysicsBodyTransformation(t,i,n){const s=t.physicsBody.getWorldTransform();if(Math.abs(s.getOrigin().x()-i.x)>kt||Math.abs(s.getOrigin().y()-i.y)>kt||Math.abs(s.getOrigin().z()-i.z)>kt||Math.abs(s.getRotation().x()-n.x)>kt||Math.abs(s.getRotation().y()-n.y)>kt||Math.abs(s.getRotation().z()-n.z)>kt||Math.abs(s.getRotation().w()-n.w)>kt)if(this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),s.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(n.x,n.y,n.z,n.w),s.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(s),0==t.mass){const a=t.physicsBody.getMotionState();a&&a.setWorldTransform(s)}else t.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(t){let i;if(i=t.soft?t.physicsBody.linearVelocity():t.physicsBody.getLinearVelocity(),!i)return null;const n=new E(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),n}getAngularVelocity(t){let i;if(i=t.soft?t.physicsBody.angularVelocity():t.physicsBody.getAngularVelocity(),!i)return null;const n=new E(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),n}setBodyMass(t,i){t.soft?t.physicsBody.setTotalMass(i,!1):t.physicsBody.setMassProps(i),t._pluginData.mass=i}getBodyMass(t){return t._pluginData.mass||0}getBodyFriction(t){return t._pluginData.friction||0}setBodyFriction(t,i){t.soft?t.physicsBody.get_m_cfg().set_kDF(i):t.physicsBody.setFriction(i),t._pluginData.friction=i}getBodyRestitution(t){return t._pluginData.restitution||0}setBodyRestitution(t,i){t.physicsBody.setRestitution(i),t._pluginData.restitution=i}getBodyPressure(t){return t.soft?t._pluginData.pressure||0:(H.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(t,i){t.soft?t.type===ut.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(i),t._pluginData.pressure=i):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):H.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(t){return t.soft?t._pluginData.stiffness||0:(H.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(t,i){t.soft?(i=(i=i<0?0:i)>1?1:i,t.physicsBody.get_m_materials().at(0).set_m_kLST(i),t._pluginData.stiffness=i):H.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(t){return t.soft?t._pluginData.velocityIterations||0:(H.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_viterations(i),t._pluginData.velocityIterations=i):H.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(t){return t.soft?t._pluginData.positionIterations||0:(H.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_piterations(i),t._pluginData.positionIterations=i):H.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(t,i,n,s,a=1,o=!1){const l=t.segments,c=Math.round((l-1)*n),u=Math.round((l-1)*s);t.physicsBody.appendAnchor(c+l*(l-1-u),i.physicsBody,o,a)}appendHook(t,i,n,s=1,a=!1){const o=Math.round(t.segments*n);t.physicsBody.appendAnchor(o,i.physicsBody,a,s)}sleepBody(t){t.physicsBody.forceActivationState(0)}wakeUpBody(t){t.physicsBody.activate()}updateDistanceJoint(){H.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(t,i,n){t.physicsJoint.enableAngularMotor(!0,i,n)}setLimit(){H.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(t,i){i.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(t){return t.getObjectExtents().x/2}getBoxSizeToRef(t,i){const n=t.getObjectExtents();i.x=n.x,i.y=n.y,i.z=n.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(t,i){return this.raycastToRef(t,i,this._raycastResult),this._raycastResult}raycastToRef(t,i,n){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(i.x,i.y,i.z);const s=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,s),n.reset(t,i),s.hasHit()&&(n.setHitData({x:s.get_m_hitNormalWorld().x(),y:s.get_m_hitNormalWorld().y(),z:s.get_m_hitNormalWorld().z()},{x:s.get_m_hitPointWorld().x(),y:s.get_m_hitPointWorld().y(),z:s.get_m_hitPointWorld().z()}),n.calculateHitDistance()),this.bjsAMMO.destroy(s),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}return r._DISABLE_COLLISION_FLAG=4,r._KINEMATIC_FLAG=2,r._DISABLE_DEACTIVATION_FLAG=4,r})();class Cp{}Cp.LoaderInjectedPhysicsEngine=void 0;let ru={},Yo={};const fF=(r,e,t,i)=>{if(!e.materials)return null;for(let n=0,s=e.materials.length;n<s;n++){const a=e.materials[n];if(r(a))return{parsedMaterial:a,material:le.Parse(a,t,i)}}return null},p8=(r,e,t)=>{for(const i in e)if(r.name===e[i])return t.push(r.id),!0;return void 0!==r.parentId&&-1!==t.indexOf(r.parentId)&&(t.push(r.id),!0)},su=(r,e)=>r+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),pF=(r,e)=>{const t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){const i=e._waitingData.lods.ids,n=t.isEnabled(!1);if(e._waitingData.lods.distances){const s=e._waitingData.lods.distances;if(s.length>=i.length){const a=s.length>i.length?s[s.length-1]:0;t.setEnabled(!1);for(let o=0;o<i.length;o++){const c=r.getMeshById(i[o]);null!=c&&t.addLODLevel(s[o],c)}a>0&&t.addLODLevel(a,null),!0===n&&t.setEnabled(!0)}else Ie.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},Ip=(r,e,t)=>{if("number"!=typeof r){const n=t.getLastEntryById(r);return n&&null!=e?n.instances[parseInt(e)]:n}const i=ru[r];return i&&null!=e?i.instances[parseInt(e)]:i},Rp=(r,e)=>"number"!=typeof r?e.getLastMaterialById(r,!0):Yo[r],gF=(r,e,t,i,n=!1)=>{const s=new r8(r);let a="importScene has failed JSON parse";try{var o=JSON.parse(e);a="";const l=yt.loggingLevel===yt.DETAILED_LOGGING;let c,u;if(null!=o.environmentTexture){const d=void 0===o.isPBR||o.isPBR;if(o.environmentTextureType&&"BABYLON.HDRCubeTexture"===o.environmentTextureType){const f=o.environmentTextureSize?o.environmentTextureSize:128,p=new gw((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,r,f,!0,!d,void 0,o.environmentTexturePrefilterOnLoad);o.environmentTextureRotationY&&(p.rotationY=o.environmentTextureRotationY),r.environmentTexture=p}else if("object"==typeof o.environmentTexture){const f=Nn.Parse(o.environmentTexture,r,t);r.environmentTexture=f}else if(o.environmentTexture.endsWith(".env")){const f=new Nn((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,r,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(f.rotationY=o.environmentTextureRotationY),r.environmentTexture=f}else{const f=Nn.CreateFromPrefilteredData((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,r,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(f.rotationY=o.environmentTextureRotationY),r.environmentTexture=f}!0===o.createDefaultSkybox&&r.createDefaultSkybox(r.environmentTexture,d,null!=r.activeCamera?(r.activeCamera.maxZ-r.activeCamera.minZ)/2:1e3,o.skyboxBlurLevel||0),s.environmentTexture=r.environmentTexture}if(null!=o.environmentIntensity&&(r.environmentIntensity=o.environmentIntensity),null!=o.lights)for(c=0,u=o.lights.length;c<u;c++){const d=o.lights[c],f=Rt.Parse(d,r);f&&(ru[d.uniqueId]=f,s.lights.push(f),f._parentContainer=s,a+=0===c?"\n\tLights:":"",a+="\n\t\t"+f.toString(l))}if(null!=o.reflectionProbes)for(c=0,u=o.reflectionProbes.length;c<u;c++){const f=iu.Parse(o.reflectionProbes[c],r,t);f&&(s.reflectionProbes.push(f),f._parentContainer=s,a+=0===c?"\n\tReflection Probes:":"",a+="\n\t\t"+f.toString(l))}if(null!=o.animations)for(c=0,u=o.animations.length;c<u;c++){const d=o.animations[c],f=zr("BABYLON.Animation");if(f){const p=f.Parse(d);r.animations.push(p),s.animations.push(p),a+=0===c?"\n\tAnimations:":"",a+="\n\t\t"+p.toString(l)}}if(null!=o.materials)for(c=0,u=o.materials.length;c<u;c++){const d=o.materials[c],f=le.Parse(d,r,t);f&&(Yo[d.uniqueId||d.id]=f,s.materials.push(f),f._parentContainer=s,a+=0===c?"\n\tMaterials:":"",a+="\n\t\t"+f.toString(l),f.getActiveTextures().forEach(g=>{-1==s.textures.indexOf(g)&&(s.textures.push(g),g._parentContainer=s)}))}if(null!=o.multiMaterials)for(c=0,u=o.multiMaterials.length;c<u;c++){const d=o.multiMaterials[c],f=Vo.ParseMultiMaterial(d,r);Yo[d.uniqueId||d.id]=f,s.multiMaterials.push(f),f._parentContainer=s,a+=0===c?"\n\tMultiMaterials:":"",a+="\n\t\t"+f.toString(l),f.getActiveTextures().forEach(g=>{-1==s.textures.indexOf(g)&&(s.textures.push(g),g._parentContainer=s)})}if(null!=o.morphTargetManagers)for(const d of o.morphTargetManagers){const f=uF.Parse(d,r);s.morphTargetManagers.push(f),f._parentContainer=s}if(null!=o.skeletons)for(c=0,u=o.skeletons.length;c<u;c++){const f=Gh.Parse(o.skeletons[c],r);s.skeletons.push(f),f._parentContainer=s,a+=0===c?"\n\tSkeletons:":"",a+="\n\t\t"+f.toString(l)}const h=o.geometries;if(null!=h){const d=new Array,f=h.vertexData;if(null!=f)for(c=0,u=f.length;c<u;c++)d.push(pr.Parse(f[c],r,t));d.forEach(p=>{p&&(s.geometries.push(p),p._parentContainer=s)})}if(null!=o.transformNodes)for(c=0,u=o.transformNodes.length;c<u;c++){const d=o.transformNodes[c],f=gt.Parse(d,r,t);ru[d.uniqueId]=f,s.transformNodes.push(f),f._parentContainer=s}if(null!=o.meshes)for(c=0,u=o.meshes.length;c<u;c++){const d=o.meshes[c],f=U.Parse(d,r,t);if(ru[d.uniqueId]=f,s.meshes.push(f),f._parentContainer=s,f.hasInstances)for(const p of f.instances)s.meshes.push(p),p._parentContainer=s;a+=0===c?"\n\tMeshes:":"",a+="\n\t\t"+f.toString(l)}if(null!=o.cameras)for(c=0,u=o.cameras.length;c<u;c++){const d=o.cameras[c],f=it.Parse(d,r);ru[d.uniqueId]=f,s.cameras.push(f),f._parentContainer=s,a+=0===c?"\n\tCameras:":"",a+="\n\t\t"+f.toString(l)}if(null!=o.postProcesses)for(c=0,u=o.postProcesses.length;c<u;c++){const f=li.Parse(o.postProcesses[c],r,t);f&&(s.postProcesses.push(f),f._parentContainer=s,a+=0===c?"\nPostprocesses:":"",a+="\n\t\t"+f.toString())}if(null!=o.animationGroups)for(c=0,u=o.animationGroups.length;c<u;c++){const f=Vf.Parse(o.animationGroups[c],r);s.animationGroups.push(f),f._parentContainer=s,a+=0===c?"\n\tAnimationGroups:":"",a+="\n\t\t"+f.toString(l)}for(c=0,u=r.cameras.length;c<u;c++){const d=r.cameras[c];null!==d._waitingParentId&&(d.parent=Ip(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=r.lights.length;c<u;c++){const d=r.lights[c];d&&null!==d._waitingParentId&&(d.parent=Ip(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=r.transformNodes.length;c<u;c++){const d=r.transformNodes[c];null!==d._waitingParentId&&(d.parent=Ip(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=r.meshes.length;c<u;c++){const d=r.meshes[c];null!==d._waitingParentId&&(d.parent=Ip(d._waitingParentId,d._waitingParentInstanceIndex,r),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&pF(r,d)}for(r.multiMaterials.forEach(d=>{d._waitingSubMaterialsUniqueIds.forEach(f=>{d.subMaterials.push(Rp(f,r))}),d._waitingSubMaterialsUniqueIds=[]}),r.meshes.forEach(d=>{null!==d._waitingMaterialId&&(d.material=Rp(d._waitingMaterialId,r),d._waitingMaterialId=null)}),c=0,u=r.skeletons.length;c<u;c++){const d=r.skeletons[c];d._hasWaitingData&&(null!=d.bones&&d.bones.forEach(f=>{if(f._waitingTransformNodeId){const p=r.getLastEntryById(f._waitingTransformNodeId);p&&f.linkTransformNode(p),f._waitingTransformNodeId=null}}),d._hasWaitingData=null)}for(c=0,u=r.meshes.length;c<u;c++){const d=r.meshes[c];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(c=0,u=r.lights.length;c<u;c++){const d=r.lights[c];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){const p=r.getMeshById(d._excludedMeshesIds[f]);p&&d.excludedMeshes.push(p)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){const p=r.getMeshById(d._includedOnlyMeshesIds[f]);p&&d.includedOnlyMeshes.push(p)}d._includedOnlyMeshesIds=[]}}for(r.geometries.forEach(d=>{d._loadedUniqueId=""}),cs.Parse(o,r,s,t),c=0,u=r.meshes.length;c<u;c++){const d=r.meshes[c];d._waitingData.actions&&(Oa.Parse(d._waitingData.actions,d,r),d._waitingData.actions=null)}null!=o.actions&&Oa.Parse(o.actions,null,r)}catch(l){const c=su("loadAssets",o?o.producer:"Unknown")+a;if(!i)throw H.Log(c),l;i(c,l)}finally{ru={},Yo={},n||s.removeAllFromScene(),null!==a&&yt.loggingLevel!==yt.NO_LOGGING&&H.Log(su("loadAssets",o?o.producer:"Unknown")+(yt.loggingLevel!==yt.MINIMAL_LOGGING?a:""))}return s};yt.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:r=>-1!==r.indexOf("babylon"),importMesh:(r,e,t,i,n,s,a,o)=>{var l;let c="importMesh has failed JSON parse";try{var u=JSON.parse(t);c="";const h=yt.loggingLevel===yt.DETAILED_LOGGING;r?Array.isArray(r)||(r=[r]):r=null;const d=new Array,f=new Map,p=[];if(null!=u.transformNodes)for(let g=0,_=u.transformNodes.length;g<_;g++){const T=gt.Parse(u.transformNodes[g],e,i);p.push(T),f.set(T._waitingParsedUniqueId,T),T._waitingParsedUniqueId=null}if(null!=u.meshes){const g=[],_=[],m=[],T=[];for(let A=0,S=u.meshes.length;A<S;A++){const x=u.meshes[A];if(null===r||p8(x,r,d)){if(null!==r&&delete r[r.indexOf(x.name)],null!=x.geometryId&&null!=u.geometries){let R=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(D=>{!0===R||!u.geometries[D]||!Array.isArray(u.geometries[D])||u.geometries[D].forEach(P=>{P.id===x.geometryId&&("vertexData"===D&&pr.Parse(P,e,i),R=!0)})}),!1===R&&H.Warn("Geometry not found for mesh "+x.id)}if(x.materialUniqueId||x.materialId){const R=x.materialUniqueId?m:_;let D=-1!==R.indexOf(x.materialUniqueId||x.materialId);if(!1===D&&null!=u.multiMaterials){const P=(N,k)=>{R.push(N);const X=fF(k,u,e,i);X&&X.material&&(Yo[X.parsedMaterial.uniqueId||X.parsedMaterial.id]=X.material,c+="\n\tMaterial "+X.material.toString(h))};for(let N=0,k=u.multiMaterials.length;N<k;N++){const X=u.multiMaterials[N];if(x.materialUniqueId&&X.uniqueId===x.materialUniqueId||X.id===x.materialId){X.materialsUniqueIds?X.materialsUniqueIds.forEach(ge=>P(ge,ue=>ue.uniqueId===ge)):X.materials.forEach(ge=>P(ge,ue=>ue.id===ge)),R.push(X.uniqueId||X.id);const ne=Vo.ParseMultiMaterial(X,e);Yo[X.uniqueId||X.id]=ne,ne&&(D=!0,c+="\n\tMulti-Material "+ne.toString(h));break}}}if(!1===D){R.push(x.materialUniqueId||x.materialId);const P=fF(N=>x.materialUniqueId&&N.uniqueId===x.materialUniqueId||N.id===x.materialId,u,e,i);P&&P.material?(Yo[P.parsedMaterial.uniqueId||P.parsedMaterial.id]=P.material,c+="\n\tMaterial "+P.material.toString(h)):H.Warn("Material not found for mesh "+x.id)}}if(x.skeletonId>-1&&null!=u.skeletons&&!(g.indexOf(x.skeletonId)>-1))for(let D=0,P=u.skeletons.length;D<P;D++){const N=u.skeletons[D];if(N.id===x.skeletonId){const k=Gh.Parse(N,e);a.push(k),g.push(N.id),c+="\n\tSkeleton "+k.toString(h)}}if(x.morphTargetManagerId>-1&&null!=u.morphTargetManagers&&!(T.indexOf(x.morphTargetManagerId)>-1))for(let D=0,P=u.morphTargetManagers.length;D<P;D++){const N=u.morphTargetManagers[D];if(N.id===x.morphTargetManagerId){const k=uF.Parse(N,e);T.push(k.uniqueId),c+="\nMorph target "+k.toString()}}const C=U.Parse(x,e,i);n.push(C),f.set(C._waitingParsedUniqueId,C),C._waitingParsedUniqueId=null,c+="\n\tMesh "+C.toString(h)}}e.multiMaterials.forEach(A=>{A._waitingSubMaterialsUniqueIds.forEach(S=>{A.subMaterials.push(Rp(S,e))}),A._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(A=>{null!==A._waitingMaterialId&&(A.material=Rp(A._waitingMaterialId,e),A._waitingMaterialId=null)});for(let A=0,S=e.transformNodes.length;A<S;A++){const x=e.transformNodes[A];if(null!==x._waitingParentId){let C=f.get(parseInt(x._waitingParentId))||null;null===C&&(C=e.getLastEntryById(x._waitingParentId));let R=C;x._waitingParentInstanceIndex&&(R=C.instances[parseInt(x._waitingParentInstanceIndex)],x._waitingParentInstanceIndex=null),x.parent=R,x._waitingParentId=null}}let v;for(let A=0,S=e.meshes.length;A<S;A++){if(v=e.meshes[A],v._waitingParentId){let x=f.get(parseInt(v._waitingParentId))||null;null===x&&(x=e.getLastEntryById(v._waitingParentId));let C=x;if(v._waitingParentInstanceIndex&&(C=x.instances[parseInt(v._waitingParentInstanceIndex)],v._waitingParentInstanceIndex=null),v.parent=C,"TransformNode"===(null===(l=v.parent)||void 0===l?void 0:l.getClassName())){const R=p.indexOf(v.parent);R>-1&&p.splice(R,1)}v._waitingParentId=null}v._waitingData.lods&&pF(e,v)}for(const A of p)A.dispose();for(let A=0,S=e.skeletons.length;A<S;A++){const x=e.skeletons[A];x._hasWaitingData&&(null!=x.bones&&x.bones.forEach(C=>{if(C._waitingTransformNodeId){const R=e.getLastEntryById(C._waitingTransformNodeId);R&&C.linkTransformNode(R),C._waitingTransformNodeId=null}}),x._hasWaitingData=null)}for(let A=0,S=e.meshes.length;A<S;A++)v=e.meshes[A],v._waitingData.freezeWorldMatrix?(v.freezeWorldMatrix(),v._waitingData.freezeWorldMatrix=null):v.computeWorldMatrix(!0)}if(null!=u.particleSystems){const g=cs.GetIndividualParser(Bi.NAME_PARTICLESYSTEM);if(g)for(let _=0,m=u.particleSystems.length;_<m;_++){const T=u.particleSystems[_];-1!==d.indexOf(T.emitterId)&&s.push(g(T,e,i))}}return e.geometries.forEach(g=>{g._loadedUniqueId=""}),!0}catch(h){const d=su("importMesh",u?u.producer:"Unknown")+c;if(!o)throw H.Log(d),h;o(d,h)}finally{null!==c&&yt.loggingLevel!==yt.NO_LOGGING&&H.Log(su("importMesh",u?u.producer:"Unknown")+(yt.loggingLevel!==yt.MINIMAL_LOGGING?c:"")),Yo={}}return!1},load:(r,e,t,i)=>{let n="importScene has failed JSON parse";try{var s=JSON.parse(e);if(n="",null!=s.useDelayedTextureLoading&&(r.useDelayedTextureLoading=s.useDelayedTextureLoading&&!yt.ForceFullSceneLoadingForIncremental),null!=s.autoClear&&(r.autoClear=s.autoClear),null!=s.clearColor&&(r.clearColor=ct.FromArray(s.clearColor)),null!=s.ambientColor&&(r.ambientColor=Fe.FromArray(s.ambientColor)),null!=s.gravity&&(r.gravity=E.FromArray(s.gravity)),void 0!==s.useRightHandedSystem&&(r.useRightHandedSystem=!!s.useRightHandedSystem),s.fogMode&&0!==s.fogMode)switch(r.fogMode=s.fogMode,r.fogColor=Fe.FromArray(s.fogColor),r.fogStart=s.fogStart,r.fogEnd=s.fogEnd,r.fogDensity=s.fogDensity,n+="\tFog mode for scene:  ",r.fogMode){case 1:n+="exp\n";break;case 2:n+="exp2\n";break;case 3:n+="linear\n"}if(s.physicsEnabled){let o;"cannon"===s.physicsEngine||s.physicsEngine===GE.name?o=new GE(void 0,void 0,Cp.LoaderInjectedPhysicsEngine):"oimo"===s.physicsEngine||s.physicsEngine===hF.name?o=new hF(void 0,Cp.LoaderInjectedPhysicsEngine):("ammo"===s.physicsEngine||s.physicsEngine===dF.name)&&(o=new dF(void 0,Cp.LoaderInjectedPhysicsEngine,void 0)),n="\tPhysics engine "+(s.physicsEngine?s.physicsEngine:"oimo")+" enabled\n";const l=s.physicsGravity?E.FromArray(s.physicsGravity):null;r.enablePhysics(l,o)}return null!=s.metadata&&(r.metadata=s.metadata),null!=s.collisionsEnabled&&(r.collisionsEnabled=s.collisionsEnabled),!!gF(r,e,t,i,!0)&&(s.autoAnimate&&r.beginAnimation(r,s.autoAnimateFrom,s.autoAnimateTo,s.autoAnimateLoop,s.autoAnimateSpeed||1),null!=s.activeCameraID&&r.setActiveCameraById(s.activeCameraID),!0)}catch(a){const o=su("importScene",s?s.producer:"Unknown")+n;if(!i)throw H.Log(o),a;i(o,a)}finally{null!==n&&yt.loggingLevel!==yt.NO_LOGGING&&H.Log(su("importScene",s?s.producer:"Unknown")+(yt.loggingLevel!==yt.MINIMAL_LOGGING?n:""))}return!1},loadAssetContainer:(r,e,t,i)=>gF(r,e,t,i)}),ye("BABYLON.PlaySoundAction",class g8 extends bi{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}),ye("BABYLON.StopSoundAction",class _8 extends bi{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}),ye("BABYLON.InterpolateValueAction",class m8 extends bi{constructor(e,t,i,n,s=1e3,a,o,l){super(e,a),this.duration=1e3,this.onInterpolationDoneObservable=new J,this.propertyPath=i,this.value=n,this.duration=s,this.stopOtherAnimations=o,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if("number"==typeof this.value)i=Me.ANIMATIONTYPE_FLOAT;else if(this.value instanceof Fe)i=Me.ANIMATIONTYPE_COLOR3;else if(this.value instanceof E)i=Me.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof B)i=Me.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof Be))return void H.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");i=Me.ANIMATIONTYPE_QUATERNION}const n=new Me("InterpolateValueAction",this._property,1e3/this.duration*100,i,Me.ANIMATIONLOOPMODE_CONSTANT);n.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget),e.beginDirectAnimation(this._effectiveTarget,[n],0,100,!1,1,()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()})}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[bi._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bi._SerializeValueAsString(this.value)},{name:"duration",value:bi._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:bi._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}});Z.ShadersStore.glowMapGenerationPixelShader="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;\nuniform sampler2D opacitySampler;\nuniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor;\n#else\ngl_FragColor=finalColor;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";Z.ShadersStore.glowMapGenerationVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;\nuniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{\nvec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;\ngl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";class ps{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const n=e[i];t?this._materialForRendering[n.uniqueId]=[n,t]:delete this._materialForRendering[n.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new ct},this.neutralColor=new ct,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new J,this.onBeforeRenderMainTextureObservable=new J,this.onBeforeComposeObservable=new J,this.onBeforeRenderMeshToEffect=new J,this.onAfterRenderMeshToEffect=new J,this.onAfterComposeObservable=new J,this.onSizeChangedObservable=new J,this._materialForRendering={},this.name=e,this._scene=t||Je.LastCreatedScene,ps._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions=Mi({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0},e),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new I(this._engine,e,I.PositionKind,!1,!1,2);this._vertexBuffers[I.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?Ve.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?Ve.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new ir("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=j.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=j.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(j.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let n=0;n<e.subMeshes.length;++n){const s=e.subMeshes[n],a=s.getMaterial(),o=s.getRenderingMesh();if(!a)continue;const c=o._getInstancesRenderList(s._id,!!s.getReplacementMesh()).hardwareInstancedRendering[s._id]||o.hasThinInstances;if(this._setEmissiveTextureAndColor(o,s,a),!this._isReady(s,c,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,n)=>{let s;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const a=this._scene.getEngine();if(n.length){for(a.setColorWrite(!1),s=0;s<n.length;s++)this._renderSubMesh(n.data[s]);a.setColorWrite(!0)}for(s=0;s<e.length;s++)this._renderSubMesh(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMesh(t.data[s]);const o=a.getAlphaMode();for(s=0;s<i.length;s++)this._renderSubMesh(i.data[s],!0);a.setAlphaMode(o)},this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e}),this._mainTexture.onAfterUnbindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=e})}}_addCustomEffectDefines(e){}_isReady(e,t,i){var n;const s=this._scene.getEngine(),a=e.getMesh(),o=null===(n=a._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===n?void 0:n[s.currentRenderPassId];if(o)return o.isReadyForSubMesh(a,e,t);const l=e.getMaterial();if(!l)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return l.isReadyForSubMesh(e.getMesh(),e,t);const c=[],u=[I.PositionKind];let h=!1,d=!1;if(l){const v=l.needAlphaTesting(),A=l.getAlphaTestTexture(),S=A&&A.hasAlpha&&(l.useAlphaFromDiffuseTexture||l._useAlphaFromAlbedoTexture);A&&(v||S)&&(c.push("#define DIFFUSE"),a.isVerticesDataPresent(I.UV2Kind)&&1===A.coordinatesIndex?(c.push("#define DIFFUSEUV2"),d=!0):a.isVerticesDataPresent(I.UVKind)&&(c.push("#define DIFFUSEUV1"),h=!0),v&&(c.push("#define ALPHATEST"),c.push("#define ALPHATESTVALUE 0.4")),A.gammaSpace||c.push("#define DIFFUSE_ISLINEAR"));const x=l.opacityTexture;x&&(c.push("#define OPACITY"),a.isVerticesDataPresent(I.UV2Kind)&&1===x.coordinatesIndex?(c.push("#define OPACITYUV2"),d=!0):a.isVerticesDataPresent(I.UVKind)&&(c.push("#define OPACITYUV1"),h=!0))}i&&(c.push("#define EMISSIVE"),a.isVerticesDataPresent(I.UV2Kind)&&1===i.coordinatesIndex?(c.push("#define EMISSIVEUV2"),d=!0):a.isVerticesDataPresent(I.UVKind)&&(c.push("#define EMISSIVEUV1"),h=!0),i.gammaSpace||c.push("#define EMISSIVE_ISLINEAR")),a.useVertexColors&&a.isVerticesDataPresent(I.ColorKind)&&a.hasVertexAlpha&&l.transparencyMode!==le.MATERIAL_OPAQUE&&(u.push(I.ColorKind),c.push("#define VERTEXALPHA")),h&&(u.push(I.UVKind),c.push("#define UV1")),d&&(u.push(I.UV2Kind),c.push("#define UV2"));const f=new xl;if(a.useBones&&a.computeBonesUsingShaders){u.push(I.MatricesIndicesKind),u.push(I.MatricesWeightsKind),a.numBoneInfluencers>4&&(u.push(I.MatricesIndicesExtraKind),u.push(I.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers);const v=a.skeleton;c.push(v&&v.isUsingTextureForMatrices?"#define BONETEXTURE":"#define BonesPerMesh "+(v?v.bones.length+1:0)),a.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,a)}else c.push("#define NUM_BONE_INFLUENCERS 0");const p=a.morphTargetManager;let g=0;p&&p.numInfluencers>0&&(c.push("#define MORPHTARGETS"),g=p.numInfluencers,c.push("#define NUM_MORPH_INFLUENCERS "+g),p.isUsingTextureForTargets&&c.push("#define MORPHTARGETS_TEXTURE"),fe.PrepareAttributesForMorphTargetsInfluencers(u,a,g)),t&&(c.push("#define INSTANCES"),fe.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),kf(l,this._scene,c),this._addCustomEffectDefines(c);const _=e._getDrawWrapper(void 0,!0),m=_.defines,T=c.join("\n");if(m!==T){const v=["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices"];Sl(v),_.setEffect(this._engine.createEffect("glowMapGeneration",u,v,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],T,f,void 0,void 0,{maxSimultaneousMorphTargets:g}),T)}return _.effect.isReady()}render(){for(let a=0;a<this._postProcesses.length;a++)if(!this._postProcesses[a].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let a=0;a<t;++a){let o=this._mergeDrawWrapper[a];o||(o=this._mergeDrawWrapper[a]=new Qs(this._engine),o.setEffect(this._createMergeEffect())),i=i&&o.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const n=e.getAlphaMode();for(let a=0;a<t;++a){const o=this._mergeDrawWrapper[a];e.enableEffect(o),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,o.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(o.effect,a)}e.setAlphaMode(n),this.onAfterComposeObservable.notifyObservers(this);const s=this._mainTexture.getSize();this._setMainTextureSize(),(s.width!==this._mainTextureDesiredSize.width||s.height!==this._mainTextureDesiredSize.height)&&0!==this._mainTextureDesiredSize.width&&0!==this._mainTextureDesiredSize.height&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){var i,n;if(!this.shouldRender())return;const s=e.getMaterial(),a=e.getMesh(),o=e.getReplacementMesh(),l=e.getRenderingMesh(),c=e.getEffectiveMesh(),u=this._scene,h=u.getEngine();if(c._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!s||!this._canRenderMesh(l,s))return;let d=null!==(i=l.overrideMaterialSideOrientation)&&void 0!==i?i:s.sideOrientation;c._getWorldMatrixDeterminant()<0&&(d=d===le.ClockWiseSideOrientation?le.CounterClockWiseSideOrientation:le.ClockWiseSideOrientation),h.setState(s.backFaceCulling,s.zOffset,void 0,d===le.ClockWiseSideOrientation,s.cullBackFaces,void 0,s.zOffsetUnits);const g=l._getInstancesRenderList(e._id,!!o);if(g.mustReturn||!this._shouldRenderMesh(l))return;const _=g.hardwareInstancedRendering[e._id]||l.hasThinInstances;if(this._setEmissiveTextureAndColor(l,e,s),this.onBeforeRenderMeshToEffect.notifyObservers(a),this._useMeshMaterial(l))l.render(e,t,o||void 0);else if(this._isReady(e,_,this._emissiveTextureAndColor.texture)){const m=null===(n=c._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===n?void 0:n[h.currentRenderPassId];let T=e._getDrawWrapper();if(!T&&m&&(T=m._getDrawWrapper()),!T)return;const v=T.effect;if(h.enableEffect(T),_||l._bind(e,v,s.fillMode),m?m.bindForSubMesh(c.getWorldMatrix(),c,e):(v.setMatrix("viewProjection",u.getTransformMatrix()),v.setMatrix("world",c.getWorldMatrix()),v.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!m){const A=s.needAlphaTesting(),S=s.getAlphaTestTexture(),x=S&&S.hasAlpha&&(s.useAlphaFromDiffuseTexture||s._useAlphaFromAlbedoTexture);if(S&&(A||x)){v.setTexture("diffuseSampler",S);const R=S.getTextureMatrix();R&&v.setMatrix("diffuseMatrix",R)}const C=s.opacityTexture;if(C){v.setTexture("opacitySampler",C),v.setFloat("opacityIntensity",C.level);const R=C.getTextureMatrix();R&&v.setMatrix("opacityMatrix",R)}if(this._emissiveTextureAndColor.texture&&(v.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),v.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),l.useBones&&l.computeBonesUsingShaders&&l.skeleton){const R=l.skeleton;if(R.isUsingTextureForMatrices){const D=R.getTransformMatrixTexture(l);if(!D)return;v.setTexture("boneSampler",D),v.setFloat("boneTextureWidth",4*(R.bones.length+1))}else v.setMatrices("mBones",R.getTransformMatrices(l))}fe.BindMorphTargetParameters(l,v),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(v),t&&h.setAlphaMode(s.alphaMode),Uo(v,s,u)}l._processRendering(c,e,v,s.fillMode,g,_,(A,S)=>v.setMatrix("world",S))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(a)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[I.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[I.PositionKind];e&&(e.dispose(),this._vertexBuffers[I.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const i of this._mergeDrawWrapper)i.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return Ie.Instantiate(e.customType).Parse(e,t,i)}}ps._SceneComponentInitialization=r=>{throw ht("EffectLayerSceneComponent")},b([O()],ps.prototype,"name",void 0),b([jm()],ps.prototype,"neutralColor",void 0),b([O()],ps.prototype,"isEnabled",void 0),b([function uz(r){return rs(11,r)}()],ps.prototype,"camera",null),b([O()],ps.prototype,"renderingGroupId",null),b([O()],ps.prototype,"disableBoundingBoxesFromEffectLayer",void 0),cs.AddParser(Bi.NAME_EFFECTLAYER,(r,e,t,i)=>{if(r.effectLayers){t.effectLayers||(t.effectLayers=new Array);for(let n=0;n<r.effectLayers.length;n++){const s=ps.Parse(r.effectLayers[n],e,i);t.effectLayers.push(s)}}}),cs.prototype.removeEffectLayer=function(r){const e=this.effectLayers.indexOf(r);return-1!==e&&this.effectLayers.splice(e,1),e},cs.prototype.addEffectLayer=function(r){this.effectLayers.push(r)};class T8{constructor(e){this.name=Bi.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||Je.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=new Array)}register(){this.scene._isReadyForMeshStage.registerStep(Bi.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Bi.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Bi.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Bi.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Bi.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Bi.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){!e.effectLayers||e.effectLayers.forEach(t=>{this.scene.addEffectLayer(t)})}removeFromContainer(e,t){!e.effectLayers||e.effectLayers.forEach(i=>{this.scene.removeEffectLayer(i),t&&i.dispose()})}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,n=this.scene.effectLayers;for(const s of n)if(s.hasMesh(e)){this._engine.currentRenderPassId=s._mainTexture.renderPassId;for(const o of e.subMeshes)if(!s.isReady(o,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const n of i)if(n.shouldRender()&&(!n.camera||n.camera.cameraRigMode===it.RIG_MODE_NONE&&e===n.camera||n.camera.cameraRigMode!==it.RIG_MODE_NONE&&n.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||n.needStencil();const s=n._mainTexture;s._shouldRender()&&(this.scene.incrementRenderId(),s.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const n=t[i];n.renderingGroupId===e&&n.shouldRender()&&n.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}ps._SceneComponentInitialization=r=>{let e=r._getComponent(Bi.NAME_EFFECTLAYER);e||(e=new T8(r),r._addComponent(e))};Z.ShadersStore.glowMapMergePixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);\nbaseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);\nbaseColor.a=alpha;\nbaseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";Z.ShadersStore.glowMapMergeVertexShader="attribute vec2 position;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}",cs.prototype.getGlowLayerByName=function(r){var e;for(let t=0;t<(null===(e=this.effectLayers)||void 0===e?void 0:e.length);t++)if(this.effectLayers[t].name===r&&this.effectLayers[t].getEffectName()===gs.EffectName)return this.effectLayers[t];return null};class gs extends ps{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new ct(0,0,0,1),this._options=Mi({mainTextureRatio:gs.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType})}getEffectName(){return gs.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[I.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?Ve.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?Ve.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new ir("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=j.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=j.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(j.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const n=Math.floor(e/2),s=Math.floor(t/2);this._blurTexture2=new ir("GlowLayerBlurRTT2",{width:n,height:s},this._scene,!1,!0,i),this._blurTexture2.wrapU=j.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=j.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(j.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const a=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new dr("GlowLayerHBP1",new We(1,0),a,{width:e,height:t},null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(o=>{o.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess1=new dr("GlowLayerVBP1",new We(0,1),a,{width:e,height:t},null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new dr("GlowLayerHBP2",new We(1,0),a,{width:n,height:s},null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=n,this._horizontalBlurPostprocess2.height=s,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(o=>{o.setTexture("textureSampler",this._blurTexture1)}),this._verticalBlurPostprocess2=new dr("GlowLayerVBP2",new We(0,1),a,{width:n,height:s},null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{const o=this._blurTexture1.renderTarget;if(o){this._scene.postProcessManager.directRender(this._postProcesses1,o,!0);const l=this._blurTexture2.renderTarget;l&&this._scene.postProcessManager.directRender(this._postProcesses2,l,!0),this._engine.unBindFramebuffer(null!=l?l:o,!0)}}),this._postProcesses.map(o=>{o.autoClear=!1})}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),n=e.getRenderingMesh();return!(!i||!n)&&super._isReady(e,t,i.emissiveTexture)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(le.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){var n;let s=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(s=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(s*=null!==(n=i.emissiveIntensity)&&void 0!==n?n:1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*s,i.emissiveColor.g*s,i.emissiveColor.b*s,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return 0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add(()=>{this._disposeMesh(e)})}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=lt.Serialize(this);let t;if(e.customType="BABYLON.GlowLayer",e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const n=lt.Parse(()=>new gs(e.name,t,e.options),e,t,i);let s;for(s=0;s<e.excludedMeshes.length;s++){const a=t.getMeshById(e.excludedMeshes[s]);a&&n.addExcludedMesh(a)}for(s=0;s<e.includedMeshes.length;s++){const a=t.getMeshById(e.includedMeshes[s]);a&&n.addIncludedOnlyMesh(a)}return n}}gs.EffectName="GlowLayer",gs.DefaultBlurKernelSize=32,gs.DefaultTextureRatio=.5,b([O()],gs.prototype,"blurKernelSize",null),b([O()],gs.prototype,"intensity",null),b([O("options")],gs.prototype,"_options",void 0),ye("BABYLON.GlowLayer",gs);Z.ShadersStore.glowBlurPostProcessPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",cs.prototype.getHighlightLayerByName=function(r){var e;for(let t=0;t<(null===(e=this.effectLayers)||void 0===e?void 0:e.length);t++)if(this.effectLayers[t].name===r&&this.effectLayers[t].getEffectName()===sr.EffectName)return this.effectLayers[t];return null};class CF extends li{constructor(e,t,i,n,s,a=j.BILINEAR_SAMPLINGMODE,o,l){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,n,s,a,o,l),this.direction=t,this.kernel=i,this.onApplyObservable.add(c=>{c.setFloat2("screenSize",this.width,this.height),c.setVector2("direction",this.direction),c.setFloat("blurWidth",this.kernel)})}}class sr extends ps{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new J,this.onAfterBlurObservable=new J,this._instanceGlowingMeshStencilReference=sr.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=sr.NeutralColor,this._engine.isStencilEnable||H.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options=Mi({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return sr.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[I.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?Ve.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?Ve.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new ir("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=j.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=j.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(j.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new Hc("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(n=>{n.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new CF("HighlightLayerHBP",new We(1,0),this._options.blurHorizontalSize,1,null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(n=>{n.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new CF("HighlightLayerVBP",new We(0,1),this._options.blurVerticalSize,1,null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(n=>{n.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new dr("HighlightLayerHBP",new We(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(n=>{n.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new dr("HighlightLayerVBP",new We(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,j.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);const n=this._blurTexture.renderTarget;n&&(this._scene.postProcessManager.directRender(this._postProcesses,n,!0),this._engine.unBindFramebuffer(n,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(n=>{n.autoClear=!1})}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),n=e.getRenderingMesh();if(!i||!n||!this._meshes)return!1;let s=null;const a=this._meshes[n.uniqueId];return a&&a.glowEmissiveOnly&&i&&(s=i.emissiveTexture),super._isReady(e,t,s)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(le.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(le.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const n=this._meshes[e.uniqueId];n?this._emissiveTextureAndColor.color.set(n.color.r,n.color.g,n.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),n&&n.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){const i={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};i.beforeBind=e.onBeforeBindObservable.add(n=>{i.stencilState=n.getEngine().getStencilBuffer(),n.getEngine().setStencilBuffer(!1)}),i.afterRender=e.onAfterRenderObservable.add(n=>{n.getEngine().setStencilBuffer(i.stencilState)}),this._excludedMeshes[e.uniqueId]=i}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!(!this._meshes||!super.hasMesh(e))&&null!=this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const n=this._meshes[e.uniqueId];n?n.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(s=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[s.uniqueId]?this._defaultStencilReference(s):s.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(s=>{this.isEnabled&&this._defaultStencilReference(s)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(sr.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=lt.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const n=lt.Parse(()=>new sr(e.name,t,e.options),e,t,i);let s;for(s=0;s<e.excludedMeshes.length;s++){const a=t.getMeshById(e.excludedMeshes[s]);a&&n.addExcludedMesh(a)}for(s=0;s<e.meshes.length;s++){const a=e.meshes[s],o=t.getMeshById(a.meshId);o&&n.addMesh(o,Fe.FromArray(a.color),a.glowEmissiveOnly)}return n}}sr.EffectName="HighlightLayer",sr.NeutralColor=new ct(0,0,0,0),sr.GlowingMeshStencilReference=2,sr.NormalMeshStencilReference=1,b([O()],sr.prototype,"innerGlow",void 0),b([O()],sr.prototype,"outerGlow",void 0),b([O()],sr.prototype,"blurHorizontalSize",null),b([O()],sr.prototype,"blurVerticalSize",null),b([O("options")],sr.prototype,"_options",void 0),ye("BABYLON.HighlightLayer",sr);Z.ShadersStore.layerPixelShader="varying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef LINEAR\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";Z.ShadersStore.layerVertexShader="attribute vec2 position;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";Z.IncludesShadersStore.boundingBoxRendererFragmentDeclaration="uniform vec4 color;\n";Z.IncludesShadersStore.boundingBoxRendererUboDeclaration="#ifdef WEBGL2\nuniform vec4 color;\nuniform mat4 world;\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#else\nlayout(std140,column_major) uniform;\nuniform BoundingBoxRenderer {\nvec4 color;\nmat4 world;\nmat4 viewProjection;\nmat4 viewProjectionR;\n};\n#endif\n";Z.ShadersStore.boundingBoxRendererPixelShader="#include<__decl__boundingBoxRendererFragment>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";Z.IncludesShadersStore.boundingBoxRendererVertexDeclaration="uniform mat4 world;\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n";Z.ShadersStore.boundingBoxRendererVertexShader="attribute vec3 position;\n#include<__decl__boundingBoxRendererVertex>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec4 worldPos=world*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n",Object.defineProperty(dt.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(r){this._forceShowBoundingBoxes=r,r&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),dt.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new E8(this)),this._boundingBoxRenderer},Object.defineProperty(hn.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(r){this._showBoundingBox=r,r&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class E8{constructor(e){this.name=Bi.NAME_BOUNDINGBOXRENDERER,this.frontColor=new Fe(1,1,1),this.backColor=new Fe(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new J,this.onAfterBoxRenderingObservable=new J,this.onResourcesReadyObservable=new J,this.enabled=!0,this.renderList=new Qn(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new He(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new He(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(Bi.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(Bi.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(Bi.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(Bi.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new ba("colorShader",this.scene,"boundingBoxRenderer",{attributes:[I.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new ba("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[I.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=CT({size:1});this._vertexBuffers[I.PositionKind]=new I(e,t.positions,I.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[I.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(0===this.renderList.length||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;const n=this.scene.getEngine();n.setDepthWrite(!1);const s=this.frontColor.toColor4(),a=this.backColor.toColor4(),o=this.scene.getTransformMatrix();for(let l=0;l<this.renderList.length;l++){const c=this.renderList.data[l];if(c._tag!==e)continue;this._createWrappersForBoundingBox(c),this.onBeforeBoxRenderingObservable.notifyObservers(c);const u=c.minimum,d=c.maximum.subtract(u),f=u.add(d.scale(.5)),p=B.Scaling(d.x,d.y,d.z).multiply(B.Translation(f.x,f.y,f.z)).multiply(c.getWorldMatrix()),g=n.useReverseDepthBuffer;if(this.showBackLines){const m=null!==(t=c._drawWrapperBack)&&void 0!==t?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(m),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),g?n.setDepthFunctionToLessOrEqual():n.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(m.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateDirectColor4("color",a),this._uniformBufferBack.updateMatrix("world",p),this._uniformBufferBack.updateMatrix("viewProjection",o),this._uniformBufferBack.update(),n.drawElementsType(le.LineListDrawMode,0,24)}const _=null!==(i=c._drawWrapperFront)&&void 0!==i?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(_),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),g?n.setDepthFunctionToGreater():n.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(_.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateDirectColor4("color",s),this._uniformBufferFront.updateMatrix("world",p),this._uniformBufferFront.updateMatrix("viewProjection",o),this._uniformBufferFront.update(),n.drawElementsType(le.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(c)}this._colorShader.unbind(),n.setDepthFunctionToLessOrEqual(),n.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new Qs(t),e._drawWrapperBack=new Qs(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const n=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,n)||!e.hasBoundingInfo)return void(t.currentRenderPassId=i);this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const s=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const a=e.getBoundingInfo().boundingBox,o=a.minimum,c=a.maximum.subtract(o),u=o.add(c.scale(.5)),h=B.Scaling(c.x,c.y,c.z).multiply(B.Translation(u.x,u.y,u.z)).multiply(a.getWorldMatrix()),d=n._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),s?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",h),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(le.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[I.PositionKind];e&&(e.dispose(),this._vertexBuffers[I.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}class Bn extends it{constructor(e,t,i,n=!0){super(e,t,i,n),this._tmpUpVector=E.Zero(),this._tmpTargetVector=E.Zero(),this.cameraDirection=new E(0,0,0),this.cameraRotation=new We(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new Be,this.rotation=new E(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=E.Zero(),this._initialFocalDistance=1,this._viewMatrix=B.Zero(),this._camMatrix=B.Zero(),this._cameraTransformMatrix=B.Zero(),this._cameraRotationMatrix=B.Zero(),this._referencePoint=new E(0,0,1),this._transformedReferencePoint=E.Zero(),this._defaultUp=E.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new Be(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=kt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),B.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);this.rotation.y=t.x>=0?-Math.atan(t.z/t.x)+Math.PI/2:-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&Be.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(z.Matrix[0]),E.TransformNormalToRef(this.cameraDirection,z.Matrix[0],z.Vector3[0]),void this.position.addInPlace(z.Vector3[0]);this.position.addInPlace(this.cameraDirection)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&Be.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),t&&(Math.abs(this.cameraDirection.x)<this.speed*kt&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*kt&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*kt&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*kt&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*kt&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):B.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return E.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),E.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?wo.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(Be.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),wo.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const n=this.parent.getWorldMatrix();E.TransformCoordinatesToRef(e,n,this._globalPosition),E.TransformCoordinatesToRef(t,n,this._tmpTargetVector),E.TransformNormalToRef(i,n,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?B.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):B.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?B.LookAtRHToRef(e,t,i,this._viewMatrix):B.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const n=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(n,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==it.RIG_MODE_NONE){const i=new Bn(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===it.RIG_MODE_VR||this.cameraRigMode===it.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new Be),i._cameraRigParams={},i.rotationQuaternion=new Be),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case it.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case it.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case it.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case it.RIG_MODE_STEREOSCOPIC_OVERUNDER:case it.RIG_MODE_STEREOSCOPIC_INTERLACED:{const n=this.cameraRigMode===it.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*(this.cameraRigMode===it.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1),e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,t);break}case it.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,Bn._TargetFocalPoint),Bn._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const n=Bn._TargetFocalPoint.addInPlace(this.position);B.TranslationToRef(-n.x,-n.y,-n.z,Bn._TargetTransformMatrix),Bn._TargetTransformMatrix.multiplyToRef(B.RotationAxis(t.upVector,e),Bn._RigCamTransformMatrix),B.TranslationToRef(n.x,n.y,n.z,Bn._TargetTransformMatrix),Bn._RigCamTransformMatrix.multiplyToRef(Bn._TargetTransformMatrix,Bn._RigCamTransformMatrix),E.TransformCoordinatesToRef(this.position,Bn._RigCamTransformMatrix,t.position),t.setTarget(n)}getClassName(){return"TargetCamera"}}Bn._RigCamTransformMatrix=new B,Bn._TargetTransformMatrix=new B,Bn._TargetFocalPoint=new E,b([Mr()],Bn.prototype,"rotation",void 0),b([O()],Bn.prototype,"speed",void 0),b([Bb("lockedTargetId")],Bn.prototype,"lockedTarget",void 0);var ia={};class GF{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();this.attached[t]?H.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!it.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const n=this.attached[i],s=lt.Serialize(n);t[n.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const n=ia[i];if(n){const a=lt.Parse(()=>new n,t[i],null);this.add(a)}}}else for(const i in this.attached){const n=ia[this.attached[i].getClassName()];if(n){const s=lt.Parse(()=>new n,e,null);this.remove(this.attached[i]),this.add(s)}}}}class _s{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey)if(t.type===Uf.KEYDOWN)(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const n=this._keys.indexOf(i.keyCode);n>=0&&this._keys.splice(n,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],n=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-n,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,n):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(n,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-n):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,n,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-n,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),E.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}b([O()],_s.prototype,"keysUp",void 0),b([O()],_s.prototype,"keysUpward",void 0),b([O()],_s.prototype,"keysDown",void 0),b([O()],_s.prototype,"keysDownward",void 0),b([O()],_s.prototype,"keysLeft",void 0),b([O()],_s.prototype,"keysRight",void 0),b([O()],_s.prototype,"rotationSpeed",void 0),b([O()],_s.prototype,"keysRotateLeft",void 0),b([O()],_s.prototype,"keysRotateRight",void 0),b([O()],_s.prototype,"keysRotateUp",void 0),b([O()],_s.prototype,"keysRotateDown",void 0),ia.FreeCameraKeyboardMoveInput=_s;class Mp{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new J,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=n=>{const s=n.event,a="touch"===s.pointerType;if(t.isInVRExclusivePointerMode||!this.touchEnabled&&a||n.type!==Ct.POINTERMOVE&&-1===this.buttons.indexOf(s.button))return;const o=s.target;if(n.type===Ct.POINTERDOWN){if(a&&-1!==this._activePointerId||!a&&-1!==this._currentActiveButton)return;this._activePointerId=s.pointerId;try{null==o||o.setPointerCapture(s.pointerId)}catch(l){}-1===this._currentActiveButton&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(n.event)}else if(n.type===Ct.POINTERUP){if(a&&this._activePointerId!==s.pointerId||!a&&this._currentActiveButton!==s.button)return;try{null==o||o.releasePointerCapture(s.pointerId)}catch(l){}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(n.type===Ct.POINTERMOVE&&(this._activePointerId===s.pointerId||!a))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(n.event);else if(this._previousPosition){let l=s.clientX-this._previousPosition.x;const c=s.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(l*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=l/this.angularSensibility,this.camera.cameraRotation.x+=c/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:c}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}),this._onMouseMove=n=>{if(!t.isPointerLock||t.isInVRExclusivePointerMode)return;let s=n.movementX;this.camera.getScene().useRightHandedSystem&&(s*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(s*=-1),this.camera.cameraRotation.y+=s/this.angularSensibility,this.camera.cameraRotation.x+=n.movementY/this.angularSensibility,this._previousPosition=null,e||n.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ct.POINTERDOWN|Ct.POINTERUP|Ct.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}b([O()],Mp.prototype,"buttons",void 0),b([O()],Mp.prototype,"angularSensibility",void 0),ia.FreeCameraMouseInput=Mp;class Dp{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new J,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ct.POINTERWHEEL)return;const i=t.event,n=i.deltaMode===oT.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*n*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*n*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*n*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ct.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}b([O()],Dp.prototype,"wheelPrecisionX",void 0),b([O()],Dp.prototype,"wheelPrecisionY",void 0),b([O()],Dp.prototype,"wheelPrecisionZ",void 0);var Ti=(()=>{return(r=Ti||(Ti={}))[r.MoveRelative=0]="MoveRelative",r[r.RotateRelative=1]="RotateRelative",r[r.MoveScene=2]="MoveScene",Ti;var r})();class na extends Dp{constructor(){super(...arguments),this._moveRelative=E.Zero(),this._rotateRelative=E.Zero(),this._moveScene=E.Zero(),this._wheelXAction=Ti.MoveRelative,this._wheelXActionCoordinate=Oo.X,this._wheelYAction=Ti.MoveRelative,this._wheelYActionCoordinate=Oo.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==Ti.MoveRelative||(this._wheelXAction=Ti.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Ti.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==Ti.MoveRelative||(this._wheelYAction=Ti.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Ti.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==Ti.MoveRelative||(this._wheelZAction=Ti.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Ti.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==Ti.RotateRelative||(this._wheelXAction=Ti.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Ti.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==Ti.RotateRelative||(this._wheelYAction=Ti.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Ti.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==Ti.RotateRelative||(this._wheelZAction=Ti.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Ti.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==Ti.MoveScene||(this._wheelXAction=Ti.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Ti.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==Ti.MoveScene||(this._wheelYAction=Ti.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Ti.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==Ti.MoveScene||(this._wheelZAction=Ti.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Ti.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=B.Zero();this.camera.getViewMatrix().invertToRef(e);const t=E.Zero();E.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e||null===t||null===i)return;let n=null;switch(t){case Ti.MoveRelative:n=this._moveRelative;break;case Ti.RotateRelative:n=this._rotateRelative;break;case Ti.MoveScene:n=this._moveScene}switch(i){case Oo.X:n.set(e,0,0);break;case Oo.Y:n.set(0,e,0);break;case Oo.Z:n.set(0,0,e)}}}b([O()],na.prototype,"wheelXMoveRelative",null),b([O()],na.prototype,"wheelYMoveRelative",null),b([O()],na.prototype,"wheelZMoveRelative",null),b([O()],na.prototype,"wheelXRotateRelative",null),b([O()],na.prototype,"wheelYRotateRelative",null),b([O()],na.prototype,"wheelZRotateRelative",null),b([O()],na.prototype,"wheelXMoveScene",null),b([O()],na.prototype,"wheelYMoveScene",null),b([O()],na.prototype,"wheelZMoveScene",null),ia.FreeCameraMouseWheelInput=na;class Pp{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Ie.IsSafari()}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const n=i.event;if(this.allowMouse||!("mouse"===n.pointerType||this._isSafari&&void 0===n.pointerType))if(i.type===Ct.POINTERDOWN){if(e||n.preventDefault(),this._pointerPressed.push(n.pointerId),1!==this._pointerPressed.length)return;t={x:n.clientX,y:n.clientY}}else if(i.type===Ct.POINTERUP){e||n.preventDefault();const a=this._pointerPressed.indexOf(n.pointerId);if(-1===a||(this._pointerPressed.splice(a,1),0!=a))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Ct.POINTERMOVE){if(e||n.preventDefault(),!t||0!=this._pointerPressed.indexOf(n.pointerId))return;this._offsetX=n.clientX-t.x,this._offsetY=-(n.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ct.POINTERDOWN|Ct.POINTERUP|Ct.POINTERMOVE),this._onLostFocus){const n=this.camera.getEngine().getInputElement();n&&n.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY||0===this._offsetX&&0===this._offsetY)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const i=e._computeLocalCameraSpeed(),n=new E(0,0,0!==this.touchMoveSensibility?i*this._offsetY/this.touchMoveSensibility:0);B.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(E.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}b([O()],Pp.prototype,"touchAngularSensibility",void 0),b([O()],Pp.prototype,"touchMoveSensibility",void 0),ia.FreeCameraTouchInput=Pp;class HF extends GF{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new _s),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Mp(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new na,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Pp),this}clear(){super.clear(),this._mouseInput=null}}class Hh extends Bn{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,n=!0){super(e,t,i,n),this.ellipsoid=new E(.5,1,.5),this.ellipsoidOffset=new E(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=E.Zero(),this._diffPosition=E.Zero(),this._newPosition=E.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,a,o=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>Ve.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&o&&this.onCollide(o))})(a)},this.inputs=new HF(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=Ie.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new E(0,0,0),this.cameraRotation=new We(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?E.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let n=e;this.applyGravity&&(n=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,n,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=E.Zero(),this._transformedDirection=E.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}b([Mr()],Hh.prototype,"ellipsoid",void 0),b([Mr()],Hh.prototype,"ellipsoidOffset",void 0),b([O()],Hh.prototype,"checkCollisions",void 0),b([O()],Hh.prototype,"applyGravity",void 0),$i.AddNodeConstructor("TouchCamera",(r,e)=>()=>new zF(r,E.Zero(),e));class zF extends Hh{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0}}class si{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new si(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const n=si._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),s=si._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let l,c,u,h,a=0,o=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,c=(n.x-this.origin.x)*l,u=(s.x-this.origin.x)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,c=(n.y-this.origin.y)*l,u=(s.y-this.origin.y)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,c=(n.z-this.origin.z)*l,u=(s.z-this.origin.z)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,n=e.center.y-this.origin.y,s=e.center.z-this.origin.z,a=i*i+n*n+s*s,o=e.radius+t,l=o*o;if(a<=l)return!0;const c=i*this.direction.x+n*this.direction.y+s*this.direction.z;return!(c<0)&&a-c*c<=l}intersectsTriangle(e,t,i){const n=si._TmpVector3[0],s=si._TmpVector3[1],a=si._TmpVector3[2],o=si._TmpVector3[3],l=si._TmpVector3[4];t.subtractToRef(e,n),i.subtractToRef(e,s),E.CrossToRef(this.direction,s,a);const c=E.Dot(n,a);if(0===c)return null;const u=1/c;this.origin.subtractToRef(e,o);const h=E.Dot(o,a)*u;if(h<0||h>1)return null;E.CrossToRef(o,n,l);const d=E.Dot(this.direction,l)*u;if(d<0||h+d>1)return null;const f=E.Dot(s,l)*u;return f>this.length?null:new ST(1-h-d,h,f)}intersectsPlane(e){let t;const i=E.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const n=E.Dot(e.normal,this.origin);return t=(-e.d-n)/i,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new E(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new E(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new E(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t){const i=z.Matrix[0];return e.getWorldMatrix().invertToRef(i),this._tmpRay?si.TransformToRef(this,i,this._tmpRay):this._tmpRay=si.Transform(this,i),e.intersects(this._tmpRay,t)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let n=0;n<e.length;n++){const s=this.intersectsMesh(e[n],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const n=this.origin,s=z.Vector3[0],a=z.Vector3[1],o=z.Vector3[2],l=z.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(si._Rayl,o),n.addToRef(o,a),e.subtractToRef(n,l);const c=E.Dot(s,s),u=E.Dot(s,o),h=E.Dot(o,o),d=E.Dot(s,l),f=E.Dot(o,l),p=c*h-u*u;let g,m,_=p,T=p;p<si._Smallnum?(g=0,_=1,m=f,T=h):(g=u*f-h*d,m=c*f-u*d,g<0?(g=0,m=f,T=h):g>_&&(g=_,m=f+u,T=h)),m<0?(m=0,-d<0?g=0:-d>c?g=_:(g=-d,_=c)):m>T&&(m=T,-d+u<0?g=0:-d+u>c?g=_:(g=-d+u,_=c));const v=Math.abs(g)<si._Smallnum?0:g/_,A=Math.abs(m)<si._Smallnum?0:m/T,S=z.Vector3[4];o.scaleToRef(A,S);const x=z.Vector3[5];s.scaleToRef(v,x),x.addInPlace(l);const C=z.Vector3[6];return x.subtractToRef(S,C),A>0&&A<=this.length&&C.lengthSquared()<i*i?x.length():-1}update(e,t,i,n,s,a,o,l=!1){if(l){si._RayDistant||(si._RayDistant=si.Zero()),si._RayDistant.unprojectRayToRef(e,t,i,n,B.IdentityReadOnly,a,o);const c=z.Matrix[0];s.invertToRef(c),si.TransformToRef(si._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,n,s,a,o);return this}static Zero(){return new si(E.Zero(),E.Zero())}static CreateNew(e,t,i,n,s,a,o){return si.Zero().update(e,t,i,n,s,a,o)}static CreateNewFromTo(e,t,i=B.IdentityReadOnly){const n=t.subtract(e),s=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return n.normalize(),si.Transform(new si(e,n,s),i)}static Transform(e,t){const i=new si(new E(0,0,0),new E(0,0,0));return si.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){E.TransformCoordinatesToRef(e.origin,t,i.origin),E.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const n=i.direction,s=n.length();if(0!==s&&1!==s){const a=1/s;n.x*=a,n.y*=a,n.z*=a,i.length*=s}}unprojectRayToRef(e,t,i,n,s,a,o){var l;const c=z.Matrix[0];s.multiplyToRef(a,c),c.multiplyToRef(o,c),c.invert();const u=z.Vector3[0];u.x=e/i*2-1,u.y=-(t/n*2-1),u.z=(null===(l=Je.LastCreatedEngine)||void 0===l?void 0:l.isNDCHalfZRange)?0:-1;const h=z.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),d=z.Vector3[2],f=z.Vector3[3];E._UnprojectFromInvertedMatrixToRef(u,c,d),E._UnprojectFromInvertedMatrixToRef(h,c,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}si._TmpVector3=mn.BuildArray(6,E.Zero),si._RayDistant=si.Zero(),si._Smallnum=1e-8,si._Rayl=1e9,dt.prototype.createPickingRay=function(r,e,t,i,n=!1){const s=si.Zero();return this.createPickingRayToRef(r,e,t,s,i,n),s},dt.prototype.createPickingRayToRef=function(r,e,t,i,n,s=!1,a=!1){const o=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}const c=n.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return r=r/o.getHardwareScalingLevel()-c.x,e=e/o.getHardwareScalingLevel()-(o.getRenderHeight()-c.y-c.height),i.update(r,e,c.width,c.height,t||B.IdentityReadOnly,s?B.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),a),this},dt.prototype.createPickingRayInCameraSpace=function(r,e,t){const i=si.Zero();return this.createPickingRayInCameraSpaceToRef(r,e,i,t),i},dt.prototype.createPickingRayInCameraSpaceToRef=function(r,e,t,i){if(!Za)return this;const n=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}const a=i.viewport.toGlobal(n.getRenderWidth(),n.getRenderHeight()),o=B.Identity();return r=r/n.getHardwareScalingLevel()-a.x,e=e/n.getHardwareScalingLevel()-(n.getRenderHeight()-a.y-a.height),t.update(r,e,a.width,a.height,o,o,i.getProjectionMatrix()),this},dt.prototype._internalPickForMesh=function(r,e,t,i,n,s,a,o){const l=e(i,t.enableDistantPicking),c=t.intersects(l,n,a,s,i,o);return!c||!c.hit||!n&&null!=r&&c.distance>=r.distance?null:c},dt.prototype._internalPick=function(r,e,t,i,n){let s=null;const a=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),o=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const c=this.meshes[l];if(e){if(!e(c))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const u=a&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,o);if(c.hasThinInstances&&c.thinInstanceEnablePicking){const d=this._internalPickForMesh(s,r,c,h,!0,!0,n);if(d){if(i)return d;const f=z.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let g=0;g<p.length;g++){p[g].multiplyToRef(h,f);const m=this._internalPickForMesh(s,r,c,f,t,i,n,!0);if(m&&(s=m,s.thinInstanceIndex=g,t))return s}}}else{const d=this._internalPickForMesh(s,r,c,h,t,i,n);if(d&&(s=d,t))return s}}return s||new Za},dt.prototype._internalMultiPick=function(r,e,t){if(!Za)return null;const i=new Array,n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),s=this.cameraToUseForPointers||this.activeCamera;for(let a=0;a<this.meshes.length;a++){const o=this.meshes[a];if(e){if(!e(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;const l=n&&o.isWorldMatrixCameraDependent(),c=o.computeWorldMatrix(l,s);if(o.hasThinInstances&&o.thinInstanceEnablePicking){if(this._internalPickForMesh(null,r,o,c,!0,!0,t)){const h=z.Matrix[1],d=o.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(c,h);const g=this._internalPickForMesh(null,r,o,h,!1,!1,t,!0);g&&(g.thinInstanceIndex=f,i.push(g))}}}else{const u=this._internalPickForMesh(null,r,o,c,!1,!1,t);u&&i.push(u)}}return i},dt.prototype.pickWithBoundingInfo=function(r,e,t,i,n){if(!Za)return null;const s=this._internalPick(a=>(this._tempPickingRay||(this._tempPickingRay=si.Zero()),this.createPickingRayToRef(r,e,a,this._tempPickingRay,n||null),this._tempPickingRay),t,i,!0);return s&&(s.ray=this.createPickingRay(r,e,B.Identity(),n||null)),s},Object.defineProperty(dt.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1}),dt.prototype.pick=function(r,e,t,i,n,s,a=!1){const o=this._internalPick((l,c)=>(this._tempPickingRay||(this._tempPickingRay=si.Zero()),this.createPickingRayToRef(r,e,l,this._tempPickingRay,n||null,!1,c),this._tempPickingRay),t,i,!1,s);return o&&(o.ray=this.createPickingRay(r,e,B.Identity(),n||null)),o},dt.prototype.pickWithRay=function(r,e,t,i){const n=this._internalPick(s=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=B.Identity()),s.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=si.Zero()),si.TransformToRef(r,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return n&&(n.ray=r),n},dt.prototype.multiPick=function(r,e,t,i,n){return this._internalMultiPick(s=>this.createPickingRay(r,e,s,i||null),t,n)},dt.prototype.multiPickWithRay=function(r,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=B.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=si.Zero()),si.TransformToRef(r,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)},it.prototype.getForwardRay=function(r=100,e,t){return this.getForwardRayToRef(new si(E.Zero(),E.Zero(),r),r,e,t)},it.prototype.getForwardRayToRef=function(r,e=100,t,i){return t||(t=this.getWorldMatrix()),r.length=e,r.origin.copyFrom(i||this.position),z.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),E.TransformNormalToRef(z.Vector3[2],t,z.Vector3[3]),E.NormalizeToRef(z.Vector3[3],r.direction),r};let ms=(()=>{class r{get isConnected(){return this._isConnected}constructor(t,i,n,s=0,a=1,o=2,l=3){this.id=t,this.index=i,this.browserGamepad=n,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=r.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=a,this._rightStickAxisX=o,this._rightStickAxisY=l,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(t){this._onleftstickchanged=t}onrightstickchanged(t){this._onrightstickchanged=t}get leftStick(){return this._leftStick}set leftStick(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t}get rightStick(){return this._rightStick}set rightStick(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}return r.GAMEPAD=0,r.GENERIC=1,r.XBOX=2,r.POSE_ENABLED=3,r.DUALSHOCK=4,r})();class v8 extends ms{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new J,this.onButtonUpObservable=new J,this.type=ms.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}let S8=(()=>{class r{static InitiateController(t){for(const i of this._ControllerFactories)if(i.canCreate(t))return i.create(t);if(this._DefaultControllerFactory)return this._DefaultControllerFactory(t);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."}}return r._ControllerFactories=[],r._DefaultControllerFactory=null,r})();var Ts=(()=>{return(r=Ts||(Ts={}))[r.A=0]="A",r[r.B=1]="B",r[r.X=2]="X",r[r.Y=3]="Y",r[r.LB=4]="LB",r[r.RB=5]="RB",r[r.Back=8]="Back",r[r.Start=9]="Start",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick",Ts;var r})(),Ol=(()=>{return(r=Ol||(Ol={}))[r.Up=12]="Up",r[r.Down=13]="Down",r[r.Left=14]="Left",r[r.Right=15]="Right",Ol;var r})();class x8 extends ms{constructor(e,t,i,n=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new J,this.onButtonUpObservable=new J,this.onPadDownObservable=new J,this.onPadUpObservable=new J,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=ms.XBOX,this._isXboxOnePad=n}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,Ts.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,Ts.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,Ts.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,Ts.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,Ts.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,Ts.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,Ts.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,Ts.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Ts.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Ts.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Ol.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Ol.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Ol.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Ol.Right)}update(){super.update(),this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var Es=(()=>{return(r=Es||(Es={}))[r.Cross=0]="Cross",r[r.Circle=1]="Circle",r[r.Square=2]="Square",r[r.Triangle=3]="Triangle",r[r.L1=4]="L1",r[r.R1=5]="R1",r[r.Share=8]="Share",r[r.Options=9]="Options",r[r.LeftStick=10]="LeftStick",r[r.RightStick=11]="RightStick",Es;var r})(),Fl=(()=>{return(r=Fl||(Fl={}))[r.Up=12]="Up",r[r.Down=13]="Down",r[r.Left=14]="Left",r[r.Right=15]="Right",Fl;var r})();class A8 extends ms{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new J,this.onButtonUpObservable=new J,this.onPadDownObservable=new J,this.onPadUpObservable=new J,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=ms.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,Es.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,Es.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,Es.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,Es.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,Es.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,Es.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,Es.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,Es.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Es.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Es.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,Fl.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,Fl.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,Fl.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,Fl.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class y8{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new J,rn()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new J(t=>{for(const i in this._babylonGamepads){const n=this._babylonGamepads[i];n&&n._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,n)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let n;this._babylonGamepads[i.index]?(n=this._babylonGamepads[i.index],n.browserGamepad=i,n._isConnected=!0):n=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(n),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const n in this._babylonGamepads)if(this._babylonGamepads[n].index===i.index){const s=this._babylonGamepads[n];s._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=ms.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),n=-1!==e.id.search("Xbox One");return t=n||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new x8(e.id,e.index,e,n):i?new A8(e.id,e.index,e):e.pose?S8.InitiateController(e):new v8(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch(i){-1===this._loggedErrors.indexOf(t.index)&&(Ie.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&!this._scene&&Ve.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const n=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(n)}}}}class wp{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=B.Identity(),this._deltaTransform=E.Zero(),this._vector3=E.Zero(),this._vector2=We.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==ms.POSE_ENABLED&&(!this.gamepad||t.type===ms.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(ms.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):B.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const n=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*n,0,-t.y*n),E.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}b([O()],wp.prototype,"gamepadAngularSensibility",void 0),b([O()],wp.prototype,"gamepadMoveSensibility",void 0),ia.FreeCameraGamepadInput=wp;class WF{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let n=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{var l,c;const u=o.event,h="touch"===u.pointerType;if(t.isInVRExclusivePointerMode||o.type!==Ct.POINTERMOVE&&-1===this.buttons.indexOf(u.button))return;const d=u.target;if(this._altKey=u.altKey,this._ctrlKey=u.ctrlKey,this._metaKey=u.metaKey,this._shiftKey=u.shiftKey,this._buttonsPressed=u.buttons,t.isPointerLock)this.onTouch(null,u.movementX,u.movementY),this._pointA=null,this._pointB=null;else{if(o.type!==Ct.POINTERDOWN&&h&&(null===(l=this._pointA)||void 0===l?void 0:l.pointerId)!==u.pointerId&&(null===(c=this._pointB)||void 0===c?void 0:c.pointerId)!==u.pointerId)return;if(o.type!==Ct.POINTERDOWN||-1!==this._currentActiveButton&&!h)if(o.type===Ct.POINTERDOUBLETAP)this.onDoubleTap(u.pointerType);else if(o.type!==Ct.POINTERUP||this._currentActiveButton!==u.button&&!h){if(o.type===Ct.POINTERMOVE)if(e||u.preventDefault(),this._pointA&&null===this._pointB)this.onTouch(this._pointA,u.clientX-this._pointA.x,u.clientY-this._pointA.y),this._pointA.x=u.clientX,this._pointA.y=u.clientY;else if(this._pointA&&this._pointB){const f=this._pointA.pointerId===u.pointerId?this._pointA:this._pointB;f.x=u.clientX,f.y=u.clientY;const p=this._pointA.x-this._pointB.x,g=this._pointA.y-this._pointB.y,_=p*p+g*g,m={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:u.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,n,_,s,m),s=m,n=_}}else{try{null==d||d.releasePointerCapture(u.pointerId)}catch(f){}h||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==u.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==u.pointerId?this._pointB=null:this._pointA=this._pointB=null,(0!==n||s)&&(this.onMultiTouch(this._pointA,this._pointB,n,0,s,null),n=0,s=null),this._currentActiveButton=-1,this.onButtonUp(u),e||u.preventDefault()}else{try{null==d||d.setPointerCapture(u.pointerId)}catch(f){}if(null===this._pointA)this._pointA={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType};else{if(null!==this._pointB)return;this._pointB={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType}}-1===this._currentActiveButton&&!h&&(this._currentActiveButton=u.button),this.onButtonDown(u),e||(u.preventDefault(),i&&i.focus())}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ct.POINTERDOWN|Ct.POINTERUP|Ct.POINTERMOVE|Ct.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,n=0,s=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const a=this.camera.getScene().getEngine().getHostWindow();a&&Ie.RegisterTopRootEvents(a,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Ie.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,n,s,a){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}b([O()],WF.prototype,"buttons",void 0);class Or extends WF{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const n=t.y-e.y;this.camera.inertialPanningX+=-(t.x-e.x)/this.panningSensibility,this.camera.inertialPanningY+=n/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Or.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.camera.inertialRadiusOffset+=this.pinchDeltaPercentage?.001*(t-e)*i*this.pinchDeltaPercentage:(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,n,s,a){0===i&&null===s||0===n&&null===a||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,n),this._computeMultiTouchPanning(s,a)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(n)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,n),this._isPinching=!0):this._computeMultiTouchPanning(s,a)):this.multiTouchPanning?this._computeMultiTouchPanning(s,a):this.pinchZoom&&this._computePinchZoom(i,n))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Or.MinimumRadiusForPinch=.001,b([O()],Or.prototype,"buttons",void 0),b([O()],Or.prototype,"angularSensibilityX",void 0),b([O()],Or.prototype,"angularSensibilityY",void 0),b([O()],Or.prototype,"pinchPrecision",void 0),b([O()],Or.prototype,"pinchDeltaPercentage",void 0),b([O()],Or.prototype,"useNaturalPinchZoom",void 0),b([O()],Or.prototype,"pinchZoom",void 0),b([O()],Or.prototype,"panningSensibility",void 0),b([O()],Or.prototype,"multiTouchPanning",void 0),b([O()],Or.prototype,"multiTouchPanAndZoom",void 0),ia.ArcRotateCameraPointersInput=Or;class ra{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey)if(t.type===Uf.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const n=this._keys.indexOf(i.keyCode);n>=0&&this._keys.splice(n,1),i.preventDefault&&(e||i.preventDefault())}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}b([O()],ra.prototype,"keysUp",void 0),b([O()],ra.prototype,"keysDown",void 0),b([O()],ra.prototype,"keysLeft",void 0),b([O()],ra.prototype,"keysRight",void 0),b([O()],ra.prototype,"keysReset",void 0),b([O()],ra.prototype,"panningSensibility",void 0),b([O()],ra.prototype,"zoomingSensibility",void 0),b([O()],ra.prototype,"useAltToZoom",void 0),b([O()],ra.prototype,"angularSpeed",void 0),ia.ArcRotateCameraKeyboardMoveInput=ra;class zh{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=E.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const n=.01*e*this.wheelDeltaPercentage*t;return i=e>0?n/(1+this.wheelDeltaPercentage):n*(1+this.wheelDeltaPercentage),i}attachControl(e){e=Ie.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ct.POINTERWHEEL)return;const i=t.event;let n=0;const a=-i.deltaY*(i.deltaMode===oT.DOM_DELTA_LINE?40:1);if(this.customComputeDeltaFromMouseWheel)n=this.customComputeDeltaFromMouseWheel(a,this,i);else if(this.wheelDeltaPercentage){if(n=this._computeDeltaFromMouseWheelLegacyEvent(a,this.camera.radius),n>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+n;for(let c=0;c<20&&Math.abs(l)>.001;c++)o-=l,l*=this.camera.inertia;o=Se.Clamp(o,0,Number.MAX_VALUE),n=this._computeDeltaFromMouseWheelLegacyEvent(a,o)}}else n=a/(40*this.wheelPrecision);n&&(this.zoomToMouseLocation&&this._hitPlane?this._zoomToMouse(n):this.camera.inertialRadiusOffset+=n),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ct.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=ss.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),n=i.createPickingRay(i.pointerX,i.pointerY,B.Identity(),t,!1);let s=0;return this._hitPlane&&(s=null!==(e=n.intersectsPlane(this._hitPlane))&&void 0!==e?e:0),n.origin.addInPlace(n.direction.scaleInPlace(s))}_zoomToMouse(e){var t,i;const n=this.camera,s=1-n.inertia;if(n.lowerRadiusLimit){const u=null!==(t=n.lowerRadiusLimit)&&void 0!==t?t:0;n.radius-(n.inertialRadiusOffset+e)/s<u&&(e=(n.radius-u)*s-n.inertialRadiusOffset)}if(n.upperRadiusLimit){const u=null!==(i=n.upperRadiusLimit)&&void 0!==i?i:0;n.radius-(n.inertialRadiusOffset+e)/s>u&&(e=(n.radius-u)*s-n.inertialRadiusOffset)}const o=e/s/n.radius,l=this._getPosition(),c=z.Vector3[6];l.subtractToRef(n.target,c),c.scaleInPlace(o),c.scaleInPlace(s),this._inertialPanning.addInPlace(c),n.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<kt&&(e.x=0),Math.abs(e.y)<kt&&(e.y=0),Math.abs(e.z)<kt&&(e.z=0)}}b([O()],zh.prototype,"wheelPrecision",void 0),b([O()],zh.prototype,"zoomToMouseLocation",void 0),b([O()],zh.prototype,"wheelDeltaPercentage",void 0),ia.ArcRotateCameraMouseWheelInput=zh;class Op{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==ms.POSE_ENABLED&&(!this.gamepad||t.type===ms.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(ms.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const n=t.x/this.gamepadRotationSensibility;0!=n&&Math.abs(n)>.005&&(e.inertialAlphaOffset+=n)}if(0!=t.y){const n=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=n&&Math.abs(n)>.005&&(e.inertialBetaOffset+=n)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const n=i.y/this.gamepadMoveSensibility;0!=n&&Math.abs(n)>.005&&(this.camera.inertialRadiusOffset-=n)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}b([O()],Op.prototype,"gamepadRotationSensibility",void 0),b([O()],Op.prototype,"gamepadMoveSensibility",void 0),ia.ArcRotateCameraGamepadInput=Op,Object.defineProperty(dt.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new y8(this);let r=this._getComponent(Bi.NAME_GAMEPAD);r||(r=new I8(this),this._addComponent(r))}return this._gamepadManager},enumerable:!0,configurable:!0}),HF.prototype.addGamepad=function(){return this.add(new wp),this},class C8 extends GF{constructor(e){super(e)}addMouseWheel(){return this.add(new zh),this}addPointers(){return this.add(new Or),this}addKeyboard(){return this.add(new ra),this}}.prototype.addGamepad=function(){return this.add(new Op),this};class I8{constructor(e){this.name=Bi.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Bi.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}$i.AddNodeConstructor("FreeCamera",(r,e)=>()=>new XF(r,E.Zero(),e));class XF extends zF{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}it._CreateDefaultParsedCamera=(r,e)=>new XF(r,E.Zero(),e);const au={UKNOWN:"Unknown"},HE={CHROME:"Chrome",FIREFOX:"Firefox",SAFARI:"Safari",OPERA:"Opera",IE:"IE",MS_EDGE:"MS-Edge",MS_EDGE_CHROMIUM:"MS-Edge-Chromium",FB_MESSANGER:"FB-Messanger",SAMSUNG:"Samsung",UCBROWSER:"UC-Browser",UNKNOWN:au.UKNOWN},Fp={HTC:/HTC|HTC.*(Sensation|Evo|Vision|Explorer|6800|8100|8900|A7272|S510e|C110e|Legend|Desire|T8282)|APX515CKT|Qtek9090|APA9292KT|HD_mini|Sensation.*Z710e|PG86100|Z715e|Desire.*(A8181|HD)|ADR6200|ADR6400L|ADR6425|001HT|Inspire 4G|Android.*\bEVO\b|T-Mobile G1|Z520m|Android [0-9.]+; Pixel/,NEXUS_PHONE:/Nexus One|Nexus S|Galaxy.*Nexus|Android.*Nexus.*Mobile|Nexus 4|Nexus 5|Nexus 6/,DELL:/Dell[;]? (Streak|Aero|Venue|Venue Pro|Flash|Smoke|Mini 3iX)|XCD28|XCD35|\b001DL\b|\b101DL\b|\bGS01\b/,MOTOROLA:new RegExp("Motorola|DROIDX|DROID BIONIC|\\bDroid\\b.*Build|Android.*Xoom|HRI39|MOT-|A1260|A1680|A555|A853|\n      A855|A953|A955|A956|Motorola.*ELECTRIFY|Motorola.*i1|i867|i940|MB200|MB300|MB501|MB502|MB508|MB511|\n      MB520|MB525|MB526|MB611|MB612|MB632|MB810|MB855|MB860|MB861|MB865|MB870|ME501|ME502|ME511|ME525|ME600|\n      ME632|ME722|ME811|ME860|ME863|ME865|MT620|MT710|MT716|MT720|MT810|MT870|MT917|Motorola.*TITANIUM|WX435|\n      WX445|XT300|XT301|XT311|XT316|XT317|XT319|XT320|XT390|XT502|XT530|XT531|XT532|XT535|XT603|XT610|XT611|\n      XT615|XT681|XT701|XT702|XT711|XT720|XT800|XT806|XT860|XT862|XT875|XT882|XT883|XT894|XT901|XT907|XT909|\n      XT910|XT912|XT928|XT926|XT915|XT919|XT925|XT1021|\\bMoto E\\b|XT1068|XT1092|XT1052"),SAMSUNG:new RegExp("\\bSamsung\\b|SM-G950F|SM-G955F|SM-G9250|GT-19300|SGH-I337|BGT-S5230|GT-B2100|GT-B2700|GT-B2710|\n      GT-B3210|GT-B3310|GT-B3410|GT-B3730|GT-B3740|GT-B5510|GT-B5512|GT-B5722|GT-B6520|GT-B7300|GT-B7320|\n      GT-B7330|GT-B7350|GT-B7510|GT-B7722|GT-B7800|GT-C3010|GT-C3011|GT-C3060|GT-C3200|GT-C3212|GT-C3212I|\n      GT-C3262|GT-C3222|GT-C3300|GT-C3300K|GT-C3303|GT-C3303K|GT-C3310|GT-C3322|GT-C3330|GT-C3350|GT-C3500|\n      GT-C3510|GT-C3530|GT-C3630|GT-C3780|GT-C5010|GT-C5212|GT-C6620|GT-C6625|GT-C6712|GT-E1050|GT-E1070|\n      GT-E1075|GT-E1080|GT-E1081|GT-E1085|GT-E1087|GT-E1100|GT-E1107|GT-E1110|GT-E1120|GT-E1125|GT-E1130|\n      GT-E1160|GT-E1170|GT-E1175|GT-E1180|GT-E1182|GT-E1200|GT-E1210|GT-E1225|GT-E1230|GT-E1390|GT-E2100|\n      GT-E2120|GT-E2121|GT-E2152|GT-E2220|GT-E2222|GT-E2230|GT-E2232|GT-E2250|GT-E2370|GT-E2550|GT-E2652|\n      GT-E3210|GT-E3213|GT-I5500|GT-I5503|GT-I5700|GT-I5800|GT-I5801|GT-I6410|GT-I6420|GT-I7110|GT-I7410|\n      GT-I7500|GT-I8000|GT-I8150|GT-I8160|GT-I8190|GT-I8320|GT-I8330|GT-I8350|GT-I8530|GT-I8700|GT-I8703|\n      GT-I8910|GT-I9000|GT-I9001|GT-I9003|GT-I9010|GT-I9020|GT-I9023|GT-I9070|GT-I9082|GT-I9100|GT-I9103|\n      GT-I9220|GT-I9250|GT-I9300|GT-I9305|GT-I9500|GT-I9505|GT-M3510|GT-M5650|GT-M7500|GT-M7600|GT-M7603|\n      GT-M8800|GT-M8910|GT-N7000|GT-S3110|GT-S3310|GT-S3350|GT-S3353|GT-S3370|GT-S3650|GT-S3653|GT-S3770|\n      GT-S3850|GT-S5210|GT-S5220|GT-S5229|GT-S5230|GT-S5233|GT-S5250|GT-S5253|GT-S5260|GT-S5263|GT-S5270|\n      GT-S5300|GT-S5330|GT-S5350|GT-S5360|GT-S5363|GT-S5369|GT-S5380|GT-S5380D|GT-S5560|GT-S5570|GT-S5600|\n      GT-S5603|GT-S5610|GT-S5620|GT-S5660|GT-S5670|GT-S5690|GT-S5750|GT-S5780|GT-S5830|GT-S5839|GT-S6102|\n      GT-S6500|GT-S7070|GT-S7200|GT-S7220|GT-S7230|GT-S7233|GT-S7250|GT-S7500|GT-S7530|GT-S7550|GT-S7562|\n      GT-S7710|GT-S8000|GT-S8003|GT-S8500|GT-S8530|GT-S8600|SCH-A310|SCH-A530|SCH-A570|SCH-A610|SCH-A630|\n      SCH-A650|SCH-A790|SCH-A795|SCH-A850|SCH-A870|SCH-A890|SCH-A930|SCH-A950|SCH-A970|SCH-A990|SCH-I100|\n      SCH-I110|SCH-I400|SCH-I405|SCH-I500|SCH-I510|SCH-I515|SCH-I600|SCH-I730|SCH-I760|SCH-I770|SCH-I830|\n      SCH-I910|SCH-I920|SCH-I959|SCH-LC11|SCH-N150|SCH-N300|SCH-R100|SCH-R300|SCH-R351|SCH-R400|SCH-R410|\n      SCH-T300|SCH-U310|SCH-U320|SCH-U350|SCH-U360|SCH-U365|SCH-U370|SCH-U380|SCH-U410|SCH-U430|SCH-U450|\n      SCH-U460|SCH-U470|SCH-U490|SCH-U540|SCH-U550|SCH-U620|SCH-U640|SCH-U650|SCH-U660|SCH-U700|SCH-U740|\n      SCH-U750|SCH-U810|SCH-U820|SCH-U900|SCH-U940|SCH-U960|SCS-26UC|SGH-A107|SGH-A117|SGH-A127|SGH-A137|\n      SGH-A157|SGH-A167|SGH-A177|SGH-A187|SGH-A197|SGH-A227|SGH-A237|SGH-A257|SGH-A437|SGH-A517|SGH-A597|\n      SGH-A637|SGH-A657|SGH-A667|SGH-A687|SGH-A697|SGH-A707|SGH-A717|SGH-A727|SGH-A737|SGH-A747|SGH-A767|\n      SGH-A777|SGH-A797|SGH-A817|SGH-A827|SGH-A837|SGH-A847|SGH-A867|SGH-A877|SGH-A887|SGH-A897|SGH-A927|\n      SGH-B100|SGH-B130|SGH-B200|SGH-B220|SGH-C100|SGH-C110|SGH-C120|SGH-C130|SGH-C140|SGH-C160|SGH-C170|\n      SGH-C180|SGH-C200|SGH-C207|SGH-C210|SGH-C225|SGH-C230|SGH-C417|SGH-C450|SGH-D307|SGH-D347|SGH-D357|\n      SGH-D407|SGH-D415|SGH-D780|SGH-D807|SGH-D980|SGH-E105|SGH-E200|SGH-E315|SGH-E316|SGH-E317|SGH-E335|\n      SGH-E590|SGH-E635|SGH-E715|SGH-E890|SGH-F300|SGH-F480|SGH-I200|SGH-I300|SGH-I320|SGH-I550|SGH-I577|\n      SGH-I600|SGH-I607|SGH-I617|SGH-I627|SGH-I637|SGH-I677|SGH-I700|SGH-I717|SGH-I727|SGH-i747M|SGH-I777|\n      SGH-I780|SGH-I827|SGH-I847|SGH-I857|SGH-I896|SGH-I897|SGH-I900|SGH-I907|SGH-I917|SGH-I927|SGH-I937|\n      SGH-I997|SGH-J150|SGH-J200|SGH-L170|SGH-L700|SGH-M110|SGH-M150|SGH-M200|SGH-N105|SGH-N500|SGH-N600|\n      SGH-N620|SGH-N625|SGH-N700|SGH-N710|SGH-P107|SGH-P207|SGH-P300|SGH-P310|SGH-P520|SGH-P735|SGH-P777|\n      SGH-Q105|SGH-R210|SGH-R220|SGH-R225|SGH-S105|SGH-S307|SGH-T109|SGH-T119|SGH-T139|SGH-T209|SGH-T219|\n      SGH-T229|SGH-T239|SGH-T249|SGH-T259|SGH-T309|SGH-T319|SGH-T329|SGH-T339|SGH-T349|SGH-T359|SGH-T369|\n      SGH-T379|SGH-T409|SGH-T429|SGH-T439|SGH-T459|SGH-T469|SGH-T479|SGH-T499|SGH-T509|SGH-T519|SGH-T539|\n      SGH-T559|SGH-T589|SGH-T609|SGH-T619|SGH-T629|SGH-T639|SGH-T659|SGH-T669|SGH-T679|SGH-T709|SGH-T719|\n      SGH-T729|SGH-T739|SGH-T746|SGH-T749|SGH-T759|SGH-T769|SGH-T809|SGH-T819|SGH-T839|SGH-T919|SGH-T929|\n      SGH-T939|SGH-T959|SGH-T989|SGH-U100|SGH-U200|SGH-U800|SGH-V205|SGH-V206|SGH-X100|SGH-X105|SGH-X120|\n      SGH-X140|SGH-X426|SGH-X427|SGH-X475|SGH-X495|SGH-X497|SGH-X507|SGH-X600|SGH-X610|SGH-X620|SGH-X630|\n      SGH-X700|SGH-X820|SGH-X890|SGH-Z130|SGH-Z150|SGH-Z170|SGH-ZX10|SGH-ZX20|SHW-M110|SPH-A120|SPH-A400|\n      SPH-A420|SPH-A460|SPH-A500|SPH-A560|SPH-A600|SPH-A620|SPH-A660|SPH-A700|SPH-A740|SPH-A760|SPH-A790|\n      SPH-A800|SPH-A820|SPH-A840|SPH-A880|SPH-A900|SPH-A940|SPH-A960|SPH-D600|SPH-D700|SPH-D710|SPH-D720|\n      SPH-I300|SPH-I325|SPH-I330|SPH-I350|SPH-I500|SPH-I600|SPH-I700|SPH-L700|SPH-M100|SPH-M220|SPH-M240|\n      SPH-M300|SPH-M305|SPH-M320|SPH-M330|SPH-M350|SPH-M360|SPH-M370|SPH-M380|SPH-M510|SPH-M540|SPH-M550|\n      SPH-M560|SPH-M570|SPH-M580|SPH-M610|SPH-M620|SPH-M630|SPH-M800|SPH-M810|SPH-M850|SPH-M900|SPH-M910|\n      SPH-M920|SPH-M930|SPH-N100|SPH-N200|SPH-N240|SPH-N300|SPH-N400|SPH-Z400|SWC-E100|SCH-i909|GT-N7100|\n      GT-N7105|SCH-I535|SM-N900A|SM-N900T|SGH-I317|SGH-T999L|GT-S5360B|GT-I8262|GT-S6802|GT-S6312|GT-S6310|GT-S5312|\n      GT-S5310|GT-I9105|GT-I8510|GT-S6790N|SM-G7105|SM-N9005|GT-S5301|GT-I9295|GT-I9195|SM-C101|GT-S7392|GT-S7560|\n      GT-B7610|GT-I5510|GT-S7582|GT-S7530E|GT-I8750|SM-G9006V|SM-G9008V|SM-G9009D|SM-G900A|SM-G900D|SM-G900F|\n      SM-G900H|SM-G900I|SM-G900J|SM-G900K|SM-G900L|SM-G900M|SM-G900P|SM-G900R4|SM-G900S|SM-G900T|SM-G900V|\n      SM-G900W8|SHV-E160K|SCH-P709|SCH-P729|SM-T2558|GT-I9205|SM-G9350|SM-J120F|SM-G920F|SM-G920V|SM-G930F|\n      SM-N910C|SM-A310F|GT-I9190|SM-J500FN|SM-G903F|SM-J330F"),LG:new RegExp("\\bLG\\b;|LG[- ]?(C800|C900|E400|E610|E900|E-900|F160|F180K|F180L|F180S|730|855|L160|LS740|LS840|LS970|\n      LU6200|MS690|MS695|MS770|MS840|MS870|MS910|P500|P700|P705|VM696|AS680|AS695|AX840|C729|E970|GS505|272|\n      C395|E739BK|E960|L55C|L75C|LS696|LS860|P769BK|P350|P500|P509|P870|UN272|US730|VS840|VS950|LN272|LN510|\n      LS670|LS855|LW690|MN270|MN510|P509|P769|P930|UN200|UN270|UN510|UN610|US670|US740|US760|UX265|UX840|VN271|\n      VN530|VS660|VS700|VS740|VS750|VS910|VS920|VS930|VX9200|VX11000|AX840A|LW770|P506|P925|P999|E612|D955|D802|\n      MS323|M257)"),SONY:/SonyST|SonyLT|SonyEricsson|SonyEricssonLT15iv|LT18i|E10i|LT28h|LT26w|SonyEricssonMT27i|C5303|C6902|C6903|C6906|C6943|D2533/,ASUS:/Asus.*Galaxy|PadFone.*Mobile/,NOKIA_LUMIA:/Lumia [0-9]{3,4}/,MICROMAX:/Micromax.*\b(A210|A92|A88|A72|A111|A110Q|A115|A116|A110|A90S|A26|A51|A35|A54|A25|A27|A89|A68|A65|A57|A90)\b/,PALM:/PalmSource|Palm/,VERTU:/Vertu|Vertu.*Ltd|Vertu.*Ascent|Vertu.*Ayxta|Vertu.*Constellation(F|Quest)?|Vertu.*Monika|Vertu.*Signature/,PANTECH:new RegExp("PANTECH|IM-A850S|IM-A840S|IM-A830L|IM-A830K|IM-A830S|IM-A820L|IM-A810K|IM-A810S|IM-A800S|IM-T100K|\n        IM-A725L|IM-A780L|IM-A775C|IM-A770K|IM-A760S|IM-A750K|IM-A740S|IM-A730S|IM-A720L|IM-A710K|IM-A690L|\n        IM-A690S|IM-A650S|IM-A630K|IM-A600S|VEGA PTL21|PT003|P8010|ADR910L|P6030|P6020|P9070|P4100|P9060|P5000|\n        CDM8992|TXT8045|ADR8995|IS11PT|P2030|P6010|P8000|PT002|IS06|CDM8999|P9050|PT001|TXT8040|P2020|P9020|\n        P2000|P7040|P7000|C790"),FLY:/IQ230|IQ444|IQ450|IQ440|IQ442|IQ441|IQ245|IQ256|IQ236|IQ255|IQ235|IQ245|IQ275|IQ240|IQ285|IQ280|IQ270|IQ260|IQ250/,WIKO:new RegExp("KITE 4G|HIGHWAY|GETAWAY|STAIRWAY|DARKSIDE|DARKFULL|DARKNIGHT|DARKMOON|SLIDE|WAX 4G|RAINBOW|BLOOM|\n        SUNSET|GOA(?!nna)|LENNY|BARRY|IGGY|OZZY|CINK FIVE|CINK PEAX|CINK PEAX 2|CINK SLIM|CINK SLIM 2|CINK +|\n        CINK KING|CINK PEAX|CINK SLIM|SUBLIM"),I_MOBILE:/i-mobile (IQ|i-STYLE|idea|ZAA|Hitz)/,SIMVALLEY:/\b(SP-80|XT-930|SX-340|XT-930|SX-310|SP-360|SP60|SPT-800|SP-120|SPT-800|SP-140|SPX-5|SPX-8|SP-100|SPX-8|SPX-12)\b/,WOLFGANG:/AT-B24D|AT-AS50HD|AT-AS40W|AT-AS55HD|AT-AS45q2|AT-B26D|AT-AS50Q/,ALCATEL:/Alcatel|Mobile; rv:49.0|Mobile; ALCATEL 4052R; rv:48.0/,NINTENDO:/Nintendo (3DS|Switch)/,AMOI:/Amoi/,INQ:/INQ/,VITA:/\bVita\b/,BLACKBERRY:/\bBlackBerry\b|\bBB10\b|rim[0-9]+/,FIREFOX_OS:/\bFirefox-OS\b/,IPHONE:/\biPhone\b/,iPod:/\biPod\b/,ANDROID:/\bAndroid\b/,WINDOWS_PHONE:/\bWindows-Phone\b/,GENERIC_PHONE:new RegExp("Tapatalk|PDA;|SAGEM|\\bmmp\\b|pocket|\\bpsp\\b|symbian|Smartphone|smartfon|treo|up.browser|\n        up.link|vodafone|\\bwap\\b|nokia|Nokia|Series40|Series60|S60|SonyEricsson|N900|MAUI.*WAP.*Browser")},ou={iPad:/iPad|iPad.*Mobile/,NexusTablet:/Android.*Nexus[\s]+(7|9|10)/,GoogleTablet:/Android.*Pixel C/,SamsungTablet:new RegExp("SAMSUNG.*Tablet|Galaxy.*Tab|SC-01C|GT-P1000|GT-P1003|GT-P1010|GT-P3105|GT-P6210|\n        GT-P6800|GT-P6810|GT-P7100|GT-P7300|GT-P7310|GT-P7500|GT-P7510|SCH-I800|SCH-I815|SCH-I905|\n        SGH-I957|SGH-I987|SGH-T849|SGH-T859|SGH-T869|SPH-P100|GT-P3100|GT-P3108|GT-P3110|GT-P5100|\n        GT-P5110|GT-P6200|GT-P7320|GT-P7511|GT-N8000|GT-P8510|SGH-I497|SPH-P500|SGH-T779|SCH-I705|\n        SCH-I915|GT-N8013|GT-P3113|GT-P5113|GT-P8110|GT-N8010|GT-N8005|GT-N8020|GT-P1013|GT-P6201|\n        GT-P7501|GT-N5100|GT-N5105|GT-N5110|SHV-E140K|SHV-E140L|SHV-E140S|SHV-E150S|SHV-E230K|SHV-E230L|\n        SHV-E230S|SHW-M180K|SHW-M180L|SM-T865|SM-T290|SHW-M180S|SHW-M180W|SHW-M300W|SHW-M305W|SHW-M380K|SHW-M380S|SHW-M380W|\n        SHW-M430W|SHW-M480K|SHW-M480S|SHW-M480W|SHW-M485W|SHW-M486W|SHW-M500W|GT-I9228|SCH-P739|SCH-I925|\n        GT-I9200|GT-P5200|GT-P5210|GT-P5210X|SM-T385M|SM-P585M|SM-T311|SM-T310|SM-T310X|SM-T210|SM-T210R|SM-T211|SM-P600|\n        SM-P601|SM-P605|SM-P615|SM-P900|SM-P901|SM-T217|SM-T217A|SM-T217S|SM-P6000|SM-T3100|SGH-I467|XE500|SM-T110|\n        GT-P5220|GT-I9200X|GT-N5110X|GT-N5120|SM-P905|SM-T111|SM-T2105|SM-T315|SM-T320|SM-T320X|SM-T321|\n        SM-T510|SM-T520|SM-T525|SM-T530NU|SM-T230NU|SM-T330NU|SM-T900|XE500T1C|SM-P605V|SM-P905V|SM-T337V|SM-T537V|\n        SM-T707V|SM-T807V|SM-P600X|SM-P900X|SM-T210X|SM-T230|SM-T230X|SM-T325|GT-P7503|SM-T531|SM-T500|SM-T330|\n        SM-T530|SM-T705|SM-T705C|SM-T535|SM-T331|SM-T800|SM-T700|SM-T537|SM-T807|SM-P907A|SM-T337A|SM-T537A|\n        SM-T707A|SM-T807A|SM-T237|SM-T807P|SM-P607T|SM-T217T|SM-T337T|SM-T807T|SM-T116NQ|SM-T116BU|SM-P550|\n        SM-T350|SM-T550|SM-T9000|SM-P9000|SM-T705Y|SM-T805|GT-P3113|SM-T710|SM-T810|SM-T815|SM-T360|SM-T533|\n        SM-T113|SM-T335|SM-T715|SM-T560|SM-T670|SM-T677|SM-T377|SM-T567|SM-T357T|SM-T555|SM-T561|SM-T713|\n        SM-T719|SM-T813|SM-T819|SM-T580|SM-T590|SM-T355Y?|SM-T280|SM-T817A|SM-T820|SM-W700|SM-P580|SM-T587|SM-P350|\n        SM-P555M|SM-P355M|SM-T113NU|SM-T815Y|SM-T585|SM-T285|SM-T825|SM-W708|SM-T835|SM-P585Y"),Kindle:new RegExp("Kindle|Silk.*Accelerated|Android.*\\b(KFOT|KFTT|KFJWI|KFJWA|KFOTE|KFSOWI|KFTHWI|KFTHWA|KFAPWI|\n        KFAPWA|WFJWAE|KFSAWA|KFSAWI|KFASWI|KFARWI|KFFOWI|KFGIWI|KFMEWI)\\b|Android.*Silk/[0-9.]+ like Chrome        /[0-9.]+ (?!Mobile)"),SurfaceTablet:/Windows NT [0-9.]+; ARM;.*(Tablet|ARMBJS)/,HPTablet:/HP Slate (7|8|10)|HP ElitePad 900|hp-tablet|EliteBook.*Touch|HP 8|Slate 21|HP SlateBook 10/,AsusTablet:new RegExp("^.*PadFone((?!Mobile).)*$|Transformer|TF101|TF101G|TF300T|TF300TG|TF300TL|TF700T|TF700KL|\n        TF701T|TF810C|ME171|ME301T|ME302C|ME371MG|ME370T|ME372MG|ME172V|ME173X|ME400C|\n        Slider SL101|\\bK00F\\b|\\bK00C\\b|\\bK00E\\b|\\bK00L\\b|TX201LA|ME176C|ME102A|\\bM80TA\\b|ME372CL|\n        ME560CG|ME372CG|ME302KL| K010 | K011 | K017 | K01E |ME572C|ME103K|ME170C|ME171C|\\bME70C\\b|ME581C|\n        ME581CL|ME8510C|ME181C|P01Y|PO1MA|P01Z|\\bP027\\b|\\bP024\\b|\\bP00C\\b"),BlackBerryTablet:/PlayBook|RIM Tablet/,HTCtablet:/HTC_Flyer_P512|HTC Flyer|HTC Jetstream|HTC-P715a|HTC EVO View 4G|PG41200|PG09410/,MotorolaTablet:/xoom|sholest|MZ615|MZ605|MZ505|MZ601|MZ602|MZ603|MZ604|MZ606|MZ607|MZ608|MZ609|MZ615|MZ616|MZ617/,NookTablet:/Android.*Nook|NookColor|nook browser|BNRV200|BNRV200A|BNTV250|BNTV250A|BNTV400|BNTV600|LogicPD Zoom2/,AcerTablet:new RegExp("Android.*; \\b(A100|A101|A110|A200|A210|A211|A500|A501|A510|A511|A700|A701|W500|W500P|W501|\n        W501P|W510|W511|W700|G100|G100W|B1-A71|B1-710|B1-711|A1-810|A1-811|A1-830)\\b|W3-810|\\bA3-A10\\b|\\bA3-A11\\b|\n        \\bA3-A20\\b|\\bA3-A30"),ToshibaTablet:/Android.*(AT100|AT105|AT200|AT205|AT270|AT275|AT300|AT305|AT1S5|AT500|AT570|AT700|AT830)|TOSHIBA.*FOLIO/,LGTablet:/\bL-06C|LG-V909|LG-V900|LG-V700|LG-V510|LG-V500|LG-V410|LG-V400|LG-VK810\b/,FujitsuTablet:/Android.*\b(F-01D|F-02F|F-05E|F-10D|M532|Q572)\b/,PrestigioTablet:new RegExp("PMP3170B|PMP3270B|PMP3470B|PMP7170B|PMP3370B|PMP3570C|PMP5870C|PMP3670B|PMP5570C|\n        PMP5770D|PMP3970B|PMP3870C|PMP5580C|PMP5880D|PMP5780D|PMP5588C|PMP7280C|PMP7280C3G|PMP7280|PMP7880D|\n        PMP5597D|PMP5597|PMP7100D|PER3464|PER3274|PER3574|PER3884|PER5274|PER5474|PMP5097CPRO|PMP5097|PMP7380D|\n        PMP5297C|PMP5297C_QUAD|PMP812E|PMP812E3G|PMP812F|PMP810E|PMP880TD|PMT3017|PMT3037|PMT3047|PMT3057|PMT7008|\n        PMT5887|PMT5001|PMT5002"),LenovoTablet:new RegExp("Lenovo TAB|Idea(Tab|Pad)( A1|A10| K1|)|ThinkPad([ ]+)?Tablet|YT3-850M|YT3-X90L|YT3-X90F|\n        YT3-X90X|Lenovo.*(S2109|S2110|S5000|S6000|K3011|A3000|A3500|A1000|A2107|A2109|A1107|A5500|A7600|B6000|\n        B8000|B8080)(-|)(FL|F|HV|H|)|TB-X606F|TB-X103F|TB-X304F|TB-X304L|TB-X704F|TB-8703F|Tab2A7-10F|TB2-X30L|TB-8504F"),DellTablet:/Venue 11|Venue 8|Venue 7|Dell Streak 10|Dell Streak 7/,YarvikTablet:new RegExp("Android.*\\b(TAB210|TAB211|TAB224|TAB250|TAB260|TAB264|TAB310|TAB360|TAB364|TAB410|TAB411|\n        TAB420|TAB424|TAB450|TAB460|TAB461|TAB464|TAB465|TAB467|TAB468|TAB07-100|TAB07-101|TAB07-150|TAB07-151|\n        TAB07-152|TAB07-200|TAB07-201-3G|TAB07-210|TAB07-211|TAB07-212|TAB07-214|TAB07-220|TAB07-400|TAB07-485|\n        TAB08-150|TAB08-200|TAB08-201-3G|TAB08-201-30|TAB09-100|TAB09-211|TAB09-410|TAB10-150|TAB10-201|TAB10-211|\n        TAB10-400|TAB10-410|TAB13-201|TAB274EUK|TAB275EUK|TAB374EUK|TAB462EUK|TAB474EUK|TAB9-200)\\b"),MedionTablet:/Android.*\bOYO\b|LIFE.*(P9212|P9514|P9516|S9512)|LIFETAB/,ArnovaTablet:/97G4|AN10G2|AN7bG3|AN7fG3|AN8G3|AN8cG3|AN7G3|AN9G3|AN7dG3|AN7dG3ST|AN7dG3ChildPad|AN10bG3|AN10bG3DT|AN9G2/,IntensoTablet:/INM8002KP|INM1010FP|INM805ND|Intenso Tab|TAB1004/,IRUTablet:/M702pro/,MegafonTablet:/MegaFon V9|\bZTE V9\b|Android.*\bMT7A\b/,EbodaTablet:/E-Boda (Supreme|Impresspeed|Izzycomm|Essential)/,AllViewTablet:/Allview.*(Viva|Alldro|City|Speed|All TV|Frenzy|Quasar|Shine|TX1|AX1|AX2)/,ArchosTablet:new RegExp("\\b(101G9|80G9|A101IT)\\b|Qilive 97R|Archos5|\\bARCHOS (70|79|80|90|97|101|FAMILYPAD|)(b|c|)(G10|\n         Cobalt| TITANIUM(HD|)| Xenon| Neon|XSK| 2| XS 2| PLATINUM| CARBON|GAMEPAD)\\b"),AinolTablet:/NOVO7|NOVO8|NOVO10|Novo7Aurora|Novo7Basic|NOVO7PALADIN|novo9-Spark/,NokiaLumiaTablet:/Lumia 2520/,SonyTablet:new RegExp("Sony.*Tablet|Xperia Tablet|Sony Tablet S|SO-03E|SGPT12|SGPT13|SGPT114|SGPT121|SGPT122|SGPT123|\n        SGPT111|SGPT112|SGPT113|SGPT131|SGPT132|SGPT133|SGPT211|SGPT212|SGPT213|SGP311|SGP312|SGP321|EBRD1101|\n        EBRD1102|EBRD1201|SGP351|SGP341|SGP511|SGP512|SGP521|SGP541|SGP551|SGP621|SGP641|SGP612|SOT31|SGP771|SGP611|\n        SGP612|SGP712"),PhilipsTablet:/\b(PI2010|PI3000|PI3100|PI3105|PI3110|PI3205|PI3210|PI3900|PI4010|PI7000|PI7100)\b/,CubeTablet:/Android.*(K8GT|U9GT|U10GT|U16GT|U17GT|U18GT|U19GT|U20GT|U23GT|U30GT)|CUBE U8GT/,CobyTablet:new RegExp("MID1042|MID1045|MID1125|MID1126|MID7012|MID7014|MID7015|MID7034|MID7035|MID7036|MID7042|MID7048|\n        MID7127|MID8042|MID8048|MID8127|MID9042|MID9740|MID9742|MID7022|MID7010"),MIDTablet:new RegExp("M9701|M9000|M9100|M806|M1052|M806|T703|MID701|MID713|MID710|MID727|MID760|MID830|MID728|MID933|\n        MID125|MID810|MID732|MID120|MID930|MID800|MID731|MID900|MID100|MID820|MID735|MID980|MID130|MID833|MID737|\n        MID960|MID135|MID860|MID736|MID140|MID930|MID835|MID733|MID4X10"),MSITablet:new RegExp("MSI \\b(Primo 73K|Primo 73L|Primo 81L|Primo 77|Primo 93|Primo 75|Primo 76|Primo 73|Primo 81|\n        Primo 91|Primo 90|Enjoy 71|Enjoy 7|Enjoy 10)\\b"),SMiTTablet:/Android.*(\bMID\b|MID-560|MTV-T1200|MTV-PND531|MTV-P1101|MTV-PND530)/,RockChipTablet:/Android.*(RK2818|RK2808A|RK2918|RK3066)|RK2738|RK2808A/,FlyTablet:/IQ310|Fly Vision/,bqTablet:new RegExp("Android.*(bq)?.*(Elcano|Curie|Edison|Maxwell|Kepler|Pascal|Tesla|Hypatia|Platon|Newton|\n        Livingstone|Cervantes|Avant|Aquaris ([E|M]10|M8))|Maxwell.*Lite|Maxwell.*Plus"),HuaweiTablet:new RegExp("MediaPad|MediaPad 7 Youth|MediaPad T3 10|IDEOS S7|S7-201c|S7-202u|S7-101|S7-103|S7-104|S7-105|S7-106|\n        S7-201|S7-Slim|M2-A01L|BAH-L09|BAH-W09|AGS-W09"),NecTablet:/\bN-06D|\bN-08D/,PantechTablet:/Pantech.*P4100/,BronchoTablet:/Broncho.*(N701|N708|N802|a710)/,VersusTablet:/TOUCHPAD.*[78910]|\bTOUCHTAB\b/,ZyncTablet:/z1000|Z99 2G|z99|z930|z999|z990|z909|Z919|z900/,PositivoTablet:/TB07STA|TB10STA|TB07FTA|TB10FTA/,NabiTablet:/Android.*\bNabi/,KoboTablet:/Kobo Touch|\bK080\b|\bVox\b Build|\bArc\b Build/,DanewTablet:/DSlide.*\b(700|701R|702|703R|704|802|970|971|972|973|974|1010|1012)\b/,TexetTablet:new RegExp("NaviPad|TB-772A|TM-7045|TM-7055|TM-9750|TM-7016|TM-7024|TM-7026|TM-7041|TM-7043|TM-7047|\n        TM-8041|TM-9741|TM-9747|TM-9748|TM-9751|TM-7022|TM-7021|TM-7020|TM-7011|TM-7010|TM-7023|TM-7025|\n        TM-7037W|TM-7038W|TM-7027W|TM-9720|TM-9725|TM-9737W|TM-1020|TM-9738W|TM-9740|TM-9743W|TB-807A|TB-771A|\n        TB-727A|TB-725A|TB-719A|TB-823A|TB-805A|TB-723A|TB-715A|TB-707A|TB-705A|TB-709A|TB-711A|TB-890HD|\n        TB-880HD|TB-790HD|TB-780HD|TB-770HD|TB-721HD|TB-710HD|TB-434HD|TB-860HD|TB-840HD|TB-760HD|TB-750HD|\n        TB-740HD|TB-730HD|TB-722HD|TB-720HD|TB-700HD|TB-500HD|TB-470HD|TB-431HD|TB-430HD|TB-506|TB-504|TB-446|\n        TB-436|TB-416|TB-146SE|TB-126SE"),PlaystationTablet:/Playstation.*(Portable|Vita)/,TrekstorTablet:/ST10416-1|VT10416-1|ST70408-1|ST702xx-1|ST702xx-2|ST80208|ST97216|ST70104-2|VT10416-2|ST10216-2A|SurfTab/,PyleAudioTablet:/\b(PTBL10CEU|PTBL10C|PTBL72BC|PTBL72BCEU|PTBL7CEU|PTBL7C|PTBL92BC|PTBL92BCEU|PTBL9CEU|PTBL9CUK|PTBL9C)\b/,AdvanTablet:new RegExp("Android.* \\b(E3A|T3X|T5C|T5B|T3E|T3C|T3B|T1J|T1F|T2A|T1H|T1i|E1C|T1-E|T5-A|T4|E1-B|T2Ci|\n        T1-B|T1-D|O1-A|E1-A|T1-A|T3A|T4i)\\b"),DanyTechTablet:"Genius Tab G3|Genius Tab S2|Genius Tab Q3|Genius Tab G4|Genius Tab Q4|Genius Tab G-II|\n        Genius TAB GII|Genius TAB GIII|Genius Tab S1",GalapadTablet:/Android.*\bG1\b(?!\))/,MicromaxTablet:/Funbook|Micromax.*\b(P250|P560|P360|P362|P600|P300|P350|P500|P275)\b/,KarbonnTablet:/Android.*\b(A39|A37|A34|ST8|ST10|ST7|Smart Tab3|Smart Tab2)\b/,AllFineTablet:/Fine7 Genius|Fine7 Shine|Fine7 Air|Fine8 Style|Fine9 More|Fine10 Joy|Fine11 Wide/,PROSCANTablet:new RegExp("\\b(PEM63|PLT1023G|PLT1041|PLT1044|PLT1044G|PLT1091|PLT4311|PLT4311PL|PLT4315|PLT7030|\n        PLT7033|PLT7033D|PLT7035|PLT7035D|PLT7044K|PLT7045K|PLT7045KB|PLT7071KG|PLT7072|PLT7223G|PLT7225G|\n        PLT7777G|PLT7810K|PLT7849G|PLT7851G|PLT7852G|PLT8015|PLT8031|PLT8034|PLT8036|PLT8080K|PLT8082|PLT8088|\n        PLT8223G|PLT8234G|PLT8235G|PLT8816K|PLT9011|PLT9045K|PLT9233G|PLT9735|PLT9760G|PLT9770G)\\b"),YONESTablet:/BQ1078|BC1003|BC1077|RK9702|BC9730|BC9001|IT9001|BC7008|BC7010|BC708|BC728|BC7012|BC7030|BC7027|BC7026/,ChangJiaTablet:new RegExp("TPC7102|TPC7103|TPC7105|TPC7106|TPC7107|TPC7201|TPC7203|TPC7205|TPC7210|TPC7708|TPC7709|\n        TPC7712|TPC7110|TPC8101|TPC8103|TPC8105|TPC8106|TPC8203|TPC8205|TPC8503|TPC9106|TPC9701|TPC97101|TPC97103|\n        TPC97105|TPC97106|TPC97111|TPC97113|TPC97203|TPC97603|TPC97809|TPC97205|TPC10101|TPC10103|TPC10106|\n        TPC10111|TPC10203|TPC10205|TPC10503"),GUTablet:/TX-A1301|TX-M9002|Q702|kf026/,PointOfViewTablet:new RegExp("TAB-P506|TAB-navi-7-3G-M|TAB-P517|TAB-P-527|TAB-P701|TAB-P703|TAB-P721|TAB-P731N|\n        TAB-P741|TAB-P825|TAB-P905|TAB-P925|TAB-PR945|TAB-PL1015|TAB-P1025|TAB-PI1045|TAB-P1325|TAB-PROTAB[0-9]+|\n        TAB-PROTAB25|TAB-PROTAB26|TAB-PROTAB27|TAB-PROTAB26XL|TAB-PROTAB2-IPS9|TAB-PROTAB30-IPS9|TAB-PROTAB25XXL|\n        TAB-PROTAB26-IPS10|TAB-PROTAB30-IPS10"),OvermaxTablet:new RegExp("OV-(SteelCore|NewBase|Basecore|Baseone|Exellen|Quattor|EduTab|Solution|ACTION|BasicTab|TeddyTab|\n        MagicTab|Stream|TB-08|TB-09)|Qualcore 1027"),HCLTablet:/HCL.*Tablet|Connect-3G-2.0|Connect-2G-2.0|ME Tablet U1|ME Tablet U2|ME Tablet G1|ME Tablet X1|ME Tablet Y2|ME Tablet Sync/,DPSTablet:/DPS Dream 9|DPS Dual 7/,VistureTablet:/V97 HD|i75 3G|Visture V4( HD)?|Visture V5( HD)?|Visture V10/,CrestaTablet:/CTP(-)?810|CTP(-)?818|CTP(-)?828|CTP(-)?838|CTP(-)?888|CTP(-)?978|CTP(-)?980|CTP(-)?987|CTP(-)?988|CTP(-)?989/,MediatekTablet:/\bMT8125|MT8389|MT8135|MT8377\b/,ConcordeTablet:/Concorde([ ]+)?Tab|ConCorde ReadMan/,GoCleverTablet:new RegExp("GOCLEVER TAB|A7GOCLEVER|M1042|M7841|M742|R1042BK|R1041|TAB A975|TAB A7842|TAB A741|TAB A741L|TAB M723G|\n        TAB M721|TAB A1021|TAB I921|TAB R721|TAB I720|TAB T76|TAB R70|TAB R76.2|TAB R106|TAB R83.2|TAB M813G|TAB I721|\n        GCTA722|TAB I70|TAB I71|TAB S73|TAB R73|TAB R74|TAB R93|TAB R75|TAB R76.1|TAB A73|TAB A93|TAB A93.2|TAB T72|\n        TAB R83|TAB R974|TAB R973|TAB A101|TAB A103|TAB A104|TAB A104.2|R105BK|M713G|A972BK|TAB A971|TAB R974.2|\n        TAB R104|TAB R83.3|TAB A1042"),ModecomTablet:new RegExp("FreeTAB 9000|FreeTAB 7.4|FreeTAB 7004|FreeTAB 7800|FreeTAB 2096|FreeTAB 7.5|FreeTAB 1014|\n        FreeTAB 1001 |FreeTAB 8001|FreeTAB 9706|FreeTAB 9702|FreeTAB 7003|FreeTAB 7002|FreeTAB 1002|FreeTAB 7801|\n        FreeTAB 1331|FreeTAB 1004|FreeTAB 8002|FreeTAB 8014|FreeTAB 9704|FreeTAB 1003"),VoninoTablet:new RegExp("\\b(Argus[ _]?S|Diamond[ _]?79HD|Emerald[ _]?78E|Luna[ _]?70C|Onyx[ _]?S|Onyx[ _]?Z|\n        Orin[ _]?HD|Orin[ _]?S|Otis[ _]?S|SpeedStar[ _]?S|Magnet[ _]?M9|Primus[ _]?94[ _]?3G|Primus[ _]?94HD|\n        Primus[ _]?QS|Android.*\\bQ8\\b|Sirius[ _]?EVO[ _]?QS|Sirius[ _]?QS|Spirit[ _]?S)\\b"),ECSTablet:/V07OT2|TM105A|S10OT1|TR10CS1/,StorexTablet:/eZee[_']?(Tab|Go)[0-9]+|TabLC7|Looney Tunes Tab/,VodafoneTablet:/SmartTab([ ]+)?[0-9]+|SmartTabII10|SmartTabII7|VF-1497/,EssentielBTablet:/Smart[ ']?TAB[ ]+?[0-9]+|Family[ ']?TAB2/,RossMoorTablet:/RM-790|RM-997|RMD-878G|RMD-974R|RMT-705A|RMT-701|RME-601|RMT-501|RMT-711/,iMobileTablet:/i-mobile i-note/,TolinoTablet:/tolino tab [0-9.]+|tolino shine/,AudioSonicTablet:/\bC-22Q|T7-QC|T-17B|T-17P\b/,AMPETablet:/Android.* A78 /,SkkTablet:/Android.* (SKYPAD|PHOENIX|CYCLOPS)/,TecnoTablet:/TECNO P9|TECNO DP8D/,JXDTablet:new RegExp("Android.* \\b(F3000|A3300|JXD5000|JXD3000|JXD2000|JXD300B|JXD300|S5800|S7800|S602b|S5110b|S7300|\n        S5300|S602|S603|S5100|S5110|S601|S7100a|P3000F|P3000s|P101|P200s|P1000m|P200m|P9100|P1000s|S6600b|S908|\n        P1000|P300|S18|S6600|S9100)\\b"),iJoyTablet:new RegExp("Tablet (Spirit 7|Essentia|Galatea|Fusion|Onix 7|Landa|Titan|Scooby|Deox|Stella|Themis|Argon|\n        Unique 7|Sygnus|Hexen|Finity 7|Cream|Cream X2|Jade|Neon 7|Neron 7|Kandy|Scape|Saphyr 7|Rebel|Biox|Rebel|\n        Rebel 8GB|Myst|Draco 7|Myst|Tab7-004|Myst|Tadeo Jones|Tablet Boing|Arrow|Draco Dual Cam|Aurix|Mint|Amity|\n        Revolution|Finity 9|Neon 9|T9w|Amity 4GB Dual Cam|Stone 4GB|Stone 8GB|Andromeda|Silken|X2|Andromeda II|\n        Halley|Flame|Saphyr 9,7|Touch 8|Planet|Triton|Unique 10|Hexen 10|Memphis 4GB|Memphis 8GB|Onix 10)"),FX2Tablet:/FX2 PAD7|FX2 PAD10/,XoroTablet:new RegExp("KidsPAD 701|PAD[ ]?712|PAD[ ]?714|PAD[ ]?716|PAD[ ]?717|PAD[ ]?718|PAD[ ]?720|PAD[ ]?721|\n        PAD[ ]?722|PAD[ ]?790|PAD[ ]?792|PAD[ ]?900|PAD[ ]?9715D|PAD[ ]?9716DR|PAD[ ]?9718DR|PAD[ ]?9719QR|\n        PAD[ ]?9720QR|TelePAD1030|Telepad1032|TelePAD730|TelePAD731|TelePAD732|TelePAD735Q|TelePAD830|TelePAD9730|\n        TelePAD795|MegaPAD 1331|MegaPAD 1851|MegaPAD 2151"),ViewsonicTablet:/ViewPad 10pi|ViewPad 10e|ViewPad 10s|ViewPad E72|ViewPad7|ViewPad E100|ViewPad 7e|ViewSonic VB733|VB100a/,VerizonTablet:/QTAQZ3|QTAIR7|QTAQTZ3|QTASUN1|QTASUN2|QTAXIA1/,OdysTablet:/LOOX|XENO10|ODYS[ -](Space|EVO|Xpress|NOON)|\bXELIO\b|Xelio10Pro|XELIO7PHONETAB|XELIO10EXTREME|XELIOPT2|NEO_QUAD10/,CaptivaTablet:/CAPTIVA PAD/,IconbitTablet:new RegExp("NetTAB|NT-3702|NT-3702S|NT-3702S|NT-3603P|NT-3603P|NT-0704S|NT-0704S|NT-3805C|NT-3805C|\n        NT-0806C|NT-0806C|NT-0909T|NT-0909T|NT-0907S|NT-0907S|NT-0902S|NT-0902S"),TeclastTablet:new RegExp("T98 4G|\\bP80\\b|\\bX90HD\\b|X98 Air|X98 Air 3G|\\bX89\\b|P80 3G|\\bX80h\\b|P98 Air|\n        \\bX89HD\\b|P98 3G|\\bP90HD\\b|P89 3G|X98 3G|\\bP70h\\b|P79HD 3G|G18d 3G|\\bP79HD\\b|\\bP89s\\b|\\bA88\\b|\n        \\bP10HD\\b|\\bP19HD\\b|G18 3G|\\bP78HD\\b|\\bA78\\b|\\bP75\\b|G17s 3G|G17h 3G|\\bP85t\\b|\\bP90\\b|\n        \\bP11\\b|\\bP98t\\b|\\bP98HD\\b|\\bG18d\\b|\\bP85s\\b|\\bP11HD\\b|\\bP88s\\b|\\bA80HD\\b|\\bA80se\\b|\n        \\bA10h\\b|\\bP89\\b|\\bP78s\\b|\\bG18\\b|\\bP85\\b|\\bA70h\\b|\\bA70\\b|\\bG17\\b|\\bP18\\b|\\bA80s\\b|\n        \\bA11s\\b|\\bP88HD\\b|\\bA80h\\b|\\bP76s\\b|\\bP76h\\b|\\bP98\\b|\\bA10HD\\b|\\bP78\\b|\\bP88\\b|\\bA11\\b|\n        \\bA10t\\b|\\bP76a\\b|\\bP76t\\b|\\bP76e\\b|\\bP85HD\\b|\\bP85a\\b|\\bP86\\b|\\bP75HD\\b|\\bP76v\\b|\\bA12\\b|\n        \\bP75a\\b|\\bA15\\b|\\bP76Ti\\b|\\bP81HD\\b|\\bA10\\b|\\bT760VE\\b|\\bT720HD\\b|\\bP76\\b|\\bP73\\b|\\bP71\\b|\n        \\bP72\\b|\\bT720SE\\b|\\bC520Ti\\b|\\bT760\\b|\\bT720VE\\b|T720-3GE|T720-WiFi"),OndaTablet:new RegExp("\\b(V975i|Vi30|VX530|V701|Vi60|V701s|Vi50|V801s|V719|Vx610w|VX610W|V819i|Vi10|VX580W|Vi10|\n        V711s|V813|V811|V820w|V820|Vi20|V711|VI30W|V712|V891w|V972|V819w|V820w|Vi60|V820w|V711|V813s|V801|V819|\n        V975s|V801|V819|V819|V818|V811|V712|V975m|V101w|V961w|V812|V818|V971|V971s|V919|V989|V116w|V102w|V973|\n        Vi40)\\b[s]+|V10 \\b4G\\b"),JaytechTablet:/TPC-PA762/,BlaupunktTablet:/Endeavour 800NG|Endeavour 1010/,DigmaTablet:/\b(iDx10|iDx9|iDx8|iDx7|iDxD7|iDxD8|iDsQ8|iDsQ7|iDsQ8|iDsD10|iDnD7|3TS804H|iDsQ11|iDj7|iDs10)\b/,EvolioTablet:/ARIA_Mini_wifi|Aria[ _]Mini|Evolio X10|Evolio X7|Evolio X8|\bEvotab\b|\bNeura\b/,LavaTablet:/QPAD E704|\bIvoryS\b|E-TAB IVORY|\bE-TAB\b/,AocTablet:/MW0811|MW0812|MW0922|MTK8382|MW1031|MW0831|MW0821|MW0931|MW0712/,MpmanTablet:new RegExp("MP11 OCTA|MP10 OCTA|MPQC1114|MPQC1004|MPQC994|MPQC974|MPQC973|MPQC804|MPQC784|MPQC780|\n        \\bMPG7\\b|MPDCG75|MPDCG71|MPDC1006|MP101DC|MPDC9000|MPDC905|MPDC706HD|MPDC706|MPDC705|MPDC110|\n        MPDC100|MPDC99|MPDC97|MPDC88|MPDC8|MPDC77|MP709|MID701|MID711|MID170|MPDC703|MPQC1010"),CelkonTablet:/CT695|CT888|CT[\s]?910|CT7 Tab|CT9 Tab|CT3 Tab|CT2 Tab|CT1 Tab|C820|C720|\bCT-1\b/,WolderTablet:new RegExp("miTab \\b(DIAMOND|SPACE|BROOKLYN|NEO|FLY|MANHATTAN|FUNK|EVOLUTION|SKY|GOCAR|IRON|GENIUS|\n        POP|MINT|EPSILON|BROADWAY|JUMP|HOP|LEGEND|NEW AGE|LINE|ADVANCE|FEEL|FOLLOW|LIKE|LINK|LIVE|THINK|\n        FREEDOM|CHICAGO|CLEVELAND|BALTIMORE-GH|IOWA|BOSTON|SEATTLE|PHOENIX|DALLAS|IN 101|MasterChef)\\b"),MediacomTablet:"M-MPI10C3G|M-SP10EG|M-SP10EGP|M-SP10HXAH|M-SP7HXAH|M-SP10HXBH|M-SP8HXAH|M-SP8MXA",MiTablet:/\bMI PAD\b|\bHM NOTE 1W\b/,NibiruTablet:/Nibiru M1|Nibiru Jupiter One/,NexoTablet:/NEXO NOVA|NEXO 10|NEXO AVIO|NEXO FREE|NEXO GO|NEXO EVO|NEXO 3G|NEXO SMART|NEXO KIDDO|NEXO MOBI/,LeaderTablet:new RegExp("TBLT10Q|TBLT10I|TBL-10WDKB|TBL-10WDKBO2013|TBL-W230V2|TBL-W450|TBL-W500|SV572|TBLT7I|\n        TBA-AC7-8G|TBLT79|TBL-8W16|TBL-10W32|TBL-10WKB|TBL-W100"),UbislateTablet:/UbiSlate[\s]?7C/,PocketBookTablet:/Pocketbook/,KocasoTablet:/\b(TB-1207)\b/,HisenseTablet:/\b(F5281|E2371)\b/,Hudl:/Hudl HT7S3|Hudl 2/,TelstraTablet:/T-Hub2/,Honeywell:/RT10A/,GenericTablet:new RegExp("Android.*\\b97D\\b|Tablet(?!.*PC)|BNTV250A|MID-WCDMA|LogicPD Zoom2|\\bA7EB\\b|CatNova8|\n        A1_07|CT704|CT1002|\\bM721\\b|rk30sdk|\\bEVOTAB\\b|M758A|ET904|ALUMIUM10|Smartfren Tab|Endeavour 1010|\n        Tablet-PC-4|Tagi Tab|\\bM6pro\\b|CT1020W|arc 10HD|\\bTP750\\b|\\bQTAQZ3\\b|WVT101|TM1088|KT107")},jo={BLACKBERRY:"Blackberry",FIREFOX_OS:"Firefox-OS",CHROME_BOOK:"Chrome-Book",WINDOWS_PHONE:"Windows-Phone",VITA:"Vita",PS4:"PS4",MAC:"Macintosh",CHROMECAST:"Chromecast",APPLE_TV:"Apple-TV",GOOGLE_TV:"Google-TV",ANDROID:"Android",Tesla:"Tesla",iPad:"iPad",IPHONE:"iPhone",iPod:"iPod",UNKNOWN:au.UKNOWN,HTC:"HTC",NEXUS_PHONE:"Nexus Phone",NexusTablet:"Nexus Tablet",DELL:"Dell",MOTOROLA:"Motorola",SAMSUNG:"Samsung",LG:"LG",SONY:"Sony",ASUS:"Asus",NOKIA_LUMIA:"Nokia Lumia",MICROMAX:"Micromax",PALM:"Palm",VERTU:"Vertu",PANTECH:"PANTECH",FLY:"Fly",WIKO:"WIKO",I_MOBILE:"i-mobile",SIMVALLEY:"Simvalley",WOLFGANG:"Wolfgang",ALCATEL:"Alcatel",HONEYWELL:"Honeywell",NINTENDO:"Nintendo",AMOI:"Amoi",INQ:"INQ",GENERIC_PHONE:"Generic Phone",MI_SE_9:"Mi SE 9"},YF=[jo.PS4,jo.CHROME_BOOK,jo.MAC,jo.DELL,jo.ASUS,jo.UNKNOWN],R8={WINDOWS:"Windows",MAC:"Mac",IOS:"iOS",ANDROID:"Android",LINUX:"Linux",UNIX:"Unix",FIREFOX_OS:"Firefox-OS",CHROME_OS:"Chrome-OS",WINDOWS_PHONE:"Windows-Phone",UNKNOWN:au.UKNOWN},M8={WINDOWS_3_11:"windows-3-11",WINDOWS_95:"windows-95",WINDOWS_ME:"windows-me",WINDOWS_98:"windows-98",WINDOWS_CE:"windows-ce",WINDOWS_2000:"windows-2000",WINDOWS_XP:"windows-xp",WINDOWS_SERVER_2003:"windows-server-2003",WINDOWS_VISTA:"windows-vista",WINDOWS_7:"windows-7",WINDOWS_8_1:"windows-8-1",WINDOWS_8:"windows-8",WINDOWS_10:"windows-10",WINDOWS_PHONE_7_5:"windows-phone-7-5",WINDOWS_PHONE_8_1:"windows-phone-8-1",WINDOWS_PHONE_10:"windows-phone-10",WINDOWS_NT_4_0:"windows-nt-4-0",MACOSX_11_0:"mac-os-x-11-0",MACOSX_16:"mac-os-x-16",MACOSX_15:"mac-os-x-15",MACOSX_14:"mac-os-x-14",MACOSX_13:"mac-os-x-13",MACOSX_12:"mac-os-x-12",MACOSX_11:"mac-os-x-11",MACOSX_10:"mac-os-x-10",MACOSX_9:"mac-os-x-9",MACOSX_8:"mac-os-x-8",MACOSX_7:"mac-os-x-7",MACOSX_6:"mac-os-x-6",MACOSX_5:"mac-os-x-5",MACOSX_4:"mac-os-x-4",MACOSX_3:"mac-os-x-3",MACOSX_2:"mac-os-x-2",MACOSX:"mac-os-x",iOS:"iOS",ANDROID_9:"android-9",UNKNOWN:au.UKNOWN.toLowerCase()},jF={WINDOWS:{and:[{or:[/\bWindows|(Win\d\d)\b/,/\bWin 9x\b/]},{not:/\bWindows Phone\b/}]},MAC:{and:[/\bMac OS\b/,{not:{or:[/\biPhone\b/,/\biPad\b/,/\biPod\b/,/\bWindows Phone\b/]}}]},IOS:{and:[{or:[/\biPad\b/,/\biPhone\b/,/\biPod\b/]},{not:/\bWindows Phone\b/}]},ANDROID:{and:[/\bAndroid\b/,{not:/\bWindows Phone\b/}]},LINUX:/\bLinux\b/,UNIX:/\bUNIX\b/,FIREFOX_OS:{and:[/\bFirefox\b/,/Mobile\b/]},CHROME_OS:/\bCrOS\b/,WINDOWS_PHONE:{or:[/\bIEMobile\b/,/\bWindows Phone\b/]},PS4:/\bMozilla\/5.0 \(PlayStation 4\b/,VITA:/\bMozilla\/5.0 \(Play(S|s)tation Vita\b/},P8=Object.assign(Object.assign(Object.assign(Object.assign({},Fp),ou),jF),{FIREFOX_OS:{and:[/\bFirefox\b/,/\bMobile\b/]},CHROME_BOOK:/\bCrOS\b/,PS4:/\bMozilla\/5.0 \(PlayStation 4\b/,CHROMECAST:/\bCrKey\b/,APPLE_TV:/^iTunes-AppleTV\/4.1$/,GOOGLE_TV:/\bGoogleTV\b/,Tesla:/Tesla\/([0-9]{4}.[0-9]{1,2}.?[0-9]{0,2}.?[0-9]{0,2})-(.{7})/,MI_SE_9:/\bXiaomi\b/,MAC:{and:[/\bMac OS\b/,{not:{or:[/\biPhone\b/,/\biPad\b/,/\biPod\b/,/\bWindows Phone\b/]}}]}}),zE={WINDOWS_3_11:/Win16/,WINDOWS_95:/(Windows 95|Win95|Windows_95)/,WINDOWS_ME:/(Win 9x 4.90|Windows ME)/,WINDOWS_98:/(Windows 98|Win98)/,WINDOWS_CE:/Windows CE/,WINDOWS_2000:/(Windows NT 5.0|Windows 2000)/,WINDOWS_XP:/(Windows NT 5.1|Windows XP)/,WINDOWS_SERVER_2003:/Windows NT 5.2/,WINDOWS_VISTA:/Windows NT 6.0/,WINDOWS_7:/(Windows 7|Windows NT 6.1)/,WINDOWS_8_1:/(Windows 8.1|Windows NT 6.3)/,WINDOWS_8:/(Windows 8|Windows NT 6.2)/,WINDOWS_10:/(Windows NT 10.0)/,WINDOWS_PHONE_7_5:/(Windows Phone OS 7.5)/,WINDOWS_PHONE_8_1:/(Windows Phone 8.1)/,WINDOWS_PHONE_10:/(Windows Phone 10)/,WINDOWS_NT_4_0:{and:[/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/,{not:/Windows NT 10.0/}]},MACOSX:/(MAC OS X\s*[^ 0-9])/,MACOSX_3:/(Darwin 10.3|Mac OS X 10.3)/,MACOSX_4:/(Darwin 10.4|Mac OS X 10.4)/,MACOSX_5:/(Mac OS X 10.5)/,MACOSX_6:/(Mac OS X 10.6)/,MACOSX_7:/(Mac OS X 10.7)/,MACOSX_8:/(Mac OS X 10.8)/,MACOSX_9:/(Mac OS X 10.9)/,MACOSX_10:/(Mac OS X 10.10)/,MACOSX_11:/(Mac OS X 10.11)/,MACOSX_12:/(Mac OS X 10.12)/,MACOSX_13:/(Mac OS X 10.13)/,MACOSX_14:/(Mac OS X 10.14)/,MACOSX_15:/(Mac OS X 10.15)/,MACOSX_16:/(Mac OS X 10.16)/,MACOSX_11_0:{or:[/11_0 like Mac OS X/,/Mac OS X 11/]},iOS:/(iPhone OS\s*[0-9_]+)/,ANDROID_9:/(Android 9)/},WE={CHROME:[/\bChrome\/([\d\.]+)\b/,/\bCriOS\/([\d\.]+)\b/,/\bHeadlessChrome\/([\d\.]+)\b/],FIREFOX:[/\bFirefox\/([\d\.]+)\b/,/\bFxiOS\/([\d\.]+)\b/],SAFARI:[/\bVersion\/([\d\.]+)\b/,/\bSafari\/([\d\.]+)\b/],OPERA:[/\bVersion\/([\d\.]+)\b/,/\bOPR\/([\d\.]+)\b/],IE:[/\bMSIE ([\d\.]+\w?)\b/,/\brv:([\d\.]+\w?)\b/],MS_EDGE:/\bEdg(?:e|A|iOS)\/([\d\.]+)\b/,MS_EDGE_CHROMIUM:/\bEdg\/([\d\.]+)\b/,SAMSUNG:/\bSamsungBrowser\/([\d\.]+)\b/,UCBROWSER:/\bUCBrowser\/([\d\.]+)\b/},$F=(r,e)=>(r[e]=zE[e],r),w8=Object.keys(zE).reduce($F,{}),KF=(r,e)=>(r[HE[e]]=WE[e],r),QF=Object.keys(WE).reduce(KF,{});var Fa=Object.freeze({__proto__:null,GENERAL:au,BROWSERS:HE,MOBILES_RE:Fp,TABLETS_RE:ou,DEVICES:jo,DESKTOP_DEVICES:YF,OS:R8,OS_VERSIONS:M8,OS_RE:jF,BROWSERS_RE:{CHROME:{and:[{or:[/\bChrome\b/,/\bCriOS\b/,/\bHeadlessChrome\b/]},{not:{or:[/\bOPR\b/,/\bEdg(e|A|iOS)\b/,/\bEdg\/\b/,/\bSamsungBrowser\b/,/\bUCBrowser\b/]}}]},FIREFOX:{or:[/\bFirefox\b/,/\bFxiOS\b/]},SAFARI:{and:[/^((?!CriOS).)*\Safari\b.*$/,{not:{or:[/\bOPR\b/,/\bEdg(e|A|iOS)\b/,/\bEdg\/\b/,/\bWindows Phone\b/,/\bSamsungBrowser\b/,/\bUCBrowser\b/]}}]},OPERA:{or:[/Opera\b/,/\bOPR\b/]},IE:{or:[/\bMSIE\b/,/\bTrident\b/,/^Mozilla\/5\.0 \(Windows NT 10\.0; Win64; x64\)$/]},MS_EDGE:{or:[/\bEdg(e|A|iOS)\b/]},MS_EDGE_CHROMIUM:/\bEdg\/\b/,PS4:/\bMozilla\/5.0 \(PlayStation 4\b/,VITA:/\bMozilla\/5.0 \(Play(S|s)tation Vita\b/,FB_MESSANGER:/\bFBAN\/MessengerForiOS\b/,SAMSUNG:/\bSamsungBrowser\b/,UCBROWSER:/\bUCBrowser\b/},DEVICES_RE:P8,OS_VERSIONS_RE_MAP:zE,BROWSER_VERSIONS_RE_MAP:WE,OS_VERSIONS_RE:w8,BROWSER_VERSIONS_RE:QF,\u02750:$F,\u02751:KF});class O8{constructor(){}test(e,t){return"string"==typeof t&&(t=new RegExp(t)),t instanceof RegExp?t.test(e):t&&Array.isArray(t.and)?t.and.every(i=>this.test(e,i)):t&&Array.isArray(t.or)?t.or.some(i=>this.test(e,i)):!(!t||!t.not||this.test(e,t.not))}exec(e,t){return"string"==typeof t&&(t=new RegExp(t)),t instanceof RegExp?t.exec(e):t&&Array.isArray(t)?t.reduce((i,n)=>i||this.exec(e,n),null):null}}var Nl=(()=>{return(r=Nl||(Nl={})).Mobile="mobile",r.Tablet="tablet",r.Desktop="desktop",r.Unknown="unknown",Nl;var r})(),Wh=(()=>{return(r=Wh||(Wh={})).Portrait="portrait",r.Landscape="landscape",Wh;var r})();const XE="iPad";let F8=(()=>{class r{constructor(t){this.platformId=t,this.ua="",this.userAgent="",this.os="",this.browser="",this.device="",this.os_version="",this.browser_version="",this.reTree=new O8,this.deviceType="",this.orientation="",ja(this.platformId)&&"undefined"!=typeof window&&(this.userAgent=window.navigator.userAgent),this.setDeviceInfo(this.userAgent)}setDeviceInfo(t=this.userAgent){t!==this.userAgent&&(this.userAgent=t);const i=[{const:"OS",prop:"os"},{const:"BROWSERS",prop:"browser"},{const:"DEVICES",prop:"device"},{const:"OS_VERSIONS",prop:"os_version"}];if(i.forEach(n=>{this[n.prop]=Object.keys(Fa[n.const]).reduce((s,a)=>"device"===Fa[n.const][a]&&ja(this.platformId)&&(this.reTree.test(this.userAgent,ou[XE])||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)?(s[Fa[n.const][a]]=XE,Object):(s[Fa[n.const][a]]=this.reTree.test(t,Fa[`${n.const}_RE`][a]),s),{})}),i.forEach(n=>{this[n.prop]=Object.keys(Fa[n.const]).map(s=>Fa[n.const][s]).reduce((s,a)=>"device"===n.prop&&s===Fa[n.const].ANDROID?this[n.prop][a]?a:s:s===Fa[n.const].UNKNOWN&&this[n.prop][a]?a:s,Fa[n.const].UNKNOWN)}),this.browser_version="0",this.browser!==HE.UNKNOWN){const s=this.reTree.exec(t,QF[this.browser]);s&&(this.browser_version=s[1])}this.orientation="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(orientation: landscape)").matches?Wh.Landscape:Wh.Portrait:au.UKNOWN,this.deviceType=this.isTablet()?Nl.Tablet:this.isMobile(this.userAgent)?Nl.Mobile:this.isDesktop(this.userAgent)?Nl.Desktop:Nl.Unknown}getDeviceInfo(){return{userAgent:this.userAgent,os:this.os,browser:this.browser,device:this.device,os_version:this.os_version,browser_version:this.browser_version,deviceType:this.deviceType,orientation:this.orientation}}isMobile(t=this.userAgent){return!this.isTablet(t)&&!!Object.keys(Fp).find(n=>this.reTree.test(t,Fp[n]))}isTablet(t=this.userAgent){return!(!ja(this.platformId)||!(this.reTree.test(this.userAgent,ou[XE])||"undefined"!=typeof navigator&&"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1))||!!Object.keys(ou).find(n=>!!this.reTree.test(t,ou[n]))}isDesktop(t=this.userAgent){return(this.device!==jo.UNKNOWN||!this.isMobile(t)&&!this.isTablet(t))&&YF.indexOf(this.device)>-1}}return r.\u0275fac=function(t){return new(t||r)(rt(Gr))},r.\u0275prov=St({factory:function(){return new r(rt(Gr))},token:r,providedIn:"root"}),r})(),N8=(()=>{class r{constructor(t){this.deviceService=t,this.shadowGenerators=[],this.lightNamesWithUpdatingShadows=["InnerLightCeilingFanShadow"],console.log(this.deviceService.deviceType)}appendFromBabylonFile$(){return function qz(r,e){return e?(0,Zz.c)(r,e):new Pe.y((0,Qz.A)(r))}(yt.AppendAsync("assets/full_scene/","main.babylon",this.scene))}createScene$(t){return this.canvas=t.nativeElement,this.canvas.style.height="100%",this.canvas.style.width="100%",this.engine=new Ve(this.canvas,!0),this.scene=new dt(this.engine),this.windowReflectionProbe=new iu("window",256,this.scene),this.appendFromBabylonFile$().pipe(Mo(i=>this.handleLoadedStaticBabylonFile(i)))}handleLoadedStaticBabylonFile(t){this.camera=t.getNodeByName("cameraMain"),this.cameraMainPos=this.camera.position.clone(),this.cameraProjectsPos=t.getNodeByName("cameraProjects").position.clone(),t.materials.forEach(T=>{T instanceof Ma&&(T.maxSimultaneousLights=this.deviceService.isDesktop()?6:3)});const i=t.getMaterialByName("Facade");if(null!=i){const T=new j("assets/lightmaps/Facade_and_road_combined_lightmap_4k.jpg",t);i.lightmapTexture=T,i.useLightmapAsShadowmap=!0}const n=t.getMaterialByName("backwall_mat");if(null!=n){const T=new j("assets/lightmaps/wall_backShape_lightmap_1k_2.jpg",t);n.lightmapTexture=T,n.useLightmapAsShadowmap=!1}const s=t.getMaterialByName("GlassMat");if(t.getNodeByName("GlassPane").isPickable=!1,s.baseColor=Fe.Black(),s.metallic=0,s.alpha=.5,this.deviceService.isDesktop()){const T=t.getNodeByName("reflectionBG");null!=this.windowReflectionProbe.renderList&&null!=T&&this.windowReflectionProbe.renderList.push(T),s.environmentTexture=this.windowReflectionProbe.cubeTexture}t.lights.forEach(T=>{T instanceof hs&&(this.lightNamesWithUpdatingShadows.includes(T.name)?this.deviceService.isDesktop()?this.shadowGenerators.push(new fr(512,T)):this.shadowGenerators.push(new fr(128,T)):this.shadowGenerators.push(new fr(1024,T)))}),this.scene.meshes.forEach(T=>{T instanceof U&&(T.receiveShadows=!0),this.shadowGenerators.forEach(v=>{v.addShadowCaster(T)})}),this.shadowGenerators.forEach(T=>{T.usePoissonSampling=!0}),this.shadowGenerators.forEach(T=>{this.lightNamesWithUpdatingShadows.includes(T.getLight().name)||(T.getShadowMap().refreshRate=ir.REFRESHRATE_RENDER_ONCE)}),this.topTV=t.getNodeByName("TV2"),this.middleTV=t.getNodeByName("TV1"),this.bottomTV=t.getNodeByName("TV"),this.topTVCollision=this.topTV.getChildMeshes(!1,T=>"collision"===T.name)[0],this.middleTVCollision=this.middleTV.getChildMeshes(!1,T=>"collision"===T.name)[0],this.bottomTVCollision=this.bottomTV.getChildMeshes(!1,T=>"collision"===T.name)[0],this.topTVCollision.visibility=0,this.middleTVCollision.visibility=0,this.bottomTVCollision.visibility=0;const o=this.topTV.getChildMeshes(!1,T=>"kinescope"===T.name)[0],l=this.middleTV.getChildMeshes(!1,T=>"kinescope"===T.name)[0],c=this.bottomTV.getChildMeshes(!1,T=>"kinescope"===T.name)[0],u={autoPlay:!0,loop:!0,autoUpdateTexture:!0,muted:!0},d=new Ue("githubMat",t);d.diffuseTexture=new jc("githubTex",["assets/video/github/github.webm","assets/video/github/github.mp4"],t,!1,!1,0,u),d.emissiveColor=Fe.White(),o.material=d;const p=new Ue("contactMat",t);p.diffuseTexture=new jc("contactTex",["assets/video/contact/contact_me.webm","assets/video/contact/contact_me.mp4"],t,!1,!1,0,u),p.emissiveColor=Fe.White(),l.material=p;const _=new Ue("projectsMat",t);if(_.diffuseTexture=new jc("projectsTex",["assets/video/projects/project.webm","assets/video/projects/project.mp4"],t,!1,!1,0,u),_.emissiveColor=Fe.White(),c.material=_,this.deviceService.isDesktop()){var m=new gs("glow",this.scene,{mainTextureFixedSize:1024,blurKernelSize:256});m.intensity=1.5,m.addExcludedMesh(o),m.addExcludedMesh(l),m.addExcludedMesh(c)}}registerHover(t,i,n){i?t.getChildMeshes(!1).forEach(s=>{s.isPickable=!0,null==s.actionManager&&(s.actionManager=new Oa(this.scene)),s.actionManager.registerAction(new kh(Oa.OnPointerOverTrigger,n))}):(t.isPickable=!0,null==t.actionManager&&(t.actionManager=new Oa(this.scene)),t.actionManager.registerAction(new kh(Oa.OnPointerOverTrigger,n)))}registerEndHover(t,i,n){i?t.getChildMeshes(!1).forEach(s=>{s.isPickable=!0,null==s.actionManager&&(s.actionManager=new Oa(this.scene)),s.actionManager.registerAction(new kh(Oa.OnPointerOutTrigger,n))}):(t.isPickable=!0,null==t.actionManager&&(t.actionManager=new Oa(this.scene)),t.actionManager.registerAction(new kh(Oa.OnPointerOutTrigger,n)))}start(t,i=!0){i?t.runOutsideAngular(()=>{this.startTheEngine()}):this.startTheEngine()}startTheEngine(){let t=!0;this.engine.runRenderLoop(()=>{this.scene.render(),t&&(this.engine.resize(),t=!1)}),window.addEventListener("resize",()=>this.engine.resize())}}return r.\u0275fac=function(t){return new(t||r)(rt(F8))},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();var L8=L(1086),Np=L(6053),B8=L(3527);function ZF(r,e){return"function"==typeof e?t=>t.pipe(ZF((i,n)=>(0,B8.D)(r(i,n)).pipe((0,Ir.U)((s,a)=>e(i,s,n,a))))):t=>t.lift(new U8(r))}class U8{constructor(e){this.project=e}call(e,t){return t.subscribe(new V8(e,this.project))}}class V8 extends Rc.Ds{constructor(e,t){super(e),this.project=t,this.index=0}_next(e){let t;const i=this.index++;try{t=this.project(e,i)}catch(n){return void this.destination.error(n)}this._innerSub(t)}_innerSub(e){const t=this.innerSubscription;t&&t.unsubscribe();const i=new Rc.IY(this),n=this.destination;n.add(i),this.innerSubscription=(0,Rc.ft)(e,i),this.innerSubscription!==i&&n.add(this.innerSubscription)}_complete(){const{innerSubscription:e}=this;(!e||e.closed)&&super._complete(),this.unsubscribe()}_unsubscribe(){this.innerSubscription=void 0}notifyComplete(){this.innerSubscription=void 0,this.isStopped&&super._complete()}notifyNext(e){this.destination.next(e)}}var qF=L(1221),k8=L(2866);class z8{constructor(e){this.callback=e}call(e,t){return t.subscribe(new W8(e,this.callback))}}class W8 extends oh.L{constructor(e,t){super(e),this.add(new xe.w(t))}}class Y8{constructor(e,t){this.predicate=e,this.inclusive=t}call(e,t){return t.subscribe(new j8(e,this.predicate,this.inclusive))}}class j8 extends oh.L{constructor(e,t,i){super(e),this.predicate=t,this.inclusive=i,this.index=0}_next(e){const t=this.destination;let i;try{i=this.predicate(e,this.index++)}catch(n){return void t.error(n)}this.nextOrComplete(e,i)}nextOrComplete(e,t){const i=this.destination;Boolean(t)?i.next(e):(this.inclusive&&i.next(e),i.complete())}}var $8=L(6676),K8=L.n($8);function JF(){return r=>r.lift(new Q8)}class Q8{call(e,t){return t.subscribe(new Z8(e))}}class Z8 extends oh.L{constructor(e){super(e),this.hasPrev=!1}_next(e){let t;this.hasPrev?t=[this.prev,e]:this.hasPrev=!0,this.prev=e,t&&this.destination.next(t)}}var eN=L(2289);class q8{constructor(e,t,i,n,s){this.element=e,this.newWidth=t,this.newHeight=i,this.oldWidth=n,this.oldHeight=s}}let J8=(()=>{class r{constructor(t){this.element=t,this.resized=new is}ngOnInit(){eN.ResizeSensor&&(this.resizeSensor=new eN.ResizeSensor(this.element.nativeElement,()=>this.onResized()))}ngOnDestroy(){this.resizeSensor&&this.resizeSensor.detach()}onResized(){const t=this.element.nativeElement.clientWidth,i=this.element.nativeElement.clientHeight;if(t===this.oldWidth&&i===this.oldHeight)return;const n=new q8(this.element,t,i,this.oldWidth,this.oldHeight);this.oldWidth=this.element.nativeElement.clientWidth,this.oldHeight=this.element.nativeElement.clientHeight,this.resized.emit(n)}}return r.\u0275fac=function(t){return new(t||r)(de(Ii))},r.\u0275dir=Tt({type:r,selectors:[["","resized",""]],outputs:{resized:"resized"}}),r})(),e7=(()=>{class r{constructor(){this.windowSize$=this.getWindowSize$(),this.windowWidth$=this.getWindowWidth$(),this.windowHeight$=this.getWindowHeight$()}getHostSizeChange$(t){new J8(t)}getWindowWidth$(){return this.windowWidth$=new Io.X(window.innerWidth),this.windowSize$.pipe(JF(),(0,js.h)(t=>t[0].width!==t[1].width),(0,Ir.U)(t=>t[1].width)).subscribe(this.windowWidth$),this.windowWidth$}getWindowHeight$(){return this.windowHeight$=new Io.X(window.innerHeight),this.windowSize$.pipe(JF(),(0,js.h)(t=>t[0].height!==t[1].height),(0,Ir.U)(t=>t[1].height)).subscribe(this.windowHeight$),this.windowHeight$}getWindowSize$(){return this.windowSize$=new Io.X({width:window.innerWidth,height:window.innerHeight}),(0,Ic.R)(window,"resize").pipe((0,Ir.U)(t=>{const i=t.target;return{width:i.innerWidth,height:i.innerHeight}})).subscribe(this.windowSize$),this.windowSize$}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"root"}),r})(),tN=(()=>{class r{constructor(t){this.windowSizeService=t,this.cameraBasePos$=new ah.t(1),this.relativeMousePos$=new ah.t(1),this.relativeDeviceMotion$=new ah.t(1),this.currentCameraPos$=new ah.t(1),this.cameraPositions=[],this.cameraLimits={minX:-1.5,maxX:1.5,minY:1,maxY:-1},this.deviceMotionPosition$=new Io.X(new E),this.mouseMoveEvent$=(0,Ic.R)(document.body,"mousemove"),this.destroy$=new he.xQ,this.createRelativeMousePos()}ngOnDestroy(){this.destroy$.next()}moveBaseCameraPositionName(t){const i=this.cameraPositions.find(n=>n.name===t);null!=i&&this.cameraBasePos$.pipe(Wm(1),ZF(n=>(0,L8.of)(null).pipe(Wm(1),(0,Ir.U)(()=>i.pos),function G8(...r){const e=r[r.length-1];return(0,k8.K)(e)?(r.pop(),t=>(0,qF.z)(r,t,e)):t=>(0,qF.z)(r,t)}(n),(0,Ir.U)(s=>({x:s.x,y:s.y})),K8()({x:[120,18],y:[120,18]}),(0,Ir.U)(({x:s,y:a})=>new E(s,a,n.z)))),Mo(n=>this.cameraBasePos$.next(n)),function H8(r){return e=>e.lift(new z8(r))}(()=>this.currentCameraPos$.next(i)),function X8(r,e=!1){return t=>t.lift(new Y8(r,e))}(n=>n.x!=i.pos.x)).subscribe()}moveCameraByMousePos(){(0,Np.aj)([this.cameraBasePos$,this.relativeMousePos$]).pipe(Mo(([t,i])=>{if(i){const n=Se.Lerp(t.x+this.cameraLimits.minX,t.x+this.cameraLimits.maxX,i.x),s=Se.Lerp(t.y+this.cameraLimits.minY,t.y+this.cameraLimits.maxY,i.y);this.camera.position.x=n,this.camera.position.y=s}})).subscribe()}moveCameraByDeviceMotion(){(0,Np.aj)([this.cameraBasePos$]).pipe(Mo(([t])=>{this.camera.position.x=t.x,this.camera.position.y=t.y})).subscribe()}createRelativeMousePos(){(0,Np.aj)([this.windowSizeService.windowSize$,this.mouseMoveEvent$.pipe(ns(this.destroy$),(0,Ir.U)(t=>new We(t.clientX,t.clientY)))]).pipe((0,Ir.U)(([t,i])=>(i.x=i.x/t.width,i.y=i.y/t.height,i))).subscribe(t=>this.relativeMousePos$.next(t))}createRelativeDeviceMotion(){(0,Np.aj)([this.windowSizeService.windowSize$,this.deviceMotionPosition$]).pipe(ns(this.destroy$),(0,Ir.U)(([t,i])=>new We(i.x/t.width,i.y/t.height))).subscribe(t=>this.relativeMousePos$.next(t))}}return r.\u0275fac=function(t){return new(t||r)(rt(e7))},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const i7={provide:A0,useFactory:function t7(r,e){return()=>{if(ja(e)){const t=Array.from(r.querySelectorAll(`[class*=${iN}]`)),i=/\bflex-layout-.+?\b/g;t.forEach(n=>{n.classList.contains(`${iN}ssr`)&&n.parentNode?n.parentNode.removeChild(n):n.className.replace(i,"")})}}},deps:[xn,Gr],multi:!0},iN="flex-layout-";let YE=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({providers:[i7]}),r})();class Ll{constructor(e=!1,t="all",i="",n="",s=0){this.matches=e,this.mediaQuery=t,this.mqAlias=i,this.suffix=n,this.priority=s,this.property=""}clone(){return new Ll(this.matches,this.mediaQuery,this.mqAlias,this.suffix)}}let nN=(()=>{class r{constructor(){this.stylesheet=new Map}addStyleToElement(t,i,n){const s=this.stylesheet.get(t);s?s.set(i,n):this.stylesheet.set(t,new Map([[i,n]]))}clearStyles(){this.stylesheet.clear()}getStyleForElement(t,i){const n=this.stylesheet.get(t);let s="";if(n){const a=n.get(i);("number"==typeof a||"string"==typeof a)&&(s=a+"")}return s}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=St({factory:function(){return new r},token:r,providedIn:"root"}),r})();const jE={addFlexToParent:!0,addOrientationBps:!1,disableDefaultBps:!1,disableVendorPrefixes:!1,serverLoaded:!1,useColumnBasisZero:!0,printWithBreakpoints:[],mediaTriggerAutoRestore:!0,ssrObserveBreakpoints:[]},sa=new oi("Flex Layout token, config options for the library",{providedIn:"root",factory:()=>jE}),Bl=new oi("FlexLayoutServerLoaded",{providedIn:"root",factory:()=>!1}),$E=new oi("Flex Layout token, collect all breakpoints into one provider",{providedIn:"root",factory:()=>null});function rN(r,e){return r=r?r.clone():new Ll,e&&(r.mqAlias=e.alias,r.mediaQuery=e.mediaQuery,r.suffix=e.suffix,r.priority=e.priority),r}const KE="inline",sN=["row","column","row-reverse","column-reverse"];function s7(r){if(r)switch(r.toLowerCase()){case"reverse":case"wrap-reverse":case"reverse-wrap":r="wrap-reverse";break;case"no":case"none":case"nowrap":r="nowrap";break;default:r="wrap"}return r}let fn=(()=>{class r{constructor(t,i,n,s){this.elementRef=t,this.styleBuilder=i,this.styler=n,this.marshal=s,this.DIRECTIVE_KEY="",this.inputs=[],this.mru={},this.destroySubject=new he.xQ,this.styleCache=new Map}get parentElement(){return this.elementRef.nativeElement.parentElement}get nativeElement(){return this.elementRef.nativeElement}get activatedValue(){return this.marshal.getValue(this.nativeElement,this.DIRECTIVE_KEY)}set activatedValue(t){this.marshal.setValue(this.nativeElement,this.DIRECTIVE_KEY,t,this.marshal.activatedAlias)}ngOnChanges(t){Object.keys(t).forEach(i=>{if(-1!==this.inputs.indexOf(i)){const n=i.split(".").slice(1).join(".");this.setValue(t[i].currentValue,n)}})}ngOnDestroy(){this.destroySubject.next(),this.destroySubject.complete(),this.marshal.releaseElement(this.nativeElement)}init(t=[]){this.marshal.init(this.elementRef.nativeElement,this.DIRECTIVE_KEY,this.updateWithValue.bind(this),this.clearStyles.bind(this),t)}addStyles(t,i){const n=this.styleBuilder,s=n.shouldCache;let a=this.styleCache.get(t);(!a||!s)&&(a=n.buildStyles(t,i),s&&this.styleCache.set(t,a)),this.mru=Object.assign({},a),this.applyStyleToElement(a),n.sideEffect(t,a,i)}clearStyles(){Object.keys(this.mru).forEach(t=>{this.mru[t]=""}),this.applyStyleToElement(this.mru),this.mru={}}triggerUpdate(){this.marshal.triggerUpdate(this.nativeElement,this.DIRECTIVE_KEY)}getFlexFlowDirection(t,i=!1){if(t){const[n,s]=this.styler.getFlowDirection(t);if(!s&&i){const a=function n7(r){let[e,t,i]=function r7(r){r=r?r.toLowerCase():"";let[e,t,i]=r.split(" ");return sN.find(n=>n===e)||(e=sN[0]),t===KE&&(t=i!==KE?i:"",i=KE),[e,s7(t),!!i]}(r);return function a7(r,e=null,t=!1){return{display:t?"inline-flex":"flex","box-sizing":"border-box","flex-direction":r,"flex-wrap":e||null}}(e,t,i)}(n);this.styler.applyStyleToElements(a,[t])}return n.trim()}return"row"}hasWrap(t){return this.styler.hasWrap(t)}applyStyleToElement(t,i,n=this.nativeElement){this.styler.applyStyleToElement(n,t,i)}setValue(t,i){this.marshal.setValue(this.nativeElement,this.DIRECTIVE_KEY,t,i)}updateWithValue(t){this.currentValue!==t&&(this.addStyles(t),this.currentValue=t)}}return r.\u0275fac=function(t){!function cA(){throw new Error("invalid")}()},r.\u0275dir=Tt({type:r,features:[il]}),r})();const o7=[{alias:"xs",mediaQuery:"screen and (min-width: 0px) and (max-width: 599.98px)",priority:1e3},{alias:"sm",mediaQuery:"screen and (min-width: 600px) and (max-width: 959.98px)",priority:900},{alias:"md",mediaQuery:"screen and (min-width: 960px) and (max-width: 1279.98px)",priority:800},{alias:"lg",mediaQuery:"screen and (min-width: 1280px) and (max-width: 1919.98px)",priority:700},{alias:"xl",mediaQuery:"screen and (min-width: 1920px) and (max-width: 4999.98px)",priority:600},{alias:"lt-sm",overlapping:!0,mediaQuery:"screen and (max-width: 599.98px)",priority:950},{alias:"lt-md",overlapping:!0,mediaQuery:"screen and (max-width: 959.98px)",priority:850},{alias:"lt-lg",overlapping:!0,mediaQuery:"screen and (max-width: 1279.98px)",priority:750},{alias:"lt-xl",overlapping:!0,priority:650,mediaQuery:"screen and (max-width: 1919.98px)"},{alias:"gt-xs",overlapping:!0,mediaQuery:"screen and (min-width: 600px)",priority:-950},{alias:"gt-sm",overlapping:!0,mediaQuery:"screen and (min-width: 960px)",priority:-850},{alias:"gt-md",overlapping:!0,mediaQuery:"screen and (min-width: 1280px)",priority:-750},{alias:"gt-lg",overlapping:!0,mediaQuery:"screen and (min-width: 1920px)",priority:-650}],aN="(orientation: portrait) and (max-width: 599.98px)",oN="(orientation: landscape) and (max-width: 959.98px)",lN="(orientation: portrait) and (min-width: 600px) and (max-width: 839.98px)",cN="(orientation: landscape) and (min-width: 960px) and (max-width: 1279.98px)",uN="(orientation: portrait) and (min-width: 840px)",hN="(orientation: landscape) and (min-width: 1280px)",go={HANDSET:`${aN}, ${oN}`,TABLET:`${lN} , ${cN}`,WEB:`${uN}, ${hN} `,HANDSET_PORTRAIT:`${aN}`,TABLET_PORTRAIT:`${lN} `,WEB_PORTRAIT:`${uN}`,HANDSET_LANDSCAPE:`${oN}`,TABLET_LANDSCAPE:`${cN}`,WEB_LANDSCAPE:`${hN}`},l7=[{alias:"handset",priority:2e3,mediaQuery:go.HANDSET},{alias:"handset.landscape",priority:2e3,mediaQuery:go.HANDSET_LANDSCAPE},{alias:"handset.portrait",priority:2e3,mediaQuery:go.HANDSET_PORTRAIT},{alias:"tablet",priority:2100,mediaQuery:go.TABLET},{alias:"tablet.landscape",priority:2100,mediaQuery:go.TABLET_LANDSCAPE},{alias:"tablet.portrait",priority:2100,mediaQuery:go.TABLET_PORTRAIT},{alias:"web",priority:2200,mediaQuery:go.WEB,overlapping:!0},{alias:"web.landscape",priority:2200,mediaQuery:go.WEB_LANDSCAPE,overlapping:!0},{alias:"web.portrait",priority:2200,mediaQuery:go.WEB_PORTRAIT,overlapping:!0}],u7=/(\.|-|_)/g;function h7(r){let e=r.length>0?r.charAt(0):"",t=r.length>1?r.slice(1):"";return e.toUpperCase()+t}function p7(r,e=[]){const t={};return r.forEach(i=>{t[i.alias]=i}),e.forEach(i=>{t[i.alias]?function c7(r,...e){if(null==r)throw TypeError("Cannot convert undefined or null to object");for(let t of e)if(null!=t)for(let i in t)t.hasOwnProperty(i)&&(r[i]=t[i])}(t[i.alias],i):t[i.alias]=i}),function f7(r){return r.forEach(e=>{e.suffix||(e.suffix=function d7(r){return r.replace(u7,"|").split("|").map(h7).join("")}(e.alias),e.overlapping=!!e.overlapping)}),r}(Object.keys(t).map(i=>t[i]))}const dN=new oi("Token (@angular/flex-layout) Breakpoints",{providedIn:"root",factory:()=>{const r=vd($E),e=vd(sa),t=[].concat.apply([],(r||[]).map(n=>Array.isArray(n)?n:[n]));return p7((e.disableDefaultBps?[]:o7).concat(e.addOrientationBps?l7:[]),t)}});function Xh(r,e){return(e&&e.priority||0)-(r&&r.priority||0)}function g7(r,e){return(r.priority||0)-(e.priority||0)}let Yh=(()=>{class r{constructor(t){this.findByMap=new Map,this.items=[...t].sort(g7)}findByAlias(t){return t?this.findWithPredicate(t,i=>i.alias==t):null}findByQuery(t){return this.findWithPredicate(t,i=>i.mediaQuery==t)}get overlappings(){return this.items.filter(t=>1==t.overlapping)}get aliases(){return this.items.map(t=>t.alias)}get suffixes(){return this.items.map(t=>t.suffix?t.suffix:"")}findWithPredicate(t,i){let n=this.findByMap.get(t);return n||(n=this.items.find(i)||null,this.findByMap.set(t,n)),n||null}}return r.\u0275fac=function(t){return new(t||r)(rt(dN))},r.\u0275prov=St({factory:function(){return new r(rt(dN))},token:r,providedIn:"root"}),r})(),Lp=(()=>{class r{constructor(t,i,n){this._zone=t,this._platformId=i,this._document=n,this.source=new Io.X(new Ll(!0)),this.registry=new Map,this.pendingRemoveListenerFns=[],this._observable$=this.source.asObservable()}get activations(){const t=[];return this.registry.forEach((i,n)=>{i.matches&&t.push(n)}),t}isActive(t){const i=this.registry.get(t);return i?i.matches:this.registerQuery(t).some(n=>n.matches)}observe(t,i=!1){if(t&&t.length){const n=this._observable$.pipe((0,js.h)(a=>!i||t.indexOf(a.mediaQuery)>-1)),s=new Pe.y(a=>{const o=this.registerQuery(t);if(o.length){const l=o.pop();o.forEach(c=>{a.next(c)}),this.source.next(l)}a.complete()});return(0,ve.T)(s,n)}return this._observable$}registerQuery(t){const i=Array.isArray(t)?t:[t],n=[];return function _7(r,e){const t=r.filter(i=>!fN[i]);if(t.length>0){const i=t.join(", ");try{const n=e.createElement("style");n.setAttribute("type","text/css"),n.styleSheet||n.appendChild(e.createTextNode(`\n/*\n  @angular/flex-layout - workaround for possible browser quirk with mediaQuery listeners\n  see http://bit.ly/2sd4HMP\n*/\n@media ${i} {.fx-query-test{ }}\n`)),e.head.appendChild(n),t.forEach(s=>fN[s]=n)}catch(n){console.error(n)}}}(i,this._document),i.forEach(s=>{const a=l=>{this._zone.run(()=>this.source.next(new Ll(l.matches,s)))};let o=this.registry.get(s);o||(o=this.buildMQL(s),o.addListener(a),this.pendingRemoveListenerFns.push(()=>o.removeListener(a)),this.registry.set(s,o)),o.matches&&n.push(new Ll(!0,s))}),n}ngOnDestroy(){let t;for(;t=this.pendingRemoveListenerFns.pop();)t()}buildMQL(t){return function m7(r,e){return e&&window.matchMedia("all").addListener?window.matchMedia(r):{matches:"all"===r||""===r,media:r,addListener:()=>{},removeListener:()=>{},onchange:null,addEventListener(){},removeEventListener(){},dispatchEvent:()=>!1}}(t,ja(this._platformId))}}return r.\u0275fac=function(t){return new(t||r)(rt(Pn),rt(Gr),rt(xn))},r.\u0275prov=St({factory:function(){return new r(rt(Pn),rt(Gr),rt(xn))},token:r,providedIn:"root"}),r})();const fN={},lu="print",v7={alias:lu,mediaQuery:lu,priority:1e3};let pN=(()=>{class r{constructor(t,i,n){this.breakpoints=t,this.layoutConfig=i,this._document=n,this.registeredBeforeAfterPrintHooks=!1,this.isPrintingBeforeAfterEvent=!1,this.beforePrintEventListeners=[],this.afterPrintEventListeners=[],this.isPrinting=!1,this.queue=new S7,this.deactivations=[]}withPrintQuery(t){return[...t,lu]}isPrintEvent(t){return t.mediaQuery.startsWith(lu)}get printAlias(){return this.layoutConfig.printWithBreakpoints||[]}get printBreakPoints(){return this.printAlias.map(t=>this.breakpoints.findByAlias(t)).filter(t=>null!==t)}getEventBreakpoints({mediaQuery:t}){const i=this.breakpoints.findByQuery(t);return(i?[...this.printBreakPoints,i]:this.printBreakPoints).sort(Xh)}updateEvent(t){let i=this.breakpoints.findByQuery(t.mediaQuery);return this.isPrintEvent(t)&&(i=this.getEventBreakpoints(t)[0],t.mediaQuery=i?i.mediaQuery:""),rN(t,i)}registerBeforeAfterPrintHooks(t){if(!this._document.defaultView||this.registeredBeforeAfterPrintHooks)return;this.registeredBeforeAfterPrintHooks=!0;const i=()=>{this.isPrinting||(this.isPrintingBeforeAfterEvent=!0,this.startPrinting(t,this.getEventBreakpoints(new Ll(!0,lu))),t.updateStyles())},n=()=>{this.isPrintingBeforeAfterEvent=!1,this.isPrinting&&(this.stopPrinting(t),t.updateStyles())};this._document.defaultView.addEventListener("beforeprint",i),this._document.defaultView.addEventListener("afterprint",n),this.beforePrintEventListeners.push(i),this.afterPrintEventListeners.push(n)}interceptEvents(t){return this.registerBeforeAfterPrintHooks(t),i=>{this.isPrintEvent(i)?i.matches&&!this.isPrinting?(this.startPrinting(t,this.getEventBreakpoints(i)),t.updateStyles()):!i.matches&&this.isPrinting&&!this.isPrintingBeforeAfterEvent&&(this.stopPrinting(t),t.updateStyles()):this.collectActivations(i)}}blockPropagation(){return t=>!(this.isPrinting||this.isPrintEvent(t))}startPrinting(t,i){this.isPrinting=!0,t.activatedBreakpoints=this.queue.addPrintBreakpoints(i)}stopPrinting(t){t.activatedBreakpoints=this.deactivations,this.deactivations=[],this.queue.clear(),this.isPrinting=!1}collectActivations(t){if(!this.isPrinting||this.isPrintingBeforeAfterEvent)if(t.matches)this.isPrintingBeforeAfterEvent||(this.deactivations=[]);else{const i=this.breakpoints.findByQuery(t.mediaQuery);i&&(this.deactivations.push(i),this.deactivations.sort(Xh))}}ngOnDestroy(){this._document.defaultView&&(this.beforePrintEventListeners.forEach(t=>this._document.defaultView.removeEventListener("beforeprint",t)),this.afterPrintEventListeners.forEach(t=>this._document.defaultView.removeEventListener("afterprint",t)))}}return r.\u0275fac=function(t){return new(t||r)(rt(Yh),rt(sa),rt(xn))},r.\u0275prov=St({factory:function(){return new r(rt(Yh),rt(sa),rt(xn))},token:r,providedIn:"root"}),r})();class S7{constructor(){this.printBreakpoints=[]}addPrintBreakpoints(e){return e.push(v7),e.sort(Xh),e.forEach(t=>this.addBreakpoint(t)),this.printBreakpoints}addBreakpoint(e){e&&void 0===this.printBreakpoints.find(i=>i.mediaQuery===e.mediaQuery)&&(this.printBreakpoints=function x7(r){return!!r&&r.mediaQuery.startsWith(lu)}(e)?[e,...this.printBreakpoints]:[...this.printBreakpoints,e])}clear(){this.printBreakpoints=[]}}function gN(r){for(let e in r){let t=r[e]||"";switch(e){case"display":r.display="flex"===t?["-webkit-flex","flex"]:"inline-flex"===t?["-webkit-inline-flex","inline-flex"]:t;break;case"align-items":case"align-self":case"align-content":case"flex":case"flex-basis":case"flex-flow":case"flex-grow":case"flex-shrink":case"flex-wrap":case"justify-content":r["-webkit-"+e]=t;break;case"flex-direction":t=t||"row",r["-webkit-flex-direction"]=t,r["flex-direction"]=t;break;case"order":r.order=r["-webkit-"+e]=isNaN(+t)?"0":t}}return r}let en=(()=>{class r{constructor(t,i,n,s){this._serverStylesheet=t,this._serverModuleLoaded=i,this._platformId=n,this.layoutConfig=s}applyStyleToElement(t,i,n=null){let s={};"string"==typeof i&&(s[i]=n,i=s),s=this.layoutConfig.disableVendorPrefixes?i:gN(i),this._applyMultiValueStyleToElement(s,t)}applyStyleToElements(t,i=[]){const n=this.layoutConfig.disableVendorPrefixes?t:gN(t);i.forEach(s=>{this._applyMultiValueStyleToElement(n,s)})}getFlowDirection(t){const i="flex-direction";let n=this.lookupStyle(t,i);return[n||"row",this.lookupInlineStyle(t,i)||Cc(this._platformId)&&this._serverModuleLoaded?n:""]}hasWrap(t){return"wrap"===this.lookupStyle(t,"flex-wrap")}lookupAttributeValue(t,i){return t.getAttribute(i)||""}lookupInlineStyle(t,i){return ja(this._platformId)?t.style.getPropertyValue(i):this._getServerStyle(t,i)}lookupStyle(t,i,n=!1){let s="";return t&&((s=this.lookupInlineStyle(t,i))||(ja(this._platformId)?n||(s=getComputedStyle(t).getPropertyValue(i)):this._serverModuleLoaded&&(s=this._serverStylesheet.getStyleForElement(t,i)))),s?s.trim():""}_applyMultiValueStyleToElement(t,i){Object.keys(t).sort().forEach(n=>{const s=t[n],a=Array.isArray(s)?s:[s];a.sort();for(let o of a)o=o?o+"":"",ja(this._platformId)||!this._serverModuleLoaded?ja(this._platformId)?i.style.setProperty(n,o):this._setServerStyle(i,n,o):this._serverStylesheet.addStyleToElement(i,n,o)})}_setServerStyle(t,i,n){i=i.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();const s=this._readStyleAttribute(t);s[i]=n||"",this._writeStyleAttribute(t,s)}_getServerStyle(t,i){return this._readStyleAttribute(t)[i]||""}_readStyleAttribute(t){const i={},n=t.getAttribute("style");if(n){const s=n.split(/;+/g);for(let a=0;a<s.length;a++){const o=s[a].trim();if(o.length>0){const l=o.indexOf(":");if(-1===l)throw new Error(`Invalid CSS style: ${o}`);i[o.substr(0,l).trim()]=o.substr(l+1).trim()}}}return i}_writeStyleAttribute(t,i){let n="";for(const s in i)i[s]&&(n+=s+":"+i[s]+";");t.setAttribute("style",n)}}return r.\u0275fac=function(t){return new(t||r)(rt(nN),rt(Bl),rt(Gr),rt(sa))},r.\u0275prov=St({factory:function(){return new r(rt(nN),rt(Bl),rt(Gr),rt(sa))},token:r,providedIn:"root"}),r})();class Mn{constructor(){this.shouldCache=!0}sideEffect(e,t,i){}}let pn=(()=>{class r{constructor(t,i,n){this.matchMedia=t,this.breakpoints=i,this.hook=n,this.activatedBreakpoints=[],this.elementMap=new Map,this.elementKeyMap=new WeakMap,this.watcherMap=new WeakMap,this.updateMap=new WeakMap,this.clearMap=new WeakMap,this.subject=new he.xQ,this.observeActivations()}get activatedAlias(){return this.activatedBreakpoints[0]?this.activatedBreakpoints[0].alias:""}onMediaChange(t){const i=this.findByQuery(t.mediaQuery);i&&((t=rN(t,i)).matches&&-1===this.activatedBreakpoints.indexOf(i)?(this.activatedBreakpoints.push(i),this.activatedBreakpoints.sort(Xh),this.updateStyles()):!t.matches&&-1!==this.activatedBreakpoints.indexOf(i)&&(this.activatedBreakpoints.splice(this.activatedBreakpoints.indexOf(i),1),this.activatedBreakpoints.sort(Xh),this.updateStyles()))}init(t,i,n,s,a=[]){TN(this.updateMap,t,i,n),TN(this.clearMap,t,i,s),this.buildElementKeyMap(t,i),this.watchExtraTriggers(t,i,a)}getValue(t,i,n){const s=this.elementMap.get(t);if(s){const a=void 0!==n?s.get(n):this.getActivatedValues(s,i);if(a)return a.get(i)}}hasValue(t,i){const n=this.elementMap.get(t);if(n){const s=this.getActivatedValues(n,i);if(s)return void 0!==s.get(i)||!1}return!1}setValue(t,i,n,s){let a=this.elementMap.get(t);if(a){const l=(a.get(s)||new Map).set(i,n);a.set(s,l),this.elementMap.set(t,a)}else a=(new Map).set(s,(new Map).set(i,n)),this.elementMap.set(t,a);const o=this.getValue(t,i);void 0!==o&&this.updateElement(t,i,o)}trackValue(t,i){return this.subject.asObservable().pipe((0,js.h)(n=>n.element===t&&n.key===i))}updateStyles(){this.elementMap.forEach((t,i)=>{const n=new Set(this.elementKeyMap.get(i));let s=this.getActivatedValues(t);s&&s.forEach((a,o)=>{this.updateElement(i,o,a),n.delete(o)}),n.forEach(a=>{if(s=this.getActivatedValues(t,a),s){const o=s.get(a);this.updateElement(i,a,o)}else this.clearElement(i,a)})})}clearElement(t,i){const n=this.clearMap.get(t);if(n){const s=n.get(i);s&&(s(),this.subject.next({element:t,key:i,value:""}))}}updateElement(t,i,n){const s=this.updateMap.get(t);if(s){const a=s.get(i);a&&(a(n),this.subject.next({element:t,key:i,value:n}))}}releaseElement(t){const i=this.watcherMap.get(t);i&&(i.forEach(s=>s.unsubscribe()),this.watcherMap.delete(t));const n=this.elementMap.get(t);n&&(n.forEach((s,a)=>n.delete(a)),this.elementMap.delete(t))}triggerUpdate(t,i){const n=this.elementMap.get(t);if(n){const s=this.getActivatedValues(n,i);s&&(i?this.updateElement(t,i,s.get(i)):s.forEach((a,o)=>this.updateElement(t,o,a)))}}buildElementKeyMap(t,i){let n=this.elementKeyMap.get(t);n||(n=new Set,this.elementKeyMap.set(t,n)),n.add(i)}watchExtraTriggers(t,i,n){if(n&&n.length){let s=this.watcherMap.get(t);if(s||(s=new Map,this.watcherMap.set(t,s)),!s.get(i)){const o=(0,ve.T)(...n).subscribe(()=>{const l=this.getValue(t,i);this.updateElement(t,i,l)});s.set(i,o)}}}findByQuery(t){return this.breakpoints.findByQuery(t)}getActivatedValues(t,i){for(let s=0;s<this.activatedBreakpoints.length;s++){const o=t.get(this.activatedBreakpoints[s].alias);if(o&&(void 0===i||o.has(i)&&null!=o.get(i)))return o}const n=t.get("");return void 0===i||n&&n.has(i)?n:void 0}observeActivations(){const i=this.breakpoints.items.map(n=>n.mediaQuery);this.matchMedia.observe(this.hook.withPrintQuery(i)).pipe(Mo(this.hook.interceptEvents(this)),(0,js.h)(this.hook.blockPropagation())).subscribe(this.onMediaChange.bind(this))}}return r.\u0275fac=function(t){return new(t||r)(rt(Lp),rt(Yh),rt(pN))},r.\u0275prov=St({factory:function(){return new r(rt(Lp),rt(Yh),rt(pN))},token:r,providedIn:"root"}),r})();function TN(r,e,t,i){if(void 0!==i){let n=r.get(e);n||(n=new Map,r.set(e,n)),n.set(t,i)}}let I7=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({}),r})();const QE="inline",Bp=["row","column","row-reverse","column-reverse"];function vN(r){r=r?r.toLowerCase():"";let[e,t,i]=r.split(" ");return Bp.find(n=>n===e)||(e=Bp[0]),t===QE&&(t=i!==QE?i:"",i=QE),[e,M7(t),!!i]}function jh(r){let[e]=vN(r);return e.indexOf("row")>-1}function M7(r){if(r)switch(r.toLowerCase()){case"reverse":case"wrap-reverse":case"reverse-wrap":r="wrap-reverse";break;case"no":case"none":case"nowrap":r="nowrap";break;default:r="wrap"}return r}let P7=(()=>{class r extends Mn{buildStyles(t){return function R7(r){let[e,t,i]=vN(r);return function D7(r,e=null,t=!1){return{display:t?"inline-flex":"flex","box-sizing":"border-box","flex-direction":r,"flex-wrap":e||null}}(e,t,i)}(t)}}return r.\u0275fac=function(){let e;return function(i){return(e||(e=Jt(r)))(i||r)}}(),r.\u0275prov=St({factory:function(){return new r},token:r,providedIn:"root"}),r})();const w7=["fxLayout","fxLayout.xs","fxLayout.sm","fxLayout.md","fxLayout.lg","fxLayout.xl","fxLayout.lt-sm","fxLayout.lt-md","fxLayout.lt-lg","fxLayout.lt-xl","fxLayout.gt-xs","fxLayout.gt-sm","fxLayout.gt-md","fxLayout.gt-lg"];let O7=(()=>{class r extends fn{constructor(t,i,n,s){super(t,n,i,s),this.DIRECTIVE_KEY="layout",this.styleCache=F7,this.init()}}return r.\u0275fac=function(t){return new(t||r)(de(Ii),de(en),de(P7),de(pn))},r.\u0275dir=Tt({type:r,features:[Vt]}),r})(),ZE=(()=>{class r extends O7{constructor(){super(...arguments),this.inputs=w7}}return r.\u0275fac=function(){let e;return function(i){return(e||(e=Jt(r)))(i||r)}}(),r.\u0275dir=Tt({type:r,selectors:[["","fxLayout",""],["","fxLayout.xs",""],["","fxLayout.sm",""],["","fxLayout.md",""],["","fxLayout.lg",""],["","fxLayout.xl",""],["","fxLayout.lt-sm",""],["","fxLayout.lt-md",""],["","fxLayout.lt-lg",""],["","fxLayout.lt-xl",""],["","fxLayout.gt-xs",""],["","fxLayout.gt-sm",""],["","fxLayout.gt-md",""],["","fxLayout.gt-lg",""]],inputs:{fxLayout:"fxLayout","fxLayout.xs":"fxLayout.xs","fxLayout.sm":"fxLayout.sm","fxLayout.md":"fxLayout.md","fxLayout.lg":"fxLayout.lg","fxLayout.xl":"fxLayout.xl","fxLayout.lt-sm":"fxLayout.lt-sm","fxLayout.lt-md":"fxLayout.lt-md","fxLayout.lt-lg":"fxLayout.lt-lg","fxLayout.lt-xl":"fxLayout.lt-xl","fxLayout.gt-xs":"fxLayout.gt-xs","fxLayout.gt-sm":"fxLayout.gt-sm","fxLayout.gt-md":"fxLayout.gt-md","fxLayout.gt-lg":"fxLayout.gt-lg"},features:[Vt]}),r})();const F7=new Map;let xY=(()=>{class r extends Mn{buildStyles(t,i){const n={},[s,a]=t.split(" ");switch(s){case"center":n["justify-content"]="center";break;case"space-around":n["justify-content"]="space-around";break;case"space-between":n["justify-content"]="space-between";break;case"space-evenly":n["justify-content"]="space-evenly";break;case"end":case"flex-end":n["justify-content"]="flex-end";break;default:n["justify-content"]="flex-start"}switch(a){case"start":case"flex-start":n["align-items"]=n["align-content"]="flex-start";break;case"center":n["align-items"]=n["align-content"]="center";break;case"end":case"flex-end":n["align-items"]=n["align-content"]="flex-end";break;case"space-between":n["align-content"]="space-between",n["align-items"]="stretch";break;case"space-around":n["align-content"]="space-around",n["align-items"]="stretch";break;case"baseline":n["align-content"]="stretch",n["align-items"]="baseline";break;default:n["align-items"]=n["align-content"]="stretch"}return function $o(r,...e){if(null==r)throw TypeError("Cannot convert undefined or null to object");for(let t of e)if(null!=t)for(let i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);return r}(n,{display:i.inline?"inline-flex":"flex","flex-direction":i.layout,"box-sizing":"border-box","max-width":"stretch"===a?jh(i.layout)?null:"100%":null,"max-height":"stretch"===a&&jh(i.layout)?"100%":null})}}return r.\u0275fac=function(){let e;return function(i){return(e||(e=Jt(r)))(i||r)}}(),r.\u0275prov=St({factory:function(){return new r},token:r,providedIn:"root"}),r})();const AY=["fxLayoutAlign","fxLayoutAlign.xs","fxLayoutAlign.sm","fxLayoutAlign.md","fxLayoutAlign.lg","fxLayoutAlign.xl","fxLayoutAlign.lt-sm","fxLayoutAlign.lt-md","fxLayoutAlign.lt-lg","fxLayoutAlign.lt-xl","fxLayoutAlign.gt-xs","fxLayoutAlign.gt-sm","fxLayoutAlign.gt-md","fxLayoutAlign.gt-lg"];let yY=(()=>{class r extends fn{constructor(t,i,n,s){super(t,n,i,s),this.DIRECTIVE_KEY="layout-align",this.layout="row",this.inline=!1,this.init(),this.marshal.trackValue(this.nativeElement,"layout").pipe(ns(this.destroySubject)).subscribe(this.onLayoutChange.bind(this))}updateWithValue(t){const i=this.layout||"row",n=this.inline;"row"===i&&n?this.styleCache=MY:"row"!==i||n?"row-reverse"===i&&n?this.styleCache=PY:"row-reverse"!==i||n?"column"===i&&n?this.styleCache=DY:"column"!==i||n?"column-reverse"===i&&n?this.styleCache=wY:"column-reverse"===i&&!n&&(this.styleCache=RY):this.styleCache=CY:this.styleCache=IY:this.styleCache=bY,this.addStyles(t,{layout:i,inline:n})}onLayoutChange(t){const i=t.value.split(" ");this.layout=i[0],this.inline=t.value.includes("inline"),Bp.find(n=>n===this.layout)||(this.layout="row"),this.triggerUpdate()}}return r.\u0275fac=function(t){return new(t||r)(de(Ii),de(en),de(xY),de(pn))},r.\u0275dir=Tt({type:r,features:[Vt]}),r})(),qE=(()=>{class r extends yY{constructor(){super(...arguments),this.inputs=AY}}return r.\u0275fac=function(){let e;return function(i){return(e||(e=Jt(r)))(i||r)}}(),r.\u0275dir=Tt({type:r,selectors:[["","fxLayoutAlign",""],["","fxLayoutAlign.xs",""],["","fxLayoutAlign.sm",""],["","fxLayoutAlign.md",""],["","fxLayoutAlign.lg",""],["","fxLayoutAlign.xl",""],["","fxLayoutAlign.lt-sm",""],["","fxLayoutAlign.lt-md",""],["","fxLayoutAlign.lt-lg",""],["","fxLayoutAlign.lt-xl",""],["","fxLayoutAlign.gt-xs",""],["","fxLayoutAlign.gt-sm",""],["","fxLayoutAlign.gt-md",""],["","fxLayoutAlign.gt-lg",""]],inputs:{fxLayoutAlign:"fxLayoutAlign","fxLayoutAlign.xs":"fxLayoutAlign.xs","fxLayoutAlign.sm":"fxLayoutAlign.sm","fxLayoutAlign.md":"fxLayoutAlign.md","fxLayoutAlign.lg":"fxLayoutAlign.lg","fxLayoutAlign.xl":"fxLayoutAlign.xl","fxLayoutAlign.lt-sm":"fxLayoutAlign.lt-sm","fxLayoutAlign.lt-md":"fxLayoutAlign.lt-md","fxLayoutAlign.lt-lg":"fxLayoutAlign.lt-lg","fxLayoutAlign.lt-xl":"fxLayoutAlign.lt-xl","fxLayoutAlign.gt-xs":"fxLayoutAlign.gt-xs","fxLayoutAlign.gt-sm":"fxLayoutAlign.gt-sm","fxLayoutAlign.gt-md":"fxLayoutAlign.gt-md","fxLayoutAlign.gt-lg":"fxLayoutAlign.gt-lg"},features:[Vt]}),r})();const bY=new Map,CY=new Map,IY=new Map,RY=new Map,MY=new Map,DY=new Map,PY=new Map,wY=new Map;let AN=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({imports:[[YE,I7]]}),r})();class OY{constructor(e,t){this._document=t;const i=this._textarea=this._document.createElement("textarea"),n=i.style;n.position="fixed",n.top=n.opacity="0",n.left="-999em",i.setAttribute("aria-hidden","true"),i.value=e,this._document.body.appendChild(i)}copy(){const e=this._textarea;let t=!1;try{if(e){const i=this._document.activeElement;e.select(),e.setSelectionRange(0,e.value.length),t=this._document.execCommand("copy"),i&&i.focus()}}catch(i){}return t}destroy(){const e=this._textarea;e&&(e.remove(),this._textarea=void 0)}}let FY=(()=>{class r{constructor(t){this._document=t}copy(t){const i=this.beginCopy(t),n=i.copy();return i.destroy(),n}beginCopy(t){return new OY(t,this._document)}}return r.\u0275fac=function(t){return new(t||r)(rt(xn))},r.\u0275prov=St({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const NY=new oi("CDK_COPY_TO_CLIPBOARD_CONFIG");let LY=(()=>{class r{constructor(t,i,n){this._clipboard=t,this._ngZone=i,this.text="",this.attempts=1,this.copied=new is,this._pending=new Set,n&&null!=n.attempts&&(this.attempts=n.attempts)}copy(t=this.attempts){if(t>1){let i=t;const n=this._clipboard.beginCopy(this.text);this._pending.add(n);const s=()=>{const a=n.copy();a||!--i||this._destroyed?(this._currentTimeout=null,this._pending.delete(n),n.destroy(),this.copied.emit(a)):this._currentTimeout=this._ngZone.runOutsideAngular(()=>setTimeout(s,1))};s()}else this.copied.emit(this._clipboard.copy(this.text))}ngOnDestroy(){this._currentTimeout&&clearTimeout(this._currentTimeout),this._pending.forEach(t=>t.destroy()),this._pending.clear(),this._destroyed=!0}}return r.\u0275fac=function(t){return new(t||r)(de(FY),de(Pn),de(NY,8))},r.\u0275dir=Tt({type:r,selectors:[["","cdkCopyToClipboard",""]],hostBindings:function(t,i){1&t&&Gu("click",function(){return i.copy()})},inputs:{text:["cdkCopyToClipboard","text"],attempts:["cdkCopyToClipboardAttempts","attempts"]},outputs:{copied:"cdkCopyToClipboardCopied"}}),r})(),BY=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({}),r})(),UY=(()=>{class r{constructor(t,i){this.el=t,this.renderer=i,this.isClickable=!0}ngOnChanges(t){this.isClickable?(this.renderer.setStyle(this.el.nativeElement,"cursor","pointer"),this.renderer.setStyle(this.el.nativeElement,"outline",0)):(this.renderer.removeStyle(this.el.nativeElement,"cursor"),this.renderer.removeStyle(this.el.nativeElement,"outline"))}}return r.\u0275fac=function(t){return new(t||r)(de(Ii),de(ju))},r.\u0275dir=Tt({type:r,selectors:[["","appClickable",""]],inputs:{isClickable:["appClickable","isClickable"]},features:[il]}),r})(),VY=(()=>{class r{constructor(t){this.hostElement=t,this.appClickOutside=new is,this.clickOutsideIncludeNodeList=[],this.clickOutsideIncludeIdList=[],this.clickOutsideIncludeClassList=[],this.clickOutsideIgnoreFirstNoOfClicks=0,this.noOfClicks=0}ngAfterViewInit(){this.click$=(0,Ic.R)(document,"click"),this.click$.pipe(Mo(()=>this.noOfClicks++),(0,js.h)(()=>this.noOfClicks>=this.clickOutsideIgnoreFirstNoOfClicks+1),(0,Ir.U)(t=>t.composedPath()),(0,js.h)(t=>{const i=this.hostElement.nativeElement;for(const n of t){if(n===i)return!1;if(this.clickOutsideIncludeNodeList.length>0){const s=n.nodeName;if(void 0!==s&&-1!==this.clickOutsideIncludeNodeList.findIndex(a=>a.toLowerCase()===s.toLowerCase()))return!1}if(this.clickOutsideIncludeIdList.length>0){const s=n.id;if(void 0!==s&&-1!==this.clickOutsideIncludeIdList.findIndex(a=>a.toLowerCase()===s.toLowerCase()))return!1}if(this.clickOutsideIncludeClassList.length>0){const s=n.classList;if(void 0!==s)for(const a of this.clickOutsideIncludeClassList)if(s.contains(a))return!1}}return!0})).subscribe(()=>this.appClickOutside.emit())}}return r.\u0275fac=function(t){return new(t||r)(de(Ii))},r.\u0275dir=Tt({type:r,selectors:[["","appClickOutside",""]],inputs:{clickOutsideIncludeNodeList:"clickOutsideIncludeNodeList",clickOutsideIncludeIdList:"clickOutsideIncludeIdList",clickOutsideIncludeClassList:"clickOutsideIncludeClassList",clickOutsideIgnoreFirstNoOfClicks:"clickOutsideIgnoreFirstNoOfClicks"},outputs:{appClickOutside:"appClickOutside"}}),r})();function kY(r,e){return{type:7,name:r,definitions:e,options:{}}}function yN(r,e=null){return{type:4,styles:e,timings:r}}function bN(r){return{type:6,styles:r,offset:null}}function CN(r,e,t){return{type:0,name:r,styles:e,options:t}}function IN(r,e,t=null){return{type:1,expr:r,animation:e,options:t}}const GY=[{name:"AngularFirestore-deep",description:"Simplify the work with complex and deep objects while retaining all the great benefits from Firebase Firestore.",language:"Typescript",githubUrl:"https://github.com/Tylder/angularfirestore-deep"},{name:"AngularFireStorage-wrapper",description:"Angular class which wraps AngularFire Storage and provides methods to upload multiple files simultaneously while keeping track of their progress.",language:"Typescript",githubUrl:"https://github.com/Tylder/AngularFireStorage-wrapper"},{name:"Portfolio 3d (this site)",description:"Portfolio site to display projects and an excuse to make a site in 3d",language:"Angular / Typescript",githubUrl:"https://github.com/Tylder/portfolio3d"},{name:"ngx-long-click",description:"Angular directive for detecting long clicks of an element in Angular 2 and up.",language:"Typescript",githubUrl:"https://github.com/Tylder/ngx-long-click"}];let HY=(()=>{class r{constructor(){}ngAfterContentInit(){console.log(this.project)}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=mo({type:r,selectors:[["app-sub-project"]],inputs:{project:"project"},decls:9,vars:5,consts:[[1,"wrapper"],[1,"language"],[3,"href"]],template:function(t,i){1&t&&(yr(0,"div",0)(1,"h2"),Ea(2),kr(),yr(3,"span",1),Ea(4),kr(),yr(5,"p"),Ea(6),kr(),yr(7,"a",2),Ea(8),kr()()),2&t&&(ur(2),ll(i.project.name),ur(2),ll(i.project.language),ur(2),ll(i.project.description),ur(1),ys("href",i.project.githubUrl,Qg),ur(1),ll(i.project.githubUrl))},styles:[".wrapper[_ngcontent-%COMP%]{padding-top:1em;padding-bottom:2em}h2[_ngcontent-%COMP%]{color:#fff;font-family:Roboto,sans-serif;font-size:1.4em;display:inline}.language[_ngcontent-%COMP%]{margin-left:1em;font-style:italic;color:#fff;font-family:Roboto,sans-serif;font-size:1em}p[_ngcontent-%COMP%], a[_ngcontent-%COMP%]{color:#fff;font-family:Roboto,sans-serif;font-size:1em}a[_ngcontent-%COMP%]{color:#c3ffff;text-decoration:none}"]}),r})();function zY(r,e){1&r&&yo(0,"app-sub-project",4),2&r&&ys("project",e.$implicit)}let WY=(()=>{class r{constructor(t){this.camService=t,this.projects=GY}goBackToMain(){this.camService.moveBaseCameraPositionName("main")}ngOnInit(){}}return r.\u0275fac=function(t){return new(t||r)(de(tN))},r.\u0275cmp=mo({type:r,selectors:[["app-projects"]],decls:7,vars:1,consts:[["fxLayout","row","fxLayoutAlign","center center",1,"wrapper",3,"click"],[1,"container"],[1,"exit"],[3,"project",4,"ngFor","ngForOf"],[3,"project"]],template:function(t,i){1&t&&(yr(0,"div",0),Gu("click",function(){return i.goBackToMain()}),yr(1,"div",1)(2,"h1"),Ea(3,"Projects"),kr(),yr(4,"span",2),Ea(5,"(Click to go back)"),kr(),ol(6,zY,1,1,"app-sub-project",3),kr()()),2&t&&(ur(6),ys("ngForOf",i.projects))},directives:[ZE,qE,eb,HY],styles:[".wrapper[_ngcontent-%COMP%]{height:100%;width:100%;overflow:auto;padding:20px}.container[_ngcontent-%COMP%]{max-height:100%}h1[_ngcontent-%COMP%]{color:#fff;font-family:Roboto,sans-serif;font-size:1.6em;display:inline}.exit[_ngcontent-%COMP%]{margin-left:.8em;font-style:italic;color:#fff;font-family:Roboto,sans-serif;font-size:.8em}"],data:{animation:[kY("showProjects",[CN("show",bN({height:"200px",opacity:1})),CN("hide",bN({height:"100px",opacity:.8})),IN("* => show",[yN("0.5s")]),IN("* => hide",[yN("1s")])])]}}),r})();const XY=["rCanvas"];function YY(r,e){if(1&r&&(yr(0,"div",8)(1,"p"),Ea(2),kr()()),2&r){const t=e.ngIf;ur(2),ll(t)}}function jY(r,e){1&r&&yo(0,"div",9)}function $Y(r,e){if(1&r){const t=function hA(){return Ge()}();yr(0,"div",10)(1,"div",11),Gu("appClickOutside",function(){return function Av(r){return $t.lFrame.contextLView=r,r[8]}(t),Vd().closeEmailOverlay()}),yo(2,"img",12),yr(3,"p"),Ea(4,"Click to copy to clipboard"),kr()()()}if(2&r){const t=Vd();ur(1),ys("cdkCopyToClipboard",t.getEmailAddress())("appClickable",!0)("clickOutsideIgnoreFirstNoOfClicks",1),ur(1),ys("alt",t.getEmailAddress())}}function KY(r,e){if(1&r&&(yr(0,"div",13)(1,"p",14),Ea(2),ul(3,"number"),kr()()),2&r){const t=Vd();ur(2),Gd("FPS: ",function Xy(r,e,t,i){const n=r+20,s=Ge(),a=zl(s,n);return Qu(s,n)?Gy(s,Sr(),e,a.transform,t,i,a):a.transform(t,i)}(3,1,t.babylonSceneService.engine.getFps(),"1.2-2"),"")}}function QY(r,e){1&r&&yo(0,"app-projects",15)}let ZY=(()=>{class r{constructor(t,i,n,s){this.doc=t,this.ngZone=i,this.babylonSceneService=n,this.camService=s,this.spaceBarPressedEvent$=(0,Ic.R)(document.body,"keydown").pipe((0,js.h)(a=>"Space"===a.code)),this.pKeyPressedEvent$=(0,Ic.R)(document.body,"keydown").pipe((0,js.h)(a=>"KeyP"===a.code)),this.isShowBackdrop$=new Io.X(!1),this.isShowEmail$=new Io.X(!1),this.hintText$=new ah.t(1),this.isShowFps$=new Io.X(!1),this.destroy$=new he.xQ,this.clickEvent$=(0,Ic.R)(document.body,"click").pipe(function GH(...r){return e=>{let t;return"function"==typeof r[r.length-1]&&(t=r.pop()),e.lift(new HH(r,t))}}(this.isShowBackdrop$),(0,js.h)(([a,o])=>!o),(0,Ir.U)(([a,o])=>a),Mo(a=>console.log(a))),this.isShowBackdrop$.pipe(ns(this.destroy$),(0,js.h)(a=>a)).subscribe(()=>this.hintText$.next(null))}ngOnDestroy(){this.destroy$.next()}ngAfterViewInit(){this.babylonSceneService.createScene$(this.canvasRef).pipe(Wm(1)).subscribe(t=>{this.camService.camera=this.babylonSceneService.camera,this.camService.cameraBasePos$.next(this.babylonSceneService.cameraMainPos),this.camService.cameraPositions.push({name:"main",pos:this.babylonSceneService.cameraMainPos},{name:"projects",pos:this.babylonSceneService.cameraProjectsPos}),this.createAndListenForSceneActions(t),this.createFanAnimations(t),this.create24HrsOpenAnimation(t),this.babylonSceneService.start(this.ngZone,!0),this.camService.currentCameraPos$.pipe(ns(this.destroy$),Mo(i=>{this.isShowBackdrop$.next("main"!=i.name)})).subscribe()})}isTouchScreenDevice(){return"ontouchstart"in window||null!=navigator.maxTouchPoints&&navigator.maxTouchPoints>0}getEmailAddress(){return"lofgrendaniel@hotmail.com"}closeEmailOverlay(){this.isShowBackdrop$.next(!1),this.isShowEmail$.next(!1)}createFanAnimations(t){const i=t.getNodeByName("CeilingFan"),n=t.getNodeByName("CeilingFan1"),s=i.getChildren(d=>"FanHolder"===d.name)[0],a=n.getChildren(d=>"FanHolder"===d.name)[0];s.rotationQuaternion=null,a.rotationQuaternion=null;const l=new Me("fan0Rotate","rotation.y",10,Me.ANIMATIONTYPE_FLOAT,Me.ANIMATIONLOOPMODE_CYCLE),c=new Me("fan1Rotate","rotation.y",10,Me.ANIMATIONTYPE_FLOAT,Me.ANIMATIONLOOPMODE_CYCLE),u=[{frame:0,value:0},{frame:20,value:Math.PI/180*60}],h=[{frame:0,value:0},{frame:13,value:Math.PI/180*60}];l.setKeys(u),c.setKeys(h),s.animations.push(l),a.animations.push(c),t.beginAnimation(s,0,20,!0),t.beginAnimation(a,0,13,!0)}create24HrsOpenAnimation(t){const i=t.getNodeByName("text_hrs"),n=new Fe(0,1,.1),a=new Me("textHrs_flicker","material.emissiveColor",20,Me.ANIMATIONTYPE_COLOR3,Me.ANIMATIONLOOPMODE_CYCLE),o=[{frame:0,value:n},{frame:20,value:n},{frame:21,value:new Fe(0,0,0)},{frame:22,value:n},{frame:25,value:n},{frame:26,value:new Fe(0,0,0)},{frame:30,value:new Fe(0,0,0)},{frame:31,value:n},{frame:32,value:new Fe(0,0,0)},{frame:40,value:new Fe(0,0,0)},{frame:41,value:n},{frame:200,value:n}];a.enableBlending=!1,a.blendingSpeed=1,a.setKeys(o),i.animations.push(a),t.beginAnimation(i,0,200,!0)}createAndListenForSceneActions(t){this.spaceBarPressedEvent$.pipe(ns(this.destroy$)).subscribe(()=>this.toggleAllLights()),this.pKeyPressedEvent$.pipe(ns(this.destroy$)).subscribe(()=>this.isShowFps$.next(!this.isShowFps$.value)),this.babylonSceneService.registerHover(this.babylonSceneService.topTVCollision,!1,()=>this.hintText$.next("Press to open my Github")),this.babylonSceneService.registerHover(this.babylonSceneService.middleTVCollision,!1,()=>this.hintText$.next("Press to see my email address")),this.babylonSceneService.registerHover(this.babylonSceneService.bottomTVCollision,!1,()=>this.hintText$.next("Press to go my projects")),this.babylonSceneService.registerEndHover(this.babylonSceneService.topTVCollision,!1,()=>this.hintText$.next(null)),this.babylonSceneService.registerEndHover(this.babylonSceneService.middleTVCollision,!1,()=>this.hintText$.next(null)),this.babylonSceneService.registerEndHover(this.babylonSceneService.bottomTVCollision,!1,()=>this.hintText$.next(null)),this.tvClicked$=this.clickEvent$.pipe(ns(this.destroy$),(0,Ir.U)(()=>t.pick(t.pointerX,t.pointerY,i=>this.getTopMeshParent(i).name.includes("TV"))),Rb(),(0,Ir.U)(i=>i.pickedMesh),Rb(),(0,Ir.U)(i=>this.getTopMeshParent(i))),this.handleTVClicks(),this.isTouchScreenDevice()?this.camService.moveCameraByDeviceMotion():this.camService.moveCameraByMousePos(),t.registerBeforeRender(()=>{})}handleTVClicks(){this.tvClicked$.subscribe(t=>{switch(t.name){case"TV2":window.open("https://github.com/tylder","_blank");break;case"TV1":this.isShowEmail$.next(!0),this.isShowBackdrop$.next(!0);break;case"TV":console.log("TV"),this.hintText$.next(null),this.camService.moveBaseCameraPositionName("projects")}})}getTopMeshParent(t){return null!=t.parent?null!=t.parent.parent?this.getTopMeshParent(t.parent):t.parent:t}toggleAllLights(){this.babylonSceneService.scene.lights.forEach(t=>{t.setEnabled(!t.isEnabled())})}}return r.\u0275fac=function(t){return new(t||r)(de(xn),de(Pn),de(N8),de(tN))},r.\u0275cmp=mo({type:r,selectors:[["app-main"]],viewQuery:function(t,i){if(1&t&&qy(XY,7),2&t){let n;Zy(n=function Jy(){return function ok(r,e){return r[19].queries[e].queryList}(Ge(),Iv())}())&&(i.canvasRef=n.first)}},decls:13,vars:15,consts:[[1,"wrapper"],["id","rCanvas"],["rCanvas",""],["class","hint-overlay","fxLayout","row","fxLayoutAlign","center center",4,"ngIf"],["class","backdrop",4,"ngIf"],["class","fullpage-container","fxLayout","row","fxLayoutAlign","center center",4,"ngIf"],["fxLayout","row","fxLayoutAlign","end end","class","fullpage-container",4,"ngIf"],["class","fullpage-container",4,"ngIf"],["fxLayout","row","fxLayoutAlign","center center",1,"hint-overlay"],[1,"backdrop"],["fxLayout","row","fxLayoutAlign","center center",1,"fullpage-container"],["fxLayout","column","fxLayoutAlign","center center",1,"email-overlay",3,"cdkCopyToClipboard","appClickable","clickOutsideIgnoreFirstNoOfClicks","appClickOutside"],["src","assets/images/email_white.png",3,"alt"],["fxLayout","row","fxLayoutAlign","end end",1,"fullpage-container"],[1,"fpsLabel"],[1,"fullpage-container"]],template:function(t,i){if(1&t&&(yr(0,"div",0),yo(1,"canvas",1,2),ol(3,YY,3,1,"div",3),ul(4,"async"),ol(5,jY,1,0,"div",4),ul(6,"async"),ol(7,$Y,5,4,"div",5),ul(8,"async"),ol(9,KY,4,4,"div",6),ul(10,"async"),ol(11,QY,1,0,"app-projects",7),ul(12,"async"),kr()),2&t){let n;ur(3),ys("ngIf",yc(4,5,i.hintText$)),ur(2),ys("ngIf",yc(6,7,i.isShowBackdrop$)),ur(2),ys("ngIf",yc(8,9,i.isShowEmail$)),ur(2),ys("ngIf",yc(10,11,i.isShowFps$)),ur(2),ys("ngIf","projects"===(null==(n=yc(12,13,i.camService.currentCameraPos$))?null:n.name))}},directives:[ib,ZE,qE,LY,UY,VY,WY],pipes:[ub,db],styles:["[_nghost-%COMP%]{width:100%;height:100%}.wrapper[_ngcontent-%COMP%]{height:100%;width:100%;position:fixed;top:0;left:0;z-index:-99}.backdrop[_ngcontent-%COMP%]{position:absolute;top:0;left:0;height:100vh;width:100vw;background-color:#150f09;opacity:25%}.fullpage-container[_ngcontent-%COMP%]{position:absolute;top:0;left:0;height:100vh;width:100vw}.email-overlay[_ngcontent-%COMP%]{padding:2vw}.email-overlay[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:100%}.email-overlay[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#fff;font-family:Roboto,sans-serif}.hint-overlay[_ngcontent-%COMP%]{position:absolute;bottom:5vh;width:100%;height:40px}.hint-overlay[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#fff;font-family:Roboto,sans-serif}.fpsLabel[_ngcontent-%COMP%]{padding:10px;color:#fff;font-family:Roboto,sans-serif}"]}),r})(),qY=(()=>{class r{constructor(){this.title="ng-web-portfolio"}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=mo({type:r,selectors:[["app-root"]],decls:1,vars:0,template:function(t,i){1&t&&yo(0,"app-main")},directives:[ZY],styles:[""]}),r})(),FN=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({imports:[[YE]]}),r})(),HN=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({imports:[[YE]]}),r})(),U$=(()=>{class r{constructor(t,i){Cc(i)&&!t&&console.warn("Warning: Flex Layout loaded on the server without FlexLayoutServerModule")}static withConfig(t,i=[]){return{ngModule:r,providers:t.serverLoaded?[{provide:sa,useValue:Object.assign(Object.assign({},jE),t)},{provide:$E,useValue:i,multi:!0},{provide:Bl,useValue:!0}]:[{provide:sa,useValue:Object.assign(Object.assign({},jE),t)},{provide:$E,useValue:i,multi:!0}]}}}return r.\u0275fac=function(t){return new(t||r)(rt(Bl),rt(Gr))},r.\u0275mod=Er({type:r}),r.\u0275inj=Lr({imports:[[AN,FN,HN],AN,FN,HN]}),r})(),V$=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=Er({type:r,bootstrap:[qY]}),r.\u0275inj=Lr({providers:[],imports:[[RH,U$,BY]]}),r})();(function jk(){O0=!1})(),CH().bootstrapModule(V$).catch(r=>console.error(r))},2289:(et,Ce,L)=>{et.exports={ResizeSensor:L(294),ElementQueries:L(3322)}},3322:function(et,Ce,L){"use strict";var xe,Pe;"undefined"!=typeof window&&window,xe=[L(294)],void 0!==(Pe=function(ve){var K=function(){var ce,Ae={},Le=[];function Te(ze){ze||(ze=document.documentElement);var Qe=window.getComputedStyle(ze,null).fontSize;return parseFloat(Qe)||16}function ie(ze,Qe){var Pt=Qe.split(/\d/),Et=Pt[Pt.length-1];switch(Qe=parseFloat(Qe),Et){case"px":default:return Qe;case"em":return Qe*Te(ze);case"rem":return Qe*Te();case"vw":return Qe*document.documentElement.clientWidth/100;case"vh":return Qe*document.documentElement.clientHeight/100;case"vmin":case"vmax":var pi=document.documentElement.clientWidth/100,tn=document.documentElement.clientHeight/100;return Qe*(0,Math["vmin"===Et?"min":"max"])(pi,tn)}}function q(ze,Qe){this.element=ze;var Pt,Et,pi,tn,Jn,gi,Un,ar,jn=["min-width","min-height","max-width","max-height"];this.call=function(){for(Pt in pi=function G(ze){if(!ze.getBoundingClientRect)return{width:ze.offsetWidth,height:ze.offsetHeight};var Qe=ze.getBoundingClientRect();return{width:Math.round(Qe.width),height:Math.round(Qe.height)}}(this.element),gi={},Ae[Qe])!Ae[Qe].hasOwnProperty(Pt)||(tn=ie(this.element,(Et=Ae[Qe][Pt]).value),Jn="width"===Et.property?pi.width:pi.height,Un="","min"===Et.mode&&Jn>=tn&&(Un+=Et.value),"max"===Et.mode&&Jn<=tn&&(Un+=Et.value),gi[ar=Et.mode+"-"+Et.property]||(gi[ar]=""),Un&&-1===(" "+gi[ar]+" ").indexOf(" "+Un+" ")&&(gi[ar]+=" "+Un));for(var Nr in jn)!jn.hasOwnProperty(Nr)||(gi[jn[Nr]]?this.element.setAttribute(jn[Nr],gi[jn[Nr]].substr(1)):this.element.removeAttribute(jn[Nr]))}}function we(ze,Qe){ze.elementQueriesSetupInformation||(ze.elementQueriesSetupInformation=new q(ze,Qe)),ze.elementQueriesSensor||(ze.elementQueriesSensor=new ve(ze,function(){ze.elementQueriesSetupInformation.call()}))}function Ee(ze,Qe,Pt,Et){if(void 0===Ae[ze]){Ae[ze]=[];var pi=Le.length;ce.innerHTML+="\n"+ze+" {animation: 0.1s element-queries;}",ce.innerHTML+="\n"+ze+" > .resize-sensor {min-width: "+pi+"px;}",Le.push(ze)}Ae[ze].push({mode:Qe,property:Pt,value:Et})}function pe(ze){var Qe;if(document.querySelectorAll&&(Qe=ze?ze.querySelectorAll.bind(ze):document.querySelectorAll.bind(document)),!Qe&&"undefined"!=typeof $$&&(Qe=$$),!Qe&&"undefined"!=typeof jQuery&&(Qe=jQuery),!Qe)throw"No document.querySelectorAll, jQuery or Mootools's $$ found.";return Qe}function _t(ze){var Qe=[],Pt=[],Et=[],pi=0,tn=-1,Jn=[];for(var gi in ze.children)if(ze.children.hasOwnProperty(gi)&&ze.children[gi].tagName&&"img"===ze.children[gi].tagName.toLowerCase()){Qe.push(ze.children[gi]);var Un=ze.children[gi].getAttribute("min-width")||ze.children[gi].getAttribute("data-min-width"),ar=ze.children[gi].getAttribute("data-src")||ze.children[gi].getAttribute("url");Et.push(ar),Pt.push({minWidth:Un}),Un?ze.children[gi].style.display="none":(pi=Qe.length-1,ze.children[gi].style.display="block")}function Nr(){var or,Fi=!1;for(or in Qe)!Qe.hasOwnProperty(or)||Pt[or].minWidth&&ze.offsetWidth>Pt[or].minWidth&&(Fi=or);if(Fi||(Fi=pi),tn!==Fi)if(Jn[Fi])Qe[tn].style.display="none",Qe[Fi].style.display="block",tn=Fi;else{var La=new Image;La.onload=function(){Qe[Fi].src=Et[Fi],Qe[tn].style.display="none",Qe[Fi].style.display="block",Jn[Fi]=!0,tn=Fi},La.src=Et[Fi]}else Qe[Fi].src=Et[Fi]}tn=pi,ze.resizeSensorInstance=new ve(ze,Nr),Nr()}var Ke=/,?[\s\t]*([^,\n]*?)((?:\[[\s\t]*?(?:min|max)-(?:width|height)[\s\t]*?[~$\^]?=[\s\t]*?"[^"]*?"[\s\t]*?])+)([^,\n\s\{]*)/gim,Zt=/\[[\s\t]*?(min|max)-(width|height)[\s\t]*?[~$\^]?=[\s\t]*?"([^"]*?)"[\s\t]*?]/gim;function st(ze){var Qe,Pt,Et,pi;for(ze=ze.replace(/'/g,'"');null!==(Qe=Ke.exec(ze));)for(Pt=Qe[1]+Qe[3],Et=Qe[2];null!==(pi=Zt.exec(Et));)Ee(Pt,pi[1],pi[2],pi[3])}function Ut(ze){var Qe="";if(ze)if("string"==typeof ze)(-1!==(ze=ze.toLowerCase()).indexOf("min-width")||-1!==ze.indexOf("max-width"))&&st(ze);else for(var Pt=0,Et=ze.length;Pt<Et;Pt++)1===ze[Pt].type?(-1!==(Qe=ze[Pt].selectorText||ze[Pt].cssText).indexOf("min-height")||-1!==Qe.indexOf("max-height")||-1!==Qe.indexOf("min-width")||-1!==Qe.indexOf("max-width"))&&st(Qe):4===ze[Pt].type?Ut(ze[Pt].cssRules||ze[Pt].rules):3===ze[Pt].type&&ze[Pt].styleSheet.hasOwnProperty("cssRules")&&Ut(ze[Pt].styleSheet.cssRules)}var Di=!1;this.init=function(){var ze="animationstart";void 0!==document.documentElement.style.webkitAnimationName?ze="webkitAnimationStart":void 0!==document.documentElement.style.MozAnimationName?ze="mozanimationstart":void 0!==document.documentElement.style.OAnimationName&&(ze="oanimationstart"),document.body.addEventListener(ze,function(Et){var pi=Et.target,tn=pi&&window.getComputedStyle(pi,null),Jn=tn&&tn.getPropertyValue("animation-name");if(Jn&&-1!==Jn.indexOf("element-queries")){pi.elementQueriesSensor=new ve(pi,function(){pi.elementQueriesSetupInformation&&pi.elementQueriesSetupInformation.call()});var ar=window.getComputedStyle(pi.resizeSensor,null).getPropertyValue("min-width");ar=parseInt(ar.replace("px","")),we(Et.target,Le[ar])}}),Di||((ce=document.createElement("style")).type="text/css",ce.innerHTML="[responsive-image] > img, [data-responsive-image] {overflow: hidden; padding: 0; } [responsive-image] > img, [data-responsive-image] > img {width: 100%;}",ce.innerHTML+="\n@keyframes element-queries { 0% { visibility: inherit; } }",document.getElementsByTagName("head")[0].appendChild(ce),Di=!0);for(var Qe=0,Pt=document.styleSheets.length;Qe<Pt;Qe++)try{document.styleSheets[Qe].href&&0===document.styleSheets[Qe].href.indexOf("file://")&&console.warn("CssElementQueries: unable to parse local css files, "+document.styleSheets[Qe].href),Ut(document.styleSheets[Qe].cssRules||document.styleSheets[Qe].rules||document.styleSheets[Qe].cssText)}catch(Et){}!function It(){for(var Qe=pe()("[data-responsive-image],[responsive-image]"),Pt=0,Et=Qe.length;Pt<Et;Pt++)_t(Qe[Pt])}()},this.findElementQueriesElements=function(ze){!function ae(ze){var Qe=pe(ze);for(var Pt in Ae)if(Ae.hasOwnProperty(Pt))for(var Et=Qe(Pt,ze),pi=0,tn=Et.length;pi<tn;pi++)we(Et[pi],Pt)}(ze)},this.update=function(){this.init()}};K.update=function(){K.instance.update()},K.detach=function(ce){ce.elementQueriesSetupInformation?(ce.elementQueriesSensor.detach(),delete ce.elementQueriesSetupInformation,delete ce.elementQueriesSensor):ce.resizeSensorInstance&&(ce.resizeSensorInstance.detach(),delete ce.resizeSensorInstance)},K.init=function(){K.instance||(K.instance=new K),K.instance.init()};return K.findElementQueriesElements=function(ce){K.instance.findElementQueriesElements(ce)},K.listen=function(){!function(ce){if(document.addEventListener)document.addEventListener("DOMContentLoaded",ce,!1);else if(/KHTML|WebKit|iCab/i.test(navigator.userAgent))var Ae=setInterval(function(){/loaded|complete/i.test(document.readyState)&&(ce(),clearInterval(Ae))},10);else window.onload=ce}(K.init)},K}.apply(Ce,xe))&&(et.exports=Pe)},294:function(et,Ce,L){"use strict";var xe;"undefined"!=typeof window&&window,void 0!==(xe=function(){if("undefined"==typeof window)return null;var Pe="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")(),ve=Pe.requestAnimationFrame||Pe.mozRequestAnimationFrame||Pe.webkitRequestAnimationFrame||function(G){return Pe.setTimeout(G,20)},K=Pe.cancelAnimationFrame||Pe.mozCancelAnimationFrame||Pe.webkitCancelAnimationFrame||function(G){Pe.clearTimeout(G)};function re(G,ie){var q=Object.prototype.toString.call(G),we="[object Array]"===q||"[object NodeList]"===q||"[object HTMLCollection]"===q||"[object Object]"===q||"undefined"!=typeof jQuery&&G instanceof jQuery||"undefined"!=typeof Elements&&G instanceof Elements,Ee=0,pe=G.length;if(we)for(;Ee<pe;Ee++)ie(G[Ee]);else ie(G)}function ce(G){if(!G.getBoundingClientRect)return{width:G.offsetWidth,height:G.offsetHeight};var ie=G.getBoundingClientRect();return{width:Math.round(ie.width),height:Math.round(ie.height)}}function Ae(G,ie){Object.keys(ie).forEach(function(q){G.style[q]=ie[q]})}var Le=function(G,ie){var q=0;function we(){var ae,_t,pe=[];this.add=function(It){pe.push(It)},this.call=function(It){for(ae=0,_t=pe.length;ae<_t;ae++)pe[ae].call(this,It)},this.remove=function(It){var Ke=[];for(ae=0,_t=pe.length;ae<_t;ae++)pe[ae]!==It&&Ke.push(pe[ae]);pe=Ke},this.length=function(){return pe.length}}function Ee(pe,ae){if(pe){if(pe.resizedAttached)return void pe.resizedAttached.add(ae);pe.resizedAttached=new we,pe.resizedAttached.add(ae),pe.resizeSensor=document.createElement("div"),pe.resizeSensor.dir="ltr",pe.resizeSensor.className="resize-sensor";var _t={pointerEvents:"none",position:"absolute",left:"0px",top:"0px",right:"0px",bottom:"0px",overflow:"hidden",zIndex:"-1",visibility:"hidden",maxWidth:"100%"},It={position:"absolute",left:"0px",top:"0px",transition:"0s"};Ae(pe.resizeSensor,_t);var Ke=document.createElement("div");Ke.className="resize-sensor-expand",Ae(Ke,_t);var Zt=document.createElement("div");Ae(Zt,It),Ke.appendChild(Zt);var st=document.createElement("div");st.className="resize-sensor-shrink",Ae(st,_t);var Ut=document.createElement("div");Ae(Ut,It),Ae(Ut,{width:"200%",height:"200%"}),st.appendChild(Ut),pe.resizeSensor.appendChild(Ke),pe.resizeSensor.appendChild(st),pe.appendChild(pe.resizeSensor);var Di=window.getComputedStyle(pe),ze=Di?Di.getPropertyValue("position"):null;"absolute"!==ze&&"relative"!==ze&&"fixed"!==ze&&"sticky"!==ze&&(pe.style.position="relative");var Qe=!1,Pt=0,Et=ce(pe),pi=0,tn=0,Jn=!0;q=0;var Un=function(){if(Jn){if(0===pe.offsetWidth&&0===pe.offsetHeight)return void(q||(q=ve(function(){q=0,Un()})));Jn=!1}var Fi,or;or=pe.offsetHeight,Zt.style.width=(Fi=pe.offsetWidth)+10+"px",Zt.style.height=or+10+"px",Ke.scrollLeft=Fi+10,Ke.scrollTop=or+10,st.scrollLeft=Fi+10,st.scrollTop=or+10};pe.resizeSensor.resetSensor=Un;var ar=function(){Pt=0,Qe&&(pi=Et.width,tn=Et.height,pe.resizedAttached&&pe.resizedAttached.call(Et))},jn=function(){Et=ce(pe),(Qe=Et.width!==pi||Et.height!==tn)&&!Pt&&(Pt=ve(ar)),Un()},Nr=function(Fi,or,La){Fi.attachEvent?Fi.attachEvent("on"+or,La):Fi.addEventListener(or,La)};Nr(Ke,"scroll",jn),Nr(st,"scroll",jn),q=ve(function(){q=0,Un()})}}re(G,function(pe){Ee(pe,ie)}),this.detach=function(pe){q||(K(q),q=0),Le.detach(G,pe)},this.reset=function(){G.resizeSensor.resetSensor()}};if(Le.reset=function(G){re(G,function(ie){ie.resizeSensor.resetSensor()})},Le.detach=function(G,ie){re(G,function(q){!q||q.resizedAttached&&"function"==typeof ie&&(q.resizedAttached.remove(ie),q.resizedAttached.length())||q.resizeSensor&&(q.contains(q.resizeSensor)&&q.removeChild(q.resizeSensor),delete q.resizeSensor,delete q.resizedAttached)})},"undefined"!=typeof MutationObserver){var Te=new MutationObserver(function(G){for(var ie in G)if(G.hasOwnProperty(ie))for(var q=G[ie].addedNodes,we=0;we<q.length;we++)q[we].resizeSensor&&Le.reset(q[we])});document.addEventListener("DOMContentLoaded",function(G){Te.observe(document.body,{childList:!0,subtree:!0})})}return Le}.call(Ce,L,Ce,et))&&(et.exports=xe)},6676:function(et,Ce,L){"use strict";var he=this&&this.__assign||function(){return he=Object.assign||function(Ee){for(var pe,ae=1,_t=arguments.length;ae<_t;ae++)for(var It in pe=arguments[ae])Object.prototype.hasOwnProperty.call(pe,It)&&(Ee[It]=pe[It]);return Ee},he.apply(this,arguments)};Ce.__esModule=!0;var xe=L(3389);Ce.presets={noWobble:[170,26],gentle:[120,14],wobbly:[180,12],stiff:[210,20]},Ce.mapValues=function(Ee,pe){return Object.keys(pe).reduce(function(ae,_t){var It;return he(he({},ae),((It={})[_t]=Ee(pe[_t],_t),It))},{})};var K=function(Ee){var pe=!0,ae=!0,_t=[];return function(){for(var It=[],Ke=0;Ke<arguments.length;Ke++)It[Ke]=arguments[Ke];if(pe)pe=!1,Ee.apply(void 0,It);else{if(_t=It,!ae)return;ae=!1,window.requestAnimationFrame(function(){ae=!0,Ee.apply(void 0,_t)})}}},re=[0,0];function ce(Ee,pe,ae,_t,It,Ke,Zt){void 0===_t&&(_t=170),void 0===It&&(It=20),void 0===Ke&&(Ke=.016),void 0===Zt&&(Zt=.1);var ze=pe+(-_t*(Ee-ae)+-It*pe)*Ke,Qe=Ee+ze*Ke;return Math.abs(ze)<Zt&&Math.abs(Qe-ae)<Zt?(re[0]=ae,re[1]=0,re):(re[0]=Qe,re[1]=ze,re)}function G(Ee,pe){return Array.isArray(Ee)?function(Ee){var pe,_t,ae=Ee.map(function(){return 0});return function(It){return _t=It,void 0===pe&&(pe=It),new xe.Observable(function(Ke){var Zt=!0,st=K(function(){for(var Ut,Di=0;Di<Ee.length;Di++){var ze=Ee[Di];Ut=ce(pe[Di],ae[Di],_t[Di],ze[0],ze[1]),pe[Di]=Ut[0],ae[Di]=Ut[1]}Ke.next(pe),ae.some(function(Et){return 0!==Et})&&Zt&&st()});return st(),{unsubscribe:function(){Zt=!1}}})}}(Ee):"object"==typeof Ee?function(Ee){var pe,_t,ae=Ce.mapValues(function(){return 0},Ee);return function(It){return _t=It,void 0===pe&&(pe=It),new xe.Observable(function(Ke){var Zt=!0,st=K(function(){var Ut;for(var Di in Ee){var ze=Ee[Di];Ut=ce(pe[Di],ae[Di],_t[Di],ze[0],ze[1]),pe[Di]=Ut[0],ae[Di]=Ut[1]}Ke.next(pe),Object.keys(ae).some(function(Et){return 0!==ae[Et]})&&Zt&&st()});return st(),{unsubscribe:function(){Zt=!1}}})}}(Ee):function(Ee,pe){var ae,It,_t=0;return function(Ke){return It=Ke,void 0===ae&&(ae=Ke),new xe.Observable(function(Zt){var st=!0,Ut=K(function(){var Di;Di=ce(ae,_t,It,Ee,pe),_t=Di[1],Zt.next(ae=Di[0]),0!==_t&&st&&Ut()});return Ut(),{unsubscribe:function(){st=!1}}})}}(Ee,pe)}var ie=new Map;Ce.default=function we(Ee,pe,ae){return function(Ee){return function(pe){var ae;return new xe.Observable(function(_t){var It=!1,Ke=!1,Zt=pe.subscribe({next:function(st){ae&&ae.unsubscribe(),ae=Ee(st).subscribe({error:function(Ut){return _t.error(Ut)},next:function(Ut){return _t.next(Ut)},complete:function(){Ke=!0,It&&_t.complete()}})},error:function(st){return _t.error(st)},complete:function(){It=!0,Ke&&_t.complete()}});return{unsubscribe:function(){ae&&ae.unsubscribe(),Zt.unsubscribe()}}})}}(function q(Ee,pe,ae){return void 0===ae&&"object"==typeof Ee&&(ae=pe),void 0===ae?G(Ee,pe):(ie.has(ae)||ie.set(ae,G(Ee,pe)),ie.get(ae))}(Ee,pe,ae))}},3389:(et,Ce,L)=>{"use strict";L.r(Ce),L.d(Ce,{ArgumentOutOfRangeError:()=>av.W,AsyncSubject:()=>we,BehaviorSubject:()=>ie.X,ConnectableObservable:()=>xe.c,EMPTY:()=>Vn.E,EmptyError:()=>ov,GroupedObservable:()=>Ae,NEVER:()=>Gl,Notification:()=>or.P,NotificationKind:()=>or.W,ObjectUnsubscribedError:()=>St.N,Observable:()=>he.y,ReplaySubject:()=>q.t,Scheduler:()=>Nr.b,Subject:()=>G.xQ,Subscriber:()=>Fi.L,Subscription:()=>Pe.w,TimeoutError:()=>uu,UnsubscriptionError:()=>lv.B,VirtualAction:()=>jn,VirtualTimeScheduler:()=>ar,animationFrame:()=>Un,animationFrameScheduler:()=>gi,asap:()=>Qe,asapScheduler:()=>ze,async:()=>Et,asyncScheduler:()=>Pt,bindCallback:()=>Jo,bindNodeCallback:()=>Ht,combineLatest:()=>qh.aj,concat:()=>uv.z,config:()=>ka.v,defer:()=>Wp,empty:()=>Vn.c,forkJoin:()=>vs,from:()=>Br.D,fromEvent:()=>Xp.R,fromEventPattern:()=>jp,generate:()=>Ni,identity:()=>er.y,iif:()=>fv,interval:()=>Ui,isObservable:()=>Pi,merge:()=>fu.T,never:()=>Jh,noop:()=>Hp.Z,observable:()=>Te.L,of:()=>Fs.of,onErrorResumeNext:()=>Ba,pairs:()=>$p,partition:()=>ed,pipe:()=>La.z,queue:()=>pi.c,queueScheduler:()=>pi.N,race:()=>Tt,range:()=>la,scheduled:()=>vr.x,throwError:()=>Ur._,timer:()=>Hl,using:()=>el,zip:()=>$n});var he=L(4202),xe=L(1762),Pe=L(4096);class Ae extends he.y{constructor(V,W,oe){super(),this.key=V,this.groupSubject=W,this.refCountSubscription=oe}_subscribe(V){const W=new Pe.w,{refCountSubscription:oe,groupSubject:Oe}=this;return oe&&!oe.closed&&W.add(new Le(oe)),W.add(Oe.subscribe(V)),W}}class Le extends Pe.w{constructor(V){super(),this.parent=V,V.count++}unsubscribe(){const V=this.parent;!V.closed&&!this.closed&&(super.unsubscribe(),V.count-=1,0===V.count&&V.attemptedToUnsubscribe&&V.unsubscribe())}}var Te=L(3821),G=L(8929),ie=L(591),q=L(2247);class we extends G.xQ{constructor(){super(...arguments),this.value=null,this.hasNext=!1,this.hasCompleted=!1}_subscribe(V){return this.hasError?(V.error(this.thrownError),Pe.w.EMPTY):this.hasCompleted&&this.hasNext?(V.next(this.value),V.complete(),Pe.w.EMPTY):super._subscribe(V)}next(V){this.hasCompleted||(this.value=V,this.hasNext=!0)}error(V){this.hasCompleted||super.error(V)}complete(){this.hasCompleted=!0,this.hasNext&&super.next(this.value),super.complete()}}let Ee=1;const pe=Promise.resolve(),ae={};function _t(te){return te in ae&&(delete ae[te],!0)}const It={setImmediate(te){const V=Ee++;return ae[V]=!0,pe.then(()=>_t(V)&&te()),V},clearImmediate(te){_t(te)}};var Zt=L(6686),Ut=L(198);const ze=new class Di extends Ut.v{flush(V){this.active=!0,this.scheduled=void 0;const{actions:W}=this;let oe,Oe=-1,Ne=W.length;V=V||W.shift();do{if(oe=V.execute(V.state,V.delay))break}while(++Oe<Ne&&(V=W.shift()));if(this.active=!1,oe){for(;++Oe<Ne&&(V=W.shift());)V.unsubscribe();throw oe}}}(class st extends Zt.o{constructor(V,W){super(V,W),this.scheduler=V,this.work=W}requestAsyncId(V,W,oe=0){return null!==oe&&oe>0?super.requestAsyncId(V,W,oe):(V.actions.push(this),V.scheduled||(V.scheduled=It.setImmediate(V.flush.bind(V,null))))}recycleAsyncId(V,W,oe=0){if(null!==oe&&oe>0||null===oe&&this.delay>0)return super.recycleAsyncId(V,W,oe);0===V.actions.length&&(It.clearImmediate(W),V.scheduled=void 0)}}),Qe=ze,Pt=new Ut.v(Zt.o),Et=Pt;var pi=L(341);const gi=new class Jn extends Ut.v{flush(V){this.active=!0,this.scheduled=void 0;const{actions:W}=this;let oe,Oe=-1,Ne=W.length;V=V||W.shift();do{if(oe=V.execute(V.state,V.delay))break}while(++Oe<Ne&&(V=W.shift()));if(this.active=!1,oe){for(;++Oe<Ne&&(V=W.shift());)V.unsubscribe();throw oe}}}(class tn extends Zt.o{constructor(V,W){super(V,W),this.scheduler=V,this.work=W}requestAsyncId(V,W,oe=0){return null!==oe&&oe>0?super.requestAsyncId(V,W,oe):(V.actions.push(this),V.scheduled||(V.scheduled=requestAnimationFrame(()=>V.flush(null))))}recycleAsyncId(V,W,oe=0){if(null!==oe&&oe>0||null===oe&&this.delay>0)return super.recycleAsyncId(V,W,oe);0===V.actions.length&&(cancelAnimationFrame(W),V.scheduled=void 0)}}),Un=gi;let ar=(()=>{class te extends Ut.v{constructor(W=jn,oe=Number.POSITIVE_INFINITY){super(W,()=>this.frame),this.maxFrames=oe,this.frame=0,this.index=-1}flush(){const{actions:W,maxFrames:oe}=this;let Oe,Ne;for(;(Ne=W[0])&&Ne.delay<=oe&&(W.shift(),this.frame=Ne.delay,!(Oe=Ne.execute(Ne.state,Ne.delay))););if(Oe){for(;Ne=W.shift();)Ne.unsubscribe();throw Oe}}}return te.frameTimeFactor=10,te})();class jn extends Zt.o{constructor(V,W,oe=(V.index+=1)){super(V,W),this.scheduler=V,this.work=W,this.index=oe,this.active=!0,this.index=V.index=oe}schedule(V,W=0){if(!this.id)return super.schedule(V,W);this.active=!1;const oe=new jn(this.scheduler,this.work);return this.add(oe),oe.schedule(V,W)}requestAsyncId(V,W,oe=0){this.delay=V.frame+oe;const{actions:Oe}=V;return Oe.push(this),Oe.sort(jn.sortActions),!0}recycleAsyncId(V,W,oe=0){}_execute(V,W){if(!0===this.active)return super._execute(V,W)}static sortActions(V,W){return V.delay===W.delay?V.index===W.index?0:V.index>W.index?1:-1:V.delay>W.delay?1:-1}}var Nr=L(2221),Fi=L(3489),or=L(9312),La=L(4843),Hp=L(7876),er=L(5379);function Pi(te){return!!te&&(te instanceof he.y||"function"==typeof te.lift&&"function"==typeof te.subscribe)}var av=L(4231);const ov=(()=>{function te(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}return te.prototype=Object.create(Error.prototype),te})();var St=L(5279),lv=L(7964);const uu=(()=>{function te(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return te.prototype=Object.create(Error.prototype),te})();var qo=L(4850),Qh=L(9476),ws=L(6688),_o=L(2866);function Jo(te,V,W){if(V){if(!(0,_o.K)(V))return(...oe)=>Jo(te,W)(...oe).pipe((0,qo.U)(Oe=>(0,ws.k)(Oe)?V(...Oe):V(Oe)));W=V}return function(...oe){const Oe=this;let Ne;const zt={context:Oe,subject:Ne,callbackFunc:te,scheduler:W};return new he.y(bt=>{if(W)return W.schedule(hu,0,{args:oe,subscriber:bt,params:zt});if(!Ne){Ne=new we;const Li=(...ci)=>{Ne.next(ci.length<=1?ci[0]:ci),Ne.complete()};try{te.apply(Oe,[...oe,Li])}catch(ci){(0,Qh._)(Ne)?Ne.error(ci):console.warn(ci)}}return Ne.subscribe(bt)})}}function hu(te){const{args:W,subscriber:oe,params:Oe}=te,{callbackFunc:Ne,context:zt,scheduler:bt}=Oe;let{subject:Li}=Oe;if(!Li){Li=Oe.subject=new we;const ci=(...ii)=>{this.add(bt.schedule(Zh,0,{value:ii.length<=1?ii[0]:ii,subject:Li}))};try{Ne.apply(zt,[...W,ci])}catch(ii){Li.error(ii)}}this.add(Li.subscribe(oe))}function Zh(te){const{value:V,subject:W}=te;W.next(V),W.complete()}function Ht(te,V,W){if(V){if(!(0,_o.K)(V))return(...oe)=>Ht(te,W)(...oe).pipe((0,qo.U)(Oe=>(0,ws.k)(Oe)?V(...Oe):V(Oe)));W=V}return function(...oe){const Oe={subject:void 0,args:oe,callbackFunc:te,scheduler:W,context:this};return new he.y(Ne=>{const{context:zt}=Oe;let{subject:bt}=Oe;if(W)return W.schedule(du,0,{params:Oe,subscriber:Ne,context:zt});if(!bt){bt=Oe.subject=new we;const Li=(...ci)=>{const ii=ci.shift();ii?bt.error(ii):(bt.next(ci.length<=1?ci[0]:ci),bt.complete())};try{te.apply(zt,[...oe,Li])}catch(ci){(0,Qh._)(bt)?bt.error(ci):console.warn(ci)}}return bt.subscribe(Ne)})}}function du(te){const{params:V,subscriber:W,context:oe}=te,{callbackFunc:Oe,args:Ne,scheduler:zt}=V;let bt=V.subject;if(!bt){bt=V.subject=new we;const Li=(...ci)=>{const ii=ci.shift();this.add(ii?zt.schedule(Os,0,{err:ii,subject:bt}):zt.schedule(zp,0,{value:ci.length<=1?ci[0]:ci,subject:bt}))};try{Oe.apply(oe,[...Ne,Li])}catch(ci){this.add(zt.schedule(Os,0,{err:ci,subject:bt}))}}this.add(bt.subscribe(W))}function zp(te){const{value:V,subject:W}=te;W.next(V),W.complete()}function Os(te){const{err:V,subject:W}=te;W.error(V)}var qh=L(6053),uv=L(1221),Br=L(3527),Vn=L(8896);function Wp(te){return new he.y(V=>{let W;try{W=te()}catch(Oe){return void V.error(Oe)}return(W?(0,Br.D)(W):(0,Vn.c)()).subscribe(V)})}var hv=L(7830);function vs(...te){if(1===te.length){const V=te[0];if((0,ws.k)(V))return Vl(V,null);if((0,hv.K)(V)&&Object.getPrototypeOf(V)===Object.prototype){const W=Object.keys(V);return Vl(W.map(oe=>V[oe]),W)}}if("function"==typeof te[te.length-1]){const V=te.pop();return Vl(te=1===te.length&&(0,ws.k)(te[0])?te[0]:te,null).pipe((0,qo.U)(W=>V(...W)))}return Vl(te,null)}function Vl(te,V){return new he.y(W=>{const oe=te.length;if(0===oe)return void W.complete();const Oe=new Array(oe);let Ne=0,zt=0;for(let bt=0;bt<oe;bt++){const Li=(0,Br.D)(te[bt]);let ci=!1;W.add(Li.subscribe({next:ii=>{ci||(ci=!0,zt++),Oe[bt]=ii},error:ii=>W.error(ii),complete:()=>{Ne++,(Ne===oe||!ci)&&(zt===oe&&W.next(V?V.reduce((ii,Kr,To)=>(ii[Kr]=Oe[To],ii),{}):Oe),W.complete())}}))}})}var Xp=L(3753),Yp=L(7043);function jp(te,V,W){return W?jp(te,V).pipe((0,qo.U)(oe=>(0,ws.k)(oe)?W(...oe):W(oe))):new he.y(oe=>{const Oe=(...zt)=>oe.next(1===zt.length?zt[0]:zt);let Ne;try{Ne=te(Oe)}catch(zt){return void oe.error(zt)}if((0,Yp.m)(V))return()=>V(Oe,Ne)})}function Ni(te,V,W,oe,Oe){let Ne,zt;return 1==arguments.length?(zt=te.initialState,V=te.condition,W=te.iterate,Ne=te.resultSelector||er.y,Oe=te.scheduler):void 0===oe||(0,_o.K)(oe)?(zt=te,Ne=er.y,Oe=oe):(zt=te,Ne=oe),new he.y(bt=>{let Li=zt;if(Oe)return Oe.schedule(dv,0,{subscriber:bt,iterate:W,condition:V,resultSelector:Ne,state:Li});for(;;){if(V){let ii;try{ii=V(Li)}catch(Kr){return void bt.error(Kr)}if(!ii){bt.complete();break}}let ci;try{ci=Ne(Li)}catch(ii){return void bt.error(ii)}if(bt.next(ci),bt.closed)break;try{Li=W(Li)}catch(ii){return void bt.error(ii)}}})}function dv(te){const{subscriber:V,condition:W}=te;if(V.closed)return;if(te.needIterate)try{te.state=te.iterate(te.state)}catch(Oe){return void V.error(Oe)}else te.needIterate=!0;if(W){let Oe;try{Oe=W(te.state)}catch(Ne){return void V.error(Ne)}if(!Oe)return void V.complete();if(V.closed)return}let oe;try{oe=te.resultSelector(te.state)}catch(Oe){return void V.error(Oe)}return V.closed||(V.next(oe),V.closed)?void 0:this.schedule(te)}function fv(te,V=Vn.E,W=Vn.E){return Wp(()=>te()?V:W)}function oa(te){return!(0,ws.k)(te)&&te-parseFloat(te)+1>=0}function Ui(te=0,V=Et){return(!oa(te)||te<0)&&(te=0),(!V||"function"!=typeof V.schedule)&&(V=Et),new he.y(W=>(W.add(V.schedule(kl,te,{subscriber:W,counter:0,period:te})),W))}function kl(te){const{subscriber:V,counter:W,period:oe}=te;V.next(W),this.schedule({subscriber:V,counter:W+1,period:oe},oe)}var fu=L(6787);const Gl=new he.y(Hp.Z);function Jh(){return Gl}var Fs=L(1086);function Ba(...te){if(0===te.length)return Vn.E;const[V,...W]=te;return 1===te.length&&(0,ws.k)(V)?Ba(...V):new he.y(oe=>{const Oe=()=>oe.add(Ba(...W).subscribe(oe));return(0,Br.D)(V).subscribe({next(Ne){oe.next(Ne)},error:Oe,complete:Oe})})}function $p(te,V){return new he.y(V?W=>{const oe=Object.keys(te),Oe=new Pe.w;return Oe.add(V.schedule(mo,0,{keys:oe,index:0,subscriber:W,subscription:Oe,obj:te})),Oe}:W=>{const oe=Object.keys(te);for(let Oe=0;Oe<oe.length&&!W.closed;Oe++){const Ne=oe[Oe];te.hasOwnProperty(Ne)&&W.next([Ne,te[Ne]])}W.complete()})}function mo(te){const{keys:V,index:W,subscriber:oe,subscription:Oe,obj:Ne}=te;if(!oe.closed)if(W<V.length){const zt=V[W];oe.next([zt,Ne[zt]]),Oe.add(this.schedule({keys:V,index:W+1,subscriber:oe,subscription:Oe,obj:Ne}))}else oe.complete()}function Kp(te,V){function W(){return!W.pred.apply(W.thisArg,arguments)}return W.pred=te,W.thisArg=V,W}var pu=L(4544),gu=L(2198);function ed(te,V,W){return[(0,gu.h)(V,W)(new he.y((0,pu.s)(te))),(0,gu.h)(Kp(V,W))(new he.y((0,pu.s)(te)))]}var Er=L(3009),Qp=L(826),td=L(448);function Tt(...te){if(1===te.length){if(!(0,ws.k)(te[0]))return te[0];te=te[0]}return(0,Er.n)(te,void 0).lift(new lr)}class lr{call(V,W){return W.subscribe(new kn(V))}}class kn extends Qp.L{constructor(V){super(V),this.hasFirst=!1,this.observables=[],this.subscriptions=[]}_next(V){this.observables.push(V)}_complete(){const V=this.observables,W=V.length;if(0===W)this.destination.complete();else{for(let oe=0;oe<W&&!this.hasFirst;oe++){const Ne=(0,td.D)(this,V[oe],void 0,oe);this.subscriptions&&this.subscriptions.push(Ne),this.add(Ne)}this.observables=null}}notifyNext(V,W,oe){if(!this.hasFirst){this.hasFirst=!0;for(let Oe=0;Oe<this.subscriptions.length;Oe++)if(Oe!==oe){let Ne=this.subscriptions[Oe];Ne.unsubscribe(),this.remove(Ne)}this.subscriptions=null}this.destination.next(W)}}function la(te=0,V,W){return new he.y(oe=>{void 0===V&&(V=te,te=0);let Oe=0,Ne=te;if(W)return W.schedule(Ua,0,{index:Oe,count:V,start:te,subscriber:oe});for(;;){if(Oe++>=V){oe.complete();break}if(oe.next(Ne++),oe.closed)break}})}function Ua(te){const{start:V,index:W,count:oe,subscriber:Oe}=te;W>=oe?Oe.complete():(Oe.next(V),!Oe.closed&&(te.index=W+1,te.start=V+1,this.schedule(te)))}var Ur=L(1737);function Hl(te=0,V,W){let oe=-1;return oa(V)?oe=Number(V)<1?1:Number(V):(0,_o.K)(V)&&(W=V),(0,_o.K)(W)||(W=Et),new he.y(Oe=>{const Ne=oa(te)?te:+te-W.now();return W.schedule(_u,Ne,{index:0,period:oe,subscriber:Oe})})}function _u(te){const{index:V,period:W,subscriber:oe}=te;if(oe.next(V),!oe.closed){if(-1===W)return oe.complete();te.index=V+1,this.schedule(te,W)}}function el(te,V){return new he.y(W=>{let oe,Oe;try{oe=te()}catch(bt){return void W.error(bt)}try{Oe=V(oe)}catch(bt){return void W.error(bt)}const zt=(Oe?(0,Br.D)(Oe):Vn.E).subscribe(W);return()=>{zt.unsubscribe(),oe&&oe.unsubscribe()}})}var Va=L(5430),Ns=L(1177);function $n(...te){const V=te[te.length-1];return"function"==typeof V&&te.pop(),(0,Er.n)(te,void 0).lift(new Zp(V))}class Zp{constructor(V){this.resultSelector=V}call(V,W){return W.subscribe(new Vr(V,this.resultSelector))}}class Vr extends Fi.L{constructor(V,W,oe=Object.create(null)){super(V),this.resultSelector=W,this.iterators=[],this.active=0,this.resultSelector="function"==typeof W?W:void 0}_next(V){const W=this.iterators;(0,ws.k)(V)?W.push(new ai(V)):W.push("function"==typeof V[Va.hZ]?new nt(V[Va.hZ]()):new Xi(this.destination,this,V))}_complete(){const V=this.iterators,W=V.length;if(this.unsubscribe(),0!==W){this.active=W;for(let oe=0;oe<W;oe++){let Oe=V[oe];Oe.stillUnsubscribed?this.destination.add(Oe.subscribe()):this.active--}}else this.destination.complete()}notifyInactive(){this.active--,0===this.active&&this.destination.complete()}checkIterators(){const V=this.iterators,W=V.length,oe=this.destination;for(let zt=0;zt<W;zt++){let bt=V[zt];if("function"==typeof bt.hasValue&&!bt.hasValue())return}let Oe=!1;const Ne=[];for(let zt=0;zt<W;zt++){let bt=V[zt],Li=bt.next();if(bt.hasCompleted()&&(Oe=!0),Li.done)return void oe.complete();Ne.push(Li.value)}this.resultSelector?this._tryresultSelector(Ne):oe.next(Ne),Oe&&oe.complete()}_tryresultSelector(V){let W;try{W=this.resultSelector.apply(this,V)}catch(oe){return void this.destination.error(oe)}this.destination.next(W)}}class nt{constructor(V){this.iterator=V,this.nextResult=V.next()}hasValue(){return!0}next(){const V=this.nextResult;return this.nextResult=this.iterator.next(),V}hasCompleted(){const V=this.nextResult;return Boolean(V&&V.done)}}class ai{constructor(V){this.array=V,this.index=0,this.length=0,this.length=V.length}[Va.hZ](){return this}next(V){const W=this.index++;return W<this.length?{value:this.array[W],done:!1}:{value:null,done:!0}}hasValue(){return this.array.length>this.index}hasCompleted(){return this.array.length===this.index}}class Xi extends Ns.Ds{constructor(V,W,oe){super(V),this.parent=W,this.observable=oe,this.stillUnsubscribed=!0,this.buffer=[],this.isComplete=!1}[Va.hZ](){return this}next(){const V=this.buffer;return 0===V.length&&this.isComplete?{value:null,done:!0}:{value:V.shift(),done:!1}}hasValue(){return this.buffer.length>0}hasCompleted(){return 0===this.buffer.length&&this.isComplete}notifyComplete(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()}notifyNext(V){this.buffer.push(V),this.parent.checkIterators()}subscribe(){return(0,Ns.ft)(this.observable,new Ns.IY(this))}}var vr=L(7164),ka=L(2830)},591:(et,Ce,L)=>{"use strict";L.d(Ce,{X:()=>Pe});var he=L(8929),xe=L(5279);class Pe extends he.xQ{constructor(K){super(),this._value=K}get value(){return this.getValue()}_subscribe(K){const re=super._subscribe(K);return re&&!re.closed&&K.next(this._value),re}getValue(){if(this.hasError)throw this.thrownError;if(this.closed)throw new xe.N;return this._value}next(K){super.next(this._value=K)}}},9312:(et,Ce,L)=>{"use strict";L.d(Ce,{P:()=>K,W:()=>ve});var he=L(8896),xe=L(1086),Pe=L(1737),ve=(()=>{return(re=ve||(ve={})).NEXT="N",re.ERROR="E",re.COMPLETE="C",ve;var re})();class K{constructor(ce,Ae,Le){this.kind=ce,this.value=Ae,this.error=Le,this.hasValue="N"===ce}observe(ce){switch(this.kind){case"N":return ce.next&&ce.next(this.value);case"E":return ce.error&&ce.error(this.error);case"C":return ce.complete&&ce.complete()}}do(ce,Ae,Le){switch(this.kind){case"N":return ce&&ce(this.value);case"E":return Ae&&Ae(this.error);case"C":return Le&&Le()}}accept(ce,Ae,Le){return ce&&"function"==typeof ce.next?this.observe(ce):this.do(ce,Ae,Le)}toObservable(){switch(this.kind){case"N":return(0,xe.of)(this.value);case"E":return(0,Pe._)(this.error);case"C":return(0,he.c)()}throw new Error("unexpected notification kind value")}static createNext(ce){return void 0!==ce?new K("N",ce):K.undefinedValueNotification}static createError(ce){return new K("E",void 0,ce)}static createComplete(){return K.completeNotification}}K.completeNotification=new K("C"),K.undefinedValueNotification=new K("N",void 0)},4202:(et,Ce,L)=>{"use strict";L.d(Ce,{y:()=>Le});var he=L(9476),xe=L(3489),Pe=L(7668),ve=L(3292),re=L(3821),ce=L(4843),Ae=L(2830);let Le=(()=>{class G{constructor(q){this._isScalar=!1,q&&(this._subscribe=q)}lift(q){const we=new G;return we.source=this,we.operator=q,we}subscribe(q,we,Ee){const{operator:pe}=this,ae=function K(G,ie,q){if(G){if(G instanceof xe.L)return G;if(G[Pe.b])return G[Pe.b]()}return G||ie||q?new xe.L(G,ie,q):new xe.L(ve.c)}(q,we,Ee);if(ae.add(pe?pe.call(ae,this.source):this.source||Ae.v.useDeprecatedSynchronousErrorHandling&&!ae.syncErrorThrowable?this._subscribe(ae):this._trySubscribe(ae)),Ae.v.useDeprecatedSynchronousErrorHandling&&ae.syncErrorThrowable&&(ae.syncErrorThrowable=!1,ae.syncErrorThrown))throw ae.syncErrorValue;return ae}_trySubscribe(q){try{return this._subscribe(q)}catch(we){Ae.v.useDeprecatedSynchronousErrorHandling&&(q.syncErrorThrown=!0,q.syncErrorValue=we),(0,he._)(q)?q.error(we):console.warn(we)}}forEach(q,we){return new(we=Te(we))((Ee,pe)=>{let ae;ae=this.subscribe(_t=>{try{q(_t)}catch(It){pe(It),ae&&ae.unsubscribe()}},pe,Ee)})}_subscribe(q){const{source:we}=this;return we&&we.subscribe(q)}[re.L](){return this}pipe(...q){return 0===q.length?this:(0,ce.U)(q)(this)}toPromise(q){return new(q=Te(q))((we,Ee)=>{let pe;this.subscribe(ae=>pe=ae,ae=>Ee(ae),()=>we(pe))})}}return G.create=ie=>new G(ie),G})();function Te(G){if(G||(G=Ae.v.Promise||Promise),!G)throw new Error("no Promise impl found");return G}},3292:(et,Ce,L)=>{"use strict";L.d(Ce,{c:()=>Pe});var he=L(2830),xe=L(2782);const Pe={closed:!0,next(ve){},error(ve){if(he.v.useDeprecatedSynchronousErrorHandling)throw ve;(0,xe.z)(ve)},complete(){}}},826:(et,Ce,L)=>{"use strict";L.d(Ce,{L:()=>xe});var he=L(3489);class xe extends he.L{notifyNext(ve,K,re,ce,Ae){this.destination.next(K)}notifyError(ve,K){this.destination.error(ve)}notifyComplete(ve){this.destination.complete()}}},2247:(et,Ce,L)=>{"use strict";L.d(Ce,{t:()=>ie});var he=L(8929),xe=L(341),Pe=L(4096),ve=L(3489),K=L(9312);class Ae extends ve.L{constructor(Ee,pe,ae=0){super(Ee),this.scheduler=pe,this.delay=ae}static dispatch(Ee){const{notification:pe,destination:ae}=Ee;pe.observe(ae),this.unsubscribe()}scheduleMessage(Ee){this.destination.add(this.scheduler.schedule(Ae.dispatch,this.delay,new Le(Ee,this.destination)))}_next(Ee){this.scheduleMessage(K.P.createNext(Ee))}_error(Ee){this.scheduleMessage(K.P.createError(Ee)),this.unsubscribe()}_complete(){this.scheduleMessage(K.P.createComplete()),this.unsubscribe()}}class Le{constructor(Ee,pe){this.notification=Ee,this.destination=pe}}var Te=L(5279),G=L(5283);class ie extends he.xQ{constructor(Ee=Number.POSITIVE_INFINITY,pe=Number.POSITIVE_INFINITY,ae){super(),this.scheduler=ae,this._events=[],this._infiniteTimeWindow=!1,this._bufferSize=Ee<1?1:Ee,this._windowTime=pe<1?1:pe,pe===Number.POSITIVE_INFINITY?(this._infiniteTimeWindow=!0,this.next=this.nextInfiniteTimeWindow):this.next=this.nextTimeWindow}nextInfiniteTimeWindow(Ee){if(!this.isStopped){const pe=this._events;pe.push(Ee),pe.length>this._bufferSize&&pe.shift()}super.next(Ee)}nextTimeWindow(Ee){this.isStopped||(this._events.push(new q(this._getNow(),Ee)),this._trimBufferThenGetEvents()),super.next(Ee)}_subscribe(Ee){const pe=this._infiniteTimeWindow,ae=pe?this._events:this._trimBufferThenGetEvents(),_t=this.scheduler,It=ae.length;let Ke;if(this.closed)throw new Te.N;if(this.isStopped||this.hasError?Ke=Pe.w.EMPTY:(this.observers.push(Ee),Ke=new G.W(this,Ee)),_t&&Ee.add(Ee=new Ae(Ee,_t)),pe)for(let Zt=0;Zt<It&&!Ee.closed;Zt++)Ee.next(ae[Zt]);else for(let Zt=0;Zt<It&&!Ee.closed;Zt++)Ee.next(ae[Zt].value);return this.hasError?Ee.error(this.thrownError):this.isStopped&&Ee.complete(),Ke}_getNow(){return(this.scheduler||xe.c).now()}_trimBufferThenGetEvents(){const Ee=this._getNow(),pe=this._bufferSize,ae=this._windowTime,_t=this._events,It=_t.length;let Ke=0;for(;Ke<It&&!(Ee-_t[Ke].time<ae);)Ke++;return It>pe&&(Ke=Math.max(Ke,It-pe)),Ke>0&&_t.splice(0,Ke),_t}}class q{constructor(Ee,pe){this.time=Ee,this.value=pe}}},2221:(et,Ce,L)=>{"use strict";L.d(Ce,{b:()=>he});let he=(()=>{class xe{constructor(ve,K=xe.now){this.SchedulerAction=ve,this.now=K}schedule(ve,K=0,re){return new this.SchedulerAction(this,ve).schedule(re,K)}}return xe.now=()=>Date.now(),xe})()},8929:(et,Ce,L)=>{"use strict";L.d(Ce,{Yc:()=>ce,xQ:()=>Ae});var he=L(4202),xe=L(3489),Pe=L(4096),ve=L(5279),K=L(5283),re=L(7668);class ce extends xe.L{constructor(G){super(G),this.destination=G}}let Ae=(()=>{class Te extends he.y{constructor(){super(),this.observers=[],this.closed=!1,this.isStopped=!1,this.hasError=!1,this.thrownError=null}[re.b](){return new ce(this)}lift(ie){const q=new Le(this,this);return q.operator=ie,q}next(ie){if(this.closed)throw new ve.N;if(!this.isStopped){const{observers:q}=this,we=q.length,Ee=q.slice();for(let pe=0;pe<we;pe++)Ee[pe].next(ie)}}error(ie){if(this.closed)throw new ve.N;this.hasError=!0,this.thrownError=ie,this.isStopped=!0;const{observers:q}=this,we=q.length,Ee=q.slice();for(let pe=0;pe<we;pe++)Ee[pe].error(ie);this.observers.length=0}complete(){if(this.closed)throw new ve.N;this.isStopped=!0;const{observers:ie}=this,q=ie.length,we=ie.slice();for(let Ee=0;Ee<q;Ee++)we[Ee].complete();this.observers.length=0}unsubscribe(){this.isStopped=!0,this.closed=!0,this.observers=null}_trySubscribe(ie){if(this.closed)throw new ve.N;return super._trySubscribe(ie)}_subscribe(ie){if(this.closed)throw new ve.N;return this.hasError?(ie.error(this.thrownError),Pe.w.EMPTY):this.isStopped?(ie.complete(),Pe.w.EMPTY):(this.observers.push(ie),new K.W(this,ie))}asObservable(){const ie=new he.y;return ie.source=this,ie}}return Te.create=(G,ie)=>new Le(G,ie),Te})();class Le extends Ae{constructor(G,ie){super(),this.destination=G,this.source=ie}next(G){const{destination:ie}=this;ie&&ie.next&&ie.next(G)}error(G){const{destination:ie}=this;ie&&ie.error&&this.destination.error(G)}complete(){const{destination:G}=this;G&&G.complete&&this.destination.complete()}_subscribe(G){const{source:ie}=this;return ie?this.source.subscribe(G):Pe.w.EMPTY}}},5283:(et,Ce,L)=>{"use strict";L.d(Ce,{W:()=>xe});var he=L(4096);class xe extends he.w{constructor(ve,K){super(),this.subject=ve,this.subscriber=K,this.closed=!1}unsubscribe(){if(this.closed)return;this.closed=!0;const ve=this.subject,K=ve.observers;if(this.subject=null,!K||0===K.length||ve.isStopped||ve.closed)return;const re=K.indexOf(this.subscriber);-1!==re&&K.splice(re,1)}}},3489:(et,Ce,L)=>{"use strict";L.d(Ce,{L:()=>ce});var he=L(7043),xe=L(3292),Pe=L(4096),ve=L(7668),K=L(2830),re=L(2782);class ce extends Pe.w{constructor(Te,G,ie){switch(super(),this.syncErrorValue=null,this.syncErrorThrown=!1,this.syncErrorThrowable=!1,this.isStopped=!1,arguments.length){case 0:this.destination=xe.c;break;case 1:if(!Te){this.destination=xe.c;break}if("object"==typeof Te){Te instanceof ce?(this.syncErrorThrowable=Te.syncErrorThrowable,this.destination=Te,Te.add(this)):(this.syncErrorThrowable=!0,this.destination=new Ae(this,Te));break}default:this.syncErrorThrowable=!0,this.destination=new Ae(this,Te,G,ie)}}[ve.b](){return this}static create(Te,G,ie){const q=new ce(Te,G,ie);return q.syncErrorThrowable=!1,q}next(Te){this.isStopped||this._next(Te)}error(Te){this.isStopped||(this.isStopped=!0,this._error(Te))}complete(){this.isStopped||(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe())}_next(Te){this.destination.next(Te)}_error(Te){this.destination.error(Te),this.unsubscribe()}_complete(){this.destination.complete(),this.unsubscribe()}_unsubscribeAndRecycle(){const{_parentOrParents:Te}=this;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=Te,this}}class Ae extends ce{constructor(Te,G,ie,q){super(),this._parentSubscriber=Te;let we,Ee=this;(0,he.m)(G)?we=G:G&&(we=G.next,ie=G.error,q=G.complete,G!==xe.c&&(Ee=Object.create(G),(0,he.m)(Ee.unsubscribe)&&this.add(Ee.unsubscribe.bind(Ee)),Ee.unsubscribe=this.unsubscribe.bind(this))),this._context=Ee,this._next=we,this._error=ie,this._complete=q}next(Te){if(!this.isStopped&&this._next){const{_parentSubscriber:G}=this;K.v.useDeprecatedSynchronousErrorHandling&&G.syncErrorThrowable?this.__tryOrSetError(G,this._next,Te)&&this.unsubscribe():this.__tryOrUnsub(this._next,Te)}}error(Te){if(!this.isStopped){const{_parentSubscriber:G}=this,{useDeprecatedSynchronousErrorHandling:ie}=K.v;if(this._error)ie&&G.syncErrorThrowable?(this.__tryOrSetError(G,this._error,Te),this.unsubscribe()):(this.__tryOrUnsub(this._error,Te),this.unsubscribe());else if(G.syncErrorThrowable)ie?(G.syncErrorValue=Te,G.syncErrorThrown=!0):(0,re.z)(Te),this.unsubscribe();else{if(this.unsubscribe(),ie)throw Te;(0,re.z)(Te)}}}complete(){if(!this.isStopped){const{_parentSubscriber:Te}=this;if(this._complete){const G=()=>this._complete.call(this._context);K.v.useDeprecatedSynchronousErrorHandling&&Te.syncErrorThrowable?(this.__tryOrSetError(Te,G),this.unsubscribe()):(this.__tryOrUnsub(G),this.unsubscribe())}else this.unsubscribe()}}__tryOrUnsub(Te,G){try{Te.call(this._context,G)}catch(ie){if(this.unsubscribe(),K.v.useDeprecatedSynchronousErrorHandling)throw ie;(0,re.z)(ie)}}__tryOrSetError(Te,G,ie){if(!K.v.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{G.call(this._context,ie)}catch(q){return K.v.useDeprecatedSynchronousErrorHandling?(Te.syncErrorValue=q,Te.syncErrorThrown=!0,!0):((0,re.z)(q),!0)}return!1}_unsubscribe(){const{_parentSubscriber:Te}=this;this._context=null,this._parentSubscriber=null,Te.unsubscribe()}}},4096:(et,Ce,L)=>{"use strict";L.d(Ce,{w:()=>K});var ce,he=L(6688),xe=L(7830),Pe=L(7043),ve=L(7964);class K{constructor(Ae){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,Ae&&(this._ctorUnsubscribe=!0,this._unsubscribe=Ae)}unsubscribe(){let Ae;if(this.closed)return;let{_parentOrParents:Le,_ctorUnsubscribe:Te,_unsubscribe:G,_subscriptions:ie}=this;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,Le instanceof K)Le.remove(this);else if(null!==Le)for(let q=0;q<Le.length;++q)Le[q].remove(this);if((0,Pe.m)(G)){Te&&(this._unsubscribe=void 0);try{G.call(this)}catch(q){Ae=q instanceof ve.B?re(q.errors):[q]}}if((0,he.k)(ie)){let q=-1,we=ie.length;for(;++q<we;){const Ee=ie[q];if((0,xe.K)(Ee))try{Ee.unsubscribe()}catch(pe){Ae=Ae||[],pe instanceof ve.B?Ae=Ae.concat(re(pe.errors)):Ae.push(pe)}}}if(Ae)throw new ve.B(Ae)}add(Ae){let Le=Ae;if(!Ae)return K.EMPTY;switch(typeof Ae){case"function":Le=new K(Ae);case"object":if(Le===this||Le.closed||"function"!=typeof Le.unsubscribe)return Le;if(this.closed)return Le.unsubscribe(),Le;if(!(Le instanceof K)){const ie=Le;Le=new K,Le._subscriptions=[ie]}break;default:throw new Error("unrecognized teardown "+Ae+" added to Subscription.")}let{_parentOrParents:Te}=Le;if(null===Te)Le._parentOrParents=this;else if(Te instanceof K){if(Te===this)return Le;Le._parentOrParents=[Te,this]}else{if(-1!==Te.indexOf(this))return Le;Te.push(this)}const G=this._subscriptions;return null===G?this._subscriptions=[Le]:G.push(Le),Le}remove(Ae){const Le=this._subscriptions;if(Le){const Te=Le.indexOf(Ae);-1!==Te&&Le.splice(Te,1)}}}function re(ce){return ce.reduce((Ae,Le)=>Ae.concat(Le instanceof ve.B?Le.errors:Le),[])}K.EMPTY=((ce=new K).closed=!0,ce)},2830:(et,Ce,L)=>{"use strict";L.d(Ce,{v:()=>xe});let he=!1;const xe={Promise:void 0,set useDeprecatedSynchronousErrorHandling(Pe){if(Pe){const ve=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated synchronous error handling behavior by code at: \n"+ve.stack)}else he&&console.log("RxJS: Back to a better error behavior. Thank you. <3");he=Pe},get useDeprecatedSynchronousErrorHandling(){return he}}},1177:(et,Ce,L)=>{"use strict";L.d(Ce,{Ds:()=>re,IY:()=>ve,ft:()=>Ae});var he=L(3489),xe=L(4202),Pe=L(4544);class ve extends he.L{constructor(Te){super(),this.parent=Te}_next(Te){this.parent.notifyNext(Te)}_error(Te){this.parent.notifyError(Te),this.unsubscribe()}_complete(){this.parent.notifyComplete(),this.unsubscribe()}}class re extends he.L{notifyNext(Te){this.destination.next(Te)}notifyError(Te){this.destination.error(Te)}notifyComplete(){this.destination.complete()}}function Ae(Le,Te){if(Te.closed)return;if(Le instanceof xe.y)return Le.subscribe(Te);let G;try{G=(0,Pe.s)(Le)(Te)}catch(ie){Te.error(ie)}return G}},1762:(et,Ce,L)=>{"use strict";L.d(Ce,{N:()=>re,c:()=>K});var he=L(8929),xe=L(4202),Pe=L(4096),ve=L(4327);class K extends xe.y{constructor(G,ie){super(),this.source=G,this.subjectFactory=ie,this._refCount=0,this._isComplete=!1}_subscribe(G){return this.getSubject().subscribe(G)}getSubject(){const G=this._subject;return(!G||G.isStopped)&&(this._subject=this.subjectFactory()),this._subject}connect(){let G=this._connection;return G||(this._isComplete=!1,G=this._connection=new Pe.w,G.add(this.source.subscribe(new ce(this.getSubject(),this))),G.closed&&(this._connection=null,G=Pe.w.EMPTY)),G}refCount(){return(0,ve.x)()(this)}}const re=(()=>{const Te=K.prototype;return{operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:Te._subscribe},_isComplete:{value:Te._isComplete,writable:!0},getSubject:{value:Te.getSubject},connect:{value:Te.connect},refCount:{value:Te.refCount}}})();class ce extends he.Yc{constructor(G,ie){super(G),this.connectable=ie}_error(G){this._unsubscribe(),super._error(G)}_complete(){this.connectable._isComplete=!0,this._unsubscribe(),super._complete()}_unsubscribe(){const G=this.connectable;if(G){this.connectable=null;const ie=G._connection;G._refCount=0,G._subject=null,G._connection=null,ie&&ie.unsubscribe()}}}},6053:(et,Ce,L)=>{"use strict";L.d(Ce,{aj:()=>ce});var he=L(2866),xe=L(6688),Pe=L(826),ve=L(448),K=L(3009);const re={};function ce(...Te){let G,ie;return(0,he.K)(Te[Te.length-1])&&(ie=Te.pop()),"function"==typeof Te[Te.length-1]&&(G=Te.pop()),1===Te.length&&(0,xe.k)(Te[0])&&(Te=Te[0]),(0,K.n)(Te,ie).lift(new Ae(G))}class Ae{constructor(G){this.resultSelector=G}call(G,ie){return ie.subscribe(new Le(G,this.resultSelector))}}class Le extends Pe.L{constructor(G,ie){super(G),this.resultSelector=ie,this.active=0,this.values=[],this.observables=[]}_next(G){this.values.push(re),this.observables.push(G)}_complete(){const G=this.observables,ie=G.length;if(0===ie)this.destination.complete();else{this.active=ie,this.toRespond=ie;for(let q=0;q<ie;q++)this.add((0,ve.D)(this,G[q],void 0,q))}}notifyComplete(G){0==(this.active-=1)&&this.destination.complete()}notifyNext(G,ie,q){const we=this.values,pe=this.toRespond?we[q]===re?--this.toRespond:this.toRespond:0;we[q]=ie,0===pe&&(this.resultSelector?this._tryResultSelector(we):this.destination.next(we.slice()))}_tryResultSelector(G){let ie;try{ie=this.resultSelector.apply(this,G)}catch(q){return void this.destination.error(q)}this.destination.next(ie)}}},1221:(et,Ce,L)=>{"use strict";L.d(Ce,{z:()=>ve});var he=L(1086),xe=L(5557);function ve(...K){return function Pe(){return(0,xe.J)(1)}()((0,he.of)(...K))}},8896:(et,Ce,L)=>{"use strict";L.d(Ce,{E:()=>xe,c:()=>Pe});var he=L(4202);const xe=new he.y(K=>K.complete());function Pe(K){return K?function ve(K){return new he.y(re=>K.schedule(()=>re.complete()))}(K):xe}},3527:(et,Ce,L)=>{"use strict";L.d(Ce,{D:()=>ve});var he=L(4202),xe=L(4544),Pe=L(7164);function ve(K,re){return re?(0,Pe.x)(K,re):K instanceof he.y?K:new he.y((0,xe.s)(K))}},3009:(et,Ce,L)=>{"use strict";L.d(Ce,{n:()=>ve});var he=L(4202),xe=L(3650),Pe=L(6454);function ve(K,re){return re?(0,Pe.r)(K,re):new he.y((0,xe.V)(K))}},3753:(et,Ce,L)=>{"use strict";L.d(Ce,{R:()=>re});var he=L(4202),xe=L(6688),Pe=L(7043),ve=L(4850);function re(G,ie,q,we){return(0,Pe.m)(q)&&(we=q,q=void 0),we?re(G,ie,q).pipe((0,ve.U)(Ee=>(0,xe.k)(Ee)?we(...Ee):we(Ee))):new he.y(Ee=>{ce(G,ie,function pe(ae){Ee.next(arguments.length>1?Array.prototype.slice.call(arguments):ae)},Ee,q)})}function ce(G,ie,q,we,Ee){let pe;if(function Te(G){return G&&"function"==typeof G.addEventListener&&"function"==typeof G.removeEventListener}(G)){const ae=G;G.addEventListener(ie,q,Ee),pe=()=>ae.removeEventListener(ie,q,Ee)}else if(function Le(G){return G&&"function"==typeof G.on&&"function"==typeof G.off}(G)){const ae=G;G.on(ie,q),pe=()=>ae.off(ie,q)}else if(function Ae(G){return G&&"function"==typeof G.addListener&&"function"==typeof G.removeListener}(G)){const ae=G;G.addListener(ie,q),pe=()=>ae.removeListener(ie,q)}else{if(!G||!G.length)throw new TypeError("Invalid event target");for(let ae=0,_t=G.length;ae<_t;ae++)ce(G[ae],ie,q,we,Ee)}we.add(pe)}},6787:(et,Ce,L)=>{"use strict";L.d(Ce,{T:()=>K});var he=L(4202),xe=L(2866),Pe=L(5557),ve=L(3009);function K(...re){let ce=Number.POSITIVE_INFINITY,Ae=null,Le=re[re.length-1];return(0,xe.K)(Le)?(Ae=re.pop(),re.length>1&&"number"==typeof re[re.length-1]&&(ce=re.pop())):"number"==typeof Le&&(ce=re.pop()),null===Ae&&1===re.length&&re[0]instanceof he.y?re[0]:(0,Pe.J)(ce)((0,ve.n)(re,Ae))}},1086:(et,Ce,L)=>{"use strict";L.d(Ce,{of:()=>ve});var he=L(2866),xe=L(3009),Pe=L(6454);function ve(...K){let re=K[K.length-1];return(0,he.K)(re)?(K.pop(),(0,Pe.r)(K,re)):(0,xe.n)(K)}},1737:(et,Ce,L)=>{"use strict";L.d(Ce,{_:()=>xe});var he=L(4202);function xe(ve,K){return new he.y(K?re=>K.schedule(Pe,0,{error:ve,subscriber:re}):re=>re.error(ve))}function Pe({error:ve,subscriber:K}){K.error(ve)}},2198:(et,Ce,L)=>{"use strict";L.d(Ce,{h:()=>xe});var he=L(3489);function xe(K,re){return function(Ae){return Ae.lift(new Pe(K,re))}}class Pe{constructor(re,ce){this.predicate=re,this.thisArg=ce}call(re,ce){return ce.subscribe(new ve(re,this.predicate,this.thisArg))}}class ve extends he.L{constructor(re,ce,Ae){super(re),this.predicate=ce,this.thisArg=Ae,this.count=0}_next(re){let ce;try{ce=this.predicate.call(this.thisArg,re,this.count++)}catch(Ae){return void this.destination.error(Ae)}ce&&this.destination.next(re)}}},4850:(et,Ce,L)=>{"use strict";L.d(Ce,{U:()=>xe});var he=L(3489);function xe(K,re){return function(Ae){if("function"!=typeof K)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return Ae.lift(new Pe(K,re))}}class Pe{constructor(re,ce){this.project=re,this.thisArg=ce}call(re,ce){return ce.subscribe(new ve(re,this.project,this.thisArg))}}class ve extends he.L{constructor(re,ce,Ae){super(re),this.project=ce,this.count=0,this.thisArg=Ae||this}_next(re){let ce;try{ce=this.project.call(this.thisArg,re,this.count++)}catch(Ae){return void this.destination.error(Ae)}this.destination.next(ce)}}},5557:(et,Ce,L)=>{"use strict";L.d(Ce,{J:()=>Le});var he=L(4850),xe=L(3527),Pe=L(1177);function ve(Te,G,ie=Number.POSITIVE_INFINITY){return"function"==typeof G?q=>q.pipe(ve((we,Ee)=>(0,xe.D)(Te(we,Ee)).pipe((0,he.U)((pe,ae)=>G(we,pe,Ee,ae))),ie)):("number"==typeof G&&(ie=G),q=>q.lift(new K(Te,ie)))}class K{constructor(G,ie=Number.POSITIVE_INFINITY){this.project=G,this.concurrent=ie}call(G,ie){return ie.subscribe(new re(G,this.project,this.concurrent))}}class re extends Pe.Ds{constructor(G,ie,q=Number.POSITIVE_INFINITY){super(G),this.project=ie,this.concurrent=q,this.hasCompleted=!1,this.buffer=[],this.active=0,this.index=0}_next(G){this.active<this.concurrent?this._tryNext(G):this.buffer.push(G)}_tryNext(G){let ie;const q=this.index++;try{ie=this.project(G,q)}catch(we){return void this.destination.error(we)}this.active++,this._innerSub(ie)}_innerSub(G){const ie=new Pe.IY(this),q=this.destination;q.add(ie);const we=(0,Pe.ft)(G,ie);we!==ie&&q.add(we)}_complete(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()}notifyNext(G){this.destination.next(G)}notifyComplete(){const G=this.buffer;this.active--,G.length>0?this._next(G.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()}}var Ae=L(5379);function Le(Te=Number.POSITIVE_INFINITY){return ve(Ae.y,Te)}},4327:(et,Ce,L)=>{"use strict";L.d(Ce,{x:()=>xe});var he=L(3489);function xe(){return function(re){return re.lift(new Pe(re))}}class Pe{constructor(re){this.connectable=re}call(re,ce){const{connectable:Ae}=this;Ae._refCount++;const Le=new ve(re,Ae),Te=ce.subscribe(Le);return Le.closed||(Le.connection=Ae.connect()),Te}}class ve extends he.L{constructor(re,ce){super(re),this.connectable=ce}_unsubscribe(){const{connectable:re}=this;if(!re)return void(this.connection=null);this.connectable=null;const ce=re._refCount;if(ce<=0)return void(this.connection=null);if(re._refCount=ce-1,ce>1)return void(this.connection=null);const{connection:Ae}=this,Le=re._connection;this.connection=null,Le&&(!Ae||Le===Ae)&&Le.unsubscribe()}}},6454:(et,Ce,L)=>{"use strict";L.d(Ce,{r:()=>Pe});var he=L(4202),xe=L(4096);function Pe(ve,K){return new he.y(re=>{const ce=new xe.w;let Ae=0;return ce.add(K.schedule(function(){Ae!==ve.length?(re.next(ve[Ae++]),re.closed||ce.add(this.schedule())):re.complete()})),ce})}},8687:(et,Ce,L)=>{"use strict";L.d(Ce,{c:()=>Pe});var he=L(4202),xe=L(4096);function Pe(ve,K){return new he.y(re=>{const ce=new xe.w;return ce.add(K.schedule(()=>ve.then(Ae=>{ce.add(K.schedule(()=>{re.next(Ae),ce.add(K.schedule(()=>re.complete()))}))},Ae=>{ce.add(K.schedule(()=>re.error(Ae)))}))),ce})}},7164:(et,Ce,L)=>{"use strict";L.d(Ce,{x:()=>q});var he=L(4202),xe=L(4096),Pe=L(3821),K=L(8687),re=L(6454),ce=L(5430),Te=L(8955),G=L(8515);function q(we,Ee){if(null!=we){if(function Le(we){return we&&"function"==typeof we[Pe.L]}(we))return function ve(we,Ee){return new he.y(pe=>{const ae=new xe.w;return ae.add(Ee.schedule(()=>{const _t=we[Pe.L]();ae.add(_t.subscribe({next(It){ae.add(Ee.schedule(()=>pe.next(It)))},error(It){ae.add(Ee.schedule(()=>pe.error(It)))},complete(){ae.add(Ee.schedule(()=>pe.complete()))}}))})),ae})}(we,Ee);if((0,Te.t)(we))return(0,K.c)(we,Ee);if((0,G.z)(we))return(0,re.r)(we,Ee);if(function ie(we){return we&&"function"==typeof we[ce.hZ]}(we)||"string"==typeof we)return function Ae(we,Ee){if(!we)throw new Error("Iterable cannot be null");return new he.y(pe=>{const ae=new xe.w;let _t;return ae.add(()=>{_t&&"function"==typeof _t.return&&_t.return()}),ae.add(Ee.schedule(()=>{_t=we[ce.hZ](),ae.add(Ee.schedule(function(){if(pe.closed)return;let It,Ke;try{const Zt=_t.next();It=Zt.value,Ke=Zt.done}catch(Zt){return void pe.error(Zt)}Ke?pe.complete():(pe.next(It),this.schedule())}))})),ae})}(we,Ee)}throw new TypeError((null!==we&&typeof we||we)+" is not observable")}},6686:(et,Ce,L)=>{"use strict";L.d(Ce,{o:()=>Pe});var he=L(4096);class xe extends he.w{constructor(K,re){super()}schedule(K,re=0){return this}}class Pe extends xe{constructor(K,re){super(K,re),this.scheduler=K,this.work=re,this.pending=!1}schedule(K,re=0){if(this.closed)return this;this.state=K;const ce=this.id,Ae=this.scheduler;return null!=ce&&(this.id=this.recycleAsyncId(Ae,ce,re)),this.pending=!0,this.delay=re,this.id=this.id||this.requestAsyncId(Ae,this.id,re),this}requestAsyncId(K,re,ce=0){return setInterval(K.flush.bind(K,this),ce)}recycleAsyncId(K,re,ce=0){if(null!==ce&&this.delay===ce&&!1===this.pending)return re;clearInterval(re)}execute(K,re){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const ce=this._execute(K,re);if(ce)return ce;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(K,re){let Ae,ce=!1;try{this.work(K)}catch(Le){ce=!0,Ae=!!Le&&Le||new Error(Le)}if(ce)return this.unsubscribe(),Ae}_unsubscribe(){const K=this.id,re=this.scheduler,ce=re.actions,Ae=ce.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==Ae&&ce.splice(Ae,1),null!=K&&(this.id=this.recycleAsyncId(re,K,null)),this.delay=null}}},198:(et,Ce,L)=>{"use strict";L.d(Ce,{v:()=>xe});var he=L(2221);class xe extends he.b{constructor(ve,K=he.b.now){super(ve,()=>xe.delegate&&xe.delegate!==this?xe.delegate.now():K()),this.actions=[],this.active=!1,this.scheduled=void 0}schedule(ve,K=0,re){return xe.delegate&&xe.delegate!==this?xe.delegate.schedule(ve,K,re):super.schedule(ve,K,re)}flush(ve){const{actions:K}=this;if(this.active)return void K.push(ve);let re;this.active=!0;do{if(re=ve.execute(ve.state,ve.delay))break}while(ve=K.shift());if(this.active=!1,re){for(;ve=K.shift();)ve.unsubscribe();throw re}}}},341:(et,Ce,L)=>{"use strict";L.d(Ce,{c:()=>re,N:()=>K});var he=L(6686),Pe=L(198);const K=new class ve extends Pe.v{}(class xe extends he.o{constructor(Ae,Le){super(Ae,Le),this.scheduler=Ae,this.work=Le}schedule(Ae,Le=0){return Le>0?super.schedule(Ae,Le):(this.delay=Le,this.state=Ae,this.scheduler.flush(this),this)}execute(Ae,Le){return Le>0||this.closed?super.execute(Ae,Le):this._execute(Ae,Le)}requestAsyncId(Ae,Le,Te=0){return null!==Te&&Te>0||null===Te&&this.delay>0?super.requestAsyncId(Ae,Le,Te):Ae.flush(this)}}),re=K},5430:(et,Ce,L)=>{"use strict";L.d(Ce,{hZ:()=>xe});const xe=function he(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}()},3821:(et,Ce,L)=>{"use strict";L.d(Ce,{L:()=>he});const he="function"==typeof Symbol&&Symbol.observable||"@@observable"},7668:(et,Ce,L)=>{"use strict";L.d(Ce,{b:()=>he});const he="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()},4231:(et,Ce,L)=>{"use strict";L.d(Ce,{W:()=>xe});const xe=(()=>{function Pe(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return Pe.prototype=Object.create(Error.prototype),Pe})()},5279:(et,Ce,L)=>{"use strict";L.d(Ce,{N:()=>xe});const xe=(()=>{function Pe(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return Pe.prototype=Object.create(Error.prototype),Pe})()},7964:(et,Ce,L)=>{"use strict";L.d(Ce,{B:()=>xe});const xe=(()=>{function Pe(ve){return Error.call(this),this.message=ve?`${ve.length} errors occurred during unsubscription:\n${ve.map((K,re)=>`${re+1}) ${K.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=ve,this}return Pe.prototype=Object.create(Error.prototype),Pe})()},9476:(et,Ce,L)=>{"use strict";L.d(Ce,{_:()=>xe});var he=L(3489);function xe(Pe){for(;Pe;){const{closed:ve,destination:K,isStopped:re}=Pe;if(ve||re)return!1;Pe=K&&K instanceof he.L?K:null}return!0}},2782:(et,Ce,L)=>{"use strict";function he(xe){setTimeout(()=>{throw xe},0)}L.d(Ce,{z:()=>he})},5379:(et,Ce,L)=>{"use strict";function he(xe){return xe}L.d(Ce,{y:()=>he})},6688:(et,Ce,L)=>{"use strict";L.d(Ce,{k:()=>he});const he=Array.isArray||(xe=>xe&&"number"==typeof xe.length)},8515:(et,Ce,L)=>{"use strict";L.d(Ce,{z:()=>he});const he=xe=>xe&&"number"==typeof xe.length&&"function"!=typeof xe},7043:(et,Ce,L)=>{"use strict";function he(xe){return"function"==typeof xe}L.d(Ce,{m:()=>he})},7830:(et,Ce,L)=>{"use strict";function he(xe){return null!==xe&&"object"==typeof xe}L.d(Ce,{K:()=>he})},8955:(et,Ce,L)=>{"use strict";function he(xe){return!!xe&&"function"!=typeof xe.subscribe&&"function"==typeof xe.then}L.d(Ce,{t:()=>he})},2866:(et,Ce,L)=>{"use strict";function he(xe){return xe&&"function"==typeof xe.schedule}L.d(Ce,{K:()=>he})},7876:(et,Ce,L)=>{"use strict";function he(){}L.d(Ce,{Z:()=>he})},4843:(et,Ce,L)=>{"use strict";L.d(Ce,{U:()=>Pe,z:()=>xe});var he=L(5379);function xe(...ve){return Pe(ve)}function Pe(ve){return 0===ve.length?he.y:1===ve.length?ve[0]:function(re){return ve.reduce((ce,Ae)=>Ae(ce),re)}}},4544:(et,Ce,L)=>{"use strict";L.d(Ce,{s:()=>Te});var he=L(3650),xe=L(3445),Pe=L(5430),K=L(3821),ce=L(8515),Ae=L(8955),Le=L(7830);const Te=G=>{if(G&&"function"==typeof G[K.L])return(G=>ie=>{const q=G[K.L]();if("function"!=typeof q.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return q.subscribe(ie)})(G);if((0,ce.z)(G))return(0,he.V)(G);if((0,Ae.t)(G))return(0,xe.A)(G);if(G&&"function"==typeof G[Pe.hZ])return(G=>ie=>{const q=G[Pe.hZ]();for(;;){let we;try{we=q.next()}catch(Ee){return ie.error(Ee),ie}if(we.done){ie.complete();break}if(ie.next(we.value),ie.closed)break}return"function"==typeof q.return&&ie.add(()=>{q.return&&q.return()}),ie})(G);{const q=`You provided ${(0,Le.K)(G)?"an invalid object":`'${G}'`} where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.`;throw new TypeError(q)}}},3650:(et,Ce,L)=>{"use strict";L.d(Ce,{V:()=>he});const he=xe=>Pe=>{for(let ve=0,K=xe.length;ve<K&&!Pe.closed;ve++)Pe.next(xe[ve]);Pe.complete()}},3445:(et,Ce,L)=>{"use strict";L.d(Ce,{A:()=>xe});var he=L(2782);const xe=Pe=>ve=>(Pe.then(K=>{ve.closed||(ve.next(K),ve.complete())},K=>ve.error(K)).then(null,he.z),ve)},448:(et,Ce,L)=>{"use strict";L.d(Ce,{D:()=>K});var he=L(3489);class xe extends he.L{constructor(ce,Ae,Le){super(),this.parent=ce,this.outerValue=Ae,this.outerIndex=Le,this.index=0}_next(ce){this.parent.notifyNext(this.outerValue,ce,this.outerIndex,this.index++,this)}_error(ce){this.parent.notifyError(ce,this),this.unsubscribe()}_complete(){this.parent.notifyComplete(this),this.unsubscribe()}}var Pe=L(4544),ve=L(4202);function K(re,ce,Ae,Le,Te=new xe(re,Ae,Le)){if(!Te.closed)return ce instanceof ve.y?ce.subscribe(Te):(0,Pe.s)(ce)(Te)}}},et=>{et(et.s=9993)}]);